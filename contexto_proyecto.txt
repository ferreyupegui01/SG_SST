CONTEXTO DEL PROYECTO (FECHA: 2025-11-26T12:53:37.515Z):


==================================================================
ARCHIVO: backend\config\dbConfig.js
==================================================================
// backend/dbConfig.js

import mssql from 'mssql';
// Asegura que dotenv se cargue
import 'dotenv/config';

// Configuración de la conexión leída desde .env
const config = {
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    server: process.env.DB_SERVER,
    database: process.env.DB_DATABASE,
    options: {
        encrypt: true, // Para Azure SQL
        trustServerCertificate: true // Cambia a false si usas un certificado SSL/TLS de confianza
    }
};

// --- Exportación Nombrada (ESM) ---
// Creamos y exportamos la promesa del pool directamente
export const poolPromise = new mssql.ConnectionPool(config)
    .connect()
    .then(pool => {
        console.log('Conectado a SQL Server (mssql)');
        return pool;
    })
    .catch(err => {
        console.error('Error de conexión a la base de datos:', err);
        process.exit(1); // Termina la aplicación si no se puede conectar a la DB
    });

// Exportamos mssql para poder usar tipos (ej. mssql.NVarChar) en los controladores
export { mssql };


==================================================================
ARCHIVO: backend\controllers\acpmController.js
==================================================================
// backend/src/controllers/acpmController.js

import { validationResult } from 'express-validator';
import { poolPromise, mssql } from '../config/dbConfig.js';
import path from 'path'; 
import { fileURLToPath } from 'url';
import fs from 'fs/promises'; 
import { logAction } from '../services/logService.js'; // <-- Importar logService

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * @controller  crearACPM
 * @desc        (CU-03) Crea una nueva ACPM
 */
const crearACPM = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    const {
        tipoAccion, origen, descripcionProblema, planAccion,
        idUsuarioResponsable, fechaLimite, idInspeccionOrigen,
        idReporteMaquinaOrigen, idReporteSeguridadOrigen, analisisCausa
    } = req.body;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('tipoAccion', mssql.NVarChar, tipoAccion)
            .input('origen', mssql.NVarChar, origen)
            .input('descripcionProblema', mssql.NVarChar, descripcionProblema)
            .input('planAccion', mssql.NVarChar, planAccion)
            .input('idUsuarioResponsable', mssql.Int, idUsuarioResponsable)
            .input('fechaLimite', mssql.Date, fechaLimite)
            .input('idInspeccionOrigen', mssql.Int, idInspeccionOrigen || null)
            .input('idReporteMaquinaOrigen', mssql.Int, idReporteMaquinaOrigen || null)
            .input('idReporteSeguridadOrigen', mssql.Int, idReporteSeguridadOrigen || null)
            .input('analisisCausa', mssql.NVarChar, analisisCausa || null)
            .query('EXEC SP_CREATE_AccionACPM @tipoAccion, @origen, @descripcionProblema, @planAccion, @idUsuarioResponsable, @fechaLimite, @idInspeccionOrigen, @idReporteMaquinaOrigen, @idReporteSeguridadOrigen, @analisisCausa');
        
        const nuevaAcpmId = result.recordset[0].ID_ACPM;

        // --- LOG ---
        await logAction(
            req.usuario.id, 
            req.usuario.nombre, 
            'CREAR_ACPM', 
            `Creó la ACPM (ID: ${nuevaAcpmId}) con origen: '${origen}'`
        );
        // --- FIN LOG ---

        res.status(201).json({
            msg: 'Acción ACPM creada exitosamente',
            idACPM: nuevaAcpmId
        });
    } catch (err) {
        if (err.message.includes('La fecha límite')) {
            return res.status(400).json({ msg: 'La fecha límite no puede ser anterior a la fecha actual' });
        }
        console.error('Error en crearACPM:', err.message);
        res.status(500).json({ msg: 'Error del servidor al crear ACPM' }); // CORREGIDO a JSON
    }
};

/**
 * @controller  getACPMs
 * @desc        Obtiene la lista de todas las ACPM
 */
const getACPMs = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_AccionesACPM');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getACPMs:', err.message);
        res.status(500).json({ msg: 'Error del servidor al obtener ACPMs' }); // CORREGIDO a JSON
    }
};

/**
 * @controller  getACPMDetalle
 * @desc        Obtiene el detalle completo de una ACPM
 */
const getACPMDetalle = async (req, res) => {
    const { id: idACPM } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idACPM', mssql.Int, idACPM)
            .query('EXEC SP_GET_ACPMDetalle @idACPM');
        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Acción ACPM no encontrada' });
        }
        res.json(result.recordset[0]);
    } catch (err) {
        console.error('Error en getACPMDetalle:', err.message);
        res.status(500).json({ msg: 'Error del servidor al obtener detalle' }); // CORREGIDO a JSON
    }
};

/**
 * @controller  gestionarACPM
 * @desc        (CU-04) Gestiona el estado, comentarios y evidencia
 */
const gestionarACPM = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    const { id: idACPM } = req.params; 
    const { estadoACPM, comentariosSeguimiento } = req.body; 
    const idUsuario = req.usuario.id; 
    const nombreUsuario = req.usuario.nombre; 
    const archivoEvidencia = req.file; 
    
    if (estadoACPM === 'Cerrada' && !archivoEvidencia) {
        return res.status(400).json({ msg: 'Se requiere un archivo de evidencia para cerrar la acción' });
    }
    
    try {
        const pool = await poolPromise;
        
        // 1. Verificar existencia
        const checkACPM = await pool.request()
            .input('idACPM', mssql.Int, idACPM)
            .query('SELECT ID_ACPM FROM dbo.AccionesACPM WHERE ID_ACPM = @idACPM'); // Quitamos ComentariosSeguimiento del select para simplificar
        
        if (checkACPM.recordset.length === 0) {
            return res.status(404).json({ msg: 'Acción ACPM no encontrada' });
        }

        // 2. Preparar comentario nuevo
        // (Nota: SP_UPDATE_ACPMGestionar ya hace CONCAT en la BD, así que solo enviamos el nuevo)
        let comentarioFormateado = '';
        if (comentariosSeguimiento && comentariosSeguimiento.trim() !== '') {
            const fecha = new Date().toISOString().split('T')[0];
            comentarioFormateado = `\n[${fecha} - ${nombreUsuario}]: ${comentariosSeguimiento}`;
        }

        // 3. Actualizar Estado y Comentarios
        await pool.request()
            .input('idACPM', mssql.Int, idACPM)
            .input('estadoACPM', mssql.NVarChar, estadoACPM)
            .input('comentarioAdicional', mssql.NVarChar, comentarioFormateado)
            .query('EXEC SP_UPDATE_ACPMGestionar @idACPM, @estadoACPM, @comentarioAdicional');

        let logDescripcion = `Gestionó la ACPM (ID: ${idACPM}), nuevo estado: ${estadoACPM}.`;

        // 4. Guardar Evidencia (SI EXISTE)
        if (archivoEvidencia) {
            const nombreArchivo = archivoEvidencia.filename;
            const rutaArchivo = archivoEvidencia.path;
            
            // --- CORRECCIÓN CRÍTICA: Normalizar extensión ---
            // 1. Sacar extensión
            let tipoArchivo = path.extname(archivoEvidencia.originalname).replace('.', '').toLowerCase();
            // 2. Mapear tipos problemáticos
            if (tipoArchivo === 'jpeg') tipoArchivo = 'jpg';
            // ------------------------------------------------

            const esEvidenciaDeCierre = (estadoACPM === 'Cerrada'); 
            
            await pool.request()
                .input('idACPM', mssql.Int, idACPM)
                .input('nombreArchivo', mssql.NVarChar, nombreArchivo)
                .input('rutaArchivo', mssql.NVarChar, rutaArchivo)
                .input('tipoArchivo', mssql.NVarChar, tipoArchivo) // Enviamos la variable limpia
                .input('idUsuarioSubio', mssql.Int, idUsuario)
                .input('esEvidenciaDeCierre', mssql.Bit, esEvidenciaDeCierre)
                .query('EXEC SP_CREATE_EvidenciaACPM @idACPM, @nombreArchivo, @rutaArchivo, @tipoArchivo, @idUsuarioSubio, @esEvidenciaDeCierre');
            
            logDescripcion += ` Se adjuntó evidencia: ${nombreArchivo}.`;
        }

        // --- LOG ---
        await logAction(req.usuario.id, req.usuario.nombre, 'GESTIONAR_ACPM', logDescripcion);
        // --- FIN LOG ---

        res.json({ msg: 'Acción ACPM gestionada exitosamente' });

    } catch (err) {
        console.error('Error en gestionarACPM:', err.message);
        
        // Si es error de Multer (tipo de archivo), ya se atrapó antes, pero por si acaso:
        if (err.message.includes('Solo se permiten')) {
            return res.status(400).json({ msg: err.message });
        }
        
        // CORRECCIÓN: Devolver JSON para que el frontend no falle
        res.status(500).json({ 
            msg: 'Error del servidor al gestionar la ACPM',
            error: err.message 
        });
    }
};

/**
 * @controller  getEvidenciasACPM
 * @desc        Obtiene las evidencias de una ACPM
 */
const getEvidenciasACPM = async (req, res) => {
    const { id: idACPM } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idACPM', mssql.Int, idACPM)
            .query('EXEC SP_GET_EvidenciasPorACPM @idACPM');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getEvidenciasACPM:', err.message);
        res.status(500).json({ msg: 'Error del servidor al obtener evidencias' }); // CORREGIDO a JSON
    }
};

const acpmController = {
    crearACPM,
    getACPMs,
    getACPMDetalle,
    gestionarACPM,
    getEvidenciasACPM
};

export default acpmController;


==================================================================
ARCHIVO: backend\controllers\activityController.js
==================================================================
// backend/src/controllers/activityController.js

import { validationResult } from 'express-validator';
import { poolPromise, mssql } from '../config/dbConfig.js';
import path from 'path'; 
import { fileURLToPath } from 'url';
import fs from 'fs/promises'; 
import { logAction } from '../services/logService.js'; // Importar Log

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * @controller  editarActividad
 * @desc        (CU-10) Edita los detalles de una actividad
 */
const editarActividad = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }

    const { id: idActividad } = req.params; 
    const { nombreActividad, descripcionActividad, fechaLimite, idUsuarioResponsable } = req.body;

    try {
        const pool = await poolPromise;
        const checkActividad = await pool.request().input('idActividad', mssql.Int, idActividad).query('SELECT ID_Actividad FROM dbo.Actividades WHERE ID_Actividad = @idActividad');
        if (checkActividad.recordset.length === 0) {
            return res.status(404).json({ msg: 'Actividad no encontrada' });
        }
        
        await pool.request()
            .input('idActividad', mssql.Int, idActividad)
            .input('nombreActividad', mssql.NVarChar, nombreActividad)
            .input('descripcionActividad', mssql.NVarChar, descripcionActividad || null)
            .input('idUsuarioResponsable', mssql.Int, idUsuarioResponsable) 
            .input('fechaLimite', mssql.Date, new Date(fechaLimite))
            .query('EXEC SP_UPDATE_Actividad @idActividad, @nombreActividad, @descripcionActividad, @idUsuarioResponsable, @fechaLimite');
        
        await logAction(req.usuario.id, req.usuario.nombre, 'EDITAR_ACTIVIDAD', `Editó la actividad: '${nombreActividad}' (ID: ${idActividad})`);
        
        res.json({ msg: 'Actividad actualizada exitosamente' });
    } catch (err) {
        console.error('Error en editarActividad:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  eliminarActividad
 * @desc        (CU-11) Marca una actividad como Inactiva
 */
const eliminarActividad = async (req, res) => {
    const { id: idActividad } = req.params; 
    try {
        const pool = await poolPromise;
        const checkActividad = await pool.request().input('idActividad', mssql.Int, idActividad).query('SELECT NombreActividad FROM dbo.Actividades WHERE ID_Actividad = @idActividad');
        if (checkActividad.recordset.length === 0) {
            return res.status(404).json({ msg: 'Actividad no encontrada' });
        }
        const nombreActividad = checkActividad.recordset[0].NombreActividad;
        
        await pool.request()
            .input('idActividad', mssql.Int, idActividad)
            .query('EXEC SP_DELETE_Actividad @idActividad');
        
        await logAction(req.usuario.id, req.usuario.nombre, 'ELIMINAR_ACTIVIDAD', `Eliminó la actividad: '${nombreActividad}' (ID: ${idActividad})`);
        
        res.json({ msg: 'Actividad eliminada (archivada) exitosamente' });
    } catch (err) {
        console.error('Error en eliminarActividad:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  gestionarActividad
 * @desc        (CU-01) Gestiona el estado y la evidencia de una actividad
 */
const gestionarActividad = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    const { id: idActividad } = req.params; 
    const { estado, observaciones } = req.body; 
    const idUsuario = req.usuario.id; 
    const archivoEvidencia = req.file; 
    
    // Validación: Si marca como realizada, debe subir evidencia
    if (estado === 'Realizada' && !archivoEvidencia) {
        // Nota: Esto asume que es obligatorio subir evidencia CADA VEZ que se marca realizada.
        // Si quieres permitir marcarla si YA TIENE evidencia previa, la lógica sería más compleja.
        return res.status(400).json({ msg: 'Se requiere un archivo de evidencia para marcar la actividad como "Realizada"' });
    }
    
    try {
        const pool = await poolPromise;
        const checkActividad = await pool.request().input('idActividad', mssql.Int, idActividad).query('SELECT ID_Actividad FROM dbo.Actividades WHERE ID_Actividad = @idActividad');
        if (checkActividad.recordset.length === 0) {
            return res.status(404).json({ msg: 'Actividad no encontrada' });
        }
        
        // 1. Actualizar Estado y Observaciones
        await pool.request()
            .input('idActividad', mssql.Int, idActividad)
            .input('estado', mssql.NVarChar, estado)
            .input('observaciones', mssql.NVarChar, observaciones || null) 
            .query('EXEC SP_UPDATE_ActividadEstado @idActividad, @estado, @observaciones');
        
        let logDescripcion = `Gestionó la actividad (ID: ${idActividad}), nuevo estado: ${estado}.`;

        // 2. Insertar Evidencia (si existe archivo)
        if (archivoEvidencia) {
            const nombreArchivo = archivoEvidencia.filename;
            const rutaArchivo = archivoEvidencia.path;
            const tipoArchivo = archivoEvidencia.mimetype; // Esto envía "application/pdf", etc.
            
            await pool.request()
                .input('idActividad', mssql.Int, idActividad)
                .input('nombreArchivo', mssql.NVarChar, nombreArchivo)
                .input('rutaArchivo', mssql.NVarChar, rutaArchivo)
                .input('tipoArchivo', mssql.NVarChar, tipoArchivo)
                .input('idUsuarioSubio', mssql.Int, idUsuario)
                .query('EXEC SP_CREATE_EvidenciaActividad @idActividad, @nombreArchivo, @rutaArchivo, @tipoArchivo, @idUsuarioSubio');
            
            logDescripcion += ` Se adjuntó evidencia.`;
        }
        
        await logAction(req.usuario.id, req.usuario.nombre, 'GESTIONAR_ACTIVIDAD', logDescripcion);
        
        res.json({ msg: 'Actividad gestionada exitosamente' });

    } catch (err) {
        console.error('Error en gestionarActividad:', err.message);
        
        // Atrapa el error de la BD si todavía hay problemas de constraints
        if (err.message.includes('conflicted with the CHECK constraint')) {
            return res.status(500).send('Error de BD: Restricción de tipo de archivo no actualizada. Ejecute el script SQL.');
        }
        
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getEvidenciasActividad
 * @desc        Obtiene las evidencias de una actividad
 */
const getEvidenciasActividad = async (req, res) => {
    const { id: idActividad } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idActividad', mssql.Int, idActividad)
            .query('EXEC SP_GET_EvidenciasPorActividad @idActividad');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getEvidenciasActividad:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getActividadDetalle
 * @desc        (NUEVO) Obtiene el detalle completo de una actividad por ID
 */
const getActividadDetalle = async (req, res) => {
    const { id: idActividad } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idActividad', mssql.Int, idActividad)
            .query('EXEC SP_GET_ActividadDetalle @idActividad');

        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Actividad no encontrada' });
        }
        
        res.json(result.recordset[0]);
    } catch (err) {
        console.error('Error en getActividadDetalle:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const activityController = {
    editarActividad,
    eliminarActividad,
    gestionarActividad,
    getEvidenciasActividad,
    getActividadDetalle
};

export default activityController;


==================================================================
ARCHIVO: backend\controllers\assetController.js
==================================================================
// backend/src/controllers/assetController.js

import { validationResult } from 'express-validator';
import { poolPromise, mssql } from '../config/dbConfig.js';

const getActivosPorTipo = async (req, res) => {
    const { tipo } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('tipoActivo', mssql.NVarChar, tipo)
            .query('EXEC SP_GET_ActivosPorTipo @tipoActivo');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getActivosPorTipo:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getActivosTodos = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_Activos_Todos');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getActivosTodos:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const crearActivo = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) return res.status(400).json({ errors: errors.array() });

    // Extraemos todos los campos
    const { 
        tipoActivo, codigoIdentificador, nombreDescriptivo, ubicacion,
        marca, modelo, soatVencimiento, tecnoVencimiento, kilometrajeInicial, idConductor
    } = req.body;

    try {
        const pool = await poolPromise;
        await pool.request()
            .input('tipoActivo', mssql.NVarChar, tipoActivo)
            .input('codigoIdentificador', mssql.NVarChar, codigoIdentificador)
            .input('nombreDescriptivo', mssql.NVarChar, nombreDescriptivo)
            .input('ubicacion', mssql.NVarChar, ubicacion || null)
            .input('marca', mssql.NVarChar, marca || null)
            .input('modelo', mssql.NVarChar, modelo || null)
            .input('soatVencimiento', mssql.Date, soatVencimiento || null)
            .input('tecnoVencimiento', mssql.Date, tecnoVencimiento || null)
            .input('kilometrajeInicial', mssql.Int, kilometrajeInicial || 0)
            .input('idConductor', mssql.Int, idConductor || null)
            .query('EXEC SP_CREATE_Activo @tipoActivo, @codigoIdentificador, @nombreDescriptivo, @ubicacion, @marca, @modelo, @soatVencimiento, @tecnoVencimiento, @kilometrajeInicial, @idConductor');

        res.status(201).json({ msg: 'Activo creado exitosamente' });
    } catch (err) {
        if (err.message.includes('Ya existe un activo')) return res.status(400).json({ msg: err.message });
        console.error('Error en crearActivo:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const actualizarActivo = async (req, res) => {
    const { id } = req.params;
    const { 
        tipoActivo, codigoIdentificador, nombreDescriptivo, ubicacion,
        marca, modelo, soatVencimiento, tecnoVencimiento, idConductor
    } = req.body;

    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idActivo', mssql.Int, id)
            .input('tipoActivo', mssql.NVarChar, tipoActivo)
            .input('codigoIdentificador', mssql.NVarChar, codigoIdentificador)
            .input('nombreDescriptivo', mssql.NVarChar, nombreDescriptivo)
            .input('ubicacion', mssql.NVarChar, ubicacion || null)
            .input('marca', mssql.NVarChar, marca || null)
            .input('modelo', mssql.NVarChar, modelo || null)
            .input('soatVencimiento', mssql.Date, soatVencimiento || null)
            .input('tecnoVencimiento', mssql.Date, tecnoVencimiento || null)
            .input('idConductor', mssql.Int, idConductor || null)
            .query('EXEC SP_UPDATE_Activo @idActivo, @tipoActivo, @codigoIdentificador, @nombreDescriptivo, @ubicacion, @marca, @modelo, @soatVencimiento, @tecnoVencimiento, @idConductor');

        res.json({ msg: 'Activo actualizado exitosamente' });
    } catch (err) {
        if (err.message.includes('Ya existe OTRO activo')) return res.status(400).json({ msg: err.message });
        console.error('Error en actualizarActivo:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const eliminarActivo = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        await pool.request().input('idActivo', mssql.Int, id).query('EXEC SP_DELETE_Activo @idActivo');
        res.json({ msg: 'Activo eliminado exitosamente' });
    } catch (err) {
        if (err.message.includes('referenciado') || err.message.includes('No se puede inactivar')) {
             return res.status(400).json({ msg: err.message });
        }
        console.error('Error en eliminarActivo:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getTiposDisponibles = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_TiposActivosDisponibles');
        
        // CAMBIO CLAVE: Devolvemos todo el recordset (objetos con Tipo y Categoría)
        // No hacemos .map() para que el frontend pueda leer la propiedad 'Categoria'
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getTiposDisponibles:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const assetController = {
    getActivosPorTipo,
    getActivosTodos,
    crearActivo,
    actualizarActivo,
    eliminarActivo,
    getTiposDisponibles
};

export default assetController;


==================================================================
ARCHIVO: backend\controllers\authController.js
==================================================================
// backend/controllers/authController.js

import { validationResult } from 'express-validator';
import bcrypt from 'bcryptjs';
import jwt from 'jsonwebtoken'; 
import { poolPromise, mssql } from '../config/dbConfig.js';

const login = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }

    const { cedula, password } = req.body;

    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('cedula', mssql.NVarChar, cedula)
            .query('EXEC SP_AUTH_LoginUsuario @cedula');

        if (result.recordset.length === 0) {
            return res.status(401).json({ msg: 'Credenciales inválidas' });
        }

        const usuario = result.recordset[0];

        if (usuario.EstadoCuenta === 'Inactivo') {
            return res.status(403).json({ msg: 'Esta cuenta de usuario está inactiva.' });
        }

        const isMatch = await bcrypt.compare(password, usuario.PasswordHash);
        if (!isMatch) {
            return res.status(401).json({ msg: 'Credenciales inválidas' });
        }

        // --- AQUÍ AGREGAMOS LA CÉDULA AL TOKEN ---
        const payload = {
            usuario: {
                id: usuario.ID_Usuario,
                nombre: usuario.NombreCompleto,
                rol: usuario.NombreRol,
                cedula: usuario.CedulaUsuario // <--- ¡ESTO FALTABA!
            }
        };

        jwt.sign(
            payload,
            process.env.JWT_SECRET,
            { expiresIn: '8h' },
            (err, token) => {
                if (err) throw err;
                res.json({ token });
            }
        );

    } catch (err) {
        console.error('Error en login:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const authController = { login };
export default authController;


==================================================================
ARCHIVO: backend\controllers\dashboardController.js
==================================================================
// backend/controllers/dashboardController.js

import { poolPromise, mssql } from '../config/dbConfig.js';

/**
 * @controller  getAdminKPIs
 * @desc        Obtiene los 4 KPIs (contadores) para el dashboard del Admin
 */
const getAdminKPIs = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_Dashboard_Admin_KPIs');
        res.json(result.recordset[0]);
    } catch (err) {
        console.error('Error en getAdminKPIs:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getAdminActividadesPendientes
 * @desc        Obtiene la lista Top 5 de actividades pendientes
 */
const getAdminActividadesPendientes = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_Dashboard_ActividadesPendientes');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getAdminActividadesPendientes:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getAdminReportesRecientes
 * @desc        Obtiene la lista Top 5 de reportes nuevos
 */
const getAdminReportesRecientes = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_Dashboard_ReportesRecientes');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getAdminReportesRecientes:', err.message);
        res.status(500).send('Error del servidor');
    }
};



/**
 * @controller  getSuperAdminData
 * @desc        Obtiene toda la data para el dashboard del Super Admin
 */
const getSuperAdminData = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_SuperAdmin_Dashboard');
        
        // El SP devuelve 3 tablas (recordsets)
        const kpis = result.recordsets[0][0];       // Tabla 1: KPIs
        const grafica = result.recordsets[1];       // Tabla 2: Datos Gráfica
        const logs = result.recordsets[2];          // Tabla 3: Logs Recientes

        res.json({
            kpis,
            grafica,
            logs
        });
    } catch (err) {
        console.error('Error en getSuperAdminData:', err.message);
        res.status(500).send('Error del servidor');
    }
};



const dashboardController = {
    getAdminKPIs,
    getAdminActividadesPendientes,
    getAdminReportesRecientes,
    getSuperAdminData
};

export default dashboardController;


==================================================================
ARCHIVO: backend\controllers\documentController.js
==================================================================
// backend/src/controllers/documentController.js

import { validationResult } from 'express-validator';
import { poolPromise, mssql } from '../config/dbConfig.js';
import path from 'path'; 
import { fileURLToPath } from 'url';
import fs from 'fs/promises'; 
import mime from 'mime-types'; 
import { logAction } from '../services/logService.js'; // <-- 1. Importar

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const getContenidoCarpeta = async (req, res) => {
    // (Lectura, no se loguea)
    const { id } = req.params; 
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idCarpeta', mssql.Int, id)
            .query('EXEC SP_GET_ContenidoCarpeta @idCarpeta');
        res.json({
            carpetas: result.recordsets[0] || [],
            archivos: result.recordsets[1] || []
        });
    } catch (err) {
        console.error('Error en getContenidoCarpeta:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const crearCarpeta = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    const { nombreCarpeta, idCarpetaPadre } = req.body;
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('nombreCarpeta', mssql.NVarChar, nombreCarpeta)
            .input('idCarpetaPadre', mssql.Int, idCarpetaPadre)
            .query('EXEC SP_CREATE_Carpeta @nombreCarpeta, @idCarpetaPadre');
        
        // --- 2. AÑADIR LOG ---
        await logAction(
            req.usuario.id, 
            req.usuario.nombre, 
            'CREAR_CARPETA_DMS', 
            `Creó la carpeta: '${nombreCarpeta}' (en ID Padre: ${idCarpetaPadre})`
        );
        // --- FIN DE LOG ---

        res.status(201).json({ msg: 'Carpeta creada exitosamente' });
    } catch (err) {
        if (err.message.includes('Ya existe una carpeta con ese nombre')) {
            return res.status(400).json({ msg: err.message });
        }
        console.error('Error en crearCarpeta:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const subirArchivos = async (req, res) => {
    const { idCarpeta } = req.body;
    const idUsuario = req.usuario.id;
    const files = req.files; 
    if (!idCarpeta) {
        return res.status(400).json({ msg: 'No se especificó la carpeta de destino.' });
    }
    if (!files || files.length === 0) {
        return res.status(400).json({ msg: 'No se seleccionaron archivos.' });
    }
    try {
        const pool = await poolPromise;
        let nombresDeArchivos = []; // Para el log
        
        for (const file of files) {
            const params = {
                idCarpeta: idCarpeta,
                idUsuarioSubio: idUsuario,
                nombreOriginal: file.originalname,
                nombreAlmacenado: file.filename,
                rutaArchivo: file.path,
                tipoArchivo: file.mimetype,
                tamanoArchivoKB: Math.round(file.size / 1024)
            };
            nombresDeArchivos.push(file.originalname); // Añadir al log
            await pool.request()
                .input('idCarpeta', mssql.Int, params.idCarpeta)
                .input('idUsuarioSubio', mssql.Int, params.idUsuarioSubio)
                .input('nombreOriginal', mssql.NVarChar, params.nombreOriginal)
                .input('nombreAlmacenado', mssql.NVarChar, params.nombreAlmacenado)
                .input('rutaArchivo', mssql.NVarChar, params.rutaArchivo)
                .input('tipoArchivo', mssql.NVarChar, params.tipoArchivo)
                .input('tamanoArchivoKB', mssql.Int, params.tamanoArchivoKB)
                .query('EXEC SP_CREATE_Documento @idCarpeta, @idUsuarioSubio, @nombreOriginal, @nombreAlmacenado, @rutaArchivo, @tipoArchivo, @tamanoArchivoKB');
        }
        
        // --- AÑADIR LOG ---
        await logAction(
            req.usuario.id, 
            req.usuario.nombre, 
            'SUBIR_DOCUMENTO_DMS', 
            `Subió ${files.length} archivo(s) a la carpeta ID ${idCarpeta}: ${nombresDeArchivos.join(', ')}`
        );
        // --- FIN DE LOG ---

        res.status(201).json({ msg: `${files.length} archivo(s) subidos exitosamente.` });
    } catch (err) {
        console.error('Error en subirArchivos:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const descargarDocumento = async (req, res) => {
    // (Lectura, no se loguea)
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idDocumento', mssql.Int, id)
            .query('EXEC SP_GET_DocumentoDetalle @idDocumento');
        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Documento no encontrado' });
        }
        const doc = result.recordset[0];
        const rutaAbsoluta = path.resolve(__dirname, '..', doc.RutaArchivo);
        res.download(rutaAbsoluta, doc.NombreOriginal, (err) => {
            if (err) {
                console.error("Error al enviar el archivo:", err);
                res.status(404).send('Error: Archivo no encontrado en el servidor.');
            }
        });
    } catch (err) {
        console.error('Error en descargarDocumento:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const eliminarDocumento = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idDocumento', mssql.Int, id)
            .query('EXEC SP_GET_DocumentoDetalle @idDocumento');
        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Documento no encontrado en la BD.' });
        }
        const doc = result.recordset[0];
        const rutaAbsoluta = path.resolve(__dirname, '..', doc.RutaArchivo);

        await pool.request()
            .input('idDocumento', mssql.Int, id)
            .query('EXEC SP_DELETE_Documento @idDocumento');
        
        try {
            await fs.unlink(rutaAbsoluta);
        } catch (fileErr) {
            console.warn(`Se eliminó el registro ${id}, pero el archivo físico no se encontró en: ${rutaAbsoluta}`);
        }
        
        // --- AÑADIR LOG ---
        await logAction(
            req.usuario.id, 
            req.usuario.nombre, 
            'ELIMINAR_DOCUMENTO_DMS', 
            `Eliminó el documento: '${doc.NombreOriginal}' (ID: ${id})`
        );
        // --- FIN DE LOG ---
        
        res.json({ msg: 'Documento eliminado exitosamente' });
    } catch (err) {
        console.error('Error en eliminarDocumento:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const eliminarCarpeta = async (req, res) => {
    const { id } = req.params;
    if (id === '1') {
        return res.status(400).json({ msg: 'No se puede eliminar la carpeta raíz.' });
    }
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idCarpeta', mssql.Int, id)
            .query('EXEC SP_DELETE_Carpeta @idCarpeta');
        
        // --- AÑADIR LOG ---
        await logAction(
            req.usuario.id, 
            req.usuario.nombre, 
            'ELIMINAR_CARPETA_DMS', 
            `Eliminó la carpeta (ID: ${id})`
        );
        // --- FIN DE LOG ---
        
        res.json({ msg: 'Carpeta eliminada exitosamente' });
    } catch (err) {
        if (err.message.includes('contiene subcarpetas') || err.message.includes('contiene archivos')) {
            return res.status(400).json({ msg: err.message });
        }
        console.error('Error en eliminarCarpeta:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const streamDocumento = async (req, res) => {
    // (Lectura, no se loguea)
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idDocumento', mssql.Int, id)
            .query('EXEC SP_GET_DocumentoDetalle @idDocumento');
        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Documento no encontrado' });
        }
        const doc = result.recordset[0];
        const rutaAbsoluta = path.resolve(__dirname, '..', doc.RutaArchivo);
        const mimeType = doc.TipoArchivo || mime.lookup(rutaAbsoluta) || 'application/octet-stream';
        res.setHeader('Content-Type', mimeType);
        res.setHeader('Content-Disposition', `inline; filename="${doc.NombreOriginal}"`);
        res.sendFile(rutaAbsoluta, (err) => {
            if (err) {
                console.error("Error al enviar el archivo:", err);
                res.status(404).send('Error: Archivo no encontrado en el servidor.');
            }
        });
    } catch (err) {
        console.error('Error en streamDocumento:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const documentController = {
    getContenidoCarpeta,
    crearCarpeta,
    subirArchivos,
    descargarDocumento,
    eliminarDocumento,
    eliminarCarpeta,
    streamDocumento 
};

export default documentController;


==================================================================
ARCHIVO: backend\controllers\indicatorController.js
==================================================================
// backend/src/controllers/indicatorController.js

import { poolPromise, mssql } from '../config/dbConfig.js';

/**
 * @controller guardarIndicador
 * @desc Guarda un indicador asegurando tipos de datos numéricos
 */
const guardarIndicador = async (req, res) => {
    const { 
        nombreIndicador, mes, anio, 
        numerador, denominador, constante, meta, analisis 
    } = req.body;
    
    try {
        // 1. Sanitización (Convertir a números seguros)
        // Si viene vacío ('') o null, se convierte a 0
        const valNumerador = parseFloat(numerador) || 0;
        const valDenominador = parseFloat(denominador) || 1; // Evitar div/0
        const valConstante = parseInt(constante) || 100;
        const valMeta = parseFloat(meta) || 0;

        const pool = await poolPromise;
        
        await pool.request()
            .input('nombreIndicador', mssql.NVarChar, nombreIndicador)
            .input('mes', mssql.Int, parseInt(mes))
            .input('anio', mssql.Int, parseInt(anio))
            .input('numerador', mssql.Decimal(18, 2), valNumerador)
            .input('denominador', mssql.Decimal(18, 2), valDenominador)
            .input('constante', mssql.Int, valConstante)
            .input('meta', mssql.Decimal(18, 2), valMeta)
            .input('analisis', mssql.NVarChar, analisis || '')
            .query('EXEC SP_SAVE_Indicador @nombreIndicador, @mes, @anio, @numerador, @denominador, @constante, @meta, @analisis');

        res.json({ msg: 'Indicador guardado exitosamente' });

    } catch (err) {
        console.error('Error en guardarIndicador:', err.message);
        res.status(500).send('Error del servidor al guardar indicador: ' + err.message);
    }
};

const getIndicadoresAnuales = async (req, res) => {
    const { anio } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('anio', mssql.Int, anio)
            .query('EXEC SP_GET_IndicadoresAnuales @anio');
        
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getIndicadoresAnuales:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const indicatorController = {
    guardarIndicador,
    getIndicadoresAnuales
};

export default indicatorController;


==================================================================
ARCHIVO: backend\controllers\inspectionController.js
==================================================================
// backend/src/controllers/inspectionController.js

import { validationResult } from 'express-validator';
import { poolPromise, mssql } from '../config/dbConfig.js';
import { logAction } from '../services/logService.js';

// --- CREAR INSPECCIÓN (Diligenciar) ---
const crearInspeccion = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) return res.status(400).json({ errors: errors.array() });

    const { idFormulario, idActivoInspeccionado, datosDiligenciados, observacionesGenerales, resultadoGeneral } = req.body;
    const idUsuarioRealizo = req.usuario.id;

    try {
        const pool = await poolPromise;
        let datosJsonString = typeof datosDiligenciados === 'object' ? JSON.stringify(datosDiligenciados) : datosDiligenciados;

        await pool.request()
            .input('idFormulario', mssql.NVarChar, idFormulario)
            .input('idActivoInspeccionado', mssql.Int, idActivoInspeccionado || null)
            .input('idUsuarioRealizo', mssql.Int, idUsuarioRealizo)
            .input('datosDiligenciados', mssql.NVarChar(mssql.MAX), datosJsonString)
            .input('observacionesGenerales', mssql.NVarChar(mssql.MAX), observacionesGenerales || null)
            .input('resultadoGeneral', mssql.NVarChar, resultadoGeneral)
            .query('EXEC SP_CREATE_Inspeccion @idFormulario, @idActivoInspeccionado, @idUsuarioRealizo, @datosDiligenciados, @observacionesGenerales, @resultadoGeneral');

        await logAction(req.usuario.id, req.usuario.nombre, 'DILIGENCIAR_INSPECCION', `Diligenció formulario '${idFormulario}'.`);
        res.status(201).json({ msg: 'Inspección registrada exitosamente' });
    } catch (err) {
        console.error('Error en crearInspeccion:', err.message);
        res.status(500).send('Error del servidor');
    }
};

// --- OBTENER HISTORIAL ---
const getInspeccionesHistorial = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_InspeccionesHistorial');
        res.json(result.recordset);
    } catch (err) {
        console.error(err);
        res.status(500).send('Error del servidor');
    }
};

// --- OBTENER DETALLE ---
const getInspeccionDetalle = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request().input('idInspeccion', mssql.Int, id).query('EXEC SP_GET_InspeccionDetalle @idInspeccion');
        if (result.recordset.length === 0) return res.status(404).json({ msg: 'Inspección no encontrada' });
        res.json(result.recordset[0]);
    } catch (err) {
        console.error(err);
        res.status(500).send('Error del servidor');
    }
};

// --- CREAR NUEVO FORMULARIO (Estructura) ---
const crearNuevoFormulario = async (req, res) => {
    const { idFormulario, nombreFormulario, descripcion, tipoActivoAsociado, preguntas, categoria, visibleColaborador } = req.body;
    try {
        const pool = await poolPromise;
        const jsonPreguntas = JSON.stringify(preguntas);
        
        await pool.request()
            .input('idFormulario', mssql.NVarChar, idFormulario)
            .input('nombreFormulario', mssql.NVarChar, nombreFormulario)
            .input('descripcion', mssql.NVarChar, descripcion)
            .input('tipoActivoAsociado', mssql.NVarChar, tipoActivoAsociado)
            .input('jsonPreguntas', mssql.NVarChar(mssql.MAX), jsonPreguntas)
            .input('categoria', mssql.NVarChar, categoria || 'General')
            .input('visibleColaborador', mssql.Bit, visibleColaborador ? 1 : 0)
            .query('EXEC SP_CREATE_NuevoFormulario @idFormulario, @nombreFormulario, @descripcion, @tipoActivoAsociado, @jsonPreguntas, @categoria, @visibleColaborador');
        
        await logAction(req.usuario.id, req.usuario.nombre, 'CREAR_FORMULARIO', `Creó el formulario '${nombreFormulario}'`);
        res.status(201).json({ msg: 'Formulario creado exitosamente' });
    } catch (err) {
        console.error('Error en crearNuevoFormulario:', err.message);
        if (err.message.includes('El código del formulario ya existe')) return res.status(400).json({ msg: err.message });
        res.status(500).send('Error del servidor');
    }
};

// --- OBTENER LISTA DE FORMULARIOS ---
const getFormularios = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_Formularios');
        res.json(result.recordset);
    } catch (err) {
        console.error(err);
        res.status(500).send('Error del servidor');
    }
};

// --- OBTENER PREGUNTAS ---
const getPreguntasFormulario = async (req, res) => {
    const { idFormulario } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idFormulario', mssql.NVarChar, idFormulario)
            .query('EXEC SP_GET_PreguntasPorFormulario @idFormulario');
        res.json(result.recordset);
    } catch (err) {
        console.error(err);
        res.status(500).send('Error del servidor');
    }
};

// --- AGREGAR PREGUNTA ---
const agregarPregunta = async (req, res) => {
    const { id: idFormulario } = req.params;
    const { textoPregunta } = req.body;
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idFormulario', mssql.NVarChar, idFormulario)
            .input('textoPregunta', mssql.NVarChar, textoPregunta)
            .query('EXEC SP_ADD_Pregunta @idFormulario, @textoPregunta');
        res.status(201).json({ msg: 'Pregunta agregada' });
    } catch (err) {
        console.error(err);
        res.status(500).send('Error del servidor');
    }
};

// --- ELIMINAR PREGUNTA ---
const eliminarPregunta = async (req, res) => {
    const { id: idPregunta } = req.params;
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idPregunta', mssql.Int, idPregunta)
            .query('EXEC SP_DELETE_Pregunta @idPregunta');
        res.json({ msg: 'Pregunta eliminada' });
    } catch (err) {
        if (err.message.includes('ya ha sido respondida')) return res.status(400).json({ msg: err.message });
        console.error(err);
        res.status(500).send('Error del servidor');
    }
};

// --- CAMBIAR VISIBILIDAD ---
const toggleVisibilidad = async (req, res) => {
    const { id } = req.params;
    const { visible } = req.body;
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idFormulario', mssql.NVarChar, id)
            .input('visible', mssql.Bit, visible ? 1 : 0)
            .query('EXEC SP_UPDATE_Formulario_Visibilidad @idFormulario, @visible');
        res.json({ msg: 'Visibilidad actualizada' });
    } catch (err) {
        console.error(err);
        res.status(500).send('Error del servidor');
    }
};

const inspectionController = {
    crearInspeccion,
    getInspeccionesHistorial,
    getInspeccionDetalle,
    crearNuevoFormulario,
    getFormularios,
    getPreguntasFormulario,
    agregarPregunta,
    eliminarPregunta,
    toggleVisibilidad
};

export default inspectionController;


==================================================================
ARCHIVO: backend\controllers\logController.js
==================================================================
// backend/src/controllers/logController.js

import { poolPromise, mssql } from '../config/dbConfig.js';

/**
 * @controller  getLogs
 * @desc        Obtiene la lista de todos los registros de auditoría (filtrados)
 */
const getLogs = async (req, res) => {
    // Los filtros ahora vienen en el body
    const { idUsuario, accion, fechaInicio, fechaFin } = req.body;

    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idUsuario', mssql.Int, idUsuario || null)
            .input('accion', mssql.NVarChar(100), accion || null)
            .input('fechaInicio', mssql.Date, fechaInicio || null)
            .input('fechaFin', mssql.Date, fechaFin || null)
            .query('EXEC SP_GET_AuditLog @idUsuario, @accion, @fechaInicio, @fechaFin');
        
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getLogs:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getLogFiltros
 * @desc        Obtiene las listas de usuarios y acciones para los filtros
 */
const getLogFiltros = async (req, res) => {
    try {
        const pool = await poolPromise;
        // El SP devuelve 2 tablas: [0] = Usuarios, [1] = Acciones
        const result = await pool.request().query('EXEC SP_GET_AuditLog_Filtros');
        
        res.json({
            usuarios: result.recordsets[0] || [],
            acciones: result.recordsets[1] || []
        });
    } catch (err) {
        console.error('Error en getLogFiltros:', err.message);
        res.status(500).send('Error del servidor');
    }
};


const logController = {
    getLogs,
    getLogFiltros // <-- AÑADIDO
};

export default logController;


==================================================================
ARCHIVO: backend\controllers\medicalController.js
==================================================================
// backend/controllers/medicalController.js

import { validationResult } from 'express-validator';
import { poolPromise, mssql } from '../config/dbConfig.js';
import PDFDocument from 'pdfkit';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// (getHistorialExamenes - sin cambios)
const getHistorialExamenes = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_ExamenesHistorial');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getHistorialExamenes:', err.message);
        res.status(500).send('Error del servidor');
    }
};

// (crearExamenMedico - sin cambios)
const crearExamenMedico = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) return res.status(400).json({ errors: errors.array() });

    const {
        idUsuarioColaborador, tipoExamen, fechaExamen, conceptoAptitud,
        recomendacionesGenerales, observaciones, recomendacionesOcupacionales, 
        medicoEspecialista, entidadEmite, duracionRecomendaciones, resumenCaso, compromisos
    } = req.body;
    const idUsuarioAdminRegistra = req.usuario.id;

    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idUsuarioColaborador', mssql.Int, idUsuarioColaborador)
            .input('idUsuarioAdminRegistra', mssql.Int, idUsuarioAdminRegistra)
            .input('tipoExamen', mssql.NVarChar, tipoExamen)
            .input('fechaExamen', mssql.Date, fechaExamen)
            .input('conceptoAptitud', mssql.NVarChar, conceptoAptitud)
            .input('recomendacionesGenerales', mssql.NVarChar, recomendacionesGenerales || null)
            .input('observaciones', mssql.NVarChar, observaciones || null)
            .input('recomendacionesOcupacionales', mssql.NVarChar, recomendacionesOcupacionales || null)
            .input('medicoEspecialista', mssql.NVarChar, medicoEspecialista || null)
            .input('entidadEmite', mssql.NVarChar, entidadEmite || null)
            .input('duracionRecomendaciones', mssql.NVarChar, duracionRecomendaciones || null)
            .input('resumenCaso', mssql.NVarChar, resumenCaso || null)
            .input('compromisos', mssql.NVarChar, compromisos || null)
            .query('EXEC SP_CREATE_ExamenMedico @idUsuarioColaborador, @idUsuarioAdminRegistra, @tipoExamen, @fechaExamen, @conceptoAptitud, @recomendacionesGenerales, @observaciones, @recomendacionesOcupacionales, @medicoEspecialista, @entidadEmite, @duracionRecomendaciones, @resumenCaso, @compromisos');

        res.status(201).json({ msg: 'Examen médico registrado exitosamente' });
    } catch (err) {
        console.error('Error en crearExamenMedico:', err.message);
        res.status(500).send('Error del servidor');
    }
};

// (getExamenMedicoDetalle - sin cambios)
const getExamenMedicoDetalle = async (req, res) => {
    const { id: idExamenMedico } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idExamenMedico', mssql.Int, idExamenMedico)
            .query('EXEC SP_GET_ExamenMedicoDetalle @idExamenMedico');
        if (result.recordset.length === 0) return res.status(404).json({ msg: 'Examen médico no encontrado' });
        res.json(result.recordset[0]);
    } catch (err) {
        console.error('Error en getExamenMedicoDetalle:', err.message);
        res.status(500).send('Error del servidor');
    }
};

// --- GENERAR PDF ---
const generarPdfRecomendaciones = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idExamenMedico', mssql.Int, id)
            .query('EXEC SP_GET_ExamenMedicoDetalle @idExamenMedico');

        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Examen médico no encontrado' });
        }

        const data = result.recordset[0];
        
        // 1. BUFFER PAGES (Paginación automática)
        const doc = new PDFDocument({ margin: 50, size: 'A4', bufferPages: true });

        const filename = `Recomendaciones-${data.CedulaColaborador || 'NA'}.pdf`;
        res.setHeader('Content-Type', 'application/pdf');
        res.setHeader('Content-Disposition', `attachment; filename="${filename}"`);
        doc.pipe(res);

        const startX = 50;
        let y = 40; 

        // === LOGO ===
        const logoPath = path.resolve(__dirname, '..', 'assets', 'logo.png');
        let logoHeight = 0;
        try {
            doc.image(logoPath, 60, 10, { width: 120 });
            logoHeight = 60;
        } catch {
            doc.font('Helvetica-Bold').text('EMPRESA', startX, y);
            logoHeight = 20;
        }

        // === ENCABEZADO ===
        const headerX = startX + 120;
        const headerWidth = 390;
        
        doc.font('Helvetica-Bold').fontSize(14).fillColor('#000000')
           .text('Acta de notificación de restricciones y/o recomendaciones médicas',
               headerX, y + 5, { align: 'center', width: headerWidth });
        
        doc.moveDown(0.3);
        
        // Guardar posición Y para la paginación (debajo del título)
        const subtitleY = doc.y; 
        doc.fontSize(9);
        doc.moveDown(1); // Espacio reservado

        doc.moveDown(2);
        doc.y = y + logoHeight + 30;
        doc.fillColor('#000000'); 

        const seccion = (titulo) => {
            doc.moveDown(1);
            doc.font('Helvetica-Bold').fontSize(11).fillColor('#000000')
                .text(titulo.toUpperCase(), startX);
            doc.moveDown(0.4);
            doc.font('Helvetica').fontSize(10).fillColor('#000000');
        };

        // === DATOS ===
        let contentX = 50;
        let contentY = doc.y;
        doc.y = contentY;

        seccion("Datos del colaborador");
        doc.text(`Nombre: ${data.NombreColaborador || ''}`, contentX);
        doc.text(`C.C: ${data.CedulaColaborador || ''}`, contentX);
        
        const fechaExamenStr = new Date(data.FechaExamen).toLocaleDateString('es-CO', { timeZone: 'UTC' });
        doc.text(`Fecha del Examen: ${fechaExamenStr}`, contentX);
        
        doc.text(`Tipo de Examen: ${data.TipoExamen || ''}`, contentX);
        doc.text(`Concepto de Aptitud: ${data.ConceptoAptitud || ''}`, contentX);

        seccion("Información del concepto");
        doc.text(`Persona que emite el concepto (Médico): ${data.MedicoEspecialista || 'No registra'}`, contentX);
        doc.text(`Entidad que emite el concepto (ARL/EPS): ${data.EntidadEmite || 'No registra'}`, contentX);
        doc.text(`Duración de las recomendaciones: ${data.DuracionRecomendaciones || 'No registra'}`, contentX);

        seccion("Temas tratados: breve resumen del caso");
        doc.text(data.ResumenCaso || 'No se registró un resumen del caso.', contentX, doc.y, { width: 480, align: 'justify' });

        seccion("Ampliación de las recomendaciones médicas (no ocupacionales)");
        doc.text(data.RecomendacionesGenerales || 'Sin recomendaciones médicas generales.', contentX, doc.y, { width: 480, align: 'justify' });

        seccion("Recomendaciones ocupacionales (para el trabajo)");
        doc.text(data.RecomendacionesOcupacionales || 'Sin recomendaciones ocupacionales específicas.', contentX, doc.y, { width: 480, align: 'justify' });

        seccion("Compromisos");
        doc.text(data.Compromisos || 'Sin compromisos registrados.', contentX, doc.y, { width: 480, align: 'justify' });

        // === FIRMAS (Restaurado al formato ORIGINAL) ===
        
        if (doc.y > 600) doc.addPage(); 

        doc.moveDown(4);
        seccion("En constancia de lo anterior se firma por parte de los asistentes:");
        doc.moveDown(3);
        doc.font('Helvetica').fontSize(10);
        
        // Formato vertical exacto como pediste
        doc.text('___________________________________', contentX);
        doc.text('Nombre:', contentX);
        doc.text('Cargo/Empresa:', contentX);
        doc.text('N° Identificación:', contentX);
        doc.text('Firma:', contentX);

        // === 2. ESCRITURA FINAL DE PÁGINAS ===
        const range = doc.bufferedPageRange();
        const totalPages = range.count;

        for (let i = 0; i < totalPages; i++) {
            doc.switchToPage(i);

            if (i === 0) {
                const fechaEmision = new Date().toLocaleDateString('es-CO');
                doc.font('Helvetica').fontSize(9).fillColor('#6c757d')
                   .text(
                       `Fecha Emisión: ${fechaEmision}    Fecha Revisión: ${fechaEmision}    Páginas: ${i + 1} de ${totalPages}`,
                       headerX, 
                       subtitleY, 
                       { align: 'center', width: headerWidth }
                   );
            } else {
                doc.font('Helvetica').fontSize(9).fillColor('#6c757d')
                   .text(`Página ${i + 1} de ${totalPages}`, 50, 30, { align: 'right' });
            }
        }

        doc.end();

    } catch (err) {
        console.error('Error en generarPdfRecomendaciones:', err.message);
        if (!res.headersSent) {
            res.status(500).send('Error del servidor al generar el PDF');
        }
    }
};

const medicalController = {
    getHistorialExamenes,
    crearExamenMedico,
    getExamenMedicoDetalle, 
    generarPdfRecomendaciones
};

export default medicalController;


==================================================================
ARCHIVO: backend\controllers\notificationController.js
==================================================================
// backend/controllers/notificationController.js
import { poolPromise, mssql } from '../config/dbConfig.js';

const getMisNotificaciones = async (req, res) => {
    const { id, rol } = req.usuario;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idUsuario', mssql.Int, id)
            .input('rolUsuario', mssql.NVarChar, rol)
            .query('EXEC SP_GET_MisNotificaciones @idUsuario, @rolUsuario');
        res.json(result.recordset);
    } catch (err) {
        console.error(err);
        res.status(500).send('Error al obtener notificaciones');
    }
};

const marcarLeida = async (req, res) => {
    const { id } = req.params; // ID Notificación
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idNotificacion', mssql.Int, id)
            .query('EXEC SP_MARK_NotificacionLeida @idNotificacion');
        res.json({ msg: 'Leída' });
    } catch (err) {
        console.error(err);
        res.status(500).send('Error');
    }
};

export default { getMisNotificaciones, marcarLeida };


==================================================================
ARCHIVO: backend\controllers\pesvController.js
==================================================================
// backend/controllers/pesvController.js

import { poolPromise, mssql } from '../config/dbConfig.js';
import { generarActaPDF } from '../utils/pdfGenerator.js';
import path from 'path';
import { fileURLToPath } from 'url';
import fs from 'fs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// --- GESTIÓN DE ARCHIVOS ---
const descargarArchivo = (req, res) => {
    const { filename } = req.params;
    const rutaArchivo = path.join(__dirname, '../uploads', filename);
    if (fs.existsSync(rutaArchivo)) {
        res.download(rutaArchivo); 
    } else {
        res.status(404).send('Archivo no encontrado');
    }
};

const getDocumentosGenerados = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_DocumentosInternos');
        res.json(result.recordset);
    } catch (err) { console.error(err); res.status(500).send('Error'); }
};

// --- NUEVO: REEMPLAZAR EVIDENCIA ---
const reemplazarEvidencia = async (req, res) => {
    const { idEvidencia } = req.body;
    const nuevoArchivo = req.file;

    if (!nuevoArchivo) return res.status(400).json({ msg: 'No se subió archivo' });

    try {
        const nombreArchivo = nuevoArchivo.originalname;
        const rutaArchivo = nuevoArchivo.path.replace(/\\/g, '/'); // Normalizar ruta

        const pool = await poolPromise;
        await pool.request()
            .input('idEvidencia', mssql.Int, idEvidencia)
            .input('nombreArchivo', mssql.NVarChar, nombreArchivo)
            .input('rutaArchivo', mssql.NVarChar, rutaArchivo)
            .query('EXEC SP_UPDATE_Evidencia_Archivo @idEvidencia, @nombreArchivo, @rutaArchivo');

        res.json({ msg: 'Evidencia actualizada correctamente' });
    } catch (err) {
        console.error(err);
        res.status(500).send('Error reemplazando evidencia');
    }
};

// --- CONDUCTORES ---
const getConductoresPESV = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_ConductoresPESV');
        res.json(result.recordset);
    } catch (err) { console.error(err); res.status(500).send('Error'); }
};

const guardarInfoConductor = async (req, res) => {
    const { idUsuario, numeroLicencia, categoria, vencimiento } = req.body;
    const archivoLicencia = req.file ? req.file.path.replace(/\\/g, '/') : null;
    try {
        const pool = await poolPromise;
        await pool.request().input('idUsuario', mssql.Int, idUsuario).input('numeroLicencia', mssql.NVarChar, numeroLicencia).input('categoria', mssql.NVarChar, categoria).input('vencimiento', mssql.Date, vencimiento).input('rutaLicencia', mssql.NVarChar, archivoLicencia).query('EXEC SP_SAVE_InfoConductor @idUsuario, @numeroLicencia, @categoria, @vencimiento, @rutaLicencia');
        res.json({ msg: 'Guardado' });
    } catch (err) { console.error(err); res.status(500).send('Error'); }
};

// --- MANTENIMIENTOS ---
const crearMantenimiento = async (req, res) => {
    const { idActivo, tipo, fecha, kilometraje, descripcion, taller, costo } = req.body;
    try {
        const pool = await poolPromise;
        await pool.request().input('idActivo', mssql.Int, idActivo).input('tipo', mssql.NVarChar, tipo).input('fecha', mssql.Date, fecha).input('kilometraje', mssql.Int, kilometraje).input('descripcion', mssql.NVarChar, descripcion).input('taller', mssql.NVarChar, taller).input('costo', mssql.Decimal(18, 2), costo).query('EXEC SP_CREATE_Mantenimiento @idActivo, @tipo, @fecha, @kilometraje, @descripcion, @taller, @costo');
        res.json({ msg: 'Registrado' });
    } catch (err) { console.error(err); res.status(500).send('Error'); }
};

const getMantenimientos = async (req, res) => {
    const { idActivo } = req.query; 
    try {
        const pool = await poolPromise;
        const result = await pool.request().input('idActivo', mssql.Int, idActivo || null).query('EXEC SP_GET_Mantenimientos @idActivo');
        res.json(result.recordset);
    } catch (err) { console.error(err); res.status(500).send('Error'); }
};

// --- PASOS PESV ---
const getPasosPESV = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_PasosPESV');
        res.json(result.recordset);
    } catch (err) { console.error(err); res.status(500).send('Error'); }
};

const getEvidenciasPorPaso = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request().input('idPaso', mssql.Int, id).query('EXEC SP_GET_Evidencias_Por_Paso @idPaso');
        res.json(result.recordset);
    } catch (err) { console.error(err); res.status(500).send('Error'); }
};

const actualizarPasoPESV = async (req, res) => {
    const { idPaso, estado } = req.body;
    const archivoEvidencia = req.file; 
    try {
        const pool = await poolPromise;
        const request = pool.request().input('idPaso', mssql.Int, idPaso).input('estado', mssql.NVarChar, estado);
        if (archivoEvidencia) {
            request.input('nombreArchivo', mssql.NVarChar, archivoEvidencia.originalname);
            request.input('rutaArchivo', mssql.NVarChar, archivoEvidencia.path.replace(/\\/g, '/'));
        } else {
            request.input('nombreArchivo', mssql.NVarChar, null);
            request.input('rutaArchivo', mssql.NVarChar, null);
        }
        await request.query('EXEC SP_UPDATE_PasoPESV @idPaso, @estado, @nombreArchivo, @rutaArchivo');
        res.json({ msg: 'Actualizado' });
    } catch (err) { console.error(err); res.status(500).send('Error'); }
};

// --- GENERACIÓN ---
const guardarConfiguracionPlantilla = async (req, res) => {
    const { idPaso, titulo, cuerpo, campos } = req.body; 
    try {
        const pool = await poolPromise;
        const jsonCampos = JSON.stringify(campos);
        await pool.request().input('idPaso', mssql.Int, idPaso).input('titulo', mssql.NVarChar, titulo).input('cuerpo', mssql.NVarChar, cuerpo).input('jsonCampos', mssql.NVarChar(mssql.MAX), jsonCampos).query('EXEC SP_SAVE_PlantillaPESV @idPaso, @titulo, @cuerpo, @jsonCampos');
        res.json({ msg: 'Guardado' });
    } catch (err) { console.error(err); res.status(500).send('Error'); }
};

const getPlantillaPaso = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request().input('idPaso', mssql.Int, id).query('EXEC SP_GET_PlantillaPaso @idPaso');
        if (result.recordsets[0].length === 0) return res.json({ existe: false });
        res.json({ existe: true, config: result.recordsets[0][0], campos: result.recordsets[1] });
    } catch (err) { console.error(err); res.status(500).send('Error'); }
};

const generarDocumentoPaso = async (req, res) => {
    const { idPaso, datosFormulario } = req.body; 
    try {
        const pool = await poolPromise;
        const resultConfig = await pool.request().input('idPaso', mssql.Int, idPaso).query('EXEC SP_GET_PlantillaPaso @idPaso');
        if (resultConfig.recordsets[0].length === 0) return res.status(400).json({ msg: 'No hay plantilla' });

        const configBD = resultConfig.recordsets[0][0];
        const camposBD = resultConfig.recordsets[1];
        const camposLlenos = camposBD.map(c => ({ label: c.Etiqueta, valor: datosFormulario[c.Etiqueta] || '---' }));

        const nombreArchivo = `Generado_Paso${idPaso}_${Date.now()}.pdf`;
        const rutaAbsoluta = path.join(__dirname, '../uploads', nombreArchivo);
        const rutaRelativa = `uploads/${nombreArchivo}`;

        await generarActaPDF({ titulo: configBD.TituloDocumento, cuerpo: configBD.CuerpoInicial, camposLlenos: camposLlenos }, null, rutaAbsoluta);

        await pool.request()
            .input('idPaso', mssql.Int, idPaso).input('estado', mssql.NVarChar, 'Realizado')
            .input('nombreArchivo', mssql.NVarChar, nombreArchivo).input('rutaArchivo', mssql.NVarChar, rutaRelativa)
            .query('EXEC SP_UPDATE_PasoPESV @idPaso, @estado, @nombreArchivo, @rutaArchivo');

        res.json({ msg: 'Generado', filename: nombreArchivo, ruta: rutaRelativa });
    } catch (err) { console.error(err); res.status(500).send('Error'); }
};

// --- CRUD PASOS ---
const crearPaso = async (req, res) => {
    const { numeroPaso, nombrePaso, descripcionNorma } = req.body;
    try {
        const pool = await poolPromise;
        await pool.request().input('numeroPaso', mssql.Int, numeroPaso).input('nombrePaso', mssql.NVarChar, nombrePaso).input('descripcionNorma', mssql.NVarChar, descripcionNorma).query('EXEC SP_CREATE_PasoPESV @numeroPaso, @nombrePaso, @descripcionNorma');
        res.json({ msg: 'Creado' });
    } catch (err) { console.error(err); res.status(500).send('Error'); }
};

const editarPasoInfo = async (req, res) => {
    const { idPaso, numeroPaso, nombrePaso, descripcionNorma } = req.body;
    try {
        const pool = await poolPromise;
        await pool.request().input('idPaso', mssql.Int, idPaso).input('numeroPaso', mssql.Int, numeroPaso).input('nombrePaso', mssql.NVarChar, nombrePaso).input('descripcionNorma', mssql.NVarChar, descripcionNorma).query('EXEC SP_UPDATE_PasoPESV_Info @idPaso, @numeroPaso, @nombrePaso, @descripcionNorma');
        res.json({ msg: 'Actualizado' });
    } catch (err) { console.error(err); res.status(500).send('Error'); }
};

const eliminarPaso = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        await pool.request().input('idPaso', mssql.Int, id).query('EXEC SP_DELETE_PasoPESV @idPaso');
        res.json({ msg: 'Eliminado' });
    } catch (err) { console.error(err); res.status(500).send('Error'); }
};

export default {
    getConductoresPESV,
    guardarInfoConductor,
    crearMantenimiento, 
    getMantenimientos,
    getPasosPESV, 
    getEvidenciasPorPaso, 
    actualizarPasoPESV,
    guardarConfiguracionPlantilla, 
    getPlantillaPaso,
    generarDocumentoPaso,
    crearPaso, 
    editarPasoInfo, 
    eliminarPaso,
    descargarArchivo, 
    getDocumentosGenerados,
    reemplazarEvidencia // <--- Exportar
};


==================================================================
ARCHIVO: backend\controllers\reportController.js
==================================================================
// backend/src/controllers/reportController.js

import { validationResult } from 'express-validator';
import { poolPromise, mssql } from '../config/dbConfig.js';
import path from 'path'; 
import { fileURLToPath } from 'url';
import { logAction } from '../services/logService.js';
import { crearNotificacion } from '../services/notificationService.js'; // <--- IMPORTANTE: Servicio de Notificaciones

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * @controller  crearReporteMaquina
 * @desc        (CU-07) Guarda un reporte de pre-uso de máquina y notifica
 */
const crearReporteMaquina = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) return res.status(400).json({ errors: errors.array() });
    
    const { idActivo, estadoReportado, descripcionProblema, datosReporte, kilometraje } = req.body;
    const idUsuarioReporta = req.usuario.id;
    const archivoFoto = req.file ? req.file.path : null;

    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idActivo', mssql.Int, idActivo)
            .input('idUsuarioReporta', mssql.Int, idUsuarioReporta)
            .input('estadoReportado', mssql.NVarChar, estadoReportado)
            .input('descripcionProblema', mssql.NVarChar, descripcionProblema || null)
            .input('rutaFotoAdjunta', mssql.NVarChar, archivoFoto)
            .input('datosReporte', mssql.NVarChar(mssql.MAX), datosReporte || null) 
            .input('kilometraje', mssql.Int, kilometraje || null)
            .query('EXEC SP_CREATE_ReporteMaquina @idActivo, @idUsuarioReporta, @estadoReportado, @descripcionProblema, @rutaFotoAdjunta, @datosReporte, @kilometraje');

        // --- NOTIFICACIÓN AUTOMÁTICA ---
        const icono = estadoReportado === 'Con Problema' ? '🔴' : '🔵';
        const tituloNoti = `${icono} Nuevo Reporte de Máquina`;
        const mensajeNoti = `${req.usuario.nombre} reportó estado: ${estadoReportado}.`;

        // Enviamos la notificación al Rol SST (El Super Admin también la verá si consulta por rol o si se ajusta el SP)
        await crearNotificacion({
            rolDestino: 'Administrador SST', 
            titulo: tituloNoti,
            mensaje: mensajeNoti,
            ruta: '/reportes' // Ruta a la que irá el admin al dar clic
        });
        // -------------------------------

        res.status(201).json({ msg: 'Reporte enviado exitosamente' });
    } catch (err) {
        if (err.message.includes('Se debe describir el problema')) {
            return res.status(400).json({ msg: 'Debe describir el problema si el estado es "Con Problema"' });
        }
        console.error('Error en crearReporteMaquina:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  crearReporteSeguridad
 * @desc        (CU-08) Guarda un reporte de seguridad y notifica
 */
const crearReporteSeguridad = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) return res.status(400).json({ errors: errors.array() });

    const { tipoReporte, ubicacionArea, descripcion } = req.body;
    const idUsuarioReporta = req.usuario.id;
    const archivoFoto = req.file ? req.file.path : null;

    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idUsuarioReporta', mssql.Int, idUsuarioReporta)
            .input('tipoReporte', mssql.NVarChar, tipoReporte)
            .input('ubicacionArea', mssql.NVarChar, ubicacionArea)
            .input('descripcion', mssql.NVarChar, descripcion)
            .input('rutaFotoAdjunta', mssql.NVarChar, archivoFoto) 
            .query('EXEC SP_CREATE_ReporteSeguridad @idUsuarioReporta, @tipoReporte, @ubicacionArea, @descripcion, @rutaFotoAdjunta');

        // --- NOTIFICACIÓN AUTOMÁTICA ---
        await crearNotificacion({
            rolDestino: 'Administrador SST',
            titulo: `⚠️ Nuevo Reporte de Seguridad`,
            mensaje: `${req.usuario.nombre} reportó un ${tipoReporte} en ${ubicacionArea}.`,
            ruta: '/reportes'
        });
        // -------------------------------

        res.status(201).json({ msg: 'Reporte de seguridad enviado exitosamente' });
    } catch (err) {
        console.error('Error en crearReporteSeguridad:', err.message);
        if (err.message.includes('Solo se permiten')) {
            return res.status(400).json({ msg: err.message });
        }
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getReportesMaquina
 * @desc        (Admin) Lista de reportes de máquina
 */
const getReportesMaquina = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_ReportesMaquina');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getReportesMaquina:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getReportesSeguridad
 * @desc        (Admin) Lista de reportes de seguridad
 */
const getReportesSeguridad = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_ReportesSeguridad');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getReportesSeguridad:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getReporteMaquinaDetalle
 * @desc        Obtiene detalle. Si es Admin, marca como revisado (1). Si es Colaborador, solo lee (0).
 */
const getReporteMaquinaDetalle = async (req, res) => {
    const { id: idReporte } = req.params;
    
    // Lógica de permisos: Solo Admins marcan como revisado
    const esAdmin = ['Administrador SST', 'Super Admin', 'Gestion de Calidad'].includes(req.usuario.rol);
    const marcarRevisado = esAdmin ? 1 : 0;

    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idReporteMaquina', mssql.Int, idReporte)
            .input('marcarRevisado', mssql.Bit, marcarRevisado)
            .query('EXEC SP_GET_ReporteMaquinaDetalle @idReporteMaquina, @marcarRevisado');
        
        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Reporte de máquina no encontrado' });
        }

        // Log solo si hubo cambio real de estado por un admin
        if (esAdmin && result.recordset[0].EstadoRevision === 'Revisado') {
             await logAction(
                req.usuario.id, 
                req.usuario.nombre, 
                'REVISAR_REPORTE_MAQUINA', 
                `Revisó el reporte de máquina ID: ${idReporte}`
            );
        }

        res.json(result.recordset[0]);
    } catch (err) {
        console.error('Error en getReporteMaquinaDetalle:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getReporteSeguridadDetalle
 * @desc        Obtiene detalle. Si es Admin, marca como revisado (1). Si es Colaborador, solo lee (0).
 */
const getReporteSeguridadDetalle = async (req, res) => {
    const { id: idReporte } = req.params;
    
    const esAdmin = ['Administrador SST', 'Super Admin', 'Gestion de Calidad'].includes(req.usuario.rol);
    const marcarRevisado = esAdmin ? 1 : 0;

    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idReporteSeguridad', mssql.Int, idReporte)
            .input('marcarRevisado', mssql.Bit, marcarRevisado)
            .query('EXEC SP_GET_ReporteSeguridadDetalle @idReporteSeguridad, @marcarRevisado');
        
        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Reporte de seguridad no encontrado' });
        }

        if (esAdmin && result.recordset[0].EstadoRevision === 'Revisado') {
            await logAction(
                req.usuario.id, 
                req.usuario.nombre, 
                'REVISAR_REPORTE_SEGURIDAD', 
                `Revisó el reporte de seguridad ID: ${idReporte}`
            );
        }

        res.json(result.recordset[0]);
    } catch (err) {
        console.error('Error en getReporteSeguridadDetalle:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getMisReportesMaquina
 * @desc        (Colaborador) Obtiene sus reportes de máquina
 */
const getMisReportesMaquina = async (req, res) => {
    const idUsuario = req.usuario.id;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idUsuario', mssql.Int, idUsuario)
            .query('EXEC SP_GET_MisReportesMaquina @idUsuario');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getMisReportesMaquina:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getMisReportesSeguridad
 * @desc        (Colaborador) Obtiene sus reportes de seguridad
 */
const getMisReportesSeguridad = async (req, res) => {
    const idUsuario = req.usuario.id;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idUsuario', mssql.Int, idUsuario)
            .query('EXEC SP_GET_MisReportesSeguridad @idUsuario');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getMisReportesSeguridad:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const reportController = {
    crearReporteMaquina,
    crearReporteSeguridad,
    getReportesMaquina,
    getReportesSeguridad,
    getReporteMaquinaDetalle,
    getReporteSeguridadDetalle,
    getMisReportesMaquina,
    getMisReportesSeguridad
};

export default reportController;


==================================================================
ARCHIVO: backend\controllers\requestController.js
==================================================================
// backend/controllers/requestController.js

import { poolPromise, mssql } from '../config/dbConfig.js';
import { estamparFirmaEnPDF } from '../utils/signer.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// --- 1. CREAR SOLICITUD (SST) ---
const crearSolicitud = async (req, res) => {
    const { tipo, mensaje, rutaDocumentoInterno } = req.body;
    const idUsuario = req.usuario.id;
    
    // Lógica dual: Archivo subido desde PC -O- Ruta interna del software
    let rutaDocFinal = null;

    if (req.file) {
        // Si suben archivo desde PC, normalizamos la ruta
        rutaDocFinal = req.file.path.replace(/\\/g, '/');
    } else if (rutaDocumentoInterno) {
        // Si eligen uno del sistema, ya viene como 'uploads/archivo.pdf'
        rutaDocFinal = rutaDocumentoInterno;
    }

    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idUsuario', mssql.Int, idUsuario)
            .input('tipo', mssql.NVarChar, tipo)
            .input('mensaje', mssql.NVarChar, mensaje)
            .input('rutaDoc', mssql.NVarChar, rutaDocFinal)
            .query('EXEC SP_CREATE_Solicitud @idUsuario, @tipo, @mensaje, @rutaDoc');
        
        res.json({ msg: 'Solicitud enviada al Super Admin' });
    } catch (err) {
        console.error(err); res.status(500).send('Error enviando solicitud');
    }
};

// --- 2. OBTENER LISTA DE SOLICITUDES ---
const getSolicitudes = async (req, res) => {
    const { id, rol } = req.usuario;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idUsuario', mssql.Int, id)
            .input('rolUsuario', mssql.NVarChar, rol)
            .query('EXEC SP_GET_Solicitudes @idUsuario, @rolUsuario');
        res.json(result.recordset);
    } catch (err) {
        console.error(err); res.status(500).send('Error obteniendo solicitudes');
    }
};

// --- 3. RESPONDER Y FIRMAR (SUPER ADMIN) ---
const responderSolicitud = async (req, res) => {
    const { idSolicitud, estado, comentario, rutaDocumentoOriginal } = req.body;
    const archivoFirma = req.file; // Imagen de la firma

    // Datos fijos o dinámicos para la firma
    const nombreFirmante = req.usuario.nombre; 
    const cargoFirmante = "GERENTE DE OPERACIONES"; 

    let rutaFirmadoFinal = null;

    try {
        // SI SE APRUEBA + HAY DOC ORIGINAL + HAY IMAGEN DE FIRMA
        if (estado === 'Aprobado' && rutaDocumentoOriginal && archivoFirma) {
            
            const nombrePdfFirmado = `Firmado_Solicitud${idSolicitud}_${Date.now()}.pdf`;
            
            // CORRECCIÓN DE RUTA PARA ENCONTRAR EL ORIGINAL
            // Si la ruta en BD es "uploads/archivo.pdf", subimos un nivel desde controllers (../)
            let rutaRelativaLimpia = rutaDocumentoOriginal.startsWith('backend/') 
                ? rutaDocumentoOriginal.replace('backend/', '') 
                : rutaDocumentoOriginal;

            const pathOriginal = path.join(__dirname, '../', rutaRelativaLimpia); 
            const pathSalida = path.join(__dirname, '../uploads', nombrePdfFirmado);
            const pathFirma = archivoFirma.path;

            if (fs.existsSync(pathOriginal)) {
                // Llamamos a la utilidad de firma con el cargo específico
                await estamparFirmaEnPDF(
                    pathOriginal, 
                    pathFirma, 
                    pathSalida,
                    nombreFirmante,
                    cargoFirmante
                );
                
                rutaFirmadoFinal = `uploads/${nombrePdfFirmado}`;
                
                // Limpiar imagen temporal de la firma
                try { fs.unlinkSync(pathFirma); } catch(e){}
            } else {
                console.warn("⚠️ El documento original no existe en:", pathOriginal);
                return res.status(404).json({ msg: 'No se encontró el documento original en el servidor.' });
            }
        }

        // Actualizar Base de Datos
        const pool = await poolPromise;
        await pool.request()
            .input('idSolicitud', mssql.Int, idSolicitud)
            .input('estado', mssql.NVarChar, estado)
            .input('comentario', mssql.NVarChar, comentario)
            .input('rutaFirmado', mssql.NVarChar, rutaFirmadoFinal)
            .query('EXEC SP_UPDATE_ResponderSolicitud @idSolicitud, @estado, @comentario, @rutaFirmado');
        
        res.json({ msg: 'Respuesta registrada correctamente', rutaFirmado: rutaFirmadoFinal });

    } catch (err) {
        console.error('Error respondiendo:', err);
        res.status(500).send('Error al procesar la solicitud: ' + err.message);
    }
};

// --- 4. ACTUALIZAR DOCUMENTO MANUALMENTE (BOTÓN RECICLAJE) ---
const actualizarDocumentoFirmado = async (req, res) => {
    const { idSolicitud } = req.body;
    const archivo = req.file;

    if (!archivo) {
        return res.status(400).json({ msg: 'No se subió ningún archivo' });
    }

    try {
        const rutaFinal = archivo.path.replace(/\\/g, '/');
        
        const pool = await poolPromise;
        await pool.request()
            .input('idSolicitud', mssql.Int, idSolicitud)
            .input('rutaNuevoDoc', mssql.NVarChar, rutaFinal)
            .query('EXEC SP_UPDATE_Solicitud_DocFirmado @idSolicitud, @rutaNuevoDoc');

        res.json({ msg: 'Documento actualizado correctamente' });

    } catch (err) {
        console.error(err);
        res.status(500).send('Error actualizando documento');
    }
};

export default { crearSolicitud, getSolicitudes, responderSolicitud, actualizarDocumentoFirmado };


==================================================================
ARCHIVO: backend\controllers\scheduleController.js
==================================================================
// backend/src/controllers/scheduleController.js

import { validationResult } from 'express-validator';
import { poolPromise, mssql } from '../config/dbConfig.js';
import { logAction } from '../services/logService.js'; 

const crearCronograma = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    const { nombreCronograma, anioAplicacion, descripcion } = req.body;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('nombreCronograma', mssql.NVarChar, nombreCronograma)
            .input('anioAplicacion', mssql.Int, anioAplicacion || null)
            .input('descripcion', mssql.NVarChar, descripcion || null)
            .query('EXEC SP_CREATE_Cronograma @nombreCronograma, @anioAplicacion, @descripcion'); 
        const nuevoCronogramaId = result.recordset[0].ID_Cronograma;

        await logAction(req.usuario.id, req.usuario.nombre, 'CREAR_CRONOGRAMA', `Creó el cronograma: '${nombreCronograma}' (ID: ${nuevoCronogramaId})`);

        res.status(201).json({ 
            msg: 'Cronograma creado exitosamente',
            idCronograma: nuevoCronogramaId 
        });
    } catch (err) {
        if (err.message.includes('Ya existe un cronograma')) { 
             return res.status(400).json({ msg: 'Ya existe un cronograma con ese nombre y año de aplicación' });
        }
        console.error('Error en crearCronograma:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getCronogramas = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_Cronogramas'); 
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getCronogramas:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  eliminarCronograma
 * @desc        Marca un cronograma como Inactivo (Con Validación)
 */
const eliminarCronograma = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        
        // Obtenemos el nombre antes de intentar borrar (para el log)
        const check = await pool.request().input('id', mssql.Int, id).query('SELECT NombreCronograma FROM Cronogramas WHERE ID_Cronograma = @id');
        if (check.recordset.length === 0) {
            return res.status(404).json({ msg: 'Cronograma no encontrado' });
        }
        const nombreCronograma = check.recordset[0].NombreCronograma;

        // Intentamos eliminar
        await pool.request()
            .input('idCronograma', mssql.Int, id)
            .query('EXEC SP_DELETE_Cronograma @idCronograma');

        // Si no hubo error en el SP, guardamos el log
        await logAction(req.usuario.id, req.usuario.nombre, 'ELIMINAR_CRONOGRAMA', `Eliminó (archivó) el cronograma: '${nombreCronograma}' (ID: ${id})`);

        res.json({ msg: 'Cronograma eliminado exitosamente' });

    } catch (err) {
        // --- CORRECCIÓN AQUÍ ---
        // Si el error viene del SP (RAISERROR), lo enviamos al frontend
        if (err.message.includes('No se puede eliminar')) {
            return res.status(400).json({ msg: err.message });
        }
        
        console.error('Error en eliminarCronograma:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const crearActividad = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }

    const { id: idCronograma } = req.params; 
    const { nombreActividad, fechaLimite, idUsuarioResponsable, descripcion } = req.body;

    try {
        const pool = await poolPromise;
        const fechaLimiteDate = new Date(fechaLimite);
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0); 
        if (fechaLimiteDate < hoy) {
            return res.status(400).json({ msg: 'La fecha límite no puede ser anterior a la fecha actual' });
        }
        const checkCronograma = await pool.request().input('idCronograma', mssql.Int, idCronograma).query('SELECT ID_Cronograma FROM dbo.Cronogramas WHERE ID_Cronograma = @idCronograma');
        if (checkCronograma.recordset.length === 0) {
            return res.status(404).json({ msg: 'Cronograma no encontrado' });
        }

        const result = await pool.request()
            .input('idCronograma', mssql.Int, idCronograma)
            .input('nombreActividad', mssql.NVarChar, nombreActividad)
            .input('descripcionActividad', mssql.NVarChar, descripcion || null)
            .input('idUsuarioResponsable', mssql.Int, idUsuarioResponsable)
            .input('fechaLimite', mssql.Date, fechaLimiteDate)
            .query('EXEC SP_CREATE_Actividad @idCronograma, @nombreActividad, @descripcionActividad, @idUsuarioResponsable, @fechaLimite');
        
        const nuevaActividadId = result.recordset[0].ID_Actividad;
        await logAction(req.usuario.id, req.usuario.nombre, 'CREAR_ACTIVIDAD', `Creó la actividad: '${nombreActividad}' (ID: ${nuevaActividadId})`);

        res.status(201).json({ msg: 'Actividad creada exitosamente', idActividad: nuevaActividadId });
    } catch (err) {
        console.error('Error en crearActividad:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getActividadesPorCronograma = async (req, res) => {
    const { id: idCronograma } = req.params; 
    try {
        const pool = await poolPromise;
        const checkCronograma = await pool.request().input('idCronograma', mssql.Int, idCronograma).query('SELECT ID_Cronograma FROM dbo.Cronogramas WHERE ID_Cronograma = @idCronograma');
        if (checkCronograma.recordset.length === 0) {
            return res.status(404).json({ msg: 'Cronograma no encontrado' });
        }
        const result = await pool.request()
            .input('idCronograma', mssql.Int, idCronograma)
            .query('EXEC SP_GET_ActividadesPorCronograma @idCronograma'); 
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getActividadesPorCronograma:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const scheduleController = {
    crearCronograma,
    getCronogramas,
    eliminarCronograma, 
    crearActividad,
    getActividadesPorCronograma
};

export default scheduleController;


==================================================================
ARCHIVO: backend\controllers\userController.js
==================================================================
// backend/src/controllers/userController.js

import { validationResult } from 'express-validator';
import bcrypt from 'bcryptjs';
import { poolPromise, mssql } from '../config/dbConfig.js';
import { logAction } from '../services/logService.js';

const crearColaborador = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }

    const { nombreCompleto, cedula, password, idRol, area, cargo } = req.body;

    try {
        const pool = await poolPromise;
        const salt = await bcrypt.genSalt(10);
        const passwordHash = await bcrypt.hash(password, salt);

        await pool.request()
            .input('nombreCompleto', mssql.NVarChar, nombreCompleto)
            .input('cedula', mssql.NVarChar, cedula)
            .input('passwordHash', mssql.NVarChar, passwordHash)
            .input('idRol', mssql.Int, idRol) 
            .input('area', mssql.NVarChar, area || null)
            .input('cargo', mssql.NVarChar, cargo || null)
            .query('EXEC SP_CREATE_Colaborador @nombreCompleto, @cedula, @passwordHash, @idRol, @area, @cargo'); 

        await logAction(req.usuario.id, req.usuario.nombre, 'CREAR_USUARIO', `Creó al usuario: ${nombreCompleto} (Cédula: ${cedula})`);

        res.status(201).json({ msg: 'Usuario creado exitosamente' });

    } catch (err) {
        if (err.message.includes('La cédula ingresada ya existe')) { 
            return res.status(400).json({ msg: 'La cédula ingresada ya existe' });
        }
        console.error('Error en crearColaborador:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getColaboradores = async (req, res) => {
    const idAdminLogueado = req.usuario.id; 
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idAdminLogueado', mssql.Int, idAdminLogueado) 
            .query('EXEC SP_GET_Colaboradores @idAdminLogueado'); 
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getColaboradores:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getTodosUsuarios = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_TodosUsuarios');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getTodosUsuarios:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getUsuarioPorCedula = async (req, res) => {
    const { cedula } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('cedula', mssql.NVarChar, cedula)
            .query('EXEC SP_GET_UsuarioPorCedula @cedula');
        
        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Usuario no encontrado o inactivo' });
        }
        
        res.json(result.recordset[0]);

    } catch (err) {
        console.error('Error en getUsuarioPorCedula:', err.message);
        res.status(500).send('Error del servidor');
    }
};

// --- NUEVA FUNCIÓN: Obtener lista de roles ---
const getRoles = async (req, res) => {
    try {
        const pool = await poolPromise;
        // Obtenemos ID y Nombre de los roles
        const result = await pool.request().query('SELECT ID_Rol, NombreRol FROM Roles ORDER BY ID_Rol ASC');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getRoles:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const editarColaborador = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    const { id } = req.params; 
    const { nombreCompleto, area, cargo } = req.body; 
    try {
        const pool = await poolPromise;
        const checkUser = await pool.request().input('id', mssql.Int, id).query('SELECT ID_Usuario FROM dbo.Usuarios WHERE ID_Usuario = @id');
        if (checkUser.recordset.length === 0) {
            return res.status(404).json({ msg: 'Usuario no encontrado' });
        }
        await pool.request()
            .input('idUsuario', mssql.Int, id)
            .input('nombreCompleto', mssql.NVarChar, nombreCompleto)
            .input('area', mssql.NVarChar, area || null)
            .input('cargo', mssql.NVarChar, cargo || null)
            .query('EXEC SP_UPDATE_Colaborador @idUsuario, @nombreCompleto, @area, @cargo'); 
        
        await logAction(req.usuario.id, req.usuario.nombre, 'EDITAR_USUARIO', `Editó al usuario: ${nombreCompleto} (ID: ${id})`);

        res.json({ msg: 'Colaborador actualizado exitosamente' });
    } catch (err) {
        console.error('Error en editarColaborador:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const cambiarEstadoColaborador = async (req, res) => {
    const { id } = req.params; 
    const { estado } = req.body; 
    try {
        const pool = await poolPromise;
        const checkUser = await pool.request().input('id', mssql.Int, id).query('SELECT ID_Usuario, NombreCompleto FROM dbo.Usuarios WHERE ID_Usuario = @id');
        if (checkUser.recordset.length === 0) {
            return res.status(404).json({ msg: 'Usuario no encontrado' });
        }
        const nombreAfectado = checkUser.recordset[0].NombreCompleto;

        await pool.request()
            .input('idUsuario', mssql.Int, id)
            .input('estado', mssql.NVarChar, estado)
            .query('EXEC SP_UPDATE_EstadoUsuario @idUsuario, @estado'); 
        
        await logAction(req.usuario.id, req.usuario.nombre, 'CAMBIAR_ESTADO_USUARIO', `Cambió estado a '${estado}' para: ${nombreAfectado}`);

        res.json({ msg: `Usuario ${estado.toLowerCase()} exitosamente` });
    } catch (err) {
        console.error('Error en cambiarEstadoColaborador:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const resetPasswordColaborador = async (req, res) => {
    const { id } = req.params; 
    const { password } = req.body; 
    try {
        const pool = await poolPromise;
        const checkUser = await pool.request().input('id', mssql.Int, id).query('SELECT ID_Usuario, NombreCompleto FROM dbo.Usuarios WHERE ID_Usuario = @id');
        if (checkUser.recordset.length === 0) {
            return res.status(404).json({ msg: 'Usuario no encontrado' });
        }
        const nombreAfectado = checkUser.recordset[0].NombreCompleto;

        const salt = await bcrypt.genSalt(10);
        const passwordHash = await bcrypt.hash(password, salt);
        await pool.request()
            .input('idUsuario', mssql.Int, id)
            .input('passwordHash', mssql.NVarChar, passwordHash)
            .query('EXEC SP_UPDATE_PasswordUsuario @idUsuario, @passwordHash'); 
        
        await logAction(req.usuario.id, req.usuario.nombre, 'RESETEAR_PASSWORD', `Reseteó contraseña para: ${nombreAfectado}`);

        res.json({ msg: 'Contraseña del colaborador actualizada exitosamente' });
    } catch (err) {
        console.error('Error en resetPasswordColaborador:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const userController = {
    crearColaborador,
    getColaboradores,
    getTodosUsuarios,
    getUsuarioPorCedula,
    getRoles, // <--- Se exporta la nueva función
    editarColaborador,
    cambiarEstadoColaborador,
    resetPasswordColaborador
};

export default userController;


==================================================================
ARCHIVO: backend\middleware\acpmFileUpload.js
==================================================================
// backend/middleware/acpmFileUpload.js

import multer from 'multer';
import path from 'path';

// 1. Dónde y cómo guardar los archivos
const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        cb(null, 'uploads/'); // Usa la misma carpeta 'uploads/'
    },
    filename: (req, file, cb) => {
        // Genera un nombre de archivo único para ACPM
        // Formato: acpm-IDACPM-timestamp.extension
        const idACPM = req.params.id; // Asume que el ID está en la URL
        const timestamp = Date.now();
        const extension = path.extname(file.originalname);
        
        cb(null, `acpm-${idACPM}-${timestamp}${extension}`);
    }
});

// 2. Filtro de archivos (igual al anterior)
const fileFilter = (req, file, cb) => {
    const allowedTypes = /jpeg|jpg|png|pdf/;
    const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
    const mimetype = allowedTypes.test(file.mimetype);

    if (mimetype && extname) {
        cb(null, true);
    } else {
        cb(new Error('Error: Solo se permiten archivos .jpg, .png o .pdf'), false);
    }
};

// 3. Creación del middleware de subida
const acpmUpload = multer({
    storage: storage,
    limits: { fileSize: 1024 * 1024 * 10 }, // Límite de 10 MB
    fileFilter: fileFilter
});

// Exportamos como 'default'
export default acpmUpload;


==================================================================
ARCHIVO: backend\middleware\authMiddleware.js
==================================================================
// backend/middleware/authMiddleware.js
import jwt from 'jsonwebtoken';
import 'dotenv/config.js';

/**
 * @middleware protect
 * @desc       Middleware para identificar el token y el usuario.
 */
const protect = (req, res, next) => {
    let token;

    const authHeader = req.headers.authorization;

    if (authHeader && authHeader.startsWith('Bearer')){
        try {
            token = authHeader.split(' ')[1];
            const decoded = jwt.verify(token, process.env.JWT_SECRET);
            req.usuario = decoded.usuario; // { id, nombre, rol }
            next();
        } catch (error) {
            console.error('Error de autenticacion:', error.message);
            res.status(401).json({msg: 'Token no valido, autorizacion denegada'});
        }
    }

    if(!token){
        res.status(401).json({msg: 'No hay token autorizacion denegada'});
    }
};

/**
 * @middleware admin
 * @desc       Middleware para verificar roles administrativos (SST o Super Admin)
 */
const admin = (req, res, next) => {
    // Verifica si existe el usuario y si tiene uno de los roles permitidos
    if (req.usuario && (req.usuario.rol === 'Administrador SST' || req.usuario.rol === 'Super Admin')){
        next();
    } else {
        res.status(403).json({msg:'Acceso denegado. Se requiere rol de administrador'});
    }
};

export { protect, admin };


==================================================================
ARCHIVO: backend\middleware\dmsFileUpload.js
==================================================================
// backend/middleware/dmsFileUpload.js

import multer from 'multer';
import path from 'path';

// --- 1. Definir tipos de archivo permitidos (RNF-017) ---
const allowedMimeTypes = [
    'application/pdf', // .pdf
    'application/msword', // .doc
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // .docx
    'application/vnd.ms-excel', // .xls
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
    'application/xml', // .xml
    'text/xml' // .xml
];

// --- 2. Dónde y cómo guardar ---
const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        // Guarda en una subcarpeta 'dms' para no mezclar con evidencias
        cb(null, 'uploads/dms'); 
    },
    filename: (req, file, cb) => {
        // Genera un nombre de archivo único (timestamp + nombre original)
        const timestamp = Date.now();
        const safeOriginalName = file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_');
        cb(null, `${timestamp}-${safeOriginalName}`);
    }
});

// --- 3. Filtro de archivos ---
const fileFilter = (req, file, cb) => {
    if (allowedMimeTypes.includes(file.mimetype)) {
        cb(null, true); // Archivo permitido
    } else {
        // Archivo rechazado (RNF-017)
        cb(new Error(`Tipo de archivo no permitido: ${file.mimetype}`), false);
    }
};

// --- 4. Creación del middleware de subida ---
// Usamos .array('archivos') para permitir subida múltiple
const dmsUpload = multer({
    storage: storage,
    limits: {
        fileSize: 1024 * 1024 * 25 // Límite de 25 MB (RNF-018)
    },
    fileFilter: fileFilter
});

export default dmsUpload;


==================================================================
ARCHIVO: backend\middleware\fileUpload.js
==================================================================
// backend/middleware/fileUpload.js

import multer from 'multer';
import path from 'path'; // Módulo 'path' de Node.js

/**
 * @middleware  fileUpload
 * @desc        Configuración de Multer para la subida de archivos
 */

// 1. Dónde y cómo guardar los archivos
const storage = multer.diskStorage({
    // Define la carpeta de destino
    destination: (req, file, cb) => {
        cb(null, 'uploads/'); // Asegúrate de que la carpeta 'uploads/' exista
    },
    // Define el nombre del archivo
    filename: (req, file, cb) => {
        // Genera un nombre de archivo único para evitar colisiones
        // Formato: actividad-IDActividad-timestamp.extension
        const idActividad = req.params.id; // Asume que el ID está en la URL
        const timestamp = Date.now();
        const extension = path.extname(file.originalname); // .jpg, .pdf
        
        cb(null, `actividad-${idActividad}-${timestamp}${extension}`);
    }
});

// 2. Filtro de archivos (basado en tu CU-01 y DB)
const fileFilter = (req, file, cb) => {
    // Define los tipos de archivo permitidos
    const allowedTypes = /jpeg|jpg|png|pdf/;
    
    // Comprueba la extensión del archivo
    const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
    // Comprueba el 'mimetype'
    const mimetype = allowedTypes.test(file.mimetype);

    if (mimetype && extname) {
        // Archivo permitido
        cb(null, true);
    } else {
        // Archivo rechazado
        cb(new Error('Error: Solo se permiten archivos .jpg, .png o .pdf'), false);
    }
};

// 3. Creación del middleware de subida
const upload = multer({
    storage: storage,
    limits: {
        fileSize: 1024 * 1024 * 10 // Límite de 10 MB por archivo
    },
    fileFilter: fileFilter
});

export default upload;


==================================================================
ARCHIVO: backend\package.json
==================================================================
{
  "name": "backend",
  "version": "1.0.0",
  "main": "index.js",
  "type": "module",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "description": "",
  "dependencies": {
    "bcrypt": "^6.0.0",
    "bcryptjs": "^3.0.2",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^5.1.0",
    "express-validator": "^7.3.0",
    "jsonwebtoken": "^9.0.2",
    "mssql": "^12.0.0",
    "multer": "^2.0.2",
    "pdf-lib": "^1.17.1",
    "pdfkit": "^0.17.2"
  },
  "devDependencies": {
    "nodemon": "^3.1.10"
  }
}



==================================================================
ARCHIVO: backend\routes\acpmRoutes.js
==================================================================
// backend/routes/acpmRoutes.js

import express from 'express';
import { check } from 'express-validator';
import acpmController from '../controllers/acpmController.js';
import { protect, admin } from '../middleware/authMiddleware.js';
import acpmUpload from '../middleware/acpmFileUpload.js';

const router = express.Router();

// POST /api/acpm (Crear ACPM)
router.post(
    '/',
    [ protect, admin ], 
    [
        check('tipoAccion', 'El tipo de acción es obligatorio').isIn(['Correctiva', 'Preventiva', 'Mejora']),
        check('origen', 'El origen es obligatorio').not().isEmpty(),
        check('descripcionProblema', 'La descripción del problema es obligatoria').not().isEmpty(),
        check('planAccion', 'El plan de acción es obligatorio').not().isEmpty(),
        // --- CAMBIO: Validación de ID ---
        check('idUsuarioResponsable', 'El responsable es obligatorio').isInt(),
        check('fechaLimite', 'La fecha límite es obligatoria').isISO8601()
    ],
    acpmController.crearACPM
);

// GET /api/acpm (Listar ACPM)
router.get(
    '/',
    [ protect, admin ], 
    acpmController.getACPMs
);

// GET /api/acpm/:id (Ver Detalle)
router.get(
    '/:id', 
    [ protect, admin ], 
    acpmController.getACPMDetalle
);

// PATCH /api/acpm/:id (Gestionar/Cerrar)
router.patch(
    '/:id', 
    [ protect, admin ], 
    acpmUpload.single('evidenciaCierre'), 
    [
        check('estadoACPM', 'El estado es obligatorio').isIn(['Abierta', 'En Proceso', 'Cerrada'])
    ],
    acpmController.gestionarACPM
);

// GET /api/acpm/:id/evidencias (Ver Evidencias)
router.get(
    '/:id/evidencias',
    [ protect, admin ],
    acpmController.getEvidenciasACPM
);

export default router;


==================================================================
ARCHIVO: backend\routes\activityRoutes.js
==================================================================
// backend/routes/activityRoutes.js

import express from 'express';
import { check } from 'express-validator';
import activityController from '../controllers/activityController.js';
import { protect, admin } from '../middleware/authMiddleware.js';
import upload from '../middleware/fileUpload.js';

const router = express.Router();

/**
 * @route   PUT /api/actividades/:id
 * @desc    Editar los detalles de una actividad (CU-10)
 */
router.put(
    '/:id', // :id es el ID_Actividad
    [ protect, admin ],
    [
        check('nombreActividad', 'El nombre de la actividad es obligatorio').not().isEmpty(),
        check('fechaLimite', 'La fecha límite es obligatoria y debe ser una fecha válida').isISO8601(),
        // --- CAMBIO: Validación de ID ---
        check('idUsuarioResponsable', 'El responsable es obligatorio').isInt()
    ],
    activityController.editarActividad
);

// DELETE /api/actividades/:id (Eliminar Actividad)
router.delete(
    '/:id', 
    [ protect, admin ], 
    activityController.eliminarActividad
);

// PATCH /api/actividades/:id/estado (Gestionar Estado/Evidencia)
router.patch(
    '/:id/estado',
    [ protect, admin ], 
    upload.single('evidenciaFile'), 
    [
        check('estado', 'El estado es obligatorio').isIn(['Pendiente', 'Realizada', 'Cancelada']),
        check('observaciones').optional().isString()
    ],
    activityController.gestionarActividad
);

// GET /api/actividades/:id/evidencias (Ver Evidencias)
router.get(
    '/:id/evidencias',
    [ protect, admin ],
    activityController.getEvidenciasActividad
);

/**
 * @route   GET /api/actividades/:id
 * @desc    Obtener el detalle completo de una actividad
 * @access  Privado (Admin)
 */
router.get(
    '/:id', 
    [ protect, admin ],
    activityController.getActividadDetalle // <-- NUEVA RUTA
);

export default router;


==================================================================
ARCHIVO: backend\routes\assetRoutes.js
==================================================================
// backend/routes/assetRoutes.js

import express from 'express';
import { check } from 'express-validator';
import assetController from '../controllers/assetController.js';
import { protect, admin } from '../middleware/authMiddleware.js';

const router = express.Router();

/**
 * @route   GET /api/activos/tipos
 * @desc    Obtener lista de tipos de activos
 * @access  Privado (Admin) - Se usa para crear activos
 */
router.get(
    '/tipos',
    [ protect, admin ],
    assetController.getTiposDisponibles
);

/**
 * @route   GET /api/activos/tipo/:tipo
 * @desc    Obtener lista de activos filtrados por tipo
 * @access  Privado (Cualquier rol logueado)
 */
router.get(
    '/tipo/:tipo',
    [ protect ], 
    assetController.getActivosPorTipo
);

/**
 * @route   GET /api/activos
 * @desc    Obtener lista de TODOS los activos
 * @access  Privado (Cualquier rol logueado) <--- CAMBIO IMPORTANTE
 */
router.get(
    '/',
    [ protect ], // <--- Antes tenía [protect, admin]. Ahora cualquiera puede ver la lista para reportar.
    assetController.getActivosTodos
);

/**
 * @route   POST /api/activos
 * @desc    Crear un nuevo activo
 * @access  Privado (Admin)
 */
router.post(
    '/',
    [ protect, admin ],
    [
        check('tipoActivo', 'El tipo de activo es obligatorio').not().isEmpty(),
        check('codigoIdentificador', 'El código identificador es obligatorio').not().isEmpty(),
        check('nombreDescriptivo', 'El nombre descriptivo es obligatorio').not().isEmpty()
    ],
    assetController.crearActivo
);

/**
 * @route   PUT /api/activos/:id
 * @desc    Actualizar un activo
 * @access  Privado (Admin)
 */
router.put(
    '/:id',
    [ protect, admin ],
    [
        check('tipoActivo', 'El tipo de activo es obligatorio').not().isEmpty(),
        check('codigoIdentificador', 'El código identificador es obligatorio').not().isEmpty(),
        check('nombreDescriptivo', 'El nombre descriptivo es obligatorio').not().isEmpty()
    ],
    assetController.actualizarActivo
);

/**
 * @route   DELETE /api/activos/:id
 * @desc    Eliminar un activo
 * @access  Privado (Admin)
 */
router.delete(
    '/:id',
    [ protect, admin ],
    assetController.eliminarActivo
);

export default router;


==================================================================
ARCHIVO: backend\routes\authRoutes.js
==================================================================
// backend/routes/authRoutes.js

import express from 'express';
import { check } from 'express-validator'; // Para validar los datos de entrada
import authController from '../controllers/authController.js';

const router = express.Router();

/**
 * @route   POST /api/auth/login
 * @desc    Autenticar usuario (Admin o Colaborador) y obtener token
 * @access  Public
 */
router.post(
    '/login',
    [
        // Validaciones: no deben estar vacíos
        check('cedula', 'La cédula es obligatoria').not().isEmpty(),
        check('password', 'La contraseña es obligatoria').not().isEmpty()
    ],
    authController.login // Llama a la función 'login' del controlador
);

export default router;


==================================================================
ARCHIVO: backend\routes\dashboardRoutes.js
==================================================================
// backend/routes/dashboardRoutes.js

import express from 'express';
import dashboardController from '../controllers/dashboardController.js';
import { protect, admin } from '../middleware/authMiddleware.js';

const router = express.Router();

/**
 * @route   GET /api/dashboard/admin-kpis
 * @desc    Obtener los 4 KPIs (contadores)
 */
router.get(
    '/admin-kpis',
    [ protect, admin ],
    dashboardController.getAdminKPIs
);

/**
 * @route   GET /api/dashboard/admin-actividades
 * @desc    Obtener lista Top 5 de actividades pendientes
 */
router.get(
    '/admin-actividades',
    [ protect, admin ],
    dashboardController.getAdminActividadesPendientes
);

/**
 * @route   GET /api/dashboard/admin-reportes
 * @desc    Obtener lista Top 5 de reportes nuevos
 */
router.get(
    '/admin-reportes',
    [ protect, admin ],
    dashboardController.getAdminReportesRecientes
);

/**
 * @route   GET /api/dashboard/super-admin
 * @desc    Data completa para Super Admin
 */
router.get(
    '/super-admin',
    [ protect, admin ], // Reutilizamos 'admin' ya que Super Admin también pasa por ahí
    dashboardController.getSuperAdminData
);

export default router;


==================================================================
ARCHIVO: backend\routes\documentRoutes.js
==================================================================
// backend/routes/documentRoutes.js

import express from 'express';
import { check } from 'express-validator';
import documentController from '../controllers/documentController.js';
import { protect, admin } from '../middleware/authMiddleware.js';
import dmsUpload from '../middleware/dmsFileUpload.js'; 

const router = express.Router();

// --- Rutas de Carpetas (CU-25) ---
router.get(
    '/carpeta/:id', 
    [ protect, admin ], 
    documentController.getContenidoCarpeta
);

router.post(
    '/carpeta', 
    [ protect, admin ],
    [
        check('nombreCarpeta', 'El nombre de la carpeta es obligatorio').not().isEmpty(),
        check('idCarpetaPadre', 'El ID de la carpeta padre es obligatorio').isInt()
    ],
    documentController.crearCarpeta
);

router.delete(
    '/carpeta/:id', 
    [ protect, admin ], 
    documentController.eliminarCarpeta
);


// --- Rutas de Archivos (CU-26, 27, 28) ---
router.post(
    '/upload', 
    [ protect, admin ], 
    dmsUpload.array('archivos'), 
    documentController.subirArchivos
);

router.get(
    '/descargar/:id', 
    [ protect, admin ], 
    documentController.descargarDocumento
);

router.delete(
    '/documento/:id',
    [ protect, admin ],
    documentController.eliminarDocumento
);

/**
 * @route   GET /api/documentos/stream/:id
 * @desc    Obtiene un archivo para visualizarlo (inline) (Tanda 3.D)
 * @access  Privado (Admin)
 */
router.get(
    '/stream/:id',
    [ protect, admin ],
    documentController.streamDocumento 
);

export default router;


==================================================================
ARCHIVO: backend\routes\indicatorRoutes.js
==================================================================
// backend/routes/indicatorRoutes.js
import express from 'express';
import indicatorController from '../controllers/indicatorController.js';
import { protect, admin } from '../middleware/authMiddleware.js';

const router = express.Router();

// Guardar indicador (Solo Admin SST/Super Admin)
router.post('/', [protect, admin], indicatorController.guardarIndicador);

// Obtener indicadores de un año
router.get('/:anio', [protect, admin], indicatorController.getIndicadoresAnuales);

export default router;


==================================================================
ARCHIVO: backend\routes\inspectionRoutes.js
==================================================================
// backend/routes/inspectionRoutes.js

import express from 'express';
import { check } from 'express-validator';
import inspectionController from '../controllers/inspectionController.js';
import { protect, admin } from '../middleware/authMiddleware.js';

const router = express.Router();

// POST /api/inspecciones (Diligenciar)
router.post('/', [ protect, admin ], [
    check('idFormulario', 'Obligatorio').not().isEmpty(),
    check('datosDiligenciados', 'Obligatorio').exists(),
    check('resultadoGeneral', 'Obligatorio').isIn(['OK', 'Con Hallazgos'])
], inspectionController.crearInspeccion);

// GET /api/inspecciones (Historial)
router.get('/', [ protect, admin ], inspectionController.getInspeccionesHistorial);

// GET /api/inspecciones/formularios (Lista)
router.get('/formularios', [ protect ], inspectionController.getFormularios);

// POST /api/inspecciones/formularios (Crear Estructura)
router.post('/formularios', [ protect, admin ], [
    check('idFormulario', 'Obligatorio').not().isEmpty(),
    check('nombreFormulario', 'Obligatorio').not().isEmpty(),
    check('preguntas', 'Min 1 pregunta').isArray({ min: 1 })
], inspectionController.crearNuevoFormulario);

// GET /api/inspecciones/:id (Detalle)
router.get('/:id', [ protect, admin ], inspectionController.getInspeccionDetalle);

/**
 * @route   GET /api/inspecciones/formularios/:idFormulario/preguntas
 * @desc    Obtener preguntas (ACCESO PÚBLICO para colaboradores logueados)
 */
router.get(
    '/formularios/:idFormulario/preguntas', 
    [ protect ], // <--- CLAVE: Solo protect, sin admin
    inspectionController.getPreguntasFormulario
);

// POST Agregar pregunta (Solo admin)
router.post(
    '/formularios/:id/preguntas',
    [ protect, admin ],
    [ check('textoPregunta', 'El texto es obligatorio').not().isEmpty() ],
    inspectionController.agregarPregunta
);

// DELETE Eliminar pregunta (Solo admin)
router.delete(
    '/preguntas/:id',
    [ protect, admin ],
    inspectionController.eliminarPregunta
);

// PATCH Cambiar Visibilidad (Nuevo)
router.patch(
    '/formularios/:id/visibilidad',
    [ protect, admin ],
    inspectionController.toggleVisibilidad
);

export default router;


==================================================================
ARCHIVO: backend\routes\logRoutes.js
==================================================================
// backend/src/routes/logRoutes.js

import express from 'express';
import logController from '../controllers/logController.js';
import { protect, admin } from '../middleware/authMiddleware.js';

const router = express.Router();

/**
 * @route   GET /api/logs/filtros
 * @desc    Obtener las listas para los dropdowns de filtro
 * @access  Privado (Admin)
 */
router.get(
    '/filtros',
    [ protect, admin ],
    logController.getLogFiltros
);

/**
 * @route   POST /api/logs/buscar
 * @desc    Obtener el historial de auditoría (filtrado)
 * @access  Privado (Admin)
 */
router.post(
    '/buscar', // Cambiado de GET / a POST /buscar
    [ protect, admin ],
    logController.getLogs
);

export default router;


==================================================================
ARCHIVO: backend\routes\medicalRoutes.js
==================================================================
// backend/routes/medicalRoutes.js

import express from 'express';
import { check } from 'express-validator';
import medicalController from '../controllers/medicalController.js';
import { protect, admin } from '../middleware/authMiddleware.js';

const router = express.Router();

// GET /api/medicina (Historial)
router.get(
    '/',
    [ protect, admin ],
    medicalController.getHistorialExamenes
);

// POST /api/medicina (Registrar)
router.post(
    '/',
    [ protect, admin ],
    [ 
        check('nombreColaborador', 'El nombre del colaborador es obligatorio').not().isEmpty(),
        check('cedulaColaborador', 'La cédula del colaborador es obligatoria').not().isEmpty(),
        check('tipoExamen', 'El tipo de examen es obligatorio').not().isEmpty(),
        check('fechaExamen', 'La fecha de examen es obligatoria').isISO8601(),
        check('conceptoAptitud', 'El concepto de aptitud es obligatorio').not().isEmpty()
    ],
    medicalController.crearExamenMedico
);

/**
 * @route   GET /api/medicina/:id
 * @desc    Obtener detalle de UN examen (para el modal "Ver Detalle")
 * @access  Privado (Admin)
 */
router.get(
    '/:id',
    [ protect, admin ],
    medicalController.getExamenMedicoDetalle // <-- ¡CORREGIDO!
);

// GET /api/medicina/:id/pdf (Generar PDF)
router.get(
    '/:id/pdf',
    [ protect, admin ],
    medicalController.generarPdfRecomendaciones 
);

export default router;


==================================================================
ARCHIVO: backend\routes\notificationRoutes.js
==================================================================
// backend/routes/notificationRoutes.js
import express from 'express';
import notificationController from '../controllers/notificationController.js';
import { protect } from '../middleware/authMiddleware.js';

const router = express.Router();

router.get('/', [protect], notificationController.getMisNotificaciones);
router.patch('/:id/leida', [protect], notificationController.marcarLeida);

export default router;


==================================================================
ARCHIVO: backend\routes\pesvRoutes.js
==================================================================
// backend/routes/pesvRoutes.js

import express from 'express';
import pesvController from '../controllers/pesvController.js';
import { protect, admin } from '../middleware/authMiddleware.js';
import upload from '../middleware/fileUpload.js';

const router = express.Router();

// Conductores
router.get('/conductores', [protect, admin], pesvController.getConductoresPESV);
router.post('/conductores', [protect, admin], upload.single('archivoLicencia'), pesvController.guardarInfoConductor);

// Mantenimientos
router.get('/mantenimientos', [protect, admin], pesvController.getMantenimientos);
router.post('/mantenimientos', [protect, admin], pesvController.crearMantenimiento);

// Pasos PESV
router.get('/pasos', [protect, admin], pesvController.getPasosPESV);
router.get('/pasos/:id/evidencias', [protect, admin], pesvController.getEvidenciasPorPaso);

// Documentos Internos
router.get('/documentos-internos', [protect], pesvController.getDocumentosGenerados);

// Actualizaciones
router.post('/pasos/actualizar', [protect, admin], upload.single('evidencia'), pesvController.actualizarPasoPESV);

// REEMPLAZAR EVIDENCIA (Ruta nueva para el botón de actualizar)
router.put('/evidencias/reemplazar', [protect, admin], upload.single('evidencia'), pesvController.reemplazarEvidencia);

// Plantillas y Generación
router.post('/plantilla', [protect, admin], pesvController.guardarConfiguracionPlantilla);
router.get('/plantilla/:id', [protect, admin], pesvController.getPlantillaPaso);
router.post('/pasos/generar', [protect, admin], pesvController.generarDocumentoPaso);

// CRUD Pasos
router.post('/pasos/crear', [protect, admin], pesvController.crearPaso);
router.put('/pasos/editar', [protect, admin], pesvController.editarPasoInfo);
router.delete('/pasos/:id', [protect, admin], pesvController.eliminarPaso);

// Descarga
router.get('/download/:filename', pesvController.descargarArchivo);

export default router;


==================================================================
ARCHIVO: backend\routes\reportRoutes.js
==================================================================
// backend/routes/reportRoutes.js

import express from 'express';
import { check } from 'express-validator';
import reportController from '../controllers/reportController.js';
import { protect, admin } from '../middleware/authMiddleware.js'; 
import upload from '../middleware/fileUpload.js'; 

const router = express.Router();

// --- Rutas Colaborador (Crear Reportes) ---
router.post('/maquina', 
    [ protect ], 
    upload.single('fotoReporte'), 
    [ 
        check('idActivo', 'Debe seleccionar una máquina').not().isEmpty().isInt(),
        check('estadoReportado', 'El estado es obligatorio').isIn(['OK', 'Con Problema'])
    ],
    reportController.crearReporteMaquina
);

router.post('/seguridad', 
    [ protect ], 
    upload.single('fotoReporte'), 
    [
        check('tipoReporte', 'Obligatorio').not().isEmpty(),
        check('ubicacionArea', 'Obligatorio').not().isEmpty(),
        check('descripcion', 'Obligatorio').not().isEmpty()
    ],
    reportController.crearReporteSeguridad
);

// --- Rutas Colaborador (Ver Mis Reportes) ---
router.get('/maquina/mis-reportes', [ protect ], reportController.getMisReportesMaquina);
router.get('/seguridad/mis-reportes', [ protect ], reportController.getMisReportesSeguridad);

// --- Rutas Generales (Admin Listas) ---
router.get('/maquina', [ protect, admin ], reportController.getReportesMaquina);
router.get('/seguridad', [ protect, admin ], reportController.getReportesSeguridad);

// --- Rutas Detalle (Acceso mixto: Admin revisa, Colaborador solo lee) ---
// NOTA: Se quitó el middleware 'admin' para permitir acceso al colaborador
router.get('/maquina/:id', [ protect ], reportController.getReporteMaquinaDetalle);
router.get('/seguridad/:id', [ protect ], reportController.getReporteSeguridadDetalle);

export default router;


==================================================================
ARCHIVO: backend\routes\requestRoutes.js
==================================================================
// backend/routes/requestRoutes.js

import express from 'express';
import requestController from '../controllers/requestController.js';
import { protect, admin } from '../middleware/authMiddleware.js';
import upload from '../middleware/fileUpload.js';

const router = express.Router();

// Crear solicitud (SST envía archivo opcional)
router.post('/', 
    [protect], 
    upload.single('archivo'), 
    requestController.crearSolicitud
);

// Leer solicitudes
router.get('/', 
    [protect], 
    requestController.getSolicitudes
);

// Responder y Firmar (Super Admin envía imagen de firma opcional)
router.put('/responder', 
    [protect, admin], 
    upload.single('firma'), 
    requestController.responderSolicitud
);

// Actualizar documento firmado manualmente (Reemplazar archivo)
router.post('/actualizar-doc', 
    [protect, admin], 
    upload.single('archivo'), 
    requestController.actualizarDocumentoFirmado
);

export default router;


==================================================================
ARCHIVO: backend\routes\scheduleRoutes.js
==================================================================
// backend/src/routes/scheduleRoutes.js

import express from 'express';
import { check } from 'express-validator';
import scheduleController from '../controllers/scheduleController.js';
import { protect, admin } from '../middleware/authMiddleware.js';

const router = express.Router();

// POST /api/cronogramas (Crear Cronograma)
router.post(
    '/',
    [ protect, admin ],
    [
        check('nombreCronograma', 'El nombre del cronograma es obligatorio').not().isEmpty()
    ],
    scheduleController.crearCronograma
);

// GET /api/cronogramas (Listar Cronogramas Activos)
router.get(
    '/',
    [ protect, admin ],
    scheduleController.getCronogramas
);

/**
 * @route   DELETE /api/cronogramas/:id
 * @desc    Eliminar (Soft Delete) un cronograma
 * @access  Privado (Admin)
 */
router.delete(
    '/:id',
    [ protect, admin ],
    scheduleController.eliminarCronograma // <--- NUEVA RUTA
);


// --- Rutas de Actividades ---
router.post(
    '/:id/actividades',
    [ protect, admin ],
    [
        check('nombreActividad', 'El nombre de la actividad es obligatorio').not().isEmpty(),
        check('fechaLimite', 'La fecha límite es obligatoria y debe ser una fecha válida').isISO8601(),
        check('idUsuarioResponsable', 'El responsable es obligatorio').isInt()
    ],
    scheduleController.crearActividad
);

router.get(
    '/:id/actividades',
    [ protect, admin ],
    scheduleController.getActividadesPorCronograma
);

export default router;


==================================================================
ARCHIVO: backend\routes\userRoutes.js
==================================================================
// backend/src/routes/userRoutes.js
import express from 'express';
import { check } from 'express-validator';
import userController from '../controllers/userController.js';
import { protect, admin } from '../middleware/authMiddleware.js';

const router = express.Router();

// POST /api/usuarios (Crear)
router.post(
    '/',
    [ protect, admin ],
    [
        check('nombreCompleto', 'El nombre completo es obligatorio').not().isEmpty(),
        check('cedula', 'La cédula (usuario) es obligatoria').not().isEmpty(),
        check('password', 'La contraseña temporal es obligatoria').not().isEmpty(),
        check('idRol', 'El rol es obligatorio').isInt()
    ],
    userController.crearColaborador
);

// GET /api/usuarios (Lista gestión)
router.get(
    '/',
    [ protect, admin ],
    userController.getColaboradores
);

// GET /api/usuarios/todos (Lista selectores)
router.get(
    '/todos',
    [ protect, admin ], 
    userController.getTodosUsuarios
);

// --- NUEVA RUTA: Obtener Roles ---
router.get(
    '/roles',
    [ protect, admin ],
    userController.getRoles
);

router.get(
    '/cedula/:cedula',
    [ protect, admin ],
    userController.getUsuarioPorCedula
);

// PUT /api/usuarios/:id (Editar)
router.put(
    '/:id', 
    [ protect, admin ],
    [
        check('nombreCompleto', 'El nombre completo es obligatorio').not().isEmpty()
    ],
    userController.editarColaborador
);

// PATCH /api/usuarios/:id/estado (Activar/Inactivar)
router.patch(
    '/:id/estado',
    [ protect, admin ],
    [
        check('estado', 'El estado es obligatorio').isIn(['Activo', 'Inactivo'])
    ],
    userController.cambiarEstadoColaborador
);

// PATCH /api/usuarios/:id/reset-password (Resetear)
router.patch(
    '/:id/reset-password',
    [ protect, admin ],
    [
        check('password', 'La nueva contraseña es obligatoria').not().isEmpty()
    ],
    userController.resetPasswordColaborador
);

export default router;


==================================================================
ARCHIVO: backend\server.js
==================================================================
// backend/server.js

import express from 'express';
import cors from 'cors';
import 'dotenv/config'; 
import path from 'path';
import { fileURLToPath } from 'url';

// --- Importación de Rutas (ESM) ---
import authRoutes from './routes/authRoutes.js';
import userRoutes from './routes/userRoutes.js';
import scheduleRoutes from './routes/scheduleRoutes.js';
import activityRoutes from './routes/activityRoutes.js';
import inspectionRoutes from './routes/inspectionRoutes.js';
import reportRoutes from './routes/reportRoutes.js';
import acpmRoutes from './routes/acpmRoutes.js'; 
import assetRoutes from './routes/assetRoutes.js'; 
import dashboardRoutes from './routes/dashboardRoutes.js';
import documentRoutes from './routes/documentRoutes.js';
import medicalRoutes from './routes/medicalRoutes.js';
import logRoutes from './routes/logRoutes.js';
import notificationRoutes from './routes/notificationRoutes.js';
import indicatorRoutes from './routes/indicatorRoutes.js';
import pesvRoutes from './routes/pesvRoutes.js';
import requestRoutes from './routes/requestRoutes.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const port = process.env.PORT || 5000;



// --- Middlewares ---
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true })); 

// --- Middleware de Archivos Estáticos (Corregido) ---
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));

// --- Definición de Rutas de la API ---
app.use('/api/auth', authRoutes);
app.use('/api/usuarios', userRoutes);
app.use('/api/cronogramas', scheduleRoutes);
app.use('/api/actividades', activityRoutes);
app.use('/api/inspecciones', inspectionRoutes);
app.use('/api/reportes', reportRoutes);
app.use('/api/acpm', acpmRoutes); 
app.use('/api/activos', assetRoutes); // <--- AÑADE ESTA LÍNEA
app.use('/api/dashboard', dashboardRoutes);
app.use('/api/documentos', documentRoutes);
app.use('/api/medicina', medicalRoutes);
app.use('/api/logs', logRoutes);
app.use('/api/notificaciones', notificationRoutes);
app.use('/api/indicadores', indicatorRoutes);
app.use('/api/pesv', pesvRoutes);
app.use('/api/solicitudes', requestRoutes);

app.listen(port, () => {
    console.log(`Servidor corriendo exitosamente en el puerto ${port}`);
});


==================================================================
ARCHIVO: backend\services\logService.js
==================================================================
// backend/src/services/logService.js
import { poolPromise, mssql } from '../config/dbConfig.js';

/**
 * @service   logAction
 * @desc      Registra una acción de administrador en la tabla AuditLog.
 * @param {number} idUsuario - El ID del usuario que realiza la acción (del token).
 * @param {string} nombreUsuario - El nombre del usuario (del token).
 * @param {string} accion - Un código de acción (ej. "CREAR_USUARIO").
 * @param {string} descripcion - Un texto legible (ej. "Creó al usuario Pepito Perez (ID: 12)").
 */
export const logAction = async (idUsuario, nombreUsuario, accion, descripcion) => {
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idUsuario', mssql.Int, idUsuario)
            .input('nombreUsuario', mssql.NVarChar, nombreUsuario)
            .input('accion', mssql.NVarChar, accion)
            .input('descripcion', mssql.NVarChar, descripcion)
            .query('EXEC SP_CREATE_AuditLog @idUsuario, @nombreUsuario, @accion, @descripcion');
    } catch (err) {
        // Si el log falla, no queremos que la aplicación principal se caiga.
        // Solo lo registramos en la consola del servidor.
        console.error('CRITICAL: Falla al escribir en AuditLog.', err.message);
    }
};


==================================================================
ARCHIVO: backend\services\notificationService.js
==================================================================
// backend/services/notificationService.js
import { poolPromise, mssql } from '../config/dbConfig.js';

/**
 * @desc Crea una notificación en la BD
 * @param {Object} data - { idUsuarioDestino, rolDestino, titulo, mensaje, ruta }
 */
export const crearNotificacion = async ({ idUsuarioDestino, rolDestino, titulo, mensaje, ruta }) => {
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idUsuarioDestino', mssql.Int, idUsuarioDestino || null)
            .input('rolDestino', mssql.NVarChar, rolDestino || null)
            .input('titulo', mssql.NVarChar, titulo)
            .input('mensaje', mssql.NVarChar, mensaje)
            .input('rutaAccion', mssql.NVarChar, ruta || null)
            .query('EXEC SP_CREATE_Notificacion @idUsuarioDestino, @rolDestino, @titulo, @mensaje, @rutaAccion');
    } catch (err) {
        console.error('Error creando notificación interna:', err.message);
        // No lanzamos error para no interrumpir el flujo principal
    }
};


==================================================================
ARCHIVO: backend\utils\pdfGenerator.js
==================================================================
// backend/utils/pdfGenerator.js

import PDFDocument from 'pdfkit';
import fs from 'fs';
import path from 'path';

export const generarActaPDF = (configuracion, datosUsuario, rutaSalida) => {
    return new Promise((resolve, reject) => {
        try {
            const directorio = path.dirname(rutaSalida);
            if (!fs.existsSync(directorio)) {
                fs.mkdirSync(directorio, { recursive: true });
            }

            const doc = new PDFDocument({ margin: 50, size: 'LETTER' });
            const stream = fs.createWriteStream(rutaSalida);

            doc.pipe(stream);

            // --- ENCABEZADO ---
            doc.rect(50, 40, 510, 70).stroke();
            
            doc.fontSize(16).font('Helvetica-Bold').text('EMPAQUETADOS EL TRECE S.A.S', 60, 55, { align: 'center', width: 490 });
            doc.fontSize(10).font('Helvetica').text('NIT: 900.123.456-7', { align: 'center' });
            doc.fontSize(10).font('Helvetica-Oblique').text('PLAN ESTRATÉGICO DE SEGURIDAD VIAL (PESV)', { align: 'center' });
            doc.moveDown(3);

            // --- TÍTULO ---
            doc.fontSize(14).font('Helvetica-Bold').text(configuracion.titulo.toUpperCase(), { align: 'center', underline: true });
            doc.moveDown();

            // --- FECHA (SIN CIUDAD) ---
            const fechaActual = new Date().toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            doc.fontSize(11).font('Helvetica').text(`Fecha de emisión: ${fechaActual}`, { align: 'right' });
            doc.moveDown(2);

            // --- CUERPO FIJO ---
            if (configuracion.cuerpo) {
                doc.fontSize(11).font('Helvetica').text(configuracion.cuerpo, { align: 'justify', lineGap: 4 });
                doc.moveDown();
            }

            // --- CAMPOS DINÁMICOS ---
            if (configuracion.camposLlenos && configuracion.camposLlenos.length > 0) {
                doc.font('Helvetica-Bold').text('INFORMACIÓN ESPECÍFICA:', { underline: true });
                doc.moveDown(0.5);

                configuracion.camposLlenos.forEach(campo => {
                    doc.font('Helvetica-Bold').text(`• ${campo.label}: `, { continued: true });
                    doc.font('Helvetica').text(campo.valor);
                    doc.moveDown(0.3);
                });
                doc.moveDown(2);
            }

            // --- FIRMAS ---
            if (doc.y > 600) doc.addPage();
            
            const yFirmas = doc.y + 50;

            // Firma 1
            doc.text('_____________________________', 50, yFirmas);
            doc.font('Helvetica-Bold').text('RESPONSABLE PESV', 50, yFirmas + 15);
            
            // Firma 2 (Si detectamos un nombre en los campos)
            const campoNombre = configuracion.camposLlenos.find(c => c.label.toLowerCase().includes('nombre') || c.label.toLowerCase().includes('presidente'));
            
            if (campoNombre) {
                doc.text('_____________________________', 350, yFirmas);
                doc.font('Helvetica-Bold').text(campoNombre.valor.toUpperCase(), 350, yFirmas + 15);
                doc.font('Helvetica').text('Aceptante', 350, yFirmas + 30);
            }

            // --- PIE DE PÁGINA ---
            const pageCount = doc.bufferedPageRange().count;
            for (let i = 0; i < pageCount; i++) {
                doc.switchToPage(i);
                doc.fontSize(8).text(`Página ${i + 1}`, 50, 750, { align: 'center', color: 'gray' });
            }

            doc.end();
            stream.on('finish', () => resolve(true));
            stream.on('error', (err) => reject(err));

        } catch (error) { reject(error); }
    });
};


==================================================================
ARCHIVO: backend\utils\seedAdmin.js
==================================================================
// backend/utils/seedAdmin.js

import bcrypt from 'bcryptjs';
import { poolPromise, mssql } from '../config/dbConfig.js';
import 'dotenv/config'; 

const seedAdmin = async () => {
    console.log('Iniciando script para sembrar Admin SST (Modo Seguro)...');

    // 1. Leer credenciales del entorno
    // Usamos los valores del .env, o un fallback seguro vacío para forzar el error si faltan
    const adminData = {
        nombre: "Administrador Principal",
        cedula: process.env.ADMIN_CEDULA,
        passwordPlano: process.env.ADMIN_PASSWORD
    };

    // Validación de seguridad
    if (!adminData.cedula || !adminData.passwordPlano) {
        console.error('❌ ERROR DE SEGURIDAD: Las variables ADMIN_CEDULA o ADMIN_PASSWORD no están definidas en el archivo .env');
        process.exit(1);
    }

    try {
        const pool = await poolPromise;

        // 2. Verificar si existe
        const checkUser = await pool.request()
            .input('cedula', mssql.NVarChar, adminData.cedula)
            .query('SELECT ID_Usuario FROM Usuarios WHERE CedulaUsuario = @cedula');

        if (checkUser.recordset.length > 0) {
            console.log(`ℹ️ El usuario '${adminData.cedula}' ya existe. No se realizaron cambios.`);
            process.exit(0); 
        }

        // 3. Hashear
        console.log('Hasheando contraseña...');
        const salt = await bcrypt.genSalt(10);
        const passwordHash = await bcrypt.hash(adminData.passwordPlano, salt);

        // 4. Insertar (ID_Rol = 1 es Admin SST)
        const insertQuery = `
            INSERT INTO Usuarios (NombreCompleto, CedulaUsuario, PasswordHash, ID_Rol, EstadoCuenta, Cargo)
            VALUES (@nombre, @cedula, @hash, 1, 'Activo', 'Jefe SST')
        `;

        await pool.request()
            .input('nombre', mssql.NVarChar, adminData.nombre)
            .input('cedula', mssql.NVarChar, adminData.cedula)
            .input('hash', mssql.NVarChar, passwordHash)
            .query(insertQuery);

        console.log('-------------------------------------------');
        console.log('✅ ¡Usuario Administrador SST Creado!');
        console.log(`   Usuario: ${adminData.cedula}`);
        console.log('-------------------------------------------');

        process.exit(0);

    } catch (err) {
        console.error('❌ Error durante el sembrado del admin:', err.message);
        process.exit(1);
    }
};

seedAdmin();


==================================================================
ARCHIVO: backend\utils\seedSuperAdmin.js
==================================================================
// backend/utils/seedSuperAdmin.js

import bcrypt from 'bcryptjs';
import { poolPromise, mssql } from '../config/dbConfig.js';
import 'dotenv/config'; // Carga las variables del .env

const seedSuperAdmin = async () => {
    console.log('--- Configurando Super Admin (Modo Seguro) ---');

    // 1. Leer credenciales del entorno
    const usuario = process.env.SUPER_ADMIN_CEDULA;
    const passwordPlano = process.env.SUPER_ADMIN_PASSWORD;

    // Validación de seguridad: Si no están en el .env, detenemos el script
    if (!usuario || !passwordPlano) {
        console.error('❌ ERROR DE SEGURIDAD: Las variables SUPER_ADMIN_CEDULA o SUPER_ADMIN_PASSWORD no están definidas en el archivo .env');
        process.exit(1);
    }

    try {
        const pool = await poolPromise;

        // 2. Buscar ID del Rol "Super Admin"
        const roleResult = await pool.request()
            .query("SELECT ID_Rol FROM Roles WHERE NombreRol = 'Super Admin'");
        
        if (roleResult.recordset.length === 0) {
            console.error('❌ ERROR: No existe el rol "Super Admin" en la BD. Ejecuta primero el script SQL de roles.');
            process.exit(1);
        }
        const idRolSuper = roleResult.recordset[0].ID_Rol;

        // 3. Hashear contraseña
        const salt = await bcrypt.genSalt(10);
        const passwordHash = await bcrypt.hash(passwordPlano, salt);

        // 4. Verificar existencia del usuario
        const userCheck = await pool.request()
            .input('cedula', mssql.NVarChar, usuario)
            .query('SELECT ID_Usuario FROM Usuarios WHERE CedulaUsuario = @cedula');

        if (userCheck.recordset.length > 0) {
            console.log('El usuario ya existe. Actualizando credenciales...');
            await pool.request()
                .input('cedula', mssql.NVarChar, usuario)
                .input('pass', mssql.NVarChar, passwordHash)
                .query(`UPDATE Usuarios SET PasswordHash = @pass, EstadoCuenta = 'Activo' WHERE CedulaUsuario = @cedula`);
        } else {
            console.log('Creando nuevo Super Admin...');
            await pool.request()
                .input('cedula', mssql.NVarChar, usuario)
                .input('pass', mssql.NVarChar, passwordHash)
                .input('rol', mssql.Int, idRolSuper)
                .query(`INSERT INTO Usuarios (NombreCompleto, CedulaUsuario, PasswordHash, ID_Rol, Cargo, EstadoCuenta) 
                        VALUES ('Super Administrador', @cedula, @pass, @rol, 'Gerencia TI', 'Activo')`);
        }

        console.log('✅ ÉXITO: Super Admin configurado desde variables de entorno.');
        process.exit(0);

    } catch (err) {
        console.error('❌ ERROR:', err.message);
        process.exit(1);
    }
};

seedSuperAdmin();


==================================================================
ARCHIVO: backend\utils\signer.js
==================================================================
// backend/utils/signer.js

import { PDFDocument, rgb, StandardFonts } from 'pdf-lib'; // Importamos rgb y fonts
import fs from 'fs';

export const estamparFirmaEnPDF = async (rutaPdfOriginal, rutaImagenFirma, rutaSalida, nombreFirmante, cargoFirmante) => {
    try {
        const pdfBytes = fs.readFileSync(rutaPdfOriginal);
        const pdfDoc = await PDFDocument.load(pdfBytes);
        const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);

        const firmaBytes = fs.readFileSync(rutaImagenFirma);
        let firmaImage;
        
        if (rutaImagenFirma.endsWith('.png')) {
            firmaImage = await pdfDoc.embedPng(firmaBytes);
        } else {
            firmaImage = await pdfDoc.embedJpg(firmaBytes);
        }

        const pages = pdfDoc.getPages();
        const lastPage = pages[pages.length - 1]; // Firmamos en la última página
        const { width, height } = lastPage.getSize();

        // --- CONFIGURACIÓN DE POSICIÓN ---
        // Escalar firma (ajusta el 0.4 según el tamaño de tus imágenes)
        const scale = 0.4; 
        const firmaDims = firmaImage.scale(scale);

        // Coordenadas: Abajo a la derecha
        const margenDerecho = 50;
        const margenInferior = 120; // Subimos un poco para dejar espacio al texto
        
        const xPos = width - firmaDims.width - margenDerecho;
        const yPos = margenInferior;

        // 1. DIBUJAR LA IMAGEN DE LA FIRMA
        lastPage.drawImage(firmaImage, {
            x: xPos,
            y: yPos,
            width: firmaDims.width,
            height: firmaDims.height,
        });
        
        // 2. DIBUJAR EL TEXTO DEBAJO ("FIRMADO POR...")
        const fechaFirma = new Date().toLocaleString('es-CO');
        
        // Línea divisoria
        lastPage.drawLine({
            start: { x: xPos, y: yPos - 5 },
            end: { x: xPos + firmaDims.width, y: yPos - 5 },
            thickness: 1,
            color: rgb(0, 0, 0),
        });

        // Texto
        lastPage.drawText(`FIRMADO POR: ${cargoFirmante.toUpperCase()}`, {
            x: xPos,
            y: yPos - 20,
            size: 8,
            font: helveticaFont,
            color: rgb(0, 0, 0),
        });

        lastPage.drawText(`Nombre: ${nombreFirmante}`, {
            x: xPos,
            y: yPos - 32,
            size: 8,
            font: helveticaFont,
            color: rgb(0.4, 0.4, 0.4),
        });

        lastPage.drawText(`Fecha: ${fechaFirma}`, {
            x: xPos,
            y: yPos - 44,
            size: 7,
            font: helveticaFont,
            color: rgb(0.6, 0.6, 0.6),
        });

        const pdfFirmadoBytes = await pdfDoc.save();
        fs.writeFileSync(rutaSalida, pdfFirmadoBytes);

        return true;

    } catch (error) {
        console.error("Error estampando firma:", error);
        throw new Error("No se pudo estampar la firma en el documento.");
    }
};


==================================================================
ARCHIVO: frontend\eslint.config.js
==================================================================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs['recommended-latest'],
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])



==================================================================
ARCHIVO: frontend\package.json
==================================================================
{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "date-fns": "^4.1.0",
    "jwt-decode": "^4.0.0",
    "react": "^19.1.1",
    "react-big-calendar": "^1.19.4",
    "react-dom": "^19.1.1",
    "react-icons": "^5.5.0",
    "react-router-dom": "^7.9.5",
    "react-signature-canvas": "^1.1.0-alpha.2",
    "recharts": "^3.5.0",
    "sweetalert2": "^11.26.3"
  },
  "devDependencies": {
    "@eslint/js": "^9.36.0",
    "@types/react": "^19.1.16",
    "@types/react-dom": "^19.1.9",
    "@vitejs/plugin-react": "^5.0.4",
    "eslint": "^9.36.0",
    "eslint-plugin-react-hooks": "^5.2.0",
    "eslint-plugin-react-refresh": "^0.4.22",
    "globals": "^16.4.0",
    "vite": "^7.1.7"
  }
}



==================================================================
ARCHIVO: frontend\src\App.css
==================================================================



==================================================================
ARCHIVO: frontend\src\App.jsx
==================================================================
// frontend/src/App.jsx

import React, { useEffect } from 'react';
import { Routes, Route, Navigate, Outlet } from 'react-router-dom';
import { useAuth } from './context/AuthContext';

// --- Páginas Generales ---
import LoginPage from './pages/LoginPage';
import DashboardPage from './pages/DashboardPage'; 

// --- Páginas Módulo SST ---
import UsuariosPage from './pages/UsuariosPage';
import ActivosPage from './pages/ActivosPage.jsx';
import PlanificacionPage from './pages/PlanificacionPage.jsx';
import InspeccionesPage from './pages/InspeccionesPage.jsx';
import ReportesPage from './pages/ReportesPage.jsx'; 
import AcpmPage from './pages/AcpmPage.jsx'; 
import DocumentosPage from './pages/DocumentosPage.jsx';
import MedicinaLaboralPage from './pages/MedicinaLaboralPage.jsx'; 
import LogsPage from './pages/LogsPage.jsx'; 
import IndicadoresPage from './pages/IndicadoresPage.jsx'; 
import PesvPage from './pages/PesvPage.jsx'; 
import SolicitudesPage from './pages/SolicitudesPage.jsx'; // <--- NUEVA PÁGINA

// --- Páginas Módulo Colaborador ---
import ReportarMaquinaPage from './pages/ReportarMaquinaPage.jsx'; 
import ReportarSeguridadPage from './pages/ReportarSeguridadPage.jsx';

// --- Páginas Roles Específicos ---
import DashboardSuperAdmin from './pages/DashboardSuperAdmin';
import DashboardCalidad from './pages/DashboardCalidad';
import GestionFormulariosPage from './pages/GestionFormulariosPage'; 

// --- Layouts y Componentes ---
import MainLayout from './layout/MainLayout'; 
import ColaboradorLayout from './layout/ColaboradorLayout.jsx'; 
import ProtectedRoutes from './components/ProtectedRoutes';

// ==========================================
// 🛡️ GUARDS (Protección de Rutas)
// ==========================================

// 1. Rutas para Admin SST y Super Admin (Gestión Operativa)
const AdminRoutes = () => {
    const { usuario } = useAuth();
    const tienePermiso = usuario.rol === 'Administrador SST' || usuario.rol === 'Super Admin';
    
    if (!tienePermiso) {
        return <Navigate to="/dashboard" replace />;
    }
    return <Outlet />; 
};

// 2. Rutas Exclusivas Super Admin (Configuración Global)
const SuperAdminRoutes = () => {
    const { usuario } = useAuth();
    return usuario.rol === 'Super Admin' ? <Outlet /> : <Navigate to="/dashboard" replace />;
};

// 3. Rutas Exclusivas Calidad
const CalidadRoutes = () => {
    const { usuario } = useAuth();
    const tienePermiso = usuario.rol === 'Gestion de Calidad' || usuario.rol === 'Super Admin';
    return tienePermiso ? <Outlet /> : <Navigate to="/dashboard" replace />;
};

// ==========================================
// 🚀 COMPONENTE PRINCIPAL
// ==========================================
function App() {
    const { isAuthenticated, isLoading, usuario } = useAuth();

    useEffect(() => {
        const root = document.getElementById('root');
        if (isAuthenticated) {
            root.classList.add('layout-activo');
        } else {
            root.classList.remove('layout-activo');
        }
    }, [isAuthenticated]);

    // --- Lógica de Redirección Inicial ---
    const getDefaultRoute = () => {
        if (!usuario) return "/login";
        if (usuario.rol === 'Super Admin') return "/super-admin/dashboard";
        if (usuario.rol === 'Gestion de Calidad') return "/calidad/dashboard";
        if (usuario.rol === 'Administrador SST') return "/dashboard";
        if (usuario.rol === 'Colaborador') return "/dashboard"; 
        return "/login";
    };

    if (isLoading) {
        return <div style={{display: 'flex', height: '100vh', justifyContent: 'center', alignItems: 'center'}}>Cargando Sistema...</div>;
    }

    return (
        <Routes>
            {/* Ruta Pública */}
            <Route 
                path="/login" 
                element={isAuthenticated ? <Navigate to={getDefaultRoute()} replace /> : <LoginPage />} 
            />
            
            {/* Rutas Protegidas */}
            <Route path="/" element={<ProtectedRoutes />}>
                
                {/* Selector de Layout */}
                <Route 
                    element={usuario?.rol === 'Colaborador' ? <ColaboradorLayout /> : <MainLayout />}
                >
                    {/* Redirección Inteligente */}
                    <Route path="dashboard" element={
                        usuario?.rol === 'Super Admin' ? <Navigate to="/super-admin/dashboard" replace /> :
                        usuario?.rol === 'Gestion de Calidad' ? <Navigate to="/calidad/dashboard" replace /> :
                        <DashboardPage /> 
                    } />
                    
                    {/* --- MÓDULO SUPER ADMIN --- */}
                    <Route path="super-admin" element={<SuperAdminRoutes />}>
                        <Route path="dashboard" element={<DashboardSuperAdmin />} />
                        <Route path="formularios" element={<GestionFormulariosPage />} />
                    </Route>

                    {/* --- MÓDULO CALIDAD --- */}
                    <Route path="calidad" element={<CalidadRoutes />}>
                        <Route path="dashboard" element={<DashboardCalidad />} />
                    </Route>

                    {/* --- MÓDULO SST (Compartido con Super Admin) --- */}
                    <Route element={<AdminRoutes />}>
                        <Route path="usuarios" element={<UsuariosPage />} />
                        <Route path="activos" element={<ActivosPage />} /> 
                        <Route path="planificacion" element={<PlanificacionPage />} />
                        <Route path="inspecciones" element={<InspeccionesPage />} />
                        <Route path="reportes" element={<ReportesPage />} /> 
                        <Route path="acpm" element={<AcpmPage />} /> 
                        <Route path="documentos" element={<DocumentosPage />} />
                        <Route path="medicina" element={<MedicinaLaboralPage />} /> 
                        <Route path="indicadores" element={<IndicadoresPage />} />
                        <Route path="pesv" element={<PesvPage />} /> 
                        <Route path="solicitudes" element={<SolicitudesPage />} /> {/* <--- RUTA NUEVA */}
                        <Route path="logs" element={<LogsPage />} />
                    </Route>

                    {/* --- MÓDULO COLABORADOR --- */}
                    <Route path="reportar-maquina" element={<ReportarMaquinaPage />} />
                    <Route path="reportar-seguridad" element={<ReportarSeguridadPage />} />

                    <Route index element={<Navigate to={getDefaultRoute()} replace />} />
                </Route>
            </Route>
            
            <Route path="*" element={<Navigate to={getDefaultRoute()} replace />} />
        </Routes>
    );
}

export default App;


==================================================================
ARCHIVO: frontend\src\components\forms\FormBotiquin.jsx
==================================================================
// frontend/src/componentes/forms/FormBotiquin.jsx

import React, { useState, useEffect } from 'react';
import '../../style/InspeccionesPage.css';
import '../../index.css';

const initialState = {
    item_gasas: { respuesta: '', observacion: '' },
    item_esparadrapo: { respuesta: '', observacion: '' },
    item_baja_lenguas: { respuesta: '', observacion: '' },
    item_curas: { respuesta: '', observacion: '' },
    item_venda_ela_2: { respuesta: '', observacion: '' },
    item_venda_ela_3: { respuesta: '', observacion: '' },
    item_venda_alg: { respuesta: '', observacion: '' },
    item_yodopovidona: { respuesta: '', observacion: '' },
    item_sol_salina: { respuesta: '', observacion: '' },
    item_guantes: { respuesta: '', observacion: '' },
    item_tijeras: { respuesta: '', observacion: '' },
    item_termometro: { respuesta: '', observacion: '' },
};

// Usamos C (Cumple) / NC (No Cumple) / NA (No Aplica)
const ChecklistItemCN = ({ id, label, value, onRespuestaChange, onObservacionChange }) => (
    <div className="checklist-item-wrapper">
        <div className="checklist-item">
            <label className="item-label">{label}</label>
            <div className="checklist-options">
                {['C', 'NC', 'NA'].map(val => (
                    <label key={val} className="radio-label-cn">
                        <input 
                            type="radio" 
                            name={id} 
                            value={val} 
                            checked={value.respuesta === val} 
                            onChange={() => onRespuestaChange(id, val)} 
                        />
                        <span>{val}</span>
                    </label>
                ))}
            </div>
        </div>
        <div className="checklist-item-observacion">
            <label htmlFor={`${id}_obs`}>Obs:</label>
            <input 
                type="text" id={`${id}_obs`} 
                value={value.observacion} 
                onChange={(e) => onObservacionChange(id, e.target.value)}
                placeholder="Cantidades, fechas..."
            />
        </div>
    </div>
);

const FormBotiquin = ({ onFormChange, onResultadoChange }) => {
    const [respuestas, setRespuestas] = useState(initialState);

    useEffect(() => {
        const tieneHallazgos = Object.values(respuestas).some(v => v.respuesta === 'NC');
        onResultadoChange(tieneHallazgos ? 'Con Hallazgos' : 'OK');
        // Ya no enviamos observacionesFormulario desde aquí, solo el checklist
        onFormChange({ checklist: respuestas });
    }, [respuestas, onFormChange, onResultadoChange]);

    const handleRespuestaChange = (item, valor) => {
        setRespuestas(prev => ({ ...prev, [item]: { ...prev[item], respuesta: valor } }));
    };
    const handleObservacionChange = (item, valor) => {
        setRespuestas(prev => ({ ...prev, [item]: { ...prev[item], observacion: valor } }));
    };

    const items = [
        { id: 'item_gasas', label: 'Gasas limpias (paquete)' },
        { id: 'item_esparadrapo', label: 'Esparadrapo de tela' },
        { id: 'item_baja_lenguas', label: 'Baja lenguas (paquete)' },
        { id: 'item_curas', label: 'Curitas (paquete)' },
        { id: 'item_venda_ela_2', label: 'Venda elástica 2x5' },
        { id: 'item_venda_ela_3', label: 'Venda elástica 3x5' },
        { id: 'item_venda_alg', label: 'Venda de algodón 3x5' },
        { id: 'item_yodopovidona', label: 'Yodopovidona (jabón)' },
        { id: 'item_sol_salina', label: 'Solución salina (250 o 500ml)' },
        { id: 'item_guantes', label: 'Guantes de látex (caja)' },
        { id: 'item_tijeras', label: 'Tijeras' },
        { id: 'item_termometro', label: 'Termómetro' },
    ];

    return (
        <div className="form-checklist-container">
            {items.map(item => (
                <ChecklistItemCN 
                    key={item.id} 
                    {...item} 
                    value={respuestas[item.id]} 
                    onRespuestaChange={handleRespuestaChange}
                    onObservacionChange={handleObservacionChange}
                />
            ))}
            {/* SE ELIMINÓ EL TEXTAREA DE OBSERVACIONES GENERALES */}
        </div>
    );
};

export default FormBotiquin;


==================================================================
ARCHIVO: frontend\src\components\forms\FormExtintores.jsx
==================================================================
// frontend/src/componentes/forms/FormExtintores.jsx

import React, { useState, useEffect } from 'react';
import '../../style/InspeccionesPage.css'; 
import '../../index.css';

const initialState = {
    item1_ubicacion: { respuesta: '', observacion: '' },
    item2_senalizacion: { respuesta: '', observacion: '' },
    item3_acceso: { respuesta: '', observacion: '' },
    item4_manometro: { respuesta: '', observacion: '' },
    item5_seguro: { respuesta: '', observacion: '' },
    item6_manguera: { respuesta: '', observacion: '' },
    item7_etiqueta_vencimiento: { respuesta: '', observacion: '' },
};

const ChecklistItem = ({ id, label, value, onRespuestaChange, onObservacionChange }) => (
    <div className="checklist-item-wrapper">
        <div className="checklist-item">
            <label className="item-label">{label}</label>
            <div className="checklist-options">
                {['B', 'R', 'M', 'NA'].map(val => (
                    <label key={val} className="radio-label">
                        <input 
                            type="radio" name={id} value={val} 
                            checked={value.respuesta === val} 
                            onChange={() => onRespuestaChange(id, val)} 
                        />
                        <span>{val}</span>
                    </label>
                ))}
            </div>
        </div>
        <div className="checklist-item-observacion">
            <label htmlFor={`${id}_obs`}>Obs:</label>
            <input 
                type="text" id={`${id}_obs`} 
                value={value.observacion} 
                onChange={(e) => onObservacionChange(id, e.target.value)}
                placeholder="Observación..."
            />
        </div>
    </div>
);

const FormExtintores = ({ onFormChange, onResultadoChange }) => {
    const [respuestas, setRespuestas] = useState(initialState);

    useEffect(() => {
        const tieneHallazgos = Object.values(respuestas).some(v => v.respuesta === 'R' || v.respuesta === 'M');
        onResultadoChange(tieneHallazgos ? 'Con Hallazgos' : 'OK');
        onFormChange({ checklist: respuestas }); // Solo enviamos el checklist
    }, [respuestas, onFormChange, onResultadoChange]);

    const handleRespuestaChange = (item, valor) => {
        setRespuestas(prev => ({ ...prev, [item]: { ...prev[item], respuesta: valor } }));
    };

    const handleObservacionChange = (item, valor) => {
        setRespuestas(prev => ({ ...prev, [item]: { ...prev[item], observacion: valor } }));
    };

    const items = [
        { id: 'item1_ubicacion', label: '1. ¿Está en la ubicación asignada?' },
        { id: 'item2_senalizacion', label: '2. ¿La señalización es visible y adecuada?' },
        { id: 'item3_acceso', label: '3. ¿El acceso al extintor está libre de obstáculos?' },
        { id: 'item4_manometro', label: '4. ¿El manómetro indica la presión adecuada (en verde)?' },
        { id: 'item5_seguro', label: '5. ¿El seguro (pasador) y sello de garantía están intactos?' },
        { id: 'item6_manguera', label: '6. ¿La manguera y boquilla están en buen estado?' },
        { id: 'item7_etiqueta_vencimiento', label: '7. ¿La etiqueta de vencimiento de carga está vigente?' },
    ];

    return (
        <div className="form-checklist-container">
            {items.map(item => (
                <ChecklistItem 
                    key={item.id} 
                    {...item} 
                    value={respuestas[item.id]}
                    onRespuestaChange={handleRespuestaChange}
                    onObservacionChange={handleObservacionChange}
                />
            ))}
            {/* SE ELIMINÓ EL TEXTAREA DE OBSERVACIONES GENERALES */}
        </div>
    );
};

export default FormExtintores;


==================================================================
ARCHIVO: frontend\src\components\forms\FormOrdenAseo.jsx
==================================================================
// frontend/src/componentes/forms/FormOrdenAseo.jsx

import React, { useState, useEffect } from 'react';
import '../../style/InspeccionesPage.css';
import '../../index.css';

const ChecklistItem = ({ id, label, value, onRespuestaChange, onObservacionChange }) => (
    <div className="checklist-item-wrapper">
        <div className="checklist-item">
            <label className="item-label">{label}</label>
            <div className="checklist-options">
                {['B', 'R', 'M', 'NA'].map(val => (
                    <label key={val} className="radio-label">
                        <input type="radio" name={id} value={val} checked={value.respuesta === val} onChange={() => onRespuestaChange(id, val)} />
                        <span>{val}</span>
                    </label>
                ))}
            </div>
        </div>
        <div className="checklist-item-observacion">
            <label htmlFor={`${id}_obs`}>Obs:</label>
            <input type="text" id={`${id}_obs`} value={value.observacion} onChange={(e) => onObservacionChange(id, e.target.value)} placeholder="Observación..." />
        </div>
    </div>
);

const FormSection = ({ title, children }) => (
    <> 
        <h3 className="form-section-header">{title}</h3> 
        <div className="form-checklist-container">{children}</div> 
    </>
);

const FormOrdenAseo = ({ onFormChange, onResultadoChange }) => {
    const sections = {
        clasificar: [{ id: 'cla_necesarios', label: 'Se conservan solo elementos necesarios' }, { id: 'cla_obsoletos', label: 'Se retiran elementos obsoletos' }],
        ordenar: [{ id: 'ord_lugar', label: 'Un lugar para cada cosa y cada cosa en su lugar' }, { id: 'ord_identificados', label: 'Áreas y elementos identificados' }, { id: 'ord_pasillos', label: 'Pasillos y accesos despejados' }],
        limpiar: [{ id: 'lim_pisos', label: 'Pisos, paredes y techos limpios' }, { id: 'lim_maquinas', label: 'Maquinaria y equipos limpios' }, { id: 'lim_puntos', label: 'Puntos ecológicos/residuos limpios y ordenados' }],
        estandarizar: [{ id: 'est_controles', label: 'Existen controles visuales y recordatorios' }, { id: 'est_rutinas', label: 'Se siguen rutinas de orden y aseo' }],
        disciplina: [{ id: 'dis_habito', label: 'El personal demuestra hábito de orden y aseo' }, { id: 'dis_epp', label: 'Uso de EPP según área' }]
    };

    // Generamos el estado inicial
    const initialState = Object.values(sections).flat().reduce((acc, item) => {
        acc[item.id] = { respuesta: '', observacion: '' };
        return acc;
    }, {});

    const [respuestas, setRespuestas] = useState(initialState);

    useEffect(() => {
        const tieneHallazgos = Object.values(respuestas).some(v => v.respuesta === 'R' || v.respuesta === 'M');
        onResultadoChange(tieneHallazgos ? 'Con Hallazgos' : 'OK');
        onFormChange({ checklist: respuestas }); // Solo checklist
    }, [respuestas, onFormChange, onResultadoChange]);

    const handleRespuestaChange = (item, valor) => {
        setRespuestas(prev => ({ ...prev, [item]: { ...prev[item], respuesta: valor } }));
    };
    const handleObservacionChange = (item, valor) => {
        setRespuestas(prev => ({ ...prev, [item]: { ...prev[item], observacion: valor } }));
    };

    return (
        <>
            <FormSection title="1S - CLASIFICAR (SEIRI)">{sections.clasificar.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="2S - ORDENAR (SEITON)">{sections.ordenar.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="3S - LIMPIAR (SEISO)">{sections.limpiar.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="4S - ESTANDARIZAR (SEIKETSU)">{sections.estandarizar.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="5S - DISCIPLINA (SHITSUKE)">{sections.disciplina.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            
            {/* SE ELIMINÓ EL TEXTAREA DE OBSERVACIONES GENERALES */}
        </>
    );
};

export default FormOrdenAseo;


==================================================================
ARCHIVO: frontend\src\components\forms\FormRiesgoElectrico.jsx
==================================================================
// frontend/src/componentes/forms/FormRiesgoElectrico.jsx

import React, { useState, useEffect } from 'react';
import '../../style/InspeccionesPage.css';
import '../../index.css';

const ChecklistItem = ({ id, label, value, onRespuestaChange, onObservacionChange }) => (
    <div className="checklist-item-wrapper">
        <div className="checklist-item">
            <label className="item-label">{label}</label>
            <div className="checklist-options">
                {['B', 'R', 'M', 'NA'].map(val => (
                    <label key={val} className="radio-label">
                        <input type="radio" name={id} value={val} checked={value.respuesta === val} onChange={() => onRespuestaChange(id, val)} />
                        <span>{val}</span>
                    </label>
                ))}
            </div>
        </div>
        <div className="checklist-item-observacion">
            <label htmlFor={`${id}_obs`}>Obs:</label>
            <input type="text" id={`${id}_obs`} value={value.observacion} onChange={(e) => onObservacionChange(id, e.target.value)} placeholder="Observación..." />
        </div>
    </div>
);

const FormSection = ({ title, children }) => (
    <> <h3 className="form-section-header">{title}</h3> <div className="form-checklist-container">{children}</div> </>
);

const FormRiesgoElectrico = ({ onFormChange, onResultadoChange }) => {
    const sections = {
        tableros: [{ id: 'tab_senalizados', label: 'Tableros eléctricos señalizados' }, { id: 'tab_libres', label: 'Acceso libre de obstáculos' }, { id: 'tab_tapas', label: 'Con tapas de protección y directorios' }, { id: 'tab_polo', label: 'Conexión a polo a tierra' },],
        conductores: [{ id: 'con_estado', label: 'Cables/Conductores en buen estado (sin uniones)' }, { id: 'con_canalizacion', label: 'Canalizados (no expuestos)' },],
        tomas: [{ id: 'tom_estado', label: 'Tomas e interruptores en buen estado (sin roturas)' }, { id: 'tom_sobrecarga', label: 'Sin sobrecarga (no usar "multitomas")' },],
        extensiones: [{ id: 'ext_uso', label: 'Uso de extensiones solo temporal' }, { id: 'ext_estado', label: 'Estado de extensiones (sin daños)' },],
        epp: [{ id: 'epp_dielectrico', label: 'Uso de EPP dieléctrico (si aplica)' },]
    };
    
    const initialState = Object.values(sections).flat().reduce((acc, item) => {
        acc[item.id] = { respuesta: '', observacion: '' };
        return acc;
    }, {});
    
    const [respuestas, setRespuestas] = useState(initialState);

    useEffect(() => {
        const tieneHallazgos = Object.values(respuestas).some(v => v.respuesta === 'R' || v.respuesta === 'M');
        onResultadoChange(tieneHallazgos ? 'Con Hallazgos' : 'OK');
        onFormChange({ checklist: respuestas }); // Solo checklist
    }, [respuestas, onFormChange, onResultadoChange]);

    const handleRespuestaChange = (item, valor) => {
        setRespuestas(prev => ({ ...prev, [item]: { ...prev[item], respuesta: valor } }));
    };
    const handleObservacionChange = (item, valor) => {
        setRespuestas(prev => ({ ...prev, [item]: { ...prev[item], observacion: valor } }));
    };

    return (
        <>
            <FormSection title="TABLEROS ELÉCTRICOS">{sections.tableros.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="CONDUCTORES">{sections.conductores.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="TOMAS E INTERRUPTORES">{sections.tomas.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="EXTENSIONES">{sections.extensiones.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="EPP">{sections.epp.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            {/* SE ELIMINÓ EL TEXTAREA DE OBSERVACIONES GENERALES */}
        </>
    );
};

export default FormRiesgoElectrico;


==================================================================
ARCHIVO: frontend\src\components\forms\FormSeguridadGeneral.jsx
==================================================================
// frontend/src/componentes/forms/FormSeguridadGeneral.jsx

import React, { useState, useEffect } from 'react';
import '../../style/InspeccionesPage.css';
import '../../index.css';

const ChecklistItem = ({ id, label, value, onRespuestaChange, onObservacionChange }) => (
    <div className="checklist-item-wrapper">
        <div className="checklist-item">
            <label className="item-label">{label}</label>
            <div className="checklist-options">
                {['B', 'R', 'M', 'NA'].map(val => (
                    <label key={val} className="radio-label">
                        <input type="radio" name={id} value={val} checked={value.respuesta === val} onChange={() => onRespuestaChange(id, val)} />
                        <span>{val}</span>
                    </label>
                ))}
            </div>
        </div>
        <div className="checklist-item-observacion">
            <label htmlFor={`${id}_obs`}>Obs:</label>
            <input type="text" id={`${id}_obs`} value={value.observacion} onChange={(e) => onObservacionChange(id, e.target.value)} placeholder="Observación..." />
        </div>
    </div>
);

const FormSection = ({ title, children }) => (
    <> <h3 className="form-section-header">{title}</h3> <div className="form-checklist-container">{children}</div> </>
);

const FormSeguridadGeneral = ({ onFormChange, onResultadoChange }) => {
    const sections = {
        maquinas: [{ id: 'maq_guardas', label: 'Guardas de seguridad instaladas y en uso' }, { id: 'maq_parada_e', label: 'Paradas de emergencia visibles y funcionales' }, { id: 'maq_mantenimiento', label: 'Mantenimiento preventivo (sin fugas, ruidos)' },],
        escaleras: [{ id: 'esc_estado', label: 'Escaleras fijas (barandas, antideslizante)' }, { id: 'esc_manuales', label: 'Escaleras manuales (estado, zapatas)' }, { id: 'esc_andamios', label: 'Andamios (estabilidad, plataformas)' },],
        instalaciones: [{ id: 'inst_pisos', label: 'Pisos (sin huecos, antideslizantes)' }, { id: 'inst_iluminacion', label: 'Iluminación adecuada' }, { id: 'inst_ventilacion', label: 'Ventilación adecuada' },],
        almacenamiento: [{ id: 'alm_estanterias', label: 'Estanterías (sin sobrecarga, ancladas)' }, { id: 'alm_materiales', label: 'Materiales bien apilados' },],
        epp: [{ id: 'epp_uso', label: 'Uso correcto de EPP por el personal' }, { id: 'epp_estado', label: 'Disponibilidad y estado de EPP' },],
        emergencia: [{ id: 'em_rutas', label: 'Rutas de evacuación despejadas' }, { id: 'em_salidas', label: 'Salidas de emergencia funcionales' }, { id: 'em_extintores', label: 'Extintores (accesibles, cargados)' }, { id: 'em_botiquin', label: 'Botiquín (visible, con dotación)' },]
    };
    
    const initialState = Object.values(sections).flat().reduce((acc, item) => {
        acc[item.id] = { respuesta: '', observacion: '' };
        return acc;
    }, {});
    
    const [respuestas, setRespuestas] = useState(initialState);

    useEffect(() => {
        const tieneHallazgos = Object.values(respuestas).some(v => v.respuesta === 'R' || v.respuesta === 'M');
        onResultadoChange(tieneHallazgos ? 'Con Hallazgos' : 'OK');
        onFormChange({ checklist: respuestas }); // Solo checklist
    }, [respuestas, onFormChange, onResultadoChange]);

    const handleRespuestaChange = (item, valor) => {
        setRespuestas(prev => ({ ...prev, [item]: { ...prev[item], respuesta: valor } }));
    };
    const handleObservacionChange = (item, valor) => {
        setRespuestas(prev => ({ ...prev, [item]: { ...prev[item], observacion: valor } }));
    };

    return (
        <>
            <FormSection title="MAQUINAS, EQUIPOS Y HERRAMIENTAS">{sections.maquinas.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="ESCALERAS Y ANDAMIOS">{sections.escaleras.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="INSTALACIONES LOCATIVAS">{sections.instalaciones.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="ALMACENAMIENTO">{sections.almacenamiento.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="ELEMENTOS DE PROTECCIÓN PERSONAL (EPP)">{sections.epp.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="PREVENCIÓN Y ATENCIÓN DE EMERGENCIAS">{sections.emergencia.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            {/* SE ELIMINÓ EL TEXTAREA DE OBSERVACIONES GENERALES */}
        </>
    );
};

export default FormSeguridadGeneral;


==================================================================
ARCHIVO: frontend\src\components\forms\FormSustanciasQuimicas.jsx
==================================================================
// frontend/src/componentes/forms/FormSustanciasQuimicas.jsx

import React, { useState, useEffect } from 'react';
import '../../style/InspeccionesPage.css';
import '../../index.css';

const ChecklistItem = ({ id, label, value, onRespuestaChange, onObservacionChange }) => (
    <div className="checklist-item-wrapper">
        <div className="checklist-item">
            <label className="item-label">{label}</label>
            <div className="checklist-options">
                {['B', 'R', 'M', 'NA'].map(val => (
                    <label key={val} className="radio-label">
                        <input type="radio" name={id} value={val} checked={value.respuesta === val} onChange={() => onRespuestaChange(id, val)} />
                        <span>{val}</span>
                    </label>
                ))}
            </div>
        </div>
        <div className="checklist-item-observacion">
            <label htmlFor={`${id}_obs`}>Obs:</label>
            <input type="text" id={`${id}_obs`} value={value.observacion} onChange={(e) => onObservacionChange(id, e.target.value)} placeholder="Observación..." />
        </div>
    </div>
);

const FormSection = ({ title, children }) => (
    <> <h3 className="form-section-header">{title}</h3> <div className="form-checklist-container">{children}</div> </>
);

const FormSustanciasQuimicas = ({ onFormChange, onResultadoChange }) => {
    const sections = {
        almacenamiento: [{ id: 'alm_area', label: 'Área de almacenamiento ventilada y señalizada' }, { id: 'alm_compatibilidad', label: 'Incompatibilidades químicas separadas' }, { id: 'alm_envases', label: 'Envases rotulados y en buen estado' }, { id: 'alm_hojas_seg', label: 'Hojas de seguridad (MSDS) disponibles' }, { id: 'alm_diques', label: 'Sistemas de contención/diques para derrames' },],
        manipulacion: [{ id: 'man_trasvase', label: 'Trasvase seguro (embudos, bombas)' }, { id: 'man_personal', label: 'Personal capacitado en riesgos químicos' },],
        epp: [{ id: 'epp_guantes', label: 'Guantes de nitrilo/caucho' }, { id: 'epp_gafas', label: 'Gafas de seguridad / Monogafas' }, { id: 'epp_respirador', label: 'Protección respiratoria (si aplica)' },],
        emergencia: [{ id: 'em_kit', label: 'Kit anti-derrames disponible y completo' }, { id: 'em_ducha', label: 'Ducha de emergencia / Lavaojos funcional' },]
    };
    
    const initialState = Object.values(sections).flat().reduce((acc, item) => {
        acc[item.id] = { respuesta: '', observacion: '' };
        return acc;
    }, {});

    const [respuestas, setRespuestas] = useState(initialState);

    useEffect(() => {
        const tieneHallazgos = Object.values(respuestas).some(v => v.respuesta === 'R' || v.respuesta === 'M');
        onResultadoChange(tieneHallazgos ? 'Con Hallazgos' : 'OK');
        onFormChange({ checklist: respuestas }); // Solo checklist
    }, [respuestas, onFormChange, onResultadoChange]);

    const handleRespuestaChange = (item, valor) => {
        setRespuestas(prev => ({ ...prev, [item]: { ...prev[item], respuesta: valor } }));
    };
    const handleObservacionChange = (item, valor) => {
        setRespuestas(prev => ({ ...prev, [item]: { ...prev[item], observacion: valor } }));
    };

    return (
        <>
            <FormSection title="ALMACENAMIENTO">{sections.almacenamiento.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="MANIPULACIÓN">{sections.manipulacion.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="EPP ESPECÍFICO">{sections.epp.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="EMERGENCIA">{sections.emergencia.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            {/* SE ELIMINÓ EL TEXTAREA DE OBSERVACIONES GENERALES */}
        </>
    );
};
export default FormSustanciasQuimicas;


==================================================================
ARCHIVO: frontend\src\components\forms\FormularioGenericoRenderer.jsx
==================================================================
/* eslint-disable no-unused-vars */
// frontend/src/componentes/forms/FormularioGenericoRenderer.jsx

import React, { useState, useEffect } from 'react';
import '../../style/InspeccionesPage.css';
import '../../index.css';

const ChecklistItem = ({ id, label, value, onRespuestaChange, onObservacionChange }) => (
    <div className="checklist-item-wrapper">
        <div className="checklist-item">
            <label className="item-label">{label}</label>
            <div className="checklist-options">
                {['B', 'R', 'M', 'NA'].map(val => (
                    <label key={val} className="radio-label">
                        <input type="radio" name={id} value={val} checked={value.respuesta === val} onChange={() => onRespuestaChange(id, val)} />
                        <span>{val}</span>
                    </label>
                ))}
            </div>
        </div>
        <div className="checklist-item-observacion">
            <label htmlFor={`${id}_obs`}>Obs:</label>
            <input type="text" id={`${id}_obs`} value={value.observacion} onChange={(e) => onObservacionChange(id, e.target.value)} placeholder="Observación..." />
        </div>
    </div>
);

const FormularioGenericoRenderer = ({ preguntas, onFormChange, onResultadoChange }) => {
    
    const initialState = preguntas.reduce((acc, p) => {
        acc[p.CodigoPregunta] = { respuesta: '', observacion: '' };
        return acc;
    }, {});

    const [respuestas, setRespuestas] = useState(initialState);

    useEffect(() => {
        const tieneHallazgos = Object.values(respuestas).some(v => v.respuesta === 'R' || v.respuesta === 'M' || v.respuesta === 'NC');
        onResultadoChange(tieneHallazgos ? 'Con Hallazgos' : 'OK');
        
        // Comunicar cambios al padre (SOLO checklist)
        onFormChange({ checklist: respuestas });
    }, [respuestas, onFormChange, onResultadoChange]);

    const handleRespuestaChange = (key, valor) => {
        setRespuestas(prev => ({ ...prev, [key]: { ...prev[key], respuesta: valor } }));
    };
    const handleObservacionChange = (key, valor) => {
        setRespuestas(prev => ({ ...prev, [key]: { ...prev[key], observacion: valor } }));
    };

    if (!preguntas || preguntas.length === 0) return <p>No se encontraron preguntas para este formulario. Verifique la estructura en el backend.</p>;

    return (
        <div className="form-checklist-container">
            <h3>Checklist Dinámico</h3>
            {preguntas.map((p, index) => (
                <ChecklistItem 
                    key={p.ID_Pregunta} 
                    id={p.CodigoPregunta} 
                    label={`${p.Orden}. ${p.TextoPregunta}`}
                    value={respuestas[p.CodigoPregunta] || { respuesta: '', observacion: '' }}
                    onRespuestaChange={handleRespuestaChange}
                    onObservacionChange={handleObservacionChange}
                />
            ))}
            {/* SE ELIMINÓ EL TEXTAREA DE OBSERVACIONES GENERALES */}
        </div>
    );
};

export default FormularioGenericoRenderer;


==================================================================
ARCHIVO: frontend\src\components\forms\FormVehiculos.jsx
==================================================================
// frontend/src/componentes/forms/FormVehiculos.jsx

import React, { useState, useEffect } from 'react';
import '../../index.css'; // Usa estilos globales

const initialState = {
    // Documentación
    doc_soat: { respuesta: '', observacion: '' },
    doc_tecnomecanica: { respuesta: '', observacion: '' },
    doc_licencia: { respuesta: '', observacion: '' },
    doc_tarjeta_op: { respuesta: '', observacion: '' },
    // Equipo
    eq_gato: { respuesta: '', observacion: '' },
    eq_cruceta: { respuesta: '', observacion: '' },
    eq_llanta_rep: { respuesta: '', observacion: '' },
    eq_herramienta: { respuesta: '', observacion: '' },
    eq_botiquin: { respuesta: '', observacion: '' },
    eq_extintor: { respuesta: '', observacion: '' },
    eq_tacos: { respuesta: '', observacion: '' },
    eq_senales: { respuesta: '', observacion: '' },
    // Revisión
    rev_luces_altas: { respuesta: '', observacion: '' },
    rev_direccionales: { respuesta: '', observacion: '' },
    rev_stop: { respuesta: '', observacion: '' },
    rev_reversa: { respuesta: '', observacion: '' },
    rev_frenos: { respuesta: '', observacion: '' },
    rev_llantas_est: { respuesta: '', observacion: '' },
    rev_limpiabrisas: { respuesta: '', observacion: '' },
    rev_espejos: { respuesta: '', observacion: '' },
    rev_pito: { respuesta: '', observacion: '' },
    // EPP
    epp_guantes: { respuesta: '', observacion: '' },
    epp_casco: { respuesta: '', observacion: '' },
    // Fluidos
    flu_aceite: { respuesta: '', observacion: '' },
    flu_liq_frenos: { respuesta: '', observacion: '' },
    flu_agua: { respuesta: '', observacion: '' },
};

const ChecklistItem = ({ id, label, value, onRespuestaChange, onObservacionChange }) => (
    <div className="checklist-item-wrapper">
        <div className="checklist-item">
            <label className="item-label">{label}</label>
            <div className="checklist-options">
                {['B', 'R', 'M', 'NA'].map(val => (
                    <label key={val} className="radio-label">
                        <input 
                            type="radio" name={id} value={val} 
                            checked={value.respuesta === val} 
                            onChange={() => onRespuestaChange(id, val)} 
                        />
                        <span>{val}</span>
                    </label>
                ))}
            </div>
        </div>
        <div className="checklist-item-observacion">
            <label htmlFor={`${id}_obs`}>Observación:</label>
            <input 
                type="text" id={`${id}_obs`} 
                value={value.observacion} 
                onChange={(e) => onObservacionChange(id, e.target.value)}
                placeholder="Opcional..."
            />
        </div>
    </div>
);

const FormSection = ({ title, children }) => (
    <>
        <h3 className="form-section-header">{title}</h3>
        <div className="form-checklist-container">{children}</div>
    </>
);

const FormVehiculos = ({ onFormChange, onResultadoChange }) => {
    const [respuestas, setRespuestas] = useState(initialState);

    useEffect(() => {
        const tieneHallazgos = Object.values(respuestas).some(v => v.respuesta === 'R' || v.respuesta === 'M');
        onResultadoChange(tieneHallazgos ? 'Con Hallazgos' : 'OK');
        onFormChange({ checklist: respuestas }); // Solo checklist
    }, [respuestas, onFormChange, onResultadoChange]);

    const handleRespuestaChange = (item, valor) => {
        setRespuestas(prev => ({ ...prev, [item]: { ...prev[item], respuesta: valor } }));
    };
    const handleObservacionChange = (item, valor) => {
        setRespuestas(prev => ({ ...prev, [item]: { ...prev[item], observacion: valor } }));
    };

    const sections = {
        documentos: [
            { id: 'doc_soat', label: 'SOAT Vigente' },
            { id: 'doc_tecnomecanica', label: 'Revisión Tecnomecánica' },
            { id: 'doc_licencia', label: 'Licencia de Conducción' },
            { id: 'doc_tarjeta_op', label: 'Tarjeta de Operación' },
        ],
        equipo: [
            { id: 'eq_gato', label: 'Gato' },
            { id: 'eq_cruceta', label: 'Cruceta' },
            { id: 'eq_llanta_rep', label: 'Llanta Repuesto' },
            { id: 'eq_herramienta', label: 'Herramienta Básica' },
            { id: 'eq_botiquin', label: 'Botiquín' },
            { id: 'eq_extintor', label: 'Extintor' },
            { id: 'eq_tacos', label: 'Tacos' },
            { id: 'eq_senales', label: 'Señales' },
        ],
        revision: [
            { id: 'rev_luces_altas', label: 'Luces Altas/Bajas' },
            { id: 'rev_direccionales', label: 'Direccionales' },
            { id: 'rev_stop', label: 'Stop' },
            { id: 'rev_reversa', label: 'Reversa' },
            { id: 'rev_frenos', label: 'Frenos' },
            { id: 'rev_llantas_est', label: 'Estado Llantas' },
            { id: 'rev_limpiabrisas', label: 'Limpiabrisas' },
            { id: 'rev_espejos', label: 'Espejos' },
            { id: 'rev_pito', label: 'Pito' },
        ],
        epp: [
            { id: 'epp_guantes', label: 'Guantes' },
            { id: 'epp_casco', label: 'Casco (Si aplica)' },
        ],
        fluidos: [
            { id: 'flu_aceite', label: 'Nivel Aceite' },
            { id: 'flu_liq_frenos', label: 'Nivel Liq. Frenos' },
            { id: 'flu_agua', label: 'Nivel Agua' },
        ]
    };

    return (
        <>
            <FormSection title="DOCUMENTOS">{sections.documentos.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="EQUIPO DE CARRETERA">{sections.equipo.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="REVISIÓN EXTERNA E INTERNA">{sections.revision.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="EPP">{sections.epp.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>
            <FormSection title="FLUIDOS">{sections.fluidos.map(item => <ChecklistItem key={item.id} {...item} value={respuestas[item.id]} onRespuestaChange={handleRespuestaChange} onObservacionChange={handleObservacionChange} />)}</FormSection>

            {/* SE ELIMINÓ EL TEXTAREA DE OBSERVACIONES GENERALES */}
        </>
    );
};

export default FormVehiculos;


==================================================================
ARCHIVO: frontend\src\components\Header.jsx
==================================================================
// frontend/src/components/Header.jsx

import React from 'react';
import { useAuth } from '../context/AuthContext';
import '../style/Header.css';
import { useNavigate } from 'react-router-dom';
import logo from "../assets/logo-empaquetados.png";

// Importamos el componente de Campana
import NotificationBell from './NotificationBell'; 

const Header = () => {
    const { usuario, logout } = useAuth();
    const navigate = useNavigate();

    const handleLogout = () => {
        logout();
        navigate('/login');
    };

    return (
        <header className="header-container">
            
            {/* --- LOGO RECUPERADO --- */}
            {/* Se usa la clase 'sidebar-logo-img3' que ya tienes en Header.css con posición absoluta */}
            <img src={logo} alt="Logo Empaquetados El Trece" className="sidebar-logo-img3"/>

            {/* Placeholder izquierdo */}
            <div className="header-title-placeholder"></div>
            
            {/* --- Sección Derecha: Usuario y Notificaciones --- */}
            <div className="header-user-info">
                
                {/* 1. CAMPANA DE NOTIFICACIONES */}
                <NotificationBell />
                
                {/* Separador vertical sutil */}
                <div style={{width:'1px', height:'25px', background:'#dee2e6', margin:'0 1rem'}}></div>

                {/* 2. Información del Usuario */}
                <div style={{display: 'flex', flexDirection: 'column', alignItems: 'flex-end', marginRight: '0.8rem'}}>
                    <span style={{fontSize: '0.9rem', fontWeight: '600', color: '#333'}}>
                        {usuario ? usuario.nombre : 'Usuario'}
                    </span>
                    <span style={{fontSize: '0.75rem', color: '#6c757d'}}>
                        {usuario ? usuario.rol : ''}
                    </span>
                </div>

                <div className="user-avatar">
                    {usuario ? usuario.nombre[0].toUpperCase() : 'U'}
                </div>
                
                {/* 3. Botón Cerrar Sesión */}
                <button onClick={handleLogout} className="header-logout-button">
                    Cerrar Sesión
                </button>
            </div>
        </header>
    );
};

export default Header;


==================================================================
ARCHIVO: frontend\src\components\InspeccionDetalleRenderer.jsx
==================================================================
// frontend/src/componentes/InspeccionDetalleRenderer.jsx

import React from 'react';
import '../style/InspeccionesPage.css'; 
import '../index.css'; 

// --- DICCIONARIOS DE TRADUCCIÓN COMPLETOS (TODOS LOS FORMULARIOS) ---
const DICTIONARIES = {
    // 1. VEHÍCULOS (FTO-SST-02)
    'FTO-SST-02': { 
        doc_soat: 'SOAT Vigente', doc_tecnomecanica: 'Revisión Tecnomecánica Vigente',
        doc_licencia: 'Licencia de Conducción Vigente', doc_tarjeta_op: 'Tarjeta de Operación (si aplica)',
        eq_gato: 'Gato con capacidad', eq_cruceta: 'Cruceta', eq_llanta_rep: 'Llanta de Repuesto',
        eq_herramienta: 'Herramienta Básica', eq_botiquin: 'Botiquín', eq_extintor: 'Extintor (Vigente y Cargado)',
        eq_tacos: 'Tacos para bloquear', eq_senales: 'Señales de carretera',
        rev_luces_altas: 'Luces Altas y Bajas', rev_direccionales: 'Luces Direccionales',
        rev_stop: 'Luces de Stop', rev_reversa: 'Luces de Reversa', rev_frenos: 'Frenos (Pedal y Emergencia)',
        rev_llantas_est: 'Estado Llantas', rev_limpiabrisas: 'Limpiaparabrisas',
        rev_espejos: 'Espejos (Laterales y Retrovisor)', rev_pito: 'Pito',
        epp_guantes: 'Guantes', epp_casco: 'Casco (si aplica)',
        flu_aceite: 'Nivel Aceite Motor', flu_liq_frenos: 'Nivel Líquido de Frenos',
        flu_agua: 'Nivel Agua/Refrigerante',
    },
    // 2. EXTINTORES (FTO-SST-13)
    'FTO-SST-13': { 
        item1_ubicacion: '1. ¿Está en la ubicación asignada?',
        item2_senalizacion: '2. ¿La señalización es visible y adecuada?',
        item3_acceso: '3. ¿El acceso al extintor está libre de obstáculos?',
        item4_manometro: '4. ¿El manómetro indica la presión adecuada (en verde)?',
        item5_seguro: '5. ¿El seguro (pasador) y sello de garantía están intactos?',
        item6_manguera: '6. ¿La manguera y boquilla están en buen estado?',
        item7_etiqueta_vencimiento: '7. ¿La etiqueta de vencimiento de carga está vigente?',
    },
    // 3. BOTIQUÍN (FTO-SST-14)
    'FTO-SST-14': { 
        item_gasas: 'Gasas limpias (paquete)', item_esparadrapo: 'Esparadrapo de tela',
        item_baja_lenguas: 'Baja lenguas (paquete)', item_curas: 'Curitas (paquete)',
        item_venda_ela_2: 'Venda elástica 2x5', item_venda_ela_3: 'Venda elástica 3x5',
        item_venda_alg: 'Venda de algodón 3x5', item_yodopovidona: 'Yodopovidona (jabón)',
        item_sol_salina: 'Solución salina (250 o 500ml)', item_guantes: 'Guantes de látex (caja)',
        item_tijeras: 'Tijeras', item_termometro: 'Termómetro',
    },
    // 4. ORDEN Y ASEO (FTO-SST-23)
    'FTO-SST-23': { 
        cla_necesarios: 'Se conservan solo elementos necesarios', cla_obsoletos: 'Se retiran elementos obsoletos',
        ord_lugar: 'Un lugar para cada cosa y cada cosa en su lugar', ord_identificados: 'Áreas y elementos identificados',
        ord_pasillos: 'Pasillos y accesos despejados', lim_pisos: 'Pisos, paredes y techos limpios',
        lim_maquinas: 'Maquinaria y equipos limpios', lim_puntos: 'Puntos ecológicos/residuos limpios y ordenados',
        est_controles: 'Existen controles visuales y recordatorios', est_rutinas: 'Se siguen rutinas de orden y aseo',
        dis_habito: 'El personal demuestra hábito de orden y aseo', dis_epp: 'Uso de EPP según área',
    },
    // 5. SEGURIDAD GENERAL (FTO-SST-45)
    'FTO-SST-45': { 
        maq_guardas: 'Guardas de seguridad instaladas y en uso', maq_parada_e: 'Paradas de emergencia visibles y funcionales',
        maq_mantenimiento: 'Mantenimiento preventivo (sin fugas, ruidos)', esc_estado: 'Escaleras fijas (barandas, antideslizante)',
        esc_manuales: 'Escaleras manuales (estado, zapatas)', esc_andamios: 'Andamios (estabilidad, plataformas)',
        inst_pisos: 'Pisos (sin huecos, antideslizantes)', inst_iluminacion: 'Iluminación adecuada',
        inst_ventilacion: 'Ventilación adecuada', alm_estanterias: 'Estanterías (sin sobrecarga, ancladas)',
        alm_materiales: 'Materiales bien apilados', epp_uso: 'Uso correcto de EPP por el personal',
        epp_estado: 'Disponibilidad y estado de EPP', em_rutas: 'Rutas de evacuación despejadas',
        em_salidas: 'Salidas de emergencia funcionales', em_extintores: 'Extintores (accesibles, cargados)',
        em_botiquin: 'Botiquín (visible, con dotación)',
    },
    // 6. SUSTANCIAS QUÍMICAS (FTO-SST-95)
    'FTO-SST-95': { 
        alm_area: 'Área de almacenamiento ventilada y señalizada', alm_compatibilidad: 'Incompatibilidades químicas separadas',
        alm_envases: 'Envases rotulados y en buen estado', alm_hojas_seg: 'Hojas de seguridad (MSDS) disponibles',
        alm_diques: 'Sistemas de contención/diques para derrames', man_trasvase: 'Trasvase seguro (embudos, bombas)',
        man_personal: 'Personal capacitado en riesgos químicos', epp_guantes: 'Guantes de nitrilo/caucho',
        epp_gafas: 'Gafas de seguridad / Monogafas', epp_respirador: 'Protección respiratoria (si aplica)',
        em_kit: 'Kit anti-derrames disponible y completo', em_ducha: 'Ducha de emergencia / Lavaojos funcional',
    },
    // 7. RIESGO ELÉCTRICO (FTO-SST-96)
    'FTO-SST-96': { 
        tab_senalizados: 'Tableros eléctricos señalizados', tab_libres: 'Acceso libre de obstáculos',
        tab_tapas: 'Con tapas de protección y directorios', tab_polo: 'Conexión a polo a tierra',
        con_estado: 'Cables/Conductores en buen estado (sin uniones)', con_canalizacion: 'Canalizados (no expuestos)',
        tom_estado: 'Tomas e interruptores en buen estado (sin roturas)', tom_sobrecarga: 'Sin sobrecarga (no usar "multitomas")',
        ext_uso: 'Uso de extensiones solo temporal', ext_estado: 'Estado de extensiones (sin daños)',
        epp_dielectrico: 'Uso de EPP dieléctrico (si aplica)',
    }
};

// Componente pequeño para mostrar la 'píldora' de B/R/M/C/NC
const RenderValor = ({ valor }) => {
    let clase = '';
    if (valor === 'B' || valor === 'C') clase = 'status-activo'; 
    else if (valor === 'R' || valor === 'M' || valor === 'NC') clase = 'status-pendiente'; 
    else if (valor === 'NA') clase = 'status-inactivo'; 
    else clase = 'status-inactivo'; 

    return <span className={`status-pill ${clase}`} style={{ width: '45px', textAlign: 'center', flexShrink: 0 }}>{valor}</span>;
};

/**
 * @component InspeccionDetalleRenderer
 * @desc Renderiza el JSON (o Array) de 'DatosDiligenciados' de forma legible
 */
const InspeccionDetalleRenderer = ({ formId, jsonString }) => {
    // Si viene vacío
    if (!jsonString) return <p>No hay datos registrados.</p>;

    let data;
    try {
        data = JSON.parse(jsonString);
    // eslint-disable-next-line no-unused-vars
    } catch (e) {
        return <p className="modal-error">Error al leer los datos (JSON inválido).</p>;
    }

    // 1. Identificar el Diccionario
    const dictionary = DICTIONARIES[formId] || {};
    
    // 2. Normalizar los datos (Soportar formato Nuevo Array y Viejo Objeto)
    let items = [];
    let observacionesGenerales = '';
    let infoAdicional = '';
    let otroActivo = '';

    if (Array.isArray(data)) {
        // --- FORMATO NUEVO (SQL 'FOR JSON') ---
        // La BD devuelve un array de objetos [{key, respuesta, observacion}, ...]
        items = data;
    } else {
        // --- FORMATO VIEJO (Objeto JS guardado como string) ---
        // { checklist: {...}, observacionesFormulario: "...", infoAdicionalActivo: "..." }
        observacionesGenerales = data.observacionesFormulario || '';
        infoAdicional = data.infoAdicionalActivo || '';
        otroActivo = data.otroActivoMencionado || '';
        
        if (data.checklist) {
            items = Object.entries(data.checklist).map(([key, val]) => {
                // Algunos viejos pueden ser solo string "B", otros objetos {respuesta: "B"}
                const respuesta = (typeof val === 'object' && val !== null) ? val.respuesta : val;
                const observacion = (typeof val === 'object' && val !== null) ? val.observacion : '';
                return { key, respuesta, observacion };
            });
        }
    }

    // 3. Renderizar
    return (
        <div className="form-checklist-container">

            {/* Secciones de Info Adicional (Solo si vienen en el JSON antiguo o separado) */}
            {infoAdicional && (
                <div className="detail-section" style={{ paddingBottom: '1rem', borderBottom: '1px solid #f0f2f5' }}>
                    <strong>Información Adicional del Activo:</strong>
                    <p style={{ margin: 0, fontSize: '0.95rem' }}>{infoAdicional}</p>
                </div>
            )}
            {otroActivo && (
                <div className="detail-section" style={{ paddingBottom: '1rem', borderBottom: '1px solid #f0f2f5' }}>
                    <strong>Activo/Área Relacionada:</strong>
                    <p style={{ margin: 0, fontSize: '0.95rem' }}>{otroActivo}</p>
                </div>
            )}
            
            {/* Renderizado del Checklist */}
            {items.map((item, index) => {
                if (!item.respuesta) return null;
                
                // Busca el texto legible en el diccionario. Si no existe, usa la 'key' original.
                const label = dictionary[item.key] || item.key; 
                
                return (
                    <div key={index} className="checklist-item-wrapper">
                        <div className="checklist-item">
                            <label className="item-label">{label}</label>
                            <RenderValor valor={item.respuesta} />
                        </div>
                        {/* Muestra observación individual si existe */}
                        {item.observacion && (
                            <div className="checklist-item-observacion" style={{ paddingLeft: '0.5rem', marginTop: '0.25rem' }}>
                                <em style={{ color: '#6c757d', fontSize: '0.9rem' }}>Obs: {item.observacion}</em>
                            </div>
                        )}
                    </div>
                );
            })}
            
            {/* Observaciones Generales (Formato Viejo) */}
            {observacionesGenerales && (
                <div className="detail-section" style={{marginTop: '1rem', borderTop: '1px solid #f0f2f5', paddingTop: '1rem'}}>
                    <strong>Observaciones Generales del Formulario:</strong>
                    <p className="detail-box">{observacionesGenerales}</p>
                </div>
            )}
        </div>
    );
};

export default InspeccionDetalleRenderer;


==================================================================
ARCHIVO: frontend\src\components\ModalConfigurarPlantilla.jsx
==================================================================
// frontend/src/components/ModalConfigurarPlantilla.jsx

import React, { useState, useEffect } from 'react';
import { apiFetch } from '../services/apiService';
import '../style/Modal.css';
import Swal from 'sweetalert2';
import { BsPlusCircle, BsTrash, BsFileEarmarkText } from 'react-icons/bs';

const ModalConfigurarPlantilla = ({ paso, alCerrar }) => {
    const [config, setConfig] = useState({
        titulo: '',
        cuerpo: '',
        campos: [] // [{ label: 'Nombre', tipo: 'texto', orden: 1 }]
    });
    const [isLoading, setIsLoading] = useState(false);

    useEffect(() => {
        cargarConfig();
    }, []);

    const cargarConfig = async () => {
        try {
            const data = await apiFetch(`/pesv/plantilla/${paso.ID_Paso}`);
            if (data.existe) {
                setConfig({
                    titulo: data.config.TituloDocumento,
                    cuerpo: data.config.CuerpoInicial || '',
                    campos: data.campos.map(c => ({ label: c.Etiqueta, tipo: c.TipoInput, orden: c.Orden }))
                });
            }
        } catch (error) { console.error(error); }
    };

    const agregarCampo = () => {
        setConfig(prev => ({
            ...prev,
            campos: [...prev.campos, { label: '', tipo: 'texto', orden: prev.campos.length + 1 }]
        }));
    };

    const actualizarCampo = (idx, key, val) => {
        const nuevos = [...config.campos];
        nuevos[idx][key] = val;
        setConfig({ ...config, campos: nuevos });
    };

    const borrarCampo = (idx) => {
        const nuevos = config.campos.filter((_, i) => i !== idx);
        setConfig({ ...config, campos: nuevos });
    };

    const handleGuardar = async (e) => {
        e.preventDefault();
        if (config.campos.length === 0) {
            Swal.fire('Atención', 'Debe agregar al menos un campo para el formulario.', 'warning');
            return;
        }
        setIsLoading(true);
        try {
            await apiFetch('/pesv/plantilla', {
                method: 'POST',
                body: JSON.stringify({
                    idPaso: paso.ID_Paso,
                    titulo: config.titulo,
                    cuerpo: config.cuerpo,
                    campos: config.campos
                })
            });
            Swal.fire('Éxito', 'Plantilla configurada correctamente. Ahora se puede generar.', 'success');
            alCerrar();
        // eslint-disable-next-line no-unused-vars
        } catch (error) {
            Swal.fire('Error', 'No se pudo guardar la configuración', 'error');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                    <h3>Diseñar Formulario: Paso {paso.NumeroPaso}</h3>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleGuardar}>
                    <div className="modal-body" style={{maxHeight:'70vh', overflowY:'auto'}}>
                        
                        <div className="form-group">
                            <label>Título del Documento PDF</label>
                            <input className="form-control" required value={config.titulo} onChange={e => setConfig({...config, titulo: e.target.value})} placeholder="Ej: ACTA DE REUNIÓN" />
                        </div>
                        
                        <div className="form-group">
                            <label>Texto Introductorio (Fijo)</label>
                            <textarea className="form-control" rows="3" value={config.cuerpo} onChange={e => setConfig({...config, cuerpo: e.target.value})} placeholder="Ej: En la ciudad de Medellín se reunieron..." />
                        </div>

                        <hr />
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'10px'}}>
                            <h4 style={{margin:0, color:'#005A5B'}}>Campos Dinámicos</h4>
                            <button type="button" className="btn btn-sm btn-secondary" onClick={agregarCampo}>
                                <BsPlusCircle /> Agregar Campo
                            </button>
                        </div>
                        
                        {config.campos.length === 0 && <p style={{color:'#999', textAlign:'center'}}>No hay campos definidos. Agrega uno.</p>}

                        {config.campos.map((campo, idx) => (
                            <div key={idx} style={{display:'flex', gap:'10px', marginBottom:'10px', alignItems:'center', backgroundColor:'#f8f9fa', padding:'10px', borderRadius:'6px'}}>
                                <span style={{fontWeight:'bold', color:'#666'}}>{idx + 1}.</span>
                                <input 
                                    className="form-control" 
                                    placeholder="Nombre del Campo (Ej: Nombre Asistente)" 
                                    value={campo.label} 
                                    onChange={e => actualizarCampo(idx, 'label', e.target.value)}
                                    required
                                    style={{flex: 2}}
                                />
                                <select className="form-control" value={campo.tipo} onChange={e => actualizarCampo(idx, 'tipo', e.target.value)} style={{flex: 1}}>
                                    <option value="texto">Texto Corto</option>
                                    <option value="fecha">Fecha</option>
                                    <option value="parrafo">Párrafo Largo</option>
                                </select>
                                <button type="button" className="btn btn-sm btn-danger" onClick={() => borrarCampo(idx)}><BsTrash /></button>
                            </div>
                        ))}

                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>
                            {isLoading ? 'Guardando...' : 'Guardar Diseño'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalConfigurarPlantilla;


==================================================================
ARCHIVO: frontend\src\components\ModalConfirmarAccion.jsx
==================================================================
// frontend/src/componentes/ModalConfirmarAccion.jsx

import React, { useState } from 'react';
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; // <-- 1. Importar

const ModalConfirmarAccion = ({ 
    titulo, 
    mensaje, 
    enConfirmar, // Esta es la función async que llama a la API
    alCerrar, 
    textoBotonConfirmar = "Confirmar", 
    claseBoton = "btn-danger" 
}) => {
    
    const [isLoading, setIsLoading] = useState(false);

    const handleConfirmar = async () => {
        setIsLoading(true);
        try {
            await enConfirmar(); // Llama a la acción (ej. eliminarActividad)
            
            // --- 2. MOSTRAR ÉXITO (SUTIL) ---
            Swal.fire({
                title: '¡Hecho!',
                text: `La acción "${textoBotonConfirmar}" se completó exitosamente.`,
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            
            alCerrar(); // Cierra el modal si tiene éxito
        } catch (err) {
            // --- 3. MOSTRAR ERROR ---
            Swal.fire({
                title: 'Error',
                text: err.message || 'Ocurrió un error al realizar la acción',
                icon: 'error'
            });
            setIsLoading(false); // Permite reintentar
        } 
        // No ponemos 'finally' porque solo queremos que se quite el loading en error
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>{titulo}</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <div className="modal-body">
                    <p>{mensaje}</p>
                </div>
                <div className="modal-footer">
                    <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                    <button type="button" className={`btn ${claseBoton}`} onClick={handleConfirmar} disabled={isLoading}>
                        {isLoading ? 'Procesando...' : textoBotonConfirmar}
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalConfirmarAccion;


==================================================================
ARCHIVO: frontend\src\components\ModalCrearACPM.jsx
==================================================================
// frontend/src/componentes/ModalCrearACPM.jsx

import React, { useState, useEffect } from 'react';
import { crearACPM } from '../services/acpmService'; 
import { getTodosUsuarios } from '../services/userService'; 
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; 

/**
 * @component ModalCrearACPM
 * @desc Modal con formulario para crear una nueva ACPM (CU-03)
 * @param {function} alCerrar - Función para cerrar el modal
 * @param {function} alExito - Función que se llama si se crea exitosamente (devuelve el nuevo ID)
 * @param {object} initialData - (Opcional) Datos para pre-llenar el formulario
 */
const ModalCrearACPM = ({ alCerrar, alExito, initialData = {} }) => {
    
    // --- Estados del Formulario ---
    const [formData, setFormData] = useState({
        tipoAccion: initialData.tipoAccion || 'Correctiva', 
        origen: initialData.origen || '',
        descripcionProblema: initialData.descripcionProblema || '',
        planAccion: '',
        idUsuarioResponsable: '', // (Se carga desde el selector)
        fechaLimite: new Date().toISOString().split('T')[0], 
        analisisCausa: '',
        idInspeccionOrigen: initialData.idInspeccionOrigen || null,
        idReporteMaquinaOrigen: initialData.idReporteMaquinaOrigen || null,
        idReporteSeguridadOrigen: initialData.idReporteSeguridadOrigen || null,
    });
    
    const [listaUsuarios, setListaUsuarios] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    // --- Cargar Usuarios para el Selector ---
    useEffect(() => {
        const cargarUsuarios = async () => {
            try {
                const data = await getTodosUsuarios();
                setListaUsuarios(data);
            } catch (err) {
                console.error("Error cargando usuarios:", err);
                setError("No se pudo cargar la lista de responsables");
            }
        };
        cargarUsuarios();
    }, []); // Se ejecuta solo una vez al montar

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({
            ...prevState,
            [name]: value
        }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        
        // --- Validación (Bug de NaN) ---
        const idResponsableNum = parseInt(formData.idUsuarioResponsable);
        if (!idResponsableNum) {
            setError('Debe seleccionar un responsable válido.');
            return;
        }

        setIsLoading(true);

        try {
            const payload = { 
                ...formData, 
                idUsuarioResponsable: idResponsableNum // Envía el número
            };
            
            const respuesta = await crearACPM(payload);
            const nuevoIdACPM = respuesta.idACPM; // Obtenemos el ID
            
            Swal.fire({
                title: '¡Éxito!',
                text: 'Acción ACPM creada exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            
            alExito(nuevoIdACPM); // Devolvemos el ID al padre
            
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Crear Nueva Acción (ACPM)</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <form onSubmit={handleSubmit}>
                    <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                        
                        <div className="form-group"><label htmlFor="tipoAccion">Tipo de Acción *</label><select id="tipoAccion" name="tipoAccion" value={formData.tipoAccion} onChange={handleChange}><option value="Correctiva">Correctiva</option><option value="Preventiva">Preventiva</option><option value="Mejora">Mejora</option></select></div>
                        <div className="form-group"><label htmlFor="origen">Origen del Hallazgo *</label><input type="text" id="origen" name="origen" value={formData.origen} onChange={handleChange} placeholder="Ej: Inspección Extintores, Reporte Colaborador..." required /></div>
                        <div className="form-group"><label htmlFor="descripcionProblema">Descripción del Problema/Hallazgo *</label><textarea id="descripcionProblema" name="descripcionProblema" rows="3" value={formData.descripcionProblema} onChange={handleChange} required /></div>
                        <div className="form-group"><label htmlFor="planAccion">Plan de Acción *</label><textarea id="planAccion" name="planAccion" rows="3" value={formData.planAccion} onChange={handleChange} required /></div>
                        
                        <div className="form-group">
                            <label htmlFor="idUsuarioResponsable">Responsable de la Ejecución *</label>
                            <select id="idUsuarioResponsable" name="idUsuarioResponsable" value={formData.idUsuarioResponsable} onChange={handleChange} required>
                                <option value="">-- Seleccione un responsable --</option>
                                {listaUsuarios.map(user => (
                                    <option key={user.ID_Usuario} value={user.ID_Usuario}>
                                        {user.NombreCompleto}
                                    </option>
                                ))}
                            </select>
                        </div>
                        
                        <div className="form-group"><label htmlFor="fechaLimite">Fecha Límite *</label><input type="date" id="fechaLimite" name="fechaLimite" value={formData.fechaLimite} onChange={handleChange} min={new Date().toISOString().split('T')[0]} required /></div>
                        <div className="form-group"><label htmlFor="analisisCausa">Análisis de Causa (Opcional)</label><textarea id="analisisCausa" name="analisisCausa" rows="3" value={formData.analisisCausa} onChange={handleChange} /></div>

                        {error && <p className="modal-error">{error}</p>}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Creando...' : 'Crear Acción'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalCrearACPM;


==================================================================
ARCHIVO: frontend\src\components\ModalCrearActividad.jsx
==================================================================
// frontend/src/componentes/ModalCrearActividad.jsx

import React, { useState, useEffect } from 'react';
import { crearActividad } from '../services/scheduleService';
import { getTodosUsuarios } from '../services/userService'; 
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; // <-- 1. Importar

const ModalCrearActividad = ({ idCronograma, alCerrar, alExito }) => {
    const getManana = () => {
        const manana = new Date();
        manana.setDate(manana.getDate() + 1);
        return manana.toISOString().split('T')[0];
    };
    const [formData, setFormData] = useState({
        nombreActividad: '',
        idUsuarioResponsable: '',
        fechaLimite: getManana(),
        descripcion: ''
    });
    const [listaUsuarios, setListaUsuarios] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    useEffect(() => {
        const cargarUsuarios = async () => {
            try {
                const data = await getTodosUsuarios();
                setListaUsuarios(data);
            } catch (err) {
                console.error("Error cargando usuarios:", err);
                setError("No se pudo cargar la lista de responsables");
            }
        };
        cargarUsuarios();
    }, []);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({ ...prevState, [name]: value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setIsLoading(true);
        try {
            const payload = { ...formData, idUsuarioResponsable: parseInt(formData.idUsuarioResponsable) };
            await crearActividad(idCronograma, payload);
            
            // --- 2. REEMPLAZAR 'alert()' ---
            Swal.fire({
                title: '¡Éxito!',
                text: 'Actividad creada exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            alExito(); 
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Añadir Nueva Actividad</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        {/* (Inputs del formulario sin cambios) */}
                        <div className="form-group"><label htmlFor="nombreActividad">Nombre de la Actividad *</label><input type="text" id="nombreActividad" name="nombreActividad" value={formData.nombreActividad} onChange={handleChange} placeholder="Ej: Capacitación Uso de EPP" required /></div>
                        <div className="form-group"><label htmlFor="idUsuarioResponsable">Responsable *</label><select id="idUsuarioResponsable" name="idUsuarioResponsable" value={formData.idUsuarioResponsable} onChange={handleChange} required><option value="">-- Seleccione un responsable --</option>{listaUsuarios.map(user => (<option key={user.ID_Usuario} value={user.ID_Usuario}>{user.NombreCompleto}</option>))}</select></div>
                        <div className="form-group"><label htmlFor="fechaLimite">Fecha Límite *</label><input type="date" id="fechaLimite" name="fechaLimite" value={formData.fechaLimite} onChange={handleChange} min={getManana()} required /></div>
                        <div className="form-group"><label htmlFor="descripcion">Descripción (Opcional)</label><input type="text" id="descripcion" name="descripcion" value={formData.descripcion} onChange={handleChange} /></div>
                        {error && <p className="modal-error">{error}</p>}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Creando...' : 'Añadir Actividad'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalCrearActividad;


==================================================================
ARCHIVO: frontend\src\components\ModalCrearActivo.jsx
==================================================================
// frontend/src/components/ModalCrearActivo.jsx

import React, { useState, useEffect } from 'react';
import { crearActivo, getTiposActivosDisponibles } from '../services/assetService';
import { getColaboradores } from '../services/userService';
import { useAuth } from '../context/AuthContext';
import '../style/Modal.css';
import '../index.css';
import Swal from 'sweetalert2';

const ModalCrearActivo = ({ alCerrar, alExito }) => {
    // eslint-disable-next-line no-unused-vars
    const { usuario } = useAuth(); 

    const [formData, setFormData] = useState({
        tipoActivo: '',
        codigoIdentificador: '',
        nombreDescriptivo: '',
        ubicacion: '',
        // Campos extra para Vehículos
        marca: '',
        modelo: '',
        soatVencimiento: '',
        tecnoVencimiento: '',
        kilometrajeInicial: 0,
        idConductor: ''
    });

    const [listaTipos, setListaTipos] = useState([]); // Array de objetos { TipoActivoAsociado, Categoria }
    const [listaConductores, setListaConductores] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    useEffect(() => {
        const cargarDatos = async () => {
            try {
                // 1. Cargar Tipos (Ahora trae la categoría)
                const tipos = await getTiposActivosDisponibles();
                setListaTipos(tipos);
                
                // Pre-seleccionar el primer tipo si existe
                if (tipos.length > 0) {
                    setFormData(prev => ({ ...prev, tipoActivo: tipos[0].TipoActivoAsociado }));
                }

                // 2. Cargar Usuarios (Para asignar como conductores)
                const users = await getColaboradores(); 
                setListaConductores(users);

            } catch (err) {
                console.error("Error cargando datos:", err);
                setError('Error cargando las listas de configuración.');
            }
        };
        cargarDatos();
    }, []);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({ ...prevState, [name]: value }));
    };

    // --- LÓGICA INTELIGENTE ---
    // Busca el objeto completo en la lista para ver su categoría
    const esVehiculo = () => {
        const tipoSeleccionado = listaTipos.find(t => t.TipoActivoAsociado === formData.tipoActivo);
        // Si la categoría en BD es 'Vehiculo', mostramos los campos
        return tipoSeleccionado?.Categoria === 'Vehiculo';
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setIsLoading(true);

        try {
            // Preparar payload: Limpiar datos numéricos si están vacíos
            const payload = {
                ...formData,
                kilometrajeInicial: formData.kilometrajeInicial || 0,
                idConductor: formData.idConductor || null
            };

            await crearActivo(payload);
            
            Swal.fire({
                title: '¡Éxito!',
                text: 'Activo creado exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            alExito(); 
            
        } catch (err) {
            Swal.fire('Error', err.message, 'error');
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Crear Nuevo Activo</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <form onSubmit={handleSubmit}>
                    <div className="modal-body" style={{maxHeight: '70vh', overflowY: 'auto'}}>
                        
                        <div className="form-group">
                            <label htmlFor="tipoActivo">Tipo de Activo *</label>
                            {listaTipos.length === 0 ? (
                                <p style={{color: 'orange'}}>Cargando tipos...</p>
                            ) : (
                                <select 
                                    id="tipoActivo" 
                                    name="tipoActivo" 
                                    value={formData.tipoActivo} 
                                    onChange={handleChange} 
                                    required
                                >
                                    {listaTipos.map((t, index) => (
                                        <option key={index} value={t.TipoActivoAsociado}>{t.TipoActivoAsociado}</option>
                                    ))}
                                </select>
                            )}
                        </div>

                        {/* CAMPOS COMUNES */}
                        <div className="form-group">
                            <label>{esVehiculo() ? 'Placa del Vehículo *' : 'Código Identificador *'}</label>
                            <input type="text" name="codigoIdentificador" value={formData.codigoIdentificador} onChange={handleChange} placeholder={esVehiculo() ? "Ej: ABC-123" : "Ej: MAQ-01"} required />
                        </div>
                        <div className="form-group">
                            <label>Nombre Descriptivo *</label>
                            <input type="text" name="nombreDescriptivo" value={formData.nombreDescriptivo} onChange={handleChange} placeholder={esVehiculo() ? "Ej: Camioneta N300 - Repartos" : "Ej: Taladro de Banco"} required />
                        </div>
                        <div className="form-group">
                            <label>Ubicación / Área</label>
                            <input type="text" name="ubicacion" value={formData.ubicacion} onChange={handleChange} placeholder="Ej: Parqueadero / Bodega" />
                        </div>

                        {/* --- SECCIÓN DINÁMICA DE VEHÍCULOS --- */}
                        {esVehiculo() && (
                            <div style={{backgroundColor: '#f8f9fa', padding: '1rem', borderRadius: '8px', border: '1px solid #dee2e6', marginTop: '1rem'}}>
                                <h4 style={{marginTop:0, color: 'var(--color-primario)', borderBottom: '1px solid #ddd', paddingBottom: '5px'}}>Datos del Vehículo</h4>
                                
                                <div style={{display: 'flex', gap: '10px'}}>
                                    <div className="form-group" style={{flex: 1}}>
                                        <label>Marca</label>
                                        <input type="text" name="marca" value={formData.marca} onChange={handleChange} placeholder="Ej: Chevrolet" />
                                    </div>
                                    <div className="form-group" style={{flex: 1}}>
                                        <label>Modelo</label>
                                        <input type="text" name="modelo" value={formData.modelo} onChange={handleChange} placeholder="Ej: 2024" />
                                    </div>
                                </div>

                                <div className="form-group">
                                    <label>Conductor Asignado</label>
                                    <select name="idConductor" value={formData.idConductor} onChange={handleChange}>
                                        <option value="">-- Sin asignar --</option>
                                        {listaConductores.map(u => (
                                            <option key={u.ID_Usuario} value={u.ID_Usuario}>{u.NombreCompleto} ({u.CedulaUsuario})</option>
                                        ))}
                                    </select>
                                </div>

                                <div className="form-group">
                                    <label>Kilometraje Inicial</label>
                                    <input type="number" name="kilometrajeInicial" value={formData.kilometrajeInicial} onChange={handleChange} placeholder="0" />
                                </div>

                                <div style={{display: 'flex', gap: '10px'}}>
                                    <div className="form-group" style={{flex: 1}}>
                                        <label>Vencimiento SOAT</label>
                                        <input type="date" name="soatVencimiento" value={formData.soatVencimiento} onChange={handleChange} />
                                    </div>
                                    <div className="form-group" style={{flex: 1}}>
                                        <label>Venc. Tecnomecánica</label>
                                        <input type="date" name="tecnoVencimiento" value={formData.tecnoVencimiento} onChange={handleChange} />
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* --- FIN SECCIÓN VEHÍCULOS --- */}

                        {error && <p className="modal-error">{error}</p>}
                    </div>

                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>
                            {isLoading ? 'Creando...' : 'Crear Activo'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalCrearActivo;


==================================================================
ARCHIVO: frontend\src\components\ModalCrearCarpeta.jsx
==================================================================
// frontend/src/componentes/ModalCrearCarpeta.jsx
import React, { useState } from 'react';
import { crearCarpeta } from '../services/documentService';
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; // <-- Importar

const ModalCrearCarpeta = ({ idCarpetaPadre, alCerrar, alExito }) => {
    const [nombreCarpeta, setNombreCarpeta] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleSubmit = async (e) => {
        e.preventDefault(); setError(''); setIsLoading(true);
        try {
            await crearCarpeta(nombreCarpeta, idCarpetaPadre);
            Swal.fire({ title: '¡Éxito!', text: 'Carpeta creada exitosamente.', icon: 'success', timer: 2000, showConfirmButton: false });
            alExito(); 
        } catch (err) { setError(err.message); } finally { setIsLoading(false); }
    };
    return (
        <div className="modal-overlay" onClick={alCerrar}><div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header"><h2>Crear Nueva Carpeta</h2><button onClick={alCerrar} className="modal-close-button">&times;</button></div>
            <form onSubmit={handleSubmit}>
                <div className="modal-body">
                    <div className="form-group"><label htmlFor="nombreCarpeta">Nombre de la Carpeta *</label><input type="text" id="nombreCarpeta" name="nombreCarpeta" value={nombreCarpeta} onChange={(e) => setNombreCarpeta(e.target.value)} autoFocus required /></div>
                    {error && <p className="modal-error">{error}</p>}
                </div>
                <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button><button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Creando...' : 'Crear Carpeta'}</button></div>
            </form>
        </div></div>
    );
};
export default ModalCrearCarpeta;


==================================================================
ARCHIVO: frontend\src\components\ModalCrearCronograma.jsx
==================================================================
// frontend/src/componentes/ModalCrearCronograma.jsx

import React, { useState } from 'react';
import { crearCronograma } from '../services/scheduleService';
import '../style/Modal.css';
import '../index.css';
import Swal from 'sweetalert2'; // <-- 1. Importar

const ModalCrearCronograma = ({ alCerrar, alExito }) => {
    const [formData, setFormData] = useState({
        nombreCronograma: '',
        anioAplicacion: new Date().getFullYear(),
        descripcion: ''
    });
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(''); // (Lo mantenemos para errores en línea)

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({ ...prevState, [name]: value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setIsLoading(true);
        try {
            await crearCronograma(formData);
            
            // --- 2. REEMPLAZAR 'alert()' ---
            Swal.fire({
                title: '¡Éxito!',
                text: 'Cronograma creado exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            alExito(); 
        } catch (err) {
            setError(err.message); // Muestra el error en el modal
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Crear Nuevo Cronograma</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        {/* (Inputs del formulario sin cambios) */}
                        <div className="form-group"><label htmlFor="nombreCronograma">Nombre del Cronograma *</label><input type="text" id="nombreCronograma" name="nombreCronograma" value={formData.nombreCronograma} onChange={handleChange} placeholder="Ej: Plan Anual SST 2025" required /></div>
                        <div className="form-group"><label htmlFor="anioAplicacion">Año de Aplicación (Opcional)</label><input type="number" id="anioAplicacion" name="anioAplicacion" value={formData.anioAplicacion} onChange={handleChange} placeholder="Ej: 2025" /></div>
                        <div className="form-group"><label htmlFor="descripcion">Descripción (Opcional)</label><input type="text" id="descripcion" name="descripcion" value={formData.descripcion} onChange={handleChange} /></div>
                        {error && <p className="modal-error">{error}</p>}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Creando...' : 'Crear Cronograma'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalCrearCronograma;


==================================================================
ARCHIVO: frontend\src\components\ModalCrearFormulario.jsx
==================================================================
// frontend/src/components/ModalCrearFormulario.jsx

import React, { useState } from 'react';
import { crearNuevoFormulario } from '../services/inspectionService';
import '../style/Modal.css';
import '../index.css';
import Swal from 'sweetalert2';
import { BsPlusLg, BsTrash } from 'react-icons/bs';

const ModalCrearFormulario = ({ alCerrar, alExito }) => {
    const [formData, setFormData] = useState({
        idFormulario: '',
        nombreFormulario: '',
        descripcion: '',
        tipoActivoAsociado: '',
        categoria: 'General' // Nuevo campo
    });

    const [preguntas, setPreguntas] = useState([{ id: 1, texto: '' }]);
    const [isLoading, setIsLoading] = useState(false);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData({ ...formData, [name]: value });
    };

    const handlePreguntaChange = (id, texto) => {
        setPreguntas(preguntas.map(p => p.id === id ? { ...p, texto } : p));
    };
    const agregarPregunta = () => {
        const nuevoId = preguntas.length > 0 ? Math.max(...preguntas.map(p => p.id)) + 1 : 1;
        setPreguntas([...preguntas, { id: nuevoId, texto: '' }]);
    };
    const eliminarPregunta = (id) => {
        if (preguntas.length > 1) setPreguntas(preguntas.filter(p => p.id !== id));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (preguntas.some(p => !p.texto.trim())) {
            Swal.fire('Error', 'Todas las preguntas deben tener texto.', 'warning');
            return;
        }
        setIsLoading(true);
        try {
            const payload = {
                ...formData,
                preguntas: preguntas.map((p, index) => ({ texto: p.texto, orden: index + 1 }))
            };
            await crearNuevoFormulario(payload);
            Swal.fire({ icon: 'success', title: '¡Formulario Creado!', text: 'Ahora puedes crear activos de este nuevo tipo.' });
            alExito();
        } catch (err) {
            Swal.fire('Error', err.message, 'error');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Crear Nuevo Formulario</h2>
                    <button className="modal-close-button" onClick={alCerrar}>&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body" style={{maxHeight: '70vh', overflowY: 'auto'}}>
                        <div className="form-group">
                            <label>Código (Ej: FTO-SST-TRACTO)</label>
                            <input name="idFormulario" value={formData.idFormulario} onChange={handleChange} required placeholder="Debe ser único" />
                        </div>
                        <div className="form-group">
                            <label>Nombre del Formulario</label>
                            <input name="nombreFormulario" value={formData.nombreFormulario} onChange={handleChange} required />
                        </div>
                        
                        <div style={{display:'flex', gap:'1rem'}}>
                            <div className="form-group" style={{flex:1}}>
                                <label>Tipo de Activo (Ej: Tractomula)</label>
                                <input name="tipoActivoAsociado" value={formData.tipoActivoAsociado} onChange={handleChange} required placeholder="El nombre del nuevo tipo" />
                            </div>
                            <div className="form-group" style={{flex:1}}>
                                <label>Categoría del Comportamiento</label>
                                <select name="categoria" value={formData.categoria} onChange={handleChange} required>
                                    <option value="General">General (Muebles, Areas)</option>
                                    <option value="Vehiculo">Vehículo (Pide Placa, SOAT, KM)</option>
                                    <option value="Maquinaria">Maquinaria (Pide Serial, Modelo)</option>
                                </select>
                            </div>
                        </div>

                        <hr />
                        <h3>Preguntas del Checklist</h3>
                        {preguntas.map((p, index) => (
                            <div key={p.id} style={{ display: 'flex', gap: '10px', marginBottom: '10px' }}>
                                <span style={{fontWeight: 'bold', marginTop: '10px'}}>{index + 1}.</span>
                                <input type="text" value={p.texto} onChange={(e) => handlePreguntaChange(p.id, e.target.value)} placeholder="Escribe la pregunta..." style={{flex: 1}} required />
                                <button type="button" className="btn btn-danger" onClick={() => eliminarPregunta(p.id)}><BsTrash /></button>
                            </div>
                        ))}
                        <button type="button" className="btn btn-secondary" onClick={agregarPregunta}><BsPlusLg /> Agregar Pregunta</button>
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Guardando...' : 'Guardar'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalCrearFormulario;


==================================================================
ARCHIVO: frontend\src\components\ModalCrearMantenimiento.jsx
==================================================================
// frontend/src/components/ModalCrearMantenimiento.jsx
import React, { useState } from 'react';
import { crearMantenimiento } from '../services/pesvService';
import '../style/Modal.css';
import Swal from 'sweetalert2';

const ModalCrearMantenimiento = ({ vehiculos, alCerrar, alExito }) => {
    const [form, setForm] = useState({
        idActivo: '',
        tipo: 'Preventivo',
        fecha: new Date().toISOString().split('T')[0],
        kilometraje: '',
        descripcion: '',
        taller: '',
        costo: 0
    });

    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            await crearMantenimiento(form);
            Swal.fire('Registrado', 'Mantenimiento guardado exitosamente.', 'success');
            alExito();
        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                    <h3>Registrar Mantenimiento</h3>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body" style={{maxHeight:'60vh', overflowY:'auto'}}>
                        <div className="form-group">
                            <label>Vehículo</label>
                            <select className="form-control" required value={form.idActivo} onChange={e => setForm({...form, idActivo: e.target.value})}>
                                <option value="">-- Seleccione --</option>
                                {vehiculos.map(v => <option key={v.ID_Activo} value={v.ID_Activo}>{v.NombreDescriptivo} ({v.CodigoIdentificador})</option>)}
                            </select>
                        </div>
                        <div style={{display:'flex', gap:'1rem'}}>
                            <div className="form-group" style={{flex:1}}>
                                <label>Tipo</label>
                                <select className="form-control" value={form.tipo} onChange={e => setForm({...form, tipo: e.target.value})}>
                                    <option>Preventivo</option>
                                    <option>Correctivo</option>
                                </select>
                            </div>
                            <div className="form-group" style={{flex:1}}>
                                <label>Fecha</label>
                                <input type="date" className="form-control" required value={form.fecha} onChange={e => setForm({...form, fecha: e.target.value})} />
                            </div>
                        </div>
                        <div className="form-group">
                            <label>Kilometraje al momento</label>
                            <input type="number" className="form-control" required value={form.kilometraje} onChange={e => setForm({...form, kilometraje: e.target.value})} />
                        </div>
                        <div className="form-group">
                            <label>Descripción del trabajo</label>
                            <textarea className="form-control" rows="3" required value={form.descripcion} onChange={e => setForm({...form, descripcion: e.target.value})} />
                        </div>
                        <div style={{display:'flex', gap:'1rem'}}>
                            <div className="form-group" style={{flex:1}}>
                                <label>Taller / Proveedor</label>
                                <input type="text" className="form-control" value={form.taller} onChange={e => setForm({...form, taller: e.target.value})} />
                            </div>
                            <div className="form-group" style={{flex:1}}>
                                <label>Costo Total ($)</label>
                                <input type="number" className="form-control" value={form.costo} onChange={e => setForm({...form, costo: e.target.value})} />
                            </div>
                        </div>
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar}>Cancelar</button>
                        <button type="submit" className="btn btn-primary">Registrar</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalCrearMantenimiento;


==================================================================
ARCHIVO: frontend\src\components\ModalCrearUsuario.jsx
==================================================================
// frontend/src/componentes/ModalCrearUsuario.jsx

import React, { useState, useEffect } from 'react';
import { crearColaborador, getRoles } from '../services/userService'; // Importamos getRoles
import { useAuth } from '../context/AuthContext'; // Importamos el contexto
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; 

const ModalCrearUsuario = ({ alCerrar, alExito }) => {
    const { usuario } = useAuth(); // Datos del usuario logueado

    const [formData, setFormData] = useState({
        nombreCompleto: '', cedula: '', password: '',
        idRol: '', area: '', cargo: ''
    });
    const [rolesDisponibles, setRolesDisponibles] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    // Cargar roles al iniciar
    useEffect(() => {
        const cargarRoles = async () => {
            try {
                const rolesData = await getRoles();
                
                // Lógica de permisos:
                if (usuario.rol === 'Super Admin') {
                    // Super Admin ve todos los roles
                    setRolesDisponibles(rolesData);
                } else {
                    // Admin SST solo puede crear Colaboradores (Rol ID 2, o por nombre)
                    const rolColaborador = rolesData.filter(r => r.NombreRol === 'Colaborador');
                    setRolesDisponibles(rolColaborador);
                    
                    // Seleccionar automáticamente si solo hay una opción
                    if (rolColaborador.length > 0) {
                        setFormData(prev => ({ ...prev, idRol: rolColaborador[0].ID_Rol }));
                    }
                }
            } catch (err) {
                console.error("Error al cargar roles", err);
                setError("No se pudieron cargar los roles.");
            }
        };
        cargarRoles();
    }, [usuario]);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({ ...prevState, [name]: value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        
        if (!formData.idRol) {
            setError('El rol es obligatorio.');
            return;
        }

        setIsLoading(true);
        try {
            const payload = { ...formData, idRol: parseInt(formData.idRol) };
            await crearColaborador(payload);
            
            Swal.fire({
                title: '¡Éxito!',
                text: 'Usuario creado exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            alExito(); 
        } catch (err) {
            setError(err.message); 
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Crear Nuevo Usuario</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        <div className="form-group">
                            <label htmlFor="nombreCompleto">Nombre Completo *</label>
                            <input type="text" id="nombreCompleto" name="nombreCompleto" value={formData.nombreCompleto} onChange={handleChange} required />
                        </div>
                        <div className="form-group">
                            <label htmlFor="cedula">Cédula (Usuario) *</label>
                            <input type="text" id="cedula" name="cedula" value={formData.cedula} onChange={handleChange} required />
                        </div>
                        <div className="form-group">
                            <label htmlFor="password">Contraseña Temporal *</label>
                            <input type="password" id="password" name="password" value={formData.password} onChange={handleChange} required />
                        </div>
                        
                        {/* Selector de Rol Dinámico */}
                        <div className="form-group">
                            <label htmlFor="idRol">Rol del Usuario *</label>
                            <select id="idRol" name="idRol" value={formData.idRol} onChange={handleChange} required>
                                <option value="">-- Seleccione un Rol --</option>
                                {rolesDisponibles.map(rol => (
                                    <option key={rol.ID_Rol} value={rol.ID_Rol}>{rol.NombreRol}</option>
                                ))}
                            </select>
                        </div>

                        <div className="form-group">
                            <label htmlFor="area">Área / Departamento (Opcional)</label>
                            <input type="text" id="area" name="area" value={formData.area} onChange={handleChange} />
                        </div>
                        <div className="form-group">
                            <label htmlFor="cargo">Cargo (Opcional)</label>
                            <input type="text" id="cargo" name="cargo" value={formData.cargo} onChange={handleChange} />
                        </div>
                        {error && <p className="modal-error">{error}</p>}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Creando...' : 'Crear Usuario'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalCrearUsuario;


==================================================================
ARCHIVO: frontend\src\components\ModalDetalleActividad.jsx
==================================================================
// frontend/src/components/ModalDetalleActividad.jsx

import React from 'react';
import '../style/Modal.css'; //
import '../index.css';

const ModalDetalleActividad = ({ actividad, alCerrar }) => {
    if (!actividad) return null;

    // Helper para fechas
    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        // Ajuste simple para zona horaria local
        const fecha = new Date(fechaISO.split('T')[0] + 'T00:00:00');
        return fecha.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    };

    const getEstadoClass = (estado) => {
        if (estado === 'Realizada') return 'status-activo';
        if (estado === 'Pendiente') return 'status-pendiente';
        return 'status-inactivo';
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={e => e.stopPropagation()}>
                
                {/* --- Encabezado --- */}
                <div className="modal-header">
                    <h2>Detalle de Actividad</h2>
                    <button className="modal-close-button" onClick={alCerrar}>&times;</button>
                </div>
                
                {/* --- Cuerpo (Usando estructura similar a form-group para consistencia) --- */}
                <div className="modal-body">
                    
                    {/* Nombre */}
                    <div className="form-group">
                        <label>Nombre de la Actividad:</label>
                        <p style={{ fontSize: '1.1rem', margin: '0.2rem 0', color: '#212529' }}>
                            {actividad.NombreActividad}
                        </p>
                    </div>

                    {/* Estado y Responsable (En fila) */}
                    <div style={{ display: 'flex', gap: '1.5rem', marginBottom: '1rem' }}>
                        <div style={{ flex: 1 }}>
                            <label style={{ display: 'block', fontSize: '0.9rem', fontWeight: '600', color: '#6c757d', marginBottom: '0.5rem' }}>
                                Estado:
                            </label>
                            <span className={`status-pill ${getEstadoClass(actividad.EstadoActividad)}`}>
                                {actividad.EstadoActividad}
                            </span>
                        </div>
                        <div style={{ flex: 1 }}>
                            <label style={{ display: 'block', fontSize: '0.9rem', fontWeight: '600', color: '#6c757d', marginBottom: '0.5rem' }}>
                                Responsable:
                            </label>
                            <span style={{ fontSize: '1rem' }}>{actividad.Responsable || 'Sin asignar'}</span>
                        </div>
                    </div>

                    {/* Fechas (En fila) */}
                    <div style={{ display: 'flex', gap: '1.5rem', marginBottom: '1rem' }}>
                        <div style={{ flex: 1 }}>
                            <label style={{ display: 'block', fontSize: '0.9rem', fontWeight: '600', color: '#6c757d', marginBottom: '0.5rem' }}>
                                Fecha Límite:
                            </label>
                            <span>{formatearFecha(actividad.FechaLimite)}</span>
                        </div>
                        {actividad.FechaRealizacion && (
                            <div style={{ flex: 1 }}>
                                <label style={{ display: 'block', fontSize: '0.9rem', fontWeight: '600', color: '#6c757d', marginBottom: '0.5rem' }}>
                                    Fecha Realización:
                                </label>
                                <span>{formatearFecha(actividad.FechaRealizacion)}</span>
                            </div>
                        )}
                    </div>

                    {/* Descripción */}
                    <div className="form-group">
                        <label>Descripción:</label>
                        <div style={{ 
                            background: '#f8f9fa', 
                            padding: '0.8rem', 
                            borderRadius: '8px', 
                            border: '1px solid #dee2e6', 
                            fontSize: '0.95rem',
                            maxHeight: '120px', 
                            overflowY: 'auto' 
                        }}>
                            {actividad.DescripcionActividad || 'Sin descripción.'}
                        </div>
                    </div>

                    {/* Observaciones */}
                    <div className="form-group">
                        <label>Observaciones:</label>
                        <div style={{ 
                            background: '#f8f9fa', 
                            padding: '0.8rem', 
                            borderRadius: '8px', 
                            border: '1px solid #dee2e6',
                            fontSize: '0.95rem',
                            minHeight: '40px' 
                        }}>
                            {actividad.Observaciones || 'Ninguna observación registrada.'}
                        </div>
                    </div>
                </div>

                {/* --- Pie (Botones) --- */}
                <div className="modal-footer">
                    <button type="button" className="btn btn-primary" onClick={alCerrar}>
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalDetalleActividad;


==================================================================
ARCHIVO: frontend\src\components\ModalDiligenciarInspeccion.jsx
==================================================================
// frontend/src/componentes/ModalDiligenciarInspeccion.jsx

import React, { useState, useCallback, useEffect } from 'react';
import { crearInspeccion } from '../services/inspectionService';
import { getActivosPorTipo } from '../services/assetService'; 
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; 

// Importamos los formularios específicos (para los viejos)
import FormExtintores from './forms/FormExtintores'; 
import FormVehiculos from './forms/FormVehiculos';
import FormBotiquin from './forms/FormBotiquin';
import FormOrdenAseo from './forms/FormOrdenAseo';
import FormSeguridadGeneral from './forms/FormSeguridadGeneral';
import FormSustanciasQuimicas from './forms/FormSustanciasQuimicas';
import FormRiesgoElectrico from './forms/FormRiesgoElectrico';
// Importamos el Renderizador Genérico (para los NUEVOS)
import FormularioGenericoRenderer from './forms/FormularioGenericoRenderer';

const ModalDiligenciarInspeccion = ({ 
    idFormulario, 
    nombreFormulario, 
    tipoActivo, // <--- ESTE ES EL DATO CLAVE QUE VIENE DE LA BD
    datosFormulario, // (Estructura de preguntas si es dinámico)
    alCerrar, 
    alExito 
}) => {

    const [listaActivos, setListaActivos] = useState([]);
    const [isLoadingActivos, setIsLoadingActivos] = useState(false);
    const [idActivoSeleccionado, setIdActivoSeleccionado] = useState(null); 
    
    const [observacionesGenerales, setObservacionesGenerales] = useState('');
    const [datosDiligenciados, setDatosDiligenciados] = useState({}); 
    const [resultadoGeneral, setResultadoGeneral] = useState('OK');
    const [infoAdicionalActivo, setInfoAdicionalActivo] = useState('');
    // eslint-disable-next-line no-unused-vars
    const [otroActivoMencionado, setOtroActivoMencionado] = useState('');
    
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    // --- 1. CARGAR ACTIVOS (CORREGIDO) ---
    // Ahora confiamos plenamente en la prop 'tipoActivo'
    useEffect(() => {
        if (tipoActivo) {
            const cargarActivos = async () => {
                setIsLoadingActivos(true);
                try {
                    // Busca activos del tipo específico (ej: "Montacargas", "Vehiculo")
                    const data = await getActivosPorTipo(tipoActivo);
                    setListaActivos(data);
                } catch (err) { 
                    console.error("Error cargando activos:", err); 
                    // No mostramos error fatal, solo lista vacía
                } finally { 
                    setIsLoadingActivos(false); 
                }
            };
            cargarActivos();
        }
    }, [tipoActivo]); // Se ejecuta cuando cambia el tipo

    // --- 2. RENDERIZADO DEL FORMULARIO ---
    const renderContent = () => {
        // Si es uno de los formularios "viejos" (hardcoded), usamos su componente
        switch (idFormulario) {
            case 'FTO-SST-13': return <FormExtintores onFormChange={setDatosDiligenciados} onResultadoChange={setResultadoGeneral} />;
            case 'FTO-SST-02': return <FormVehiculos onFormChange={setDatosDiligenciados} onResultadoChange={setResultadoGeneral} />;
            case 'FTO-SST-14': return <FormBotiquin onFormChange={setDatosDiligenciados} onResultadoChange={setResultadoGeneral} />;
            case 'FTO-SST-23': return <FormOrdenAseo onFormChange={setDatosDiligenciados} onResultadoChange={setResultadoGeneral} />;
            case 'FTO-SST-45': return <FormSeguridadGeneral onFormChange={setDatosDiligenciados} onResultadoChange={setResultadoGeneral} />;
            case 'FTO-SST-95': return <FormSustanciasQuimicas onFormChange={setDatosDiligenciados} onResultadoChange={setResultadoGeneral} />;
            case 'FTO-SST-96': return <FormRiesgoElectrico onFormChange={setDatosDiligenciados} onResultadoChange={setResultadoGeneral} />;
            
            // Si no es ninguno de los anteriores, es un FORMULARIO NUEVO DINÁMICO
            default: 
                // Aquí deberíamos pasar las preguntas. 
                // NOTA: Si 'datosFormulario' no tiene preguntas, el renderer mostrará "Cargando..."
                // Para la versión actual, asumimos que si es nuevo, usas el generador.
                // Pero ojo: necesitamos obtener las preguntas de la BD si no las tenemos.
                // (Por simplicidad en esta fase, mostraremos un mensaje si no hay preguntas cargadas, 
                //  o usaremos el renderer si ya tenemos la lógica de carga en el padre).
                
                /* IMPORTANTE: Si creaste el formulario con preguntas en la BD, 
                   necesitamos un endpoint para traer esas preguntas aquí.
                   Si ves el formulario vacío, es porque falta ese paso de "Traer Preguntas".
                */
               
               // Fallback temporal para formularios nuevos sin preguntas cargadas en el frontend
               if (!datosFormulario || !datosFormulario.preguntas) {
                   return <div style={{padding: '2rem', textAlign: 'center'}}>
                       <p>Este es un formulario dinámico.</p>
                       <p>(La carga automática de preguntas dinámicas requiere el endpoint GET /preguntas/:id)</p>
                       {/* Aquí podríamos inyectar el FormularioGenerico si tuviéramos las preguntas */}
                   </div>;
               }

                return (
                    <FormularioGenericoRenderer 
                        preguntas={datosFormulario.preguntas} 
                        onFormChange={setDatosDiligenciados}
                        onResultadoChange={setResultadoGeneral}
                    />
                );
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        
        // Validación básica
        if (!datosDiligenciados.checklist || Object.keys(datosDiligenciados.checklist).length === 0) {
            setError('Por favor, diligencie el checklist.');
            return;
        }

        setIsLoading(true);
        try {
            const datosJSONCompletos = {
                ...datosDiligenciados, 
                infoAdicionalActivo: infoAdicionalActivo,
                otroActivoMencionado: otroActivoMencionado
            };
            const payload = {
                idFormulario,
                idActivoInspeccionado: idActivoSeleccionado ? Number(idActivoSeleccionado) : null,
                datosDiligenciados: datosJSONCompletos, 
                observacionesGenerales,
                resultadoGeneral
            };
            await crearInspeccion(payload); 
            
            Swal.fire({ title: '¡Éxito!', text: 'Inspección guardada.', icon: 'success', timer: 2000, showConfirmButton: false });
            alExito(); 
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    // eslint-disable-next-line no-unused-vars
    const handleFormChange = useCallback((data) => { setDatosDiligenciados(data); }, []);
    // eslint-disable-next-line no-unused-vars
    const handleResultadoChange = useCallback((resultado) => { setResultadoGeneral(resultado); }, []);

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Diligenciar: {nombreFormulario}</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                        
                        {/* SELECTOR DE ACTIVO (DINÁMICO) */}
                        <div className="form-group">
                            <label htmlFor="activo-select">
                                Seleccione el Activo ({tipoActivo || 'General'})
                            </label>
                            
                            {isLoadingActivos ? (
                                <p>Cargando activos...</p>
                            ) : (
                                <select 
                                    id="activo-select" 
                                    value={idActivoSeleccionado || ''} 
                                    onChange={(e) => setIdActivoSeleccionado(e.target.value || null)}
                                >
                                    <option value="">-- Opcional (Inspección General) --</option>
                                    
                                    {listaActivos.length > 0 ? (
                                        listaActivos.map(activo => (
                                            <option key={activo.ID_Activo} value={activo.ID_Activo}>
                                                {activo.NombreDescriptivo} ({activo.CodigoIdentificador})
                                            </option>
                                        ))
                                    ) : (
                                        <option disabled>No hay activos de tipo "{tipoActivo}" registrados</option>
                                    )}
                                </select>
                            )}
                        </div>

                        <div className="form-group"><label>Información Adicional (Opcional)</label><input type="text" value={infoAdicionalActivo} onChange={(e) => setInfoAdicionalActivo(e.target.value)} placeholder="Ej: Serial XT-123..." /></div>
                        
                        <hr />
                        
                        {/* Renderizado del Formulario */}
                        {renderContent()}

                        <hr style={{ margin: '1.5rem 0' }} />
                        <div className="form-group"><label>Observaciones Generales</label><textarea rows="2" value={observacionesGenerales} onChange={(e) => setObservacionesGenerales(e.target.value)} /></div>
                        {error && <p className="modal-error">{error}</p>}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Guardando...' : 'Finalizar y Guardar Inspección'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalDiligenciarInspeccion;


==================================================================
ARCHIVO: frontend\src\components\ModalEditarActividad.jsx
==================================================================
// frontend/src/componentes/ModalEditarActividad.jsx

import React, { useState, useEffect } from 'react';
import { editarActividad } from '../services/scheduleService';
import { getTodosUsuarios } from '../services/userService'; 
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; // <-- 1. Importar

const ModalEditarActividad = ({ actividad, alCerrar, alExito }) => {
    const formatInputDate = (fechaISO) => {
        if (!fechaISO) return '';
        return new Date(fechaISO).toISOString().split('T')[0];
    };
    const [formData, setFormData] = useState({
        nombreActividad: '',
        idUsuarioResponsable: '',
        fechaLimite: '',
        descripcionActividad: '' 
    });
    const [listaUsuarios, setListaUsuarios] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    useEffect(() => {
        const cargarUsuarios = async () => {
            try {
                const data = await getTodosUsuarios();
                setListaUsuarios(data);
            } catch (err) {
                console.error("Error cargando usuarios:", err);
                setError("No se pudo cargar la lista de responsables");
            }
        };
        if (actividad) {
            setFormData({
                nombreActividad: actividad.NombreActividad || '',
                idUsuarioResponsable: actividad.ID_UsuarioResponsable || '',
                fechaLimite: formatInputDate(actividad.FechaLimite),
                descripcionActividad: actividad.DescripcionActividad || ''
            });
        }
        cargarUsuarios();
    }, [actividad]); 

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({ ...prevState, [name]: value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setIsLoading(true);
        try {
            const payload = { ...formData, idUsuarioResponsable: parseInt(formData.idUsuarioResponsable) };
            await editarActividad(actividad.ID_Actividad, payload);
            
            // --- 2. REEMPLAZAR 'alert()' ---
            Swal.fire({
                title: '¡Éxito!',
                text: 'Actividad actualizada exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            alExito(); 
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Editar Actividad</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        {/* (Inputs del formulario sin cambios) */}
                        <div className="form-group"><label htmlFor="nombreActividad">Nombre de la Actividad *</label><input type="text" id="nombreActividad" name="nombreActividad" value={formData.nombreActividad} onChange={handleChange} required /></div>
                        <div className="form-group"><label htmlFor="idUsuarioResponsable">Responsable *</label><select id="idUsuarioResponsable" name="idUsuarioResponsable" value={formData.idUsuarioResponsable} onChange={handleChange} required><option value="">-- Seleccione un responsable --</option>{listaUsuarios.map(user => (<option key={user.ID_Usuario} value={user.ID_Usuario}>{user.NombreCompleto}</option>))}</select></div>
                        <div className="form-group"><label htmlFor="fechaLimite">Fecha Límite *</label><input type="date" id="fechaLimite" name="fechaLimite" value={formData.fechaLimite} onChange={handleChange} min={new Date().toISOString().split('T')[0]} required /></div>
                        <div className="form-group"><label htmlFor="descripcionActividad">Descripción (Opcional)</label><input type="text" id="descripcionActividad" name="descripcionActividad" value={formData.descripcionActividad} onChange={handleChange} /></div>
                        {error && <p className="modal-error">{error}</p>}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Guardando...' : 'Guardar Cambios'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalEditarActividad;


==================================================================
ARCHIVO: frontend\src\components\ModalEditarActivo.jsx
==================================================================
// frontend/src/components/ModalEditarActivo.jsx

import React, { useState, useEffect } from 'react';
import { actualizarActivo, getTiposActivosDisponibles } from '../services/assetService';
import { getColaboradores } from '../services/userService';
import '../style/Modal.css';
import '../index.css';
import Swal from 'sweetalert2';

const ModalEditarActivo = ({ activo, alCerrar, alExito }) => {
    
    const formatInputDate = (isoString) => {
        if (!isoString) return '';
        return isoString.split('T')[0];
    };

    const [formData, setFormData] = useState({
        tipoActivo: '',
        codigoIdentificador: '',
        nombreDescriptivo: '',
        ubicacion: '',
        marca: '',
        modelo: '',
        idConductor: '',
        soatVencimiento: '',
        tecnoVencimiento: ''
    });

    const [listaTipos, setListaTipos] = useState([]);
    const [listaConductores, setListaConductores] = useState([]);
    const [isLoading, setIsLoading] = useState(false);

    const TIPOS_VEHICULO = ['Vehiculo', 'Moto', 'Montacarga'];

    useEffect(() => {
        const cargarDatos = async () => {
            try {
                const [tipos, users] = await Promise.all([
                    getTiposActivosDisponibles(),
                    getColaboradores()
                ]);
                setListaTipos(tipos);
                setListaConductores(users);

                if (activo) {
                    setFormData({
                        tipoActivo: activo.TipoActivo,
                        codigoIdentificador: activo.CodigoIdentificador,
                        nombreDescriptivo: activo.NombreDescriptivo,
                        ubicacion: activo.Ubicacion || '',
                        marca: activo.Marca || '',
                        modelo: activo.Modelo || '',
                        idConductor: buscarIdConductor(users, activo.NombreConductor),
                        soatVencimiento: formatInputDate(activo.SOAT_Vencimiento),
                        tecnoVencimiento: formatInputDate(activo.Tecno_Vencimiento)
                    });
                }
            } catch (err) {
                console.error(err);
            }
        };
        cargarDatos();
    }, [activo]);

    const buscarIdConductor = (users, nombre) => {
        if (!nombre) return '';
        const user = users.find(u => u.NombreCompleto === nombre);
        return user ? user.ID_Usuario : '';
    };

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({ ...prevState, [name]: value }));
    };

    const esVehiculo = () => TIPOS_VEHICULO.includes(formData.tipoActivo);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        try {
            await actualizarActivo(activo.ID_Activo, formData);
            Swal.fire('Actualizado', 'Activo actualizado correctamente.', 'success');
            alExito(); 
        } catch (err) {
            Swal.fire('Error', err.message, 'error');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Editar Activo</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <form onSubmit={handleSubmit}>
                    <div className="modal-body" style={{maxHeight:'70vh', overflowY:'auto'}}>
                        
                        <div className="form-group">
                            <label>Tipo de Activo</label>
                            <select name="tipoActivo" value={formData.tipoActivo} onChange={handleChange} required>
                                {listaTipos.map((t, i) => (
                                    // Manejo para si viene como objeto o string
                                    <option key={i} value={t.TipoActivoAsociado || t}>{t.TipoActivoAsociado || t}</option>
                                ))}
                            </select>
                        </div>

                        <div className="form-group">
                            <label>{esVehiculo() ? 'Placa *' : 'Código *'}</label>
                            <input type="text" name="codigoIdentificador" value={formData.codigoIdentificador} onChange={handleChange} required />
                        </div>

                        <div className="form-group">
                            <label>Nombre Descriptivo *</label>
                            <input type="text" name="nombreDescriptivo" value={formData.nombreDescriptivo} onChange={handleChange} required />
                        </div>

                        <div className="form-group">
                            <label>Ubicación</label>
                            <input type="text" name="ubicacion" value={formData.ubicacion} onChange={handleChange} />
                        </div>

                        {esVehiculo() && (
                            <div style={{backgroundColor: '#f8f9fa', padding: '1rem', borderRadius: '8px', border: '1px solid #dee2e6', marginTop: '1rem'}}>
                                <h4 style={{marginTop:0, color: 'var(--color-primario)', borderBottom: '1px solid #ddd'}}>Datos del Vehículo</h4>
                                
                                <div style={{display:'flex', gap:'10px'}}>
                                    <div className="form-group" style={{flex:1}}>
                                        <label>Marca</label>
                                        <input type="text" name="marca" value={formData.marca} onChange={handleChange} />
                                    </div>
                                    <div className="form-group" style={{flex:1}}>
                                        <label>Modelo</label>
                                        <input type="text" name="modelo" value={formData.modelo} onChange={handleChange} />
                                    </div>
                                </div>

                                <div className="form-group">
                                    <label>Conductor Asignado</label>
                                    <select name="idConductor" value={formData.idConductor} onChange={handleChange}>
                                        <option value="">-- Sin Asignar --</option>
                                        {listaConductores.map(u => (
                                            <option key={u.ID_Usuario} value={u.ID_Usuario}>{u.NombreCompleto}</option>
                                        ))}
                                    </select>
                                </div>

                                <div style={{display: 'flex', gap: '10px'}}>
                                    <div className="form-group" style={{flex: 1}}>
                                        <label>Vencimiento SOAT</label>
                                        <input type="date" name="soatVencimiento" value={formData.soatVencimiento} onChange={handleChange} />
                                    </div>
                                    <div className="form-group" style={{flex: 1}}>
                                        <label>Venc. Tecnomecánica</label>
                                        <input type="date" name="tecnoVencimiento" value={formData.tecnoVencimiento} onChange={handleChange} />
                                    </div>
                                </div>
                            </div>
                        )}

                    </div>

                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Guardando...' : 'Guardar Cambios'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalEditarActivo;


==================================================================
ARCHIVO: frontend\src\components\ModalEditarUsuario.jsx
==================================================================
// frontend/src/componentes/ModalEditarUsuario.jsx

import React, { useState, useEffect } from 'react';
import { editarColaborador } from '../services/userService';
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; // <-- 1. Importar

const ModalEditarUsuario = ({ usuario, alCerrar, alExito }) => {
    
    const [formData, setFormData] = useState({
        nombreCompleto: '',
        area: '',
        cargo: ''
    });
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    useEffect(() => {
        if (usuario) {
            setFormData({
                nombreCompleto: usuario.NombreCompleto || '',
                area: usuario.AreaDepartamento || '',
                cargo: usuario.Cargo || ''
            });
        }
    }, [usuario]);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({
            ...prevState,
            [name]: value
        }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setIsLoading(true);

        try {
            await editarColaborador(usuario.ID_Usuario, formData);
            
            // --- 2. REEMPLAZAR 'alert()' ---
            Swal.fire({
                title: '¡Éxito!',
                text: 'Usuario actualizado exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            alExito(); 
            
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Editar Usuario</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        <div className="form-group">
                            <label>Cédula (Usuario)</label>
                            <input type="text" value={usuario?.CedulaUsuario || ''} disabled />
                        </div>
                        <div className="form-group">
                            <label htmlFor="nombreCompleto">Nombre Completo *</label>
                            <input type="text" id="nombreCompleto" name="nombreCompleto" value={formData.nombreCompleto} onChange={handleChange} required />
                        </div>
                        <div className="form-group">
                            <label htmlFor="area">Área / Departamento (Opcional)</label>
                            <input type="text" id="area" name="area" value={formData.area} onChange={handleChange} />
                        </div>
                        <div className="form-group">
                            <label htmlFor="cargo">Cargo (Opcional)</label>
                            <input type="text" id="cargo" name="cargo" value={formData.cargo} onChange={handleChange} />
                        </div>
                        {error && <p className="modal-error">{error}</p>}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Guardando...' : 'Guardar Cambios'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalEditarUsuario;


==================================================================
ARCHIVO: frontend\src\components\ModalFirmarSolicitud.jsx
==================================================================
// frontend/src/components/ModalFirmarSolicitud.jsx

import React, { useState, useRef } from 'react';
import SignatureCanvas from 'react-signature-canvas';
import '../style/Modal.css';
import Swal from 'sweetalert2';

const ModalFirmarSolicitud = ({ solicitud, alCerrar, alExito }) => {
    const [comentario, setComentario] = useState('Aprobado y firmado.');
    const [modoFirma, setModoFirma] = useState('dibujar'); // 'dibujar' o 'subir'
    const [imagenSubida, setImagenSubida] = useState(null);
    const [isProcessing, setIsProcessing] = useState(false);
    
    const sigCanvas = useRef({});

    const limpiarFirma = () => sigCanvas.current.clear();

    const handleFileChange = (e) => {
        if (e.target.files[0]) {
            setImagenSubida(e.target.files[0]);
        }
    };

    const handleAprobar = async () => {
        setIsProcessing(true);
        
        // 1. Preparar la imagen de la firma
        let firmaBlob = null;

        try {
            if (modoFirma === 'dibujar') {
                if (sigCanvas.current.isEmpty()) {
                    Swal.fire('Error', 'Por favor dibuje su firma.', 'warning');
                    setIsProcessing(false);
                    return;
                }
                
                // --- CORRECCIÓN AQUÍ ---
                // Eliminamos .getTrimmedCanvas() porque causa conflicto con Vite/Webpack
                // Usamos .toDataURL() directo que funciona perfecto.
                const dataURL = sigCanvas.current.toDataURL('image/png');
                
                const res = await fetch(dataURL);
                firmaBlob = await res.blob();

            } else {
                if (!imagenSubida) {
                    Swal.fire('Error', 'Por favor suba una imagen de su firma.', 'warning');
                    setIsProcessing(false);
                    return;
                }
                firmaBlob = imagenSubida;
            }

            // 2. Enviar al Backend
            const formData = new FormData();
            formData.append('idSolicitud', solicitud.ID_Solicitud);
            formData.append('estado', 'Aprobado');
            formData.append('comentario', comentario);
            formData.append('rutaDocumentoOriginal', solicitud.RutaDocumento); 
            formData.append('firma', firmaBlob, 'firma_admin.png'); 

            const token = localStorage.getItem('token');
            const response = await fetch('http://localhost:5000/api/solicitudes/responder', {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            if (response.ok) {
                Swal.fire('¡Éxito!', 'Documento firmado y solicitud aprobada.', 'success');
                alExito(); 
            } else {
                throw new Error('Error en el servidor al firmar');
            }
        } catch (error) {
            console.error(error);
            Swal.fire('Error', error.message || 'No se pudo procesar la firma', 'error');
        } finally {
            setIsProcessing(false);
        }
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '500px'}}>
                <div className="modal-header">
                    <h3>Firmar Documento</h3>
                    <button className="modal-close-button" onClick={alCerrar}>&times;</button>
                </div>
                <div className="modal-body">
                    <p style={{color:'#666'}}>Estás aprobando la solicitud de: <strong>{solicitud.Solicitante}</strong></p>
                    
                    <div className="form-group">
                        <label>Comentario de Aprobación</label>
                        <input className="form-control" value={comentario} onChange={e => setComentario(e.target.value)} />
                    </div>

                    <div style={{marginBottom:'10px', display:'flex', gap:'10px'}}>
                        <button className={`btn btn-sm ${modoFirma==='dibujar'?'btn-primary':'btn-secondary'}`} onClick={() => setModoFirma('dibujar')}>Dibujar</button>
                        <button className={`btn btn-sm ${modoFirma==='subir'?'btn-primary':'btn-secondary'}`} onClick={() => setModoFirma('subir')}>Subir Imagen</button>
                    </div>

                    {modoFirma === 'dibujar' ? (
                        <div style={{border: '2px dashed #ccc', borderRadius:'8px', backgroundColor:'#fff'}}>
                            <SignatureCanvas 
                                penColor="black"
                                canvasProps={{width: 460, height: 200, className: 'sigCanvas'}}
                                ref={sigCanvas}
                            />
                            <button onClick={limpiarFirma} style={{fontSize:'0.8rem', margin:'5px', color:'red', background:'none', border:'none', cursor:'pointer'}}>Borrar firma</button>
                        </div>
                    ) : (
                        <div className="form-group">
                            <label>Subir imagen de firma (PNG/JPG)</label>
                            <input type="file" className="form-control" onChange={handleFileChange} accept="image/*" />
                        </div>
                    )}
                </div>
                <div className="modal-footer">
                    <button className="btn btn-secondary" onClick={alCerrar} disabled={isProcessing}>Cancelar</button>
                    <button className="btn btn-primary" onClick={handleAprobar} disabled={isProcessing}>
                        {isProcessing ? 'Firmando...' : 'Estampar Firma y Aprobar'}
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalFirmarSolicitud;


==================================================================
ARCHIVO: frontend\src\components\ModalGenerarDocumento.jsx
==================================================================
// frontend/src/components/ModalGenerarDocumento.jsx

import React, { useState, useEffect } from 'react';
import { apiFetch } from '../services/apiService';
import '../style/Modal.css';
import Swal from 'sweetalert2';
import { BsCheckCircle, BsDownload, BsEye, BsXCircle, BsFileText } from 'react-icons/bs';

const ModalGenerarDocumento = ({ paso, alCerrar, alExito }) => {
    const [plantilla, setPlantilla] = useState(null); // Aquí guardamos la estructura
    const [respuestas, setRespuestas] = useState({}); // Aquí lo que escribe el usuario
    const [isLoading, setIsLoading] = useState(true);
    const [isGenerating, setIsGenerating] = useState(false);
    const [pdfGenerado, setPdfGenerado] = useState(null); 

    const API_URL = 'http://localhost:5000'; 

    // 1. AL ABRIR, CARGAMOS LA PLANTILLA DE LA BD
    useEffect(() => {
        const cargarPlantilla = async () => {
            try {
                const data = await apiFetch(`/pesv/plantilla/${paso.ID_Paso}`);
                if (data.existe) {
                    setPlantilla(data);
                } else {
                    setPlantilla(null); // No hay plantilla para este paso
                }
            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'No se pudo cargar la plantilla', 'error');
            } finally {
                setIsLoading(false);
            }
        };
        cargarPlantilla();
    }, [paso]);

    const handleChange = (label, valor) => {
        setRespuestas({ ...respuestas, [label]: valor });
    };

    const handleGenerar = async (e) => {
        e.preventDefault();
        setIsGenerating(true);
        try {
            const response = await apiFetch('/pesv/pasos/generar', {
                method: 'POST',
                body: JSON.stringify({
                    idPaso: paso.ID_Paso,
                    datosFormulario: respuestas // Enviamos el objeto dinámico { "Nombre": "Juan", ... }
                })
            });
            
            setPdfGenerado(`${API_URL}/${response.ruta}`);
            
            Swal.fire({
                icon: 'success',
                title: '¡Generado!',
                text: 'Documento creado y firmado digitalmente.',
                timer: 1500,
                showConfirmButton: false
            });
            
            if (alExito) alExito(); 

        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        } finally {
            setIsGenerating(false);
        }
    };

    // --- RENDERIZADO DINÁMICO ---
    const renderFormulario = () => {
        if (isLoading) return <p>Cargando estructura...</p>;
        
        if (!plantilla) {
            return (
                <div style={{textAlign:'center', padding:'2rem', color:'#666', backgroundColor:'#f8f9fa', borderRadius:'8px'}}>
                    <BsFileText style={{fontSize:'2rem', marginBottom:'10px', opacity:0.5}}/>
                    <p>Este paso aún no tiene una plantilla automática configurada.</p>
                    <p style={{fontSize:'0.85rem'}}>Por favor, use el botón "Gestionar" para subir el archivo manualmente.</p>
                </div>
            );
        }

        return (
            <form onSubmit={handleGenerar}>
                <div className="form-header-box">
                    <BsFileText />
                    <div>
                        <strong>{plantilla.config.TituloDocumento}</strong>
                        <p style={{margin:0, fontSize:'0.8rem'}}>{plantilla.config.CuerpoInicial.substring(0, 60)}...</p>
                    </div>
                </div>

                {/* DIBUJAR INPUTS SEGÚN LA BD */}
                {plantilla.campos.map((campo) => (
                    <div key={campo.ID_Campo} className="form-group">
                        <label>{campo.Etiqueta}</label>
                        {campo.TipoInput === 'parrafo' ? (
                            <textarea 
                                className="form-control" 
                                rows="3" 
                                required 
                                onChange={(e) => handleChange(campo.Etiqueta, e.target.value)}
                            />
                        ) : (
                            <input 
                                type={campo.TipoInput === 'fecha' ? 'date' : 'text'} 
                                className="form-control" 
                                required 
                                onChange={(e) => handleChange(campo.Etiqueta, e.target.value)}
                            />
                        )}
                    </div>
                ))}

                <div className="modal-footer">
                    <button type="button" className="btn btn-secondary" onClick={alCerrar}>Cancelar</button>
                    <button type="submit" className="btn btn-magic" disabled={isGenerating}>
                        {isGenerating ? 'Generando...' : 'Crear Documento'}
                    </button>
                </div>
            </form>
        );
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" style={{maxWidth: '650px'}} onClick={e => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h3>{pdfGenerado ? 'Documento Listo' : `Paso ${paso.NumeroPaso}: Generar Documento`}</h3>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                
                {!pdfGenerado ? (
                    <div className="modal-body">
                        {renderFormulario()}
                    </div>
                ) : (
                    // VISTA DE ÉXITO
                    <div className="modal-body" style={{textAlign:'center', padding:'2rem'}}>
                        <BsCheckCircle style={{fontSize:'4rem', color:'#28a745', marginBottom:'1rem'}} />
                        <h3 style={{color:'#005A5B'}}>¡Documento Generado!</h3>
                        <p style={{color:'#666', marginBottom:'2rem'}}>Se ha guardado en el historial del paso.</p>
                        
                        <div style={{display:'flex', gap:'15px', justifyContent:'center'}}>
                            <a href={pdfGenerado} target="_blank" rel="noopener noreferrer" className="btn btn-view" style={{textDecoration:'none'}}>
                                <BsEye /> Ver Online
                            </a>
                            <a href={`${API_URL}/api/pesv/download/${pdfGenerado.split('/').pop()}`} className="btn btn-download" style={{textDecoration:'none'}}>
                                <BsDownload /> Descargar
                            </a>
                        </div>
                        
                        <button className="btn btn-link" onClick={alCerrar} style={{marginTop:'2rem'}}>Cerrar</button>
                    </div>
                )}
            </div>
        </div>
    );
};

export default ModalGenerarDocumento;


==================================================================
ARCHIVO: frontend\src\components\ModalGestionarACPM.jsx
==================================================================
// frontend/src/componentes/ModalGestionarACPM.jsx
import React, { useState } from 'react';
import { gestionarACPM } from '../services/acpmService';
import '../style/Modal.css';
import '../index.css';
import '../style/InspeccionesPage.css'; 
import Swal from 'sweetalert2'; // <-- Importar

const ModalGestionarACPM = ({ acpm, alCerrar, alExito }) => {
    const [estadoACPM, setEstadoACPM] = useState(acpm.EstadoACPM);
    const [comentariosSeguimiento, setComentariosSeguimiento] = useState(''); 
    const [evidenciaCierre, setEvidenciaCierre] = useState(null); 
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');
    const handleFileChange = (e) => { setEvidenciaCierre(e.target.files[0]); };
    const handleSubmit = async (e) => {
        e.preventDefault(); setError('');
        if (estadoACPM === 'Cerrada' && !evidenciaCierre) {
            setError('Se requiere un archivo de evidencia para cerrar la acción.');
            return;
        }
        setIsLoading(true);
        const formData = new FormData();
        formData.append('estadoACPM', estadoACPM);
        formData.append('comentariosSeguimiento', comentariosSeguimiento);
        if (evidenciaCierre) { formData.append('evidenciaCierre', evidenciaCierre); }
        try {
            await gestionarACPM(acpm.ID_ACPM, formData);
            Swal.fire({ title: '¡Éxito!', text: 'Acción ACPM gestionada exitosamente.', icon: 'success', timer: 2000, showConfirmButton: false });
            alExito(); 
        } catch (err) { setError(err.message); } finally { setIsLoading(false); }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}><div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header"><h2>Gestionar Acción ACPM (ID: {acpm.ID_ACPM})</h2><button onClick={alCerrar} className="modal-close-button">&times;</button></div>
            <form onSubmit={handleSubmit}>
                <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                    <div className="detail-section"><strong>Descripción del Problema:</strong><p className="detail-box">{acpm.DescripcionProblema}</p></div>
                    {acpm.ComentariosSeguimiento && ( <div className="detail-section"><strong>Historial de Seguimiento:</strong><pre className="detail-box" style={{ fontFamily: 'inherit', fontSize: '0.9rem' }}>{acpm.ComentariosSeguimiento}</pre></div> )}
                    <div className="form-group"><label htmlFor="estadoACPM">Cambiar Estado *</label><select id="estadoACPM" name="estadoACPM" value={estadoACPM} onChange={(e) => setEstadoACPM(e.target.value)} required><option value="Abierta">Abierta</option><option value="En Proceso">En Proceso</option><option value="Cerrada">Cerrada</option></select></div>
                    <div className="form-group"><label htmlFor="comentariosSeguimiento">Añadir Nuevo Comentario de Seguimiento</label><textarea id="comentariosSeguimiento" name="comentariosSeguimiento" value={comentariosSeguimiento} onChange={(e) => setComentariosSeguimiento(e.target.value)} rows="3" placeholder="Añada aquí el nuevo seguimiento..." /></div>
                    <div className="form-group"><label htmlFor="evidenciaCierre">Adjuntar Evidencia (Cierre o Seguimiento)</label><input type="file" id="evidenciaCierre" name="evidenciaCierre" onChange={handleFileChange} accept=".jpg,.jpeg,.png,.pdf" />{estadoACPM === 'Cerrada' && !evidenciaCierre && (<small style={{ color: '#D32F2F', fontWeight: 'bold' }}>¡Obligatorio para cerrar!</small>)}</div>
                    {error && <p className="modal-error">{error}</p>}
                </div>
                <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button><button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Guardando...' : 'Guardar Gestión'}</button></div>
            </form>
        </div></div>
    );
};
export default ModalGestionarACPM;


==================================================================
ARCHIVO: frontend\src\components\ModalGestionarActividad.jsx
==================================================================
// frontend/src/componentes/ModalGestionarActividad.jsx

import React, { useState } from 'react';
import { gestionarActividad } from '../services/scheduleService';
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; // <-- 1. Importar

const ModalGestionarActividad = ({ actividad, alCerrar, alExito }) => {
    const [estado, setEstado] = useState(actividad.EstadoActividad);
    const [observaciones, setObservaciones] = useState(actividad.Observaciones || '');
    const [evidenciaFile, setEvidenciaFile] = useState(null);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleFileChange = (e) => {
        setEvidenciaFile(e.target.files[0]);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');

        if (estado === 'Realizada' && !evidenciaFile) {
            setError('Para marcar como "Realizada", debe adjuntar un nuevo archivo de evidencia.');
            return;
        }

        setIsLoading(true);
        const formData = new FormData();
        formData.append('estado', estado);
        formData.append('observaciones', observaciones);
        if (evidenciaFile) {
            formData.append('evidenciaFile', evidenciaFile); 
        }

        try {
            await gestionarActividad(actividad.ID_Actividad, formData);
            
            // --- 2. REEMPLAZAR 'alert()' ---
            Swal.fire({
                title: '¡Éxito!',
                text: 'Actividad gestionada exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            alExito(); 
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Gestionar Actividad</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        <h4>{actividad.NombreActividad}</h4>
                        {/* (Inputs del formulario sin cambios) */}
                        <div className="form-group"><label htmlFor="estado">Cambiar Estado *</label><select id="estado" name="estado" value={estado} onChange={(e) => setEstado(e.target.value)} required><option value="Pendiente">Pendiente</option><option value="Realizada">Realizada</option><option value="Cancelada">Cancelada</option></select></div>
                        <div className="form-group"><label htmlFor="observaciones">Observaciones / Motivo</label><textarea id="observaciones" name="observaciones" value={observaciones} onChange={(e) => setObservaciones(e.target.value)} rows="3" placeholder={estado === 'Cancelada' ? 'Especifique el motivo de la cancelación' : 'Añada observaciones...'} /></div>
                        <div className="form-group"><label htmlFor="evidenciaFile">Adjuntar Evidencia (.jpg, .png, .pdf)</label><input type="file" id="evidenciaFile" name="evidenciaFile" onChange={handleFileChange} accept=".jpg,.jpeg,.png,.pdf" />{estado === 'Realizada' && !evidenciaFile && (<small style={{ color: '#f57f17' }}>Se requiere evidencia para marcar como "Realizada".</small>)}</div>
                        {error && <p className="modal-error">{error}</p>}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Guardando...' : 'Guardar Gestión'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalGestionarActividad;


==================================================================
ARCHIVO: frontend\src\components\ModalGestionConductor.jsx
==================================================================
// frontend/src/components/ModalGestionConductor.jsx

import React, { useState, useEffect } from 'react';
import '../style/Modal.css';
import Swal from 'sweetalert2';
import { BsUpload, BsFileEarmarkPerson } from 'react-icons/bs';

const ModalGestionConductor = ({ conductor, alCerrar, alExito }) => {
    const [form, setForm] = useState({
        numeroLicencia: '',
        categoria: '',
        vencimiento: ''
    });
    const [archivo, setArchivo] = useState(null);
    const [isLoading, setIsLoading] = useState(false);

    // Cargar datos existentes al abrir
    useEffect(() => {
        if (conductor) {
            setForm({
                numeroLicencia: conductor.NumeroLicencia || '',
                categoria: conductor.Categoria || '',
                vencimiento: conductor.VencimientoLicencia ? conductor.VencimientoLicencia.split('T')[0] : ''
            });
        }
    }, [conductor]);

    const handleFileChange = (e) => {
        setArchivo(e.target.files[0]);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);

        // Usamos FormData para enviar archivo + texto
        const formData = new FormData();
        formData.append('idUsuario', conductor.ID_Usuario);
        formData.append('numeroLicencia', form.numeroLicencia);
        formData.append('categoria', form.categoria);
        formData.append('vencimiento', form.vencimiento);
        
        if (archivo) {
            formData.append('archivoLicencia', archivo);
        }

        try {
            const token = localStorage.getItem('token');
            // Hacemos fetch directo porque apiService suele estar configurado para JSON
            const response = await fetch('http://localhost:5000/api/pesv/conductores', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            const data = await response.json();

            if (!response.ok) throw new Error(data.msg || 'Error al guardar');

            Swal.fire('Actualizado', 'Información del conductor guardada correctamente.', 'success');
            alExito(); // Refrescar tabla padre
        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={e => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h3>Gestionar Conductor</h3>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        
                        <div style={{marginBottom:'1.5rem', padding:'10px', backgroundColor:'#f0f7ff', borderRadius:'8px', display:'flex', alignItems:'center', gap:'10px'}}>
                            <div className="user-avatar" style={{width:'40px', height:'40px', fontSize:'1.2rem'}}>
                                {conductor.NombreCompleto.charAt(0)}
                            </div>
                            <div>
                                <strong>{conductor.NombreCompleto}</strong>
                                <div style={{fontSize:'0.85rem', color:'#666'}}>C.C. {conductor.CedulaUsuario}</div>
                            </div>
                        </div>

                        <div className="form-group">
                            <label>N° Licencia de Conducción *</label>
                            <input type="text" className="form-control" required 
                                value={form.numeroLicencia} onChange={e => setForm({...form, numeroLicencia: e.target.value})} 
                                placeholder="Ej: 1234567890"
                            />
                        </div>
                        
                        <div className="form-group">
                            <label>Categoría (Ej: C1, B2) *</label>
                            <input type="text" className="form-control" required 
                                value={form.categoria} onChange={e => setForm({...form, categoria: e.target.value})} 
                            />
                        </div>
                        
                        <div className="form-group">
                            <label>Fecha Vencimiento Licencia *</label>
                            <input type="date" className="form-control" required 
                                value={form.vencimiento} onChange={e => setForm({...form, vencimiento: e.target.value})} 
                            />
                        </div>
                        
                        <div className="form-group" style={{marginTop: '1.5rem'}}>
                            <label>Adjuntar Copia Digital (Opcional)</label>
                            <div style={{display:'flex', gap:'10px', alignItems:'center', border:'2px dashed #ddd', padding:'1rem', borderRadius:'8px', backgroundColor:'#f9f9f9'}}>
                                <BsUpload style={{color:'#007BFF', fontSize:'1.5rem'}}/>
                                <div style={{flex:1}}>
                                    <input type="file" onChange={handleFileChange} accept=".pdf,image/*" style={{width:'100%'}} />
                                    <small style={{color:'#888', display:'block', marginTop:'5px'}}>Formatos: PDF, JPG, PNG</small>
                                </div>
                            </div>
                        </div>

                    </div>
                    
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>
                            {isLoading ? 'Guardando...' : 'Guardar Información'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalGestionConductor;


==================================================================
ARCHIVO: frontend\src\components\ModalGuardarPaso.jsx
==================================================================
// frontend/src/components/ModalGuardarPaso.jsx

import React, { useState, useEffect } from 'react';
import { apiFetch } from '../services/apiService';
import '../style/Modal.css';
import Swal from 'sweetalert2';

const ModalGuardarPaso = ({ paso, alCerrar, alExito }) => {
    const [form, setForm] = useState({
        numeroPaso: '',
        nombrePaso: '',
        descripcionNorma: ''
    });
    const [isLoading, setIsLoading] = useState(false);

    useEffect(() => {
        if (paso) {
            setForm({
                numeroPaso: paso.NumeroPaso,
                nombrePaso: paso.NombrePaso,
                descripcionNorma: paso.DescripcionNorma
            });
        }
    }, [paso]);

    const handleChange = (e) => setForm({ ...form, [e.target.name]: e.target.value });

    const handleSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        try {
            const url = paso ? '/pesv/pasos/editar' : '/pesv/pasos/crear';
            const method = paso ? 'PUT' : 'POST';
            // Si es edición enviamos el ID, si es nuevo no
            const body = paso ? { idPaso: paso.ID_Paso, ...form } : form;

            await apiFetch(url, { method, body: JSON.stringify(body) });
            
            Swal.fire('Éxito', `Paso ${paso ? 'actualizado' : 'creado'} correctamente`, 'success');
            alExito();
        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                    <h3>{paso ? 'Editar Paso' : 'Crear Nuevo Paso'}</h3>
                    <button className="modal-close-button" onClick={alCerrar}>&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        <div className="form-group">
                            <label>Número de Paso (Orden) *</label>
                            <input type="number" name="numeroPaso" className="form-control" required 
                                value={form.numeroPaso} onChange={handleChange} placeholder="Ej: 25" />
                        </div>
                        <div className="form-group">
                            <label>Nombre del Paso / Requisito *</label>
                            <textarea name="nombrePaso" className="form-control" required rows="2" 
                                value={form.nombrePaso} onChange={handleChange} placeholder="Ej: Plan de fatiga" />
                        </div>
                        <div className="form-group">
                            <label>Normativa / Descripción Legal</label>
                            <input type="text" name="descripcionNorma" className="form-control" 
                                value={form.descripcionNorma} onChange={handleChange} placeholder="Ej: Art 2.2.4.6.X" />
                        </div>
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>
                            {isLoading ? 'Guardando...' : 'Guardar'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalGuardarPaso;


==================================================================
ARCHIVO: frontend\src\components\ModalRegistrarExamen.jsx
==================================================================
// frontend/src/componentes/ModalRegistrarExamen.jsx

import React, { useState } from 'react';
import { registrarExamen } from '../services/medicalService';
import { getUsuarioByCedula } from '../services/userService'; 
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; 
import { BsSearch } from 'react-icons/bs';

// Listas de opciones
const LISTA_ENTIDADES = ['Sura', 'Nueva EPS', 'Sanitas', 'Salud Total', 'Coomeva', 'Sura ARL', 'Bolívar', 'Positiva', 'Axa Colpatria', 'Otra'];
const LISTA_ESPECIALISTAS = ['Médico General', 'Médico Laboral', 'Ortopedista', 'Optómetra', 'Psicólogo', 'Fisioterapeuta', 'Otro'];

const ModalRegistrarExamen = ({ alCerrar, alExito }) => {
    
    const [formData, setFormData] = useState({
        idUsuarioColaborador: '', 
        nombreColaborador: '',    
        cedulaColaborador: '',    
        tipoExamen: 'Ingreso',
        fechaExamen: new Date().toISOString().split('T')[0],
        conceptoAptitud: 'Apto',
        medicoEspecialista: '',
        entidadEmite: '',
        duracionRecomendaciones: '',
        resumenCaso: '',
        recomendacionesGenerales: '', 
        recomendacionesOcupacionales: '',
        compromisos: '',
        observaciones: '' 
    });
    
    const [isSearching, setIsSearching] = useState(false);
    const [isLoading, setIsLoading] = useState(false);

    // Estados para opción "Otra"
    const [entidadSelect, setEntidadSelect] = useState('');
    const [medicoSelect, setMedicoSelect] = useState('');

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({ ...prevState, [name]: value }));
    };

    // Manejo especial para Selects
    const handleSelectChange = (e, campo, setEstadoLocal) => {
        const valor = e.target.value;
        setEstadoLocal(valor);
        if (valor !== 'Otra' && valor !== 'Otro') {
            setFormData(prev => ({ ...prev, [campo]: valor }));
        } else {
            setFormData(prev => ({ ...prev, [campo]: '' }));
        }
    };

    // --- LÓGICA DE BÚSQUEDA RESTAURADA ---
    const handleBuscarCedula = async () => {
        if (!formData.cedulaColaborador) {
            Swal.fire('Atención', 'Por favor ingrese un número de cédula para buscar.', 'warning');
            return;
        }

        setIsSearching(true);
        try {
            const usuario = await getUsuarioByCedula(formData.cedulaColaborador);
            
            setFormData(prev => ({
                ...prev,
                idUsuarioColaborador: usuario.ID_Usuario,
                nombreColaborador: usuario.NombreCompleto
            }));

            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 3000,
                timerProgressBar: true, didOpen: (toast) => { toast.onmouseenter = Swal.stopTimer; toast.onmouseleave = Swal.resumeTimer; }
            });
            Toast.fire({ icon: 'success', title: 'Colaborador encontrado' });

        // eslint-disable-next-line no-unused-vars
        } catch (error) {
            setFormData(prev => ({
                ...prev,
                idUsuarioColaborador: '',
                nombreColaborador: '' 
            }));
            
            Swal.fire({
                title: 'Usuario no encontrado',
                text: 'El usuario no está registrado. Verifique la cédula o cree el usuario primero.',
                icon: 'error'
            });
        } finally {
            setIsSearching(false);
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        
        if (!formData.idUsuarioColaborador) {
            Swal.fire('Error', 'Debe buscar y seleccionar un colaborador válido antes de guardar.', 'error');
            return;
        }

        setIsLoading(true);

        try {
            await registrarExamen(formData); 
            Swal.fire({
                title: '¡Éxito!',
                text: 'Examen médico registrado exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            alExito(); 
        } catch (err) {
            Swal.fire('Error', err.message, 'error');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Registrar Examen Médico Ocupacional</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <form onSubmit={handleSubmit}>
                    <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                        
                        {/* BUSCADOR */}
                        <div className="form-group">
                            <label htmlFor="cedulaColaborador">Cédula del Colaborador *</label>
                            <div style={{ display: 'flex', gap: '10px' }}>
                                <input
                                    type="text" id="cedulaColaborador" name="cedulaColaborador"
                                    value={formData.cedulaColaborador} onChange={handleChange}
                                    placeholder="Ingrese cédula y busque..." required style={{ flex: 1 }}
                                />
                                <button type="button" className="btn btn-secondary" onClick={handleBuscarCedula} disabled={isSearching}>
                                    <BsSearch /> {isSearching ? '...' : 'Buscar'}
                                </button>
                            </div>
                        </div>

                        <div className="form-group">
                            <label htmlFor="nombreColaborador">Nombre del Colaborador (Automático)</label>
                            <input type="text" id="nombreColaborador" name="nombreColaborador" value={formData.nombreColaborador} readOnly disabled style={{ backgroundColor: '#f0f0f0', cursor: 'not-allowed' }} />
                        </div>
                        
                        <div style={{ display: 'flex', gap: '1rem' }}>
                            <div className="form-group" style={{ flex: 1 }}>
                                <label>Tipo de Examen *</label>
                                <select name="tipoExamen" value={formData.tipoExamen} onChange={handleChange}>
                                    <option value="Ingreso">Ingreso</option>
                                    <option value="Periódico">Periódico</option>
                                    <option value="Egreso">Egreso</option>
                                    <option value="Post-incapacidad">Post-incapacidad</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div className="form-group" style={{ flex: 1 }}>
                                <label>Fecha de Examen *</label>
                                <input type="date" name="fechaExamen" value={formData.fechaExamen} onChange={handleChange} required />
                            </div>
                        </div>
                        
                        <div className="form-group">
                            <label>Concepto de Aptitud *</label>
                            <select name="conceptoAptitud" value={formData.conceptoAptitud} onChange={handleChange}>
                                <option value="Apto">Apto</option>
                                <option value="Apto con restricciones">Apto con restricciones</option>
                                <option value="No Apto">No Apto</option>
                            </select>
                        </div>

                        <hr />
                        <h4>Detalles del Concepto</h4>

                        {/* SELECTOR ENTIDAD */}
                        <div className="form-group">
                            <label>Entidad que emite (ARL/EPS)</label>
                            <select value={entidadSelect} onChange={(e) => handleSelectChange(e, 'entidadEmite', setEntidadSelect)}>
                                <option value="">-- Seleccione --</option>
                                {LISTA_ENTIDADES.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                            </select>
                            {(entidadSelect === 'Otra') && (
                                <input type="text" name="entidadEmite" placeholder="Escriba el nombre..." value={formData.entidadEmite} onChange={handleChange} style={{ marginTop: '0.5rem' }} autoFocus />
                            )}
                        </div>

                        {/* SELECTOR MÉDICO */}
                        <div className="form-group">
                            <label>Profesional que emite (Médico)</label>
                            <select value={medicoSelect} onChange={(e) => handleSelectChange(e, 'medicoEspecialista', setMedicoSelect)}>
                                <option value="">-- Seleccione --</option>
                                {LISTA_ESPECIALISTAS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                            </select>
                            {(medicoSelect === 'Otro') && (
                                <input type="text" name="medicoEspecialista" placeholder="Escriba el tipo..." value={formData.medicoEspecialista} onChange={handleChange} style={{ marginTop: '0.5rem' }} />
                            )}
                        </div>

                        <div className="form-group"><label>Duración de Recomendaciones</label><input type="text" name="duracionRecomendaciones" value={formData.duracionRecomendaciones} onChange={handleChange} /></div>
                        <div className="form-group"><label>Breve resumen del caso</label><textarea name="resumenCaso" rows="2" value={formData.resumenCaso} onChange={handleChange} /></div>
                        <div className="form-group"><label>Recomendaciones Médicas</label><textarea name="recomendacionesGenerales" rows="3" value={formData.recomendacionesGenerales} onChange={handleChange} /></div>
                        <div className="form-group"><label>Recomendaciones Ocupacionales</label><textarea name="recomendacionesOcupacionales" rows="3" value={formData.recomendacionesOcupacionales} onChange={handleChange} /></div>
                        <div className="form-group"><label>Compromisos</label><textarea name="compromisos" rows="2" value={formData.compromisos} onChange={handleChange} /></div>
                        <div className="form-group"><label>Observaciones Internas</label><textarea name="observaciones" rows="2" value={formData.observaciones} onChange={handleChange} /></div>
                        
                    </div>

                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Guardando...' : 'Guardar Examen'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalRegistrarExamen;


==================================================================
ARCHIVO: frontend\src\components\ModalResetPassword.jsx
==================================================================
// frontend/src/componentes/ModalResetPassword.jsx

import React, { useState } from 'react';
import { resetPasswordColaborador } from '../services/userService';
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; // <-- Importar

const ModalResetPassword = ({ usuario, alCerrar, alExito }) => {
    const [password, setPassword] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        if (password.length < 6) { 
            setError('La contraseña debe tener al menos 6 caracteres');
            return;
        }
        setIsLoading(true);
        try {
            await resetPasswordColaborador(usuario.ID_Usuario, password);
            
            // --- REEMPLAZAR 'alert()' ---
            Swal.fire({
                title: '¡Contraseña Actualizada!',
                text: `Por favor, informa al colaborador su nueva contraseña temporal: ${password}`,
                icon: 'success',
                confirmButtonText: 'Entendido'
            });
            alExito(); 
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Resetear Contraseña</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        <p>Estás asignando una nueva contraseña temporal para <strong>{usuario.NombreCompleto}</strong>.</p>
                        <div className="form-group">
                            <label htmlFor="password">Nueva Contraseña Temporal *</label>
                            <input type="password" id="password" name="password" value={password} onChange={(e) => setPassword(e.target.value)} required />
                        </div>
                        {error && <p className="modal-error">{error}</p>}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Guardando...' : 'Asignar Contraseña'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalResetPassword;


==================================================================
ARCHIVO: frontend\src\components\ModalSubirArchivo.jsx
==================================================================
// frontend/src/componentes/ModalSubirArchivo.jsx
import React, { useState } from 'react';
import { subirArchivos } from '../services/documentService';
import '../style/Modal.css';
import '../index.css';
import { BsFileEarmarkArrowUpFill } from 'react-icons/bs';
import Swal from 'sweetalert2'; // <-- Importar

const ModalSubirArchivo = ({ idCarpetaDestino, alCerrar, alExito }) => {
    const [archivos, setArchivos] = useState(null); 
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');
    const handleFileChange = (e) => { setArchivos(e.target.files); };
    const handleSubmit = async (e) => {
        e.preventDefault(); setError('');
        if (!archivos || archivos.length === 0) { setError('Por favor, seleccione al menos un archivo.'); return; }
        setIsLoading(true);
        try {
            const formData = new FormData();
            formData.append('idCarpeta', idCarpetaDestino);
            for (let i = 0; i < archivos.length; i++) { formData.append('archivos', archivos[i]); }
            
            const resultado = await subirArchivos(formData); // Captura el mensaje de éxito
            
            Swal.fire({ title: '¡Éxito!', text: resultado.msg || 'Archivos subidos exitosamente.', icon: 'success', timer: 2000, showConfirmButton: false });
            alExito(); 
        } catch (err) { setError(err.message); } finally { setIsLoading(false); }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}><div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header"><h2>Subir Documentos</h2><button onClick={alCerrar} className="modal-close-button">&times;</button></div>
            <form onSubmit={handleSubmit}>
                <div className="modal-body">
                    <div className="form-group"><label htmlFor="archivos">Seleccione archivos (PDF, Word, Excel, XML)</label><input type="file" id="archivos" name="archivos" onChange={handleFileChange} multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.xml,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/xml,text/xml" /></div>
                    {archivos && archivos.length > 0 && (<div style={{fontSize: '0.9rem'}}><strong>Archivos seleccionados:</strong><ul>{Array.from(archivos).map(file => (<li key={file.name}>{file.name} ({(file.size / 1024).toFixed(1)} KB)</li>))}</ul></div>)}
                    {error && <p className="modal-error">{error}</p>}
                </div>
                <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button><button type="submit" className="btn btn-primary" disabled={isLoading}><BsFileEarmarkArrowUpFill /> {isLoading ? 'Subiendo...' : 'Subir Archivos'}</button></div>
            </form>
        </div></div>
    );
};
export default ModalSubirArchivo;


==================================================================
ARCHIVO: frontend\src\components\ModalVerACPM.jsx
==================================================================
// frontend/src/componentes/ModalVerACPM.jsx

import React, { useState, useEffect } from 'react';
// Importamos ambos servicios
import { getACPMDetalle, getEvidenciasPorACPM } from '../services/acpmService';
import '../style/Modal.css';
import '../style/UsuariosPage.css';
import '../style/InspeccionesPage.css'; // Reutiliza estilos de detalle

/**
 * @component ModalVerACPM
 * @desc Modal de "Solo Lectura" para ver el detalle de una ACPM
 */
const ModalVerACPM = ({ acpmId, alCerrar }) => {
    
    // Estados para los datos
    const [acpm, setAcpm] = useState(null);
    const [evidencias, setEvidencias] = useState([]);
    
    // Estados de carga separados
    const [isLoading, setIsLoading] = useState(true);
    const [isLoadingEvidencias, setIsLoadingEvidencias] = useState(true);
    const [error, setError] = useState('');

    // URL base del backend para construir los enlaces
    const API_BASE_URL = 'http://localhost:5000';

    // Carga los detalles y las evidencias al mismo tiempo
    useEffect(() => {
        if (!acpmId) return;

        const cargarDatos = async () => {
            try {
                // Inicia ambas peticiones
                const detallePromise = getACPMDetalle(acpmId);
                const evidenciasPromise = getEvidenciasPorACPM(acpmId);
                
                // Espera a que la de detalle termine
                const dataDetalle = await detallePromise;
                setAcpm(dataDetalle);
                setIsLoading(false); // Detalle cargado

                // Espera a que la de evidencias termine
                const dataEvidencias = await evidenciasPromise;
                setEvidencias(dataEvidencias);
                setIsLoadingEvidencias(false); // Evidencias cargadas

            } catch (err) {
                setError(err.message);
                setIsLoading(false);
                setIsLoadingEvidencias(false);
            }
        };
        cargarDatos();
    }, [acpmId]);

    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        return new Date(fechaISO.split('T')[0] + 'T00:00:00').toLocaleDateString('es-CO');
    };

    // Función para íconos (reutilizada de ModalVerEvidencias)
    const getIconoTipo = (tipo) => {
        if (tipo.includes('pdf')) return '📄';
        if (tipo.includes('png') || tipo.includes('jpg') || tipo.includes('jpeg')) return '🖼️';
        return '📎';
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Detalle de Acción ACPM (ID: {acpmId})</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                    {isLoading && <p>Cargando detalle...</p>}
                    {error && <p className="modal-error">{error}</p>}
                    
                    {!isLoading && acpm && (
                        <div className="inspection-details">
                            {/* ... (Toda la sección de detalles de la ACPM, sin cambios) ... */}
                            <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
                                <div className="detail-section" style={{ flex: 1, minWidth: '200px' }}>
                                    <strong>Tipo de Acción:</strong> {acpm.TipoAccion}
                                </div>
                                <div className="detail-section" style={{ flex: 1, minWidth: '200px' }}>
                                    <strong>Origen:</strong> {acpm.Origen}
                                </div>
                                <div className="detail-section" style={{ flex: 1, minWidth: '200px' }}>
                                    <strong>Estado:</strong>
                                    <span className={`status-pill ${
                                        acpm.EstadoACPM === 'Abierta' ? 'status-pendiente' :
                                        acpm.EstadoACPM === 'En Proceso' ? 'status-proceso' : 'status-activo'
                                    }`}>
                                        {acpm.EstadoACPM}
                                    </span>
                                </div>
                            </div>
                            <div className="detail-section"><strong>Descripción del Problema:</strong><p className="detail-box">{acpm.DescripcionProblema}</p></div>
                            <div className="detail-section"><strong>Análisis de Causa:</strong><p className="detail-box">{acpm.AnalisisCausa || 'No registrado'}</p></div>
                            <div className="detail-section"><strong>Plan de Acción:</strong><p className="detail-box">{acpm.PlanAccion}</p></div>
                            <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
                                <div className="detail-section" style={{ flex: 1 }}><strong>Responsable:</strong> {acpm.NombreResponsable || 'No asignado'}</div>
                                <div className="detail-section" style={{ flex: 1 }}><strong>Fecha Límite:</strong> {formatearFecha(acpm.FechaLimite)}</div>
                                <div className="detail-section" style={{ flex: 1 }}><strong>Fecha Cierre:</strong> {formatearFecha(acpm.FechaCierre)}</div>
                            </div>
                            <div className="detail-section">
                                <strong>Historial de Seguimiento:</strong>
                                <pre className="detail-box" style={{ fontFamily: 'inherit', fontSize: '0.9rem' }}>
                                    {acpm.ComentariosSeguimiento || 'Sin comentarios de seguimiento.'}
                                </pre>
                            </div>
                            
                            {/* --- SECCIÓN DE EVIDENCIAS (NUEVO) --- */}
                            <div className="detail-section">
                                <strong>Archivos de Evidencia:</strong>
                                {isLoadingEvidencias && <p>Cargando evidencias...</p>}
                                {!isLoadingEvidencias && evidencias.length === 0 && (
                                    <p className="detail-box" style={{fontStyle: 'italic'}}>No se han adjuntado evidencias.</p>
                                )}
                                {!isLoadingEvidencias && evidencias.length > 0 && (
                                    <ul className="evidence-list" style={{marginTop: '0.5rem'}}>
                                        {evidencias.map(ev => (
                                            <li key={ev.ID_EvidenciaACPM} className="evidence-item">
                                                <span>{getIconoTipo(ev.TipoArchivo)}</span>
                                                <div className="evidence-info">
                                                    <a href={`${API_BASE_URL}/${ev.RutaArchivo.replace(/\\/g, '/')}`} target="_blank" rel="noopener noreferrer">
                                                        {ev.NombreArchivo}
                                                    </a>
                                                    <small>
                                                        Subido por: {ev.NombreUsuarioSubio} el {new Date(ev.FechaSubida).toLocaleDateString()}
                                                        {ev.EsEvidenciaDeCierre && <strong style={{color: '#005A5B'}}> (Evidencia de Cierre)</strong>}
                                                    </small>
                                                </div>
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                        </div>
                    )}
                </div>

                <div className="modal-footer">
                    <button 
                        type="button" 
                        className="btn btn-secondary" 
                        onClick={alCerrar}
                    >
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerACPM;


==================================================================
ARCHIVO: frontend\src\components\ModalVerDetalleActividad.jsx
==================================================================
// frontend/src/componentes/ModalVerDetalleActividad.jsx

import React, { useState, useEffect } from 'react';
import { getActividadDetalle } from '../services/scheduleService';
import '../style/Modal.css';
import '../style/index.css'; 

const ModalVerDetalleActividad = ({ idActividad, alCerrar }) => {
    
    const [detalle, setDetalle] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');

    useEffect(() => {
        if (!idActividad) return;

        const cargarDetalle = async () => {
            try {
                setIsLoading(true);
                const data = await getActividadDetalle(idActividad);
                setDetalle(data);
            } catch (err) {
                setError(err.message);
            } finally {
                setIsLoading(false);
            }
        };
        cargarDetalle();
    }, [idActividad]);

    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        // Ajustamos la fecha para que no se desplace el día
        return new Date(fechaISO.split('T')[0] + 'T00:00:00').toLocaleDateString('es-CO');
    };
    
    const getEstadoClass = (estado) => {
        if (estado === 'Realizada') return 'status-activo';
        if (estado === 'Pendiente') return 'status-pendiente';
        return 'status-inactivo';
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Detalle de Actividad #{idActividad}</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                    {isLoading && <p>Cargando detalle...</p>}
                    {error && <p className="modal-error">{error}</p>}
                    
                    {!isLoading && detalle && (
                        <div className="detail-container">
                            <h3 style={{ borderBottom: '1px solid #eee', paddingBottom: '10px' }}>
                                {detalle.NombreActividad}
                            </h3>

                            {/* --- Grid de Información Básica --- */}
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '1.5rem', marginBottom: '1.5rem' }}>
                                
                                <div style={{ flex: 1, minWidth: '45%' }}>
                                    <strong>Estado:</strong>
                                    <span className={`status-pill ${getEstadoClass(detalle.EstadoActividad)}`} style={{ marginLeft: '10px' }}>
                                        {detalle.EstadoActividad}
                                    </span>
                                </div>
                                <div style={{ flex: 1, minWidth: '45%' }}>
                                    <strong>Responsable:</strong> {detalle.Responsable} ({detalle.CedulaResponsable})
                                </div>
                                <div style={{ flex: 1, minWidth: '45%' }}>
                                    <strong>Fecha Límite:</strong> {formatearFecha(detalle.FechaLimite)}
                                </div>
                                <div style={{ flex: 1, minWidth: '45%' }}>
                                    <strong>Fecha Realización:</strong> {detalle.FechaRealizacion ? formatearFecha(detalle.FechaRealizacion) : 'Pendiente'}
                                </div>
                            </div>
                            
                            <hr />

                            {/* --- Descripción --- */}
                            <div style={{ marginTop: '1.5rem' }}>
                                <strong>Descripción Detallada:</strong>
                                <p className="detail-box">{detalle.DescripcionActividad || 'No aplica'}</p>
                            </div>

                            {/* --- Observaciones --- */}
                            <div style={{ marginTop: '1.5rem' }}>
                                <strong>Observaciones Finales:</strong>
                                <p className="detail-box">{detalle.Observaciones || 'Sin observaciones registradas'}</p>
                            </div>

                        </div>
                    )}
                </div>

                <div className="modal-footer">
                    <button type="button" className="btn btn-secondary" onClick={alCerrar}>Cerrar</button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerDetalleActividad;


==================================================================
ARCHIVO: frontend\src\components\ModalVerDetalleActivo.jsx
==================================================================
// frontend/src/components/ModalVerDetalleActivo.jsx

import React from 'react';
import '../style/Modal.css';
import '../style/InspeccionesPage.css';
import { BsSpeedometer2, BsCalendarEvent, BsPersonBadge, BsGeoAlt } from 'react-icons/bs';

const ModalVerDetalleActivo = ({ activo, alCerrar }) => {
    if (!activo) return null;

    const esVehiculo = ['Vehiculo', 'Moto', 'Montacarga'].includes(activo.TipoActivo);

    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return <span style={{color: '#999'}}>No registrada</span>;
        return new Date(fechaISO.split('T')[0] + 'T00:00:00').toLocaleDateString('es-CO');
    };

    const getEstadoDocumento = (fechaISO) => {
        if (!fechaISO) return null;
        const fechaDoc = new Date(fechaISO);
        const hoy = new Date();
        const esVencido = fechaDoc < hoy;
        return (
            <span className={`status-pill ${esVencido ? 'status-inactivo' : 'status-activo'}`} style={{fontSize: '0.75rem', marginLeft: '5px'}}>
                {esVencido ? 'Vencido' : 'Vigente'}
            </span>
        );
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Ficha Técnica del Activo</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                    
                    <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', borderBottom: '1px solid #eee', paddingBottom: '1rem', marginBottom: '1rem' }}>
                        <div style={{ flex: 1 }}>
                            <small style={{color: '#666', textTransform: 'uppercase'}}>{activo.TipoActivo}</small>
                            <h3 style={{ margin: 0, color: '#005A5B' }}>{activo.NombreDescriptivo}</h3>
                        </div>
                        <div style={{ textAlign: 'right' }}>
                            <span className="status-pill status-activo" style={{fontSize: '1rem'}}>
                                {activo.CodigoIdentificador}
                            </span>
                        </div>
                    </div>

                    <div className="inspection-details">
                        <div className="detail-section">
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem'}}>
                                <div>
                                    <strong>Ubicación:</strong>
                                    <p className="detail-box"><BsGeoAlt /> {activo.Ubicacion || 'No definida'}</p>
                                </div>
                                <div>
                                    <strong>Marca / Modelo:</strong>
                                    <p className="detail-box">{activo.Marca || '---'} {activo.Modelo || ''}</p>
                                </div>
                            </div>
                        </div>

                        {esVehiculo && (
                            <>
                                <h4 style={{borderBottom: '2px solid #f0f2f5', paddingBottom: '5px', marginTop: '1.5rem', color: '#6c757d'}}>
                                    Información del Vehículo
                                </h4>
                                
                                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem', marginTop: '1rem'}}>
                                    <div>
                                        <strong><BsPersonBadge /> Conductor Asignado:</strong>
                                        <div className="detail-box">
                                            {activo.NombreConductor ? (
                                                <>
                                                    <div style={{fontWeight: 'bold'}}>{activo.NombreConductor}</div>
                                                    <small style={{color: '#666'}}>C.C. {activo.CedulaConductor}</small>
                                                </>
                                            ) : (
                                                <span style={{color: '#999', fontStyle: 'italic'}}>Sin conductor asignado</span>
                                            )}
                                        </div>
                                    </div>

                                    <div>
                                        <strong><BsSpeedometer2 /> Kilometraje Actual:</strong>
                                        <div className="detail-box" style={{fontSize: '1.2rem', fontWeight: 'bold', color: '#007BFF'}}>
                                            {activo.KilometrajeActual ? `${activo.KilometrajeActual.toLocaleString()} km` : '0 km'}
                                        </div>
                                    </div>
                                </div>

                                <div style={{marginTop: '1rem'}}>
                                    <strong>Documentación Legal:</strong>
                                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginTop: '0.5rem'}}>
                                        <div style={{background: '#f8f9fa', padding: '0.8rem', borderRadius: '8px', border: '1px solid #e9ecef'}}>
                                            <div style={{fontWeight: '600', color: '#555'}}><BsCalendarEvent /> Vencimiento SOAT</div>
                                            <div style={{marginTop: '5px'}}>
                                                {formatearFecha(activo.SOAT_Vencimiento)}
                                                {getEstadoDocumento(activo.SOAT_Vencimiento)}
                                            </div>
                                        </div>
                                        <div style={{background: '#f8f9fa', padding: '0.8rem', borderRadius: '8px', border: '1px solid #e9ecef'}}>
                                            <div style={{fontWeight: '600', color: '#555'}}><BsCalendarEvent /> Vencimiento Tecnomecánica</div>
                                            <div style={{marginTop: '5px'}}>
                                                {formatearFecha(activo.Tecno_Vencimiento)}
                                                {getEstadoDocumento(activo.Tecno_Vencimiento)}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}

                    </div>
                </div>

                <div className="modal-footer">
                    <button type="button" className="btn btn-secondary" onClick={alCerrar}>Cerrar</button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerDetalleActivo;


==================================================================
ARCHIVO: frontend\src\components\ModalVerDocumento.jsx
==================================================================
// frontend/src/componentes/ModalVerDocumento.jsx

import React, { useState, useEffect } from 'react';
import { getDocumentoBlob } from '../services/documentService';
import '../style/Modal.css';
import '../index.css';
import Swal from 'sweetalert2';

/**
 * @component ModalVerDocumento
 * @desc Modal para visualizar un documento (PDF, etc.)
 * @param {object} archivo - El objeto 'archivo' de la lista
 * @param {function} alCerrar - Función para cerrar el modal
 */
const ModalVerDocumento = ({ archivo, alCerrar }) => {
    
    const [documentUrl, setDocumentUrl] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');

    useEffect(() => {
        const cargarDocumento = async () => {
            if (!archivo) return;
            try {
                const blob = await getDocumentoBlob(archivo.ID);
                
                // --- Validar tipo (extra) ---
                // (El navegador solo puede mostrar ciertos tipos inline)
                if (!blob.type.includes('pdf') && !blob.type.includes('image') && !blob.type.includes('text')) {
                     Swal.fire({
                        title: 'Vista Previa No Soportada',
                        text: `El navegador no puede mostrar archivos '${archivo.TipoArchivo}'. Se iniciará la descarga.`,
                        icon: 'info',
                     });
                     // (Forzamos la descarga si no se puede ver)
                     const url = URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.href = url;
                     a.download = archivo.Nombre;
                     a.click();
                     URL.revokeObjectURL(url);
                     alCerrar(); // Cierra el modal
                     return;
                }
                
                const url = URL.createObjectURL(blob);
                setDocumentUrl(url);

            } catch (err) {
                setError(err.message);
            } finally {
                setIsLoading(false);
            }
        };

        cargarDocumento();

        // Limpia la URL de la memoria cuando el modal se cierra
        return () => {
            if (documentUrl) {
                URL.revokeObjectURL(documentUrl);
            }
        };
    }, [archivo]); // Solo se ejecuta una vez

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            {/* Hacemos el modal extra grande y alto */}
            <div className="modal-content" 
                 style={{ maxWidth: '90vw', width: '1000px', height: '90vh', display: 'flex', flexDirection: 'column' }} 
                 onClick={(e) => e.stopPropagation()}
            >
                
                <div className="modal-header">
                    <h2>Visor: {archivo.Nombre}</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body" style={{ flex: 1, padding: 0, overflow: 'hidden' }}>
                    {isLoading && <p style={{padding: '2rem'}}>Cargando documento...</p>}
                    {error && <p className="modal-error" style={{padding: '2rem'}}>{error}</p>}
                    
                    {documentUrl && (
                        // Usamos un iframe para mostrar el contenido
                        <iframe
                            src={documentUrl}
                            title={archivo.Nombre}
                            style={{ width: '100%', height: '100%', border: 'none' }}
                        />
                    )}
                </div>

                <div className="modal-footer">
                    <button 
                        type="button" 
                        className="btn btn-secondary" 
                        onClick={alCerrar}
                    >
                        Cerrar Visor
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerDocumento;


==================================================================
ARCHIVO: frontend\src\components\ModalVerEvidencia.jsx
==================================================================
// frontend/src/components/ModalVerEvidencia.jsx

import React, { useState, useRef, useEffect } from 'react';
import '../style/Modal.css';
import Swal from 'sweetalert2';
import { BsDownload, BsFileEarmarkPdf, BsImage, BsEye, BsXCircle, BsArrowRepeat } from 'react-icons/bs';

const ModalVerEvidencia = ({ archivos, pasoNombre, alCerrar }) => {
    
    const API_URL = 'http://localhost:5000'; 
    
    // Estado local
    const [listaArchivos, setListaArchivos] = useState([]);
    // Referencia para el input file
    const fileInputRef = useRef(null);
    const [evidenciaAActualizar, setEvidenciaAActualizar] = useState(null);

    useEffect(() => {
        if (archivos) {
            setListaArchivos(archivos);
        }
    }, [archivos]);

    const esImagen = (ruta) => ruta && ruta.match(/\.(jpeg|jpg|gif|png)$/) != null;

    // --- 1. BOTÓN ACTUALIZAR ---
    const handleClicActualizar = (e, evidencia) => {
        e.preventDefault(); // Prevenir comportamientos por defecto
        e.stopPropagation(); // EVITAR QUE SE CIERRE EL MODAL
        
        setEvidenciaAActualizar(evidencia);
        
        // Disparar el selector de archivos
        if (fileInputRef.current) {
            fileInputRef.current.click();
        }
    };

    // --- 2. AL SELECCIONAR ARCHIVO ---
    const handleArchivoSeleccionado = async (e) => {
        // Evitar propagación aquí también por seguridad
        e.stopPropagation();
        
        const file = e.target.files[0];
        if (!file || !evidenciaAActualizar) return;

        const result = await Swal.fire({
            title: '¿Reemplazar documento?',
            text: `Vas a cambiar "${evidenciaAActualizar.NombreArchivo}" por "${file.name}".`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Sí, reemplazar'
        });

        if (result.isConfirmed) {
            const formData = new FormData();
            formData.append('idEvidencia', evidenciaAActualizar.ID_Evidencia);
            formData.append('evidencia', file);

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:5000/api/pesv/evidencias/reemplazar', {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (response.ok) {
                    Swal.fire('¡Éxito!', 'Documento actualizado.', 'success');
                    
                    // Actualizar la lista visualmente al instante
                    const nuevaLista = listaArchivos.map(item => {
                        if (item.ID_Evidencia === evidenciaAActualizar.ID_Evidencia) {
                            return {
                                ...item,
                                NombreArchivo: file.name,
                                // Ruta visual temporal (el backend ya la guardó bien)
                                RutaArchivo: 'uploads/' + file.name, 
                                FechaSubida: new Date().toISOString()
                            };
                        }
                        return item;
                    });
                    setListaArchivos(nuevaLista);

                } else {
                    throw new Error('Error al actualizar');
                }
            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'No se pudo actualizar el archivo.', 'error');
            }
        }

        // Limpiar input para permitir subir el mismo archivo si se necesita
        e.target.value = null;
        setEvidenciaAActualizar(null);
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            
            {/* CONTENIDO DEL MODAL */}
            <div className="modal-content modal-lg" style={{maxWidth: '900px', maxHeight: '85vh', display: 'flex', flexDirection: 'column'}} onClick={e => e.stopPropagation()}>
                
                {/* --- IMPORTANTE: EL INPUT DEBE ESTAR AQUÍ DENTRO (NO AFUERA) --- */}
                <input 
                    type="file" 
                    ref={fileInputRef} 
                    style={{display:'none'}} 
                    accept=".pdf,.jpg,.jpeg,.png" 
                    onChange={handleArchivoSeleccionado}
                    onClick={(e) => e.stopPropagation()} // Doble seguridad
                />
                {/* ------------------------------------------------------------- */}

                <div className="modal-header">
                    <h3 style={{margin:0, fontSize:'1.2rem'}}>Evidencias: {pasoNombre}</h3>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body" style={{flex: 1, overflowY: 'auto', padding: '1.5rem'}}>
                    
                    {listaArchivos.length === 0 ? (
                        <div style={{textAlign:'center', padding:'2rem', color:'#999', border:'2px dashed #eee', borderRadius:'8px'}}>
                            <BsFileEarmarkPdf style={{fontSize:'3rem', marginBottom:'10px', opacity:0.3}}/>
                            <p>No hay archivos adjuntos en este paso.</p>
                        </div>
                    ) : (
                        <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                            {listaArchivos.map((archivo) => {
                                const rutaLimpia = archivo.RutaArchivo ? archivo.RutaArchivo.replace(/\\/g, '/') : '';
                                const urlVer = `${API_URL}/${rutaLimpia}`;
                                const urlDescarga = `${API_URL}/api/pesv/download/${archivo.NombreArchivo}`;
                                
                                return (
                                    <div key={archivo.ID_Evidencia} style={{
                                        border: '1px solid #e0e0e0', 
                                        borderRadius: '8px', 
                                        padding: '15px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'space-between',
                                        backgroundColor: '#fff',
                                        boxShadow: '0 2px 5px rgba(0,0,0,0.02)'
                                    }}>
                                        <div style={{display:'flex', alignItems:'center', gap:'15px', flex: 1, minWidth: 0}}>
                                            <div style={{
                                                width:'45px', height:'45px', borderRadius:'8px', 
                                                backgroundColor: esImagen(rutaLimpia) ? '#fff8e1' : '#e7f1ff',
                                                color: esImagen(rutaLimpia) ? '#ffc107' : '#007BFF',
                                                display:'flex', alignItems:'center', justifyContent:'center', fontSize:'1.5rem',
                                                flexShrink: 0
                                            }}>
                                                {esImagen(rutaLimpia) ? <BsImage /> : <BsFileEarmarkPdf />}
                                            </div>
                                            <div style={{overflow: 'hidden'}}>
                                                <div style={{fontWeight:'600', color:'#333', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis'}} title={archivo.NombreArchivo}>
                                                    {archivo.NombreArchivo}
                                                </div>
                                                <div style={{fontSize:'0.75rem', color:'#888'}}>
                                                    Fecha: {new Date(archivo.FechaSubida).toLocaleString()}
                                                </div>
                                            </div>
                                        </div>

                                        <div style={{display:'flex', gap:'8px', marginLeft:'15px'}}>
                                            <a href={urlVer} target="_blank" rel="noopener noreferrer" className="btn btn-sm" style={{backgroundColor: '#17a2b8', color: 'white'}}>
                                                <BsEye /> Ver
                                            </a>
                                            <a href={urlDescarga} className="btn btn-sm" style={{backgroundColor: '#6c757d', color: 'white'}}>
                                                <BsDownload /> Bajar
                                            </a>
                                            
                                            {/* BOTÓN ACTUALIZAR CORREGIDO */}
                                            <button 
                                                onClick={(e) => handleClicActualizar(e, archivo)} // Pasamos el evento 'e'
                                                className="btn btn-sm"
                                                type="button"
                                                style={{backgroundColor: '#fff', color: '#28a745', border: '1px solid #28a745', fontWeight: 'bold'}}
                                            >
                                                <BsArrowRepeat /> Actualizar
                                            </button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
                <div className="modal-footer">
                    <button className="btn btn-secondary" onClick={alCerrar}>
                        <BsXCircle style={{marginRight:'5px'}}/> Cerrar Ventana
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerEvidencia;


==================================================================
ARCHIVO: frontend\src\components\ModalVerEvidencias.jsx
==================================================================
// frontend/src/componentes/ModalVerEvidencias.jsx

import React, { useState, useEffect } from 'react';
// --- CORRECCIÓN: El nombre correcto es getEvidenciasActividad ---
import { getEvidenciasActividad } from '../services/scheduleService'; 
import '../style/Modal.css';
import '../index.css'; 
import '../style/InspeccionesPage.css'; // Reutiliza estilos de detalle

const ModalVerEvidencias = ({ actividad, alCerrar }) => {
    
    const [evidencias, setEvidencias] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');
    
    // URL base del backend para los enlaces
    const API_BASE_URL = 'http://localhost:5000';

    useEffect(() => {
        if (!actividad) return;

        const cargarEvidencias = async () => {
            try {
                setIsLoading(true);
                // --- Llamada a la función con el nombre correcto ---
                const data = await getEvidenciasActividad(actividad.ID_Actividad);
                setEvidencias(data);
            } catch (err) {
                setError(err.message);
            } finally {
                setIsLoading(false);
            }
        };
        
        cargarEvidencias();
    }, [actividad]);

    // Helper para icono según tipo
    const getIconoTipo = (tipo) => {
        if (!tipo) return '📎';
        if (tipo.includes('pdf')) return '📄';
        if (tipo.includes('image')) return '🖼️';
        return '📎';
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Evidencias de la Actividad</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body">
                    <div className="detail-section">
                        <strong>Actividad:</strong> {actividad?.NombreActividad}
                    </div>

                    {isLoading && <p>Cargando evidencias...</p>}
                    {error && <p className="modal-error">{error}</p>}
                    
                    {!isLoading && !error && evidencias.length === 0 && (
                        <p style={{ fontStyle: 'italic', color: '#666', textAlign: 'center', marginTop: '2rem' }}>
                            No hay evidencias adjuntas para esta actividad.
                        </p>
                    )}

                    {!isLoading && evidencias.length > 0 && (
                        <ul className="evidence-list" style={{ marginTop: '1rem' }}>
                            {evidencias.map((ev) => (
                                <li key={ev.ID_EvidenciaAct} className="evidence-item" style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    padding: '1rem',
                                    borderBottom: '1px solid #eee',
                                    gap: '1rem'
                                }}>
                                    <span style={{ fontSize: '1.5rem' }}>{getIconoTipo(ev.TipoArchivo)}</span>
                                    <div style={{ flex: 1 }}>
                                        <a 
                                            href={`${API_BASE_URL}/${ev.RutaArchivo.replace(/\\/g, '/')}`} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            style={{ fontWeight: '600', color: 'var(--color-acento)', textDecoration: 'none' }}
                                        >
                                            {ev.NombreArchivo}
                                        </a>
                                        <div style={{ fontSize: '0.85rem', color: '#888' }}>
                                            Subido por: {ev.NombreUsuarioSubio} • {new Date(ev.FechaSubida).toLocaleDateString()}
                                        </div>
                                    </div>
                                </li>
                            ))}
                        </ul>
                    )}
                </div>

                <div className="modal-footer">
                    <button className="btn btn-secondary" onClick={alCerrar}>Cerrar</button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerEvidencias;


==================================================================
ARCHIVO: frontend\src\components\ModalVerExamen.jsx
==================================================================
// frontend/src/componentes/ModalVerExamen.jsx

import React, { useState, useEffect } from 'react';
// Importamos el servicio para obtener el detalle
import { getExamenMedicoDetalle } from '../services/medicalService'; 
import '../style/Modal.css';
import '../index.css'; 
import '../style/InspeccionesPage.css'; // Reutiliza estilos de detalle

/**
 * @component ModalVerExamen
 * @desc Modal de "Solo Lectura" para ver el detalle de un Examen Médico
 * @param {number} examenId - El ID del examen a cargar
 * @param {function} alCerrar - Función para cerrar el modal
 */
const ModalVerExamen = ({ examenId, alCerrar }) => {
    
    const [examen, setExamen] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');

    useEffect(() => {
        if (!examenId) return;
        const cargarDetalle = async () => {
            try {
                setIsLoading(true);
                // Llama al servicio para obtener los datos
                const data = await getExamenMedicoDetalle(examenId);
                setExamen(data);
            } catch (err) {
                setError(err.message);
            } finally {
                setIsLoading(false);
            }
        };
        cargarDetalle();
    }, [examenId]); // Se ejecuta cuando el modal se abre

    // Formatear la fecha (corrigiendo zona horaria)
    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        const fecha = new Date(fechaISO.split('T')[0] + 'T00:00:00');
        return fecha.toLocaleDateString('es-CO');
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Detalle de Examen Médico</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                    {isLoading && <p>Cargando detalle...</p>}
                    {error && <p className="modal-error">{error}</p>}
                    
                    {!isLoading && examen && (
                        <div className="inspection-details">
                            {/* --- Datos Básicos --- */}
                            <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap', borderBottom: '1px solid #eee', paddingBottom: '1rem' }}>
                                <div className="detail-section" style={{ flex: 1, minWidth: '200px' }}>
                                    <strong>Colaborador:</strong> {examen.NombreColaborador}
                                </div>
                                <div className="detail-section" style={{ flex: 1, minWidth: '200px' }}>
                                    <strong>Cédula:</strong> {examen.CedulaColaborador}
                                </div>
                                <div className="detail-section" style={{ flex: 1, minWidth: '200px' }}>
                                    <strong>Tipo Examen:</strong> {examen.TipoExamen}
                                </div>
                                <div className="detail-section" style={{ flex: 1, minWidth: '200px' }}>
                                    <strong>Fecha Examen:</strong> {formatearFecha(examen.FechaExamen)}
                                </div>
                            </div>

                            {/* --- Concepto --- */}
                            <div className="detail-section" style={{marginTop: '1rem'}}>
                                <strong>Concepto de Aptitud:</strong> 
                                <p style={{margin: 0}}><strong>{examen.ConceptoAptitud}</strong></p>
                            </div>
                            
                            {/* --- Datos del PDF --- */}
                            <div className="detail-section">
                                <strong>Médico:</strong> {examen.MedicoEspecialista || 'N/A'}
                            </div>
                            <div className="detail-section">
                                <strong>Entidad:</strong> {examen.EntidadEmite || 'N/A'}
                            </div>
                            <div className="detail-section">
                                <strong>Duración:</strong> {examen.DuracionRecomendaciones || 'N/A'}
                            </div>
                            
                            <div className="detail-section">
                                <strong>Resumen del Caso:</strong>
                                <p className="detail-box">{examen.ResumenCaso || 'N/A'}</p>
                            </div>
                            <div className="detail-section">
                                <strong>Recomendaciones Médicas:</strong>
                                <p className="detail-box">{examen.RecomendacionesGenerales || 'N/A'}</p>
                            </div>
                            <div className="detail-section">
                                <strong>Recomendaciones Ocupacionales:</strong>
                                <p className="detail-box">{examen.RecomendacionesOcupacionales || 'N/A'}</p>
                            </div>
                            <div className="detail-section">
                                <strong>Compromisos:</strong>
                                <p className="detail-box">{examen.Compromisos || 'N/A'}</p>
                            </div>
                            <div className="detail-section">
                                <strong>Observaciones (Uso Interno):</strong>
                                <p className="detail-box">{examen.Observaciones || 'N/A'}</p>
                            </div>
                        </div>
                    )}
                </div>

                <div className="modal-footer">
                    <button 
                        type="button" 
                        className="btn btn-secondary" 
                        onClick={alCerrar}
                    >
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerExamen;


==================================================================
ARCHIVO: frontend\src\components\ModalVerIndicador.jsx
==================================================================
// frontend/src/components/ModalVerIndicador.jsx

import React from 'react';
import '../style/Modal.css';
import '../index.css'; 
import '../style/InspeccionesPage.css'; // Reutiliza estilos de etiquetas y cajas
import { BsCalendarEvent, BsGraphUp, BsChatLeftText } from 'react-icons/bs';

const ModalVerIndicador = ({ indicador, alCerrar }) => {
    if (!indicador) return null;

    const meses = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
    
    // Helper para formatear números
    const fmt = (num) => (num || 0).toLocaleString('es-CO', { maximumFractionDigits: 2 });

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Detalle del Indicador</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                    
                    {/* CABECERA */}
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', borderBottom: '1px solid #eee', paddingBottom: '1rem', marginBottom: '1rem' }}>
                        <div>
                            <small style={{color: '#666', textTransform: 'uppercase', fontWeight: 'bold'}}>Indicador de Gestión</small>
                            <h3 style={{ margin: 0, color: '#005A5B' }}>{indicador.NombreIndicador}</h3>
                        </div>
                        <div style={{ textAlign: 'right' }}>
                            <div className="status-pill status-proceso" style={{fontSize: '1rem', display: 'flex', alignItems: 'center', gap: '5px'}}>
                                <BsCalendarEvent /> {meses[indicador.Mes - 1]} {indicador.Anio}
                            </div>
                        </div>
                    </div>

                    <div className="inspection-details">
                        
                        {/* RESULTADOS */}
                        <div className="detail-section" style={{backgroundColor: '#f8f9fa', padding: '1rem', borderRadius: '8px', border: '1px solid #e9ecef'}}>
                            <h4 style={{marginTop: 0, color: '#6c757d', borderBottom: '1px solid #ddd', paddingBottom: '5px'}}>
                                <BsGraphUp /> Resultados del Periodo
                            </h4>
                            
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '1rem', marginTop: '1rem'}}>
                                <div>
                                    <strong>Resultado Obtenido:</strong>
                                    <div style={{fontSize: '1.5rem', fontWeight: 'bold', color: '#005A5B'}}>
                                        {indicador.Resultado.toFixed(2)}
                                    </div>
                                </div>
                                <div>
                                    <strong>Meta Establecida:</strong>
                                    <div style={{fontSize: '1.5rem', fontWeight: 'bold', color: '#666'}}>
                                        {indicador.Meta}
                                    </div>
                                </div>
                                <div>
                                    <strong>Variables (Num / Den):</strong>
                                    <div style={{fontSize: '1.1rem'}}>
                                        {fmt(indicador.Numerador)} / {fmt(indicador.Denominador)}
                                    </div>
                                    <small style={{color: '#888'}}>Constante: {indicador.Constante}</small>
                                </div>
                            </div>
                        </div>

                        {/* ANÁLISIS CUALITATIVO (AQUÍ SE VE COMPLETO) */}
                        <div className="detail-section" style={{marginTop: '1.5rem'}}>
                            <h4 style={{marginTop: 0, color: '#6c757d', display: 'flex', alignItems: 'center', gap: '5px'}}>
                                <BsChatLeftText /> Análisis y Gestión
                            </h4>
                            <div className="detail-box" style={{minHeight: '100px', fontSize: '1rem', lineHeight: '1.6'}}>
                                {indicador.Analisis || <span style={{fontStyle:'italic', color:'#999'}}>Sin análisis registrado.</span>}
                            </div>
                        </div>

                    </div>
                </div>

                <div className="modal-footer">
                    <button type="button" className="btn btn-secondary" onClick={alCerrar}>Cerrar</button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerIndicador;


==================================================================
ARCHIVO: frontend\src\components\ModalVerInspeccion.jsx
==================================================================
// frontend/src/componentes/ModalVerInspeccion.jsx

import React, { useState, useEffect } from 'react';
import { getInspeccionDetalle } from '../services/inspectionService';
import InspeccionDetalleRenderer from './InspeccionDetalleRenderer'; 
import '../style/Modal.css';
import '../index.css';
import '../style/InspeccionesPage.css'; 

const ModalVerInspeccion = ({ inspeccionId, alCerrar }) => {
    
    const [inspeccion, setInspeccion] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');

    useEffect(() => {
        // --- VALIDACIÓN: No hacer nada si no hay ID ---
        if (!inspeccionId) {
            return; 
        }
        // ---------------------------------------------

        const cargarDetalle = async () => {
            try {
                setIsLoading(true);
                const data = await getInspeccionDetalle(inspeccionId);
                setInspeccion(data);
            } catch (err) {
                setError(err.message);
            } finally {
                setIsLoading(false);
            }
        };
        cargarDetalle();
    }, [inspeccionId]);

    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        return new Date(fechaISO.split('T')[0] + 'T00:00:00').toLocaleDateString('es-CO');
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Detalle de Inspección #{inspeccionId}</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                    {isLoading && <p>Cargando detalle...</p>}
                    {error && <p className="error-message">{error}</p>}
                    
                    {!isLoading && inspeccion && (
                        <div className="inspection-details">
                            <div className="detail-header-grid" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>
                                <div className="detail-section"><strong>Formulario:</strong> {inspeccion.NombreFormulario}</div>
                                <div className="detail-section"><strong>Fecha:</strong> {formatearFecha(inspeccion.FechaInspeccion)}</div>
                                <div className="detail-section"><strong>Realizado por:</strong> {inspeccion.NombreUsuarioRealizo}</div>
                                <div className="detail-section"><strong>Activo/Área:</strong> {inspeccion.NombreActivo || 'N/A'}</div>
                                <div className="detail-section"><strong>Resultado:</strong> <span className={`status-pill ${inspeccion.ResultadoGeneral === 'OK' ? 'status-activo' : 'status-pendiente'}`} style={{marginLeft: '0.5rem'}}>{inspeccion.ResultadoGeneral}</span></div>
                            </div>
                            <hr style={{margin: '1rem 0'}}/>
                            <InspeccionDetalleRenderer formId={inspeccion.ID_Formulario} jsonString={inspeccion.DatosDiligenciados} />
                            {inspeccion.ObservacionesGenerales && (<div className="detail-section" style={{ marginTop: '2rem' }}><strong>Observaciones Generales:</strong><p className="detail-box">{inspeccion.ObservacionesGenerales}</p></div>)}
                        </div>
                    )}
                </div>
                <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={alCerrar}>Cerrar</button></div>
            </div>
        </div>
    );
};

export default ModalVerInspeccion;


==================================================================
ARCHIVO: frontend\src\components\ModalVerReporte.jsx
==================================================================
// frontend/src/components/ModalVerReporte.jsx

import React, { useState, useEffect } from 'react';
import { getReporteMaquinaDetalle, getReporteSeguridadDetalle } from '../services/reportService';
import '../style/Modal.css';
import '../index.css'; 
import '../style/InspeccionesPage.css';
import { BsSpeedometer2 } from 'react-icons/bs';

const ModalVerReporte = ({ reporte, tipo, alCerrar, alExito }) => {
    const [detalle, setDetalle] = useState(reporte);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');
    const API_BASE_URL = 'http://localhost:5000';

    useEffect(() => {
        const cargarDetalle = async () => {
            try {
                setIsLoading(true);
                let data;
                if (tipo === 'maquina' || tipo === 'Máquina (Pre-uso)') { // Soporte para ambos nombres
                    data = await getReporteMaquinaDetalle(reporte.ID_ReporteMaquina || reporte.id.split('-')[1]);
                } else {
                    data = await getReporteSeguridadDetalle(reporte.ID_ReporteSeguridad || reporte.id.split('-')[1]);
                }
                setDetalle(data); 
                if (alExito) alExito(); 
            } catch (err) { setError(err.message); } finally { setIsLoading(false); }
        };
        cargarDetalle();
    }, [reporte, tipo, alExito]);

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Detalle de Reporte</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                    {isLoading && <p>Cargando...</p>}
                    {error && <p className="modal-error">{error}</p>}
                    
                    {!isLoading && detalle && (
                        <div className="inspection-details">
                            
                            {/* === REPORTE DE MÁQUINA === */}
                            {(tipo === 'maquina' || tipo === 'Máquina (Pre-uso)') ? (
                                <>
                                    <div style={{display:'flex', gap:'1rem', marginBottom:'1rem', backgroundColor:'#f8f9fa', padding:'1rem', borderRadius:'8px'}}>
                                        <div style={{flex:1}}>
                                            <strong>Activo:</strong> {detalle.NombreActivo}
                                            <div style={{fontSize:'0.9rem', color:'#666'}}>{detalle.CodigoActivo} {detalle.Marca ? `- ${detalle.Marca}` : ''}</div>
                                        </div>
                                        <div style={{flex:1}}>
                                            <strong>Reportado por:</strong> {detalle.NombreUsuarioReporta}
                                            <div style={{fontSize:'0.9rem', color:'#666'}}>C.C. {detalle.CedulaUsuarioReporta}</div>
                                        </div>
                                        <div style={{textAlign:'right'}}>
                                            <span className={`status-pill ${detalle.EstadoReportado === 'OK' ? 'status-activo' : 'status-pendiente'}`}>
                                                {detalle.EstadoReportado}
                                            </span>
                                        </div>
                                    </div>

                                    {detalle.Kilometraje && (
                                        <div className="detail-section" style={{color: '#007BFF', fontWeight:'bold'}}>
                                            <BsSpeedometer2 /> Kilometraje: {detalle.Kilometraje.toLocaleString()} km
                                        </div>
                                    )}

                                    <div className="detail-section">
                                        <strong>Fecha:</strong> {new Date(detalle.FechaHoraReporte).toLocaleString('es-CO')}
                                    </div>

                                    {/* CHECKLIST */}
                                    {detalle.DatosReporte && (
                                        <div className="detail-section" style={{marginTop: '1rem'}}>
                                            <strong>Checklist de Verificación:</strong>
                                            <div style={{ background: '#fff', padding: '0.5rem', border: '1px solid #eee', maxHeight: '250px', overflowY: 'auto' }}>
                                                <ul style={{ listStyle: 'none', padding: 0, margin: 0 }}>
                                                    {JSON.parse(detalle.DatosReporte).map((item, idx) => (
                                                        <li key={idx} style={{ display: 'flex', justifyContent: 'space-between', padding: '0.4rem 0', borderBottom: '1px solid #f0f0f0', fontSize: '0.9rem' }}>
                                                            <span>{item.pregunta}</span>
                                                            <span style={{ fontWeight: 'bold', color: item.respuesta === 'No Cumple' ? '#dc3545' : '#28a745' }}>
                                                                {item.respuesta}
                                                            </span>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        </div>
                                    )}

                                    {/* OBSERVACIONES (Siempre visible ahora) */}
                                    <div className="detail-section" style={{marginTop:'1rem'}}>
                                        <strong>Observaciones / Detalles:</strong>
                                        <p className="detail-box" style={{
                                            color: detalle.EstadoReportado === 'Con Problema' ? '#dc3545' : '#333',
                                            borderColor: detalle.EstadoReportado === 'Con Problema' ? '#dc3545' : '#dee2e6'
                                        }}>
                                            {detalle.DescripcionProblema || 'Sin observaciones registradas.'}
                                        </p>
                                    </div>

                                    {detalle.RutaFotoAdjunta && (
                                        <div className="detail-section">
                                            <strong>Evidencia Fotográfica:</strong><br/>
                                            <img src={`${API_BASE_URL}/${detalle.RutaFotoAdjunta.replace(/\\/g, '/')}`} alt="Evidencia" style={{ maxWidth: '100%', marginTop:'0.5rem', borderRadius:'8px', border:'1px solid #ddd' }} />
                                        </div>
                                    )}
                                </>
                            ) : (
                                /* === REPORTE DE SEGURIDAD === */
                                <>
                                    <div className="detail-section"><strong>Tipo:</strong> {detalle.TipoReporte}</div>
                                    <div className="detail-section"><strong>Ubicación:</strong> {detalle.UbicacionArea}</div>
                                    <div className="detail-section"><strong>Descripción:</strong><p className="detail-box">{detalle.Descripcion}</p></div>
                                    {detalle.RutaFotoAdjunta && <img src={`${API_BASE_URL}/${detalle.RutaFotoAdjunta.replace(/\\/g, '/')}`} alt="Evidencia" style={{ maxWidth: '100%' }} />}
                                </>
                            )}
                        </div>
                    )}
                </div>
                <div className="modal-footer">
                    <button type="button" className="btn btn-secondary" onClick={alCerrar}>Cerrar</button>
                </div>
            </div>
        </div>
    );
};
export default ModalVerReporte;


==================================================================
ARCHIVO: frontend\src\components\NotificationBell.jsx
==================================================================
// frontend/src/components/NotificationBell.jsx
import React, { useState, useEffect } from 'react';
import { BsBellFill } from 'react-icons/bs';
import { useNavigate } from 'react-router-dom';
import { apiFetch } from '../services/apiService';
import '../style/Header.css'; // Reutilizamos estilos o creamos nuevos

const NotificationBell = () => {
    const [notificaciones, setNotificaciones] = useState([]);
    const [showDropdown, setShowDropdown] = useState(false);
    const navigate = useNavigate();

    const cargarNotificaciones = async () => {
        try {
            const data = await apiFetch('/notificaciones');
            setNotificaciones(data);
        } catch (err) {
            console.error("Error notificaciones:", err);
        }
    };

    // Polling: Revisar cada 30 segundos si hay nuevas
    useEffect(() => {
        cargarNotificaciones();
        const interval = setInterval(cargarNotificaciones, 30000);
        return () => clearInterval(interval);
    }, []);

    const handleLeida = async (id, ruta) => {
        try {
            await apiFetch(`/notificaciones/${id}/leida`, { method: 'PATCH' });
            setNotificaciones(prev => prev.filter(n => n.ID_Notificacion !== id));
            setShowDropdown(false);
            if (ruta) navigate(ruta);
        } catch (err) { console.error(err); }
    };

    return (
        <div className="notification-container" style={{position: 'relative', marginRight: '1.5rem'}}>
            <div 
                className="bell-icon" 
                onClick={() => setShowDropdown(!showDropdown)}
                style={{cursor: 'pointer', position: 'relative', fontSize: '1.2rem', color: '#6c757d'}}
            >
                <BsBellFill />
                {notificaciones.length > 0 && (
                    <span className="notification-badge" style={{
                        position: 'absolute', top: '-8px', right: '-8px',
                        backgroundColor: '#dc3545', color: 'white', borderRadius: '50%',
                        padding: '2px 6px', fontSize: '0.7rem', fontWeight: 'bold'
                    }}>
                        {notificaciones.length}
                    </span>
                )}
            </div>

            {showDropdown && (
                <div className="notification-dropdown" style={{
                    position: 'absolute', top: '150%', right: '-10px', width: '300px',
                    backgroundColor: 'white', boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                    borderRadius: '8px', zIndex: 1000, border: '1px solid #dee2e6',
                    maxHeight: '300px', overflowY: 'auto'
                }}>
                    <div style={{padding: '10px', borderBottom: '1px solid #eee', fontWeight: 'bold', fontSize: '0.9rem', color: '#333'}}>
                        Notificaciones
                    </div>
                    {notificaciones.length === 0 ? (
                        <div style={{padding: '15px', textAlign: 'center', color: '#999', fontSize: '0.85rem'}}>
                            Sin novedades.
                        </div>
                    ) : (
                        notificaciones.map(n => (
                            <div 
                                key={n.ID_Notificacion} 
                                onClick={() => handleLeida(n.ID_Notificacion, n.RutaAccion)}
                                style={{
                                    padding: '10px', borderBottom: '1px solid #f0f0f0', cursor: 'pointer',
                                    transition: 'background 0.2s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#f8f9fa'}
                                onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'white'}
                            >
                                <div style={{fontWeight: '600', fontSize: '0.9rem', color: '#005A5B'}}>{n.Titulo}</div>
                                <div style={{fontSize: '0.85rem', color: '#555', margin: '2px 0'}}>{n.Mensaje}</div>
                                <div style={{fontSize: '0.7rem', color: '#aaa', textAlign: 'right'}}>
                                    {new Date(n.FechaCreacion).toLocaleString()}
                                </div>
                            </div>
                        ))
                    )}
                </div>
            )}
        </div>
    );
};

export default NotificationBell;


==================================================================
ARCHIVO: frontend\src\components\ProtectedRoutes.jsx
==================================================================
// frontend/src/components/ProtectedRoutes.jsx

import React from 'react';
import { useAuth } from '../context/AuthContext';
import { Navigate, Outlet } from 'react-router-dom';

/**
 * @component ProtectedRoutes
 * @desc Componente para proteger rutas.
 * Si el usuario está autenticado, muestra las rutas hijas (Outlet).
 * Si no, lo redirige a la página de login.
 */
const ProtectedRoutes = () => {
    const { isAuthenticated, isLoading } = useAuth();

    // 1. Mostrar "Cargando..." mientras el AuthContext verifica el token
    if (isLoading) {
        return <div>Cargando sesión...</div>;
    }

    // 2. Si no está autenticado, redirigir a /login
    if (!isAuthenticated) {
        return <Navigate to="/login" replace />;
    }

    // 3. Si está autenticado, mostrar el contenido de la ruta (ej. el Dashboard)
    // 'Outlet' es el marcador de posición de react-router-dom para las rutas anidadas
    return <Outlet />;
};

export default ProtectedRoutes;


==================================================================
ARCHIVO: frontend\src\components\Sidebar.jsx
==================================================================
// frontend/src/components/Sidebar.jsx

import React from 'react';
import { NavLink } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import '../style/Sidebar.css'; 
import logo from "../assets/logo-empaquetados.png";

// --- Importar Iconos ---
import { 
    BsGrid1X2Fill,          // Dashboard
    BsPeopleFill,           // Usuarios
    BsCalendarWeek,         // Planificación
    BsClipboard2CheckFill,  // Inspecciones
    BsExclamationTriangleFill, // Reportes
    BsGraphUpArrow,         // ACPM
    BsHouseFill,            // Inicio Colaborador
    BsCpuFill,              // Reporte Máquina
    BsShieldFillExclamation, // Reporte Seguridad
    BsFillFolderFill,       // Documentos
    BsHeartPulseFill,       // Medicina
    BsArchiveFill,          // Activos
    BsFileEarmarkTextFill,  // Logs
    BsShieldLockFill,       // Super Admin Panel
    BsJournalCheck,         // Calidad
    BsListCheck,            // Gestor Formularios
    BsBarChartFill,         // Indicadores
    BsConeStriped,          // PESV
    BsEnvelopeExclamation   // Solicitudes (NUEVO)
} from 'react-icons/bs';

const Sidebar = ({ isOpen, onClose }) => {
    const { usuario } = useAuth();
    const containerClass = `sidebar-container ${isOpen ? 'open' : ''}`;

    // Detectar Roles
    const isSuperAdmin = usuario?.rol === 'Super Admin';
    const isAdminSST = usuario?.rol === 'Administrador SST';
    const isCalidad = usuario?.rol === 'Gestion de Calidad';

    return (
        <aside className={containerClass}>
            
            <div className="sidebar-logo">
                <img src={logo} alt="Logo Empaquetados El Trece" className="sidebar-logo-img"/>
                <h3>SG-SST App</h3>
                <button className="sidebar-close-btn" onClick={onClose}>&times;</button>
            </div>

            <nav className="sidebar-nav">
                
                {/* =======================================================
                    MENÚ SUPER ADMIN (Exclusivo)
                   ======================================================= */}
                {isSuperAdmin && (
                    <>
                        <div className="sidebar-section-label">SUPER ADMIN</div>
                        
                        <NavLink to="/super-admin/dashboard" className="sidebar-link" onClick={onClose}>
                            <BsShieldLockFill /> Panel de Control
                        </NavLink>
                        
                        <NavLink to="/super-admin/formularios" className="sidebar-link" onClick={onClose}>
                            <BsListCheck /> Gestor de Formularios
                        </NavLink>

                        <NavLink to="/logs" className="sidebar-link" onClick={onClose}>
                            <BsFileEarmarkTextFill /> Auditoría (Logs)
                        </NavLink>
                        
                        <NavLink to="/usuarios" className="sidebar-link" onClick={onClose}>
                            <BsPeopleFill /> Gestión de Usuarios
                        </NavLink>
                        
                        <div className="sidebar-section-label">ACCESOS DIRECTOS</div>
                        <NavLink to="/dashboard" className="sidebar-link" onClick={onClose}>
                            <BsGrid1X2Fill /> Vista General SST
                        </NavLink>
                    </>
                )}

                {/* =======================================================
                    MENÚ GESTIÓN DE CALIDAD
                   ======================================================= */}
                {isCalidad && (
                    <>
                        <div className="sidebar-section-label">CALIDAD</div>
                        <NavLink to="/calidad/dashboard" className="sidebar-link" onClick={onClose}>
                            <BsJournalCheck /> Dashboard Calidad
                        </NavLink>
                        <NavLink to="/documentos" className="sidebar-link" onClick={onClose}>
                            <BsFillFolderFill /> Gestión Documental
                        </NavLink>
                        <NavLink to="/acpm" className="sidebar-link" onClick={onClose}>
                            <BsGraphUpArrow /> Acciones (ACPM)
                        </NavLink>
                    </>
                )}

                {/* =======================================================
                    MENÚ ADMINISTRADOR SST (y Super Admin para ver herramientas)
                   ======================================================= */}
                {(isAdminSST || isSuperAdmin) && (
                    <>
                        <div className="sidebar-section-label">MÓDULOS SST</div>

                        {!isSuperAdmin && (
                            <NavLink to="/dashboard" className="sidebar-link" onClick={onClose}>
                                <BsGrid1X2Fill /> Dashboard
                            </NavLink>
                        )}

                        {!isSuperAdmin && (
                            <NavLink to="/usuarios" className="sidebar-link" onClick={onClose}>
                                <BsPeopleFill /> Usuarios
                            </NavLink>
                        )}
                        
                        {/* --- GESTIÓN OPERATIVA --- */}
                        <NavLink to="/solicitudes" className="sidebar-link" onClick={onClose}>
                            <BsEnvelopeExclamation /> Solicitudes y Aprobaciones
                        </NavLink>

                        <NavLink to="/indicadores" className="sidebar-link" onClick={onClose}>
                            <BsBarChartFill /> Indicadores de Gestión
                        </NavLink>

                        <NavLink to="/pesv" className="sidebar-link" onClick={onClose}>
                            <BsConeStriped /> Gestión PESV
                        </NavLink>

                        <NavLink to="/activos" className="sidebar-link" onClick={onClose}>
                            <BsArchiveFill /> Gestión de Activos
                        </NavLink>
                        <NavLink to="/planificacion" className="sidebar-link" onClick={onClose}>
                            <BsCalendarWeek /> Planificación
                        </NavLink>
                        <NavLink to="/inspecciones" className="sidebar-link" onClick={onClose}>
                            <BsClipboard2CheckFill /> Inspecciones
                        </NavLink>
                        <NavLink to="/reportes" className="sidebar-link" onClick={onClose}>
                            <BsExclamationTriangleFill /> Reportes
                        </NavLink>
                        <NavLink to="/acpm" className="sidebar-link" onClick={onClose}>
                            <BsGraphUpArrow /> Acciones (ACPM)
                        </NavLink>
                        <NavLink to="/documentos" className="sidebar-link" onClick={onClose}>
                            <BsFillFolderFill /> Gestión Documental
                        </NavLink>
                        <NavLink to="/medicina" className="sidebar-link" onClick={onClose}>
                            <BsHeartPulseFill /> Medicina Laboral
                        </NavLink>
                    </>
                )}

                {/* =======================================================
                    MENÚ COLABORADOR
                   ======================================================= */}
                {(!isSuperAdmin && !isAdminSST && !isCalidad) && (
                    <>
                        <div className="sidebar-section-label">COLABORADOR</div>
                        <NavLink to="/dashboard" className="sidebar-link" onClick={onClose}>
                            <BsHouseFill /> Inicio
                        </NavLink>
                        <NavLink to="/reportar-maquina" className="sidebar-link" onClick={onClose}>
                            <BsCpuFill /> Reportar Máquina
                        </NavLink>
                        <NavLink to="/reportar-seguridad" className="sidebar-link" onClick={onClose}>
                            <BsShieldFillExclamation /> Reportar Seguridad
                        </NavLink>
                    </>
                )}

            </nav>

            <div className="sidebar-footer">
                <span style={{padding: '1rem', fontSize: '0.75rem', color: '#ffffff80', display: 'block', textAlign: 'center'}}>
                    {usuario?.nombre}<br/>
                    <strong style={{ color: 'white' }}>{usuario?.rol}</strong>
                </span>
            </div>
        </aside>
    );
};

export default Sidebar;


==================================================================
ARCHIVO: frontend\src\components\TabPasosPESV.jsx
==================================================================
// frontend/src/components/TabPasosPESV.jsx

import React, { useState, useEffect } from 'react';
import { apiFetch } from '../services/apiService'; 
import { useAuth } from '../context/AuthContext'; 
import '../index.css';
import Swal from 'sweetalert2';
import { BsFileEarmarkPdf, BsMagic, BsUpload, BsEye, BsPencil, BsTrash, BsPlusLg, BsInputCursorText } from 'react-icons/bs';

import ModalGenerarDocumento from './ModalGenerarDocumento';
import ModalVerEvidencia from './ModalVerEvidencia';
import ModalGuardarPaso from './ModalGuardarPaso';         
import ModalConfigurarPlantilla from './ModalConfigurarPlantilla'; 

const TabPasosPESV = () => {
    const { usuario } = useAuth();
    const [pasos, setPasos] = useState([]);
    // eslint-disable-next-line no-unused-vars
    const [isLoading, setIsLoading] = useState(true);
    
    // Estados Modales
    const [pasoSeleccionado, setPasoSeleccionado] = useState(null);
    const [modalGenerarOpen, setModalGenerarOpen] = useState(false);
    const [modalGestionarOpen, setModalGestionarOpen] = useState(false);
    const [modalVerEvidenciaOpen, setModalVerEvidenciaOpen] = useState(false);
    const [modalCRUDOpen, setModalCRUDOpen] = useState(false); 
    const [modalConfigOpen, setModalConfigOpen] = useState(false); 

    // Estados Gestión Manual
    const [file, setFile] = useState(null);
    const [nuevoEstado, setNuevoEstado] = useState('');
    
    // Estados Visualizar
    const [evidenciasVisualizar, setEvidenciasVisualizar] = useState([]);
    const [nombrePasoVisualizar, setNombrePasoVisualizar] = useState('');

    const esSuperAdmin = usuario.rol === 'Super Admin';

    useEffect(() => { cargarPasos(); }, []);

    const cargarPasos = async () => {
        try {
            const data = await apiFetch('/pesv/pasos');
            setPasos(data);
        } catch (error) { console.error(error); } finally { setIsLoading(false); }
    };

    // --- CRUD PASOS ---
    const handleNuevoPaso = () => { setPasoSeleccionado(null); setModalCRUDOpen(true); };
    const handleEditarPaso = (paso) => { setPasoSeleccionado(paso); setModalCRUDOpen(true); };
    const handleDiseñarFormulario = (paso) => { setPasoSeleccionado(paso); setModalConfigOpen(true); };

    const handleEliminarPaso = async (paso) => {
        const result = await Swal.fire({
            title: '¿Eliminar paso?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Sí, eliminar'
        });
        if (result.isConfirmed) {
            try {
                await apiFetch(`/pesv/pasos/${paso.ID_Paso}`, { method: 'DELETE' });
                Swal.fire('Eliminado', 'Paso eliminado.', 'success');
                cargarPasos();
            } catch (error) { Swal.fire('Error', error.message, 'error'); }
        }
    };

    // --- VER EVIDENCIAS ---
    const handleVerEvidencias = async (paso) => {
        if (paso.CantidadEvidencias === 0) return;
        try {
            const archivos = await apiFetch(`/pesv/pasos/${paso.ID_Paso}/evidencias`);
            setEvidenciasVisualizar(archivos);
            setNombrePasoVisualizar(paso.NombrePaso);
            setModalVerEvidenciaOpen(true);
        // eslint-disable-next-line no-unused-vars
        } catch (error) { Swal.fire('Error', 'No se cargaron archivos', 'error'); }
    };

    // --- GESTIÓN MANUAL ---
    const abrirGestionar = (paso) => {
        setPasoSeleccionado(paso);
        setNuevoEstado(paso.Estado);
        setFile(null);
        setModalGestionarOpen(true);
    };

    const handleGuardarManual = async () => {
        if (!pasoSeleccionado) return;
        const formData = new FormData();
        formData.append('idPaso', pasoSeleccionado.ID_Paso);
        formData.append('estado', nuevoEstado);
        if (file) formData.append('evidencia', file);

        try {
            const token = localStorage.getItem('token');
            const response = await fetch('http://localhost:5000/api/pesv/pasos/actualizar', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });
            if (response.ok) {
                Swal.fire('Actualizado', 'Paso actualizado.', 'success');
                setModalGestionarOpen(false);
                cargarPasos();
            } else throw new Error('Error');
        } catch (error) { Swal.fire('Error', error.message, 'error'); }
    };

    const getEstadoColor = (estado) => {
        if (estado === 'Realizada' || estado === 'Realizado') return 'status-activo';
        if (estado === 'En Proceso') return 'status-proceso';
        return 'status-pendiente';
    };

    const avance = pasos.length > 0 ? Math.round((pasos.filter(p => p.Estado === 'Realizado').length / pasos.length) * 100) : 0;

    return (
        <div className="table-wrapper">
            <div style={{marginBottom: '1.5rem', padding: '1rem', backgroundColor: '#eef2f7', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'space-between'}}>
                <div>
                    <h3 style={{margin:0, color: '#005A5B'}}>Avance PESV</h3>
                    <p style={{margin:0, color:'#666'}}>Ciclo PHVA</p>
                </div>
                <div style={{display:'flex', alignItems:'center', gap:'20px'}}>
                    {esSuperAdmin && (
                        <button className="btn btn-primary" onClick={handleNuevoPaso}>
                            <BsPlusLg /> Nuevo Paso
                        </button>
                    )}
                    <div style={{textAlign:'right'}}>
                        <div style={{fontSize: '2rem', fontWeight: 'bold', color: avance === 100 ? '#28a745' : '#005A5B'}}>{avance}%</div>
                        <small>Cumplimiento</small>
                    </div>
                </div>
            </div>

            <table className="data-table">
                <thead>
                    <tr>
                        <th style={{width:'50px'}}>#</th>
                        <th>Requisito</th>
                        <th>Normativa</th>
                        <th>Evidencias</th>
                        <th>Estado</th>
                        <th style={{width:'200px'}}>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    {pasos.map(p => (
                        <tr key={p.ID_Paso}>
                            <td><strong>{p.NumeroPaso}</strong></td>
                            <td><strong>{p.NombrePaso}</strong></td>
                            <td style={{fontSize:'0.85rem', color:'#666'}}>{p.DescripcionNorma}</td>
                            
                            {/* COLUMNA EVIDENCIAS (CLICKEABLE) */}
                            <td style={{cursor: p.CantidadEvidencias > 0 ? 'pointer' : 'default'}} onClick={() => handleVerEvidencias(p)}>
                                {p.CantidadEvidencias > 0 ? (
                                    <div className="status-pill" style={{backgroundColor:'#e7f1ff', color:'#007BFF', display:'inline-flex', alignItems:'center', gap:'5px', border:'1px solid #007BFF'}}>
                                        <BsEye /> {p.CantidadEvidencias}
                                    </div>
                                ) : <span style={{color:'#999', fontSize:'0.8rem'}}>--</span>}
                            </td>

                            <td><span className={`status-pill ${getEstadoColor(p.Estado)}`}>{p.Estado}</span></td>
                            
                            <td>
                                <div style={{display: 'flex', gap: '5px', flexWrap: 'wrap'}}>
                                    <button className="btn btn-sm btn-magic" title="Generar" onClick={() => { setPasoSeleccionado(p); setModalGenerarOpen(true); }}><BsMagic /></button>
                                    <button className="btn btn-sm btn-action" title="Gestionar" onClick={() => abrirGestionar(p)}><BsUpload /></button>
                                    
                                    {esSuperAdmin && (
                                        <>
                                            <button className="btn btn-sm" style={{backgroundColor:'#fd7e14', color:'white'}} title="Diseñar" onClick={() => handleDiseñarFormulario(p)}><BsInputCursorText /></button>
                                            <button className="btn btn-sm btn-warning" title="Editar" onClick={() => handleEditarPaso(p)}><BsPencil /></button>
                                            <button className="btn btn-sm btn-danger" title="Eliminar" onClick={() => handleEliminarPaso(p)}><BsTrash /></button>
                                        </>
                                    )}
                                </div>
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>

            {/* MODALES */}
            {modalGestionarOpen && (
                <div className="modal-overlay" onClick={() => setModalGestionarOpen(false)}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header"><h3>Gestión Manual</h3><button className="modal-close-button" onClick={() => setModalGestionarOpen(false)}>&times;</button></div>
                        <div className="modal-body">
                            <div className="form-group"><label>Estado</label><select className="form-control" value={nuevoEstado} onChange={e => setNuevoEstado(e.target.value)}><option>Pendiente</option><option>En Proceso</option><option>Realizado</option></select></div>
                            <div className="form-group"><label>Evidencia</label><input type="file" className="form-control" onChange={e => setFile(e.target.files[0])} /></div>
                        </div>
                        <div className="modal-footer"><button className="btn btn-secondary" onClick={() => setModalGestionarOpen(false)}>Cancelar</button><button className="btn btn-primary" onClick={handleGuardarManual}>Guardar</button></div>
                    </div>
                </div>
            )}

            {modalGenerarOpen && <ModalGenerarDocumento paso={pasoSeleccionado} alCerrar={() => setModalGenerarOpen(false)} alExito={() => { setModalGenerarOpen(false); cargarPasos(); }} />}
            {modalVerEvidenciaOpen && <ModalVerEvidencia archivos={evidenciasVisualizar} pasoNombre={nombrePasoVisualizar} alCerrar={() => setModalVerEvidenciaOpen(false)} />}
            
            {modalCRUDOpen && <ModalGuardarPaso paso={pasoSeleccionado} alCerrar={() => setModalCRUDOpen(false)} alExito={() => { setModalCRUDOpen(false); cargarPasos(); }} />}
            {modalConfigOpen && <ModalConfigurarPlantilla paso={pasoSeleccionado} alCerrar={() => setModalConfigOpen(false)} />}
        </div>
    );
};

export default TabPasosPESV;


==================================================================
ARCHIVO: frontend\src\context\AuthContext.jsx
==================================================================
// frontend/src/context/AuthContext.jsx

import { createContext, useContext, useState, useEffect } from 'react';
import { jwtDecode } from 'jwt-decode'; // Importamos el decodificador
import * as authService from '../services/authService';

// 1. Crear el Contexto
const AuthContext = createContext();

// 2. Crear el Proveedor (Provider)
export const AuthProvider = ({ children }) => {
    const [token, setToken] = useState(null);
    const [usuario, setUsuario] = useState(null); // { id, nombre, rol }
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [isLoading, setIsLoading] = useState(true); // Para la carga inicial

    useEffect(() => {
        // Comprobar si ya existe un token en localStorage al cargar la app
        setIsLoading(true);
        const storedToken = authService.getCurrentToken();
        
        if (storedToken) {
            try {
                // Decodificamos el token para obtener la info del usuario
                const decoded = jwtDecode(storedToken); 
                
                // Comprobamos si el token ha expirado
                if (decoded.exp * 1000 < Date.now()) {
                    authService.logout(); // Token expirado, lo borramos
                } else {
                    // Token válido
                    setToken(storedToken);
                    setUsuario(decoded.usuario); // { id, nombre, rol }
                    setIsAuthenticated(true);
                }
            } catch (error) {
                console.error("Error decodificando el token:", error);
                authService.logout(); // Token corrupto, lo borramos
            }
        }
        setIsLoading(false);
    }, []);

    // Función de Login que se llamará desde la página de Login
    const login = async (cedula, password) => {
        // Llama al servicio de API
        const data = await authService.login(cedula, password);

        // Si tuvo éxito, el servicio ya guardó el token en localStorage
        const decoded = jwtDecode(data.token);
        
        // Actualizamos el estado global
        setToken(data.token);
        setUsuario(decoded.usuario);
        setIsAuthenticated(true);
    };

    // Función de Logout
    const logout = () => {
        authService.logout(); // Borra de localStorage
        // Resetea el estado global
        setToken(null);
        setUsuario(null);
        setIsAuthenticated(false);
    };

    // El valor que compartiremos a toda la app
    const value = {
        token,
        usuario, // El objeto { id, nombre, rol }
        isAuthenticated,
        isLoading,
        login, // La función de login
        logout, // La función de logout
    };

    return (
        <AuthContext.Provider value={value}>
            {children}
        </AuthContext.Provider>
    );
};

// 3. Crear un Hook personalizado para usar el contexto fácilmente
// eslint-disable-next-line react-refresh/only-export-components
export const useAuth = () => {
    const context = useContext(AuthContext);
    if (!context) {
        throw new Error('useAuth debe ser usado dentro de un AuthProvider');
    }
    return context;
};


==================================================================
ARCHIVO: frontend\src\index.css
==================================================================
/* frontend/src/index.css (Global y Responsive) */
@import 'sweetalert2/dist/sweetalert2.min.css';

/* --- 1. VARIABLES DE DISEÑO (TEMA PROFESIONAL) --- */
:root {
    /* Paleta de Colores */
    --color-primario: #005A5B; /* Verde Oscuro (Teal) */
    --color-primario-hover: #004B4C;
    --color-acento: #007BFF; /* Azul Acento */
    --color-acento-hover: #0056b3;
    --color-danger: #f37683; /* Rojo */
    --color-danger-hover: #c82333;
    --color-warning: #f1ce63; /* Amarillo */
    --color-warning-hover: #e0a800;
    --color-secondary: #6c757d; /* Gris */
    --color-secondary-hover: #5a6268;
    --color-success: #28a745; /* Verde 'OK' */
    --color-success-hover: #218838;
    

    /* Paleta de UI */
    --color-bg: #f4f7f6; /* Fondo de página */
    --color-card: #ffffff;
    --color-text: #212529;
    --color-text-secondary: #6c757d;
    --color-border: #dee2e6;

    /* Sombras y Bordes */
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.05);
    --border-radius: 8px;
}

/* --- 2. RESET Y ESTILOS BASE (PARA CENTRAR EL LOGIN) --- */
body, html {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--color-bg); 
    color: var(--color-text);
}
body, #root {
    width: 100%;
    min-height: 100vh;
    display: flex;
    justify-content: center; /* Centra horizontalmente */
    align-items: center;    /* Centra verticalmente */
    box-sizing: border-box;
}
#root.layout-activo {
    display: block; /* Desactiva el centrado cuando estás logueado */
    min-height: 100vh;
}

/* --- 3. ESTILOS DE LAYOUT DE PÁGINA REUTILIZABLES --- */
.page-container {
    width: 100%;
}
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap; 
    gap: 1rem; 
}
.page-header h1 {
    font-size: 2rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0;
}
.page-content-card {
    background-color: var(--color-card);
    border-radius: var(--border-radius);
    padding: 2rem;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--color-border);
    /* Agregado sutil para evitar desbordes, pero sin cambiar tu diseño */
    overflow: hidden; 
    max-width: 100%;
}

/* --- 4. CLASES DE BOTONES GLOBALES --- */
.btn {
    padding: 0.75rem 1.25rem;
    border: none;
    border-radius: var(--border-radius);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-flex; 
    align-items: center;
    justify-content: center;
    gap: 0.5rem; 
    white-space: nowrap;
}
.btn:disabled {
    background-color: #aaa;
    color: #eee;
    box-shadow: none;
    cursor: not-allowed;
}
.btn-primary { background-color: var(--color-acento); color: white; }
.btn-primary:hover:not(:disabled) { background-color: var(--color-acento-hover); }
.btn-secondary { background-color: var(--color-secondary); color: white; }
.btn-secondary:hover:not(:disabled) { background-color: var(--color-secondary-hover); }
.btn-danger { background-color: var(--color-danger); color: white; }
.btn-danger:hover:not(:disabled) { background-color: var(--color-danger-hover); }
.btn-warning { background-color: var(--color-warning); color: var(--color-text); }
.btn-warning:hover:not(:disabled) { background-color: var(--color-warning-hover); }
.btn-success { background-color: var(--color-success); color: white; }
.btn-success:hover:not(:disabled) { background-color: var(--color-success-hover); }
.btn-icon {
    background-color: transparent;
    border: 1px solid var(--color-border);
    color: var(--color-secondary);
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
}
.btn-icon:hover { background-color: #f8f9fa; }
.btn-icon svg {
    width: 14px;
    height: 14px;
}

/* --- 5. ESTILOS DE FORMULARIO GLOBALES --- */
.form-group { margin-bottom: 1.5rem; }
.form-group label { display: block; font-size: 0.9rem; font-weight: 600; color: var(--color-text-secondary); margin-bottom: 0.5rem; }
.form-group input[type="text"],
.form-group input[type="password"],
.form-group input[type="number"],
.form-group input[type="date"],
.form-group input[type="file"],
.form-group select,
.form-group textarea {
    width: 100%; padding: 0.8rem; font-size: 1rem; border: 1px solid var(--color-border);
    border-radius: var(--border-radius); box-sizing: border-box; font-family: inherit; background-color: #fff;
}
.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none; border-color: var(--color-acento); box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}
.form-group textarea { resize: vertical; min-height: 80px; }

/* --- 6. ESTILOS DE TABLA GLOBALES Y RESPONSIVE --- */
.table-wrapper {
    width: 100%;
    overflow-x: auto; /* Permite scroll horizontal */
}
.data-table {
    width: 100%;
    border-collapse: collapse; 
    min-width: 900px; /* Ancho mínimo para forzar el scroll */
}
.data-table th, .data-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
}
.data-table th {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    background-color: #f8f9fa;
}
.data-table td {
    font-size: 0.95rem;
    color: var(--color-text);
}
.data-table tr:hover {
    background-color: #f8f9fa;
}
.action-buttons {
    white-space: nowrap;
    display: flex;
    gap: 0.5rem;
}

/* --- 7. PÍLDORAS DE ESTADO GLOBALES --- */
.status-pill { padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; white-space: nowrap; }
.status-activo { background-color: #e6f7ec; color: #005A5B; }
.status-pendiente { background-color: #fff8e1; color: #f57f17; }
.status-inactivo { background-color: #fbebee; color: #dc3545; }
.status-proceso { background-color: #e7f3ff; color: #007BFF; }

/* --- 8. MENSAJES GLOBALES --- */
.error-message { color: var(--color-danger); font-weight: 500; text-align: center; }
.success-message { color: var(--color-success); font-weight: 600; text-align: center; background-color: #e6f7ec; padding: 1rem; border-radius: var(--border-radius); }

/* --- 9. RESPONSIVIDAD GLOBAL --- */
@media (max-width: 768px) {
    body, #root {
        align-items: flex-start; 
    }
    .page-header { flex-direction: column; align-items: flex-start; }
    .page-content-card { padding: 1rem; }
    .action-buttons { flex-direction: column; width: 120px; }
}

/* ==========================================================================
   10. NUEVOS ESTILOS PARA FILTROS (Diseño limpio y corregido)
   ========================================================================== */

/* Contenedor de la barra de filtros */
.filters-bar {
    background-color: #ffffff;
    padding: 1rem; /* Padding original cómodo */
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.06);
    border: 1px solid #eff2f5;
    
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    
    /* ESTA es la clave para que no se monten: permitir salto de línea */
    flex-wrap: wrap; 
}

/* Contenedor del Input de Búsqueda */
.search-input-container {
    position: relative;
    /* Flex grow + Flex basis para que ocupe espacio pero tenga un mínimo sano */
    flex: 2 1 300px; 
    min-width: 250px; /* Evita que se aplaste demasiado */
}

/* Icono de Lupa */
.search-input-container svg {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: #98a2b3;
    font-size: 1rem;
    pointer-events: none;
    z-index: 2;
}

/* Input de Texto (Estilo Píldora) */
.search-input-container input.form-control {
    width: 100%;
    height: 46px; /* Altura fija para alinear */
    padding-left: 42px !important; /* Espacio para la lupa */
    border-radius: 50px; /* Redondeado completo */
    border: 1px solid #e0e0e0;
    background-color: #f8f9fa;
    font-size: 0.95rem;
    box-shadow: none;
    transition: all 0.2s ease;
    box-sizing: border-box; /* Asegura que no se desborde */
}

/* Efecto Focus */
.search-input-container input.form-control:focus {
    background-color: #ffffff;
    border-color: var(--color-acento);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
}

/* Contenedor del Selector */
.filter-select-container {
    /* Ocupa menos espacio que el buscador, pero tiene un ancho base */
    flex: 1 1 200px; 
    min-width: 200px;
}

/* Selector (Dropdown) */
.filter-select-container select.form-control {
    width: 100%;
    height: 46px; /* Misma altura que el buscador */
    border-radius: 10px; /* Bordes un poco menos redondos */
    border: 1px solid #e0e0e0;
    background-color: #ffffff;
    padding-left: 1rem;
    cursor: pointer;
    color: var(--color-text);
    font-weight: 500;
    box-sizing: border-box;
}

.filter-select-container select.form-control:focus {
    border-color: var(--color-acento);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
    outline: none;
}


/* Ajuste Responsive (Celulares) */
@media (max-width: 768px) {
    .filters-bar {
        flex-direction: column;
        align-items: stretch; /* Estira al ancho completo */
        gap: 1rem;
    }
    
    .search-input-container, 
    .filter-select-container {
        flex: 1 1 100%;
        width: 100%;
        min-width: 100%;
    }
}


==================================================================
ARCHIVO: frontend\src\layout\ColaboradorLayout.jsx
==================================================================
// frontend/src/layout/ColaboradorLayout.jsx

import React from 'react';
import { Outlet } from 'react-router-dom';
import Header from '../components/Header'; // Importamos el Header (que ya tiene logout)
import '../style/ColaboradorLayout.css'; // CSS nuevo

const ColaboradorLayout = () => {
    return (
        <div className="colaborador-layout">
            {/* 1. Header en la parte superior */}
            <Header />

            {/* 2. Contenido de la página (se renderiza aquí) */}
            <main className="colaborador-page-content">
                <Outlet />
            </main>
        </div>
    );
};

export default ColaboradorLayout;


==================================================================
ARCHIVO: frontend\src\layout\MainLayout.jsx
==================================================================
// frontend/src/layout/MainLayout.jsx

import React from 'react';
import { Outlet } from 'react-router-dom';
import Sidebar from '../components/Sidebar'; // Importamos el Sidebar real
import Header from '../components/Header';   // Importamos el Header real
import '../style/MainLayout.css'; // Importamos el CSS del layout

/**
 * @component MainLayout
 * @desc El layout principal de la aplicación autenticada.
 */
const MainLayout = () => {
    return (
        <div className="app-layout">
            
            {/* --- 1. Barra Lateral Fija --- */}
            <Sidebar />

            {/* --- 2. Contenedor Principal (derecha) --- */}
            <div className="main-content-wrapper">
                
                {/* --- Barra Superior --- */}
                <Header />
                
                {/* 'Outlet' renderizará la página actual (ej. Dashboard) */}
                <main className="page-content">
                    <Outlet />
                </main>
            </div>
        </div>
    );
};

export default MainLayout;


==================================================================
ARCHIVO: frontend\src\main.jsx
==================================================================
// frontend/src/main.jsx

import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App.jsx';
import { BrowserRouter } from 'react-router-dom';
import { AuthProvider } from './context/AuthContext'; // <--- Importa tu AuthProvider
// Asumo que tienes un index.css global
import './index.css'; 

ReactDOM.createRoot(document.getElementById('root')).render(
    <React.StrictMode>
        {/* 1. Envuelve todo con el AuthProvider */}
        <AuthProvider>
            {/* 2. Envuelve todo con el BrowserRouter */}
            <BrowserRouter>
                <App />
            </BrowserRouter>
        </AuthProvider>
    </React.StrictMode>,
);


==================================================================
ARCHIVO: frontend\src\pages\AcpmPage.jsx
==================================================================
// frontend/src/pages/AcpmPage.jsx

import React, { useState, useEffect, useMemo } from 'react';
import { getACPMs } from '../services/acpmService';
import '../index.css'; 
import { BsPlusLg, BsSearch } from 'react-icons/bs';

import ModalCrearACPM from '../components/ModalCrearACPM.jsx'; 
import ModalGestionarACPM from '../components/ModalGestionarACPM.jsx';
import ModalVerACPM from '../components/ModalVerACPM.jsx'; 

const AcpmPage = () => {
    // --- Estados ---
    const [acpmLista, setAcpmLista] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);

    // --- Estados de Filtros (NUEVOS) ---
    const [busqueda, setBusqueda] = useState('');
    const [filtroEstado, setFiltroEstado] = useState('');

    // --- Estados de Modales ---
    const [modalCrearAbierto, setModalCrearAbierto] = useState(false);
    const [modalGestionarAbierto, setModalGestionarAbierto] = useState(false);
    const [modalVerAbierto, setModalVerAbierto] = useState(false); 
    const [acpmSeleccionada, setAcpmSeleccionada] = useState(null); 

    // --- Carga Inicial ---
    const cargarACPMs = async () => {
        try {
            setIsLoading(true);
            const data = await getACPMs();
            setAcpmLista(data);
            setError(null);
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    useEffect(() => {
        cargarACPMs();
    }, []);

    // --- LÓGICA DE FILTRADO (NUEVA) ---
    const acpmFiltradas = useMemo(() => {
        return acpmLista.filter((acpm) => {
            const texto = busqueda.toLowerCase();
            
            // 1. Búsqueda por Descripción, Origen o ID
            const matchTexto = 
                acpm.DescripcionProblema.toLowerCase().includes(texto) ||
                acpm.Origen.toLowerCase().includes(texto) ||
                acpm.ID_ACPM.toString().includes(texto);

            // 2. Filtro por Estado
            const matchEstado = filtroEstado ? acpm.EstadoACPM === filtroEstado : true;

            return matchTexto && matchEstado;
        });
    }, [acpmLista, busqueda, filtroEstado]);

    // --- Manejadores de Modal (Sin cambios) ---
    const handleAcpmCreada = () => { setModalCrearAbierto(false); cargarACPMs(); };
    
    const abrirModalGestionar = (acpm) => { setAcpmSeleccionada(acpm); setModalGestionarAbierto(true); };
    const cerrarModalGestionar = () => { setModalGestionarAbierto(false); setAcpmSeleccionada(null); };
    const handleAcpmGestionada = () => { cerrarModalGestionar(); cargarACPMs(); };

    const abrirModalVer = (acpm) => { setAcpmSeleccionada(acpm); setModalVerAbierto(true); };
    const cerrarModalVer = () => { setModalVerAbierto(false); setAcpmSeleccionada(null); };

    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        const fecha = new Date(fechaISO.split('T')[0] + 'T00:00:00');
        return fecha.toLocaleDateString('es-CO');
    };

    const getEstadoClass = (estado) => {
        if (estado === 'Abierta') return 'status-pendiente'; 
        if (estado === 'En Proceso') return 'status-proceso'; 
        if (estado === 'Cerrada') return 'status-activo'; 
        return 'status-inactivo'; 
    };

    return (
        <div className="page-container">
            {/* --- Encabezado --- */}
            <div className="page-header">
                <h1>Gestión de Acciones (ACPM)</h1>
                <button className="btn btn-primary" onClick={() => setModalCrearAbierto(true)}>
                    <BsPlusLg /> Crear Nueva ACPM
                </button>
            </div>

            {/* --- BARRA DE FILTROS (NUEVA) --- */}
            <div className="filters-bar" style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                {/* Input Búsqueda */}
                <div className="search-input-container" style={{ flex: 1, minWidth: '250px', position: 'relative' }}>
                    <BsSearch style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#aaa' }} />
                    <input 
                        type="text" 
                        className="form-control" 
                        placeholder="Buscar por descripción, origen o ID..." 
                        style={{ paddingLeft: '35px', height: '40px' }}
                        value={busqueda}
                        onChange={(e) => setBusqueda(e.target.value)}
                    />
                </div>

                {/* Select Estado */}
                <div className="filter-select-container" style={{ minWidth: '200px' }}>
                    <select 
                        className="form-control"
                        style={{ height: '40px' }}
                        value={filtroEstado}
                        onChange={(e) => setFiltroEstado(e.target.value)}
                    >
                        <option value="">Todos los Estados</option>
                        <option value="Abierta">Abierta</option>
                        <option value="En Proceso">En Proceso</option>
                        <option value="Cerrada">Cerrada</option>
                    </select>
                </div>
            </div>

            {/* --- Tabla --- */}
            <div className="page-content-card">
                <div className="table-wrapper">
                    {isLoading && <p>Cargando acciones ACPM...</p>}
                    {error && <p className="error-message">Error: {error}</p>}
                    
                    {!isLoading && !error && (
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Tipo</th>
                                    <th>Origen</th>
                                    <th>Descripción</th>
                                    <th>Responsable</th>
                                    <th>Fecha Límite</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {acpmFiltradas.length === 0 ? (
                                    <tr><td colSpan="8" style={{ textAlign: 'center' }}>No se encontraron acciones.</td></tr>
                                ) : (
                                    acpmFiltradas.map((acpm) => (
                                        <tr key={acpm.ID_ACPM}>
                                            <td>{acpm.ID_ACPM}</td>
                                            <td>{acpm.TipoAccion}</td>
                                            <td>{acpm.Origen}</td>
                                            <td title={acpm.DescripcionProblema}>{acpm.DescripcionProblema.substring(0, 30)}...</td>
                                            <td>{acpm.NombreResponsable}</td>
                                            <td>{formatearFecha(acpm.FechaLimite)}</td>
                                            <td>
                                                <span className={`status-pill ${getEstadoClass(acpm.EstadoACPM)}`}>
                                                    {acpm.EstadoACPM}
                                                </span>
                                            </td>
                                            <td className="action-buttons">
                                                <button 
                                                    className="btn btn-secondary"
                                                    onClick={() => abrirModalVer(acpm)} 
                                                >
                                                    Ver
                                                </button>
                                                {acpm.EstadoACPM !== 'Cerrada' && (
                                                    <button 
                                                        className="btn btn-warning"
                                                        onClick={() => abrirModalGestionar(acpm)} 
                                                    >
                                                        Gestionar
                                                    </button>
                                                )}
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>
            
            {/* --- Modales --- */}
            {modalCrearAbierto && <ModalCrearACPM alCerrar={() => setModalCrearAbierto(false)} alExito={handleAcpmCreada} />}
            {modalGestionarAbierto && <ModalGestionarACPM acpm={acpmSeleccionada} alCerrar={cerrarModalGestionar} alExito={handleAcpmGestionada} />}
            {modalVerAbierto && <ModalVerACPM acpmId={acpmSeleccionada.ID_ACPM} alCerrar={cerrarModalVer} />}
        </div>
    );
};

export default AcpmPage;


==================================================================
ARCHIVO: frontend\src\pages\ActivosPage.jsx
==================================================================
// frontend/src/pages/ActivosPage.jsx

import React, { useState, useEffect, useMemo } from 'react';
import { getActivosTodos, eliminarActivo, getTiposActivosDisponibles } from '../services/assetService';
import '../index.css';
// IMPORTANTE: Asegúrate de tener BsEyeFill aquí
import { BsPlusLg, BsSearch, BsPencilSquare, BsTrash, BsEyeFill } from 'react-icons/bs';

import ModalCrearActivo from '../components/ModalCrearActivo';
import ModalEditarActivo from '../components/ModalEditarActivo';
import ModalConfirmarAccion from '../components/ModalConfirmarAccion';
import ModalVerDetalleActivo from '../components/ModalVerDetalleActivo';
import Swal from 'sweetalert2';

const ActivosPage = () => {
    const [activos, setActivos] = useState([]);
    const [tiposDisponibles, setTiposDisponibles] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);

    // Filtros
    const [busqueda, setBusqueda] = useState('');
    const [filtroTipo, setFiltroTipo] = useState('');

    // Modales
    const [modalCrearAbierto, setModalCrearAbierto] = useState(false);
    const [modalEditarAbierto, setModalEditarAbierto] = useState(false);
    const [modalConfirmarAbierto, setModalConfirmarAbierto] = useState(false);
    const [modalVerDetalleAbierto, setModalVerDetalleAbierto] = useState(false);
    
    const [activoSeleccionado, setActivoSeleccionado] = useState(null);

    const cargarActivos = async () => {
        try {
            setIsLoading(true);
            const [dataActivos, dataTipos] = await Promise.all([
                getActivosTodos(),
                getTiposActivosDisponibles()
            ]);
            setActivos(dataActivos);
            setTiposDisponibles(dataTipos);
            setError(null);
        } catch (err) {
            console.error("Error:", err.message);
            setError("No se pudieron cargar los activos.");
        } finally {
            setIsLoading(false);
        }
    };

    useEffect(() => {
        cargarActivos();
    }, []);

    const activosFiltrados = useMemo(() => {
        return activos.filter((activo) => {
            const texto = busqueda.toLowerCase();
            const matchTexto = 
                activo.NombreDescriptivo.toLowerCase().includes(texto) ||
                activo.CodigoIdentificador.toLowerCase().includes(texto) ||
                (activo.Ubicacion && activo.Ubicacion.toLowerCase().includes(texto));

            const matchTipo = filtroTipo ? activo.TipoActivo === filtroTipo : true;
            return matchTexto && matchTipo;
        });
    }, [activos, busqueda, filtroTipo]);

    // Manejadores
    const handleActivoCreado = () => { setModalCrearAbierto(false); cargarActivos(); };
    
    const abrirModalEditar = (activo) => { setActivoSeleccionado(activo); setModalEditarAbierto(true); };
    const cerrarModalEditar = () => { setModalEditarAbierto(false); setActivoSeleccionado(null); };
    const handleActivoEditado = () => { cerrarModalEditar(); cargarActivos(); };

    const abrirModalEliminar = (activo) => { setActivoSeleccionado(activo); setModalConfirmarAbierto(true); };
    const cerrarModalEliminar = () => { setModalConfirmarAbierto(false); setActivoSeleccionado(null); };
    
    const abrirModalVer = (activo) => { setActivoSeleccionado(activo); setModalVerDetalleAbierto(true); };
    const cerrarModalVer = () => { setModalVerDetalleAbierto(false); setActivoSeleccionado(null); };

    const handleConfirmarEliminar = async () => {
        if (!activoSeleccionado) return;
        try {
            await eliminarActivo(activoSeleccionado.ID_Activo);
            cerrarModalEliminar();
            Swal.fire({ title: 'Eliminado', text: 'Activo eliminado.', icon: 'success', timer: 1500, showConfirmButton: false });
            cargarActivos(); 
        } catch (err) {
            cerrarModalEliminar();
            Swal.fire('Error', err.message, 'error');
        }
    };

    // Helper visual para la píldora de estado
    const getTipoClass = (tipo) => {
        if (!tipo) return 'status-pendiente';
        const t = tipo.toLowerCase();
        if (t.includes('vehiculo') || t.includes('moto') || t.includes('montacarga')) return 'status-proceso';
        if (t.includes('extintor') || t.includes('botiquin')) return 'status-activo';
        return 'status-pendiente';
    };

    // --- LÓGICA CORREGIDA PARA MOSTRAR EL OJITO ---
    const esVehiculo = (tipo) => {
        if (!tipo) return false;
        const t = tipo.toLowerCase().trim();
        // Lista amplia de palabras clave
        return ['vehiculo', 'moto', 'montacarga', 'carro', 'camion', 'tractomula', 'furgon'].some(clave => t.includes(clave));
    };

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>Gestión de Activos</h1>
                <button className="btn btn-primary" onClick={() => setModalCrearAbierto(true)}>
                    <BsPlusLg /> Crear Nuevo Activo
                </button>
            </div>

            <div className="filters-bar" style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                <div className="search-input-container" style={{ flex: 1, minWidth: '250px', position: 'relative' }}>
                    <BsSearch style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#aaa' }} />
                    <input 
                        type="text" className="form-control" 
                        placeholder="Buscar por nombre, código o ubicación..." 
                        style={{ paddingLeft: '35px', height: '40px' }}
                        value={busqueda} onChange={(e) => setBusqueda(e.target.value)}
                    />
                </div>
                <div className="filter-select-container" style={{ minWidth: '200px' }}>
                    <select className="form-control" style={{ height: '40px' }} value={filtroTipo} onChange={(e) => setFiltroTipo(e.target.value)}>
                        <option value="">Todos los Tipos</option>
                        {tiposDisponibles.map((tipoObj, idx) => {
                            // Manejo seguro: si viene objeto o string
                            const valor = typeof tipoObj === 'object' ? tipoObj.TipoActivoAsociado : tipoObj;
                            return <option key={idx} value={valor}>{valor}</option>;
                        })}
                    </select>
                </div>
            </div>

            <div className="page-content-card">
                <div className="table-wrapper">
                    {isLoading && <p>Cargando activos...</p>}
                    {!isLoading && !error && (
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Código / Placa</th>
                                    <th>Nombre Descriptivo</th>
                                    <th>Ubicación</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {activosFiltrados.length === 0 ? (
                                    <tr><td colSpan="5" style={{ textAlign: 'center' }}>No se encontraron activos.</td></tr>
                                ) : (
                                    activosFiltrados.map((activo) => (
                                        <tr key={activo.ID_Activo}>
                                            <td>
                                                <span className={`status-pill ${getTipoClass(activo.TipoActivo)}`}>
                                                    {activo.TipoActivo}
                                                </span>
                                            </td>
                                            <td><strong>{activo.CodigoIdentificador}</strong></td>
                                            <td>{activo.NombreDescriptivo}</td>
                                            <td>{activo.Ubicacion || 'N/A'}</td>
                                            <td className="action-buttons">
                                                
                                                {/* BOTÓN VER DETALLE (OJITO) */}
                                                {esVehiculo(activo.TipoActivo) && (
                                                    <button 
                                                        className="btn btn-icon" 
                                                        title="Ver Ficha Técnica" 
                                                        onClick={() => abrirModalVer(activo)}
                                                        style={{ color: '#007BFF', borderColor: '#007BFF', marginRight: '5px' }}
                                                    >
                                                        <BsEyeFill />
                                                    </button>
                                                )}

                                                <button className="btn btn-icon" title="Editar" onClick={() => abrirModalEditar(activo)}>
                                                    <BsPencilSquare style={{color: '#f57f17'}} />
                                                </button>
                                                <button className="btn btn-icon" title="Eliminar" onClick={() => abrirModalEliminar(activo)}>
                                                    <BsTrash style={{color: '#dc3545'}} />
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>
            
            {/* Modales */}
            {modalCrearAbierto && <ModalCrearActivo alCerrar={() => setModalCrearAbierto(false)} alExito={handleActivoCreado} />}
            
            {modalEditarAbierto && <ModalEditarActivo activo={activoSeleccionado} alCerrar={cerrarModalEditar} alExito={handleActivoEditado} />}
            
            {modalVerDetalleAbierto && (
                <ModalVerDetalleActivo 
                    activo={activoSeleccionado} 
                    alCerrar={cerrarModalVer} 
                />
            )}

            {modalConfirmarAbierto && (
                <ModalConfirmarAccion
                    titulo="Eliminar Activo"
                    mensaje={`¿Estás seguro de que deseas eliminar "${activoSeleccionado?.NombreDescriptivo}"?`}
                    enConfirmar={handleConfirmarEliminar}
                    alCerrar={cerrarModalEliminar}
                    textoBotonConfirmar="Eliminar"
                    claseBoton="btn-danger"
                />
            )}
        </div>
    );
};

export default ActivosPage;


==================================================================
ARCHIVO: frontend\src\pages\DashboardCalidad.jsx
==================================================================
// frontend/src/pages/DashboardCalidad.jsx

import React from 'react';
import { useAuth } from '../context/AuthContext';
import { Link } from 'react-router-dom';
import '../style/DashboardAdmin.css'; 
import { BsFillFolderFill, BsGraphUpArrow, BsClipboardCheck } from 'react-icons/bs';

const DashboardCalidad = () => {
    const { usuario } = useAuth();

    return (
        <div className="page-container">
            <div className="dashboard-admin-header" style={{ borderBottom: '4px solid #20c997' }}>
                <h1>Gestión de Calidad</h1>
                <p>Bienvenido/a, <strong>{usuario.nombre}</strong>. Panel de aseguramiento de calidad.</p>
            </div>

            <div className="page-content-card">
                <h2 style={{ marginBottom: '1.5rem' }}>Módulos Asignados</h2>
                
                <div className="kpi-grid" style={{ gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))' }}>
                    
                    <Link to="/documentos" className="kpi-card-link">
                        <div className="kpi-card">
                            <h3 style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <BsFillFolderFill /> Gestión Documental
                            </h3>
                            <p>Control de documentos, versiones y registros del sistema.</p>
                        </div>
                    </Link>

                    <Link to="/acpm" className="kpi-card-link">
                        <div className="kpi-card">
                            <h3 style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <BsGraphUpArrow /> Acciones (ACPM)
                            </h3>
                            <p>Gestión de acciones correctivas, preventivas y de mejora.</p>
                        </div>
                    </Link>

                    <div className="kpi-card" style={{ opacity: 0.6, cursor: 'not-allowed' }}>
                        <h3 style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                            <BsClipboardCheck /> Auditorías
                        </h3>
                        <p>Módulo en construcción.</p>
                    </div>

                </div>
            </div>
        </div>
    );
};

export default DashboardCalidad;


==================================================================
ARCHIVO: frontend\src\pages\DashboardPage.jsx
==================================================================
// frontend/src/pages/DashboardPage.jsx

import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import { Link } from 'react-router-dom';
import { getMisReportesMaquina, getMisReportesSeguridad } from '../services/reportService';
import { getAdminKPIs, getAdminActividadesPendientes, getAdminReportesRecientes } from '../services/dashboardService';
import ModalVerReporte from '../components/ModalVerReporte'; // <--- IMPORTANTE

import '../style/UsuariosPage.css';
import '../style/DashboardColaborador.css'; 
import '../style/DashboardAdmin.css';

// --- VISTA DEL COLABORADOR ---
const DashboardColaborador = ({ usuario }) => {
    const [misReportes, setMisReportes] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');
    
    // Estados para el modal de detalle
    const [modalVerAbierto, setModalVerAbierto] = useState(false);
    const [reporteSeleccionado, setReporteSeleccionado] = useState(null);

    useEffect(() => {
        const cargarMisReportes = async () => {
            try {
                const [maquina, seguridad] = await Promise.all([
                    getMisReportesMaquina(),
                    getMisReportesSeguridad()
                ]);
                // Unificar formatos para la tabla
                const maqFormateados = maquina.map(r => ({ 
                    id: `maq-${r.ID_ReporteMaquina}`,
                    ID_ReporteMaquina: r.ID_ReporteMaquina, // ID Real para el modal
                    fecha: r.FechaHoraReporte,
                    tipo: 'Máquina (Pre-uso)',
                    rawTipo: 'maquina', // Para saber qué endpoint llamar
                    ref: r.NombreActivo, 
                    estado: r.EstadoRevision
                }));
                const segFormateados = seguridad.map(r => ({ 
                    id: `seg-${r.ID_ReporteSeguridad}`,
                    ID_ReporteSeguridad: r.ID_ReporteSeguridad, // ID Real para el modal
                    fecha: r.FechaHoraReporte,
                    tipo: r.TipoReporte, 
                    rawTipo: 'seguridad', // Para saber qué endpoint llamar
                    ref: r.UbicacionArea, 
                    estado: r.EstadoRevision
                }));
                
                const todos = [...maqFormateados, ...segFormateados];
                todos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                setMisReportes(todos);
            } catch (err) {
                console.error(err);
                setError('No se pudo cargar el historial de reportes.');
            } finally {
                setIsLoading(false);
            }
        };
        cargarMisReportes();
    }, []);

    const formatearFecha = (fechaISO) => new Date(fechaISO).toLocaleString('es-CO');

    // Función para abrir el modal
    const abrirDetalle = (rep) => {
        setReporteSeleccionado(rep);
        setModalVerAbierto(true);
    };

    return (
        <div className="dashboard-colaborador">
            <div className="dashboard-colaborador-header">
                <h1>Hola, {usuario.nombre}</h1>
            </div>
            <div className="report-cards-container">
                <Link to="/reportar-maquina" className="report-card">
                    <h2>Reportar Estado de Máquina</h2>
                    <p>Diligenciar el reporte pre-uso de su equipo.</p>
                </Link>
                <Link to="/reportar-seguridad" className="report-card">
                    <h2>Reportar Incidente / Condición</h2>
                    <p>Reportar actos, condiciones, incidentes o accidentes.</p>
                </Link>
            </div>
            
            <div className="historial-section">
                <h2>Historial de mis reportes enviados</h2>
                <div className="page-content-card">
                    {isLoading && <p>Cargando historial...</p>}
                    {error && <p className="error-message">{error}</p>}
                    {!isLoading && !error && (
                        <div className="table-wrapper">
                            <table className="data-table">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Tipo de Reporte</th>
                                        <th>Equipo / Área</th>
                                        <th>Estado (Revisión)</th>
                                        <th>Acción</th> {/* Columna Nueva */}
                                    </tr>
                                </thead>
                                <tbody>
                                    {misReportes.length === 0 ? (
                                        <tr><td colSpan="5" style={{textAlign: 'center'}}>No has enviado reportes.</td></tr>
                                    ) : (
                                        misReportes.slice(0, 10).map((rep) => (
                                            <tr key={rep.id}>
                                                <td>{formatearFecha(rep.fecha)}</td>
                                                <td>{rep.tipo}</td>
                                                <td>{rep.ref}</td>
                                                <td>
                                                    <span className={`status-pill ${rep.estado === 'Nuevo' ? 'status-pendiente' : 'status-inactivo'}`}>
                                                        {rep.estado}
                                                    </span>
                                                </td>
                                                <td>
                                                    <button 
                                                        className="btn btn-sm btn-secondary" 
                                                        onClick={() => abrirDetalle(rep)}
                                                    >
                                                        Ver Detalle
                                                    </button>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            </div>

            {/* Modal de Ver Reporte (Reutilizado) */}
            {modalVerAbierto && reporteSeleccionado && (
                <ModalVerReporte 
                    reporte={reporteSeleccionado} 
                    tipo={reporteSeleccionado.rawTipo} 
                    alCerrar={() => setModalVerAbierto(false)}
                    // No pasamos alExito porque el colaborador no cambia el estado
                />
            )}
        </div>
    );
};

// --- VISTA DEL ADMINISTRADOR (Sin cambios significativos, solo formato) ---
const DashboardAdmin = ({ usuario }) => {
    const [kpis, setKpis] = useState(null);
    const [actividades, setActividades] = useState([]);
    const [reportes, setReportes] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');

    const formatearFechaCorta = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        const fecha = new Date(fechaISO.split('T')[0] + 'T00:00:00');
        return fecha.toLocaleDateString('es-CO');
    };

    useEffect(() => {
        const cargarDashboard = async () => {
            try {
                setIsLoading(true);
                const [dataKPIs, dataActividades, dataReportes] = await Promise.all([
                    getAdminKPIs(),
                    getAdminActividadesPendientes(),
                    getAdminReportesRecientes()
                ]);
                setKpis(dataKPIs);
                setActividades(dataActividades);
                setReportes(dataReportes);
            } catch (err) {
                console.error(err);
                setError('No se pudo cargar el dashboard.');
            } finally {
                setIsLoading(false);
            }
        };
        cargarDashboard();
    }, []);

    if (isLoading) return <div className="page-container"><p>Cargando dashboard...</p></div>;
    if (error) return <div className="page-container"><p className="error-message">{error}</p></div>;

    return (
        <div className="page-container">
            <div className="dashboard-admin-header">
                <h1>Bienvenido, {usuario.nombre}</h1>
            </div>

            {kpis && (
                <div className="kpi-grid">
                    <Link to="/inspecciones" className="kpi-card-link">
                        <div className="kpi-card kpi-inspecciones">
                            <h3>Inspecciones Realizadas</h3>
                            <div className="kpi-value">{kpis.InspeccionesRealizadas}</div>
                        </div>
                    </Link>
                    <Link to="/reportes" className="kpi-card-link">
                        <div className="kpi-card kpi-reportes-maq">
                            <h3>Reportes de Maquinaria</h3>
                            <div className="kpi-value">{kpis.ReportesMaquinaria}</div>
                        </div>
                    </Link>
                    <Link to="/reportes" className="kpi-card-link">
                        <div className="kpi-card kpi-reportes-seg">
                            <h3>Reportes de Seguridad</h3>
                            <div className="kpi-value">{kpis.ReportesSeguridad}</div>
                        </div>
                    </Link>
                    <Link to="/acpm" className="kpi-card-link">
                        <div className="kpi-card kpi-acpm">
                            <h3>Acciones Creadas (ACPM)</h3>
                            <div className="kpi-value">{kpis.AccionesCreadas}</div>
                        </div>
                    </Link>
                </div>
            )}

            <div className="dashboard-lists-grid">
                <div className="dashboard-list-card">
                    <h2><Link to="/planificacion">Actividades Pendientes</Link></h2>
                    {actividades.length === 0 ? (
                        <p>¡No hay actividades pendientes!</p>
                    ) : (
                        <ul style={{listStyle: 'none', padding: 0, margin: 0}}>
                            {actividades.map(act => (
                                <li key={act.ID_Actividad} className="dashboard-list-item">
                                    <span className="item-info">{act.NombreActividad}</span>
                                    <span className="item-date">{formatearFechaCorta(act.FechaLimite)}</span>
                                </li>
                            ))}
                        </ul>
                    )}
                </div>

                <div className="dashboard-list-card">
                    <h2><Link to="/reportes">Reportes Recientes</Link></h2>
                    {reportes.length === 0 ? (
                        <p>No hay reportes nuevos pendientes.</p>
                    ) : (
                        <ul style={{listStyle: 'none', padding: 0, margin: 0}}>
                            {reportes.map(rep => (
                                <li key={rep.ID} className="dashboard-list-item">
                                    <div>
                                        <span className="item-info">{rep.TipoReporte}</span>
                                        <small className="item-type" style={{display: 'block'}}>Ref: {rep.Referencia}</small>
                                    </div>
                                    <span className="item-date" style={{color: '#6c757d', fontWeight: 'normal'}}>
                                        {new Date(rep.FechaHoraReporte).toLocaleDateString()}
                                    </span>
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            </div>
        </div>
    );
};

const DashboardPage = () => {
    const { usuario } = useAuth();
    if (!usuario) return <div>Cargando...</div>; 
    
    return usuario.rol === 'Administrador SST' 
        ? <DashboardAdmin usuario={usuario} /> 
        : <DashboardColaborador usuario={usuario} />;
};

export default DashboardPage;


==================================================================
ARCHIVO: frontend\src\pages\DashboardSuperAdmin.jsx
==================================================================
// frontend/src/pages/DashboardSuperAdmin.jsx

import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import { apiFetch } from '../services/apiService'; // Usamos apiFetch directo para simplificar
import { Link } from 'react-router-dom';
import '../style/DashboardAdmin.css'; // Reutilizamos estilos base
// Iconos
import { 
    BsShieldLockFill, BsActivity, BsPeopleFill, BsDatabaseFillGear, 
    BsCheckCircleFill, BsExclamationOctagonFill, BsGraphUp, BsBellFill 
} from 'react-icons/bs';
// Gráficas
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Tooltip as RechartsTooltip } from 'recharts';

const DashboardSuperAdmin = () => {
    const { usuario } = useAuth();
    const [data, setData] = useState(null);
    const [loading, setLoading] = useState(true);

    // Cargar Datos
    useEffect(() => {
        const cargarDatos = async () => {
            try {
                // Llamamos al nuevo endpoint unificado
                const respuesta = await apiFetch('/dashboard/super-admin');
                setData(respuesta);
            } catch (error) {
                console.error(error);
            } finally {
                setLoading(false);
            }
        };
        cargarDatos();
    }, []);

    if (loading) return <div className="page-container"><p>Cargando Centro de Comando...</p></div>;

    const { kpis, grafica, logs } = data;

    return (
        <div className="page-container">
            {/* --- HEADER --- */}
            <div className="dashboard-admin-header" style={{ borderBottom: '4px solid #f1c40f', paddingBottom: '1rem' }}>
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                    <div>
                        <h1 style={{display:'flex', alignItems:'center', gap:'10px'}}>
                            <BsShieldLockFill style={{color: '#f1c40f'}}/> Centro de Comando
                        </h1>
                        <p>Super Usuario: <strong>{usuario.nombre}</strong></p>
                    </div>
                    <div style={{textAlign:'right'}}>
                        <span className="status-pill status-activo">Sistema Operativo</span>
                    </div>
                </div>
            </div>

            {/* --- SECCIÓN 1: KPIs GLOBALES --- */}
            <div className="kpi-grid">
                <div className="kpi-card">
                    <h3><BsPeopleFill style={{color:'#007BFF'}}/> Usuarios Totales</h3>
                    <div className="kpi-value">{kpis?.TotalUsuarios || 0}</div>
                </div>
                <div className="kpi-card">
                    <h3><BsCheckCircleFill style={{color:'#28a745'}}/> Inspecciones</h3>
                    <div className="kpi-value">{kpis?.TotalInspecciones || 0}</div>
                </div>
                <div className="kpi-card">
                    <h3><BsExclamationOctagonFill style={{color:'#dc3545'}}/> Reportes</h3>
                    <div className="kpi-value">{kpis?.TotalReportes || 0}</div>
                </div>
                <div className="kpi-card">
                    <h3><BsGraphUp style={{color:'#005A5B'}}/> ACPM Globales</h3>
                    <div className="kpi-value">{kpis?.TotalACPM || 0}</div>
                </div>
            </div>

            {/* --- SECCIÓN 2: RENDIMIENTO Y LOGS (GRID ASIMÉTRICO) --- */}
            <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '2rem', marginBottom: '2rem' }}>
                
                {/* GRÁFICA DE RENDIMIENTO */}
                <div className="page-content-card">
                    <h2 style={{marginBottom: '1.5rem', display:'flex', alignItems:'center', gap:'10px'}}>
                        <BsActivity /> Rendimiento del Sistema (Últimos 7 días)
                    </h2>
                    <div style={{ width: '100%', height: 300 }}>
                        <ResponsiveContainer>
                            <BarChart data={grafica}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#eee" />
                                <XAxis dataKey="Dia" />
                                <YAxis />
                                <RechartsTooltip 
                                    contentStyle={{borderRadius:'8px', border:'none', boxShadow:'0 2px 10px rgba(0,0,0,0.1)'}}
                                />
                                <Bar dataKey="CantidadAcciones" name="Acciones/Eventos" fill="#005A5B" radius={[4, 4, 0, 0]} />
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                </div>

                {/* NOTIFICACIONES / LOGS EN VIVO */}
                <div className="page-content-card" style={{maxHeight: '400px', overflowY: 'auto'}}>
                    <h2 style={{marginBottom: '1rem', display:'flex', alignItems:'center', gap:'10px', fontSize:'1.2rem'}}>
                        <BsBellFill style={{color:'#f1c40f'}} /> Actividad Reciente
                    </h2>
                    {logs.length === 0 ? (
                        <p style={{color:'#999'}}>No hay actividad reciente.</p>
                    ) : (
                        <ul style={{listStyle:'none', padding:0}}>
                            {logs.map(log => (
                                <li key={log.ID_Log} style={{
                                    padding: '0.8rem 0',
                                    borderBottom: '1px solid #eee',
                                    fontSize: '0.85rem'
                                }}>
                                    <div style={{fontWeight:'bold', color:'#333', marginBottom:'0.2rem'}}>
                                        {log.Accion}
                                    </div>
                                    <div style={{color:'#666', marginBottom:'0.2rem'}}>
                                        {log.Descripcion.substring(0, 60)}{log.Descripcion.length > 60 ? '...' : ''}
                                    </div>
                                    <div style={{fontSize:'0.75rem', color:'#999', display:'flex', justifyContent:'space-between'}}>
                                        <span>👤 {log.NombreUsuario}</span>
                                        <span>🕒 {new Date(log.FechaHora).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                    </div>
                                </li>
                            ))}
                        </ul>
                    )}
                    <div style={{textAlign:'center', marginTop:'1rem'}}>
                        <Link to="/logs" className="btn btn-secondary btn-sm" style={{fontSize:'0.8rem'}}>Ver Auditoría Completa</Link>
                    </div>
                </div>
            </div>

            {/* --- SECCIÓN 3: ACCESOS RÁPIDOS DE CONTROL --- */}
            <h2 style={{fontSize: '1.2rem', marginBottom: '1rem', color: '#666'}}>Panel de Control</h2>
            <div className="kpi-grid" style={{ gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))' }}>
                <Link to="/usuarios" className="kpi-card-link">
                    <div className="kpi-card" style={{ borderLeft: '4px solid #007BFF', padding:'1rem' }}>
                        <h4 style={{margin:0, color:'#007BFF'}}>Gestión de Usuarios</h4>
                        <small style={{color:'#666'}}>Permisos y Roles</small>
                    </div>
                </Link>
                <Link to="/logs" className="kpi-card-link">
                    <div className="kpi-card" style={{ borderLeft: '4px solid #f1c40f', padding:'1rem' }}>
                        <h4 style={{margin:0, color:'#f1c40f'}}>Auditoría Total</h4>
                        <small style={{color:'#666'}}>Traza de seguridad</small>
                    </div>
                </Link>
                {/* Próximamente: Permisos Dinámicos */}
                <div className="kpi-card" style={{ borderLeft: '4px solid #6c757d', padding:'1rem', opacity:0.6, cursor:'not-allowed' }}>
                    <h4 style={{margin:0, color:'#6c757d'}}>Permisos Dinámicos</h4>
                    <small style={{color:'#666'}}>Próximamente (Fase 3)</small>
                </div>
            </div>
        </div>
    );
};

export default DashboardSuperAdmin;


==================================================================
ARCHIVO: frontend\src\pages\DocumentosPage.jsx
==================================================================
// frontend/src/pages/DocumentosPage.jsx

import React, { useState, useEffect, useCallback } from 'react';
import { 
    getContenidoCarpeta, 
    descargarDocumento, 
    eliminarDocumento, 
    eliminarCarpeta 
} from '../services/documentService';
import { 
    BsFolderFill, BsFileEarmarkTextFill, BsFileEarmarkPdfFill, 
    BsFileEarmarkWordFill, BsFileEarmarkExcelFill, BsFileEarmarkZipFill, 
    BsPlusLg, BsUpload, BsDownload, BsTrash 
} from 'react-icons/bs';
import '../index.css'; 
import '../style/DocumentosPage.css'; 
import Swal from 'sweetalert2';

import ModalCrearCarpeta from '../components/ModalCrearCarpeta';
import ModalSubirArchivo from '../components/ModalSubirArchivo';
import ModalConfirmarAccion from '../components/ModalConfirmarAccion';
import ModalVerDocumento from '../components/ModalVerDocumento'; // <--- NUEVO

// Helper para obtener el icono de archivo
const getIconoArchivo = (tipo) => {
    if (tipo.includes('pdf')) return <BsFileEarmarkPdfFill style={{ color: '#E53E3E' }} />;
    if (tipo.includes('word')) return <BsFileEarmarkWordFill style={{ color: '#2B579A' }} />;
    if (tipo.includes('excel')) return <BsFileEarmarkExcelFill style={{ color: '#1D6F42' }} />;
    if (tipo.includes('xml')) return <BsFileEarmarkTextFill style={{ color: '#6c757d' }} />;
    if (tipo.includes('zip')) return <BsFileEarmarkZipFill style={{ color: '#F9A825' }} />;
    return <BsFileEarmarkTextFill className="icon-file" />;
};

const DocumentosPage = () => {
    // --- Estados ---
    const [carpetas, setCarpetas] = useState([]);
    const [archivos, setArchivos] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);
    const [ruta, setRuta] = useState([{ id: 1, nombre: 'Documentos Raíz SG-SST' }]);
    const carpetaActualId = ruta[ruta.length - 1].id;
    
    // --- Estados de Modales ---
    const [modalCarpetaAbierto, setModalCarpetaAbierto] = useState(false);
    const [modalSubirAbierto, setModalSubirAbierto] = useState(false);
    const [modalConfirmarAbierto, setModalConfirmarAbierto] = useState(false);
    const [modalVerAbierto, setModalVerAbierto] = useState(false); // <--- NUEVO
    
    // --- Estados de Contexto ---
    const [isDownloading, setIsDownloading] = useState(null);
    const [itemParaEliminar, setItemParaEliminar] = useState(null); 
    const [archivoParaVer, setArchivoParaVer] = useState(null); // <--- NUEVO

    // --- Función de Carga de Contenido ---
    const cargarContenido = useCallback(async (id) => {
        try {
            setIsLoading(true);
            const data = await getContenidoCarpeta(id);
            setCarpetas(data.carpetas);
            setArchivos(data.archivos);
            setError(null);
        } catch (err) { setError(err.message); } finally { setIsLoading(false); }
    }, []); 

    useEffect(() => {
        cargarContenido(carpetaActualId);
    }, [carpetaActualId, cargarContenido]);

    // --- Manejadores de Navegación ---
    const navegarA = (carpeta) => setRuta([...ruta, carpeta]);
    const navegarAIndex = (index) => setRuta(ruta.slice(0, index + 1));

    // --- Manejadores de Modales ---
    const handleRecargar = () => {
        setModalCarpetaAbierto(false);
        setModalSubirAbierto(false);
        setModalConfirmarAbierto(false);
        setItemParaEliminar(null);
        cargarContenido(carpetaActualId); 
    };
    
    const handleDescargar = async (id, nombreOriginal) => {
        setIsDownloading(id); 
        try { 
            await descargarDocumento(id, nombreOriginal); 
        } catch (err) { 
            console.error(err);
            Swal.fire('Error', err.message, 'error');
        } 
        finally { setIsDownloading(null); }
    };

    const abrirModalEliminar = (item, tipo) => { setItemParaEliminar({ ...item, tipo }); setModalConfirmarAbierto(true); };
    const handleConfirmarEliminar = async () => {
        if (!itemParaEliminar) return;
        // eslint-disable-next-line no-useless-catch
        try {
            if (itemParaEliminar.tipo === 'Carpeta') { await eliminarCarpeta(itemParaEliminar.ID); } 
            else if (itemParaEliminar.tipo === 'Documento') { await eliminarDocumento(itemParaEliminar.ID); }
            handleRecargar(); 
        } catch (err) { throw err; }
    };
    
    // --- MANEJADORES DE VISTA PREVIA (NUEVO) ---
    const abrirModalVer = (archivo) => {
        // (La lógica de si se puede ver o se descarga la maneja el modal)
        setArchivoParaVer(archivo);
        setModalVerAbierto(true);
    };
    const cerrarModalVer = () => {
        setModalVerAbierto(false);
        setArchivoParaVer(null);
    };
    // --- FIN ---

    const formatBytes = (bytes) => {
        if (!bytes || bytes === 0) return '0 KB';
        return `${Math.round(bytes)} KB`;
    };

    return (
        <div className="page-container">
            {/* --- Encabezado --- */}
            <div className="page-header">
                <h1>Gestión Documental</h1>
                <div className="header-actions" style={{ display: 'flex', gap: '1rem' }}>
                    <button className="btn btn-secondary" onClick={() => setModalCarpetaAbierto(true)}><BsPlusLg /> Nueva Carpeta</button>
                    <button className="btn btn-primary" onClick={() => setModalSubirAbierto(true)}><BsUpload /> Subir Archivos</button>
                </div>
            </div>

            {/* --- Breadcrumb (Navegación) --- */}
            <div className="document-breadcrumb">
                {ruta.map((p, index) => (
                    <span key={p.id}>
                        {index < ruta.length - 1 ? (<span className="breadcrumb-link" onClick={() => navegarAIndex(index)}>{p.nombre}</span>) : (<span className="breadcrumb-current">{p.nombre}</span>)}
                        {index < ruta.length - 1 && ' / '}
                    </span>
                ))}
            </div>

            {/* --- Tarjeta de Contenido (Lista) --- */}
            <div className="page-content-card">
                <div className="table-wrapper"> 
                    {isLoading && <p>Cargando contenido...</p>}
                    {error && <p className="error-message">Error: {error}</p>}
                    {!isLoading && !error && (
                        <div className="document-list">
                            <div className="document-list-header">
                                <div className="doc-name">Nombre</div>
                                <div className="doc-type">Tipo</div>
                                <div className="doc-size">Tamaño</div>
                                <div className="doc-actions">Acciones</div>
                            </div>

                            {carpetas.map(carpeta => (
                                <div key={`c-${carpeta.ID}`} className="document-item">
                                    <BsFolderFill className="icon-folder" />
                                    <div className="doc-name item-name">
                                        <span className="item-name-link" onClick={() => navegarA({ id: carpeta.ID, nombre: carpeta.Nombre })}>
                                            {carpeta.Nombre}
                                        </span>
                                    </div>
                                    <div className="doc-type item-type">Carpeta</div>
                                    <div className="doc-size item-size">--</div>
                                    <div className="doc-actions item-actions">
                                        <button className="btn btn-icon btn-danger" onClick={() => abrirModalEliminar(carpeta, 'Carpeta')}><BsTrash /> Eliminar</button>
                                    </div>
                                </div>
                            ))}

                            {archivos.map(archivo => (
                                <div key={`f-${archivo.ID}`} className="document-item">
                                    {getIconoArchivo(archivo.TipoArchivo)}
                                    <div className="doc-name item-name">
                                        {/* --- CAMBIO: Clic en el nombre abre el visor --- */}
                                        <span className="item-name-link" onClick={() => abrirModalVer(archivo)}>
                                            {archivo.Nombre}
                                        </span>
                                    </div>
                                    <div className="doc-type item-type">{archivo.TipoArchivo}</div>
                                    <div className="doc-size item-size">{formatBytes(archivo.TamanoArchivoKB)}</div>
                                    <div className="doc-actions item-actions">
                                        <button className="btn btn-icon btn-secondary" onClick={() => handleDescargar(archivo.ID, archivo.Nombre)} disabled={isDownloading === archivo.ID}><BsDownload /> {isDownloading === archivo.ID ? '...' : 'Descargar'}</button>
                                        <button className="btn btn-icon btn-danger" onClick={() => abrirModalEliminar(archivo, 'Documento')}><BsTrash /> Eliminar</button>
                                    </div>
                                </div>
                            ))}

                            {!isLoading && carpetas.length === 0 && archivos.length === 0 && ( <div style={{ padding: '2rem', textAlign: 'center', color: '#6c757d' }}>Esta carpeta está vacía.</div> )}
                        </div>
                    )}
                </div>
            </div>
            
            {/* --- Renderizado de Modales --- */}
            {modalCarpetaAbierto && ( <ModalCrearCarpeta idCarpetaPadre={carpetaActualId} alCerrar={() => setModalCarpetaAbierto(false)} alExito={handleRecargar} /> )}
            {modalSubirAbierto && ( <ModalSubirArchivo idCarpetaDestino={carpetaActualId} alCerrar={() => setModalSubirAbierto(false)} alExito={handleRecargar} /> )}
            {modalConfirmarAbierto && ( <ModalConfirmarAccion titulo={`Eliminar ${itemParaEliminar?.tipo}`} mensaje={`¿Estás seguro de que deseas eliminar "${itemParaEliminar?.Nombre}"?`} enConfirmar={handleConfirmarEliminar} alCerrar={() => { setModalConfirmarAbierto(false); setItemParaEliminar(null); }} textoBotonConfirmar="Eliminar" claseBoton="btn-danger" /> )}
            
            {/* --- NUEVO: Modal para Ver Documento --- */}
            {modalVerAbierto && (
                <ModalVerDocumento
                    archivo={archivoParaVer}
                    alCerrar={cerrarModalVer}
                />
            )}
        </div>
    );
};

export default DocumentosPage;


==================================================================
ARCHIVO: frontend\src\pages\GestionFormulariosPage.jsx
==================================================================
// frontend/src/pages/GestionFormulariosPage.jsx

import React, { useState, useEffect } from 'react';
// Importamos la nueva función del servicio
import { getFormularios, getPreguntasFormulario, agregarPregunta, eliminarPregunta, toggleVisibilidadFormulario } from '../services/inspectionService';
import '../index.css';
import Swal from 'sweetalert2';
// Importamos los iconos del interruptor
import { BsPencilSquare, BsPlusCircleFill, BsTrashFill, BsListCheck, BsArrowLeft, BsFileEarmarkPlus, BsToggleOn, BsToggleOff } from 'react-icons/bs';
import { Link } from 'react-router-dom';
import ModalCrearFormulario from '../components/ModalCrearFormulario';

const GestionFormulariosPage = () => {
    const [formularios, setFormularios] = useState([]);
    const [formularioSeleccionado, setFormularioSeleccionado] = useState(null);
    const [preguntas, setPreguntas] = useState([]);
    const [nuevaPregunta, setNuevaPregunta] = useState('');
    const [isLoading, setIsLoading] = useState(true);
    const [modalCrearAbierto, setModalCrearAbierto] = useState(false);

    useEffect(() => {
        cargarFormularios();
    }, []);

    const cargarFormularios = async () => {
        setIsLoading(true);
        try {
            const data = await getFormularios();
            setFormularios(data);
        } catch (error) {
            console.error(error);
        } finally {
            setIsLoading(false);
        }
    };

    const handleFormularioCreado = () => {
        setModalCrearAbierto(false);
        cargarFormularios();
        Swal.fire('Creado', 'El formulario ha sido creado.', 'success');
    };

    const seleccionarFormulario = async (form) => {
        setFormularioSeleccionado(form);
        setNuevaPregunta('');
        try {
            const data = await getPreguntasFormulario(form.ID_Formulario);
            setPreguntas(data || []); 
        } catch (error) {
            console.error(error);
        }
    };

    // --- FUNCIÓN PARA EL INTERRUPTOR ---
    const handleToggleVisibilidad = async (e, form) => {
        e.stopPropagation(); // Evita seleccionar el formulario al dar clic en el switch
        
        const nuevoEstado = !form.VisibleColaborador;
        
        try {
            // Llamamos al servicio
            await toggleVisibilidadFormulario(form.ID_Formulario, nuevoEstado);

            // Actualizamos la interfaz localmente
            setFormularios(prev => prev.map(f => 
                f.ID_Formulario === form.ID_Formulario ? { ...f, VisibleColaborador: nuevoEstado } : f
            ));

            // Actualizar también el seleccionado si es el mismo
            if (formularioSeleccionado?.ID_Formulario === form.ID_Formulario) {
                setFormularioSeleccionado(prev => ({ ...prev, VisibleColaborador: nuevoEstado }));
            }

            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
            Toast.fire({ 
                icon: nuevoEstado ? 'success' : 'info', 
                title: nuevoEstado ? 'Ahora es visible para Colaboradores' : 'Oculto para Colaboradores' 
            });

        // eslint-disable-next-line no-unused-vars
        } catch (error) {
            Swal.fire('Error', 'No se pudo cambiar la visibilidad', 'error');
        }
    };

    const handleAgregarPregunta = async (e) => {
        e.preventDefault();
        if (!nuevaPregunta.trim()) return;
        try {
            await agregarPregunta(formularioSeleccionado.ID_Formulario, nuevaPregunta);
            const data = await getPreguntasFormulario(formularioSeleccionado.ID_Formulario);
            setPreguntas(data);
            setNuevaPregunta('');
        } catch (error) { Swal.fire('Error', error.message, 'error'); }
    };

    const handleEliminarPregunta = async (id) => {
        const result = await Swal.fire({ title: '¿Eliminar?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Sí' });
        if (result.isConfirmed) {
            try {
                await eliminarPregunta(id);
                const data = await getPreguntasFormulario(formularioSeleccionado.ID_Formulario);
                setPreguntas(data);
            } catch (error) { Swal.fire('Error', error.message, 'error'); }
        }
    };

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>Gestor de Formularios</h1>
                <div style={{ display: 'flex', gap: '10px' }}>
                    <Link to="/super-admin/dashboard" className="btn btn-secondary"><BsArrowLeft /> Volver</Link>
                    <button className="btn btn-primary" onClick={() => setModalCrearAbierto(true)}><BsFileEarmarkPlus /> Crear Nuevo Formulario</button>
                </div>
            </div>

            <div style={{ display: 'flex', gap: '2rem', flexWrap: 'wrap', alignItems: 'flex-start' }}>
                
                {/* LISTA DE FORMULARIOS */}
                <div className="page-content-card" style={{ flex: 1, minWidth: '350px', maxHeight: '80vh', overflowY: 'auto' }}>
                    <h3 style={{ display: 'flex', alignItems: 'center', gap: '10px', borderBottom: '1px solid #eee', paddingBottom: '10px', marginTop: 0 }}>
                        <BsListCheck /> Formularios
                    </h3>
                    
                    {isLoading ? <p>Cargando...</p> : (
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                            {formularios.map(form => (
                                <div 
                                    key={form.ID_Formulario}
                                    onClick={() => seleccionarFormulario(form)}
                                    style={{
                                        padding: '1rem',
                                        borderRadius: '8px',
                                        border: formularioSeleccionado?.ID_Formulario === form.ID_Formulario ? '2px solid var(--color-acento)' : '1px solid #eee',
                                        backgroundColor: formularioSeleccionado?.ID_Formulario === form.ID_Formulario ? '#f0f7ff' : 'white',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                        <strong style={{ color: 'var(--color-primario)' }}>{form.NombreFormulario}</strong>
                                        
                                        {/* --- AQUÍ ESTÁ EL BOTÓN QUE FALTABA --- */}
                                        <div 
                                            onClick={(e) => handleToggleVisibilidad(e, form)}
                                            title={form.VisibleColaborador ? "Visible para Colaborador (Clic para ocultar)" : "Oculto para Colaborador (Clic para mostrar)"}
                                            style={{ cursor: 'pointer', fontSize: '1.8rem', color: form.VisibleColaborador ? '#28a745' : '#ccc', display: 'flex', alignItems: 'center' }}
                                        >
                                            {form.VisibleColaborador ? <BsToggleOn /> : <BsToggleOff />}
                                        </div>
                                    </div>
                                    
                                    <div style={{display:'flex', justifyContent:'space-between', marginTop:'5px', alignItems:'center'}}>
                                        <small style={{ color: '#666' }}>Tipo: {form.TipoActivoAsociado}</small>
                                        
                                        {/* Etiqueta de texto del estado */}
                                        <span style={{ 
                                            fontSize:'0.7rem', 
                                            fontWeight:'bold', 
                                            color: form.VisibleColaborador ? '#28a745' : '#999',
                                            border: `1px solid ${form.VisibleColaborador ? '#28a745' : '#ccc'}`,
                                            padding: '2px 6px',
                                            borderRadius: '4px'
                                        }}>
                                            {form.VisibleColaborador ? 'VISIBLE' : 'OCULTO'}
                                        </span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                {/* EDITOR DE PREGUNTAS (Derecha) */}
                <div className="page-content-card" style={{ flex: 2, minWidth: '400px' }}>
                    {!formularioSeleccionado ? (
                        <div style={{ textAlign: 'center', padding: '3rem', color: '#999' }}>
                            <BsPencilSquare style={{ fontSize: '3rem', marginBottom: '1rem', color: '#ddd' }} />
                            <p>Selecciona un formulario de la izquierda para ver sus preguntas.</p>
                        </div>
                    ) : (
                        <>
                            <div style={{borderBottom: '1px solid #eee', paddingBottom: '1rem', marginBottom: '1rem'}}>
                                <h3 style={{ color: 'var(--color-primario)', margin: 0 }}>{formularioSeleccionado.NombreFormulario}</h3>
                                <p style={{margin: '5px 0', color: '#666'}}>
                                    Aplica a activos tipo: <strong>{formularioSeleccionado.TipoActivoAsociado}</strong>
                                </p>
                            </div>

                            <form onSubmit={handleAgregarPregunta} style={{ display: 'flex', gap: '10px', marginBottom: '2rem', padding: '1.5rem', backgroundColor: '#f8f9fa', borderRadius: '8px', border: '1px solid #dee2e6' }}>
                                <input type="text" className="form-control" placeholder="Nueva pregunta..." value={nuevaPregunta} onChange={(e) => setNuevaPregunta(e.target.value)} style={{ flex: 1 }} />
                                <button type="submit" className="btn btn-primary" disabled={!nuevaPregunta.trim()}><BsPlusCircleFill /> Agregar</button>
                            </form>

                            <div className="table-wrapper">
                                <table className="data-table" style={{ width: '100%' }}>
                                    <thead><tr><th style={{width:'50px'}}>#</th><th>Pregunta</th><th style={{width:'100px', textAlign:'center'}}>Acción</th></tr></thead>
                                    <tbody>
                                        {preguntas.map((p, index) => (
                                            <tr key={p.ID_Pregunta}>
                                                <td>{index + 1}</td><td>{p.TextoPregunta}</td>
                                                <td style={{textAlign:'center'}}><button className="btn btn-danger btn-sm" onClick={() => handleEliminarPregunta(p.ID_Pregunta)}><BsTrashFill /> Eliminar</button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </>
                    )}
                </div>
            </div>

            {modalCrearAbierto && <ModalCrearFormulario alCerrar={() => setModalCrearAbierto(false)} alExito={handleFormularioCreado} />}
        </div>
    );
};

export default GestionFormulariosPage;


==================================================================
ARCHIVO: frontend\src\pages\IndicadoresPage.jsx
==================================================================
/* eslint-disable no-unused-vars */
// frontend/src/pages/IndicadoresPage.jsx

import React, { useState, useEffect } from 'react';
import { guardarIndicador, getIndicadoresAnuales } from '../services/indicatorService';
import '../index.css';
import Swal from 'sweetalert2';
import { BsGraphUp, BsSave, BsCalendarCheck, BsInfoCircle, BsTable, BsSearch } from 'react-icons/bs';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line } from 'recharts';

// Importamos el modal de detalle
import ModalVerIndicador from '../components/ModalVerIndicador';

const IndicadoresPage = () => {
    const currentYear = new Date().getFullYear();
    const [anio, setAnio] = useState(currentYear);
    const [dataRaw, setDataRaw] = useState([]);
    const [dataGraficas, setDataGraficas] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [filtroTabla, setFiltroTabla] = useState('');

    // Estados para el Modal
    const [modalDetalleAbierto, setModalDetalleAbierto] = useState(false);
    const [indicadorSeleccionado, setIndicadorSeleccionado] = useState(null);

    // --- CONFIGURACIÓN MAESTRA ---
    const CONFIG_INDICADORES = {
        'Severidad de Accidentalidad': {
            tipo: 'COMPUESTO', 
            label1: 'N° Días Perdidos por AT',
            label2: 'N° Días Cargados',
            labelDen: 'N° Trabajadores en el mes',
            constante: 100,
            metaDefault: 100,
            frecuencia: 'Mensual',
            tipoGrafica: 'Line',
            operadorMeta: '<='
        },
        'Frecuencia de Accidentalidad': {
            tipo: 'SIMPLE',
            labelNum: 'N° Accidentes de Trabajo',
            labelDen: 'N° Trabajadores en el periodo',
            constante: 100,
            metaDefault: 8, 
            frecuencia: 'Mensual',
            tipoGrafica: 'Line',
            operadorMeta: '<='
        },
        'Proporción de Accidentes Mortales': {
            tipo: 'SIMPLE',
            labelNum: 'N° Accidentes Mortales',
            labelDen: 'Total Accidentes de Trabajo',
            constante: 100,
            metaDefault: 0,
            frecuencia: 'Anual',
            tipoGrafica: 'Bar',
            operadorMeta: '=='
        },
        'Prevalencia de Enfermedad Laboral': {
            tipo: 'SIMPLE',
            labelNum: 'N° Casos (Nuevos + Antiguos)',
            labelDen: 'Promedio Total Trabajadores',
            constante: 100000,
            metaDefault: 0,
            frecuencia: 'Anual',
            tipoGrafica: 'Bar',
            operadorMeta: '=='
        },
        'Incidencia de Enfermedad Laboral': {
            tipo: 'SIMPLE',
            labelNum: 'N° Casos Nuevos',
            labelDen: 'Promedio Total Trabajadores',
            constante: 100000,
            metaDefault: 0,
            frecuencia: 'Anual',
            tipoGrafica: 'Bar',
            operadorMeta: '=='
        },
        'Ausentismo por Incapacidades': {
            tipo: 'SIMPLE',
            labelNum: 'N° Días Ausencia',
            labelDen: 'N° Días Trabajo Programados',
            constante: 100,
            metaDefault: 2, 
            frecuencia: 'Mensual',
            tipoGrafica: 'Line',
            operadorMeta: '<='
        },
        'Indicadores de Estructura': {
            tipo: 'SIMPLE',
            labelNum: 'Total Ítems Cumplidos',
            labelDen: 'Total Ítems a Evaluar',
            constante: 100,
            metaDefault: 95,
            frecuencia: 'Anual',
            tipoGrafica: 'Bar',
            operadorMeta: '>='
        },
        'Indicadores de Proceso': {
            tipo: 'SIMPLE',
            labelNum: 'Total Ítems Cumplidos',
            labelDen: 'Total Ítems a Evaluar',
            constante: 100,
            metaDefault: 95,
            frecuencia: 'Anual',
            tipoGrafica: 'Bar',
            operadorMeta: '>='
        },
        'Indicadores de Resultado': {
            tipo: 'SIMPLE',
            labelNum: 'Total Ítems Cumplidos',
            labelDen: 'Total Ítems a Evaluar',
            constante: 100,
            metaDefault: 95,
            frecuencia: 'Anual',
            tipoGrafica: 'Bar',
            operadorMeta: '>='
        }
    };

    const [form, setForm] = useState({
        nombreIndicador: 'Severidad de Accidentalidad',
        mes: new Date().getMonth() + 1,
        val1: '', 
        val2: '', 
        numerador: '', 
        denominador: '',
        meta: 100,
        analisis: ''
    });

    const meses = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];

    useEffect(() => {
        cargarDatos();
    }, [anio]);

    const cargarDatos = async () => {
        try {
            const datosRaw = await getIndicadoresAnuales(anio);
            const datosOrdenados = [...datosRaw].sort((a, b) => b.Mes - a.Mes);
            setDataRaw(datosOrdenados);
            procesarDatosParaGrafica(datosRaw);
        } catch (error) {
            console.error(error);
        }
    };

    const procesarDatosParaGrafica = (datos) => {
        const chartData = meses.map((mesNombre, index) => ({
            name: mesNombre,
            ...Object.keys(CONFIG_INDICADORES).reduce((acc, key) => ({ ...acc, [key]: 0, [`Meta_${key}`]: 0 }), {})
        }));

        datos.forEach(d => {
            const mesIndex = d.Mes - 1;
            if (chartData[mesIndex]) {
                chartData[mesIndex][d.NombreIndicador] = d.Resultado || 0;
                chartData[mesIndex][`Meta_${d.NombreIndicador}`] = d.Meta || 0;
            }
        });
        setDataGraficas(chartData);
    };

    const handleIndicadorChange = (nuevoIndicador) => {
        const config = CONFIG_INDICADORES[nuevoIndicador];
        setForm(prev => ({
            ...prev,
            nombreIndicador: nuevoIndicador,
            meta: config.metaDefault,
            numerador: '',
            denominador: '',
            val1: '',
            val2: ''
        }));
    };

    // --- ABRIR MODAL ---
    const abrirDetalle = (indicador) => {
        setIndicadorSeleccionado({ ...indicador, Anio: anio });
        setModalDetalleAbierto(true);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        try {
            const config = CONFIG_INDICADORES[form.nombreIndicador];
            
            let numFinal = 0;
            let analisisFinal = form.analisis;

            if (config.tipo === 'COMPUESTO') {
                const v1 = parseFloat(form.val1 || 0);
                const v2 = parseFloat(form.val2 || 0);
                numFinal = v1 + v2;
                const desglose = `[Cálculo: ${v1} Días Perdidos + ${v2} Días Cargados = ${numFinal} Total]`;
                analisisFinal = analisisFinal ? `${desglose}. ${analisisFinal}` : desglose;
            } else {
                numFinal = parseFloat(form.numerador || 0);
            }

            const denFinal = parseFloat(form.denominador || 0);
            if (denFinal === 0) {
                Swal.fire('Error', 'El denominador no puede ser 0', 'warning');
                setIsLoading(false);
                return;
            }

            const payload = {
                nombreIndicador: form.nombreIndicador,
                mes: form.mes,
                anio: anio,
                numerador: numFinal,
                denominador: denFinal,
                constante: config.constante,
                meta: parseFloat(form.meta || 0),
                analisis: analisisFinal
            };
            
            await guardarIndicador(payload);
            
            Swal.fire({ icon: 'success', title: 'Guardado', timer: 1500, showConfirmButton: false });
            cargarDatos();
            setForm(prev => ({...prev, numerador: '', denominador: '', val1: '', val2: '', analisis: ''}));

        // eslint-disable-next-line no-unused-vars
        } catch (error) {
            Swal.fire('Error', 'No se pudo guardar.', 'error');
        } finally {
            setIsLoading(false);
        }
    };

    const configActual = CONFIG_INDICADORES[form.nombreIndicador];

    const cumpleMeta = (valor, meta, indicador) => {
        const valSeguro = valor || 0;
        const metaSegura = meta || 0;
        const config = CONFIG_INDICADORES[indicador];
        if (!config) return true;
        if (config.operadorMeta === '<=') return valSeguro <= metaSegura;
        if (config.operadorMeta === '>=') return valSeguro >= metaSegura;
        return valSeguro === metaSegura;
    };

    const registrosFiltrados = dataRaw.filter(row => {
        const texto = filtroTabla.toLowerCase();
        return (
            row.NombreIndicador.toLowerCase().includes(texto) ||
            (row.Analisis && row.Analisis.toLowerCase().includes(texto)) ||
            meses[row.Mes - 1].toLowerCase().includes(texto)
        );
    });

    const RenderGrafica = ({ titulo, dataKey, tipo }) => (
        <div className="page-content-card" style={{marginBottom:'1rem', minWidth: '0'}}>
            <h4 style={{fontSize:'0.9rem', color:'#666', textTransform:'uppercase', borderBottom:'1px solid #eee', paddingBottom:'5px'}}>
                {titulo}
            </h4>
            <div style={{ width: '100%', height: 300 }}>
                <ResponsiveContainer width="100%" height="100%">
                    {tipo === 'Line' ? (
                        <LineChart data={dataGraficas} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                            <CartesianGrid strokeDasharray="3 3" />
                            <XAxis dataKey="name" />
                            <YAxis />
                            <Tooltip contentStyle={{borderRadius:'8px'}} />
                            <Legend />
                            <Line type="monotone" dataKey={dataKey} stroke="#005A5B" strokeWidth={3} activeDot={{ r: 6 }} name="Resultado" />
                            <Line type="monotone" dataKey={`Meta_${dataKey}`} stroke="#dc3545" strokeDasharray="5 5" name="Meta" />
                        </LineChart>
                    ) : (
                        <BarChart data={dataGraficas} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                            <CartesianGrid strokeDasharray="3 3" />
                            <XAxis dataKey="name" />
                            <YAxis />
                            <Tooltip contentStyle={{borderRadius:'8px'}} />
                            <Legend />
                            <Bar dataKey={dataKey} fill="#005A5B" name="Resultado" radius={[4, 4, 0, 0]} />
                            <Bar dataKey={`Meta_${dataKey}`} fill="#b3b3b3" name="Meta" radius={[4, 4, 0, 0]} />
                        </BarChart>
                    )}
                </ResponsiveContainer>
            </div>
        </div>
    );

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>Indicadores de Gestión SST ({anio})</h1>
                <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                    <span style={{fontWeight:'bold'}}>Año:</span>
                    <input 
                        type="number" className="form-control" 
                        value={anio} onChange={(e) => setAnio(e.target.value)} 
                        style={{width:'80px', padding:'5px'}} 
                    />
                </div>
            </div>

            {/* 1. FORMULARIO */}
            <div className="page-content-card" style={{borderTop: '5px solid var(--color-acento)', marginBottom: '2rem'}}>
                <h3 style={{marginTop:0, display:'flex', alignItems:'center', gap:'10px'}}>
                    <BsCalendarCheck /> Registrar Medición Mensual
                </h3>
                
                <form onSubmit={handleSubmit}>
                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1.5rem'}}>
                        <div className="form-group">
                            <label>Seleccione Indicador</label>
                            <select className="form-control" value={form.nombreIndicador} onChange={(e) => handleIndicadorChange(e.target.value)}>
                                {Object.keys(CONFIG_INDICADORES).map(k => <option key={k} value={k}>{k}</option>)}
                            </select>
                            <div style={{marginTop:'5px', fontSize:'0.8rem', color:'#666', display:'flex', gap:'10px'}}>
                                <span>Frecuencia: <strong>{configActual.frecuencia}</strong></span>
                                <span>K: <strong>{configActual.constante.toLocaleString()}</strong></span>
                            </div>
                        </div>
                        <div className="form-group">
                            <label>Mes de Reporte</label>
                            <select className="form-control" value={form.mes} onChange={(e) => setForm({...form, mes: parseInt(e.target.value)})}>
                                {meses.map((m, i) => <option key={i} value={i+1}>{m}</option>)}
                            </select>
                        </div>
                    </div>

                    <div style={{marginTop:'1rem', backgroundColor:'#f8f9fa', padding:'1.5rem', borderRadius:'8px', border:'1px solid #dee2e6'}}>
                        {configActual.tipo === 'COMPUESTO' ? (
                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '1rem'}}>
                                <div className="form-group" style={{marginBottom:0}}>
                                    <label>{configActual.label1}</label>
                                    <input type="number" step="0.01" className="form-control" required value={form.val1} onChange={(e) => setForm({...form, val1: e.target.value})} placeholder="0" />
                                </div>
                                <div className="form-group" style={{marginBottom:0}}>
                                    <label>{configActual.label2}</label>
                                    <input type="number" step="0.01" className="form-control" required value={form.val2} onChange={(e) => setForm({...form, val2: e.target.value})} placeholder="0" />
                                </div>
                                <div className="form-group" style={{marginBottom:0}}>
                                    <label>{configActual.labelDen}</label>
                                    <input type="number" step="0.01" className="form-control" required value={form.denominador} onChange={(e) => setForm({...form, denominador: e.target.value})} placeholder="0" />
                                </div>
                            </div>
                        ) : (
                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem'}}>
                                <div className="form-group" style={{marginBottom:0}}>
                                    <label>{configActual.labelNum}</label>
                                    <input type="number" step="0.01" className="form-control" required value={form.numerador} onChange={(e) => setForm({...form, numerador: e.target.value})} placeholder="0" />
                                </div>
                                <div className="form-group" style={{marginBottom:0}}>
                                    <label>{configActual.labelDen}</label>
                                    <input type="number" step="0.01" className="form-control" required value={form.denominador} onChange={(e) => setForm({...form, denominador: e.target.value})} placeholder="0" />
                                </div>
                            </div>
                        )}
                        <div className="form-group" style={{marginTop:'1rem'}}>
                            <label>Meta Establecida</label>
                            <input type="number" step="0.01" className="form-control" required value={form.meta} onChange={(e) => setForm({...form, meta: e.target.value})} style={{width:'150px'}} />
                        </div>
                    </div>
                    
                    <div className="form-group" style={{marginTop: '1rem'}}>
                        <label>Análisis Cualitativo</label>
                        <textarea className="form-control" rows="2" value={form.analisis} onChange={(e) => setForm({...form, analisis: e.target.value})} placeholder="Causas, desviaciones o planes de acción..." />
                    </div>

                    <div style={{textAlign:'right', marginTop:'1rem'}}>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>
                            <BsSave /> {isLoading ? 'Guardando...' : 'Guardar y Calcular'}
                        </button>
                    </div>
                </form>
            </div>

            {/* 2. GRÁFICAS */}
            <h2 style={{color:'#333', fontSize:'1.5rem', marginBottom:'1.5rem', borderBottom:'2px solid #eee', paddingBottom:'10px'}}>
                <BsGraphUp /> Tablero de Control
            </h2>
            
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(450px, 1fr))', gap: '2rem', marginBottom: '3rem' }}>
                {Object.keys(CONFIG_INDICADORES).map(key => {
                    const tieneDatos = dataRaw.some(d => d.NombreIndicador === key);
                    if (!tieneDatos) return null;
                    return (
                        <RenderGrafica 
                            key={key} 
                            titulo={key} 
                            dataKey={key} 
                            tipo={CONFIG_INDICADORES[key].tipoGrafica} 
                        />
                    );
                })}
            </div>

            {/* 3. TABLA DETALLADA (AL FINAL) */}
            <div className="page-content-card">
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem'}}>
                    <h3 style={{marginTop:0, display:'flex', alignItems:'center', gap:'10px'}}>
                        <BsTable /> Detalle de Registros {anio}
                    </h3>
                    <div className="search-input-container" style={{maxWidth:'300px'}}>
                        <BsSearch style={{ position: 'absolute', left: '10px', top: '50%', transform: 'translateY(-50%)', color: '#aaa' }} />
                        <input 
                            type="text" className="form-control" 
                            placeholder="Filtrar por indicador..." 
                            style={{ paddingLeft: '30px', height: '35px' }}
                            value={filtroTabla} onChange={(e) => setFiltroTabla(e.target.value)}
                        />
                    </div>
                </div>

                <div className="table-wrapper">
                    <table className="data-table">
                        <thead>
                            <tr>
                                <th>Mes</th>
                                <th>Indicador</th>
                                <th>Fórmula Aplicada</th>
                                <th>Resultado</th>
                                <th>Meta</th>
                                <th>Estado</th>
                                <th>Análisis / Desglose</th>
                                <th>Acción</th> {/* COLUMNA NUEVA */}
                            </tr>
                        </thead>
                        <tbody>
                            {registrosFiltrados.length === 0 ? (
                                <tr><td colSpan="8" style={{textAlign:'center'}}>No se encontraron registros.</td></tr>
                            ) : (
                                registrosFiltrados.map((row) => (
                                    <tr key={row.ID_Indicador}>
                                        <td>{meses[row.Mes - 1]}</td>
                                        <td><strong>{row.NombreIndicador}</strong></td>
                                        
                                        <td style={{fontFamily: 'monospace', fontSize: '0.85rem', color: '#555'}}>
                                            ({(row.Numerador || 0).toLocaleString()} ÷ {(row.Denominador || 0).toLocaleString()}) × {row.Constante}
                                        </td>

                                        <td style={{fontWeight:'bold', color: '#005A5B'}}>
                                            {(row.Resultado || 0).toFixed(2)}
                                        </td>
                                        <td>{row.Meta}</td>
                                        <td>
                                            {cumpleMeta(row.Resultado, row.Meta, row.NombreIndicador) ? (
                                                <span className="status-pill status-activo">Cumple</span>
                                            ) : (
                                                <span className="status-pill status-inactivo">No Cumple</span>
                                            )}
                                        </td>
                                        <td title={row.Analisis}>
                                            {row.Analisis ? (
                                                <div style={{maxWidth: '250px', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis'}}>
                                                    {row.Analisis}
                                                </div>
                                            ) : '--'}
                                        </td>
                                        
                                        {/* --- BOTÓN VER DETALLE --- */}
                                        <td style={{textAlign:'center'}}>
                                            <button 
                                                className="btn btn-sm btn-secondary" 
                                                onClick={() => abrirDetalle(row)}
                                                style={{ 
                                                    backgroundColor: '#fff', 
                                                    color: '#007BFF', 
                                                    border: '1px solid #007BFF',
                                                    padding: '5px 10px',
                                                    fontSize: '0.8rem'
                                                }}
                                            >
                                                Ver Detalle
                                            </button>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
            
            {dataRaw.length === 0 && (
                <div style={{textAlign:'center', padding:'3rem', color:'#999'}}>
                    <p>Comience registrando un indicador para ver las gráficas y la tabla.</p>
                </div>
            )}

            {/* MODAL DE DETALLE */}
            {modalDetalleAbierto && (
                <ModalVerIndicador 
                    indicador={indicadorSeleccionado} 
                    alCerrar={() => setModalDetalleAbierto(false)} 
                />
            )}
        </div>
    );
};

export default IndicadoresPage;


==================================================================
ARCHIVO: frontend\src\pages\InspeccionesPage.jsx
==================================================================
import React, { useState, useEffect, useMemo } from 'react';

// IMPORTAMOS TAMBIÉN getPreguntasFormulario
import { 
    getInspeccionesHistorial, 
    getFormularios, 
    getPreguntasFormulario 
} from '../services/inspectionService';

import '../index.css';
import '../style/InspeccionesPage.css';

import { BsPlusLg, BsEyeFill, BsFileEarmarkPlus, BsSearch } from 'react-icons/bs';
import Swal from 'sweetalert2'; 

// Modales
import ModalVerInspeccion from '../components/ModalVerInspeccion.jsx';
import ModalDiligenciarInspeccion from '../components/ModalDiligenciarInspeccion.jsx';
import ModalCrearACPM from '../components/ModalCrearACPM.jsx'; 
import ModalVerACPM from '../components/ModalVerACPM.jsx'; 
import ModalCrearFormulario from '../components/ModalCrearFormulario.jsx';

const InspeccionesPage = () => {

    // DATOS
    const [historial, setHistorial] = useState([]);
    const [listaFormularios, setListaFormularios] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);

    // --- FILTROS (NUEVO) ---
    const [busqueda, setBusqueda] = useState('');
    const [filtroResultado, setFiltroResultado] = useState(''); // 'OK', 'Con Hallazgos'

    // MODALES
    const [modalDetalleAbierto, setModalDetalleAbierto] = useState(false);
    const [inspeccionSeleccionadaId, setInspeccionSeleccionadaId] = useState(null);

    const [modalDiligenciarAbierto, setModalDiligenciarAbierto] = useState(false);
    const [formularioSeleccionado, setFormularioSeleccionado] = useState(null);

    // *** ESTADO PARA PREGUNTAS DINÁMICAS ***
    const [preguntasFormulario, setPreguntasFormulario] = useState([]);

    // ACPM
    const [modalCrearAcpmAbierto, setModalCrearAcpmAbierto] = useState(false);
    const [modalVerAcpmId, setModalVerAcpmId] = useState(null);
    const [acpmInitialData, setAcpmInitialData] = useState({});

    // Crear Formulario
    const [modalCrearFormularioAbierto, setModalCrearFormularioAbierto] = useState(false);

    // CARGA INICIAL
    const cargarDatos = async () => {
        try {
            setIsLoading(true);
            const [dataHistorial, dataFormularios] = await Promise.all([
                getInspeccionesHistorial(),
                getFormularios()
            ]);
            setHistorial(dataHistorial);
            setListaFormularios(dataFormularios);
            setError(null);
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    useEffect(() => { cargarDatos(); }, []);

    // --- LÓGICA DE FILTRADO (NUEVO) ---
    const historialFiltrado = useMemo(() => {
        return historial.filter(ins => {
            const texto = busqueda.toLowerCase();
            
            // 1. Búsqueda por: Formulario, Usuario, Activo o ID
            const matchTexto = 
                ins.NombreFormulario.toLowerCase().includes(texto) ||
                ins.NombreUsuarioRealizo.toLowerCase().includes(texto) ||
                (ins.NombreActivo && ins.NombreActivo.toLowerCase().includes(texto)) ||
                ins.ID_InspeccionRealizada.toString().includes(texto);

            // 2. Filtro por Resultado
            const matchResultado = filtroResultado ? ins.ResultadoGeneral === filtroResultado : true;

            return matchTexto && matchResultado;
        });
    }, [historial, busqueda, filtroResultado]);

    // MODAL DETALLE
    const abrirModalDetalle = (id) => {
        setInspeccionSeleccionadaId(id);
        setModalDetalleAbierto(true);
    };
    const cerrarModalDetalle = () => {
        setModalDetalleAbierto(false);
        setInspeccionSeleccionadaId(null);
    };

    // ABRIR MODAL DILIGENCIAR
    const abrirModalDiligenciar = async (form) => {
        setFormularioSeleccionado(form);
        setPreguntasFormulario([]);

        // Formularios hardcoded que NO usan BD
        const formulariosHardcoded = [
            'FTO-SST-02', 'FTO-SST-13', 'FTO-SST-14',
            'FTO-SST-23', 'FTO-SST-45', 'FTO-SST-95', 'FTO-SST-96'
        ];

        // Si NO es hardcoded -> cargar preguntas desde BD
        if (!formulariosHardcoded.includes(form.ID_Formulario)) {
            try {
                const preguntas = await getPreguntasFormulario(form.ID_Formulario);
                setPreguntasFormulario(preguntas);
            // eslint-disable-next-line no-unused-vars
            } catch (err) {
                Swal.fire('Error', 'No se pudieron cargar las preguntas del formulario dinámico.', 'error');
                return;
            }
        }

        setModalDiligenciarAbierto(true);
    };

    const cerrarModalDiligenciar = () => {
        setModalDiligenciarAbierto(false);
        setFormularioSeleccionado(null);
        setPreguntasFormulario([]);
    };

    const handleInspeccionGuardada = () => {
        cerrarModalDiligenciar();
        cargarDatos();
    };

    // ACPM
    const abrirModalCrearACPM = (inspeccion) => {
        setAcpmInitialData({
            origen: `Inspección: ${inspeccion.NombreFormulario} (ID: ${inspeccion.ID_InspeccionRealizada})`,
            descripcionProblema: `Hallazgos encontrados en inspección de ${inspeccion.NombreFormulario} (Activo: ${inspeccion.NombreActivo || 'N/A'}).`,
            idInspeccionOrigen: inspeccion.ID_InspeccionRealizada
        });
        setModalCrearAcpmAbierto(true);
    };

    const cerrarModalCrearACPM = () => {
        setModalCrearAcpmAbierto(false);
        setAcpmInitialData({});
    };

    const handleAcpmCreada = (nuevoIdACPM) => {
        cerrarModalCrearACPM();
        cargarDatos();
        Swal.fire({
            title: '¡ACPM Creada!',
            text: `La Acción ACPM (ID: ${nuevoIdACPM}) ha sido creada.`,
            icon: 'success',
            showCancelButton: true,
            confirmButtonText: 'Ver ACPM',
            cancelButtonText: 'Cerrar'
        }).then(result => {
            if (result.isConfirmed) setModalVerAcpmId(nuevoIdACPM);
        });
    };

    const abrirModalVerACPM = (id) => setModalVerAcpmId(id);
    const cerrarModalVerACPM = () => setModalVerAcpmId(null);

    // CREAR FORMULARIO
    const handleFormularioCreado = () => {
        setModalCrearFormularioAbierto(false);
        cargarDatos();
    };

    // UTIL FECHA
    const formatearFechaHora = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        return new Date(fechaISO).toLocaleString('es-CO');
    };

    return (
        <div className="page-container">
            
            {/* HEADER */}
            <div className="page-header">
                <h1>Inspecciones de Seguridad</h1>
                <button 
                    className="btn btn-secondary" 
                    onClick={() => setModalCrearFormularioAbierto(true)}
                >
                    <BsFileEarmarkPlus /> Crear Nuevo Formulario
                </button>
            </div>

            {/* BIBLIOTECA */}
            <div className="page-content-card inspection-library">
                <h2>Biblioteca de Formularios</h2>
                <p>Seleccione un formulario para diligenciar una nueva inspección.</p>

                <div className="form-buttons-container">
                    {listaFormularios.length === 0 ? (
                        <p>Cargando formularios...</p>
                    ) : (
                        listaFormularios.map(form => (
                            <button 
                                key={form.ID_Formulario}
                                className="btn btn-primary"
                                onClick={() => abrirModalDiligenciar(form)}
                                title={form.Descripcion}
                            >
                                <BsPlusLg /> {form.NombreFormulario}
                            </button>
                        ))
                    )}
                </div>
            </div>

            {/* HISTORIAL */}
            <div className="page-content-card" style={{ marginTop: '2rem' }}>
                <h2>Historial de Inspecciones Realizadas</h2>

                {/* --- BARRA DE FILTROS (NUEVA) --- */}
                <div className="filters-bar" style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                    {/* Input Búsqueda */}
                    <div className="search-input-container" style={{ flex: 1, minWidth: '250px', position: 'relative' }}>
                        <BsSearch style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#aaa' }} />
                        <input 
                            type="text" 
                            className="form-control" 
                            placeholder="Buscar por formulario, usuario, activo..." 
                            style={{ paddingLeft: '35px', height: '40px' }}
                            value={busqueda}
                            onChange={(e) => setBusqueda(e.target.value)}
                        />
                    </div>

                    {/* Select Resultado */}
                    <div className="filter-select-container" style={{ minWidth: '200px' }}>
                        <select 
                            className="form-control"
                            style={{ height: '40px' }}
                            value={filtroResultado}
                            onChange={(e) => setFiltroResultado(e.target.value)}
                        >
                            <option value="">Todos los Resultados</option>
                            <option value="OK">OK (Sin Hallazgos)</option>
                            <option value="Con Hallazgos">Con Hallazgos</option>
                        </select>
                    </div>
                </div>

                <div className="table-wrapper">
                    {isLoading && <p>Cargando historial...</p>}
                    {error && <p className="error-message">Error: {error}</p>}

                    {!isLoading && !error && (
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Formulario</th>
                                    <th>Fecha Realizada</th>
                                    <th>Realizada por</th>
                                    <th>Resultado</th>
                                    <th>Activo/Área</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {historialFiltrado.length === 0 ? (
                                    <tr><td colSpan="6" style={{ textAlign: 'center' }}>No se encontraron inspecciones.</td></tr>
                                ) : (
                                    historialFiltrado.map(ins => (
                                        <tr key={ins.ID_InspeccionRealizada}>
                                            <td>{ins.NombreFormulario} ({ins.ID_Formulario})</td>
                                            <td>{formatearFechaHora(ins.FechaInspeccion)}</td>
                                            <td>{ins.NombreUsuarioRealizo}</td>
                                            <td>
                                                <span className={`status-pill ${
                                                    ins.ResultadoGeneral === 'OK' ? 'status-activo' : 'status-pendiente'
                                                }`}>
                                                    {ins.ResultadoGeneral}
                                                </span>
                                            </td>
                                            <td>{ins.NombreActivo || 'N/A'}</td>
                                            <td className="action-buttons">
                                                <button 
                                                    className="btn btn-secondary"
                                                    onClick={() => abrirModalDetalle(ins.ID_InspeccionRealizada)}
                                                >
                                                    Ver Detalle
                                                </button>

                                                {ins.ResultadoGeneral === 'Con Hallazgos' && (
                                                    ins.ID_ACPM_Vinculada ? (
                                                        <button 
                                                            className="btn btn-success"
                                                            onClick={() => abrirModalVerACPM(ins.ID_ACPM_Vinculada)}
                                                        >
                                                            <BsEyeFill /> Ver ACPM
                                                        </button>
                                                    ) : (
                                                        <button 
                                                            className="btn btn-warning"
                                                            onClick={() => abrirModalCrearACPM(ins)}
                                                        >
                                                            Crear ACPM
                                                        </button>
                                                    )
                                                )}
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>

            {/* MODALES */}

            {modalDetalleAbierto && (
                <ModalVerInspeccion 
                    inspeccionId={inspeccionSeleccionadaId}
                    alCerrar={cerrarModalDetalle}
                />
            )}

            {/* Modal DILIGENCIAR con preguntas dinámicas */}
            {modalDiligenciarAbierto && formularioSeleccionado && (
                <ModalDiligenciarInspeccion 
                    idFormulario={formularioSeleccionado.ID_Formulario}
                    nombreFormulario={formularioSeleccionado.NombreFormulario}
                    tipoActivo={formularioSeleccionado.TipoActivoAsociado}
                    datosFormulario={{ preguntas: preguntasFormulario }}
                    alCerrar={cerrarModalDiligenciar}
                    alExito={handleInspeccionGuardada}
                />
            )}

            {modalCrearAcpmAbierto && (
                <ModalCrearACPM 
                    alCerrar={cerrarModalCrearACPM}
                    alExito={handleAcpmCreada}
                    initialData={acpmInitialData}
                />
            )}

            {modalVerAcpmId && (
                <ModalVerACPM 
                    acpmId={modalVerAcpmId}
                    alCerrar={cerrarModalVerACPM}
                />
            )}

            {modalCrearFormularioAbierto && (
                <ModalCrearFormulario 
                    alCerrar={() => setModalCrearFormularioAbierto(false)}
                    alExito={handleFormularioCreado}
                />
            )}

        </div>
    );
};

export default InspeccionesPage;


==================================================================
ARCHIVO: frontend\src\pages\LoginPage.jsx
==================================================================
// frontend/src/pages/LoginPage.jsx

import React, { useState } from 'react';
// eslint-disable-next-line no-unused-vars
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import '../style/LoginPage.css';
import logo from "../assets/logo-empaquetados.png";
// Iconos
import { BsShieldCheck, BsJournalCheck, BsPeople, BsArrowLeft, BsPersonFill, BsLockFill } from 'react-icons/bs';

const LoginPage = () => {
    const [view, setView] = useState('SELECCION');
    const [selectedRoleTitle, setSelectedRoleTitle] = useState(''); // Solo para visualización
    const [cedula, setCedula] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [isLoadingLogin, setIsLoadingLogin] = useState(false);
    const { login } = useAuth();

    // --- 1. SELECCIÓN DE PERFIL ---
    const handleSelectRole = (roleName) => {
        setSelectedRoleTitle(roleName);
        setView('FORMULARIO');
        setError('');
        setCedula('');
        setPassword('');
    };

    // --- 2. VOLVER ---
    const handleBack = () => {
        setView('SELECCION');
        setSelectedRoleTitle('');
        setError('');
    };

    // --- 3. LOGIN ---
    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');

        if (!cedula || !password) {
            setError('Por favor, complete todos los campos.');
            return;
        }

        setIsLoadingLogin(true);
        try {
            // El backend valida la credencial y devuelve el rol real del usuario
            await login(cedula, password);
            // La redirección la maneja el AuthContext o el App.jsx basado en el rol devuelto
        } catch (err) {
            setError(err.message || 'Credenciales incorrectas.');
            setIsLoadingLogin(false);
        }
    };

    // --- VISTA 1: SELECCIÓN DE ROL ---
    if (view === 'SELECCION') {
        return (
            <div className="login-container-selection">
                <div className="login-header-center">
                    <img src={logo} alt="Logo Empaquetados El Trece" className="login-logo-selection" />
                    <h1>Bienvenido al Sistema</h1>
                    <p>Empaquetados El Trece S.A.S</p>
                    <h3>Seleccione su perfil para ingresar:</h3>
                </div>

                <div className="role-cards-container">
                    {/* TARJETA 1: SG-SST (También entrada para Super Admin) */}
                    <div className="role-card" onClick={() => handleSelectRole('Seguridad y Salud en el Trabajo')}>
                        <div className="role-icon sst-color"><BsShieldCheck /></div>
                        <h3>Gestión SG-SST</h3>
                        <p>Administradores y Líderes SST</p>
                    </div>

                    {/* TARJETA 2: CALIDAD (NUEVO) */}
                    <div className="role-card" onClick={() => handleSelectRole('Gestión de Calidad')}>
                        <div className="role-icon calidad-color"><BsJournalCheck /></div>
                        <h3>Gestión de Calidad</h3>
                        <p>Auditores y Control de Calidad</p>
                    </div>

                    {/* TARJETA 3: COLABORADOR */}
                    <div className="role-card" onClick={() => handleSelectRole('Colaborador')}>
                        <div className="role-icon collab-color"><BsPeople /></div>
                        <h3>Colaborador</h3>
                        <p>Reportes y Consultas Operativas</p>
                    </div>
                </div>
                
                <div style={{marginTop: '2rem', fontSize: '0.8rem', color: '#aaa'}}>
                    v2.0 - Sistema Integrado de Gestión
                </div>
            </div>
        );
    }

    // --- VISTA 2: FORMULARIO ---
    return (
        <div className="login-container">
            {/* Columna Izquierda Visual */}
            <div className="login-visual-column">
                <div className="visual-content">
                    <h1>{selectedRoleTitle}</h1>
                    <p>Ingrese sus credenciales para acceder al módulo seleccionado.</p>
                </div>
            </div>

            {/* Columna Derecha Formulario */}
            <div className="login-form-column">
                <button className="btn-back" onClick={handleBack}>
                    <BsArrowLeft /> Volver
                </button>

                <div className="login-form-wrapper">
                    <div style={{ textAlign: 'center', marginBottom: '1rem' }}>
                        <img src={logo} alt="Logo" className="login-form-logo" />
                    </div>
                    <div className="login-logo-placeholder">Empaquetados El Trece</div>
                    <h2>Iniciar Sesión</h2>

                    <form onSubmit={handleSubmit}>
                        <div className="input-group">
                            <label htmlFor="cedula">Usuario / Cédula</label>
                            <div className="input-with-icon">
                                <BsPersonFill className="input-icon" />
                                <input
                                    type="text"
                                    id="cedula"
                                    value={cedula}
                                    onChange={(e) => setCedula(e.target.value)}
                                    placeholder="Ingrese su usuario"
                                    autoFocus
                                />
                            </div>
                        </div>

                        <div className="input-group">
                            <label htmlFor="password">Contraseña</label>
                            <div className="input-with-icon">
                                <BsLockFill className="input-icon" />
                                <input
                                    type="password"
                                    id="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="Ingrese su contraseña"
                                />
                            </div>
                        </div>

                        {error && <p className="login-error-message">{error}</p>}

                        <button type="submit" className="btn btn-primary login-button" disabled={isLoadingLogin}>
                            {isLoadingLogin ? 'Validando...' : 'Ingresar'}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    );
};

export default LoginPage;


==================================================================
ARCHIVO: frontend\src\pages\LogsPage.jsx
==================================================================
// frontend/src/pages/LogsPage.jsx

import React, { useState, useEffect, useCallback } from 'react';
import { buscarLogs, getLogFiltros } from '../services/logService';
import '../index.css'; // Estilos globales
import '../style/LogsPage.css'; // <-- 1. Importar el nuevo CSS
import { BsSearch, BsArrowCounterclockwise } from 'react-icons/bs';

// Estado inicial vacío para los filtros
const filtrosVacios = {
    idUsuario: '',
    accion: '',
    fechaInicio: '',
    fechaFin: ''
};

const LogsPage = () => {
    // --- Estados ---
    const [logs, setLogs] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);

    // --- Estados de Filtros ---
    const [filtros, setFiltros] = useState(filtrosVacios);
    const [listasFiltros, setListasFiltros] = useState({ usuarios: [], acciones: [] });

    // --- Carga Inicial de Datos (Logs y Filtros) ---
    
    // 1. Carga los dropdowns de filtros (solo una vez)
    useEffect(() => {
        const cargarListas = async () => {
            try {
                const data = await getLogFiltros();
                setListasFiltros(data);
            } catch (err) {
                console.error("Error cargando filtros:", err);
            }
        };
        cargarListas();
    }, []);

    // 2. Carga los logs (depende de 'filtros')
    const cargarLogs = useCallback(async (filtrosActuales) => {
        try {
            setIsLoading(true);
            const data = await buscarLogs(filtrosActuales);
            setLogs(data);
            setError(null);
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    }, []); // Ya no depende de 'filtros'

    // 3. Carga inicial de logs (con filtros vacíos)
    useEffect(() => {
        cargarLogs(filtros);
    }, [filtros, cargarLogs]);

    // --- Manejadores de Filtros ---
    const handleChange = (e) => {
        const { name, value } = e.target;
        setFiltros(prev => ({ ...prev, [name]: value }));
    };

    const handleBuscar = (e) => {
        e.preventDefault(); // Previene que el form recargue la pág
        cargarLogs(filtros); 
    };

    const handleLimpiar = () => {
        setFiltros(filtrosVacios);
        // La recarga se disparará automáticamente por el useEffect [filtros]
    };

    // Formatear la fecha para la tabla
    const formatearFechaHora = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        return new Date(fechaISO).toLocaleString('es-CO', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
    };

    return (
        <div className="page-container">
            {/* --- Encabezado --- */}
            <div className="page-header">
                <h1>Registro de Auditoría (Logs)</h1>
            </div>

            {/* --- 2. TARJETA DE FILTROS (Actualizada con CSS) --- */}
            <div className="page-content-card logs-filter-card">
                {/* Usamos <form> para que 'Enter' funcione en la búsqueda */}
                <form className="logs-filter-bar" onSubmit={handleBuscar}>
                    
                    <div className="filter-item">
                        <label htmlFor="idUsuario">Filtrar por Usuario:</label>
                        <select name="idUsuario" value={filtros.idUsuario} onChange={handleChange}>
                            <option value="">-- Todos los Usuarios --</option>
                            {listasFiltros.usuarios.map(u => (
                                <option key={u.ID_Usuario} value={u.ID_Usuario}>{u.NombreUsuario}</option>
                            ))}
                        </select>
                    </div>

                    <div className="filter-item">
                        <label htmlFor="accion">Filtrar por Acción:</label>
                        <select name="accion" value={filtros.accion} onChange={handleChange}>
                            <option value="">-- Todas las Acciones --</option>
                            {listasFiltros.acciones.map(a => (
                                <option key={a.Accion} value={a.Accion}>{a.Accion}</option>
                            ))}
                        </select>
                    </div>
                    
                    <div className="filter-item">
                        <label htmlFor="fechaInicio">Fecha Desde:</label>
                        <input type="date" name="fechaInicio" value={filtros.fechaInicio} onChange={handleChange} />
                    </div>

                    <div className="filter-item">
                        <label htmlFor="fechaFin">Fecha Hasta:</label>
                        <input type="date" name="fechaFin" value={filtros.fechaFin} onChange={handleChange} />
                    </div>

                    <div className="filter-buttons">
                        <button type="submit" className="btn btn-primary">
                            <BsSearch /> Buscar
                        </button>
                        <button type="button" className="btn btn-secondary" onClick={handleLimpiar}>
                            <BsArrowCounterclockwise /> Limpiar
                        </button>
                    </div>
                </form>
            </div>
            {/* --- FIN DE LA TARJETA DE FILTROS --- */}


            {/* --- Tarjeta de Contenido (Tabla) --- */}
            <div className="page-content-card">
                <div className="table-wrapper">
                    {isLoading && <p>Cargando registros...</p>}
                    {error && <p className="error-message">Error: {error}</p>}
                    
                    {!isLoading && !error && (
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha y Hora</th>
                                    <th>Usuario Admin</th>
                                    <th>Acción</th>
                                    <th>Descripción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {logs.length === 0 ? (
                                    <tr><td colSpan="4" style={{ textAlign: 'center' }}>No se encontraron registros con esos filtros.</td></tr>
                                ) : (
                                    logs.slice(0, 100).map((log) => ( // Limita a 100
                                        <tr key={log.ID_Log}>
                                            <td>{formatearFechaHora(log.FechaHora)}</td>
                                            <td>{log.NombreUsuario}</td>
                                            <td>
                                                <span className="status-pill status-proceso">
                                                    {log.Accion}
                                                </span>
                                            </td>
                                            <td>{log.Descripcion}</td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>
        </div>
    );
};

export default LogsPage;


==================================================================
ARCHIVO: frontend\src\pages\MedicinaLaboralPage.jsx
==================================================================
// frontend/src/pages/MedicinaLaboralPage.jsx

import React, { useState, useEffect, useMemo } from 'react';
import { getHistorialExamenes, generarPdfExamen } from '../services/medicalService';
import { BsPlusLg, BsFileEarmarkPdfFill, BsSearch } from 'react-icons/bs';
import '../index.css'; 

import ModalRegistrarExamen from '../components/ModalRegistrarExamen';
import ModalVerExamen from '../components/ModalVerExamen'; 

const MedicinaLaboralPage = () => {
    // --- Estados ---
    const [historial, setHistorial] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);
    const [isDownloading, setIsDownloading] = useState(null); 
    
    // --- Filtros (NUEVO) ---
    const [busqueda, setBusqueda] = useState('');
    const [filtroConcepto, setFiltroConcepto] = useState('');

    // --- Estados de Modales ---
    const [modalRegistroAbierto, setModalRegistroAbierto] = useState(false);
    const [modalVerAbierto, setModalVerAbierto] = useState(false); 
    const [examenSeleccionadoId, setExamenSeleccionadoId] = useState(null); 

    // --- Carga Inicial del Historial ---
    const cargarHistorial = async () => {
        try {
            setIsLoading(true);
            const data = await getHistorialExamenes();
            setHistorial(data);
            setError(null);
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    useEffect(() => {
        cargarHistorial();
    }, []); 

    // --- LÓGICA DE FILTRADO (NUEVA) ---
    const historialFiltrado = useMemo(() => {
        return historial.filter(examen => {
            const texto = busqueda.toLowerCase();
            
            // 1. Búsqueda por Nombre, Cédula o Tipo de Examen
            const matchTexto = 
                examen.NombreColaborador.toLowerCase().includes(texto) ||
                examen.CedulaColaborador.includes(texto) ||
                examen.TipoExamen.toLowerCase().includes(texto);

            // 2. Filtro por Concepto
            const matchConcepto = filtroConcepto ? examen.ConceptoAptitud === filtroConcepto : true;

            return matchTexto && matchConcepto;
        });
    }, [historial, busqueda, filtroConcepto]);

    // --- Manejadores ---
    const handleExamenRegistrado = () => {
        setModalRegistroAbierto(false); 
        cargarHistorial(); 
    };
    
    const abrirModalVer = (id) => {
        setExamenSeleccionadoId(id);
        setModalVerAbierto(true);
    };
    const cerrarModalVer = () => {
        setModalVerAbierto(false);
        setExamenSeleccionadoId(null);
    };

    const handleGenerarPDF = async (examen) => {
        setIsDownloading(examen.ID_ExamenMedico);
        try {
            await generarPdfExamen(examen.ID_ExamenMedico, examen.CedulaColaborador);
        } catch (err) {
            console.error(err);
            alert(`Error al generar el PDF: ${err.message}`);
        } finally {
            setIsDownloading(null);
        }
    };

    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        const fecha = new Date(fechaISO.split('T')[0] + 'T00:00:00');
        return fecha.toLocaleDateString('es-CO');
    };
    
    const getConceptoClass = (concepto) => {
        if (concepto === 'Apto') return 'status-activo'; 
        if (concepto === 'Apto con restricciones') return 'status-pendiente'; 
        if (concepto === 'No Apto') return 'status-inactivo'; 
        return '';
    };

    return (
        <div className="page-container">
            {/* --- Encabezado --- */}
            <div className="page-header">
                <h1>Medicina Laboral - Exámenes</h1>
                <button 
                    className="btn btn-primary"
                    onClick={() => setModalRegistroAbierto(true)}
                >
                    <BsPlusLg /> Registrar Examen
                </button>
            </div>

            {/* --- BARRA DE FILTROS (NUEVA) --- */}
            <div className="filters-bar" style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                {/* Input Búsqueda */}
                <div className="search-input-container" style={{ flex: 1, minWidth: '250px', position: 'relative' }}>
                    <BsSearch style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#aaa' }} />
                    <input 
                        type="text" 
                        className="form-control" 
                        placeholder="Buscar por nombre, cédula o tipo..." 
                        style={{ paddingLeft: '35px', height: '40px' }}
                        value={busqueda}
                        onChange={(e) => setBusqueda(e.target.value)}
                    />
                </div>

                {/* Select Concepto */}
                <div className="filter-select-container" style={{ minWidth: '220px' }}>
                    <select 
                        className="form-control"
                        style={{ height: '40px' }}
                        value={filtroConcepto}
                        onChange={(e) => setFiltroConcepto(e.target.value)}
                    >
                        <option value="">Todos los Conceptos</option>
                        <option value="Apto">Apto</option>
                        <option value="Apto con restricciones">Apto con restricciones</option>
                        <option value="No Apto">No Apto</option>
                    </select>
                </div>
            </div>

            {/* --- Tarjeta de Contenido (Tabla) --- */}
            <div className="page-content-card">
                <h2>Historial de Exámenes Registrados</h2>
                
                <div className="table-wrapper">
                    {isLoading && <p>Cargando historial...</p>}
                    {error && <p className="error-message">Error: {error}</p>}
                    
                    {!isLoading && !error && (
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Colaborador</th>
                                    <th>Cédula</th>
                                    <th>Tipo de Examen</th>
                                    <th>Fecha Examen</th>
                                    <th>Concepto Aptitud</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {historialFiltrado.length === 0 ? (
                                    <tr><td colSpan="6" style={{ textAlign: 'center' }}>No se encontraron exámenes.</td></tr>
                                ) : (
                                    historialFiltrado.map((examen) => (
                                        <tr key={examen.ID_ExamenMedico}>
                                            <td>{examen.NombreColaborador}</td>
                                            <td>{examen.CedulaColaborador}</td>
                                            <td>{examen.TipoExamen}</td>
                                            <td>{formatearFecha(examen.FechaExamen)}</td>
                                            <td>
                                                <span className={`status-pill ${getConceptoClass(examen.ConceptoAptitud)}`}>
                                                    {examen.ConceptoAptitud}
                                                </span>
                                            </td>
                                            <td className="action-buttons">
                                                <button 
                                                    className="btn btn-secondary"
                                                    onClick={() => abrirModalVer(examen.ID_ExamenMedico)}
                                                >
                                                    Ver Detalle
                                                </button>
                                                <button 
                                                    className="btn btn-icon"
                                                    title="Generar Carta de Recomendaciones"
                                                    onClick={() => handleGenerarPDF(examen)}
                                                    disabled={isDownloading === examen.ID_ExamenMedico}
                                                >
                                                    <BsFileEarmarkPdfFill />
                                                    {isDownloading === examen.ID_ExamenMedico ? '...' : 'PDF'}
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>
            
            {/* --- Renderizado de Modales --- */}
            {modalRegistroAbierto && (
                <ModalRegistrarExamen
                    alCerrar={() => setModalRegistroAbierto(false)}
                    alExito={handleExamenRegistrado}
                />
            )}
            
            {modalVerAbierto && (
                <ModalVerExamen
                    examenId={examenSeleccionadoId}
                    alCerrar={cerrarModalVer}
                />
            )}
        </div>
    );
};

export default MedicinaLaboralPage;


==================================================================
ARCHIVO: frontend\src\pages\PesvPage.jsx
==================================================================
// frontend/src/pages/PesvPage.jsx

import React, { useState, useEffect } from 'react';
import { getConductoresPESV, getMantenimientos } from '../services/pesvService';
import { getActivosTodos } from '../services/assetService';
import '../index.css';
import { BsConeStriped, BsPersonBadge, BsTools, BsTruck, BsPlusLg, BsPencilSquare, BsCheckCircle, BsFileEarmarkText } from 'react-icons/bs';

// Importamos los componentes hijos
import ModalGestionConductor from '../components/ModalGestionConductor';
import ModalCrearMantenimiento from '../components/ModalCrearMantenimiento';
import TabPasosPESV from '../components/TabPasosPESV'; 

const PesvPage = () => {
    // Estado de Pestañas
    const [activeTab, setActiveTab] = useState('implementacion'); 
    
    // Estados de Datos
    const [conductores, setConductores] = useState([]);
    const [mantenimientos, setMantenimientos] = useState([]);
    const [vehiculos, setVehiculos] = useState([]); // Todos los activos tipo vehículo
    const [isLoading, setIsLoading] = useState(false);

    // Estados de Modales
    const [modalConductorOpen, setModalConductorOpen] = useState(false);
    const [conductorSelected, setConductorSelected] = useState(null);
    const [modalMtoOpen, setModalMtoOpen] = useState(false);

    // Cargar datos al cambiar de pestaña
    useEffect(() => {
        cargarDatos();
    }, [activeTab]);

    const cargarDatos = async () => {
        // La pestaña 'implementacion' gestiona su propia carga de datos
        if (activeTab === 'implementacion') return;

        setIsLoading(true);
        try {
            if (activeTab === 'conductores') {
                const data = await getConductoresPESV();
                setConductores(data);
            } 
            else if (activeTab === 'vehiculos') {
                const allActivos = await getActivosTodos();
                // Filtramos solo lo que rueda
                const vehs = allActivos.filter(v => ['Vehiculo', 'Moto', 'Montacarga'].includes(v.TipoActivo));
                setVehiculos(vehs);
            }
            else if (activeTab === 'mantenimientos') {
                const mtos = await getMantenimientos();
                const allActivos = await getActivosTodos();
                setMantenimientos(mtos);
                setVehiculos(allActivos.filter(v => ['Vehiculo', 'Moto', 'Montacarga'].includes(v.TipoActivo)));
            }
        } catch (error) {
            console.error(error);
        } finally {
            setIsLoading(false);
        }
    };

    // --- HELPERS ---
    const abrirEditarConductor = (c) => {
        setConductorSelected(c);
        setModalConductorOpen(true);
    };

    const handleConductorGuardado = () => {
        setModalConductorOpen(false);
        setConductorSelected(null);
        cargarDatos(); // Recargar tabla
    };
    
    const handleMtoCreado = () => {
        setModalMtoOpen(false);
        cargarDatos(); // Recargar tabla
    };

    // Verificar si una fecha ya pasó (Vencido)
    const isVencido = (fechaISO) => {
        if (!fechaISO) return false;
        // Comparar solo fechas sin hora para evitar falsos positivos del mismo día
        const fecha = new Date(fechaISO).setHours(0,0,0,0);
        const hoy = new Date().setHours(0,0,0,0);
        return fecha < hoy;
    };

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>
                    <BsConeStriped style={{color:'#fd7e14', marginRight:'10px'}} /> 
                    Plan Estratégico de Seguridad Vial (PESV)
                </h1>
            </div>

            {/* --- NAVEGACIÓN (TABS) --- */}
            <div style={{display:'flex', gap:'0.5rem', marginBottom:'2rem', borderBottom:'2px solid #dee2e6', flexWrap: 'wrap'}}>
                <button 
                    className={`btn ${activeTab === 'implementacion' ? 'btn-primary' : 'btn-secondary'}`} 
                    onClick={() => setActiveTab('implementacion')}
                    style={{borderRadius:'8px 8px 0 0', borderBottom: 'none'}}
                >
                    <BsCheckCircle /> Implementación
                </button>
                <button 
                    className={`btn ${activeTab === 'conductores' ? 'btn-primary' : 'btn-secondary'}`} 
                    onClick={() => setActiveTab('conductores')}
                    style={{borderRadius:'8px 8px 0 0', borderBottom: 'none'}}
                >
                    <BsPersonBadge /> Conductores
                </button>
                <button 
                    className={`btn ${activeTab === 'vehiculos' ? 'btn-primary' : 'btn-secondary'}`} 
                    onClick={() => setActiveTab('vehiculos')}
                    style={{borderRadius:'8px 8px 0 0', borderBottom: 'none'}}
                >
                    <BsTruck /> Vehículos
                </button>
                <button 
                    className={`btn ${activeTab === 'mantenimientos' ? 'btn-primary' : 'btn-secondary'}`} 
                    onClick={() => setActiveTab('mantenimientos')}
                    style={{borderRadius:'8px 8px 0 0', borderBottom: 'none'}}
                >
                    <BsTools /> Mantenimientos
                </button>
            </div>

            {/* --- CONTENIDO --- */}
            <div className="page-content-card">
                
                {/* TAB 1: IMPLEMENTACIÓN (Gestor de Pasos) */}
                {activeTab === 'implementacion' && <TabPasosPESV />}

                {/* TAB 2: CONDUCTORES */}
                {activeTab === 'conductores' && (
                    <>
                        {isLoading ? <p>Cargando conductores...</p> : (
                            <div className="table-wrapper">
                                <table className="data-table">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Cédula</th>
                                            <th>Cargo</th>
                                            <th>Licencia</th>
                                            <th>Categoría</th>
                                            <th>Vencimiento</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {conductores.map(c => (
                                            <tr key={c.ID_Usuario}>
                                                <td>{c.NombreCompleto}</td>
                                                <td>{c.CedulaUsuario}</td>
                                                <td>{c.Cargo}</td>
                                                <td>{c.NumeroLicencia || '--'}</td>
                                                <td>{c.Categoria || '--'}</td>
                                                <td>
                                                    {c.VencimientoLicencia ? (
                                                        <span className={`status-pill ${isVencido(c.VencimientoLicencia) ? 'status-inactivo' : 'status-activo'}`}>
                                                            {new Date(c.VencimientoLicencia).toLocaleDateString()}
                                                        </span>
                                                    ) : <span style={{color:'#999'}}>--</span>}
                                                </td>
                                                <td>
                                                    <button className="btn btn-sm btn-secondary" onClick={() => abrirEditarConductor(c)}>
                                                        <BsPencilSquare /> Gestionar
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </>
                )}

                {/* TAB 3: VEHÍCULOS (Resumen) */}
                {activeTab === 'vehiculos' && (
                    <>
                        {isLoading ? <p>Cargando flota...</p> : (
                            <div className="table-wrapper">
                                <table className="data-table">
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>Placa / ID</th>
                                            <th>Descripción</th>
                                            <th>Kilometraje</th>
                                            <th>Venc. SOAT</th>
                                            <th>Venc. Tecno</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {vehiculos.map(v => (
                                            <tr key={v.ID_Activo}>
                                                <td>{v.TipoActivo}</td>
                                                <td><strong>{v.CodigoIdentificador}</strong></td>
                                                <td>{v.NombreDescriptivo}</td>
                                                <td style={{color:'#007BFF', fontWeight:'bold'}}>
                                                    {v.KilometrajeActual ? v.KilometrajeActual.toLocaleString() : 0} km
                                                </td>
                                                <td>
                                                    {v.SOAT_Vencimiento ? (
                                                        <span className={`status-pill ${isVencido(v.SOAT_Vencimiento) ? 'status-inactivo' : 'status-activo'}`}>
                                                            {new Date(v.SOAT_Vencimiento).toLocaleDateString()}
                                                        </span>
                                                    ) : '--'}
                                                </td>
                                                <td>
                                                    {v.Tecno_Vencimiento ? (
                                                        <span className={`status-pill ${isVencido(v.Tecno_Vencimiento) ? 'status-inactivo' : 'status-activo'}`}>
                                                            {new Date(v.Tecno_Vencimiento).toLocaleDateString()}
                                                        </span>
                                                    ) : '--'}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </>
                )}

                {/* TAB 4: MANTENIMIENTOS */}
                {activeTab === 'mantenimientos' && (
                    <>
                        <div style={{marginBottom:'1rem'}}>
                            <button className="btn btn-primary" onClick={() => setModalMtoOpen(true)}>
                                <BsPlusLg /> Registrar Mantenimiento
                            </button>
                        </div>
                        
                        {isLoading ? <p>Cargando historial...</p> : (
                            <div className="table-wrapper">
                                <table className="data-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Vehículo</th>
                                            <th>Tipo</th>
                                            <th>Descripción</th>
                                            <th>Taller</th>
                                            <th>Costo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {mantenimientos.length === 0 ? (
                                            <tr><td colSpan="6" style={{textAlign:'center'}}>No hay mantenimientos registrados.</td></tr>
                                        ) : (
                                            mantenimientos.map(m => (
                                                <tr key={m.ID_Mantenimiento}>
                                                    <td>{new Date(m.Fecha).toLocaleDateString()}</td>
                                                    <td>{m.Vehiculo} ({m.Placa})</td>
                                                    <td>
                                                        <span className={`status-pill ${m.TipoMantenimiento === 'Preventivo' ? 'status-activo' : 'status-inactivo'}`}>
                                                            {m.TipoMantenimiento}
                                                        </span>
                                                    </td>
                                                    <td>{m.Descripcion}</td>
                                                    <td>{m.Taller_Realizo || 'Interno'}</td>
                                                    <td>${(m.Costo || 0).toLocaleString()}</td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </>
                )}
            </div>

            {/* --- MODALES --- */}
            {modalConductorOpen && (
                <ModalGestionConductor 
                    conductor={conductorSelected} 
                    alCerrar={() => setModalConductorOpen(false)} 
                    alExito={handleConductorGuardado} 
                />
            )}
            
            {modalMtoOpen && (
                <ModalCrearMantenimiento 
                    vehiculos={vehiculos} 
                    alCerrar={() => setModalMtoOpen(false)} 
                    alExito={handleMtoCreado} 
                />
            )}
        </div>
    );
};

export default PesvPage;


==================================================================
ARCHIVO: frontend\src\pages\PlanificacionPage.jsx
==================================================================
// frontend/src/pages/PlanificacionPage.jsx

import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { 
    getCronogramas, 
    getActividadesPorCronograma, 
    eliminarActividad,
    eliminarCronograma 
} from '../services/scheduleService';
import { getACPMs } from '../services/acpmService'; 
import { Calendar, dateFnsLocalizer, Views } from 'react-big-calendar';
import format from 'date-fns/format';
import parse from 'date-fns/parse';
import startOfWeek from 'date-fns/startOfWeek';
import getDay from 'date-fns/getDay';
import es from 'date-fns/locale/es'; 
import 'react-big-calendar/lib/css/react-big-calendar.css'; 

import '../index.css'; 
import '../style/PlanificacionPage.css'; 
import { BsEyeFill, BsPlusLg, BsTrash, BsSearch, BsInfoCircle } from 'react-icons/bs'; 
import Swal from 'sweetalert2'; 

// Modales
import ModalCrearCronograma from '../components/ModalCrearCronograma.jsx';
import ModalCrearActividad from '../components/ModalCrearActividad.jsx';
import ModalEditarActividad from '../components/ModalEditarActividad.jsx';
import ModalConfirmarAccion from '../components/ModalConfirmarAccion.jsx'; 
import ModalGestionarActividad from '../components/ModalGestionarActividad.jsx';
import ModalVerEvidencias from '../components/ModalVerEvidencias.jsx';
import ModalDetalleActividad from '../components/ModalDetalleActividad.jsx';
import ModalVerACPM from '../components/ModalVerACPM.jsx'; 

const locales = { 'es': es };
const localizer = dateFnsLocalizer({ format, parse, startOfWeek: () => startOfWeek(new Date(), { weekStartsOn: 1 }), getDay, locales });
const messages = { allDay: 'Todo el día', previous: 'Anterior', next: 'Siguiente', today: 'Hoy', month: 'Mes', week: 'Semana', day: 'Día', agenda: 'Agenda', date: 'Fecha', time: 'Hora', event: 'Evento', noEventsInRange: 'No hay eventos en este rango.'};

const parseDateAsLocal = (dateString) => {
    if (!dateString) return null;
    // eslint-disable-next-line no-unused-vars
    try { const datePart = dateString.split('T')[0]; const [year, month, day] = datePart.split('-'); return new Date(year, month - 1, day); } catch (e) { return new Date(dateString); }
};

const PlanificacionPage = () => {
    const [cronogramas, setCronogramas] = useState([]);
    const [cronogramaSeleccionado, setCronogramaSeleccionado] = useState(null);
    const [cronogramaDescripcion, setCronogramaDescripcion] = useState(''); 
    
    const [actividades, setActividades] = useState([]);
    const [acpms, setAcpms] = useState([]); 

    const [isLoadingCronogramas, setIsLoadingCronogramas] = useState(true);
    const [isLoadingActividades, setIsLoadingActividades] = useState(false);
    const [error, setError] = useState(null);

    const [busqueda, setBusqueda] = useState('');
    const [filtroEstado, setFiltroEstado] = useState(''); 
    
    const [modalCronogramaAbierto, setModalCronogramaAbierto] = useState(false);
    const [modalActividadAbierto, setModalActividadAbierto] = useState(false);
    const [modalEditarAbierto, setModalEditarAbierto] = useState(false);
    const [modalConfirmarAbierto, setModalConfirmarAbierto] = useState(false);
    const [modalGestionarAbierto, setModalGestionarAbierto] = useState(false);
    const [modalEvidenciaAbierto, setModalEvidenciaAbierto] = useState(false);
    const [modalDetalleAbierto, setModalDetalleAbierto] = useState(false);
    const [modalVerACPMAbierto, setModalVerACPMAbierto] = useState(false); 
    const [acpmSeleccionadaId, setAcpmSeleccionadaId] = useState(null);

    const [itemAEliminar, setItemAEliminar] = useState(null); 
    const [actividadSeleccionada, setActividadSeleccionada] = useState(null); 
    
    const [calendarDate, setCalendarDate] = useState(new Date());
    const [calendarView, setCalendarView] = useState(Views.MONTH);
    
    // --- Carga Inicial ---
    const cargarDatosIniciales = useCallback(async () => {
        try {
            setIsLoadingCronogramas(true);
            const dataCronos = await getCronogramas();
            setCronogramas(dataCronos);
            const dataAcpms = await getACPMs();
            setAcpms(dataAcpms);

            if (dataCronos.length > 0 && !cronogramaSeleccionado) {
                const primerId = dataCronos[0].ID_Cronograma;
                handleSeleccionarCronograma(primerId, dataCronos); 
            }
        } catch (err) { setError(err.message); } finally { setIsLoadingCronogramas(false); }
    }, [cronogramaSeleccionado]); 
    
    useEffect(() => { cargarDatosIniciales(); }, []); 
    
    const handleSeleccionarCronograma = useCallback(async (idCronograma, cronogramasData = cronogramas) => {
        if (!idCronograma) return;
        setCronogramaSeleccionado(idCronograma); 
        const crono = cronogramasData.find(c => c.ID_Cronograma == idCronograma);
        setCronogramaDescripcion(crono?.Descripcion || 'Este cronograma no tiene descripción.');
        setIsLoadingActividades(true);
        setError(null);
        setActividades([]); 
        try {
            const data = await getActividadesPorCronograma(idCronograma);
            setActividades(data);
        } catch (err) { setError(err.message); } finally { setIsLoadingActividades(false); }
    }, [cronogramas]); 

    // --- Filtros ---
    const actividadesFiltradas = useMemo(() => {
        return actividades.filter(act => {
            const texto = busqueda.toLowerCase();
            const matchTexto = 
                act.NombreActividad.toLowerCase().includes(texto) ||
                (act.DescripcionActividad && act.DescripcionActividad.toLowerCase().includes(texto)) ||
                (act.Responsable && act.Responsable.toLowerCase().includes(texto));
            const matchEstado = filtroEstado ? act.EstadoActividad === filtroEstado : true;
            return matchTexto && matchEstado;
        });
    }, [actividades, busqueda, filtroEstado]);

    // --- Calendario ---
    const calendarEvents = useMemo(() => {
        // 1. Actividades
        const eventosActividades = actividadesFiltradas.map(act => ({
            title: act.NombreActividad, 
            start: parseDateAsLocal(act.FechaLimite), 
            end: parseDateAsLocal(act.FechaLimite), 
            allDay: true, 
            tipo: 'ACTIVIDAD', 
            resource: act 
        }));

        // 2. ACPMs (CORREGIDO: Muestra TODAS y usa FechaCierre si aplica)
        const eventosACPM = acpms.map(acpm => {
            const isCerrada = acpm.EstadoACPM === 'Cerrada';
            // Si está cerrada, usamos FechaCierre. Si no, FechaLimite.
            const fechaEvento = isCerrada && acpm.FechaCierre ? acpm.FechaCierre : acpm.FechaLimite;
            
            return {
                title: `ACPM: ${acpm.Origen} (${acpm.EstadoACPM})`, 
                start: parseDateAsLocal(fechaEvento),
                end: parseDateAsLocal(fechaEvento),
                allDay: true,
                tipo: 'ACPM', 
                resource: acpm
            };
        });

        return [...eventosActividades, ...eventosACPM];
    }, [actividadesFiltradas, acpms]); 

    const onCalendarNavigate = useCallback((newDate) => setCalendarDate(newDate), [setCalendarDate]);
    const onCalendarView = useCallback((newView) => setCalendarView(newView), [setCalendarView]);
    
    const handleSelectEvent = (event) => {
        if (event.tipo === 'ACPM') {
            setAcpmSeleccionadaId(event.resource.ID_ACPM);
            setModalVerACPMAbierto(true);
        } else {
            const actividad = event.resource;
            if (actividad.EstadoActividad === 'Realizada' || actividad.EstadoActividad === 'Cancelada') {
                abrirModalDetalle(actividad);
            } else {
                abrirModalGestionar(actividad);
            }
        }
    };

    const eventStyleGetter = (event) => {
        let backgroundColor = '#3174ad'; 
        
        if (event.tipo === 'ACPM') {
            // Gris para cerrada, Naranja para abierta/proceso
            backgroundColor = event.resource.EstadoACPM === 'Cerrada' ? '#6c757d' : '#fd7e14';
        } else {
            if (event.resource.EstadoActividad === 'Realizada') backgroundColor = '#28a745'; 
            else if (event.resource.EstadoActividad === 'Cancelada') backgroundColor = '#dc3545'; 
        }

        return { style: { backgroundColor, borderRadius: '5px', opacity: 0.9, color: 'white', border: '0px', display: 'block', fontSize: '0.85rem' } };
    };

    const refrescarActividades = () => { if (cronogramaSeleccionado) { handleSeleccionarCronograma(cronogramaSeleccionado); } };
    const handleCronogramaCreado = () => { setModalCronogramaAbierto(false); cargarDatosIniciales(); };
    const handleActividadCreada = () => { setModalActividadAbierto(false); refrescarActividades(); };
    const abrirModalEditar = (actividad) => { setActividadSeleccionada(actividad); setModalEditarAbierto(true); };
    const cerrarModalEditar = () => { setModalEditarAbierto(false); setActividadSeleccionada(null); };
    const handleActividadEditada = () => { cerrarModalEditar(); refrescarActividades(); };
    const abrirModalGestionar = (actividad) => { setActividadSeleccionada(actividad); setModalGestionarAbierto(true); };
    const cerrarModalGestionar = () => { setModalGestionarAbierto(false); setActividadSeleccionada(null); };
    const handleActividadGestionada = () => { cerrarModalGestionar(); refrescarActividades(); };
    const abrirModalEvidencia = (actividad) => { setActividadSeleccionada(actividad); setModalEvidenciaAbierto(true); };
    const cerrarModalEvidencia = () => { setModalEvidenciaAbierto(false); setActividadSeleccionada(null); };
    const abrirModalDetalle = (actividad) => { setActividadSeleccionada(actividad); setModalDetalleAbierto(true); };
    const cerrarModalDetalle = () => { setModalDetalleAbierto(false); setActividadSeleccionada(null); };
    const abrirModalEliminarActividad = (actividad) => { setItemAEliminar({ tipo: 'actividad', data: actividad }); setModalConfirmarAbierto(true); };
    const abrirModalEliminarCronograma = () => {
        if (!cronogramaSeleccionado) return;
        const crono = cronogramas.find(c => c.ID_Cronograma == cronogramaSeleccionado);
        if (crono) { setItemAEliminar({ tipo: 'cronograma', data: crono }); setModalConfirmarAbierto(true); }
    };
    const cerrarModalEliminar = () => { setModalConfirmarAbierto(false); setItemAEliminar(null); };

    const handleConfirmarEliminacion = async () => {
        if (!itemAEliminar) return;
        // eslint-disable-next-line no-useless-catch
        try {
            if (itemAEliminar.tipo === 'actividad') {
                await eliminarActividad(itemAEliminar.data.ID_Actividad);
                refrescarActividades();
            } else if (itemAEliminar.tipo === 'cronograma') {
                await eliminarCronograma(itemAEliminar.data.ID_Cronograma);
                setCronogramaSeleccionado(null); cargarDatosIniciales(); 
            }
        } catch (err) { throw err; }
    };

    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        const fecha = parseDateAsLocal(fechaISO);
        return fecha.toLocaleDateString('es-CO');
    };

    return (
        <div className="page-container">
            {/* --- Encabezado --- */}
            <div className="page-header">
                <h1>Planificación (Cronogramas y Actividades)</h1>
                <div className="header-actions">
                    <button className="btn btn-secondary" onClick={() => setModalCronogramaAbierto(true)}>
                        <BsPlusLg /> Crear Cronograma
                    </button>
                    <button className="btn btn-primary" disabled={!cronogramaSeleccionado} onClick={() => setModalActividadAbierto(true)}>
                        <BsPlusLg /> Añadir Actividad
                    </button>
                    {cronogramaSeleccionado && (
                        <button className="btn btn-danger" onClick={abrirModalEliminarCronograma} title="Eliminar el cronograma actual">
                            <BsTrash /> Eliminar Cronograma
                        </button>
                    )}
                </div>
            </div>

            {/* --- Selector de Cronograma --- */}
            <div className="cronograma-selector-container" style={{ marginBottom: '1.5rem', background: 'white', padding: '1rem', borderRadius: '8px', border: '1px solid #eee' }}>
                <div className="form-group" style={{ marginBottom: 0 }}>
                    <label htmlFor="cronograma" style={{ marginBottom: '0.5rem' }}>Seleccione un Cronograma:</label>
                    <select 
                        id="cronograma"
                        className="form-control"
                        value={cronogramaSeleccionado || ''}
                        onChange={(e) => handleSeleccionarCronograma(e.target.value)}
                        disabled={isLoadingCronogramas}
                    >
                        <option value="" disabled>-- Seleccione --</option>
                        {cronogramas.map(c => (
                            <option key={c.ID_Cronograma} value={c.ID_Cronograma}>
                                {c.NombreCronograma} ({c.AnioAplicacion || 'N/A'})
                            </option>
                        ))}
                    </select>
                </div>
                {cronogramaDescripcion && (
                    <p className="cronograma-descripcion" style={{ marginTop: '0.5rem', color: '#666', fontStyle: 'italic' }}>
                        {cronogramaDescripcion}
                    </p>
                )}
            </div>

            {/* --- CALENDARIO INTEGRADO (PRIMERO) --- */}
            <div className="page-content-card calendar-card" style={{marginBottom: '2rem'}}>
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                    <h2>Calendario General</h2>
                    <div style={{display: 'flex', gap: '1rem', fontSize: '0.9rem'}}>
                        <span style={{display: 'flex', alignItems: 'center', gap: '5px'}}><span style={{width: 10, height: 10, background: '#3174ad', borderRadius: '50%'}}></span> Pendiente</span>
                        <span style={{display: 'flex', alignItems: 'center', gap: '5px'}}><span style={{width: 10, height: 10, background: '#28a745', borderRadius: '50%'}}></span> Realizada</span>
                        <span style={{display: 'flex', alignItems: 'center', gap: '5px'}}><span style={{width: 10, height: 10, background: '#dc3545', borderRadius: '50%'}}></span> Cancelada</span>
                        <span style={{display: 'flex', alignItems: 'center', gap: '5px'}}><span style={{width: 10, height: 10, background: '#fd7e14', borderRadius: '50%'}}></span> ACPM (Abierta)</span>
                        <span style={{display: 'flex', alignItems: 'center', gap: '5px'}}><span style={{width: 10, height: 10, background: '#6c757d', borderRadius: '50%'}}></span> ACPM (Cerrada)</span>
                    </div>
                </div>
                
                {isLoadingActividades ? (
                    <p>Cargando calendario...</p>
                ) : (
                    <Calendar
                        localizer={localizer}
                        events={calendarEvents}
                        startAccessor="start"
                        endAccessor="end"
                        style={{ height: 600 }}
                        culture="es" 
                        messages={messages}
                        onSelectEvent={handleSelectEvent}
                        eventPropGetter={eventStyleGetter}
                        date={calendarDate}
                        view={calendarView} 
                        onNavigate={onCalendarNavigate}
                        onView={onCalendarView}
                    />
                )}
            </div>

            {/* --- BARRA DE FILTROS (EN EL MEDIO) --- */}
            <div className="filters-bar" style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                <div className="search-input-container" style={{ flex: 1, minWidth: '250px', position: 'relative' }}>
                    <BsSearch style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#aaa' }} />
                    <input type="text" className="form-control" placeholder="Buscar actividad, descripción o responsable..." style={{ paddingLeft: '35px', height: '40px' }} value={busqueda} onChange={(e) => setBusqueda(e.target.value)} />
                </div>
                <div className="filter-select-container" style={{ minWidth: '200px' }}>
                    <select className="form-control" style={{ height: '40px' }} value={filtroEstado} onChange={(e) => setFiltroEstado(e.target.value)}>
                        <option value="">Todos los Estados</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Realizada">Realizada</option>
                        <option value="Cancelada">Cancelada</option>
                    </select>
                </div>
            </div>

            {/* --- TABLA DE ACTIVIDADES (SEGUNDO - ABAJO) --- */}
            <div className="page-content-card">
                <h2>Listado de Actividades</h2>
                <div className="table-wrapper">
                    {!isLoadingActividades && !error && (
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Actividad</th>
                                    <th>Descripción</th> 
                                    <th>Responsable</th>
                                    <th>Fecha Límite</th>
                                    <th>Estado</th>
                                    <th>Evidencia</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {actividades.length === 0 && (
                                    <tr><td colSpan="8" style={{ textAlign: 'center' }}>{cronogramaSeleccionado ? 'Este cronograma aún no tiene actividades.' : 'Por favor, seleccione un cronograma.'}</td></tr>
                                )}
                                {actividadesFiltradas.map((act) => (
                                    <tr key={act.ID_Actividad}>
                                        <td title={act.NombreActividad}>{act.NombreActividad.substring(0, 30)}{act.NombreActividad.length > 30 ? '...' : ''}</td>
                                        <td title={act.DescripcionActividad}>{act.DescripcionActividad?.substring(0, 20) || 'N/A'}{act.DescripcionActividad?.length > 20 ? '...' : ''}</td>
                                        <td>{act.Responsable}</td>
                                        <td>{formatearFecha(act.FechaLimite)}</td>
                                        <td><span className={`status-pill ${
                                            act.EstadoActividad === 'Realizada' ? 'status-activo' :
                                            act.EstadoActividad === 'Pendiente' ? 'status-pendiente' : 'status-inactivo'
                                        }`}>{act.EstadoActividad}</span></td>
                                        
                                        <td>
                                            {act.EstadoActividad === 'Realizada' ? (
                                                <button 
                                                    className="btn btn-icon" 
                                                    onClick={() => abrirModalEvidencia(act)} 
                                                    title="Ver Evidencias"
                                                    style={{ color: '#6c757d', border: '1px solid #6c757d' }}
                                                >
                                                    <BsEyeFill /> Ver
                                                </button>
                                            ) : <span style={{ color: '#999', fontSize: '0.8rem' }}>-</span>}
                                        </td>

                                        <td className="action-buttons">
                                            {/* BOTÓN VER DETALLE */}
                                            <button 
                                                className="btn btn-secondary" 
                                                onClick={() => abrirModalDetalle(act)} 
                                                title="Ver Detalle Completo"
                                            >
                                                <BsInfoCircle /> Ver Detalle
                                            </button>

                                            {/* BOTONES DE GESTIÓN (Solo si NO es Realizada ni Cancelada) */}
                                            {act.EstadoActividad !== 'Realizada' && act.EstadoActividad !== 'Cancelada' && (
                                                <>
                                                    <button className="btn btn-secondary" onClick={() => abrirModalGestionar(act)} title="Cambiar Estado">Gestionar</button>
                                                    <button className="btn btn-warning" onClick={() => abrirModalEditar(act)} title="Editar Datos">Editar</button>
                                                    <button className="btn btn-danger" onClick={() => abrirModalEliminarActividad(act)} title="Eliminar Actividad"><BsTrash /></button>
                                                </>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div> 
            </div>
            
            {/* Modales */}
            {modalCronogramaAbierto && <ModalCrearCronograma alCerrar={() => setModalCronogramaAbierto(false)} alExito={handleCronogramaCreado} />}
            {modalActividadAbierto && <ModalCrearActividad idCronograma={cronogramaSeleccionado} alCerrar={() => setModalActividadAbierto(false)} alExito={handleActividadCreada} />}
            {modalEditarAbierto && <ModalEditarActividad actividad={actividadSeleccionada} alCerrar={cerrarModalEditar} alExito={handleActividadEditada} />}
            {modalConfirmarAbierto && <ModalConfirmarAccion titulo={itemAEliminar?.tipo === 'cronograma' ? 'Eliminar Cronograma' : 'Eliminar Actividad'} mensaje={itemAEliminar?.tipo === 'cronograma' ? `¿Eliminar cronograma?` : `¿Eliminar actividad?`} enConfirmar={handleConfirmarEliminacion} alCerrar={cerrarModalEliminar} textoBotonConfirmar="Eliminar" claseBoton="btn-danger" />}
            {modalGestionarAbierto && <ModalGestionarActividad actividad={actividadSeleccionada} alCerrar={cerrarModalGestionar} alExito={handleActividadGestionada} />}
            {modalEvidenciaAbierto && <ModalVerEvidencias actividad={actividadSeleccionada} alCerrar={cerrarModalEvidencia} />}
            {modalDetalleAbierto && <ModalDetalleActividad actividad={actividadSeleccionada} alCerrar={cerrarModalDetalle} />}
            {modalVerACPMAbierto && <ModalVerACPM acpmId={acpmSeleccionadaId} alCerrar={() => setModalVerACPMAbierto(false)} />}
        </div>
    );
};

export default PlanificacionPage;


==================================================================
ARCHIVO: frontend\src\pages\ReportarMaquinaPage.jsx
==================================================================
// frontend/src/pages/ReportarMaquinaPage.jsx

import React, { useState, useEffect } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { getActivosTodos } from '../services/assetService'; 
import { crearReporteMaquina } from '../services/reportService';
import { getFormularios, getPreguntasFormulario } from '../services/inspectionService';
import { useAuth } from '../context/AuthContext'; 
import '../index.css'; 
import '../style/ReportarPage.css'; 
import Swal from 'sweetalert2'; 
import { BsArrowLeftCircle, BsCheckCircle, BsExclamationTriangle, BsSpeedometer2 } from 'react-icons/bs';

const ReportarMaquinaPage = () => {
    const { usuario } = useAuth(); 
    
    const [idActivo, setIdActivo] = useState('');
    const [kilometraje, setKilometraje] = useState('');
    const [estadoReportado, setEstadoReportado] = useState('OK');
    const [descripcionProblema, setDescripcionProblema] = useState('');
    const [fotoReporte, setFotoReporte] = useState(null); 
    
    const [listaActivos, setListaActivos] = useState([]);
    const [listaFormularios, setListaFormularios] = useState([]);
    
    const [activoInfo, setActivoInfo] = useState(null);
    const [preguntasActivas, setPreguntasActivas] = useState([]);
    const [respuestasChecklist, setRespuestasChecklist] = useState({});
    
    const [isLoadingData, setIsLoadingData] = useState(true);
    const [isLoadingPreguntas, setIsLoadingPreguntas] = useState(false);
    const [isLoadingSubmit, setIsLoadingSubmit] = useState(false);
    const [error, setError] = useState('');
    const [debugInfo, setDebugInfo] = useState(null);

    // eslint-disable-next-line no-unused-vars
    const navigate = useNavigate();

    // 1. Carga Inicial Inteligente
    useEffect(() => {
        const cargarDatosMaestros = async () => {
            try {
                const [activos, formularios] = await Promise.all([
                    getActivosTodos(),
                    getFormularios()
                ]);
                
                const formulariosVisibles = formularios.filter(f => f.VisibleColaborador === true);
                setListaFormularios(formulariosVisibles);

                const tiposPermitidos = formulariosVisibles.map(f => f.TipoActivoAsociado.toLowerCase().trim());

                const activosFiltrados = activos.filter(a => 
                    a.TipoActivo && tiposPermitidos.includes(a.TipoActivo.toLowerCase().trim())
                );

                setListaActivos(activosFiltrados);

            } catch (err) {
                console.error(err);
                setError("Error conectando con el servidor.");
            } finally {
                setIsLoadingData(false);
            }
        };
        cargarDatosMaestros();
    }, []);

    // 2. Buscar Formulario
    useEffect(() => {
        if (!idActivo) {
            setPreguntasActivas([]);
            setDebugInfo(null);
            setEstadoReportado('OK');
            setActivoInfo(null);
            return;
        }

        const buscarPreguntas = async () => {
            setIsLoadingPreguntas(true);
            setRespuestasChecklist({});
            setEstadoReportado('OK');
            
            const activoSelect = listaActivos.find(a => a.ID_Activo == idActivo);
            if (!activoSelect) return;

            setActivoInfo(activoSelect);

            const tipoActivoReal = activoSelect.TipoActivo.trim();

            const formularioAsociado = listaFormularios.find(f => 
                f.TipoActivoAsociado && 
                f.TipoActivoAsociado.trim().toLowerCase() === tipoActivoReal.toLowerCase()
            );

            setDebugInfo({
                tipoDetectado: tipoActivoReal,
                formularioEncontrado: formularioAsociado ? formularioAsociado.NombreFormulario : "NINGUNO"
            });

            if (formularioAsociado) {
                try {
                    const preguntas = await getPreguntasFormulario(formularioAsociado.ID_Formulario);
                    setPreguntasActivas(preguntas);
                    
                    const inicial = {};
                    preguntas.forEach(p => { inicial[p.ID_Pregunta] = 'Cumple'; });
                    setRespuestasChecklist(inicial);
                } catch (err) {
                    console.error("Error preguntas:", err);
                }
            } else {
                setPreguntasActivas([]);
            }
            setIsLoadingPreguntas(false);
        };

        buscarPreguntas();
    }, [idActivo, listaActivos, listaFormularios]);

    const handleChecklistChange = (id, val) => {
        setRespuestasChecklist(prev => {
            const nuevasRespuestas = { ...prev, [id]: val };
            const hayFalla = Object.values(nuevasRespuestas).some(v => v === 'No Cumple');
            setEstadoReportado(hayFalla ? 'Con Problema' : 'OK');
            return nuevasRespuestas;
        });
    };

    const handleFileChange = (e) => setFotoReporte(e.target.files[0]);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');

        // Validación Kilometraje
        const esTipoVehiculo = ['vehiculo', 'moto', 'montacarga', 'carro', 'camion', 'tractomula', 'furgon'].some(t => 
            activoInfo?.TipoActivo.toLowerCase().includes(t)
        );

        if (activoInfo && esTipoVehiculo && !kilometraje) {
            setError('El kilometraje es obligatorio para este equipo.');
            return;
        }

        if (estadoReportado === 'Con Problema' && !descripcionProblema.trim()) {
            setError('Por favor describa el problema detectado en las observaciones.');
            return;
        }

        setIsLoadingSubmit(true);
        const formData = new FormData();
        formData.append('idActivo', idActivo);
        formData.append('estadoReportado', estadoReportado);
        if (kilometraje) formData.append('kilometraje', kilometraje);
        
        if (preguntasActivas.length > 0) {
            const reporteDetallado = preguntasActivas.map(p => ({
                pregunta: p.TextoPregunta,
                respuesta: respuestasChecklist[p.ID_Pregunta] || 'N/A'
            }));
            formData.append('datosReporte', JSON.stringify(reporteDetallado));
        }

        // --- CORRECCIÓN AQUÍ: Enviamos la descripción SIEMPRE que tenga texto ---
        if (descripcionProblema.trim()) {
            formData.append('descripcionProblema', descripcionProblema);
        }
        
        if (fotoReporte) formData.append('fotoReporte', fotoReporte);

        try {
            await crearReporteMaquina(formData);
            Swal.fire('Enviado', 'Reporte registrado exitosamente.', 'success');
            
            setIdActivo('');
            setEstadoReportado('OK');
            setDescripcionProblema('');
            setKilometraje('');
            setFotoReporte(null);
            setPreguntasActivas([]);
            setDebugInfo(null);
            setActivoInfo(null);
            e.target.reset();
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoadingSubmit(false);
        }
    };

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>Reporte Pre-Uso</h1>
                <Link to="/dashboard" className="btn btn-secondary"><BsArrowLeftCircle /> Volver</Link>
            </div>

            <div className="page-content-card" style={{ maxWidth: '800px', margin: '0 auto' }}>
                <form onSubmit={handleSubmit}>
                    
                    <div className="form-group">
                        <label>Seleccione el Equipo:</label>
                        {isLoadingData ? <p>Cargando activos...</p> : (
                            <select className="form-control" value={idActivo} onChange={(e) => setIdActivo(e.target.value)} required>
                                <option value="" disabled>-- Seleccione --</option>
                                {listaActivos.map(a => (
                                    <option key={a.ID_Activo} value={a.ID_Activo}>
                                        {a.NombreDescriptivo} ({a.TipoActivo}) - {a.CodigoIdentificador}
                                    </option>
                                ))}
                            </select>
                        )}
                    </div>

                    {/* INFO DEL ACTIVO */}
                    {activoInfo && (
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem', backgroundColor: '#eef2f7', padding: '1rem', borderRadius: '8px' }}>
                            <div className="form-group" style={{marginBottom:0}}>
                                <label style={{fontSize:'0.8rem', fontWeight:'bold', color:'#666'}}>Código:</label>
                                <div style={{fontSize:'1rem', fontWeight:'500'}}>{activoInfo.CodigoIdentificador}</div>
                            </div>
                            <div className="form-group" style={{marginBottom:0}}>
                                <label style={{fontSize:'0.8rem', fontWeight:'bold', color:'#666'}}>Marca/Modelo:</label>
                                <div style={{fontSize:'1rem'}}>{activoInfo.Marca || ''} {activoInfo.Modelo || ''}</div>
                            </div>
                            <div className="form-group" style={{marginBottom:0, gridColumn:'span 2'}}>
                                <label style={{fontSize:'0.8rem', fontWeight:'bold', color:'#666'}}>Responsable:</label>
                                <div style={{fontSize:'1rem', color: '#005A5B', fontWeight:'bold'}}>
                                    {activoInfo.NombreConductor || usuario?.nombre}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* CAMPO KILOMETRAJE */}
                    {activoInfo && ['vehiculo', 'moto', 'montacarga', 'carro', 'camion', 'tractomula', 'furgon'].some(t => activoInfo.TipoActivo.toLowerCase().includes(t)) && (
                        <div className="form-group">
                            <label style={{color: 'var(--color-acento)', fontWeight:'bold', display:'flex', alignItems:'center', gap:'5px'}}>
                                <BsSpeedometer2 /> Kilometraje Actual *
                            </label>
                            <input 
                                type="number" 
                                className="form-control" 
                                placeholder={`Anterior: ${activoInfo.KilometrajeActual || 0} km`} 
                                value={kilometraje} 
                                onChange={(e) => setKilometraje(e.target.value)} 
                                required
                                style={{borderColor: '#007BFF', backgroundColor: '#f0f8ff'}}
                            />
                        </div>
                    )}

                    {/* CHECKLIST */}
                    {!isLoadingPreguntas && preguntasActivas.length > 0 && (
                        <div style={{backgroundColor:'#f8f9fa', padding:'1rem', borderRadius:'8px', border:'1px solid #dee2e6', marginBottom:'1.5rem'}}>
                            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem', borderBottom:'1px solid #ddd', paddingBottom:'0.5rem'}}>
                                <h3 style={{margin:0, color:'var(--color-primario)'}}>Checklist</h3>
                                <span className={`status-pill ${estadoReportado === 'OK' ? 'status-activo' : 'status-inactivo'}`}>
                                    Estado: {estadoReportado}
                                </span>
                            </div>
                            
                            {preguntasActivas.map((p, idx) => (
                                <div key={p.ID_Pregunta} style={{display:'flex', justifyContent:'space-between', alignItems:'center', padding:'0.8rem 0', borderBottom:'1px solid #e0e0e0'}}>
                                    <span style={{flex:1, paddingRight:'10px', fontWeight:'500'}}>{idx + 1}. {p.TextoPregunta}</span>
                                    <div style={{display:'flex', gap:'15px'}}>
                                        <label style={{color:'#28a745', fontWeight:'600', cursor:'pointer', display:'flex', alignItems:'center', gap:'5px'}}>
                                            <input type="radio" name={`p_${p.ID_Pregunta}`} checked={respuestasChecklist[p.ID_Pregunta] === 'Cumple'} onChange={() => handleChecklistChange(p.ID_Pregunta, 'Cumple')} /> 
                                            Cumple
                                        </label>
                                        <label style={{color:'#dc3545', fontWeight:'600', cursor:'pointer', display:'flex', alignItems:'center', gap:'5px'}}>
                                            <input type="radio" name={`p_${p.ID_Pregunta}`} checked={respuestasChecklist[p.ID_Pregunta] === 'No Cumple'} onChange={() => handleChecklistChange(p.ID_Pregunta, 'No Cumple')} /> 
                                            No Cumple
                                        </label>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* AVISO SI NO HAY CHECKLIST */}
                    {!isLoadingPreguntas && idActivo && preguntasActivas.length === 0 && (
                        <div style={{padding:'1rem', backgroundColor:'#fff3cd', color:'#856404', borderRadius:'8px', marginBottom:'1.5rem', border:'1px solid #ffeeba'}}>
                            <strong>⚠️ Aviso:</strong> No hay checklist para el tipo <strong>"{debugInfo?.tipoDetectado}"</strong>.<br/>
                            (El Super Admin debe crear o activar un formulario para este tipo de activo).
                        </div>
                    )}

                    <div className="form-group">
                        <label>Observaciones / Detalles {estadoReportado === 'Con Problema' && <span style={{color:'red'}}>* (Obligatorio)</span>}</label>
                        <textarea 
                            className="form-control" 
                            rows="3" 
                            value={descripcionProblema} 
                            onChange={(e) => setDescripcionProblema(e.target.value)} 
                            placeholder={estadoReportado === 'Con Problema' ? "Describa qué falló..." : "Comentarios adicionales..."}
                            required={estadoReportado === 'Con Problema'}
                            style={{borderColor: estadoReportado === 'Con Problema' ? '#dc3545' : '#dee2e6'}}
                        />
                    </div>

                    <div className="form-group">
                        <label>Foto (Opcional)</label>
                        <input type="file" className="form-control" onChange={handleFileChange} accept="image/*" />
                    </div>

                    <button type="submit" className="btn btn-primary" style={{width:'100%'}} disabled={isLoadingSubmit}>
                        {isLoadingSubmit ? 'Enviando...' : 'Enviar Reporte'}
                    </button>
                    
                    {error && <p className="error-message" style={{marginTop:'1rem'}}>{error}</p>}
                </form>
            </div>
        </div>
    );
};

export default ReportarMaquinaPage;


==================================================================
ARCHIVO: frontend\src\pages\ReportarSeguridadPage.jsx
==================================================================
// frontend/src/pages/ReportarSeguridadPage.jsx

import React, { useState } from 'react';
import { useNavigate, Link } from 'react-router-dom'; // <-- 1. Importar Link
import { crearReporteSeguridad } from '../services/reportService'; 
import '../index.css'; 
import '../style/ReportarPage.css'; 
import Swal from 'sweetalert2'; // <-- Importar Swal
import { BsArrowLeftCircle } from 'react-icons/bs'; // <-- 2. Importar icono

const ReportarSeguridadPage = () => {
    // (Estados sin cambios)
    const [tipoReporte, setTipoReporte] = useState('Condicion'); 
    const [ubicacionArea, setUbicacionArea] = useState('');
    const [descripcion, setDescripcion] = useState('');
    const [fotoReporte, setFotoReporte] = useState(null); 
    const [isLoadingSubmit, setIsLoadingSubmit] = useState(false);
    const [error, setError] = useState('');

    // eslint-disable-next-line no-unused-vars
    const navigate = useNavigate();

    const handleFileChange = (e) => {
        setFotoReporte(e.target.files[0]);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setIsLoadingSubmit(true);

        const formData = new FormData();
        formData.append('tipoReporte', tipoReporte);
        formData.append('ubicacionArea', ubicacionArea);
        formData.append('descripcion', descripcion);
        if (fotoReporte) {
            formData.append('fotoReporte', fotoReporte);
        }

        try {
            await crearReporteSeguridad(formData);
            
            // --- 3. REEMPLAZAR 'alert()' ---
            Swal.fire({
                title: '¡Éxito!',
                text: 'Reporte de seguridad enviado exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            
            setTipoReporte('Condicion');
            setUbicacionArea('');
            setDescripcion('');
            setFotoReporte(null);
            e.target.reset(); 
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoadingSubmit(false);
        }
    };

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>Reportar Incidente / Condición Insegura</h1>
                {/* --- 4. AÑADIR BOTÓN DE VOLVER --- */}
                <Link to="/dashboard" className="btn btn-secondary">
                    <BsArrowLeftCircle /> Volver al Inicio
                </Link>
            </div>

            <div className="page-content-card" style={{ maxWidth: '700px', margin: '0 auto' }}>
                <form onSubmit={handleSubmit}>
                    <p>Utilice este formulario para reportar cualquier acto, condición insegura, incidente o accidente.</p>
                    
                    {/* (Resto del formulario sin cambios) */}
                    <div className="form-group"><label htmlFor="tipoReporte">Tipo de Reporte *</label><select id="tipoReporte" name="tipoReporte" value={tipoReporte} onChange={(e) => setTipoReporte(e.target.value)} required><option value="Condicion">Condición Insegura (Ej: piso mojado, cable expuesto)</option><option value="Acto">Acto Inseguro (Ej: no usar EPP)</option><option value="Incidente">Incidente (Casi accidente)</option><option value="Accidente">Accidente</option><option value="Sugerencia">Sugerencia de Mejora</option></select></div>
                    <div className="form-group"><label htmlFor="ubicacionArea">Ubicación / Área donde ocurrió *</label><input type="text" id="ubicacionArea" name="ubicacionArea" value={ubicacionArea} onChange={(e) => setUbicacionArea(e.target.value)} placeholder="Ej: Pasillo Bodega MP, Máquina Troqueladora" required /></div>
                    <div className="form-group"><label htmlFor="descripcion">Descripción detallada de lo ocurrido *</label><textarea id="descripcion" name="descripcion" rows="5" value={descripcion} onChange={(e) => setDescripcion(e.target.value)} placeholder="Sea lo más específico posible..." required /></div>
                    <div className="form-group"><label htmlFor="fotoReporte">Adjuntar Foto (Opcional)</label><input type="file" id="fotoReporte" name="fotoReporte" onChange={handleFileChange} accept=".jpg,.jpeg,.png" /></div>

                    <div className="form-footer">
                        <button type="submit" className="btn btn-primary" disabled={isLoadingSubmit}>
                            {isLoadingSubmit ? 'Enviando...' : 'Enviar Reporte de Seguridad'}
                        </button>
                    </div>
                    {error && <p className="modal-error" style={{marginTop: '1rem'}}>{error}</p>}
                </form>
            </div>
        </div>
    );
};

export default ReportarSeguridadPage;


==================================================================
ARCHIVO: frontend\src\pages\ReportesPage.jsx
==================================================================
// frontend/src/pages/ReportesPage.jsx

import React, { useState, useEffect, useMemo } from 'react';
import { getReportesMaquina, getReportesSeguridad } from '../services/reportService';
import '../index.css'; 
import '../style/PlanificacionPage.css'; // Reutiliza el estilo del filtro

// --- Importamos los modales ---
import ModalVerReporte from '../components/ModalVerReporte.jsx';
import ModalCrearACPM from '../components/ModalCrearACPM.jsx';
import ModalVerACPM from '../components/ModalVerACPM.jsx'; 
import { BsPlusLg, BsEyeFill } from 'react-icons/bs';

const ReportesPage = () => {
    // --- Estados ---
    const [reportesMaquina, setReportesMaquina] = useState([]);
    const [reportesSeguridad, setReportesSeguridad] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);
    const [filtroEstado, setFiltroEstado] = useState('Todos'); 
    
    // --- Estados de Modales ---
    const [modalVerAbierto, setModalVerAbierto] = useState(false);
    const [modalCrearAcpmAbierto, setModalCrearAcpmAbierto] = useState(false);
    const [modalVerAcpmId, setModalVerAcpmId] = useState(null); 
    const [reporteSeleccionado, setReporteSeleccionado] = useState(null); 
    const [acpmInitialData, setAcpmInitialData] = useState({});

    // --- Carga Inicial ---
    const cargarReportes = async (isRefreshing = false) => {
        try {
            if (!isRefreshing) setIsLoading(true);
            const [dataMaquina, dataSeguridad] = await Promise.all([
                getReportesMaquina(),
                getReportesSeguridad()
            ]);
            setReportesMaquina(dataMaquina);
            setReportesSeguridad(dataSeguridad);
            setError(null);
        } catch (err) {
            setError(err.message);
        } finally {
            if (!isRefreshing) setIsLoading(false);
        }
    };

    useEffect(() => {
        cargarReportes(false); 
    }, []); 

    // --- Lógica de Filtrado ---
    const reportesMaquinaFiltrados = useMemo(() => {
        if (filtroEstado === 'Todos') return reportesMaquina;
        return reportesMaquina.filter(rep => rep.EstadoRevision === filtroEstado);
    }, [reportesMaquina, filtroEstado]);

    const reportesSeguridadFiltrados = useMemo(() => {
        if (filtroEstado === 'Todos') return reportesSeguridad;
        return reportesSeguridad.filter(rep => rep.EstadoRevision === filtroEstado);
    }, [reportesSeguridad, filtroEstado]);


    // --- Manejadores de Modales ---
    const abrirModalVer = (reporte, tipo) => {
        setReporteSeleccionado({ reporte, tipo });
        setModalVerAbierto(true);
    };
    const cerrarModalVer = () => {
        setModalVerAbierto(false);
        setReporteSeleccionado(null);
    };
    const handleReporteRevisado = () => {
        cargarReportes(true); 
    };
    const abrirModalCrearACPM = (reporte, tipo) => {
        if (tipo === 'maquina') {
            setAcpmInitialData({
                origen: `Reporte Máquina ID: ${reporte.ID_ReporteMaquina}`,
                descripcionProblema: `(Activo: ${reporte.NombreActivo}) ${reporte.DescripcionProblema}`,
                idReporteMaquinaOrigen: reporte.ID_ReporteMaquina
            });
        } else { 
            setAcpmInitialData({
                origen: `Reporte Seguridad ID: ${reporte.ID_ReporteSeguridad}`,
                descripcionProblema: `(Área: ${reporte.UbicacionArea}) ${reporte.Descripcion}`,
                idReporteSeguridadOrigen: reporte.ID_ReporteSeguridad
            });
        }
        setModalCrearAcpmAbierto(true);
    };
    const cerrarModalCrearACPM = () => {
        setModalCrearAcpmAbierto(false);
        setAcpmInitialData({});
    };
    
    // Esta es la función que SÍ debe llamarse
    const handleAcpmCreada = (nuevoIdACPM) => {
        cerrarModalCrearACPM();
        cargarReportes(true); // Recarga las tablas (para obtener el nuevo ID vinculado)
        setModalVerAcpmId(nuevoIdACPM); // Opcional: abre el modal de "Ver"
    };
    
    const abrirModalVerACPM = (idACPM) => {
        setModalVerAcpmId(idACPM);
    };
    const cerrarModalVerACPM = () => {
        setModalVerAcpmId(null);
    };

    // Formatear la fecha
    const formatearFechaHora = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        return new Date(fechaISO).toLocaleString('es-CO');
    };

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>Gestión de Reportes de Colaboradores</h1>
            </div>

            <div className="cronograma-selector" style={{ marginBottom: '2rem' }}>
                <label htmlFor="filtro-estado">Filtrar por Estado:</label>
                <select id="filtro-estado" value={filtroEstado} onChange={(e) => setFiltroEstado(e.target.value)}>
                    <option value="Todos">Todos</option>
                    <option value="Nuevo">Nuevos</option>
                    <option value="Revisado">Revisados</option>
                </select>
            </div>

            {isLoading && <p>Cargando reportes...</p>}
            {error && <p className="error-message">Error: {error}</p>}

            {/* --- Tarjeta "Reportes de Máquina" --- */}
            {!isLoading && !error && (
                <div className="page-content-card" style={{ marginBottom: '2rem' }}>
                    <h2>Reportes de Estado de Máquina (Pre-uso)</h2>
                    <div className="table-wrapper">
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Máquina/Activo</th>
                                    <th>Reportado por</th>
                                    <th>Estado Reportado</th>
                                    <th>Descripción</th>
                                    <th>Estado Revisión</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {reportesMaquinaFiltrados.length === 0 ? (
                                    <tr><td colSpan="7" style={{ textAlign: 'center' }}>No hay reportes de máquina {filtroEstado !== 'Todos' ? `con estado "${filtroEstado}"` : ''}.</td></tr>
                                ) : (
                                    reportesMaquinaFiltrados.map((rep) => (
                                        <tr key={rep.ID_ReporteMaquina}>
                                            <td>{formatearFechaHora(rep.FechaHoraReporte)}</td>
                                            <td>{rep.NombreActivo} ({rep.CodigoActivo})</td>
                                            <td>{rep.NombreUsuarioReporta}</td>
                                            <td><span className={`status-pill ${rep.EstadoReportado === 'OK' ? 'status-activo' : 'status-pendiente'}`}>{rep.EstadoReportado}</span></td>
                                            <td title={rep.DescripcionProblema}>{rep.DescripcionProblema?.substring(0, 30) || 'N/A'}{rep.DescripcionProblema?.length > 30 ? '...' : ''}</td>
                                            <td><span className={`status-pill ${rep.EstadoRevision === 'Nuevo' ? 'status-pendiente' : 'status-inactivo'}`}>{rep.EstadoRevision}</span></td>
                                            <td className="action-buttons">
                                                <button className="btn btn-secondary" onClick={() => abrirModalVer(rep, 'maquina')}>Ver Detalle</button>
                                                {rep.EstadoReportado === 'Con Problema' && (
                                                    rep.ID_ACPM_Vinculada ? (
                                                        <button className="btn btn-success" onClick={() => abrirModalVerACPM(rep.ID_ACPM_Vinculada)}>
                                                            <BsEyeFill /> Ver ACPM
                                                        </button>
                                                    ) : (
                                                        <button className="btn btn-warning" onClick={() =>abrirModalCrearACPM(rep, 'maquina')}>Crear ACPM</button>
                                                    )
                                                )}
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div> 
                </div>
            )}

            {/* --- Tarjeta "Reportes de Seguridad" --- */}
            {!isLoading && !error && (
                <div className="page-content-card">
                    <h2>Reportes de Seguridad (Actos/Condiciones)</h2>
                    <div className="table-wrapper">
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Reportado por</th>
                                    <th>Ubicación</th>
                                    <th>Descripción</th>
                                    <th>Estado Revisión</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {reportesSeguridadFiltrados.length === 0 ? (
                                    <tr><td colSpan="7" style={{ textAlign: 'center' }}>No hay reportes de seguridad {filtroEstado !== 'Todos' ? `con estado "${filtroEstado}"` : ''}.</td></tr>
                                ) : (
                                    reportesSeguridadFiltrados.map((rep) => (
                                        <tr key={rep.ID_ReporteSeguridad}>
                                            <td>{formatearFechaHora(rep.FechaHoraReporte)}</td>
                                            <td>{rep.TipoReporte}</td>
                                            <td>{rep.NombreUsuarioReporta}</td>
                                            <td>{rep.UbicacionArea}</td>
                                            <td title={rep.Descripcion}>{rep.Descripcion.substring(0, 30)}...</td>
                                            <td><span className={`status-pill ${rep.EstadoRevision === 'Nuevo' ? 'status-pendiente' : 'status-inactivo'}`}>{rep.EstadoRevision}</span></td>
                                            <td className="action-buttons">
                                                <button className="btn btn-secondary" onClick={() => abrirModalVer(rep, 'seguridad')}>Ver Detalle</button>
                                                {rep.ID_ACPM_Vinculada ? (
                                                    <button className="btn btn-success" onClick={() => abrirModalVerACPM(rep.ID_ACPM_Vinculada)}>
                                                        <BsEyeFill /> Ver ACPM
                                                    </button>
                                                ) : (
                                                    <button className="btn btn-warning" onClick={() =>abrirModalCrearACPM(rep, 'seguridad')}>Crear ACPM</button>
                                                )}
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}
            
            {/* --- Renderizado de Modales --- */}
            {modalVerAbierto && ( <ModalVerReporte reporte={reporteSeleccionado.reporte} tipo={reporteSeleccionado.tipo} alCerrar={cerrarModalVer} alExito={handleReporteRevisado} /> )}
            
            {/* --- ESTA ES LA LÍNEA CORREGIDA --- */}
            {modalCrearAcpmAbierto && ( 
                <ModalCrearACPM 
                    alCerrar={cerrarModalCrearACPM} 
                    alExito={handleAcpmCreada} // <-- CORREGIDO
                    initialData={acpmInitialData} 
                /> 
            )}
            {/* --- FIN DE LA CORRECCIÓN --- */}

            {modalVerAcpmId && ( <ModalVerACPM acpmId={modalVerAcpmId} alCerrar={cerrarModalVerACPM} /> )}
        </div>
    );
};

export default ReportesPage;


==================================================================
ARCHIVO: frontend\src\pages\SolicitudesPage.jsx
==================================================================
// frontend/src/pages/SolicitudesPage.jsx

import React, { useState, useEffect, useRef } from 'react';
import { apiFetch } from '../services/apiService';
import { useAuth } from '../context/AuthContext';
import '../style/Solicitudes.css';
import Swal from 'sweetalert2';
// Iconos
import { 
    BsSend, BsFileEarmarkPdf, BsCheckCircle, BsXCircle, BsInbox, 
    BsDownload, BsCloudCheck, BsPencilSquare, BsArrowRepeat 
} from 'react-icons/bs';
import ModalFirmarSolicitud from '../components/ModalFirmarSolicitud';

const SolicitudesPage = () => {
    const { usuario } = useAuth();
    const [solicitudes, setSolicitudes] = useState([]);
    // eslint-disable-next-line no-unused-vars
    const [isLoading, setIsLoading] = useState(true);
    
    // Estados Formulario
    const [tipo, setTipo] = useState('Firma Documento');
    const [mensaje, setMensaje] = useState('');
    const [modoAdjunto, setModoAdjunto] = useState('interno'); 
    const [archivoSubido, setArchivoSubido] = useState(null);
    const [docInternoSeleccionado, setDocInternoSeleccionado] = useState('');
    const [listaDocsInternos, setListaDocsInternos] = useState([]);
    const [isSending, setIsSending] = useState(false);

    // Estados Modal Firma
    const [modalFirmaOpen, setModalFirmaOpen] = useState(false);
    const [solicitudAFirmar, setSolicitudAFirmar] = useState(null);

    // Lógica de Actualización Manual (Input oculto)
    const fileInputRef = useRef(null);
    const [solicitudParaActualizar, setSolicitudParaActualizar] = useState(null);

    const esSuperAdmin = usuario.rol === 'Super Admin';
    const API_URL = 'http://localhost:5000'; 

    useEffect(() => {
        cargarSolicitudes();
        if (!esSuperAdmin) cargarDocsInternos();
    }, []);

    const cargarSolicitudes = async () => {
        try {
            const data = await apiFetch('/solicitudes');
            setSolicitudes(data);
        } catch (error) { console.error(error); } finally { setIsLoading(false); }
    };

    const cargarDocsInternos = async () => {
        try {
            const docs = await apiFetch('/pesv/documentos-internos');
            setListaDocsInternos(docs);
        } catch (error) { console.error(error); }
    };

    // --- ENVIAR SOLICITUD ---
    const handleEnviar = async (e) => {
        e.preventDefault();
        setIsSending(true);

        const formData = new FormData();
        formData.append('tipo', tipo);
        formData.append('mensaje', mensaje);

        if (modoAdjunto === 'archivo' && archivoSubido) {
            formData.append('archivo', archivoSubido);
        } else if (modoAdjunto === 'interno' && docInternoSeleccionado) {
            formData.append('rutaDocumentoInterno', docInternoSeleccionado);
        }

        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_URL}/api/solicitudes`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            if (response.ok) {
                Swal.fire('Enviado', 'Solicitud creada exitosamente.', 'success');
                setMensaje('');
                setArchivoSubido(null);
                setDocInternoSeleccionado('');
                cargarSolicitudes();
            } else throw new Error('Error al enviar');
        // eslint-disable-next-line no-unused-vars
        } catch (error) {
            Swal.fire('Error', 'No se pudo enviar la solicitud.', 'error');
        } finally {
            setIsSending(false);
        }
    };

    // --- LÓGICA DE APROBACIÓN ---
    const handleAprobarClic = (solicitud) => {
        if (solicitud.RutaDocumento) {
            setSolicitudAFirmar(solicitud);
            setModalFirmaOpen(true);
        } else {
            // Aprobación simple
            apiFetch('/solicitudes/responder', {
                method: 'PUT',
                body: JSON.stringify({ idSolicitud: solicitud.ID_Solicitud, estado: 'Aprobado', comentario: 'Aprobado manual.' })
            }).then(() => {
                Swal.fire('Listo', 'Solicitud aprobada', 'success');
                cargarSolicitudes();
            });
        }
    };

    const handleRechazarClic = async (solicitud) => {
        const { value: text } = await Swal.fire({
            title: 'Rechazar Solicitud',
            input: 'textarea',
            inputPlaceholder: 'Motivo del rechazo...',
            showCancelButton: true,
            confirmButtonColor: '#d33'
        });
        if (text) {
            await apiFetch('/solicitudes/responder', {
                method: 'PUT',
                body: JSON.stringify({ idSolicitud: solicitud.ID_Solicitud, estado: 'Rechazado', comentario: text })
            });
            Swal.fire('Rechazado', 'Solicitud rechazada.', 'info');
            cargarSolicitudes();
        }
    };

    // --- LÓGICA DE ACTUALIZACIÓN MANUAL (BOTÓN RECICLAJE) ---
    const handleClicActualizar = (solicitud) => {
        setSolicitudParaActualizar(solicitud);
        fileInputRef.current.click(); 
    };

    const handleArchivoSeleccionado = async (e) => {
        const file = e.target.files[0];
        if (!file || !solicitudParaActualizar) return;

        const result = await Swal.fire({
            title: '¿Reemplazar documento firmado?',
            text: `Se subirá "${file.name}" como la versión final firmada.`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sí, subir'
        });

        if (result.isConfirmed) {
            const formData = new FormData();
            formData.append('idSolicitud', solicitudParaActualizar.ID_Solicitud);
            formData.append('archivo', file);

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/solicitudes/actualizar-doc`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                if (response.ok) {
                    Swal.fire('¡Listo!', 'Documento actualizado.', 'success');
                    cargarSolicitudes();
                } else throw new Error('Error');
            // eslint-disable-next-line no-unused-vars
            } catch (error) {
                Swal.fire('Error', 'No se pudo actualizar.', 'error');
            }
        }
        e.target.value = null;
        setSolicitudParaActualizar(null);
    };

    const getEstadoBadge = (estado) => {
        switch(estado) {
            case 'Pendiente': return <span className="status-pill status-pendiente">Pendiente</span>;
            case 'Aprobado': return <span className="status-pill status-activo">Aprobado</span>;
            case 'Rechazado': return <span className="status-pill status-inactivo">Rechazado</span>;
            default: return <span>{estado}</span>;
        }
    };

    return (
        <div className="solicitudes-container">
            <div className="page-header">
                <h1>{esSuperAdmin ? <><BsInbox /> Bandeja de Entrada</> : <><BsSend /> Centro de Solicitudes</>}</h1>
            </div>

            {/* INPUT OCULTO PARA ACTUALIZACIÓN */}
            <input 
                type="file" 
                ref={fileInputRef} 
                style={{display:'none'}} 
                accept=".pdf,.jpg,.png" 
                onChange={handleArchivoSeleccionado} 
            />

            {/* --- FORMULARIO SST --- */}
            {!esSuperAdmin && (
                <div className="solicitud-form-card">
                    <h3 style={{marginTop:0, borderBottom:'1px solid #eee', paddingBottom:'10px'}}>Nueva Solicitud</h3>
                    <form onSubmit={handleEnviar}>
                        <div className="form-grid">
                            <div className="form-group">
                                <label>Tipo de Solicitud</label>
                                <select className="form-control" value={tipo} onChange={e => setTipo(e.target.value)}>
                                    <option>Firma Documento</option>
                                    <option>Aprobación</option>
                                    <option>Otro</option>
                                </select>
                            </div>
                            <div className="form-group">
                                <label>Mensaje</label>
                                <input className="form-control" required value={mensaje} onChange={e => setMensaje(e.target.value)} placeholder="Describa su solicitud..." />
                            </div>
                        </div>

                        <div style={{backgroundColor:'#f8f9fa', padding:'1rem', borderRadius:'8px', border:'1px solid #dee2e6', marginBottom:'1rem'}}>
                            <label style={{fontWeight:'bold', marginBottom:'10px', display:'block'}}>Documento a Adjuntar:</label>
                            <div style={{display:'flex', gap:'20px', marginBottom:'15px'}}>
                                <label style={{cursor:'pointer'}}><input type="radio" checked={modoAdjunto === 'interno'} onChange={() => setModoAdjunto('interno')} /> <BsCloudCheck /> Del Software</label>
                                <label style={{cursor:'pointer'}}><input type="radio" checked={modoAdjunto === 'archivo'} onChange={() => setModoAdjunto('archivo')} /> <BsFileEarmarkPdf /> Subir PC</label>
                            </div>
                            
                            {modoAdjunto === 'interno' ? (
                                <select className="form-control" value={docInternoSeleccionado} onChange={e => setDocInternoSeleccionado(e.target.value)}>
                                    <option value="">-- Seleccione --</option>
                                    {listaDocsInternos.map(d => (
                                        <option key={d.ID_Evidencia} value={d.RutaArchivo}>{d.NombreArchivo}</option>
                                    ))}
                                </select>
                            ) : (
                                <input type="file" className="form-control" accept=".pdf,.jpg,.png" onChange={e => setArchivoSubido(e.target.files[0])} />
                            )}
                        </div>

                        <div style={{textAlign:'right'}}>
                            <button className="btn btn-primary" disabled={isSending}>{isSending ? 'Enviando...' : 'Enviar'}</button>
                        </div>
                    </form>
                </div>
            )}

            {/* --- TABLA --- */}
            <div className="solicitudes-list-card">
                <h3 style={{marginTop:0}}>Historial</h3>
                <div className="table-wrapper">
                    <table className="solicitud-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Solicitante</th>
                                <th>Mensaje</th>
                                <th>Documentos</th>
                                <th>Estado</th>
                                <th>Respuesta</th>
                                {esSuperAdmin && <th>Acciones</th>}
                            </tr>
                        </thead>
                        <tbody>
                            {solicitudes.map(s => (
                                <tr key={s.ID_Solicitud}>
                                    <td>{new Date(s.FechaSolicitud).toLocaleDateString()}</td>
                                    <td><strong>{s.Solicitante}</strong><br/><small>{s.Cargo}</small></td>
                                    <td style={{maxWidth:'250px'}}>{s.Mensaje}</td>
                                    
                                    {/* COLUMNA DOCUMENTOS */}
                                    <td>
                                        <div className="btn-doc-group">
                                            {s.RutaDocumento && (
                                                <a href={`${API_URL}/api/pesv/download/${s.RutaDocumento.split('/').pop()}`} className="btn-doc btn-doc-original">
                                                    <BsFileEarmarkPdf /> Original
                                                </a>
                                            )}

                                            {s.RutaDocumentoFirmado && (
                                                <a href={`${API_URL}/api/pesv/download/${s.RutaDocumentoFirmado.split('/').pop()}`} className="btn-doc btn-doc-firmado">
                                                    <BsCheckCircle /> Firmado
                                                </a>
                                            )}

                                            {/* Botón Actualizar (Solo Admin) */}
                                            {esSuperAdmin && (
                                                <button 
                                                    className="btn btn-sm" 
                                                    style={{marginTop:'5px', backgroundColor:'#fff', border:'1px dashed #007BFF', color:'#007BFF', width:'100%', fontSize:'0.75rem'}}
                                                    onClick={() => handleClicActualizar(s)}
                                                    title="Reemplazar firmado manualmente"
                                                >
                                                    <BsArrowRepeat /> {s.RutaDocumentoFirmado ? 'Cambiar' : 'Subir'}
                                                </button>
                                            )}

                                            {!s.RutaDocumento && !s.RutaDocumentoFirmado && '--'}
                                        </div>
                                    </td>

                                    <td>{getEstadoBadge(s.Estado)}</td>
                                    <td>{s.ComentarioAdmin || '--'}</td>
                                    
                                    {esSuperAdmin && s.Estado === 'Pendiente' && (
                                        <td className="actions-cell">
                                            <button className="btn btn-sm btn-primary" title="Firmar" onClick={() => handleAprobarClic(s)}><BsPencilSquare /></button>
                                            <button className="btn btn-sm btn-danger" title="Rechazar" onClick={() => handleRechazarClic(s)}><BsXCircle /></button>
                                        </td>
                                    )}
                                    {esSuperAdmin && s.Estado !== 'Pendiente' && <td>--</td>}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>

            {modalFirmaOpen && solicitudAFirmar && (
                <ModalFirmarSolicitud 
                    solicitud={solicitudAFirmar} 
                    alCerrar={() => setModalFirmaOpen(false)} 
                    alExito={() => { setModalFirmaOpen(false); cargarSolicitudes(); }} 
                />
            )}
        </div>
    );
};

export default SolicitudesPage;


==================================================================
ARCHIVO: frontend\src\pages\UsuariosPage.jsx
==================================================================
// frontend/src/pages/UsuariosPage.jsx

import React, { useState, useEffect, useMemo } from 'react';
import { getColaboradores, cambiarEstadoColaborador } from '../services/userService.js'; 
import '../index.css'; 
import { BsPlusLg, BsSearch } from 'react-icons/bs'; 

import ModalCrearUsuario from '../components/ModalCrearUsuario.jsx'; 
import ModalEditarUsuario from '../components/ModalEditarUsuario.jsx';
import ModalConfirmarAccion from '../components/ModalConfirmarAccion.jsx';
import ModalResetPassword from '../components/ModalResetPassword.jsx'; 

const UsuariosPage = () => {
    const [usuarios, setUsuarios] = useState([]); 
    const [isLoading, setIsLoading] = useState(true); 
    const [error, setError] = useState(null); 
    
    // --- Filtros (NUEVOS) ---
    const [busqueda, setBusqueda] = useState('');
    const [filtroEstado, setFiltroEstado] = useState('');

    // --- Modales ---
    const [modalCrearAbierto, setModalCrearAbierto] = useState(false);
    const [modalEditarAbierto, setModalEditarAbierto] = useState(false);
    const [modalConfirmarAbierto, setModalConfirmarAbierto] = useState(false);
    const [modalResetAbierto, setModalResetAbierto] = useState(false); 
    const [usuarioSeleccionado, setUsuarioSeleccionado] = useState(null);
    const [accionConfirmar, setAccionConfirmar] = useState(null); 

    const cargarUsuarios = async () => {
        try {
            setIsLoading(true);
            const data = await getColaboradores();
            setUsuarios(data);
            setError(null);
        } catch (err) { setError(err.message); } finally { setIsLoading(false); }
    };
    useEffect(() => { cargarUsuarios(); }, []); 

    // --- LÓGICA DE FILTRADO ---
    const usuariosFiltrados = useMemo(() => {
        return usuarios.filter(u => {
            const texto = busqueda.toLowerCase();
            
            // 1. Búsqueda por Texto
            const matchTexto = 
                u.NombreCompleto.toLowerCase().includes(texto) || 
                u.CedulaUsuario.includes(texto) ||
                (u.Cargo && u.Cargo.toLowerCase().includes(texto));
            
            // 2. Filtro por Estado
            const matchEstado = filtroEstado ? u.EstadoCuenta === filtroEstado : true;

            return matchTexto && matchEstado;
        });
    }, [usuarios, busqueda, filtroEstado]);

    // --- Manejadores ---
    const handleUsuarioCreado = () => { setModalCrearAbierto(false); cargarUsuarios(); };
    const abrirModalEditar = (usuario) => { setUsuarioSeleccionado(usuario); setModalEditarAbierto(true); };
    const cerrarModalEditar = () => { setModalEditarAbierto(false); setUsuarioSeleccionado(null); };
    const handleUsuarioEditado = () => { cerrarModalEditar(); cargarUsuarios(); };
    
    const abrirModalConfirmar = (usuario) => {
        setUsuarioSeleccionado(usuario);
        const proximaAccion = usuario.EstadoCuenta === 'Activo' ? 'Inactivar' : 'Activar';
        setAccionConfirmar(proximaAccion);
        setModalConfirmarAbierto(true);
    };
    const cerrarModalConfirmar = () => { setModalConfirmarAbierto(false); setUsuarioSeleccionado(null); setAccionConfirmar(null); };
    
    const handleConfirmarCambioEstado = async () => {
        if (!usuarioSeleccionado || !accionConfirmar) return;
        const nuevoEstado = (accionConfirmar === 'Inactivar') ? 'Inactivo' : 'Activo';
        // eslint-disable-next-line no-useless-catch
        try {
            await cambiarEstadoColaborador(usuarioSeleccionado.ID_Usuario, nuevoEstado);
            cargarUsuarios();
        } catch (err) { throw err; }
    };
    
    const abrirModalReset = (usuario) => { setUsuarioSeleccionado(usuario); setModalResetAbierto(true); };
    const cerrarModalReset = () => { setModalResetAbierto(false); setUsuarioSeleccionado(null); };
    const handlePasswordReseteado = () => { cerrarModalReset(); };
    
    const getRolClass = (rol) => {
        if (rol === 'Administrador SST') return 'status-proceso'; 
        if (rol === 'Colaborador') return 'status-inactivo'; 
        return 'status-inactivo';
    };

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>Gestión de Usuarios</h1>
                <button className="btn btn-primary" onClick={() => setModalCrearAbierto(true)}>
                    <BsPlusLg /> Crear Nuevo Usuario
                </button>
            </div>

            {/* --- BARRA DE FILTROS (NUEVA) --- */}
            <div className="filters-bar" style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                <div className="search-input-container" style={{ flex: 1, minWidth: '250px', position: 'relative' }}>
                    <BsSearch style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#aaa' }} />
                    <input 
                        type="text" 
                        className="form-control" 
                        placeholder="Buscar por nombre, cédula o cargo..." 
                        style={{ paddingLeft: '35px', height: '40px' }}
                        value={busqueda}
                        onChange={(e) => setBusqueda(e.target.value)}
                    />
                </div>
                <div className="filter-select-container" style={{ minWidth: '200px' }}>
                    <select 
                        className="form-control" 
                        style={{ height: '40px' }}
                        value={filtroEstado}
                        onChange={(e) => setFiltroEstado(e.target.value)}
                    >
                        <option value="">Todos los Estados</option>
                        <option value="Activo">Activos</option>
                        <option value="Inactivo">Inactivos</option>
                    </select>
                </div>
            </div>

            <div className="page-content-card">
                <div className="table-wrapper">
                    {isLoading && <p>Cargando usuarios...</p>}
                    {error && <p className="error-message">Error al cargar usuarios: {error}</p>}
                    
                    {!isLoading && !error && (
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre Completo</th>
                                    <th>Cédula (Usuario)</th>
                                    <th>Rol</th>
                                    <th>Área/Dpto.</th>
                                    <th>Cargo</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {usuariosFiltrados.length === 0 ? (
                                    <tr><td colSpan="7" style={{ textAlign: 'center' }}>No se encontraron usuarios.</td></tr>
                                ) : (
                                    usuariosFiltrados.map((user) => (
                                        <tr key={user.ID_Usuario}>
                                            <td>{user.NombreCompleto}</td>
                                            <td>{user.CedulaUsuario}</td>
                                            <td>
                                                <span className={`status-pill ${getRolClass(user.NombreRol)}`}>
                                                    {user.NombreRol}
                                                </span>
                                            </td>
                                            <td>{user.AreaDepartamento || 'N/A'}</td>
                                            <td>{user.Cargo || 'N/A'}</td>
                                            <td>
                                                <span className={`status-pill ${user.EstadoCuenta === 'Activo' ? 'status-activo' : 'status-inactivo'}`}>
                                                    {user.EstadoCuenta}
                                                </span>
                                            </td>
                                            <td className="action-buttons">
                                                <button className="btn btn-secondary" onClick={() => abrirModalEditar(user)}>Editar</button>
                                                <button 
                                                    className={`btn ${user.EstadoCuenta === 'Activo' ? 'btn-danger' : 'btn-success'}`}
                                                    onClick={() => abrirModalConfirmar(user)}
                                                >
                                                    {user.EstadoCuenta === 'Activo' ? 'Inactivar' : 'Activar'}
                                                </button>
                                                <button className="btn btn-warning" onClick={() => abrirModalReset(user)}>Reset Pass</button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>
            
            {modalCrearAbierto && ( <ModalCrearUsuario alCerrar={() => setModalCrearAbierto(false)} alExito={handleUsuarioCreado} /> )}
            {modalEditarAbierto && ( <ModalEditarUsuario usuario={usuarioSeleccionado} alCerrar={cerrarModalEditar} alExito={handleUsuarioEditado} /> )}
            {modalConfirmarAbierto && ( <ModalConfirmarAccion titulo={`${accionConfirmar} Usuario`} mensaje={`¿Estás seguro de que deseas ${accionConfirmar.toLowerCase()} a ${usuarioSeleccionado?.NombreCompleto}?`} enConfirmar={handleConfirmarCambioEstado} alCerrar={cerrarModalConfirmar} textoBotonConfirmar={accionConfirmar} claseBoton={accionConfirmar === 'Inactivar' ? 'btn-danger' : 'btn-success'} /> )}
            {modalResetAbierto && ( <ModalResetPassword usuario={usuarioSeleccionado} alCerrar={cerrarModalReset} alExito={handlePasswordReseteado} /> )}
        </div>
    );
};
export default UsuariosPage;


==================================================================
ARCHIVO: frontend\src\services\acpmService.js
==================================================================
// frontend/src/services/acpmService.js

import { apiFetch } from './apiService.js';

/**
 * @service getACPMs
 * @desc Obtiene la lista de todas las acciones ACPM (Admin)
 */
export const getACPMs = async () => {
    return apiFetch('/acpm'); // GET /api/acpm
};

/**
 * @service getACPMDetalle
 * @desc Obtiene el detalle de una ACPM específica (Admin)
 * @param {number} idACPM
 */
export const getACPMDetalle = async (idACPM) => {
    return apiFetch(`/acpm/${idACPM}`); // GET /api/acpm/:id
};

/**
 * @service crearACPM
 * @desc Crea una nueva acción ACPM (CU-03)
 * @param {object} datosACPM
 */
export const crearACPM = async (datosACPM) => {
    return apiFetch('/acpm', {
        method: 'POST',
        body: JSON.stringify(datosACPM),
    }); // POST /api/acpm
};

/**
 * @service gestionarACPM
 * @desc Actualiza estado, comentarios y sube evidencia de cierre (CU-04)
 * @param {number} idACPM
 * @param {FormData} formData - FormData con estado, comentarios y archivo
 */
export const gestionarACPM = async (idACPM, formData) => {
    const token = localStorage.getItem('token');
    
    const response = await fetch(`http://localhost:5000/api/acpm/${idACPM}`, {
        method: 'PATCH',
        headers: {
            'Authorization': `Bearer ${token}`,
        },
        body: formData,
    });

    const data = await response.json();
    if (!response.ok) {
        throw new Error(data.msg || 'Error al gestionar la ACPM');
    }
    return data;
};

/**
 * @service getEvidenciasPorACPM
 * @desc Obtiene la lista de archivos de evidencia de una ACPM
 * @param {number} idACPM
 */
export const getEvidenciasPorACPM = async (idACPM) => {
    return apiFetch(`/acpm/${idACPM}/evidencias`); // <--- NUEVA FUNCIÓN
};


==================================================================
ARCHIVO: frontend\src\services\apiService.js
==================================================================
// frontend/src/services/apiService.js

import { getCurrentToken } from './authService';

const BASE_URL = 'http://localhost:5000/api';

export const apiFetch = async (endpoint, options = {}) => {
    const token = getCurrentToken(); 

    const config = {
        ...options, 
        headers: {
            'Content-Type': 'application/json',
            ...options.headers, 
        },
    };

    if (token) {
        config.headers['Authorization'] = `Bearer ${token}`;
    }

    try {
        const response = await fetch(`${BASE_URL}${endpoint}`, config);
        
        // --- CAMBIO AQUÍ ---
        // Intentamos leer la respuesta como JSON
        let data;
        try {
            data = await response.json();
        } catch (jsonError) {
            // Si falla (ej. 500 y envía texto plano "Error del servidor")
            // creamos nuestro propio objeto de error.
            data = { msg: `Error: ${response.statusText}` };
        }
        // --- FIN DEL CAMBIO ---


        if (!response.ok) {
            throw new Error(data.msg || data.errors?.[0]?.msg || 'Error en la petición a la API');
        }

        return data;

    } catch (error) {
        console.error(`Error en apiFetch (${endpoint}):`, error);
        throw error; 
    }
};


==================================================================
ARCHIVO: frontend\src\services\assetService.js
==================================================================
// frontend/src/services/assetService.js

import { apiFetch } from './apiService.js';

export const getActivosTodos = async () => {
    return apiFetch('/activos');
};

export const getActivosPorTipo = async (tipoActivo) => {
    return apiFetch(`/activos/tipo/${tipoActivo}`);
};

/**
 * @service getTiposActivosDisponibles
 * @desc Obtiene la lista de tipos de activos (dinámica desde la BD)
 */
export const getTiposActivosDisponibles = async () => {
    return apiFetch('/activos/tipos'); // GET /api/activos/tipos
};

export const crearActivo = async (datosActivo) => {
    return apiFetch('/activos', { method: 'POST', body: JSON.stringify(datosActivo) });
};

export const actualizarActivo = async (idActivo, datosActivo) => {
    return apiFetch(`/activos/${idActivo}`, { method: 'PUT', body: JSON.stringify(datosActivo) });
};

export const eliminarActivo = async (idActivo) => {
    return apiFetch(`/activos/${idActivo}`, { method: 'DELETE' });
};


==================================================================
ARCHIVO: frontend\src\services\authService.js
==================================================================
// frontend/src/services/authService.js

// La URL base de tu API de backend
const API_URL = 'http://localhost:5000/api/auth';

/**
 * @service login
 * @desc Llama al endpoint /api/auth/login
 * @param {string} cedula
 * @param {string} password
 * @returns {object} { token }
 */
export const login = async (cedula, password) => {
    try {
        const response = await fetch(`${API_URL}/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ cedula, password }),
        });

        const data = await response.json();

        if (!response.ok) {
            // Si la respuesta no es 2xx, lanza un error (ej. "Credenciales inválidas")
            throw new Error(data.msg || 'Error al iniciar sesión');
        }

        // Si el login es exitoso (respuesta 200 OK)
        if (data.token) {
            // Guarda el token en el localStorage para persistir la sesión
            localStorage.setItem('token', data.token);
        }
        
        return data; // Devuelve { token }

    } catch (error) {
        console.error('Error en authService.login:', error);
        // Lanza el error para que el componente de la UI lo atrape
        throw error;
    }
};

/**
 * @service logout
 * @desc Cierra la sesión del usuario
 */
export const logout = () => {
    // Simplemente remueve el token del almacenamiento
    localStorage.removeItem('token');
};

/**
 * @service getCurrentToken
 * @desc Obtiene el token actual del localStorage
 */
export const getCurrentToken = () => {
    return localStorage.getItem('token');
};


==================================================================
ARCHIVO: frontend\src\services\dashboardService.js
==================================================================
// frontend/src/services/dashboardService.js

import { apiFetch } from './apiService.js';

/**
 * @service getAdminKPIs
 * @desc Obtiene los 4 KPIs (contadores) para el dashboard del Admin
 */
export const getAdminKPIs = async () => {
    return apiFetch('/dashboard/admin-kpis'); // GET /api/dashboard/admin-kpis
};

/**
 * @service getAdminActividadesPendientes
 * @desc Obtiene la lista Top 5 de actividades pendientes
 */
export const getAdminActividadesPendientes = async () => {
    return apiFetch('/dashboard/admin-actividades'); // GET /api/dashboard/admin-actividades
};

/**
 * @service getAdminReportesRecientes
 * @desc Obtiene la lista Top 5 de reportes nuevos
 */
export const getAdminReportesRecientes = async () => {
    return apiFetch('/dashboard/admin-reportes'); // GET /api/dashboard/admin-reportes
};


==================================================================
ARCHIVO: frontend\src\services\documentService.js
==================================================================
// frontend/src/services/documentService.js

import { apiFetch } from './apiService.js';
import Swal from 'sweetalert2';

/**
 * @service getContenidoCarpeta
 * @desc Obtiene las carpetas y archivos de un ID de carpeta
 */
export const getContenidoCarpeta = async (idCarpeta) => {
    return apiFetch(`/documentos/carpeta/${idCarpeta}`); 
};

/**
 * @service crearCarpeta
 * @desc Crea una nueva carpeta (CU-25)
 */
export const crearCarpeta = async (nombreCarpeta, idCarpetaPadre) => {
    return apiFetch('/documentos/carpeta', {
        method: 'POST',
        body: JSON.stringify({ nombreCarpeta, idCarpetaPadre }),
    }); 
};

/**
 * @service subirArchivos
 * @desc Sube uno o más archivos (CU-26)
 */
export const subirArchivos = async (formData) => {
    const token = localStorage.getItem('token');
    
    const response = await fetch('http://localhost:5000/api/documentos/upload', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData,
    });

    const data = await response.json();
    if (!response.ok) {
        throw new Error(data.msg || 'Error al subir los archivos');
    }
    return data;
};

/**
 * @service descargarDocumento
 * @desc Descarga un archivo de forma segura usando token (CU-27)
 */
export const descargarDocumento = async (idDocumento, nombreOriginal) => {
    const token = localStorage.getItem('token');
    const response = await fetch(`http://localhost:5000/api/documentos/descargar/${idDocumento}`, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!response.ok) {
        try { const errData = await response.json(); throw new Error(errData.msg || 'No se pudo descargar');} 
        // eslint-disable-next-line no-unused-vars
        catch (e) { throw new Error(`Error ${response.status}: No se pudo descargar el archivo.`); }
    }
    
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = nombreOriginal; 
    document.body.appendChild(a); 
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
};

/**
 * @service getDocumentoBlob
 * @desc Obtiene un archivo como un Blob para visualización (Tanda 3.D)
 * @param {number} idDocumento
 */
export const getDocumentoBlob = async (idDocumento) => {
    const token = localStorage.getItem('token');
    const response = await fetch(`http://localhost:5000/api/documentos/stream/${idDocumento}`, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!response.ok) {
        throw new Error('No se pudo cargar el documento para visualización.');
    }
    return await response.blob();
};


/**
 * @service eliminarDocumento
 * @desc Elimina un documento (CU-28)
 */
export const eliminarDocumento = async (idDocumento) => {
    return apiFetch(`/documentos/documento/${idDocumento}`, {
        method: 'DELETE',
    }); 
};

/**
 * @service eliminarCarpeta
 * @desc Elimina una carpeta (CU-25)
 */
export const eliminarCarpeta = async (idCarpeta) => {
    return apiFetch(`/documentos/carpeta/${idCarpeta}`, {
        method: 'DELETE',
    }); 
};


==================================================================
ARCHIVO: frontend\src\services\indicatorService.js
==================================================================
// frontend/src/services/indicatorService.js
import { apiFetch } from './apiService.js';

export const guardarIndicador = async (datos) => {
    return apiFetch('/indicadores', {
        method: 'POST',
        body: JSON.stringify(datos)
    });
};

export const getIndicadoresAnuales = async (anio) => {
    return apiFetch(`/indicadores/${anio}`);
};


==================================================================
ARCHIVO: frontend\src\services\inspectionService.js
==================================================================
// frontend/src/services/inspectionService.js

import { apiFetch } from './apiService.js';

export const getInspeccionesHistorial = async () => {
    return apiFetch('/inspecciones');
};

export const crearInspeccion = async (payload) => {
    return apiFetch('/inspecciones', {
        method: 'POST',
        body: JSON.stringify(payload),
    });
};

export const getInspeccionDetalle = async (id) => {
    return apiFetch(`/inspecciones/${id}`);
};

export const crearNuevoFormulario = async (datos) => {
    return apiFetch('/inspecciones/formularios', {
        method: 'POST',
        body: JSON.stringify(datos),
    });
};

export const getFormularios = async () => {
    return apiFetch('/inspecciones/formularios');
};

export const getPreguntasFormulario = async (idFormulario) => {
    return apiFetch(`/inspecciones/formularios/${idFormulario}/preguntas`);
};

export const agregarPregunta = async (idFormulario, textoPregunta) => {
    return apiFetch(`/inspecciones/formularios/${idFormulario}/preguntas`, {
        method: 'POST',
        body: JSON.stringify({ textoPregunta })
    });
};

export const eliminarPregunta = async (idPregunta) => {
    return apiFetch(`/inspecciones/preguntas/${idPregunta}`, {
        method: 'DELETE'
    });
};

// --- NUEVA FUNCIÓN: CAMBIAR VISIBILIDAD ---
export const toggleVisibilidadFormulario = async (idFormulario, visible) => {
    return apiFetch(`/inspecciones/formularios/${idFormulario}/visibilidad`, {
        method: 'PATCH',
        body: JSON.stringify({ visible })
    });
};


==================================================================
ARCHIVO: frontend\src\services\logService.js
==================================================================
// frontend/src/services/logService.js
import { apiFetch } from './apiService.js';

/**
 * @service buscarLogs
 * @desc (Admin) Obtiene la lista de registros de auditoría filtrados
 * @param {object} filtros - { idUsuario, accion, fechaInicio, fechaFin }
 */
export const buscarLogs = async (filtros) => {
    return apiFetch('/logs/buscar', {
        method: 'POST',
        body: JSON.stringify(filtros || {}),
    }); // POST /api/logs/buscar
};

/**
 * @service getLogFiltros
 * @desc (Admin) Obtiene las listas de usuarios y acciones para los filtros
 */
export const getLogFiltros = async () => {
    return apiFetch('/logs/filtros'); // GET /api/logs/filtros
};


==================================================================
ARCHIVO: frontend\src\services\medicalService.js
==================================================================
// frontend/src/services/medicalService.js

import { apiFetch } from './apiService.js';

/**
 * @service getHistorialExamenes
 * @desc Obtiene la lista de todos los exámenes médicos registrados
 */
export const getHistorialExamenes = async () => {
    return apiFetch('/medicina'); // GET /api/medicina
};

/**
 * @service registrarExamen
 * @desc Registra un nuevo examen médico (RF-029)
 * @param {object} datosExamen
 */
export const registrarExamen = async (datosExamen) => {
    return apiFetch('/medicina', {
        method: 'POST',
        body: JSON.stringify(datosExamen),
    }); // POST /api/medicina
};

/**
 * @service generarPdfExamen
 * @desc Descarga el PDF de recomendaciones (RF-030)
 * @param {number} idExamenMedico
 * @param {string} cedulaColaborador - Para el nombre del archivo
 */
export const generarPdfExamen = async (idExamenMedico, cedulaColaborador) => {
    const token = localStorage.getItem('token');
    const response = await fetch(`http://localhost:5000/api/medicina/${idExamenMedico}/pdf`, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!response.ok) {
        try { const errData = await response.json(); throw new Error(errData.msg || 'No se pudo generar el PDF');} 
        // eslint-disable-next-line no-unused-vars
        catch (e) { throw new Error(`Error ${response.status}: No se pudo generar el PDF.`); }
    }
    
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Recomendaciones-${cedulaColaborador}.pdf`; 
    document.body.appendChild(a); 
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
};

/**
 * @service getExamenMedicoDetalle
 * @desc Obtiene el detalle completo de UN examen (para el modal)
 * @param {number} idExamenMedico
 */
export const getExamenMedicoDetalle = async (idExamenMedico) => {
    // Esta es la función que faltaba exportar
    return apiFetch(`/medicina/${idExamenMedico}`); // GET /api/medicina/:id
};


==================================================================
ARCHIVO: frontend\src\services\notificationService.js
==================================================================
// backend/services/notificationService.js
import { poolPromise, mssql } from '../config/dbConfig.js';

/**
 * @desc Crea una notificación en la BD
 * @param {Object} data - { idUsuarioDestino, rolDestino, titulo, mensaje, ruta }
 */
export const crearNotificacion = async ({ idUsuarioDestino, rolDestino, titulo, mensaje, ruta }) => {
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idUsuarioDestino', mssql.Int, idUsuarioDestino || null)
            .input('rolDestino', mssql.NVarChar, rolDestino || null)
            .input('titulo', mssql.NVarChar, titulo)
            .input('mensaje', mssql.NVarChar, mensaje)
            .input('rutaAccion', mssql.NVarChar, ruta || null)
            .query('EXEC SP_CREATE_Notificacion @idUsuarioDestino, @rolDestino, @titulo, @mensaje, @rutaAccion');
    } catch (err) {
        console.error('Error creando notificación interna:', err.message);
        // No lanzamos error para no interrumpir el flujo principal
    }
};


==================================================================
ARCHIVO: frontend\src\services\pesvService.js
==================================================================
// frontend/src/services/pesvService.js
import { apiFetch } from './apiService.js';

// --- CONDUCTORES ---
export const getConductoresPESV = async () => {
    return apiFetch('/pesv/conductores');
};

export const guardarInfoConductor = async (datos) => {
    return apiFetch('/pesv/conductores', {
        method: 'POST',
        body: JSON.stringify(datos)
    });
};

// --- MANTENIMIENTOS ---
export const getMantenimientos = async (idActivo = null) => {
    const query = idActivo ? `?idActivo=${idActivo}` : '';
    return apiFetch(`/pesv/mantenimientos${query}`);
};

export const crearMantenimiento = async (datos) => {
    return apiFetch('/pesv/mantenimientos', {
        method: 'POST',
        body: JSON.stringify(datos)
    });
};


==================================================================
ARCHIVO: frontend\src\services\reportService.js
==================================================================
// frontend/src/services/reportService.js

import { apiFetch } from './apiService.js';

// --- Para el Administrador ---

export const getReportesMaquina = async () => {
    return apiFetch('/reportes/maquina'); 
};
export const getReportesSeguridad = async () => {
    return apiFetch('/reportes/seguridad'); 
};
export const getReporteMaquinaDetalle = async (idReporte) => {
    return apiFetch(`/reportes/maquina/${idReporte}`);
};
export const getReporteSeguridadDetalle = async (idReporte) => {
    return apiFetch(`/reportes/seguridad/${idReporte}`); 
};

// --- Para el Colaborador ---

/**
 * @service crearReporteMaquina
 * @desc Envía un nuevo reporte de estado de máquina (CU-07)
 * @param {FormData} formData - FormData con los datos y el archivo
 */
export const crearReporteMaquina = async (formData) => {
    // Usa fetch directo para FormData
    const token = localStorage.getItem('token');
    
    const response = await fetch('http://localhost:5000/api/reportes/maquina', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
        },
        body: formData,
    });

    const data = await response.json();
    if (!response.ok) {
        throw new Error(data.msg || 'Error al enviar el reporte');
    }
    return data;
};

/**
 * @service crearReporteSeguridad
 * @desc Envía un nuevo reporte de seguridad con foto opcional (CU-08)
 */
export const crearReporteSeguridad = async (formData) => {
    const token = localStorage.getItem('token');
    const response = await fetch('http://localhost:5000/api/reportes/seguridad', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData,
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.msg || 'Error al enviar el reporte');
    return data;
};

export const getMisReportesMaquina = async () => {
    return apiFetch('/reportes/maquina/mis-reportes');
};
export const getMisReportesSeguridad = async () => {
    return apiFetch('/reportes/seguridad/mis-reportes');
};


==================================================================
ARCHIVO: frontend\src\services\requestService.js
==================================================================
// frontend/src/services/requestService.js

import { apiFetch } from './apiService';

// URL Base (Ajusta si tu puerto cambia)
const API_URL = 'http://localhost:5000/api';

// Obtener lista de solicitudes (SST ve las suyas, Admin ve todas)
export const getSolicitudes = async () => {
    return apiFetch('/solicitudes');
};

// Responder una solicitud (Solo Admin)
export const responderSolicitud = async (idSolicitud, estado, comentario) => {
    return apiFetch('/solicitudes/responder', {
        method: 'PUT',
        body: JSON.stringify({ idSolicitud, estado, comentario })
    });
};

// Enviar nueva solicitud con archivo adjunto (SST)
export const crearSolicitud = async (formData) => {
    const token = localStorage.getItem('token');
    
    // Usamos fetch directo aquí porque FormData requiere headers especiales
    // que apiFetch podría sobreescribir con 'application/json'
    const response = await fetch(`${API_URL}/solicitudes`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`
            // NO agregamos 'Content-Type' para que el navegador ponga el 'multipart/form-data' con el boundary correcto
        },
        body: formData
    });

    const data = await response.json();

    if (!response.ok) {
        throw new Error(data.msg || 'Error al enviar la solicitud');
    }

    return data;
};


==================================================================
ARCHIVO: frontend\src\services\scheduleService.js
==================================================================
// frontend/src/services/scheduleService.js

import { apiFetch } from './apiService.js';

export const crearCronograma = async (datos) => {
    return apiFetch('/cronogramas', {
        method: 'POST',
        body: JSON.stringify(datos),
    });
};

export const getCronogramas = async () => {
    return apiFetch('/cronogramas');
};

export const eliminarCronograma = async (idCronograma) => {
    return apiFetch(`/cronogramas/${idCronograma}`, {
        method: 'DELETE'
    });
};

export const crearActividad = async (idCronograma, datos) => {
    return apiFetch(`/cronogramas/${idCronograma}/actividades`, {
        method: 'POST',
        body: JSON.stringify(datos),
    });
};

export const getActividadesPorCronograma = async (idCronograma) => {
    return apiFetch(`/cronogramas/${idCronograma}/actividades`);
};

export const editarActividad = async (idActividad, datos) => {
    return apiFetch(`/actividades/${idActividad}`, {
        method: 'PUT',
        body: JSON.stringify(datos),
    });
};

export const eliminarActividad = async (idActividad) => {
    return apiFetch(`/actividades/${idActividad}`, {
        method: 'DELETE',
    });
};

export const gestionarActividad = async (idActividad, formData) => {
    const token = localStorage.getItem('token');
    const response = await fetch(`http://localhost:5000/api/actividades/${idActividad}/estado`, {
        method: 'PATCH',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData,
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.msg || 'Error al gestionar actividad');
    return data;
};

/**
 * @service getActividadDetalle
 * @desc Obtiene el detalle de una sola actividad
 */
export const getActividadDetalle = async (idActividad) => {
    return apiFetch(`/actividades/${idActividad}`);
};

// --- AQUÍ ESTÁ LA FUNCIÓN EXPORTADA ---
export const getEvidenciasActividad = async (idActividad) => {
    return apiFetch(`/actividades/${idActividad}/evidencias`);
};


==================================================================
ARCHIVO: frontend\src\services\userService.js
==================================================================
// frontend/src/services/userService.js

import { apiFetch } from './apiService.js';

export const getColaboradores = async () => {
    return apiFetch('/usuarios');
};

export const getTodosUsuarios = async () => {
    return apiFetch('/usuarios/todos');
};

export const getUsuarioByCedula = async (cedula) => {
    return apiFetch(`/usuarios/cedula/${cedula}`);
};

// --- NUEVA FUNCIÓN: Obtener roles ---
export const getRoles = async () => {
    return apiFetch('/usuarios/roles');
};

export const crearColaborador = async (datosUsuario) => {
    return apiFetch('/usuarios', {
        method: 'POST',
        body: JSON.stringify(datosUsuario),
    });
};

export const editarColaborador = async (id, datosUsuario) => {
    const { nombreCompleto, area, cargo } = datosUsuario;
    return apiFetch(`/usuarios/${id}`, {
        method: 'PUT',
        body: JSON.stringify({ nombreCompleto, area, cargo }),
    });
};

export const cambiarEstadoColaborador = async (id, estado) => {
    return apiFetch(`/usuarios/${id}/estado`, {
        method: 'PATCH',
        body: JSON.stringify({ estado }),
    });
};

export const resetPasswordColaborador = async (id, password) => {
    return apiFetch(`/usuarios/${id}/reset-password`, {
        method: 'PATCH',
        body: JSON.stringify({ password }),
    });
};


==================================================================
ARCHIVO: frontend\src\style\ColaboradorLayout.css
==================================================================
/* frontend/src/style/ColaboradorLayout.css */

.colaborador-layout {
    display: flex;
    flex-direction: column;
    width: 100%;
    min-height: 100vh;
    background-color: #f4f7f6; /* Fondo gris claro */
}

/* El contenido de la página del colaborador (centrado y con ancho máx) */
.colaborador-page-content {
    width: 100%;
    max-width: 1200px; /* Ancho máximo del contenido */
    margin: 0 auto; /* Centrado */
    padding: 2rem;
    flex: 1;
}


==================================================================
ARCHIVO: frontend\src\style\DashboardAdmin.css
==================================================================
/* frontend/src/style/DashboardAdmin.css */

.dashboard-admin-header {
    margin-bottom: 2rem;
}
.dashboard-admin-header h1 {
    font-size: 2rem;
    font-weight: 600;
    color: #212529;
    margin: 0;
}
.dashboard-admin-header p {
    font-size: 1.1rem;
    color: #6c757d;
    margin: 0.25rem 0 0 0;
}

/* --- Contenedor de Widgets KPIs --- */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); 
    gap: 1.5rem;
    margin-bottom: 2.5rem;
}

/* --- TARJETA KPI (AHORA ES UN ENLACE) --- */
.kpi-card-link {
    text-decoration: none; /* Quita el subrayado del enlace */
}

.kpi-card {
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    padding: 1.5rem;
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
}
/* Efecto hover en la tarjeta */
.kpi-card-link:hover .kpi-card {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    border-color: #007BFF; /* Azul acento */
}

.kpi-card h3 {
    font-size: 1rem;
    font-weight: 600;
    color: #6c757d; 
    text-transform: uppercase;
    margin: 0 0 0.5rem 0;
}

.kpi-card .kpi-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #005A5B; 
}
/* Colores específicos para valores */
.kpi-card.kpi-inspecciones .kpi-value { color: #007BFF; }
.kpi-card.kpi-reportes-maq .kpi-value { color: #f57f17; }
.kpi-card.kpi-reportes-seg .kpi-value { color: #dc3545; }
.kpi-card.kpi-acpm .kpi-value { color: #005A5B; }


/* --- Cuadrícula de Listas (2 columnas) --- */
.dashboard-lists-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* 2 columnas */
    gap: 2rem;
}

.dashboard-list-card {
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid #dee2e6;
    padding: 1.5rem;
}

/* --- TÍTULO DE LA LISTA (AHORA ES UN ENLACE) --- */
.dashboard-list-card h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 0 1rem 0;
    border-bottom: 2px solid #f4f7f6;
    padding-bottom: 0.75rem;
}
.dashboard-list-card h2 a {
    text-decoration: none;
    color: #212529; /* Color de texto normal */
    transition: color 0.2s ease;
}
.dashboard-list-card h2 a:hover {
    color: #007BFF; /* Se pone azul al pasar el mouse */
}
/* --- FIN DEL CAMBIO DE ENLACE --- */


.dashboard-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0.25rem;
    border-bottom: 1px solid #f0f2f5;
    font-size: 0.95rem;
}
.dashboard-list-item:last-child {
    border-bottom: none;
}

.dashboard-list-item .item-info {
    font-weight: 500;
    color: #333;
}
.dashboard-list-item .item-date {
    font-weight: 600;
    color: #dc3545; /* Rojo para fechas límite */
    flex-shrink: 0;
    margin-left: 1rem;
}
.dashboard-list-item .item-type {
    font-size: 0.85rem;
    color: #6c757d;
}

/* Responsividad */
@media (max-width: 992px) {
    .kpi-grid {
        grid-template-columns: 1fr 1fr;
    }
    .dashboard-lists-grid {
        grid-template-columns: 1fr; 
    }
}
@media (max-width: 576px) {
    .kpi-grid {
        grid-template-columns: 1fr;
    }
}


==================================================================
ARCHIVO: frontend\src\style\DashboardColaborador.css
==================================================================
/* frontend/src/style/DashboardColaborador.css */

.dashboard-colaborador-header {
    margin-bottom: 2rem;
}
.dashboard-colaborador-header h1 {
    font-size: 2rem;
    font-weight: 600;
    color: #212529;
    margin: 0;
}

.report-cards-container {
    display: grid;
    /* Dos columnas de igual tamaño */
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 3rem;
}

.report-card {
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    padding: 2rem;
    text-decoration: none;
    color: #212529;
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}
.report-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    border-color: #005A5B; /* Verde corporativo */
}

.report-card h2 {
    font-size: 1.5rem;
    color: #005A5B; /* Verde corporativo */
    margin: 0 0 0.5rem 0;
}
.report-card p {
    font-size: 0.95rem;
    color: #6c757d;
    margin: 0;
}

/* Estilos para la tabla de historial */
.historial-section h2 {
    font-size: 1.5rem;
    font-weight: 600;
    color: #212529;
    margin-bottom: 1.5rem;
}


==================================================================
ARCHIVO: frontend\src\style\DocumentosPage.css
==================================================================
/* frontend/src/style/DocumentosPage.css */

.document-breadcrumb {
    font-size: 1rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    margin-bottom: 1.5rem;
}
.breadcrumb-link {
    color: var(--color-acento);
    text-decoration: none;
    cursor: pointer;
}
.breadcrumb-link:hover {
    text-decoration: underline;
}
.breadcrumb-current {
    color: var(--color-text);
    font-weight: 600;
}

/* Estilo para los ítems de la "tabla" */
.document-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
.document-list-header {
    display: flex;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    background-color: #f8f9fa;
    padding: 0.75rem 1.5rem;
    border-bottom: 2px solid var(--color-border);
}
.doc-name { flex: 3; }
.doc-type { flex: 1; }
.doc-size { flex: 1; text-align: right; }
.doc-actions { flex: 1; text-align: right; }

.document-item {
    display: flex;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--color-border);
    transition: background-color 0.2s ease;
}
.document-item:hover {
    background-color: #f8f9fa;
}

.document-item svg {
    font-size: 1.5rem;
    margin-right: 1rem;
    flex-shrink: 0;
}
.icon-folder { color: var(--color-acento); }
.icon-file { color: var(--color-secondary); }

.document-item .item-name {
    font-size: 1rem;
    font-weight: 500;
    color: var(--color-text);
}
.document-item .item-name-link {
    color: var(--color-acento);
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
}
.document-item .item-name-link:hover {
    text-decoration: underline;
}

.document-item .item-type {
    font-size: 0.9rem;
    color: var(--color-text-secondary);
}
.document-item .item-size {
    font-size: 0.9rem;
    color: var(--color-text-secondary);
    text-align: right;
}
.document-item .item-actions {
    text-align: right;
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
}


==================================================================
ARCHIVO: frontend\src\style\Header.css
==================================================================
/* frontend/src/style/Header.css */

.header-container {
    display: flex;
    justify-content: flex-end; /* Alinea todo a la derecha */
    align-items: center;
    padding: 1rem 2rem;
    height: 70px; /* Altura fija del header */
    background-color: #FFFFFF;
    border-bottom: 1px solid #dee2e6; /* Borde sutil */
}

.header-user-info {
    display: flex;
    align-items: center;
    color: #6c757d; /* Gris para "Bienvenido" */
}

.header-user-info .user-name {
    margin: 0 0.5rem 0 0.25rem;
    color: #212529; /* Texto oscuro */
    font-weight: 600;
}

.header-user-info .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #007BFF; /* Color acento */
    color: #FFFFFF;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    margin-left: 0.5rem;
}



.header-logout-button {
    background: transparent;
    border: 1px solid #dc3545; /* Rojo */
    color: #dc3545;
    padding: 0.4rem 0.8rem;
    margin-left: 1.5rem;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
}
.header-logout-button:hover {
    background-color: #dc3545;
    color: white;
}

.sidebar-logo-img3 {
    width: 160px; /* Ancho que especificaste */
    height: auto; 
    margin-top: -2rem;
    position: absolute;
    left: 2%;
    /* CORRECCIÓN: Espacio mínimo entre logo y texto */
    margin-bottom: -2.5rem; /* Pega el texto al logo */
}

.nombreEmpresa{
    position: absolute;
    left: 13%;
    /* color: #000; */
}


==================================================================
ARCHIVO: frontend\src\style\InspeccionesPage.css
==================================================================
/* frontend/src/style/InspeccionesPage.css (Completo) */

.inspection-library {
    margin-bottom: 2rem;
}

.inspection-library h2 {
    margin-top: 0;
}

.form-buttons-container {
    display: flex;
    flex-wrap: wrap; 
    gap: 1rem; 
}

/* --- Estilos para Modal Ver Detalle --- */
.modal-lg {
    max-width: 800px; 
}

.inspection-details .detail-section {
    margin-bottom: 1rem;
    font-size: 1rem;
    color: #333;
}
.inspection-details .detail-section strong {
    color: var(--color-primario); 
    display: block;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
    text-decoration: none; /* Quita subrayado */
}

.detail-box {
    background-color: #f8f9fa;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    padding: 0.75rem;
    font-size: 0.95rem;
    margin-top: 0.25rem;
    white-space: pre-wrap;
}

/* ... (json-viewer styles sin cambios) ... */

/* --- Estilos para Secciones de Checklist --- */
.form-section-header {
    background-color: #f4f7f6;
    padding: 0.75rem 1rem;
    margin: 1.5rem 0 0.5rem 0;
    border-radius: 6px;
    border: 1px solid var(--color-border);
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--color-primario);
}

/* --- Estilos de Checklist (NUEVA ESTRUCTURA) --- */
.form-checklist-container {
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    padding: 1rem;
}

.checklist-item-wrapper {
    padding: 1rem 0.5rem;
    border-bottom: 1px solid #f0f2f5;
}
.checklist-item-wrapper:last-of-type {
    border-bottom: none;
}

.checklist-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.checklist-item .item-label {
    font-size: 0.95rem;
    color: var(--color-text);
    margin-right: 1rem;
    flex: 1; 
}

.checklist-options {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

/* (Estilos de botones de radio B/R/M/C/NC - sin cambios) */
.radio-label input[type="radio"],
.radio-label-cn input[type="radio"] {
    display: none; 
}
.radio-label span, 
.radio-label-cn span {
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.9rem;
    width: 40px;
    height: 30px;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    background-color: #fff;
    color: var(--color-text);
}
.radio-label-cn span { width: 45px; }

/* (Colores de selección - sin cambios) */
.radio-label input[value="B"]:checked + span,
.radio-label-cn input[value="C"]:checked + span {
    background-color: var(--color-success); color: white; border-color: var(--color-success);
}
.radio-label input[value="R"]:checked + span { 
    background-color: var(--color-warning); color: var(--color-text); border-color: var(--color-warning); 
}
.radio-label input[value="M"]:checked + span,
.radio-label-cn input[value="NC"]:checked + span { 
    background-color: var(--color-danger); color: white; border-color: var(--color-danger); 
}
.radio-label input[value="NA"]:checked + span { 
    background-color: var(--color-secondary); color: white; border-color: var(--color-secondary); 
}

/* --- NUEVO: Estilo para la observación por ítem --- */
.checklist-item-observacion {
    margin-top: 0.75rem;
    display: flex;
    gap: 0.5rem;
    align-items: center;
}
.checklist-item-observacion label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    flex-shrink: 0;
}
.checklist-item-observacion input {
    flex: 1;
    width: 100%;
    padding: 0.5rem; /* Más pequeño */
    font-size: 0.9rem;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    box-sizing: border-box;
}


==================================================================
ARCHIVO: frontend\src\style\LoginPage.css
==================================================================
/* frontend/src/style/LoginPage.css */

:root {
    /* Colores originales de tu diseño */
    --color-primario: #005A5B; 
    --color-acento: #007BFF;
    --color-acento-hover: #0056b3;
    --color-texto-claro: #FFFFFF;
    --color-fondo-tarjeta: #FFFFFF;
    --color-texto-oscuro: #212529; 
    --color-texto-secundario: #6c757d; 
    --color-borde: #dee2e6;
    --color-error: #D32F2F;

    /* Colores solo para los iconos de selección */
    --icon-sst: #005A5B; 
    --icon-calidad: #20c997;
    --icon-collab: #007BFF;
}

/* =========================================
   VISTA DE SELECCIÓN DE ROL (NUEVA)
   ========================================= */
.login-container-selection {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    width: 100%;
    background-color: #f4f7f6;
    padding: 2rem;
}

.login-header-center {
    text-align: center;
    margin-bottom: 3rem;
}

/* Logo en la pantalla de selección */
/* Logo en la pantalla de selección */
.login-logo-selection {
    width: 280px;       /* Aumentado de 180px a 280px (Más grande) */
    height: auto;
    margin-bottom: 0rem;
    margin-top: -5rem;   /* Agregado para bajarlo un poco */
}
.login-header-center h1 { font-size: 2.5rem; color: var(--color-primario); margin: 0; }
.login-header-center p { font-size: 1.2rem; color: #666; margin: 0.5rem 0 2rem 0; }
.login-header-center h3 { font-weight: 400; color: #444; }

.role-cards-container {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 1000px;
}

.role-card {
    background: white;
    width: 240px;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid transparent;
}

.role-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.1);
    border-color: #ddd;
}

.role-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}
.sst-color { color: var(--icon-sst); }
.calidad-color { color: var(--icon-calidad); }
.collab-color { color: var(--icon-collab); }

.role-card h3 { margin: 0 0 0.5rem 0; color: #333; }
.role-card p { margin: 0; color: #777; font-size: 0.9rem; }

.login-footer-info {
    margin-top: 4rem;
    color: #999;
}

/* =========================================
   VISTA DE FORMULARIO (LOGIN ORIGINAL RESTAURADO)
   ========================================= */
.login-container {
    display: flex;
    width: 900px;
    min-height: 550px;
    background-color: var(--color-fondo-tarjeta);
    box-shadow: var(--shadow-md);
    border-radius: 10px;
    overflow: hidden;
    position: relative; /* Para el botón volver */
}

/* Botón Volver */
.btn-back {
    position: absolute;
    top: 20px;
    left: 20px;
    background: transparent;
    border: none;
    color: #666;
    font-size: 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    transition: color 0.2s;
    z-index: 10;
}
.btn-back:hover { color: #000; }

/* Columna Izquierda (Visual) */
.login-visual-column {
    flex: 1;
    background-color: var(--color-primario); /* SIEMPRE VERDE CORPORATIVO */
    color: var(--color-texto-claro);
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: left;
    padding: 3rem;
}

.visual-content { max-width: 300px; }
.visual-content h1 {
    font-size: 2.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
    border-bottom: 3px solid var(--color-acento);
    padding-bottom: 0.5rem;
    display: inline-block;
}
.visual-content p {
    font-size: 1.1rem;
    opacity: 0.9;
    line-height: 1.6;
}

/* Columna Derecha (Formulario) */
.login-form-column {
    flex: 1;
    background-color: var(--color-fondo-tarjeta);
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 3rem;
}

.login-form-wrapper {
    width: 100%;
    max-width: 350px;
}

/* Logo dentro del formulario */
.login-form-logo {
    width: 150px; /* Aumentado de 150px a 200px */
    height: auto;
    display: block;
    margin: 0 auto; 
    margin-top: -3rem;
    margin-bottom: 0rem;
}

.login-logo-placeholder {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-primario);
    text-align: center;
    margin-bottom: 1rem;
}

.login-form-wrapper h2 {
    font-size: 1.8rem;
    font-weight: 600;
    color: var(--color-texto-oscuro);
    margin-bottom: 2rem;
    text-align: center;
}

/* Inputs */
.input-group {
    margin-bottom: 1.5rem;
}
.input-group label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--color-texto-secundario);
    margin-bottom: 0.5rem;
}

.input-with-icon {
    display: flex;
    align-items: center;
    border: 1px solid var(--color-borde);
    border-radius: var(--border-radius);
    padding: 0 0.75rem;
    transition: border-color 0.3s ease;
}
.input-with-icon:focus-within {
    border-color: var(--color-acento);
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.input-icon {
    margin-right: 0.75rem;
    color: var(--color-texto-secundario);
    font-size: 1rem;
    flex-shrink: 0;
}

.input-with-icon input {
    width: 100%;
    border: none;
    outline: none;
    padding: 0.9rem 0;
    font-size: 1rem;
    background-color: transparent;
    color: var(--color-texto-oscuro);
}

.login-error-message {
    color: var(--color-error);
    font-size: 0.9rem;
    text-align: center;
    margin-bottom: 1rem;
}

.login-button {
    width: 100%;
}

@media (max-width: 900px) {
    .login-container {
        flex-direction: column;
        width: 100vw;
        min-height: 100vh;
        height: auto;
        border-radius: 0;
        box-shadow: none;
    }
    .login-visual-column {
        min-height: 250px;
        flex-basis: 250px; 
    }
    .login-form-column {
        flex: 1;
        padding: 2rem;
        align-items: flex-start;
    }
}


==================================================================
ARCHIVO: frontend\src\style\LogsPage.css
==================================================================
/* frontend/src/style/LogsPage.css */

/* Tarjeta contenedora de los filtros */
.logs-filter-card {
    margin-bottom: 2rem;
    padding: 1.5rem 2rem;
}

/* La barra de filtros (usa flexbox para responsiveness) */
.logs-filter-bar {
    display: flex;
    flex-wrap: wrap; /* Permite que los filtros se apilen en móvil */
    gap: 1.5rem; /* Espacio entre los filtros */
    align-items: flex-start; /* Alinea los items al inicio */
}

/* Cada item del filtro (cada <select> o <input>) */
.filter-item {
    flex: 1; /* Ocupa el espacio disponible */
    min-width: 180px; /* Ancho mínimo antes de apilarse */
    display: flex;
    flex-direction: column;
}

/* Hereda el estilo global de .form-group label */
.filter-item label {
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-text-secondary);
}

/* Hereda el estilo global de inputs/selects */
.filter-item select,
.filter-item input[type="date"] {
    width: 100%;
}

/* Contenedor de botones */
.filter-buttons {
    display: flex;
    gap: 0.5rem;
    align-self: flex-end; /* Alinea los botones abajo (al final de la label) */
    flex-shrink: 0; /* Evita que los botones se encojan */
}

/* En pantallas más pequeñas, los botones ocupan todo el ancho */
@media (max-width: 768px) {
    .filter-buttons {
        width: 100%;
        /* Opcional: estira los botones */
        display: grid;
        grid-template-columns: 1fr 1fr;
    }
    
    .filter-item {
        min-width: 100%; /* Ocupa todo el ancho en móvil */
    }
}


==================================================================
ARCHIVO: frontend\src\style\MainLayout.css
==================================================================
/* frontend/src/style/MainLayout.css */

.app-layout {
    display: flex;
    background-color: var(--color-bg); 
}

/* --- Wrapper para el contenido (Header + Página) --- */
.main-content-wrapper {
    flex: 1; 
    margin-left: 260px; 
    display: flex;
    flex-direction: column;
    height: 100vh;
    transition: margin-left 0.3s ease; 
    
    /* --- CORRECCIÓN CLAVE 1 --- */
    /* Evita que este contenedor se estire si el contenido es muy ancho */
    overflow-x: hidden; 
    width: 100%; /* Asegura que no intente ser más grande que su padre */
}

/* --- Contenido de la Página --- */
.page-content {
    flex: 1; 
    padding: 2rem;
    overflow-y: auto; /* Scroll vertical */
    
    /* --- CORRECCIÓN CLAVE 2 --- */
    /* Doble seguridad: el área de contenido tampoco puede desbordarse */
    overflow-x: hidden; 
}

/* --- Overlay para móvil --- */
.sidebar-overlay {
    display: none; /* Oculto en desktop */
}


/* --- RESPONSIVIDAD (Tablet y Móvil) --- */
@media (max-width: 992px) {
    .main-content-wrapper {
        margin-left: 0; /* El contenido ocupa el 100% */
        width: 100vw; /* Ocupa toda la pantalla */
    }

    /* El overlay se activa en móvil cuando el sidebar está abierto */
    .sidebar-overlay {
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1999; /* Detrás del sidebar, delante del contenido */
    }
}

@media (max-width: 768px) {
    .page-content {
        padding: 1rem; /* Menos padding en móvil */
    }
}


==================================================================
ARCHIVO: frontend\src\style\Modal.css
==================================================================
/* frontend/src/style/Modal.css */

/* --- El fondo oscuro (Overlay) --- */
.modal-overlay {
    position: fixed; /* Cubre toda la pantalla */
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.6); /* Negro semitransparente */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000; /* Asegura que esté por encima de todo */
}

/* --- La caja blanca (Modal) --- */
.modal-content {
    background-color: white;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    width: 100%;
    max-width: 500px; /* Ancho estándar para un formulario */
    z-index: 1001;
    
    /* Animación de entrada */
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* --- Encabezado del Modal --- */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 1rem;
    margin-bottom: 1.5rem;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    color: #212529;
}

.modal-close-button {
    background: transparent;
    border: none;
    font-size: 1.5rem;
    font-weight: bold;
    color: #888;
    cursor: pointer;
    padding: 0.5rem;
}
.modal-close-button:hover {
    color: #000;
}

/* --- Cuerpo y Formulario del Modal --- */
.modal-body {
    /* (Estilos de formulario) */
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    font-size: 0.9rem;
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 0.5rem;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 0.8rem;
    font-size: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    box-sizing: border-box; 
    font-family: inherit;
}

.form-group textarea {
    resize: vertical;
}

.modal-error {
    color: #D32F2F;
    font-size: 0.9rem;
    margin-top: 1rem;
    text-align: center;
}

/* --- Pie del Modal (Botones) --- */
.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem; /* Espacio entre botones */
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #dee2e6;
}

/* --- Estilos para Lista de Evidencias (NUEVO) --- */
.evidence-list {
    list-style: none;
    padding-left: 0;
    margin-top: 1rem;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
}

.evidence-item {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #dee2e6;
}
.evidence-item:last-child {
    border-bottom: none;
}

.evidence-item span {
    margin-right: 0.5rem;
    font-size: 1.5rem;
}

.evidence-info {
    font-size: 0.9rem;
}

.evidence-info a {
    font-weight: 600;
    color: #007BFF;
    text-decoration: none;
}
.evidence-info a:hover {
    text-decoration: underline;
}

.evidence-info small {
    display: block;
    color: #6c757d;
}


==================================================================
ARCHIVO: frontend\src\style\PlanificacionPage.css
==================================================================
/* frontend/src/style/PlanificacionPage.css */

.header-actions {
    display: flex;
    gap: 1rem;
}

/* Estilo para el filtro (selector de cronograma) */
.cronograma-selector {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    background-color: var(--color-card); /* Usa variable global */
    padding: 1rem;
    border-radius: var(--border-radius); /* Usa variable global */
    box-shadow: var(--shadow-sm); /* Usa variable global */
}

.cronograma-selector label {
    font-weight: 600;
    color: var(--color-text); /* Usa variable global */
}

.cronograma-selector select {
    font-size: 1rem;
    padding: 0.5rem 0.8rem;
    border-radius: var(--border-radius); /* Usa variable global */
    border: 1px solid var(--color-border); /* Usa variable global */
    min-width: 300px;
}

.cronograma-descripcion {
    font-size: 0.95rem;
    color: var(--color-text-secondary); /* Usa variable global */
    margin: -1rem 0 1.5rem 0.5rem;
    padding: 0.5rem 1rem;
    background-color: #f8f9fa; /* Gris muy claro */
    border-radius: var(--border-radius); /* Usa variable global */
    border: 1px solid var(--color-border); /* Usa variable global */
}

/* --- Tarjeta del Calendario --- */
.calendar-card {
    margin-top: 2rem;
    padding: 1.5rem;
}

/* --- Estilos para React Big Calendar --- */
.rbc-calendar {
    height: 600px !important;
}
.rbc-event {
    background-color: var(--color-primario); /* Usa variable global */
    border: 1px solid var(--color-primario-hover); /* Usa variable global */
}
.rbc-event:focus, .rbc-event.rbc-selected {
    background-color: var(--color-acento); /* Usa variable global */
}
.rbc-header {
    background-color: #f8f9fa;
    color: var(--color-text-secondary); /* Usa variable global */
    font-weight: 600;
    border-bottom: 2px solid var(--color-border); /* Usa variable global */
    padding: 0.75rem 0;
}
.rbc-today {
    background-color: #e6f7ec; /* Verde claro (global) */
}


==================================================================
ARCHIVO: frontend\src\style\ReportarPage.css
==================================================================
/* frontend/src/style/ReportarPage.css */

/* Estilos para los botones de radio grandes (OK / Problema) */
.report-radio-group {
    display: flex;
    gap: 1rem;
}

.report-radio-group .radio-label-report {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.report-radio-group .radio-label-report span {
    font-size: 1.1rem;
    font-weight: 600;
}

.report-radio-group .radio-label-report input[type="radio"] {
    display: none; /* Oculta el radio button */
}

/* Color para OK */
.report-radio-group .status-ok:hover {
    background-color: #e6f7ec;
}
.report-radio-group input[value="OK"]:checked + span {
    color: #005A5B;
}
.report-radio-group input[value="OK"]:checked + label {
    border-color: #005A5B;
    background-color: #e6f7ec;
    box-shadow: 0 0 0 3px rgba(0, 90, 91, 0.1);
}

/* Color para Problema */
.report-radio-group .status-problema:hover {
    background-color: #fbebee;
}
.report-radio-group input[value="Con Problema"]:checked + span {
    color: #dc3545;
}
.report-radio-group input[value="Con Problema"]:checked + label {
    border-color: #dc3545;
    background-color: #fbebee;
    box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
}

/* Pie del formulario */
.form-footer {
    display: flex;
    justify-content: flex-end;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #dee2e6;
}

/* Mensaje de éxito */
.success-message {
    color: #005A5B;
    font-weight: 600;
    text-align: center;
    background-color: #e6f7ec;
    padding: 1rem;
    border-radius: 8px;
}


==================================================================
ARCHIVO: frontend\src\style\Sidebar.css
==================================================================
/* frontend/src/style/Sidebar.css (Responsive y con Logo) */

:root {
    --sidebar-width: 260px;
}

.sidebar-container {
    display: flex;
    flex-direction: column;
    width: var(--sidebar-width);
    height: 100vh;
    background-color: var(--color-primario);
    color: var(--color-texto-claro);
    position: fixed; 
    left: 0;
    top: 0;
    z-index: 1000;
    box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    transition: left 0.3s ease; 
}

/* --- 1. SECCIÓN DEL LOGO (INTACTA) --- */
.sidebar-logo {
    display: flex;
    flex-direction: column; 
    align-items: center;  
    justify-content: center; /* Centra el contenido */ 
    border-bottom: 1px solid var(--color-primario-hover);
    position: relative; 
}

/* CORRECCIÓN: Clase para la imagen (Mantenemos tus ajustes exactos) */
.sidebar-logo-img {
    width: 150px; /* Ancho que especificaste */
    height: auto; 
    margin-top: -2rem;
    /* CORRECCIÓN: Espacio mínimo entre logo y texto */
    margin-bottom: -2.5rem; /* Pega el texto al logo */
}

.sidebar-logo h3 {
    margin: 0; /* Sin margen */
    font-size: 1.25rem; 
    font-weight: 600;
    text-align: center;
}

/* Botón de cerrar (solo para móvil) */
.sidebar-close-btn {
    display: none; 
    background: transparent;
    border: none;
    color: white;
    font-size: 2rem;
    cursor: pointer;
    position: absolute;
    top: 10px;
    right: 15px;
}
/* --- FIN DE LA CORRECCIÓN --- */


/* --- Navegación --- */
.sidebar-nav {
    flex-grow: 1;
    overflow-y: auto;
    padding-top: 1rem;
}

/* --- NUEVO: Estilo para los títulos de sección (Super Admin / Calidad) --- */
.sidebar-section-label {
    padding: 1.5rem 1.5rem 0.5rem 1.5rem;
    font-size: 0.7rem;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.4); /* Blanco semitransparente */
    text-transform: uppercase;
    letter-spacing: 1px;
}

.sidebar-link {
    display: flex;
    align-items: center;
    gap: 0.75rem; 
    padding: 1rem 1.5rem;
    color: var(--color-texto-claro);
    text-decoration: none;
    font-size: 1rem;
    font-weight: 500;
    transition: background-color 0.2s ease;
    border-left: 4px solid transparent; 
}

.sidebar-link svg {
    font-size: 1.1rem;
    flex-shrink: 0;
    opacity: 0.8;
}

.sidebar-link:hover {
    background-color: var(--color-primario-hover);
}

.sidebar-link.active {
    background-color: var(--color-fondo-oscuro, #003838);
    border-left-color: var(--color-acento); 
    font-weight: 600;
}
.sidebar-link.active svg {
    opacity: 1;
}

/* --- Footer --- */
.sidebar-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--color-primario-hover);
}

/* frontend/src/style/Sidebar.css */


.sidebar-nav {
    flex: 1;
    overflow-y: auto; /* Permite hacer scroll si no cabe */
    padding: 1rem 0;
    
    /* --- ESTO OCULTA LA BARRA VISUALMENTE --- */
    
    /* Para Firefox */
    scrollbar-width: none; 
    
    /* Para Internet Explorer y Edge antiguo */
    -ms-overflow-style: none;  
}

/* Para Chrome, Safari y Edge moderno */
.sidebar-nav::-webkit-scrollbar {
    display: none;
}


/* --- RESPONSIVIDAD (Tablet y Móvil) --- */
@media (max-width: 992px) {
    .sidebar-container {
        left: calc(var(--sidebar-width) * -1); 
        z-index: 2000; 
    }
    
    .sidebar-container.open {
        left: 0; 
    }

    .sidebar-close-btn {
        display: block; 
    }
}


==================================================================
ARCHIVO: frontend\src\style\Solicitudes.css
==================================================================
/* frontend/src/style/Solicitudes.css */

.solicitudes-container {
    padding: 1rem;
    background-color: #f4f6f9;
    min-height: 100vh;
}

/* --- FORMULARIO DE CREACIÓN --- */
.solicitud-form-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    padding: 2rem;
    margin-bottom: 2rem;
    border-left: 6px solid #005A5B; /* Acento corporativo */
}

.solicitud-header-title {
    color: #005A5B;
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

/* --- TABLA DE SOLICITUDES --- */
.solicitudes-list-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    padding: 1.5rem;
    overflow: hidden;
}

.solicitud-table {
    width: 100%;
    border-collapse: collapse;
}

.solicitud-table thead th {
    background-color: #f8f9fa;
    color: #495057;
    font-weight: 700;
    padding: 1rem;
    text-align: left;
    border-bottom: 2px solid #dee2e6;
}

.solicitud-table tbody tr {
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
}

.solicitud-table tbody tr:hover {
    background-color: #f1fcfc;
}

.solicitud-table td {
    padding: 1rem;
    vertical-align: middle;
}

/* --- ESTILOS DE ESTADO (BADGES) --- */
.badge-estado {
    padding: 0.35em 0.65em;
    border-radius: 50rem;
    font-size: 0.85em;
    font-weight: 700;
    text-transform: uppercase;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.badge-pendiente {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
}

.badge-aprobado {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.badge-rechazado {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

/* --- BOTONES DE DOCUMENTOS --- */
.btn-doc-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.btn-doc {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.2s;
}

.btn-doc-original {
    background-color: #e2e6ea;
    color: #343a40;
    border: 1px solid #d6d8db;
}

.btn-doc-original:hover {
    background-color: #dbe0e5;
    color: #000;
}

.btn-doc-firmado {
    background-color: #28a745;
    color: white;
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

.btn-doc-firmado:hover {
    background-color: #218838;
    transform: translateY(-1px);
}

/* --- ACCIONES --- */
.actions-cell {
    display: flex;
    gap: 8px;
}


==================================================================
ARCHIVO: frontend\src\style\UsuariosPage.css
==================================================================
/* frontend/src/style/UsuariosPage.css */

/* --- Estilos Generales de Página (reutilizables) --- */   
.page-container {
    width: 100%;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.page-header h1 {
    font-size: 2rem;
    font-weight: 600;
    color: #212529;
    margin: 0;
}

.page-content-card {
    background-color: #FFFFFF;
    border-radius: 10px;
    padding: 2rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.error-message {
    color: #D32F2F;
}

/* --- Botones --- */
.btn {
    padding: 0.75rem 1.25rem;
    border: none;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-primary {
    background-color: #007BFF; /* Azul Acento */
    color: white;
}
.btn-primary:hover {
    background-color: #0056b3;
}

.btn-secondary {
    background-color: #6c757d; /* Gris */
    color: white;
    margin-right: 0.5rem;
}
.btn-secondary:hover {
    background-color: #5a6268;
}

.btn-danger {
    background-color: #dc3545; /* Rojo */
    color: white;
}
.btn-danger:hover {
    background-color: #c82333;
}

/* --- Estilos de la Tabla --- */
.data-table {
    width: 100%;
    border-collapse: collapse; /* Bordes limpios */
}

.data-table th, .data-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.data-table th {
    font-size: 0.85rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    background-color: #f8f9fa;
}

.data-table td {
    font-size: 0.95rem;
    color: #212529;
}

/* Píldora de Estado */
.status-pill {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

.status-activo {
    background-color: #e6f7ec; /* Verde claro */
    color: #005A5B; /* Verde oscuro */
}

.status-inactivo {
    background-color: #fbebee; /* Rojo claro */
    color: #dc3545; /* Rojo */
}

.action-buttons {
    white-space: nowrap; /* Evita que los botones se partan */
}


/* Nuevo estado para 'En Proceso' (Azul) */
.status-proceso {
    background-color: #e7f3ff; /* Azul claro */
    color: #007BFF; /* Azul */
}


==================================================================
ARCHIVO: frontend\vite.config.js
==================================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})


