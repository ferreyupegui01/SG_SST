CONTEXTO DEL PROYECTO (FECHA: 2025-12-15T11:52:02.149Z):


==================================================================
ARCHIVO: api_bd_gosen\package.json
==================================================================
{
  "name": "api_bd_gosen",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "dev": "nodemon server.js",
    "start": "node server.js"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^5.1.0",
    "mssql": "^12.1.1"
  },
  "devDependencies": {
    "nodemon": "^3.1.11"
  }
}



==================================================================
ARCHIVO: api_bd_gosen\server.js
==================================================================
import express from 'express';
import cors from 'cors';
import mssql from 'mssql';
import 'dotenv/config';

const app = express();
const PORT = 4000;

app.use(cors());
app.use(express.json());

// 1. Credenciales
const dbConfig = {
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    server: process.env.DB_SERVER,
    database: process.env.DB_DATABASE,
    options: {
        encrypt: false, 
        trustServerCertificate: true
    }
};

// 2. Endpoint de B√∫squeda General (ACTUALIZADO)
app.get('/api/gosen/empleados', async (req, res) => {
    const q = req.query.q || '';

    try {
        const pool = await mssql.connect(dbConfig);

        // CONSULTA SQL
        // Traemos todas las fechas posibles para decidir en el backend cu√°l mostrar
        const query = `
            SELECT TOP 50
                r.cod_recurso AS Cedula,
                r.nombres + ' ' + r.apellidos AS NombreCompleto,
                o.des_oficio AS CargoNombre,
                r.mail AS Email,
                
                -- Centro de Costos
                ISNULL(cc.des_centro_costo, 'Sin Centro Asignado') AS CentroCosto,
                
                -- Fechas y Estado
                c.fecha_inicio AS FechaInicio,
                c.fecha_fin AS FechaFin,
                c.fecha_terminacion AS FechaTerminacion,
                c.estado AS EstadoContrato

            FROM [dbo].[rh_recursos] r
            INNER JOIN [dbo].[rh_co_contratos] c ON r.id_recurso = c.id_recurso
            LEFT JOIN [dbo].[rh_oficios] o ON c.id_oficio = o.id_oficio
            LEFT JOIN [dbo].[rh_co_centros_costos] cc ON c.id_centro_costo = cc.id_centro_costo
            
            WHERE 
                (
                    r.cod_recurso LIKE @search OR 
                    r.nombres LIKE @search OR 
                    r.apellidos LIKE @search
                )
            
            -- Ordenar: Activos (1) primero
            ORDER BY c.estado DESC, r.nombres ASC
        `;

        const result = await pool.request()
            .input('search', mssql.NVarChar, `%${q}%`)
            .query(query);

        res.json(result.recordset);

    } catch (err) {
        console.error('‚ùå Error en API GOSEN:', err.message);
        res.status(500).json({ error: 'Error conectando a N√≥mina' });
    } finally {
        await mssql.close();
    }
});

// 3. Endpoint Conductores (PESV)
app.get('/api/gosen/conductores-activos', async (req, res) => {
    try {
        const pool = await mssql.connect(dbConfig);
        const query = `
            SELECT 
                r.cod_recurso AS Cedula,
                r.nombres + ' ' + r.apellidos AS NombreCompleto,
                o.des_oficio AS CargoNombre,
                r.mail AS Email
            FROM [dbo].[rh_recursos] r
            INNER JOIN [dbo].[rh_co_contratos] c ON r.id_recurso = c.id_recurso
            LEFT JOIN [dbo].[rh_oficios] o ON c.id_oficio = o.id_oficio
            WHERE 
                c.estado = 1 
                AND (
                    o.des_oficio LIKE '%CONDUCTOR%' OR
                    o.des_oficio LIKE '%MONTACARGUISTA%' OR
                    o.des_oficio LIKE '%MOTOCARGUISTA%' OR
                    o.des_oficio LIKE '%CHOFER%' OR 
                    o.des_oficio LIKE '%TRANSPORTADOR%'
                )
            ORDER BY r.nombres ASC
        `;
        const result = await pool.request().query(query);
        res.json(result.recordset);
    } catch (err) {
        console.error('‚ùå Error conductores GOSEN:', err.message);
        res.status(500).json({ error: 'Error consultando conductores' });
    } finally {
        await mssql.close();
    }
});

app.listen(PORT, () => {
    console.log(`üöÄ API Gosen corriendo en http://localhost:${PORT}`);
});


==================================================================
ARCHIVO: backend\config\dbConfig.js
==================================================================
// backend/dbConfig.js

import mssql from 'mssql';
// Asegura que dotenv se cargue
import 'dotenv/config';

// Configuraci√≥n de la conexi√≥n le√≠da desde .env
const config = {
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    server: process.env.DB_SERVER,
    database: process.env.DB_DATABASE,
    options: {
        encrypt: true, // Para Azure SQL
        trustServerCertificate: true // Cambia a false si usas un certificado SSL/TLS de confianza
    }
};

// --- Exportaci√≥n Nombrada (ESM) ---
// Creamos y exportamos la promesa del pool directamente
export const poolPromise = new mssql.ConnectionPool(config)
    .connect()
    .then(pool => {
        console.log('Conectado a SQL Server (mssql)');
        return pool;
    })
    .catch(err => {
        console.error('Error de conexi√≥n a la base de datos:', err);
        process.exit(1); // Termina la aplicaci√≥n si no se puede conectar a la DB
    });

// Exportamos mssql para poder usar tipos (ej. mssql.NVarChar) en los controladores
export { mssql };


==================================================================
ARCHIVO: backend\config\mailer.js
==================================================================
// backend/config/mailer.js
import nodemailer from 'nodemailer';
import 'dotenv/config';

// Configuraci√≥n para GMAIL
export const transporter = nodemailer.createTransport({
    host: "smtp.gmail.com",
    port: 465, // Puerto seguro SSL
    secure: true, // true para 465, false para otros puertos
    auth: {
        user: process.env.MAIL_USER, // Tu correo gmail
        pass: process.env.MAIL_PASS, // La contrase√±a de aplicaci√≥n de 16 d√≠gitos
    },
});

export const verificarConexionCorreo = async () => {
    try {
        await transporter.verify();
        console.log('‚úÖ Servidor de correos (Gmail) listo para enviar mensajes');
    } catch (error) {
        console.error('‚ùå Error conectando servidor de correos:', error.message);
    }
};


==================================================================
ARCHIVO: backend\controllers\acpmController.js
==================================================================
// backend/src/controllers/acpmController.js

import { validationResult } from 'express-validator';
import { poolPromise, mssql } from '../config/dbConfig.js';
import path from 'path';
import { fileURLToPath } from 'url';
import fs from 'fs/promises'; 
import { logAction } from '../services/logService.js'; 
import { crearNotificacion } from '../services/notificationService.js'; // <--- IMPORTAR

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * @controller  crearACPM
 * @desc        (CU-03) Crea una nueva ACPM y NOTIFICA al responsable
 */
const crearACPM = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    const {
        tipoAccion, origen, descripcionProblema, planAccion,
        idUsuarioResponsable, fechaLimite, idInspeccionOrigen,
        idReporteMaquinaOrigen, idReporteSeguridadOrigen, 
        analisisCausa
    } = req.body;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('tipoAccion', mssql.NVarChar, tipoAccion)
            .input('origen', mssql.NVarChar, origen)
            .input('descripcionProblema', mssql.NVarChar, descripcionProblema)
            .input('planAccion', mssql.NVarChar, planAccion)
            .input('idUsuarioResponsable', mssql.Int, idUsuarioResponsable)
            .input('fechaLimite', mssql.Date, fechaLimite)
            .input('idInspeccionOrigen', mssql.Int, idInspeccionOrigen || null)
            .input('idReporteMaquinaOrigen', mssql.Int, idReporteMaquinaOrigen || null)
            .input('idReporteSeguridadOrigen', mssql.Int, idReporteSeguridadOrigen || null)
            .input('analisisCausa', mssql.NVarChar, analisisCausa || null)
            .query('EXEC SP_CREATE_AccionACPM @tipoAccion, @origen, @descripcionProblema, @planAccion, @idUsuarioResponsable, @fechaLimite, @idInspeccionOrigen, @idReporteMaquinaOrigen, @idReporteSeguridadOrigen, @analisisCausa');
        
        const nuevaAcpmId = result.recordset[0].ID_ACPM;

        // --- LOG ---
        await logAction(
            req.usuario.id, 
            req.usuario.nombre, 
            'CREAR_ACPM', 
            `Cre√≥ la ACPM (ID: ${nuevaAcpmId}) con origen: '${origen}'`
        );

        // --- NOTIFICACI√ìN AL RESPONSABLE ---
        await crearNotificacion({
            idUsuarioDestino: idUsuarioResponsable,
            titulo: 'üìã Nueva Acci√≥n Asignada',
            mensaje: `Se te ha asignado una acci√≥n ${tipoAccion} (Origen: ${origen}). Fecha l√≠mite: ${fechaLimite}.`,
            ruta: '/acpm'
        });
        // -----------------------------------

        res.status(201).json({
            msg: 'Acci√≥n ACPM creada exitosamente',
            idACPM: nuevaAcpmId
        });
    } catch (err) {
        if (err.message.includes('La fecha l√≠mite')) {
            return res.status(400).json({ msg: 'La fecha l√≠mite no puede ser anterior a la fecha actual' });
        }
        console.error('Error en crearACPM:', err.message);
        res.status(500).json({ msg: 'Error del servidor al crear ACPM' }); 
    }
};

/**
 * @controller  getACPMs
 */
const getACPMs = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_AccionesACPM');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getACPMs:', err.message);
        res.status(500).json({ msg: 'Error del servidor al obtener ACPMs' }); 
    }
};

/**
 * @controller  getACPMDetalle
 */
const getACPMDetalle = async (req, res) => {
    const { id: idACPM } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idACPM', mssql.Int, idACPM)
            .query('EXEC SP_GET_ACPMDetalle @idACPM');
        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Acci√≥n ACPM no encontrada' });
        }
        res.json(result.recordset[0]);
    } catch (err) {
        console.error('Error en getACPMDetalle:', err.message);
        res.status(500).json({ msg: 'Error del servidor al obtener detalle' }); 
    }
};

/**
 * @controller  gestionarACPM
 */
const gestionarACPM = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    const { id: idACPM } = req.params; 
    const { estadoACPM, comentariosSeguimiento } = req.body; 
    const idUsuario = req.usuario.id; 
    const nombreUsuario = req.usuario.nombre; 
    const archivoEvidencia = req.file; 
    
    if (estadoACPM === 'Cerrada' && !archivoEvidencia) {
        return res.status(400).json({ msg: 'Se requiere un archivo de evidencia para cerrar la acci√≥n' });
    }
    
    try {
        const pool = await poolPromise;
        
        const checkACPM = await pool.request()
            .input('idACPM', mssql.Int, idACPM)
            .query('SELECT ID_ACPM FROM dbo.AccionesACPM WHERE ID_ACPM = @idACPM'); 
        
        if (checkACPM.recordset.length === 0) {
            return res.status(404).json({ msg: 'Acci√≥n ACPM no encontrada' });
        }

        let comentarioFormateado = '';
        if (comentariosSeguimiento && comentariosSeguimiento.trim() !== '') {
            const fecha = new Date().toISOString().split('T')[0];
            comentarioFormateado = `\n[${fecha} - ${nombreUsuario}]: ${comentariosSeguimiento}`;
        }

        await pool.request()
            .input('idACPM', mssql.Int, idACPM)
            .input('estadoACPM', mssql.NVarChar, estadoACPM)
            .input('comentarioAdicional', mssql.NVarChar, comentarioFormateado)
            .query('EXEC SP_UPDATE_ACPMGestionar @idACPM, @estadoACPM, @comentarioAdicional');

        let logDescripcion = `Gestion√≥ la ACPM (ID: ${idACPM}), nuevo estado: ${estadoACPM}.`;

        if (archivoEvidencia) {
            const nombreArchivo = archivoEvidencia.filename;
            const rutaArchivo = archivoEvidencia.path;
            let tipoArchivo = path.extname(archivoEvidencia.originalname).replace('.', '').toLowerCase();
            if (tipoArchivo === 'jpeg') tipoArchivo = 'jpg';

            const esEvidenciaDeCierre = (estadoACPM === 'Cerrada'); 
            
            await pool.request()
                .input('idACPM', mssql.Int, idACPM)
                .input('nombreArchivo', mssql.NVarChar, nombreArchivo)
                .input('rutaArchivo', mssql.NVarChar, rutaArchivo)
                .input('tipoArchivo', mssql.NVarChar, tipoArchivo) 
                .input('idUsuarioSubio', mssql.Int, idUsuario)
                .input('esEvidenciaDeCierre', mssql.Bit, esEvidenciaDeCierre)
                .query('EXEC SP_CREATE_EvidenciaACPM @idACPM, @nombreArchivo, @rutaArchivo, @tipoArchivo, @idUsuarioSubio, @esEvidenciaDeCierre');
            
            logDescripcion += ` Se adjunt√≥ evidencia: ${nombreArchivo}.`;
        }

        await logAction(req.usuario.id, req.usuario.nombre, 'GESTIONAR_ACPM', logDescripcion);

        res.json({ msg: 'Acci√≥n ACPM gestionada exitosamente' });

    } catch (err) {
        console.error('Error en gestionarACPM:', err.message);
        if (err.message.includes('Solo se permiten')) {
            return res.status(400).json({ msg: err.message });
        }
        res.status(500).json({ 
            msg: 'Error del servidor al gestionar la ACPM',
            error: err.message 
        });
    }
};

/**
 * @controller  getEvidenciasACPM
 */
const getEvidenciasACPM = async (req, res) => {
    const { id: idACPM } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idACPM', mssql.Int, idACPM)
            .query('EXEC SP_GET_EvidenciasPorACPM @idACPM');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getEvidenciasACPM:', err.message);
        res.status(500).json({ msg: 'Error del servidor al obtener evidencias' }); 
    }
};

const acpmController = {
    crearACPM,
    getACPMs,
    getACPMDetalle,
    gestionarACPM,
    getEvidenciasACPM
};

export default acpmController;


==================================================================
ARCHIVO: backend\controllers\activityController.js
==================================================================
// backend/src/controllers/activityController.js

import { validationResult } from 'express-validator';
import { poolPromise, mssql } from '../config/dbConfig.js';
import path from 'path'; 
import { fileURLToPath } from 'url';
import fs from 'fs/promises'; 
import { logAction } from '../services/logService.js'; // Importar Log

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * @controller  editarActividad
 * @desc        (CU-10) Edita los detalles de una actividad
 */
const editarActividad = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }

    const { id: idActividad } = req.params; 
    const { nombreActividad, descripcionActividad, fechaLimite, idUsuarioResponsable } = req.body;

    try {
        const pool = await poolPromise;
        const checkActividad = await pool.request().input('idActividad', mssql.Int, idActividad).query('SELECT ID_Actividad FROM dbo.Actividades WHERE ID_Actividad = @idActividad');
        if (checkActividad.recordset.length === 0) {
            return res.status(404).json({ msg: 'Actividad no encontrada' });
        }
        
        await pool.request()
            .input('idActividad', mssql.Int, idActividad)
            .input('nombreActividad', mssql.NVarChar, nombreActividad)
            .input('descripcionActividad', mssql.NVarChar, descripcionActividad || null)
            .input('idUsuarioResponsable', mssql.Int, idUsuarioResponsable) 
            .input('fechaLimite', mssql.Date, new Date(fechaLimite))
            .query('EXEC SP_UPDATE_Actividad @idActividad, @nombreActividad, @descripcionActividad, @idUsuarioResponsable, @fechaLimite');
        
        await logAction(req.usuario.id, req.usuario.nombre, 'EDITAR_ACTIVIDAD', `Edit√≥ la actividad: '${nombreActividad}' (ID: ${idActividad})`);
        
        res.json({ msg: 'Actividad actualizada exitosamente' });
    } catch (err) {
        console.error('Error en editarActividad:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  eliminarActividad
 * @desc        (CU-11) Marca una actividad como Inactiva
 */
const eliminarActividad = async (req, res) => {
    const { id: idActividad } = req.params; 
    try {
        const pool = await poolPromise;
        const checkActividad = await pool.request().input('idActividad', mssql.Int, idActividad).query('SELECT NombreActividad FROM dbo.Actividades WHERE ID_Actividad = @idActividad');
        if (checkActividad.recordset.length === 0) {
            return res.status(404).json({ msg: 'Actividad no encontrada' });
        }
        const nombreActividad = checkActividad.recordset[0].NombreActividad;
        
        await pool.request()
            .input('idActividad', mssql.Int, idActividad)
            .query('EXEC SP_DELETE_Actividad @idActividad');
        
        await logAction(req.usuario.id, req.usuario.nombre, 'ELIMINAR_ACTIVIDAD', `Elimin√≥ la actividad: '${nombreActividad}' (ID: ${idActividad})`);
        
        res.json({ msg: 'Actividad eliminada (archivada) exitosamente' });
    } catch (err) {
        console.error('Error en eliminarActividad:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  gestionarActividad
 * @desc        (CU-01) Gestiona el estado y la evidencia de una actividad
 */
const gestionarActividad = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    const { id: idActividad } = req.params; 
    const { estado, observaciones } = req.body; 
    const idUsuario = req.usuario.id; 
    const archivoEvidencia = req.file; 
    
    // Validaci√≥n: Si marca como realizada, debe subir evidencia
    if (estado === 'Realizada' && !archivoEvidencia) {
        // Nota: Esto asume que es obligatorio subir evidencia CADA VEZ que se marca realizada.
        // Si quieres permitir marcarla si YA TIENE evidencia previa, la l√≥gica ser√≠a m√°s compleja.
        return res.status(400).json({ msg: 'Se requiere un archivo de evidencia para marcar la actividad como "Realizada"' });
    }
    
    try {
        const pool = await poolPromise;
        const checkActividad = await pool.request().input('idActividad', mssql.Int, idActividad).query('SELECT ID_Actividad FROM dbo.Actividades WHERE ID_Actividad = @idActividad');
        if (checkActividad.recordset.length === 0) {
            return res.status(404).json({ msg: 'Actividad no encontrada' });
        }
        
        // 1. Actualizar Estado y Observaciones
        await pool.request()
            .input('idActividad', mssql.Int, idActividad)
            .input('estado', mssql.NVarChar, estado)
            .input('observaciones', mssql.NVarChar, observaciones || null) 
            .query('EXEC SP_UPDATE_ActividadEstado @idActividad, @estado, @observaciones');
        
        let logDescripcion = `Gestion√≥ la actividad (ID: ${idActividad}), nuevo estado: ${estado}.`;

        // 2. Insertar Evidencia (si existe archivo)
        if (archivoEvidencia) {
            const nombreArchivo = archivoEvidencia.filename;
            const rutaArchivo = archivoEvidencia.path;
            const tipoArchivo = archivoEvidencia.mimetype; // Esto env√≠a "application/pdf", etc.
            
            await pool.request()
                .input('idActividad', mssql.Int, idActividad)
                .input('nombreArchivo', mssql.NVarChar, nombreArchivo)
                .input('rutaArchivo', mssql.NVarChar, rutaArchivo)
                .input('tipoArchivo', mssql.NVarChar, tipoArchivo)
                .input('idUsuarioSubio', mssql.Int, idUsuario)
                .query('EXEC SP_CREATE_EvidenciaActividad @idActividad, @nombreArchivo, @rutaArchivo, @tipoArchivo, @idUsuarioSubio');
            
            logDescripcion += ` Se adjunt√≥ evidencia.`;
        }
        
        await logAction(req.usuario.id, req.usuario.nombre, 'GESTIONAR_ACTIVIDAD', logDescripcion);
        
        res.json({ msg: 'Actividad gestionada exitosamente' });

    } catch (err) {
        console.error('Error en gestionarActividad:', err.message);
        
        // Atrapa el error de la BD si todav√≠a hay problemas de constraints
        if (err.message.includes('conflicted with the CHECK constraint')) {
            return res.status(500).send('Error de BD: Restricci√≥n de tipo de archivo no actualizada. Ejecute el script SQL.');
        }
        
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getEvidenciasActividad
 * @desc        Obtiene las evidencias de una actividad
 */
const getEvidenciasActividad = async (req, res) => {
    const { id: idActividad } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idActividad', mssql.Int, idActividad)
            .query('EXEC SP_GET_EvidenciasPorActividad @idActividad');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getEvidenciasActividad:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getActividadDetalle
 * @desc        (NUEVO) Obtiene el detalle completo de una actividad por ID
 */
const getActividadDetalle = async (req, res) => {
    const { id: idActividad } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idActividad', mssql.Int, idActividad)
            .query('EXEC SP_GET_ActividadDetalle @idActividad');

        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Actividad no encontrada' });
        }
        
        res.json(result.recordset[0]);
    } catch (err) {
        console.error('Error en getActividadDetalle:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const activityController = {
    editarActividad,
    eliminarActividad,
    gestionarActividad,
    getEvidenciasActividad,
    getActividadDetalle
};

export default activityController;


==================================================================
ARCHIVO: backend\controllers\assetController.js
==================================================================
// backend/src/controllers/assetController.js

import { validationResult } from 'express-validator';
import { poolPromise, mssql } from '../config/dbConfig.js';

const getActivosPorTipo = async (req, res) => {
    const { tipo } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('tipoActivo', mssql.NVarChar, tipo)
            .query('EXEC SP_GET_ActivosPorTipo @tipoActivo');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getActivosPorTipo:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getActivosTodos = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_Activos_Todos');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getActivosTodos:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const crearActivo = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) return res.status(400).json({ errors: errors.array() });

    // Extraemos todos los campos
    const { 
        tipoActivo, codigoIdentificador, nombreDescriptivo, ubicacion,
        marca, modelo, soatVencimiento, tecnoVencimiento, kilometrajeInicial, idConductor
    } = req.body;

    try {
        const pool = await poolPromise;
        await pool.request()
            .input('tipoActivo', mssql.NVarChar, tipoActivo)
            .input('codigoIdentificador', mssql.NVarChar, codigoIdentificador)
            .input('nombreDescriptivo', mssql.NVarChar, nombreDescriptivo)
            .input('ubicacion', mssql.NVarChar, ubicacion || null)
            .input('marca', mssql.NVarChar, marca || null)
            .input('modelo', mssql.NVarChar, modelo || null)
            .input('soatVencimiento', mssql.Date, soatVencimiento || null)
            .input('tecnoVencimiento', mssql.Date, tecnoVencimiento || null)
            .input('kilometrajeInicial', mssql.Int, kilometrajeInicial || 0)
            .input('idConductor', mssql.Int, idConductor || null)
            .query('EXEC SP_CREATE_Activo @tipoActivo, @codigoIdentificador, @nombreDescriptivo, @ubicacion, @marca, @modelo, @soatVencimiento, @tecnoVencimiento, @kilometrajeInicial, @idConductor');

        res.status(201).json({ msg: 'Activo creado exitosamente' });
    } catch (err) {
        if (err.message.includes('Ya existe un activo')) return res.status(400).json({ msg: err.message });
        console.error('Error en crearActivo:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const actualizarActivo = async (req, res) => {
    const { id } = req.params;
    const { 
        tipoActivo, codigoIdentificador, nombreDescriptivo, ubicacion,
        marca, modelo, soatVencimiento, tecnoVencimiento, idConductor
    } = req.body;

    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idActivo', mssql.Int, id)
            .input('tipoActivo', mssql.NVarChar, tipoActivo)
            .input('codigoIdentificador', mssql.NVarChar, codigoIdentificador)
            .input('nombreDescriptivo', mssql.NVarChar, nombreDescriptivo)
            .input('ubicacion', mssql.NVarChar, ubicacion || null)
            .input('marca', mssql.NVarChar, marca || null)
            .input('modelo', mssql.NVarChar, modelo || null)
            .input('soatVencimiento', mssql.Date, soatVencimiento || null)
            .input('tecnoVencimiento', mssql.Date, tecnoVencimiento || null)
            .input('idConductor', mssql.Int, idConductor || null)
            .query('EXEC SP_UPDATE_Activo @idActivo, @tipoActivo, @codigoIdentificador, @nombreDescriptivo, @ubicacion, @marca, @modelo, @soatVencimiento, @tecnoVencimiento, @idConductor');

        res.json({ msg: 'Activo actualizado exitosamente' });
    } catch (err) {
        if (err.message.includes('Ya existe OTRO activo')) return res.status(400).json({ msg: err.message });
        console.error('Error en actualizarActivo:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const eliminarActivo = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        await pool.request().input('idActivo', mssql.Int, id).query('EXEC SP_DELETE_Activo @idActivo');
        res.json({ msg: 'Activo eliminado exitosamente' });
    } catch (err) {
        if (err.message.includes('referenciado') || err.message.includes('No se puede inactivar')) {
             return res.status(400).json({ msg: err.message });
        }
        console.error('Error en eliminarActivo:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getTiposDisponibles = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_TiposActivosDisponibles');
        
        // CAMBIO CLAVE: Devolvemos todo el recordset (objetos con Tipo y Categor√≠a)
        // No hacemos .map() para que el frontend pueda leer la propiedad 'Categoria'
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getTiposDisponibles:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const assetController = {
    getActivosPorTipo,
    getActivosTodos,
    crearActivo,
    actualizarActivo,
    eliminarActivo,
    getTiposDisponibles
};

export default assetController;


==================================================================
ARCHIVO: backend\controllers\authController.js
==================================================================
// backend/controllers/authController.js

import { validationResult } from 'express-validator';
import bcrypt from 'bcryptjs';
import jwt from 'jsonwebtoken'; 
import { poolPromise, mssql } from '../config/dbConfig.js';

const login = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }

    const { cedula, password } = req.body;

    try {
        const pool = await poolPromise;
        
        // Ejecutamos el SP modificado (aseg√∫rate de haber corrido el script SQL del paso anterior)
        const result = await pool.request()
            .input('cedula', mssql.NVarChar, cedula)
            .query('EXEC SP_AUTH_LoginUsuario @cedula');

        if (result.recordset.length === 0) {
            return res.status(401).json({ msg: 'Credenciales inv√°lidas' });
        }

        const usuario = result.recordset[0];

        if (usuario.EstadoCuenta === 'Inactivo') {
            return res.status(403).json({ msg: 'Esta cuenta de usuario est√° inactiva.' });
        }

        const isMatch = await bcrypt.compare(password, usuario.PasswordHash);
        if (!isMatch) {
            return res.status(401).json({ msg: 'Credenciales inv√°lidas' });
        }

        // --- CREACI√ìN DEL PAYLOAD DEL TOKEN ---
        const payload = {
            usuario: {
                id: usuario.ID_Usuario,
                nombre: usuario.NombreCompleto,
                rol: usuario.NombreRol,
                cedula: usuario.CedulaUsuario,
                email: usuario.Email // <--- ¬°AQU√ç ESTABA EL ERROR! Ahora el token recordar√° el correo
            }
        };

        jwt.sign(
            payload,
            process.env.JWT_SECRET,
            { expiresIn: '8h' },
            (err, token) => {
                if (err) throw err;
                res.json({ token });
            }
        );

    } catch (err) {
        console.error('Error en login:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const authController = { login };
export default authController;


==================================================================
ARCHIVO: backend\controllers\budgetController.js
==================================================================
// backend/controllers/budgetController.js
import { poolPromise, mssql } from '../config/dbConfig.js';
import path from 'path';

// --- Crear Presupuesto (Super Admin) ---
const crearPresupuesto = async (req, res) => {
    const { nombreRubro, descripcion, montoAsignado, anio } = req.body;
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('NombreRubro', mssql.NVarChar, nombreRubro)
            .input('Descripcion', mssql.NVarChar, descripcion)
            .input('MontoAsignado', mssql.Decimal(18, 2), montoAsignado)
            .input('Anio', mssql.Int, anio)
            .query('EXEC SP_CREATE_Presupuesto @NombreRubro, @Descripcion, @MontoAsignado, @Anio');
        
        res.json({ msg: 'Presupuesto asignado correctamente' });
    } catch (err) {
        console.error(err);
        res.status(500).send('Error al crear presupuesto');
    }
};

// --- Registrar Gasto (Admin SST) ---
const registrarGasto = async (req, res) => {
    const { idPresupuesto, descripcionGasto, montoGastado, fechaGasto } = req.body;
    const archivo = req.file; // Evidencia
    const idUsuario = req.usuario.id;

    try {
        const rutaEvidencia = archivo ? archivo.path.replace(/\\/g, '/') : null;

        const pool = await poolPromise;
        await pool.request()
            .input('ID_Presupuesto', mssql.Int, idPresupuesto)
            .input('DescripcionGasto', mssql.NVarChar, descripcionGasto)
            .input('MontoGastado', mssql.Decimal(18, 2), montoGastado)
            .input('FechaGasto', mssql.Date, fechaGasto)
            .input('RutaEvidencia', mssql.NVarChar, rutaEvidencia)
            .input('ID_UsuarioRegistra', mssql.Int, idUsuario)
            .query('EXEC SP_CREATE_Gasto @ID_Presupuesto, @DescripcionGasto, @MontoGastado, @FechaGasto, @RutaEvidencia, @ID_UsuarioRegistra');

        res.json({ msg: 'Gasto registrado correctamente' });
    } catch (err) {
        console.error(err);
        res.status(500).send('Error al registrar gasto');
    }
};

// --- Obtener Resumen (Dashboard) ---
const getPresupuestos = async (req, res) => {
    const { anio } = req.query; // ?anio=2025
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('Anio', mssql.Int, anio || new Date().getFullYear())
            .query('EXEC SP_GET_PresupuestosResumen @Anio');
        res.json(result.recordset);
    } catch (err) {
        console.error(err);
        res.status(500).send('Error obteniendo presupuestos');
    }
};

// --- Obtener Detalle de Gastos ---
const getDetalleGastos = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('ID_Presupuesto', mssql.Int, id)
            .query('EXEC SP_GET_DetalleGastos @ID_Presupuesto');
        res.json(result.recordset);
    } catch (err) {
        console.error(err);
        res.status(500).send('Error obteniendo detalle');
    }
};

// --- NUEVO: Editar Presupuesto ---
const editarPresupuesto = async (req, res) => {
    const { id } = req.params;
    const { nombreRubro, descripcion, montoAsignado, anio, estado } = req.body;
    
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('ID_Presupuesto', mssql.Int, id)
            .input('NombreRubro', mssql.NVarChar, nombreRubro)
            .input('Descripcion', mssql.NVarChar, descripcion)
            .input('MontoAsignado', mssql.Decimal(18, 2), montoAsignado)
            .input('Anio', mssql.Int, anio)
            .input('Estado', mssql.NVarChar, estado)
            .query('EXEC SP_UPDATE_Presupuesto @ID_Presupuesto, @NombreRubro, @Descripcion, @MontoAsignado, @Anio, @Estado');

        res.json({ msg: 'Presupuesto actualizado correctamente' });
    } catch (err) {
        console.error(err);
        res.status(500).send('Error al actualizar presupuesto');
    }
};

// --- NUEVO: Eliminar Presupuesto ---
const eliminarPresupuesto = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('ID_Presupuesto', mssql.Int, id)
            .query('EXEC SP_DELETE_Presupuesto @ID_Presupuesto');

        res.json({ msg: 'Rubro eliminado exitosamente' });
    } catch (err) {
        // Capturamos el error del SP (si tiene gastos)
        if (err.message.includes('ya tiene gastos registrados')) {
            return res.status(400).json({ msg: err.message });
        }
        console.error(err);
        res.status(500).send('Error al eliminar presupuesto');
    }
};

export default { 
    crearPresupuesto, 
    registrarGasto, 
    getPresupuestos, 
    getDetalleGastos,
    editarPresupuesto, // <--- Nuevo
    eliminarPresupuesto // <--- Nuevo
};


==================================================================
ARCHIVO: backend\controllers\collabDocsController.js
==================================================================
// backend/controllers/collabDocsController.js

import { poolPromise, mssql } from '../config/dbConfig.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// --- SUBIR DOCUMENTO ---
const subirDocumento = async (req, res) => {
    const { cedula, nombreColaborador, tipoDocumento } = req.body;
    const archivo = req.file;
    const idUsuarioSubio = req.usuario.id;

    if (!archivo) return res.status(400).json({ msg: 'No se adjunt√≥ ning√∫n archivo' });

    try {
        // Guardamos la ruta relativa
        const rutaFinal = archivo.path.replace(/\\/g, '/');

        const pool = await poolPromise;
        await pool.request()
            .input('cedula', mssql.NVarChar, cedula)
            .input('nombreColaborador', mssql.NVarChar, nombreColaborador)
            .input('tipoDoc', mssql.NVarChar, tipoDocumento)
            .input('nombreArchivo', mssql.NVarChar, archivo.originalname)
            .input('rutaArchivo', mssql.NVarChar, rutaFinal)
            .input('idUsuarioSubio', mssql.Int, idUsuarioSubio)
            .query('EXEC SP_CREATE_DocColaborador @cedula, @nombreColaborador, @tipoDoc, @nombreArchivo, @rutaArchivo, @idUsuarioSubio');

        res.status(201).json({ msg: 'Documento adjuntado exitosamente' });

    } catch (err) {
        console.error('Error subiendo doc:', err);
        res.status(500).send('Error del servidor');
    }
};

// --- LISTAR DOCUMENTOS DE UNA C√âDULA ---
const getDocumentosPorCedula = async (req, res) => {
    const { cedula } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('cedula', mssql.NVarChar, cedula)
            .query('EXEC SP_GET_DocsPorCedula @cedula');
        
        res.json(result.recordset);
    } catch (err) {
        console.error('Error listando docs:', err);
        res.status(500).send('Error del servidor');
    }
};

// --- DESCARGAR DOCUMENTO ---
const descargarDocumento = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('id', mssql.Int, id)
            .query('SELECT RutaArchivo, NombreArchivo FROM DocumentosColaboradores WHERE ID_Documento = @id');

        if (result.recordset.length === 0) return res.status(404).json({ msg: 'Documento no encontrado en BD' });

        const { RutaArchivo, NombreArchivo } = result.recordset[0];
        
        // Ajuste de ruta: quitamos 'backend/' si la BD lo guard√≥ as√≠, para usar path.resolve correctamente
        let rutaLimpia = RutaArchivo;
        if (RutaArchivo.startsWith('backend/')) rutaLimpia = RutaArchivo.replace('backend/', '');
        if (RutaArchivo.startsWith('backend\\')) rutaLimpia = RutaArchivo.replace('backend\\', '');

        const filePath = path.resolve(__dirname, '..', rutaLimpia);

        if (fs.existsSync(filePath)) {
            res.download(filePath, NombreArchivo);
        } else {
            res.status(404).json({ msg: 'El archivo f√≠sico no existe en el servidor.' });
        }
    } catch (err) {
        console.error(err);
        res.status(500).send('Error al descargar');
    }
};

// --- ELIMINAR DOCUMENTO ---
const eliminarDocumento = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        // 1. Obtener ruta para borrar f√≠sico
        const result = await pool.request()
            .input('id', mssql.Int, id)
            .query('SELECT RutaArchivo FROM DocumentosColaboradores WHERE ID_Documento = @id');

        if (result.recordset.length > 0) {
            const ruta = result.recordset[0].RutaArchivo;
            let rutaLimpia = ruta.startsWith('backend') ? ruta.replace('backend/', '') : ruta;
            const filePath = path.resolve(__dirname, '..', rutaLimpia);

            // Borrar archivo f√≠sico (si existe)
            try { if (fs.existsSync(filePath)) fs.unlinkSync(filePath); } catch (e) { console.warn('No se pudo borrar archivo f√≠sico:', e); }
        }

        // 2. Borrar registro BD
        await pool.request().input('idDocumento', mssql.Int, id).query('EXEC SP_DELETE_DocColaborador @idDocumento');

        res.json({ msg: 'Documento eliminado' });

    } catch (err) {
        console.error(err);
        res.status(500).send('Error al eliminar');
    }
};

const verDocumento = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('id', mssql.Int, id)
            .query('SELECT RutaArchivo, NombreArchivo FROM DocumentosColaboradores WHERE ID_Documento = @id');

        if (result.recordset.length === 0) return res.status(404).json({ msg: 'Documento no encontrado' });

        const { RutaArchivo } = result.recordset[0];
        
        let rutaLimpia = RutaArchivo;
        if (RutaArchivo.startsWith('backend/')) rutaLimpia = RutaArchivo.replace('backend/', '');
        if (RutaArchivo.startsWith('backend\\')) rutaLimpia = RutaArchivo.replace('backend\\', '');

        const filePath = path.resolve(__dirname, '..', rutaLimpia);

        if (fs.existsSync(filePath)) {
            // "inline" le dice al navegador: "Intenta mostrarlo aqu√≠ mismo"
            res.setHeader('Content-Disposition', 'inline'); 
            res.sendFile(filePath);
        } else {
            res.status(404).json({ msg: 'El archivo f√≠sico no existe.' });
        }
    } catch (err) {
        console.error(err);
        res.status(500).send('Error al visualizar');
    }
};
export default { subirDocumento, getDocumentosPorCedula, descargarDocumento, eliminarDocumento, verDocumento };


==================================================================
ARCHIVO: backend\controllers\committeeController.js
==================================================================
// backend/controllers/committeeController.js

import { poolPromise, mssql } from '../config/dbConfig.js';
import { generarActaComitePDF } from '../utils/committeePdfGenerator.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const crearActa = async (req, res) => {
    const {
        codigoDocumento, fechaEmision, fechaRevision, version, numeroActa, lugar, fechaReunion,
        horaInicio, horaFin, objetivo, desarrollo, nombrePresidente, nombreSecretario,
        asistentes, compromisos
    } = req.body;

    const archivoSubido = req.file;

    try {
        if (!fechaReunion) {
            return res.status(400).json({ msg: "La 'Fecha de Reuni√≥n' es obligatoria." });
        }

        const valFechaEmision = fechaEmision ? new Date(fechaEmision) : null;
        const valFechaRevision = fechaRevision ? new Date(fechaRevision) : null;
        const valFechaReunion = new Date(fechaReunion);

        let arrAsistentes = [];
        let arrCompromisos = [];
        try {
            arrAsistentes = typeof asistentes === 'string' ? JSON.parse(asistentes) : asistentes;
            arrCompromisos = typeof compromisos === 'string' ? JSON.parse(compromisos) : compromisos;
        } catch (e) { console.warn("Error JSON:", e.message); }

        if (!Array.isArray(arrAsistentes)) arrAsistentes = [];
        if (!Array.isArray(arrCompromisos)) arrCompromisos = [];

        let rutaArchivo = '';
        const jsonAsistentesSQL = JSON.stringify(arrAsistentes);
        const jsonCompromisosSQL = JSON.stringify(arrCompromisos);

        if (archivoSubido) {
            rutaArchivo = archivoSubido.path.replace(/\\/g, '/');
        } else {
            const nombrePDF = `Acta_${numeroActa || 'SinNum'}_${Date.now()}.pdf`;
            const dirActas = path.join(__dirname, '../uploads/actas');
            if (!fs.existsSync(dirActas)) fs.mkdirSync(dirActas, { recursive: true });

            const rutaRelativa = `uploads/actas/${nombrePDF}`;
            const rutaAbsoluta = path.join(dirActas, nombrePDF);
            
            const datosActa = {
                codigoDocumento, fechaEmision, fechaRevision, version, numeroActa, 
                lugar, fechaReunion, horaInicio, horaFin, 
                objetivo, desarrollo, nombrePresidente, nombreSecretario
            };

            await generarActaComitePDF(datosActa, arrAsistentes, arrCompromisos, rutaAbsoluta);
            rutaArchivo = rutaRelativa;
        }

        const pool = await poolPromise;
        await pool.request()
            .input('CodigoDocumento', mssql.NVarChar, codigoDocumento)
            .input('FechaEmision', mssql.Date, valFechaEmision)
            .input('FechaRevision', mssql.Date, valFechaRevision)
            .input('Version', mssql.NVarChar, version)
            .input('NumeroActa', mssql.NVarChar, numeroActa)
            .input('Lugar', mssql.NVarChar, lugar)
            .input('FechaReunion', mssql.Date, valFechaReunion)
            .input('HoraInicio', mssql.NVarChar, horaInicio)
            .input('HoraFin', mssql.NVarChar, horaFin)
            .input('Objetivo', mssql.NVarChar, objetivo)
            .input('Desarrollo', mssql.NVarChar, desarrollo)
            .input('NombrePresidente', mssql.NVarChar, nombrePresidente)
            .input('NombreSecretario', mssql.NVarChar, nombreSecretario)
            .input('RutaArchivo', mssql.NVarChar, rutaArchivo)
            .input('JsonAsistentes', mssql.NVarChar(mssql.MAX), jsonAsistentesSQL)
            .input('JsonCompromisos', mssql.NVarChar(mssql.MAX), jsonCompromisosSQL)
            .query('EXEC SP_CREATE_ActaComite @CodigoDocumento, @FechaEmision, @FechaRevision, @Version, @NumeroActa, @Lugar, @FechaReunion, @HoraInicio, @HoraFin, @Objetivo, @Desarrollo, @NombrePresidente, @NombreSecretario, @RutaArchivo, @JsonAsistentes, @JsonCompromisos');

        res.json({ msg: 'Acta guardada correctamente', ruta: rutaArchivo });

    } catch (error) {
        console.error("‚ùå Error en crearActa:", error);
        res.status(500).send('Error al guardar el acta: ' + error.message);
    }
};

const getActas = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_ActasComite');
        res.json(result.recordset);
    } catch (error) {
        console.error(error);
        res.status(500).send('Error obteniendo actas');
    }
};

const actualizarArchivoActa = async (req, res) => {
    const { id } = req.params;
    const archivoNuevo = req.file;

    if (!archivoNuevo) {
        return res.status(400).json({ msg: 'No se ha subido ning√∫n archivo.' });
    }

    try {
        const rutaArchivo = archivoNuevo.path.replace(/\\/g, '/');
        const pool = await poolPromise;
        await pool.request()
            .input('idActa', mssql.Int, id)
            .input('rutaArchivo', mssql.NVarChar, rutaArchivo)
            .query('EXEC SP_UPDATE_ActaArchivo @idActa, @rutaArchivo');

        res.json({ msg: 'Archivo original actualizado correctamente' });
    } catch (error) {
        console.error("‚ùå Error actualizando archivo acta:", error);
        res.status(500).send('Error al actualizar el archivo');
    }
};

// --- NUEVA FUNCI√ìN: SUBIR FIRMAS ---
const subirFirmasActa = async (req, res) => {
    const { id } = req.params;
    const archivoFirmas = req.file;

    if (!archivoFirmas) return res.status(400).json({ msg: 'No se ha subido ning√∫n archivo de firmas.' });

    try {
        const rutaArchivo = archivoFirmas.path.replace(/\\/g, '/');
        const pool = await poolPromise;
        await pool.request()
            .input('idActa', mssql.Int, id)
            .input('rutaArchivo', mssql.NVarChar, rutaArchivo)
            .query('EXEC SP_UPLOAD_FirmasActa @idActa, @rutaArchivo');

        res.json({ msg: 'Documento de firmas subido correctamente' });
    } catch (error) {
        console.error("‚ùå Error subiendo firmas:", error);
        res.status(500).send('Error al subir el archivo de firmas');
    }
};

// --- NUEVA FUNCI√ìN: DESCARGAR ARCHIVO ---
const descargarActa = async (req, res) => {
    const { id } = req.params;
    const { tipo } = req.query; // 'original' o 'firmas'

    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('id', mssql.Int, id)
            .query('SELECT RutaArchivo, RutaArchivoFirmas, NumeroActa FROM ComiteActas WHERE ID_Acta = @id');

        if (result.recordset.length === 0) return res.status(404).json({ msg: 'Acta no encontrada' });

        const acta = result.recordset[0];
        let rutaRelativa = (tipo === 'firmas') ? acta.RutaArchivoFirmas : acta.RutaArchivo;

        if (!rutaRelativa) return res.status(404).json({ msg: 'Archivo no disponible' });

        // Limpiar ruta para evitar problemas de path
        if (rutaRelativa.startsWith('backend/')) rutaRelativa = rutaRelativa.replace('backend/', '');
        if (rutaRelativa.startsWith('backend\\')) rutaRelativa = rutaRelativa.replace('backend\\', '');

        const rutaAbsoluta = path.resolve(__dirname, '..', rutaRelativa);

        if (fs.existsSync(rutaAbsoluta)) {
            const sufijo = tipo === 'firmas' ? '_FIRMADO' : '';
            const nombreDescarga = `Acta_${acta.NumeroActa}${sufijo}.pdf`;
            
            // Forzamos la descarga con el nombre correcto
            res.download(rutaAbsoluta, nombreDescarga);
        } else {
            res.status(404).json({ msg: 'El archivo f√≠sico no existe en el servidor.' });
        }

    } catch (error) {
        console.error(error);
        res.status(500).send('Error en descarga');
    }
};

export default { crearActa, getActas, actualizarArchivoActa, subirFirmasActa, descargarActa };


==================================================================
ARCHIVO: backend\controllers\dashboardController.js
==================================================================
// backend/controllers/dashboardController.js

import { poolPromise, mssql } from '../config/dbConfig.js';

/**
 * @controller  getAdminKPIs
 * @desc        Obtiene los 4 KPIs (contadores) para el dashboard del Admin
 */
const getAdminKPIs = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_Dashboard_Admin_KPIs');
        res.json(result.recordset[0]);
    } catch (err) {
        console.error('Error en getAdminKPIs:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getAdminActividadesPendientes
 * @desc        Obtiene la lista Top 5 de actividades pendientes
 */
const getAdminActividadesPendientes = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_Dashboard_ActividadesPendientes');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getAdminActividadesPendientes:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getAdminActividadesEstado
 * @desc        Obtiene el conteo de actividades por estado para la gr√°fica
 */
const getAdminActividadesEstado = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_Dashboard_Actividades_Estado');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getAdminActividadesEstado:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getAdminReportesRecientes
 * @desc        Obtiene la lista Top 5 de reportes nuevos
 */
const getAdminReportesRecientes = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_Dashboard_ReportesRecientes');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getAdminReportesRecientes:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getSuperAdminData
 * @desc        Obtiene toda la data para el dashboard del Super Admin
 */
const getSuperAdminData = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_SuperAdmin_Dashboard');
        
        const kpis = result.recordsets[0][0];       // Tabla 1: KPIs
        const grafica = result.recordsets[1];       // Tabla 2: Datos Gr√°fica
        const logs = result.recordsets[2];          // Tabla 3: Logs Recientes

        res.json({
            kpis,
            grafica,
            logs
        });
    } catch (err) {
        console.error('Error en getSuperAdminData:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const dashboardController = {
    getAdminKPIs,
    getAdminActividadesPendientes,
    getAdminActividadesEstado, // <--- NUEVO
    getAdminReportesRecientes,
    getSuperAdminData
};

export default dashboardController;


==================================================================
ARCHIVO: backend\controllers\documentController.js
==================================================================
// backend/src/controllers/documentController.js

import { validationResult } from 'express-validator';
import { poolPromise, mssql } from '../config/dbConfig.js';
import path from 'path'; 
import { fileURLToPath } from 'url';
import fs from 'fs/promises'; 
import mime from 'mime-types'; 
import { logAction } from '../services/logService.js'; // <-- 1. Importar

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const getContenidoCarpeta = async (req, res) => {
    // (Lectura, no se loguea)
    const { id } = req.params; 
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idCarpeta', mssql.Int, id)
            .query('EXEC SP_GET_ContenidoCarpeta @idCarpeta');
        res.json({
            carpetas: result.recordsets[0] || [],
            archivos: result.recordsets[1] || []
        });
    } catch (err) {
        console.error('Error en getContenidoCarpeta:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const crearCarpeta = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    const { nombreCarpeta, idCarpetaPadre } = req.body;
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('nombreCarpeta', mssql.NVarChar, nombreCarpeta)
            .input('idCarpetaPadre', mssql.Int, idCarpetaPadre)
            .query('EXEC SP_CREATE_Carpeta @nombreCarpeta, @idCarpetaPadre');
        
        // --- 2. A√ëADIR LOG ---
        await logAction(
            req.usuario.id, 
            req.usuario.nombre, 
            'CREAR_CARPETA_DMS', 
            `Cre√≥ la carpeta: '${nombreCarpeta}' (en ID Padre: ${idCarpetaPadre})`
        );
        // --- FIN DE LOG ---

        res.status(201).json({ msg: 'Carpeta creada exitosamente' });
    } catch (err) {
        if (err.message.includes('Ya existe una carpeta con ese nombre')) {
            return res.status(400).json({ msg: err.message });
        }
        console.error('Error en crearCarpeta:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const subirArchivos = async (req, res) => {
    const { idCarpeta } = req.body;
    const idUsuario = req.usuario.id;
    const files = req.files; 
    if (!idCarpeta) {
        return res.status(400).json({ msg: 'No se especific√≥ la carpeta de destino.' });
    }
    if (!files || files.length === 0) {
        return res.status(400).json({ msg: 'No se seleccionaron archivos.' });
    }
    try {
        const pool = await poolPromise;
        let nombresDeArchivos = []; // Para el log
        
        for (const file of files) {
            const params = {
                idCarpeta: idCarpeta,
                idUsuarioSubio: idUsuario,
                nombreOriginal: file.originalname,
                nombreAlmacenado: file.filename,
                rutaArchivo: file.path,
                tipoArchivo: file.mimetype,
                tamanoArchivoKB: Math.round(file.size / 1024)
            };
            nombresDeArchivos.push(file.originalname); // A√±adir al log
            await pool.request()
                .input('idCarpeta', mssql.Int, params.idCarpeta)
                .input('idUsuarioSubio', mssql.Int, params.idUsuarioSubio)
                .input('nombreOriginal', mssql.NVarChar, params.nombreOriginal)
                .input('nombreAlmacenado', mssql.NVarChar, params.nombreAlmacenado)
                .input('rutaArchivo', mssql.NVarChar, params.rutaArchivo)
                .input('tipoArchivo', mssql.NVarChar, params.tipoArchivo)
                .input('tamanoArchivoKB', mssql.Int, params.tamanoArchivoKB)
                .query('EXEC SP_CREATE_Documento @idCarpeta, @idUsuarioSubio, @nombreOriginal, @nombreAlmacenado, @rutaArchivo, @tipoArchivo, @tamanoArchivoKB');
        }
        
        // --- A√ëADIR LOG ---
        await logAction(
            req.usuario.id, 
            req.usuario.nombre, 
            'SUBIR_DOCUMENTO_DMS', 
            `Subi√≥ ${files.length} archivo(s) a la carpeta ID ${idCarpeta}: ${nombresDeArchivos.join(', ')}`
        );
        // --- FIN DE LOG ---

        res.status(201).json({ msg: `${files.length} archivo(s) subidos exitosamente.` });
    } catch (err) {
        console.error('Error en subirArchivos:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const descargarDocumento = async (req, res) => {
    // (Lectura, no se loguea)
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idDocumento', mssql.Int, id)
            .query('EXEC SP_GET_DocumentoDetalle @idDocumento');
        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Documento no encontrado' });
        }
        const doc = result.recordset[0];
        const rutaAbsoluta = path.resolve(__dirname, '..', doc.RutaArchivo);
        res.download(rutaAbsoluta, doc.NombreOriginal, (err) => {
            if (err) {
                console.error("Error al enviar el archivo:", err);
                res.status(404).send('Error: Archivo no encontrado en el servidor.');
            }
        });
    } catch (err) {
        console.error('Error en descargarDocumento:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const eliminarDocumento = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idDocumento', mssql.Int, id)
            .query('EXEC SP_GET_DocumentoDetalle @idDocumento');
        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Documento no encontrado en la BD.' });
        }
        const doc = result.recordset[0];
        const rutaAbsoluta = path.resolve(__dirname, '..', doc.RutaArchivo);

        await pool.request()
            .input('idDocumento', mssql.Int, id)
            .query('EXEC SP_DELETE_Documento @idDocumento');
        
        try {
            await fs.unlink(rutaAbsoluta);
        } catch (fileErr) {
            console.warn(`Se elimin√≥ el registro ${id}, pero el archivo f√≠sico no se encontr√≥ en: ${rutaAbsoluta}`);
        }
        
        // --- A√ëADIR LOG ---
        await logAction(
            req.usuario.id, 
            req.usuario.nombre, 
            'ELIMINAR_DOCUMENTO_DMS', 
            `Elimin√≥ el documento: '${doc.NombreOriginal}' (ID: ${id})`
        );
        // --- FIN DE LOG ---
        
        res.json({ msg: 'Documento eliminado exitosamente' });
    } catch (err) {
        console.error('Error en eliminarDocumento:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const eliminarCarpeta = async (req, res) => {
    const { id } = req.params;
    if (id === '1') {
        return res.status(400).json({ msg: 'No se puede eliminar la carpeta ra√≠z.' });
    }
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idCarpeta', mssql.Int, id)
            .query('EXEC SP_DELETE_Carpeta @idCarpeta');
        
        // --- A√ëADIR LOG ---
        await logAction(
            req.usuario.id, 
            req.usuario.nombre, 
            'ELIMINAR_CARPETA_DMS', 
            `Elimin√≥ la carpeta (ID: ${id})`
        );
        // --- FIN DE LOG ---
        
        res.json({ msg: 'Carpeta eliminada exitosamente' });
    } catch (err) {
        if (err.message.includes('contiene subcarpetas') || err.message.includes('contiene archivos')) {
            return res.status(400).json({ msg: err.message });
        }
        console.error('Error en eliminarCarpeta:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const streamDocumento = async (req, res) => {
    // (Lectura, no se loguea)
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idDocumento', mssql.Int, id)
            .query('EXEC SP_GET_DocumentoDetalle @idDocumento');
        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Documento no encontrado' });
        }
        const doc = result.recordset[0];
        const rutaAbsoluta = path.resolve(__dirname, '..', doc.RutaArchivo);
        const mimeType = doc.TipoArchivo || mime.lookup(rutaAbsoluta) || 'application/octet-stream';
        res.setHeader('Content-Type', mimeType);
        res.setHeader('Content-Disposition', `inline; filename="${doc.NombreOriginal}"`);
        res.sendFile(rutaAbsoluta, (err) => {
            if (err) {
                console.error("Error al enviar el archivo:", err);
                res.status(404).send('Error: Archivo no encontrado en el servidor.');
            }
        });
    } catch (err) {
        console.error('Error en streamDocumento:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const documentController = {
    getContenidoCarpeta,
    crearCarpeta,
    subirArchivos,
    descargarDocumento,
    eliminarDocumento,
    eliminarCarpeta,
    streamDocumento 
};

export default documentController;


==================================================================
ARCHIVO: backend\controllers\historyController.js
==================================================================
// backend/controllers/historyController.js
import { poolPromise, mssql } from '../config/dbConfig.js';

const getHistorialColaborador = async (req, res) => {
    // CAMBIO: Ahora recibimos la C√©dula, no el ID
    const { cedula } = req.params; 
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('Cedula', mssql.NVarChar, cedula) // <--- Cambio aqu√≠
            .query('EXEC SP_GET_Historial_Colaborador @Cedula');
        res.json(result.recordset);
    } catch (err) {
        console.error(err);
        res.status(500).send('Error obteniendo historial colaborador');
    }
};

const getHistorialActivo = async (req, res) => {
    const { id } = req.params; // ID Activo
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('ID_Activo', mssql.Int, id)
            .query('EXEC SP_GET_Historial_Activo @ID_Activo');
        res.json(result.recordset);
    } catch (err) {
        console.error(err);
        res.status(500).send('Error obteniendo historial activo');
    }
};

export default { getHistorialColaborador, getHistorialActivo };


==================================================================
ARCHIVO: backend\controllers\indicatorController.js
==================================================================
// backend/src/controllers/indicatorController.js

import { poolPromise, mssql } from '../config/dbConfig.js';

const guardarIndicador = async (req, res) => {
    const { 
        nombreIndicador, mes, anio, 
        constante, meta, analisis,
        resultadoCalculado 
    } = req.body;
    
    try {
        const valConstante = parseInt(constante) || 100;
        const valMeta = parseFloat(meta) || 0;
        const valResultado = (resultadoCalculado !== undefined && resultadoCalculado !== null) ? parseFloat(resultadoCalculado) : 0;

        const pool = await poolPromise;
        
        await pool.request()
            .input('nombreIndicador', mssql.NVarChar, nombreIndicador)
            .input('mes', mssql.Int, parseInt(mes))
            .input('anio', mssql.Int, parseInt(anio))
            .input('constante', mssql.Int, valConstante)
            .input('meta', mssql.Decimal(18, 2), valMeta)
            .input('analisis', mssql.NVarChar, analisis || '')
            .input('resultadoManual', mssql.Decimal(18, 4), valResultado)
            .input('numerador', mssql.Decimal(18, 2), 0)
            .input('denominador', mssql.Decimal(18, 2), 1)
            .query('EXEC SP_SAVE_Indicador @nombreIndicador, @mes, @anio, @constante, @meta, @analisis, @resultadoManual, @numerador, @denominador');

        res.json({ msg: 'Indicador guardado exitosamente' });

    } catch (err) {
        console.error('Error en guardarIndicador:', err.message);
        
        // Si el error viene del SP (RAISERROR), lo enviamos como 400 Bad Request
        if (err.message.includes('Ya existe un registro ACTIVO')) {
            return res.status(400).json({ msg: err.message });
        }

        res.status(500).send('Error del servidor: ' + err.message);
    }
};

const getIndicadoresAnuales = async (req, res) => {
    const { anio } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request().input('anio', mssql.Int, anio).query('EXEC SP_GET_IndicadoresAnuales @anio');
        res.json(result.recordset);
    } catch (err) {
        console.error(err);
        res.status(500).send('Error del servidor');
    }
};

const getConfiguraciones = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_ConfigIndicadores');
        res.json(result.recordset);
    } catch (err) {
        console.error(err);
        res.status(500).send('Error obteniendo configuraciones');
    }
};

const crearConfiguracion = async (req, res) => {
    const { nombre, tipo, constante, meta, frecuencia, grafica, operador, formula, variables } = req.body;
    try {
        const pool = await poolPromise;
        const jsonVariables = variables ? JSON.stringify(variables) : null;

        await pool.request()
            .input('NombreIndicador', mssql.NVarChar, nombre)
            .input('Tipo', mssql.NVarChar, tipo)
            .input('Constante', mssql.Int, constante)
            .input('MetaDefault', mssql.Decimal(10,2), meta)
            .input('Frecuencia', mssql.NVarChar, frecuencia || 'Mensual')
            .input('TipoGrafica', mssql.NVarChar, grafica || 'Bar')
            .input('OperadorMeta', mssql.NVarChar, operador || '>=')
            .input('FormulaCalculo', mssql.NVarChar, formula || null)
            .input('VariablesJSON', mssql.NVarChar(mssql.MAX), jsonVariables)
            .query('EXEC SP_CREATE_ConfigIndicador @NombreIndicador, @Tipo, @Constante, @MetaDefault, @Frecuencia, @TipoGrafica, @OperadorMeta, @FormulaCalculo, @VariablesJSON');
        
        res.json({ msg: 'Indicador configurado correctamente' });
    } catch (err) {
        console.error(err);
        if(err.message.includes('UNIQUE')) return res.status(400).json({msg: 'Ya existe un indicador con ese nombre'});
        res.status(500).send('Error creando configuraci√≥n');
    }
};

const editarConfiguracion = async (req, res) => {
    const { id } = req.params;
    const { nombre, tipo, constante, meta, frecuencia, grafica, operador, formula, variables } = req.body;
    try {
        const valConstante = (constante === '' || constante === undefined || constante === null) ? 100 : parseInt(constante);
        const valMeta = (meta === '' || meta === undefined || meta === null) ? 0 : parseFloat(meta);

        const pool = await poolPromise;
        const jsonVariables = variables ? JSON.stringify(variables) : null;

        await pool.request()
            .input('ID_Config', mssql.Int, id)
            .input('NombreIndicador', mssql.NVarChar, nombre)
            .input('Tipo', mssql.NVarChar, tipo)
            .input('Constante', mssql.Int, valConstante)
            .input('MetaDefault', mssql.Decimal(10,2), valMeta)
            .input('Frecuencia', mssql.NVarChar, frecuencia || 'Mensual') 
            .input('TipoGrafica', mssql.NVarChar, grafica || 'Bar')
            .input('OperadorMeta', mssql.NVarChar, operador || '>=')
            .input('FormulaCalculo', mssql.NVarChar, formula || null)
            .input('VariablesJSON', mssql.NVarChar(mssql.MAX), jsonVariables)
            .query('EXEC SP_UPDATE_ConfigIndicador @ID_Config, @NombreIndicador, @Tipo, @Constante, @MetaDefault, @Frecuencia, @TipoGrafica, @OperadorMeta, @FormulaCalculo, @VariablesJSON');
        
        res.json({ msg: 'Indicador actualizado correctamente' });
    } catch (err) {
        console.error("Error backend update:", err);
        res.status(500).send('Error actualizando configuraci√≥n: ' + err.message);
    }
};

const eliminarConfiguracion = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        await pool.request().input('ID_Config', mssql.Int, id).query('EXEC SP_DELETE_ConfigIndicador @ID_Config');
        res.json({ msg: 'Indicador inactivado del sistema' });
    } catch (err) {
        console.error(err);
        res.status(500).send('Error eliminando configuraci√≥n');
    }
};

const eliminarRegistro = async (req, res) => {
    const { id } = req.params; 
    try {
        const pool = await poolPromise;
        await pool.request().input('ID_Indicador', mssql.Int, id).query('EXEC SP_DELETE_IndicadorRegistro @ID_Indicador');
        res.json({ msg: 'Registro inactivado correctamente' });
    } catch (err) {
        console.error(err);
        res.status(500).send('Error eliminando registro');
    }
};

const indicatorController = {
    guardarIndicador,
    getIndicadoresAnuales,
    getConfiguraciones,
    crearConfiguracion,
    editarConfiguracion,
    eliminarConfiguracion,
    eliminarRegistro
};

export default indicatorController;


==================================================================
ARCHIVO: backend\controllers\inspectionController.js
==================================================================
// backend/src/controllers/inspectionController.js

import { validationResult } from 'express-validator';
import { poolPromise, mssql } from '../config/dbConfig.js';
import { logAction } from '../services/logService.js';

// --- CREAR INSPECCI√ìN (Diligenciar) ---
const crearInspeccion = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) return res.status(400).json({ errors: errors.array() });

    const { idFormulario, idActivoInspeccionado, datosDiligenciados, observacionesGenerales, resultadoGeneral } = req.body;
    const idUsuarioRealizo = req.usuario.id;

    try {
        const pool = await poolPromise;
        let datosJsonString = typeof datosDiligenciados === 'object' ? JSON.stringify(datosDiligenciados) : datosDiligenciados;

        await pool.request()
            .input('idFormulario', mssql.NVarChar, idFormulario)
            .input('idActivoInspeccionado', mssql.Int, idActivoInspeccionado || null)
            .input('idUsuarioRealizo', mssql.Int, idUsuarioRealizo)
            .input('datosDiligenciados', mssql.NVarChar(mssql.MAX), datosJsonString)
            .input('observacionesGenerales', mssql.NVarChar(mssql.MAX), observacionesGenerales || null)
            .input('resultadoGeneral', mssql.NVarChar, resultadoGeneral)
            .query('EXEC SP_CREATE_Inspeccion @idFormulario, @idActivoInspeccionado, @idUsuarioRealizo, @datosDiligenciados, @observacionesGenerales, @resultadoGeneral');

        await logAction(req.usuario.id, req.usuario.nombre, 'DILIGENCIAR_INSPECCION', `Diligenci√≥ formulario '${idFormulario}'.`);
        res.status(201).json({ msg: 'Inspecci√≥n registrada exitosamente' });
    } catch (err) {
        console.error('Error en crearInspeccion:', err.message);
        res.status(500).json({ msg: 'Error del servidor' });
    }
};

// --- OBTENER HISTORIAL ---
const getInspeccionesHistorial = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_InspeccionesHistorial');
        res.json(result.recordset);
    } catch (err) {
        console.error(err);
        res.status(500).json({ msg: 'Error del servidor' });
    }
};

// --- OBTENER DETALLE (CORREGIDO: Validaci√≥n de ID) ---
const getInspeccionDetalle = async (req, res) => {
    const { id } = req.params;

    // 1. Validar que sea un n√∫mero antes de llamar a SQL
    const idNumerico = parseInt(id);
    if (isNaN(idNumerico)) {
        console.warn(`Intento de obtener detalle con ID inv√°lido: ${id}`);
        return res.status(400).json({ msg: 'ID de inspecci√≥n inv√°lido' });
    }

    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idInspeccion', mssql.Int, idNumerico) // Usamos el valor validado
            .query('EXEC SP_GET_InspeccionDetalle @idInspeccion');
        
        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Inspecci√≥n no encontrada' });
        }
        res.json(result.recordset[0]);
    } catch (err) {
        console.error('Error en getInspeccionDetalle:', err.message);
        res.status(500).json({ msg: 'Error del servidor' });
    }
};

// --- CREAR NUEVO FORMULARIO (Estructura) ---
const crearNuevoFormulario = async (req, res) => {
    const { idFormulario, nombreFormulario, descripcion, tipoActivoAsociado, preguntas, categoria, visibleColaborador } = req.body;
    try {
        const pool = await poolPromise;
        const jsonPreguntas = JSON.stringify(preguntas);
        
        await pool.request()
            .input('idFormulario', mssql.NVarChar, idFormulario)
            .input('nombreFormulario', mssql.NVarChar, nombreFormulario)
            .input('descripcion', mssql.NVarChar, descripcion)
            .input('tipoActivoAsociado', mssql.NVarChar, tipoActivoAsociado)
            .input('jsonPreguntas', mssql.NVarChar(mssql.MAX), jsonPreguntas)
            .input('categoria', mssql.NVarChar, categoria || 'General')
            .input('visibleColaborador', mssql.Bit, visibleColaborador ? 1 : 0)
            .query('EXEC SP_CREATE_NuevoFormulario @idFormulario, @nombreFormulario, @descripcion, @tipoActivoAsociado, @jsonPreguntas, @categoria, @visibleColaborador');
        
        await logAction(req.usuario.id, req.usuario.nombre, 'CREAR_FORMULARIO', `Cre√≥ el formulario '${nombreFormulario}'`);
        res.status(201).json({ msg: 'Formulario creado exitosamente' });
    } catch (err) {
        console.error('Error en crearNuevoFormulario:', err.message);
        if (err.message.includes('El c√≥digo del formulario ya existe')) return res.status(400).json({ msg: err.message });
        res.status(500).json({ msg: 'Error del servidor' });
    }
};

// --- OBTENER LISTA DE FORMULARIOS ---
const getFormularios = async (req, res) => {
    try {
        const pool = await poolPromise;
        // Este SP ahora filtra por Estado = 'Activo'
        const result = await pool.request().query('EXEC SP_GET_Formularios');
        res.json(result.recordset);
    } catch (err) {
        console.error(err);
        res.status(500).json({ msg: 'Error del servidor' });
    }
};

// --- OBTENER PREGUNTAS ---
const getPreguntasFormulario = async (req, res) => {
    const { idFormulario } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idFormulario', mssql.NVarChar, idFormulario)
            .query('EXEC SP_GET_PreguntasPorFormulario @idFormulario');
        res.json(result.recordset);
    } catch (err) {
        console.error(err);
        res.status(500).json({ msg: 'Error del servidor' });
    }
};

// --- AGREGAR PREGUNTA ---
const agregarPregunta = async (req, res) => {
    const { id: idFormulario } = req.params;
    const { textoPregunta } = req.body;
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idFormulario', mssql.NVarChar, idFormulario)
            .input('textoPregunta', mssql.NVarChar, textoPregunta)
            .query('EXEC SP_ADD_Pregunta @idFormulario, @textoPregunta');
        res.status(201).json({ msg: 'Pregunta agregada' });
    } catch (err) {
        console.error(err);
        res.status(500).json({ msg: 'Error del servidor' });
    }
};

// --- ELIMINAR PREGUNTA ---
const eliminarPregunta = async (req, res) => {
    const { id: idPregunta } = req.params;
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idPregunta', mssql.Int, idPregunta)
            .query('EXEC SP_DELETE_Pregunta @idPregunta');
        res.json({ msg: 'Pregunta eliminada' });
    } catch (err) {
        if (err.message.includes('ya ha sido respondida')) return res.status(400).json({ msg: err.message });
        console.error(err);
        res.status(500).json({ msg: 'Error del servidor' });
    }
};

// --- CAMBIAR VISIBILIDAD ---
const toggleVisibilidad = async (req, res) => {
    const { id } = req.params;
    const { visible } = req.body;
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idFormulario', mssql.NVarChar, id)
            .input('visible', mssql.Bit, visible ? 1 : 0)
            .query('EXEC SP_UPDATE_Formulario_Visibilidad @idFormulario, @visible');
        res.json({ msg: 'Visibilidad actualizada' });
    } catch (err) {
        console.error(err);
        res.status(500).json({ msg: 'Error del servidor' });
    }
};

// --- NUEVO: EDITAR FORMULARIO ---
const editarFormulario = async (req, res) => {
    const { id: idFormulario } = req.params;
    const { nombreFormulario, descripcion, tipoActivoAsociado, categoria, visibleColaborador } = req.body;

    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idFormulario', mssql.NVarChar, idFormulario)
            .input('nombreFormulario', mssql.NVarChar, nombreFormulario)
            .input('descripcion', mssql.NVarChar, descripcion)
            .input('tipoActivoAsociado', mssql.NVarChar, tipoActivoAsociado)
            .input('categoria', mssql.NVarChar, categoria)
            .input('visibleColaborador', mssql.Bit, visibleColaborador ? 1 : 0)
            .query('EXEC SP_UPDATE_Formulario @idFormulario, @nombreFormulario, @descripcion, @tipoActivoAsociado, @categoria, @visibleColaborador');

        await logAction(req.usuario.id, req.usuario.nombre, 'EDITAR_FORMULARIO', `Edit√≥ el formulario '${nombreFormulario}'`);
        res.json({ msg: 'Formulario actualizado exitosamente' });
    } catch (err) {
        console.error('Error en editarFormulario:', err.message);
        res.status(500).json({ msg: 'Error del servidor' });
    }
};

// --- NUEVO: ELIMINAR FORMULARIO ---
const eliminarFormulario = async (req, res) => {
    const { id: idFormulario } = req.params;
    try {
        const pool = await poolPromise;
        
        // Verificar existencia para el log
        const check = await pool.request().input('id', mssql.NVarChar, idFormulario).query("SELECT NombreFormulario FROM FormulariosInspeccion WHERE ID_Formulario = @id");
        const nombre = check.recordset[0]?.NombreFormulario || idFormulario;

        await pool.request()
            .input('idFormulario', mssql.NVarChar, idFormulario)
            .query('EXEC SP_DELETE_Formulario @idFormulario');

        await logAction(req.usuario.id, req.usuario.nombre, 'ELIMINAR_FORMULARIO', `Elimin√≥ (inactiv√≥) el formulario '${nombre}'`);
        res.json({ msg: 'Formulario eliminado exitosamente' });

    } catch (err) {
        if (err.message.includes('ya tiene inspecciones asociadas')) {
            return res.status(400).json({ msg: err.message });
        }
        console.error('Error en eliminarFormulario:', err.message);
        res.status(500).json({ msg: 'Error del servidor' });
    }
};

// --- NUEVO: OBTENER TIPOS DE ACTIVOS √öNICOS ---
const getTiposUnicos = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_TiposActivosUnicos');
        const tipos = result.recordset.map(row => row.TipoActivo);
        res.json(tipos);
    } catch (err) {
        console.error(err);
        res.status(500).json({ msg: 'Error del servidor' });
    }
};

const inspectionController = {
    crearInspeccion,
    getInspeccionesHistorial,
    getInspeccionDetalle,
    crearNuevoFormulario,
    getFormularios,
    getPreguntasFormulario,
    agregarPregunta,
    eliminarPregunta,
    toggleVisibilidad,
    editarFormulario,
    eliminarFormulario,
    getTiposUnicos
};

export default inspectionController;


==================================================================
ARCHIVO: backend\controllers\logController.js
==================================================================
// backend/src/controllers/logController.js

import { poolPromise, mssql } from '../config/dbConfig.js';

/**
 * @controller  getLogs
 * @desc        Obtiene la lista de todos los registros de auditor√≠a (filtrados)
 */
const getLogs = async (req, res) => {
    // Los filtros ahora vienen en el body
    const { idUsuario, accion, fechaInicio, fechaFin } = req.body;

    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idUsuario', mssql.Int, idUsuario || null)
            .input('accion', mssql.NVarChar(100), accion || null)
            .input('fechaInicio', mssql.Date, fechaInicio || null)
            .input('fechaFin', mssql.Date, fechaFin || null)
            .query('EXEC SP_GET_AuditLog @idUsuario, @accion, @fechaInicio, @fechaFin');
        
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getLogs:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  getLogFiltros
 * @desc        Obtiene las listas de usuarios y acciones para los filtros
 */
const getLogFiltros = async (req, res) => {
    try {
        const pool = await poolPromise;
        // El SP devuelve 2 tablas: [0] = Usuarios, [1] = Acciones
        const result = await pool.request().query('EXEC SP_GET_AuditLog_Filtros');
        
        res.json({
            usuarios: result.recordsets[0] || [],
            acciones: result.recordsets[1] || []
        });
    } catch (err) {
        console.error('Error en getLogFiltros:', err.message);
        res.status(500).send('Error del servidor');
    }
};


const logController = {
    getLogs,
    getLogFiltros // <-- A√ëADIDO
};

export default logController;


==================================================================
ARCHIVO: backend\controllers\medicalController.js
==================================================================
// backend/controllers/medicalController.js

import { validationResult } from 'express-validator';
import { poolPromise, mssql } from '../config/dbConfig.js';
import PDFDocument from 'pdfkit';
import path from 'path';
import { fileURLToPath } from 'url';
import fs from 'fs'; // Aseg√∫rate de importar fs
import { logAction } from '../services/logService.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// --- OBTENER HISTORIAL ---
const getHistorialExamenes = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_ExamenesHistorial');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getHistorialExamenes:', err.message);
        res.status(500).send('Error del servidor');
    }
};

// --- CREAR EXAMEN ---
const crearExamenMedico = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) return res.status(400).json({ errors: errors.array() });

    const {
        idUsuarioColaborador, nombreColaborador, cedulaColaborador,
        tipoExamen, fechaExamen, conceptoAptitud,
        recomendacionesGenerales, observaciones, recomendacionesOcupacionales, 
        medicoEspecialista, entidadEmite, resumenCaso, compromisos,
        fechaFinRecomendaciones 
    } = req.body;
    
    const idUsuarioAdminRegistra = req.usuario.id;

    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idUsuarioColaborador', mssql.Int, idUsuarioColaborador || null)
            .input('idUsuarioAdminRegistra', mssql.Int, idUsuarioAdminRegistra)
            .input('nombreColaborador', mssql.NVarChar, nombreColaborador)
            .input('cedulaColaborador', mssql.NVarChar, cedulaColaborador)
            .input('tipoExamen', mssql.NVarChar, tipoExamen)
            .input('fechaExamen', mssql.Date, fechaExamen)
            .input('conceptoAptitud', mssql.NVarChar, conceptoAptitud)
            .input('recomendacionesGenerales', mssql.NVarChar, recomendacionesGenerales || null)
            .input('observaciones', mssql.NVarChar, observaciones || null)
            .input('recomendacionesOcupacionales', mssql.NVarChar, recomendacionesOcupacionales || null)
            .input('medicoEspecialista', mssql.NVarChar, medicoEspecialista || null)
            .input('entidadEmite', mssql.NVarChar, entidadEmite || null)
            .input('resumenCaso', mssql.NVarChar, resumenCaso || null)
            .input('compromisos', mssql.NVarChar, compromisos || null)
            .input('fechaFinRecomendaciones', mssql.Date, fechaFinRecomendaciones || null)
            .query('EXEC SP_CREATE_ExamenMedico @idUsuarioColaborador, @idUsuarioAdminRegistra, @tipoExamen, @fechaExamen, @conceptoAptitud, @recomendacionesGenerales, @observaciones, @recomendacionesOcupacionales, @medicoEspecialista, @entidadEmite, @fechaFinRecomendaciones, @resumenCaso, @compromisos, @nombreColaborador, @cedulaColaborador');

        await logAction(req.usuario.id, req.usuario.nombre, 'CREAR_EXAMEN', `Registr√≥ examen para: ${nombreColaborador}`);
        res.status(201).json({ msg: 'Examen m√©dico registrado exitosamente' });
    } catch (err) {
        console.error('Error en crearExamenMedico:', err.message);
        res.status(500).send('Error del servidor');
    }
};

// --- OBTENER DETALLE ---
const getExamenMedicoDetalle = async (req, res) => {
    const { id: idExamenMedico } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idExamenMedico', mssql.Int, idExamenMedico)
            .query('EXEC SP_GET_ExamenMedicoDetalle @idExamenMedico');
        if (result.recordset.length === 0) return res.status(404).json({ msg: 'Examen m√©dico no encontrado' });
        res.json(result.recordset[0]);
    } catch (err) {
        console.error('Error en getExamenMedicoDetalle:', err.message);
        res.status(500).send('Error del servidor');
    }
};

// --- GENERAR PDF CON NUEVO ENCABEZADO (ACTUALIZADO) ---
const generarPdfRecomendaciones = async (req, res) => {
    const { id } = req.params;
    
    // Recibimos los datos del encabezado desde el body (POST)
    const { codigo, version, fechaEmision, fechaRevision } = req.body;

    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idExamenMedico', mssql.Int, id)
            .query('EXEC SP_GET_ExamenMedicoDetalle @idExamenMedico');

        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Examen m√©dico no encontrado' });
        }

        const data = result.recordset[0];
        
        // Configuraci√≥n Documento
        const doc = new PDFDocument({ margin: 40, size: 'LETTER', bufferPages: true }); // Margen ajustado a 40 para coincidir
        const filename = `Recomendaciones-${data.CedulaColaborador || 'NA'}.pdf`;
        
        // Headers para descarga directa
        res.setHeader('Content-Type', 'application/pdf');
        res.setHeader('Content-Disposition', `attachment; filename="${filename}"`);
        doc.pipe(res);

        const fontBold = 'Helvetica-Bold';
        const fontReg = 'Helvetica';
        const black = '#000000';

        // ==========================================
        // 1. ENCABEZADO ESTRUCTURADO (TABLA)
        // ==========================================
        const startY = 40; 
        const startX = 40;
        const col1W = 100; // Logo
        const col2W = 280; // T√≠tulo
        const col3W = 150; // Datos Control
        const hHeader = 70;

        // Bordes Tabla
        doc.rect(startX, startY, col1W + col2W + col3W, hHeader).stroke();
        doc.moveTo(startX + col1W, startY).lineTo(startX + col1W, startY + hHeader).stroke();
        doc.moveTo(startX + col1W + col2W, startY).lineTo(startX + col1W + col2W, startY + hHeader).stroke();
        
        const rowH = hHeader / 4;
        doc.moveTo(startX + col1W + col2W, startY + rowH).lineTo(startX + col1W + col2W + col3W, startY + rowH).stroke();
        doc.moveTo(startX + col1W + col2W, startY + rowH * 2).lineTo(startX + col1W + col2W + col3W, startY + rowH * 2).stroke();
        doc.moveTo(startX + col1W + col2W, startY + rowH * 3).lineTo(startX + col1W + col2W + col3W, startY + rowH * 3).stroke();

        // --- LOGO ---
        const logoPath = path.resolve(__dirname, '..', 'assets', 'logo.png');
        if (fs.existsSync(logoPath)) {
            try { doc.image(logoPath, startX + 10, startY + 4, { width: 80 }); } 
            catch (e) { console.warn('Logo error', e); }
        }

        // --- T√çTULO CENTRAL ---
        // T√≠tulo Principal del Sistema
        doc.font(fontBold).fontSize(10).fillColor(black)
           .text('SISTEMA DE GESTI√ìN DE SEGURIDAD Y SALUD EN EL TRABAJO (SG-SST)', startX + col1W, startY + 18, { width: col2W, align: 'center' });
        
        // T√≠tulo del Documento Espec√≠fico
        doc.font(fontBold).fontSize(10)
           .text('ACTA DE NOTIFICACI√ìN DE RECOMENDACIONES M√âDICAS', startX + col1W, startY + 42, { width: col2W, align: 'center' });

        // --- DATOS DE CONTROL (DERECHA) ---
        doc.font(fontBold).fontSize(8);
        doc.text(`C√ìDIGO: ${codigo || 'SST-FTO-001'}`, startX + col1W + col2W + 5, startY + 7);
        doc.text(`FECHA EMISI√ìN: ${fechaEmision || ''}`, startX + col1W + col2W + 5, startY + rowH + 7);
        doc.text(`FECHA REVISI√ìN: ${fechaRevision || ''}`, startX + col1W + col2W + 5, startY + (rowH * 2) + 7);
        doc.text(`VERSI√ìN: ${version || '1'}`, startX + col1W + col2W + 5, startY + (rowH * 3) + 7);

        // ==========================================
        // 2. CUERPO DEL DOCUMENTO
        // ==========================================
        
        // Resetear cursor debajo del encabezado
        doc.x = startX;
        doc.y = startY + hHeader + 40;
        
        const contentWidth = 530; // Ancho √∫til

        const seccion = (titulo) => {
            doc.moveDown(1);
            doc.font(fontBold).fontSize(11).fillColor(black)
                .text(titulo.toUpperCase());
            doc.moveDown(0.4);
            doc.font(fontReg).fontSize(10).fillColor(black);
        };

        // --- DATOS DEL COLABORADOR ---
        doc.font(fontBold).text("DATOS GENERALES:", { underline: true });
        doc.moveDown(0.5);
        
        const fechaExamenStr = data.FechaExamen ? new Date(data.FechaExamen).toLocaleDateString('es-CO', { timeZone: 'UTC' }) : 'N/A';
        let fechaFinStr = 'Indefinida / No aplica';
        if (data.FechaFinRecomendaciones) {
            fechaFinStr = new Date(data.FechaFinRecomendaciones).toLocaleDateString('es-CO', { timeZone: 'UTC' });
        }

        // Tabla visual simulada con tabulaciones
        doc.font(fontBold).fontSize(10);
        doc.text(`Nombre: `, { continued: true }); doc.font(fontReg).text(data.NombreColaborador);
        doc.font(fontBold).text(`C√©dula: `, { continued: true }); doc.font(fontReg).text(data.CedulaColaborador);
        doc.font(fontBold).text(`Fecha del Examen: `, { continued: true }); doc.font(fontReg).text(fechaExamenStr);
        doc.font(fontBold).text(`Tipo de Examen: `, { continued: true }); doc.font(fontReg).text(data.TipoExamen);
        doc.font(fontBold).text(`Concepto: `, { continued: true }); doc.font(fontReg).text(data.ConceptoAptitud);
        
        doc.moveDown(0.5);
        doc.font(fontBold).text(`M√©dico Emisor: `, { continued: true }); doc.font(fontReg).text(data.MedicoEspecialista || 'No registra');
        doc.font(fontBold).text(`Entidad (EPS/ARL): `, { continued: true }); doc.font(fontReg).text(data.EntidadEmite || 'No registra');
        doc.font(fontBold).text(`Vigencia Recomendaciones: `, { continued: true }); doc.font(fontReg).text(fechaFinStr);

        seccion("Temas tratados: breve resumen del caso");
        doc.text(data.ResumenCaso || 'No se registr√≥ un resumen del caso.', { width: contentWidth, align: 'justify' });

        seccion("Ampliaci√≥n de las recomendaciones m√©dicas (no ocupacionales)");
        doc.text(data.RecomendacionesGenerales || 'Sin recomendaciones m√©dicas generales.', { width: contentWidth, align: 'justify' });

        seccion("Recomendaciones ocupacionales (para el trabajo)");
        doc.text(data.RecomendacionesOcupacionales || 'Sin recomendaciones ocupacionales espec√≠ficas.', { width: contentWidth, align: 'justify' });

        seccion("Compromisos");
        doc.text(data.Compromisos || 'Sin compromisos registrados.', { width: contentWidth, align: 'justify' });

        // === FIRMAS ===
        if (doc.y > 600) doc.addPage(); 

        doc.moveDown(4);
        seccion("En constancia de lo anterior se firma por parte de los asistentes:");
        doc.moveDown(3);
        doc.font(fontReg).fontSize(10);
        
        doc.text('___________________________________');
        doc.text('Nombre:');
        doc.text('Cargo/Empresa:');
        doc.text('N¬∞ Identificaci√≥n:');
        doc.text('Firma:');

        // === NUMERACI√ìN DE P√ÅGINAS ===
        const range = doc.bufferedPageRange();
        const totalPages = range.count;

        for (let i = 0; i < totalPages; i++) {
            doc.switchToPage(i);
            doc.fontSize(8).fillColor('#6c757d')
               .text(`P√°gina ${i + 1} de ${totalPages}`, 0, 730, { align: 'center', width: 612 });
        }
        
        doc.end();

    } catch (err) {
        console.error('Error en generarPdfRecomendaciones:', err.message);
        if (!res.headersSent) {
            res.status(500).send('Error del servidor al generar el PDF');
        }
    }
};

const medicalController = {
    getHistorialExamenes,
    crearExamenMedico,
    getExamenMedicoDetalle, 
    generarPdfRecomendaciones
};

export default medicalController;


==================================================================
ARCHIVO: backend\controllers\notificationController.js
==================================================================
// backend/controllers/notificationController.js
import { poolPromise, mssql } from '../config/dbConfig.js';

const getMisNotificaciones = async (req, res) => {
    const { id, rol } = req.usuario;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idUsuario', mssql.Int, id)
            .input('rolUsuario', mssql.NVarChar, rol)
            .query('EXEC SP_GET_MisNotificaciones @idUsuario, @rolUsuario');
        res.json(result.recordset);
    } catch (err) {
        console.error(err);
        res.status(500).send('Error al obtener notificaciones');
    }
};

const marcarLeida = async (req, res) => {
    const { id } = req.params; 
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idNotificacion', mssql.Int, id)
            .query('EXEC SP_MARK_NotificacionLeida @idNotificacion');
        res.json({ msg: 'Le√≠da' });
    } catch (err) {
        console.error(err);
        res.status(500).send('Error');
    }
};

// --- NUEVA FUNCI√ìN: OCULTAR (SOFT DELETE) ---
const ocultarNotificacion = async (req, res) => {
    const { id } = req.params; 
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idNotificacion', mssql.Int, id)
            .query('EXEC SP_HIDE_Notificacion @idNotificacion');
        res.json({ msg: 'Notificaci√≥n eliminada de la vista' });
    } catch (err) {
        console.error(err);
        res.status(500).send('Error');
    }
};

export default { getMisNotificaciones, marcarLeida, ocultarNotificacion };


==================================================================
ARCHIVO: backend\controllers\pesvController.js
==================================================================
// backend/controllers/pesvController.js

import { poolPromise, mssql } from '../config/dbConfig.js';
import { generarActaPDF } from '../utils/pdfGenerator.js';
import { obtenerConductoresGosen } from '../services/externalApiService.js'; 
import path from 'path';
import { fileURLToPath } from 'url';
import fs from 'fs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ==========================================
// 1. GESTI√ìN DE ARCHIVOS Y EVIDENCIAS
// ==========================================

const descargarArchivo = (req, res) => {
    const { filename } = req.params;
    const rutaArchivo = path.join(__dirname, '../uploads', filename);
    if (fs.existsSync(rutaArchivo)) {
        res.download(rutaArchivo); 
    } else {
        res.status(404).send('Archivo no encontrado');
    }
};

const getDocumentosGenerados = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_DocumentosInternos');
        res.json(result.recordset);
    } catch (err) { console.error(err); res.status(500).send('Error al obtener documentos internos'); }
};

const reemplazarEvidencia = async (req, res) => {
    const { idEvidencia } = req.body;
    const nuevoArchivo = req.file;

    if (!nuevoArchivo) return res.status(400).json({ msg: 'No se subi√≥ archivo' });

    try {
        const nombreArchivo = nuevoArchivo.originalname;
        const rutaArchivo = nuevoArchivo.path.replace(/\\/g, '/'); // Normalizar ruta

        const pool = await poolPromise;
        await pool.request()
            .input('idEvidencia', mssql.Int, idEvidencia)
            .input('nombreArchivo', mssql.NVarChar, nombreArchivo)
            .input('rutaArchivo', mssql.NVarChar, rutaArchivo)
            .query('EXEC SP_UPDATE_Evidencia_Archivo @idEvidencia, @nombreArchivo, @rutaArchivo');

        res.json({ msg: 'Evidencia actualizada correctamente' });
    } catch (err) {
        console.error(err);
        res.status(500).send('Error reemplazando evidencia');
    }
};

// ==========================================
// 2. GESTI√ìN DE CONDUCTORES (INTEGRACI√ìN)
// ==========================================

const getConductoresPESV = async (req, res) => {
    try {
        // A. Obtener listado maestro de la API Externa (Gosen)
        const conductoresExternos = await obtenerConductoresGosen();

        // B. Obtener datos locales
        const pool = await poolPromise;
        const resultLocal = await pool.request().query('EXEC SP_GET_ConductoresPESV');
        const conductoresLocales = resultLocal.recordset;

        // C. Cruzar informaci√≥n
        const listaUnificada = conductoresExternos.map(externo => {
            const cedulaExterna = String(externo.Cedula).trim();
            const localData = conductoresLocales.find(local => 
                String(local.CedulaUsuario).trim() === cedulaExterna
            );

            if (localData) {
                // EXISTE LOCALMENTE
                return {
                    NombreCompleto: externo.NombreCompleto,
                    CedulaUsuario: externo.Cedula,
                    Cargo: externo.CargoNombre || localData.Cargo, 
                    ID_Usuario: localData.ID_Usuario, 
                    NumeroLicencia: localData.NumeroLicencia,
                    Categoria: localData.Categoria,
                    VencimientoLicencia: localData.VencimientoLicencia,
                    RutaLicencia: localData.RutaLicencia, 
                    EstadoRegistro: 'Registrado',
                    OrigenDatos: 'Local + Gosen'
                };
            } else {
                // SOLO EN GOSEN
                return {
                    NombreCompleto: externo.NombreCompleto,
                    CedulaUsuario: externo.Cedula,
                    Cargo: externo.CargoNombre,
                    ID_Usuario: null, 
                    NumeroLicencia: null,
                    Categoria: null,
                    VencimientoLicencia: null,
                    RutaLicencia: null,
                    EstadoRegistro: 'Pendiente',
                    OrigenDatos: 'Solo Gosen'
                };
            }
        });

        res.json(listaUnificada);

    } catch (err) { 
        console.error("Error en getConductoresPESV:", err); 
        res.status(500).send('Error obteniendo listado de conductores'); 
    }
};

const guardarInfoConductor = async (req, res) => {
    const { idUsuario, numeroLicencia, categoria, vencimiento } = req.body;
    const archivoLicencia = req.file ? req.file.path.replace(/\\/g, '/') : null;
    
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idUsuario', mssql.Int, idUsuario)
            .input('numeroLicencia', mssql.NVarChar, numeroLicencia)
            .input('categoria', mssql.NVarChar, categoria)
            .input('vencimiento', mssql.Date, vencimiento)
            .input('rutaLicencia', mssql.NVarChar, archivoLicencia)
            .query('EXEC SP_SAVE_InfoConductor @idUsuario, @numeroLicencia, @categoria, @vencimiento, @rutaLicencia');
        
        res.json({ msg: 'Informaci√≥n del conductor actualizada exitosamente' });
    } catch (err) { 
        console.error(err); 
        res.status(500).send('Error guardando informaci√≥n del conductor'); 
    }
};

// ==========================================
// 3. GESTI√ìN DE MANTENIMIENTOS
// ==========================================

const crearMantenimiento = async (req, res) => {
    const { idActivo, tipo, fecha, kilometraje, descripcion, taller, costo } = req.body;
    const archivoEvidencia = req.file ? req.file.path.replace(/\\/g, '/') : null;

    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idActivo', mssql.Int, idActivo)
            .input('tipo', mssql.NVarChar, tipo)
            .input('fecha', mssql.Date, fecha)
            .input('kilometraje', mssql.Int, kilometraje)
            .input('descripcion', mssql.NVarChar, descripcion)
            .input('taller', mssql.NVarChar, taller)
            .input('costo', mssql.Decimal(18, 2), costo)
            .input('rutaEvidencia', mssql.NVarChar, archivoEvidencia)
            .query('EXEC SP_CREATE_Mantenimiento @idActivo, @tipo, @fecha, @kilometraje, @descripcion, @taller, @costo, @rutaEvidencia');
        
        res.json({ msg: 'Mantenimiento registrado correctamente' });
    } catch (err) { 
        console.error(err); 
        res.status(500).send('Error registrando mantenimiento'); 
    }
};

const getMantenimientos = async (req, res) => {
    const { idActivo } = req.query; 
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idActivo', mssql.Int, idActivo || null)
            .query('EXEC SP_GET_Mantenimientos @idActivo');
        res.json(result.recordset);
    } catch (err) { console.error(err); res.status(500).send('Error obteniendo mantenimientos'); }
};

// ==========================================
// 4. GESTI√ìN DE PASOS PHVA
// ==========================================

const getPasosPESV = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_PasosPESV');
        res.json(result.recordset);
    } catch (err) { console.error(err); res.status(500).send('Error obteniendo pasos'); }
};

const getEvidenciasPorPaso = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idPaso', mssql.Int, id)
            .query('EXEC SP_GET_Evidencias_Por_Paso @idPaso');
        res.json(result.recordset);
    } catch (err) { console.error(err); res.status(500).send('Error obteniendo evidencias'); }
};

const actualizarPasoPESV = async (req, res) => {
    const { idPaso, estado } = req.body;
    const archivoEvidencia = req.file; 
    try {
        const pool = await poolPromise;
        const request = pool.request()
            .input('idPaso', mssql.Int, idPaso)
            .input('estado', mssql.NVarChar, estado);
        
        if (archivoEvidencia) {
            request.input('nombreArchivo', mssql.NVarChar, archivoEvidencia.originalname);
            request.input('rutaArchivo', mssql.NVarChar, archivoEvidencia.path.replace(/\\/g, '/'));
        } else {
            request.input('nombreArchivo', mssql.NVarChar, null);
            request.input('rutaArchivo', mssql.NVarChar, null);
        }
        
        await request.query('EXEC SP_UPDATE_PasoPESV @idPaso, @estado, @nombreArchivo, @rutaArchivo');
        res.json({ msg: 'Paso actualizado correctamente' });
    } catch (err) { console.error(err); res.status(500).send('Error actualizando paso'); }
};

// ==========================================
// 5. GENERACI√ìN DE DOCUMENTOS (ACTUALIZADO)
// ==========================================

const guardarConfiguracionPlantilla = async (req, res) => {
    // Recibimos la configuraci√≥n base desde el panel del Super Admin
    const { 
        idPaso, titulo, cuerpo, campos,
        codigo, version, fechaEmision, fechaRevision 
    } = req.body; 

    try {
        const pool = await poolPromise;
        const jsonCampos = JSON.stringify(campos);
        
        // Validaci√≥n de fechas
        const fEmision = fechaEmision ? new Date(fechaEmision) : null;
        const fRevision = fechaRevision ? new Date(fechaRevision) : null;

        const check = await pool.request().input('idPaso', mssql.Int, idPaso).query('SELECT ID_Plantilla FROM PlantillasDocPESV WHERE ID_Paso = @idPaso');
        
        let idPlantilla;

        if (check.recordset.length > 0) {
            // UPDATE
            idPlantilla = check.recordset[0].ID_Plantilla;
            await pool.request()
                .input('idPaso', mssql.Int, idPaso)
                .input('titulo', mssql.NVarChar, titulo)
                .input('cuerpo', mssql.NVarChar, cuerpo)
                .input('codigo', mssql.NVarChar, codigo)
                .input('version', mssql.NVarChar, version)
                .input('fEmision', mssql.Date, fEmision)
                .input('fRevision', mssql.Date, fRevision)
                .query(`
                    UPDATE PlantillasDocPESV 
                    SET TituloDocumento = @titulo, CuerpoInicial = @cuerpo,
                        CodigoDocumento = @codigo, Version = @version,
                        FechaEmision = @fEmision, FechaRevision = @fRevision
                    WHERE ID_Paso = @idPaso
                `);
            
            // Borrar campos viejos
            await pool.request().input('idPlantilla', mssql.Int, idPlantilla).query('DELETE FROM CamposPlantillaPESV WHERE ID_Plantilla = @idPlantilla');
        } else {
            // INSERT
            const result = await pool.request()
                .input('idPaso', mssql.Int, idPaso)
                .input('titulo', mssql.NVarChar, titulo)
                .input('cuerpo', mssql.NVarChar, cuerpo)
                .input('codigo', mssql.NVarChar, codigo)
                .input('version', mssql.NVarChar, version)
                .input('fEmision', mssql.Date, fEmision)
                .input('fRevision', mssql.Date, fRevision)
                .query(`
                    INSERT INTO PlantillasDocPESV (ID_Paso, TituloDocumento, CuerpoInicial, CodigoDocumento, Version, FechaEmision, FechaRevision)
                    VALUES (@idPaso, @titulo, @cuerpo, @codigo, @version, @fEmision, @fRevision);
                    SELECT SCOPE_IDENTITY() AS id;
                `);
            idPlantilla = result.recordset[0].id;
        }

        // Insertar Campos
        if (campos && campos.length > 0) {
            const table = new mssql.Table('CamposPlantillaPESV');
            table.create = false;
            table.columns.add('ID_Plantilla', mssql.Int, { nullable: false });
            table.columns.add('Etiqueta', mssql.NVarChar(100), { nullable: false });
            table.columns.add('TipoInput', mssql.NVarChar(20), { nullable: false });
            table.columns.add('Orden', mssql.Int, { nullable: false });

            campos.forEach(c => {
                table.rows.add(idPlantilla, c.label, c.tipo, c.orden);
            });

            const request = new mssql.Request(pool);
            await request.bulk(table);
        }

        res.json({ msg: 'Configuraci√≥n guardada exitosamente' });

    } catch (err) { 
        console.error(err); 
        res.status(500).send('Error guardando plantilla'); 
    }
};

const getPlantillaPaso = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request().input('idPaso', mssql.Int, id).query('EXEC SP_GET_PlantillaPaso @idPaso');
        if (result.recordsets[0].length === 0) return res.json({ existe: false });
        res.json({ existe: true, config: result.recordsets[0][0], campos: result.recordsets[1] });
    } catch (err) { console.error(err); res.status(500).send('Error obteniendo plantilla'); }
};

const generarDocumentoPaso = async (req, res) => {
    // --- AQU√ç RECIBIMOS 'headerData' (Datos editados por el usuario al generar) ---
    const { idPaso, datosFormulario, headerData } = req.body; 
    
    try {
        const pool = await poolPromise;
        const resultConfig = await pool.request().input('idPaso', mssql.Int, idPaso).query('EXEC SP_GET_PlantillaPaso @idPaso');
        
        if (resultConfig.recordsets[0].length === 0) {
            return res.status(400).json({ msg: 'No hay plantilla configurada para este paso' });
        }

        const configBD = resultConfig.recordsets[0][0];
        const camposBD = resultConfig.recordsets[1];
        
        const camposLlenos = camposBD.map(c => ({ 
            label: c.Etiqueta, 
            valor: datosFormulario[c.Etiqueta] || '---' 
        }));

        const nombreArchivo = `Generado_Paso${idPaso}_${Date.now()}.pdf`;
        const rutaAbsoluta = path.join(__dirname, '../uploads', nombreArchivo);
        const rutaRelativa = `uploads/${nombreArchivo}`;

        // PRIORIDAD: Si el usuario envi√≥ headerData (desde el modal de generar), usamos eso.
        // Si no, usamos los valores por defecto de la BD.
        const datosHeader = {
            titulo: configBD.TituloDocumento,
            cuerpo: configBD.CuerpoInicial,
            camposLlenos: camposLlenos,
            
            // Datos din√°micos vs BD
            codigo: headerData?.codigo || configBD.CodigoDocumento,
            version: headerData?.version || configBD.Version,
            fechaEmision: headerData?.fechaEmision || (configBD.FechaEmision ? new Date(configBD.FechaEmision).toISOString().split('T')[0] : ''),
            fechaRevision: headerData?.fechaRevision || (configBD.FechaRevision ? new Date(configBD.FechaRevision).toISOString().split('T')[0] : '')
        };

        // Generamos el PDF con el encabezado correcto
        await generarActaPDF(datosHeader, null, rutaAbsoluta);

        // Guardar autom√°ticamente como evidencia
        await pool.request()
            .input('idPaso', mssql.Int, idPaso)
            .input('estado', mssql.NVarChar, 'Realizado')
            .input('nombreArchivo', mssql.NVarChar, nombreArchivo)
            .input('rutaArchivo', mssql.NVarChar, rutaRelativa)
            .query('EXEC SP_UPDATE_PasoPESV @idPaso, @estado, @nombreArchivo, @rutaArchivo');

        res.json({ msg: 'Documento generado y guardado', filename: nombreArchivo, ruta: rutaRelativa });
    } catch (err) { console.error(err); res.status(500).send('Error generando documento'); }
};

// ==========================================
// 6. CRUD DE PASOS (SUPER ADMIN / ADMIN SST)
// ==========================================

const crearPaso = async (req, res) => {
    const { numeroPaso, nombrePaso, descripcionNorma } = req.body;
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('numeroPaso', mssql.Int, numeroPaso)
            .input('nombrePaso', mssql.NVarChar, nombrePaso)
            .input('descripcionNorma', mssql.NVarChar, descripcionNorma)
            .query('EXEC SP_CREATE_PasoPESV @numeroPaso, @nombrePaso, @descripcionNorma');
        res.json({ msg: 'Paso creado exitosamente' });
    } catch (err) { console.error(err); res.status(500).send('Error creando paso'); }
};

const editarPasoInfo = async (req, res) => {
    const { idPaso, numeroPaso, nombrePaso, descripcionNorma } = req.body;
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idPaso', mssql.Int, idPaso)
            .input('numeroPaso', mssql.Int, numeroPaso)
            .input('nombrePaso', mssql.NVarChar, nombrePaso)
            .input('descripcionNorma', mssql.NVarChar, descripcionNorma)
            .query('EXEC SP_UPDATE_PasoPESV_Info @idPaso, @numeroPaso, @nombrePaso, @descripcionNorma');
        res.json({ msg: 'Paso actualizado exitosamente' });
    } catch (err) { console.error(err); res.status(500).send('Error editando paso'); }
};

const eliminarPaso = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        await pool.request().input('idPaso', mssql.Int, id).query('EXEC SP_DELETE_PasoPESV @idPaso');
        res.json({ msg: 'Paso eliminado exitosamente' });
    } catch (err) { console.error(err); res.status(500).send('Error eliminando paso'); }
};

// Exportar todas las funciones
export default {
    getConductoresPESV,
    guardarInfoConductor,
    crearMantenimiento, 
    getMantenimientos,
    getPasosPESV, 
    getEvidenciasPorPaso, 
    actualizarPasoPESV,
    guardarConfiguracionPlantilla, // Para guardar defaults (Super Admin)
    getPlantillaPaso, 
    generarDocumentoPaso, // Para generar PDF con datos editados en modal
    crearPaso, 
    editarPasoInfo, 
    eliminarPaso,
    descargarArchivo, 
    getDocumentosGenerados,
    reemplazarEvidencia 
};


==================================================================
ARCHIVO: backend\controllers\reportController.js
==================================================================
// backend/src/controllers/reportController.js

import { validationResult } from 'express-validator';
import { poolPromise, mssql } from '../config/dbConfig.js';
import path from 'path'; 
import { fileURLToPath } from 'url';
import { logAction } from '../services/logService.js';
import { crearNotificacion } from '../services/notificationService.js'; 

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const crearReporteMaquina = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) return res.status(400).json({ errors: errors.array() });
    
    const { idActivo, estadoReportado, descripcionProblema, datosReporte, kilometraje } = req.body;
    const idUsuarioReporta = req.usuario.id;
    const archivoFoto = req.file ? req.file.path : null;

    try {
        const pool = await poolPromise;
        
        // 1. Guardar Reporte
        await pool.request()
            .input('idActivo', mssql.Int, idActivo)
            .input('idUsuarioReporta', mssql.Int, idUsuarioReporta)
            .input('estadoReportado', mssql.NVarChar, estadoReportado)
            .input('descripcionProblema', mssql.NVarChar, descripcionProblema || null)
            .input('rutaFotoAdjunta', mssql.NVarChar, archivoFoto)
            .input('datosReporte', mssql.NVarChar(mssql.MAX), datosReporte || null) 
            .input('kilometraje', mssql.Int, kilometraje || null)
            .query('EXEC SP_CREATE_ReporteMaquina @idActivo, @idUsuarioReporta, @estadoReportado, @descripcionProblema, @rutaFotoAdjunta, @datosReporte, @kilometraje');

        // 2. Obtener nombre del activo para la notificaci√≥n
        const activoResult = await pool.request().input('id', mssql.Int, idActivo).query('SELECT NombreDescriptivo FROM ActivosInspeccionables WHERE ID_Activo = @id');
        const nombreEquipo = activoResult.recordset[0]?.NombreDescriptivo || 'Equipo';

        // --- NOTIFICACI√ìN ---
        if (estadoReportado === 'Con Problema') {
            await crearNotificacion({
                rolDestino: 'Administrador SST', 
                titulo: `Falla Reportada: ${nombreEquipo}`,
                mensaje: `El equipo ${nombreEquipo} reporta fallas. Revisar urgente. Reportado por: ${req.usuario.nombre}`,
                ruta: '/reportes'
            });
        }

        res.status(201).json({ msg: 'Reporte enviado exitosamente' });
    } catch (err) {
        if (err.message.includes('Se debe describir el problema')) {
            return res.status(400).json({ msg: 'Debe describir el problema si el estado es "Con Problema"' });
        }
        console.error('Error en crearReporteMaquina:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const crearReporteSeguridad = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) return res.status(400).json({ errors: errors.array() });

    const { tipoReporte, ubicacionArea, descripcion } = req.body;
    const idUsuarioReporta = req.usuario.id;
    const archivoFoto = req.file ? req.file.path : null;

    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idUsuarioReporta', mssql.Int, idUsuarioReporta)
            .input('tipoReporte', mssql.NVarChar, tipoReporte)
            .input('ubicacionArea', mssql.NVarChar, ubicacionArea)
            .input('descripcion', mssql.NVarChar, descripcion)
            .input('rutaFotoAdjunta', mssql.NVarChar, archivoFoto) 
            .query('EXEC SP_CREATE_ReporteSeguridad @idUsuarioReporta, @tipoReporte, @ubicacionArea, @descripcion, @rutaFotoAdjunta');

        // --- NOTIFICACI√ìN ---
        const mensajeAlerta = `‚ö†Ô∏è Nuevo reporte de seguridad en ${ubicacionArea}. Tipo: ${tipoReporte}.`;
        
        await crearNotificacion({
            rolDestino: 'Administrador SST',
            titulo: `Reporte de ${tipoReporte}`,
            mensaje: mensajeAlerta,
            ruta: '/reportes'
        });

        await crearNotificacion({
            rolDestino: 'Super Admin',
            titulo: `Alerta SST: ${tipoReporte}`,
            mensaje: mensajeAlerta,
            ruta: '/reportes'
        });

        res.status(201).json({ msg: 'Reporte de seguridad enviado exitosamente' });
    } catch (err) {
        console.error('Error en crearReporteSeguridad:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getReportesMaquina = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_ReportesMaquina');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getReportesMaquina:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getReportesSeguridad = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_ReportesSeguridad');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getReportesSeguridad:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getReporteMaquinaDetalle = async (req, res) => {
    const { id: idReporte } = req.params;
    
    // --- CAMBIO: Se elimin√≥ 'Gestion de Calidad' ---
    const esAdmin = ['Administrador SST', 'Super Admin'].includes(req.usuario.rol);
    const marcarRevisado = esAdmin ? 1 : 0;

    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idReporteMaquina', mssql.Int, idReporte)
            .input('marcarRevisado', mssql.Bit, marcarRevisado)
            .query('EXEC SP_GET_ReporteMaquinaDetalle @idReporteMaquina, @marcarRevisado');
        
        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Reporte de m√°quina no encontrado' });
        }

        if (esAdmin && result.recordset[0].EstadoRevision === 'Revisado') {
             await logAction(req.usuario.id, req.usuario.nombre, 'REVISAR_REPORTE_MAQUINA', `Revis√≥ el reporte de m√°quina ID: ${idReporte}`);
        }
        res.json(result.recordset[0]);
    } catch (err) {
        console.error('Error en getReporteMaquinaDetalle:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getReporteSeguridadDetalle = async (req, res) => {
    const { id: idReporte } = req.params;
    
    // --- CAMBIO: Se elimin√≥ 'Gestion de Calidad' ---
    const esAdmin = ['Administrador SST', 'Super Admin'].includes(req.usuario.rol);
    const marcarRevisado = esAdmin ? 1 : 0;

    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idReporteSeguridad', mssql.Int, idReporte)
            .input('marcarRevisado', mssql.Bit, marcarRevisado)
            .query('EXEC SP_GET_ReporteSeguridadDetalle @idReporteSeguridad, @marcarRevisado');
        
        if (result.recordset.length === 0) {
            return res.status(404).json({ msg: 'Reporte de seguridad no encontrado' });
        }

        if (esAdmin && result.recordset[0].EstadoRevision === 'Revisado') {
            await logAction(req.usuario.id, req.usuario.nombre, 'REVISAR_REPORTE_SEGURIDAD', `Revis√≥ el reporte de seguridad ID: ${idReporte}`);
        }
        res.json(result.recordset[0]);
    } catch (err) {
        console.error('Error en getReporteSeguridadDetalle:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getMisReportesMaquina = async (req, res) => {
    const idUsuario = req.usuario.id;
    try {
        const pool = await poolPromise;
        const result = await pool.request().input('idUsuario', mssql.Int, idUsuario).query('EXEC SP_GET_MisReportesMaquina @idUsuario');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getMisReportesMaquina:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getMisReportesSeguridad = async (req, res) => {
    const idUsuario = req.usuario.id;
    try {
        const pool = await poolPromise;
        const result = await pool.request().input('idUsuario', mssql.Int, idUsuario).query('EXEC SP_GET_MisReportesSeguridad @idUsuario');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getMisReportesSeguridad:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const reportController = {
    crearReporteMaquina,
    crearReporteSeguridad,
    getReportesMaquina,
    getReportesSeguridad,
    getReporteMaquinaDetalle,
    getReporteSeguridadDetalle,
    getMisReportesMaquina,
    getMisReportesSeguridad
};

export default reportController;


==================================================================
ARCHIVO: backend\controllers\requestController.js
==================================================================
// backend/controllers/requestController.js

import { poolPromise, mssql } from '../config/dbConfig.js';
import { estamparFirmaEnPDF } from '../utils/signer.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';
import { crearNotificacion } from '../services/notificationService.js'; // Notificaciones

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// --- 1. CREAR SOLICITUD (SST) ---
const crearSolicitud = async (req, res) => {
    const { tipo, mensaje, rutaDocumentoInterno } = req.body;
    const idUsuario = req.usuario.id;
    
    let rutaDocFinal = null;
    if (req.file) {
        rutaDocFinal = req.file.path.replace(/\\/g, '/');
    } else if (rutaDocumentoInterno) {
        rutaDocFinal = rutaDocumentoInterno;
    }

    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idUsuario', mssql.Int, idUsuario)
            .input('tipo', mssql.NVarChar, tipo)
            .input('mensaje', mssql.NVarChar, mensaje)
            .input('rutaDoc', mssql.NVarChar, rutaDocFinal)
            .query('EXEC SP_CREATE_Solicitud @idUsuario, @tipo, @mensaje, @rutaDoc');
        
        // --- NOTIFICACI√ìN: NUEVA SOLICITUD DE FIRMA ---
        await crearNotificacion({
            rolDestino: 'Super Admin',
            titulo: 'üñäÔ∏è Nueva Solicitud de Firma',
            mensaje: `Solicitud pendiente: ${req.usuario.nombre} requiere firma de documento.`,
            ruta: '/solicitudes'
        });
        // ----------------------------------------------

        res.json({ msg: 'Solicitud enviada al Super Admin' });
    } catch (err) {
        console.error(err); res.status(500).send('Error enviando solicitud');
    }
};

// --- 2. OBTENER SOLICITUDES ---
const getSolicitudes = async (req, res) => {
    const { id, rol } = req.usuario;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('idUsuario', mssql.Int, id)
            .input('rolUsuario', mssql.NVarChar, rol)
            .query('EXEC SP_GET_Solicitudes @idUsuario, @rolUsuario');
        res.json(result.recordset);
    } catch (err) {
        console.error(err); res.status(500).send('Error obteniendo solicitudes');
    }
};

// --- 3. RESPONDER Y FIRMAR (SUPER ADMIN) ---
const responderSolicitud = async (req, res) => {
    const { idSolicitud, estado, comentario, rutaDocumentoOriginal } = req.body;
    const archivoFirma = req.file; 
    const nombreFirmante = req.usuario.nombre; 
    const cargoFirmante = "GERENTE DE OPERACIONES"; 

    let rutaFirmadoFinal = null;

    try {
        // L√≥gica de firma (si aplica)
        if (estado === 'Aprobado' && rutaDocumentoOriginal && archivoFirma) {
            const nombrePdfFirmado = `Firmado_Solicitud${idSolicitud}_${Date.now()}.pdf`;
            let rutaRelativaLimpia = rutaDocumentoOriginal.startsWith('backend/') 
                ? rutaDocumentoOriginal.replace('backend/', '') 
                : rutaDocumentoOriginal;

            const pathOriginal = path.join(__dirname, '../', rutaRelativaLimpia); 
            const pathSalida = path.join(__dirname, '../uploads', nombrePdfFirmado);
            const pathFirma = archivoFirma.path;

            if (fs.existsSync(pathOriginal)) {
                await estamparFirmaEnPDF(pathOriginal, pathFirma, pathSalida, nombreFirmante, cargoFirmante);
                rutaFirmadoFinal = `uploads/${nombrePdfFirmado}`;
                try { fs.unlinkSync(pathFirma); } catch(e){}
            } else {
                return res.status(404).json({ msg: 'No se encontr√≥ el documento original.' });
            }
        }

        const pool = await poolPromise;
        await pool.request()
            .input('idSolicitud', mssql.Int, idSolicitud)
            .input('estado', mssql.NVarChar, estado)
            .input('comentario', mssql.NVarChar, comentario)
            .input('rutaFirmado', mssql.NVarChar, rutaFirmadoFinal)
            .query('EXEC SP_UPDATE_ResponderSolicitud @idSolicitud, @estado, @comentario, @rutaFirmado');
        
        // --- NOTIFICACI√ìN: RESPUESTA DE SOLICITUD ---
        // 1. Averiguar qui√©n pidi√≥ la solicitud
        const ownerResult = await pool.request()
            .input('idSolicitud', mssql.Int, idSolicitud)
            .query('EXEC SP_GET_Owner_Solicitud @idSolicitud');
        
        const idSolicitante = ownerResult.recordset[0]?.ID_UsuarioSolicitante;

        if (idSolicitante) {
            const icono = estado === 'Aprobado' ? '‚úÖ' : '‚ùå';
            await crearNotificacion({
                idUsuarioDestino: idSolicitante,
                titulo: `Solicitud ${estado}`,
                mensaje: `${icono} Tu solicitud fue ${estado} por la Gerencia.`,
                ruta: '/solicitudes'
            });
        }
        // --------------------------------------------

        res.json({ msg: 'Respuesta registrada correctamente', rutaFirmado: rutaFirmadoFinal });

    } catch (err) {
        console.error('Error respondiendo:', err);
        res.status(500).send('Error al procesar la solicitud: ' + err.message);
    }
};

// --- 4. ACTUALIZAR DOCUMENTO MANUALMENTE ---
const actualizarDocumentoFirmado = async (req, res) => {
    const { idSolicitud } = req.body;
    const archivo = req.file;

    if (!archivo) return res.status(400).json({ msg: 'No se subi√≥ ning√∫n archivo' });

    try {
        const rutaFinal = archivo.path.replace(/\\/g, '/');
        const pool = await poolPromise;
        await pool.request()
            .input('idSolicitud', mssql.Int, idSolicitud)
            .input('rutaNuevoDoc', mssql.NVarChar, rutaFinal)
            .query('EXEC SP_UPDATE_Solicitud_DocFirmado @idSolicitud, @rutaNuevoDoc');

        res.json({ msg: 'Documento actualizado correctamente' });

    } catch (err) {
        console.error(err);
        res.status(500).send('Error actualizando documento');
    }
};

export default { crearSolicitud, getSolicitudes, responderSolicitud, actualizarDocumentoFirmado };


==================================================================
ARCHIVO: backend\controllers\scheduleController.js
==================================================================
// backend/src/controllers/scheduleController.js

import { validationResult } from 'express-validator';
import { poolPromise, mssql } from '../config/dbConfig.js';
import { logAction } from '../services/logService.js'; 

const crearCronograma = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    const { nombreCronograma, anioAplicacion, descripcion } = req.body;
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .input('nombreCronograma', mssql.NVarChar, nombreCronograma)
            .input('anioAplicacion', mssql.Int, anioAplicacion || null)
            .input('descripcion', mssql.NVarChar, descripcion || null)
            .query('EXEC SP_CREATE_Cronograma @nombreCronograma, @anioAplicacion, @descripcion'); 
        const nuevoCronogramaId = result.recordset[0].ID_Cronograma;

        await logAction(req.usuario.id, req.usuario.nombre, 'CREAR_CRONOGRAMA', `Cre√≥ el cronograma: '${nombreCronograma}' (ID: ${nuevoCronogramaId})`);

        res.status(201).json({ 
            msg: 'Cronograma creado exitosamente',
            idCronograma: nuevoCronogramaId 
        });
    } catch (err) {
        if (err.message.includes('Ya existe un cronograma')) { 
             return res.status(400).json({ msg: 'Ya existe un cronograma con ese nombre y a√±o de aplicaci√≥n' });
        }
        console.error('Error en crearCronograma:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getCronogramas = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_Cronogramas'); 
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getCronogramas:', err.message);
        res.status(500).send('Error del servidor');
    }
};

/**
 * @controller  eliminarCronograma
 * @desc        Marca un cronograma como Inactivo (Con Validaci√≥n)
 */
const eliminarCronograma = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await poolPromise;
        
        // Obtenemos el nombre antes de intentar borrar (para el log)
        const check = await pool.request().input('id', mssql.Int, id).query('SELECT NombreCronograma FROM Cronogramas WHERE ID_Cronograma = @id');
        if (check.recordset.length === 0) {
            return res.status(404).json({ msg: 'Cronograma no encontrado' });
        }
        const nombreCronograma = check.recordset[0].NombreCronograma;

        // Intentamos eliminar
        await pool.request()
            .input('idCronograma', mssql.Int, id)
            .query('EXEC SP_DELETE_Cronograma @idCronograma');

        // Si no hubo error en el SP, guardamos el log
        await logAction(req.usuario.id, req.usuario.nombre, 'ELIMINAR_CRONOGRAMA', `Elimin√≥ (archiv√≥) el cronograma: '${nombreCronograma}' (ID: ${id})`);

        res.json({ msg: 'Cronograma eliminado exitosamente' });

    } catch (err) {
        // --- CORRECCI√ìN AQU√ç ---
        // Si el error viene del SP (RAISERROR), lo enviamos al frontend
        if (err.message.includes('No se puede eliminar')) {
            return res.status(400).json({ msg: err.message });
        }
        
        console.error('Error en eliminarCronograma:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const crearActividad = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }

    const { id: idCronograma } = req.params; 
    const { nombreActividad, fechaLimite, idUsuarioResponsable, descripcion } = req.body;

    try {
        const pool = await poolPromise;
        const fechaLimiteDate = new Date(fechaLimite);
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0); 
        if (fechaLimiteDate < hoy) {
            return res.status(400).json({ msg: 'La fecha l√≠mite no puede ser anterior a la fecha actual' });
        }
        const checkCronograma = await pool.request().input('idCronograma', mssql.Int, idCronograma).query('SELECT ID_Cronograma FROM dbo.Cronogramas WHERE ID_Cronograma = @idCronograma');
        if (checkCronograma.recordset.length === 0) {
            return res.status(404).json({ msg: 'Cronograma no encontrado' });
        }

        const result = await pool.request()
            .input('idCronograma', mssql.Int, idCronograma)
            .input('nombreActividad', mssql.NVarChar, nombreActividad)
            .input('descripcionActividad', mssql.NVarChar, descripcion || null)
            .input('idUsuarioResponsable', mssql.Int, idUsuarioResponsable)
            .input('fechaLimite', mssql.Date, fechaLimiteDate)
            .query('EXEC SP_CREATE_Actividad @idCronograma, @nombreActividad, @descripcionActividad, @idUsuarioResponsable, @fechaLimite');
        
        const nuevaActividadId = result.recordset[0].ID_Actividad;
        await logAction(req.usuario.id, req.usuario.nombre, 'CREAR_ACTIVIDAD', `Cre√≥ la actividad: '${nombreActividad}' (ID: ${nuevaActividadId})`);

        res.status(201).json({ msg: 'Actividad creada exitosamente', idActividad: nuevaActividadId });
    } catch (err) {
        console.error('Error en crearActividad:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getActividadesPorCronograma = async (req, res) => {
    const { id: idCronograma } = req.params; 
    try {
        const pool = await poolPromise;
        const checkCronograma = await pool.request().input('idCronograma', mssql.Int, idCronograma).query('SELECT ID_Cronograma FROM dbo.Cronogramas WHERE ID_Cronograma = @idCronograma');
        if (checkCronograma.recordset.length === 0) {
            return res.status(404).json({ msg: 'Cronograma no encontrado' });
        }
        const result = await pool.request()
            .input('idCronograma', mssql.Int, idCronograma)
            .query('EXEC SP_GET_ActividadesPorCronograma @idCronograma'); 
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getActividadesPorCronograma:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const scheduleController = {
    crearCronograma,
    getCronogramas,
    eliminarCronograma, 
    crearActividad,
    getActividadesPorCronograma
};

export default scheduleController;


==================================================================
ARCHIVO: backend\controllers\userController.js
==================================================================
// backend/controllers/userController.js

import { validationResult } from 'express-validator';
import bcrypt from 'bcryptjs';
import { poolPromise, mssql } from '../config/dbConfig.js';
import { logAction } from '../services/logService.js';
import { buscarEnDirectorioExterno } from '../services/externalApiService.js';

// --- FUNCI√ìN: BUSCAR EN API EXTERNA (N√ìMINA/GOSEN) ---
const buscarDirectorioExterno = async (req, res) => {
    const query = req.query.query || ''; 
    
    try {
        const resultados = await buscarEnDirectorioExterno(query);
        
        const datosFormateados = resultados.map(u => {
            // 1. DETECCI√ìN DE ESTADO (M√°s permisiva)
            const estadoRaw = u.EstadoContrato;
            const esActivo = (estadoRaw == 1 || estadoRaw === true || String(estadoRaw).trim() === '1');

            // Helper para fecha
            const formatearFecha = (f) => {
                if (!f) return null;
                const fechaObj = new Date(f);
                if (isNaN(fechaObj.getTime())) return null;
                const userTimezoneOffset = fechaObj.getTimezoneOffset() * 60000;
                const fechaCompensada = new Date(fechaObj.getTime() + userTimezoneOffset);
                return fechaCompensada.toLocaleDateString('es-CO');
            };

            const fechaInicioStr = formatearFecha(u.FechaInicio);
            const fechaFinStr = formatearFecha(u.FechaFin);
            const fechaTerminacionStr = formatearFecha(u.FechaTerminacion);

            // 2. L√ìGICA DE FECHAS
            let textoFecha = '---';

            if (esActivo) {
                textoFecha = fechaInicioStr ? `Inicio: ${fechaInicioStr}` : 'Activo (Sin fecha inicio)';
            } else {
                if (fechaTerminacionStr) {
                    textoFecha = `Fin: ${fechaTerminacionStr}`;
                } else if (fechaFinStr) {
                    textoFecha = `Fin: ${fechaFinStr}`;
                } else {
                    textoFecha = 'Inactivo (Sin fecha fin)';
                }
            }

            return {
                Nombre: u.NombreCompleto,
                Cedula: u.Cedula,
                Cargo: u.CargoNombre || 'Sin asignar',
                Area: u.CentroCosto || 'No definido',
                Email: u.Email || 'No registrado',
                Estado: esActivo ? 'Activo' : 'Inactivo',
                FechaRelevante: textoFecha
            };
        });

        res.json(datosFormateados);

    } catch (err) {
        console.error('Error en controlador externo:', err);
        res.status(500).json({ msg: 'Error consultando directorio externo' });
    }
};

// --- CRUD DE USUARIOS LOCALES ---

const crearColaborador = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) return res.status(400).json({ errors: errors.array() });

    const { nombreCompleto, cedula, password, idRol, area, cargo } = req.body;
    try {
        const pool = await poolPromise;
        const salt = await bcrypt.genSalt(10);
        const passwordHash = await bcrypt.hash(password, salt);

        await pool.request()
            .input('nombreCompleto', mssql.NVarChar, nombreCompleto)
            .input('cedula', mssql.NVarChar, cedula)
            .input('passwordHash', mssql.NVarChar, passwordHash)
            .input('idRol', mssql.Int, idRol) 
            .input('area', mssql.NVarChar, area || null)
            .input('cargo', mssql.NVarChar, cargo || null)
            .query('EXEC SP_CREATE_Colaborador @nombreCompleto, @cedula, @passwordHash, @idRol, @area, @cargo'); 

        await logAction(req.usuario.id, req.usuario.nombre, 'CREAR_USUARIO', `Cre√≥ al usuario: ${nombreCompleto} (C√©dula: ${cedula})`);
        res.status(201).json({ msg: 'Usuario creado exitosamente' });
    } catch (err) {
        if (err.message.includes('La c√©dula ingresada ya existe')) return res.status(400).json({ msg: 'La c√©dula ingresada ya existe' });
        console.error('Error en crearColaborador:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getColaboradores = async (req, res) => {
    const idAdminLogueado = req.usuario.id;
    try {
        const pool = await poolPromise;
        const result = await pool.request().input('idAdminLogueado', mssql.Int, idAdminLogueado).query('EXEC SP_GET_Colaboradores @idAdminLogueado'); 
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getColaboradores:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getTodosUsuarios = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_TodosUsuarios');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getTodosUsuarios:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getUsuarioPorCedula = async (req, res) => {
    const { cedula } = req.params;
    try {
        const pool = await poolPromise;
        const result = await pool.request().input('cedula', mssql.NVarChar, cedula).query('EXEC SP_GET_UsuarioPorCedula @cedula');
        if (result.recordset.length === 0) return res.status(404).json({ msg: 'Usuario no encontrado o inactivo' });
        res.json(result.recordset[0]);
    } catch (err) {
        console.error('Error en getUsuarioPorCedula:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getRoles = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('SELECT ID_Rol, NombreRol FROM Roles ORDER BY ID_Rol ASC');
        res.json(result.recordset);
    } catch (err) {
        console.error('Error en getRoles:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const editarColaborador = async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) return res.status(400).json({ errors: errors.array() });
    const { id } = req.params; 
    const { nombreCompleto, area, cargo } = req.body; 
    try {
        const pool = await poolPromise;
        const checkUser = await pool.request().input('id', mssql.Int, id).query('SELECT ID_Usuario FROM dbo.Usuarios WHERE ID_Usuario = @id');
        if (checkUser.recordset.length === 0) return res.status(404).json({ msg: 'Usuario no encontrado' });
        
        await pool.request()
            .input('idUsuario', mssql.Int, id)
            .input('nombreCompleto', mssql.NVarChar, nombreCompleto)
            .input('area', mssql.NVarChar, area || null)
            .input('cargo', mssql.NVarChar, cargo || null)
            .query('EXEC SP_UPDATE_Colaborador @idUsuario, @nombreCompleto, @area, @cargo'); 
        
        await logAction(req.usuario.id, req.usuario.nombre, 'EDITAR_USUARIO', `Edit√≥ al usuario: ${nombreCompleto} (ID: ${id})`);
        res.json({ msg: 'Colaborador actualizado exitosamente' });
    } catch (err) {
        console.error('Error en editarColaborador:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const cambiarEstadoColaborador = async (req, res) => {
    const { id } = req.params; 
    const { estado } = req.body; 
    try {
        const pool = await poolPromise;
        const checkUser = await pool.request().input('id', mssql.Int, id).query('SELECT ID_Usuario, NombreCompleto FROM dbo.Usuarios WHERE ID_Usuario = @id');
        if (checkUser.recordset.length === 0) return res.status(404).json({ msg: 'Usuario no encontrado' });
        
        const nombreAfectado = checkUser.recordset[0].NombreCompleto;
        await pool.request()
            .input('idUsuario', mssql.Int, id)
            .input('estado', mssql.NVarChar, estado)
            .query('EXEC SP_UPDATE_EstadoUsuario @idUsuario, @estado'); 
        
        await logAction(req.usuario.id, req.usuario.nombre, 'CAMBIAR_ESTADO_USUARIO', `Cambi√≥ estado a '${estado}' para: ${nombreAfectado}`);
        res.json({ msg: `Usuario ${estado.toLowerCase()} exitosamente` });
    } catch (err) {
        console.error('Error en cambiarEstadoColaborador:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const resetPasswordColaborador = async (req, res) => {
    const { id } = req.params; 
    const { password } = req.body; 
    try {
        const pool = await poolPromise;
        const checkUser = await pool.request().input('id', mssql.Int, id).query('SELECT ID_Usuario, NombreCompleto FROM dbo.Usuarios WHERE ID_Usuario = @id');
        if (checkUser.recordset.length === 0) return res.status(404).json({ msg: 'Usuario no encontrado' });
        
        const nombreAfectado = checkUser.recordset[0].NombreCompleto;
        const salt = await bcrypt.genSalt(10);
        const passwordHash = await bcrypt.hash(password, salt);
        
        await pool.request()
            .input('idUsuario', mssql.Int, id)
            .input('passwordHash', mssql.NVarChar, passwordHash)
            .query('EXEC SP_UPDATE_PasswordUsuario @idUsuario, @passwordHash'); 
        
        await logAction(req.usuario.id, req.usuario.nombre, 'RESETEAR_PASSWORD', `Resete√≥ contrase√±a para: ${nombreAfectado}`);
        res.json({ msg: 'Contrase√±a del colaborador actualizada exitosamente' });
    } catch (err) {
        console.error('Error en resetPasswordColaborador:', err.message);
        res.status(500).send('Error del servidor');
    }
};

const getCargosEmpresa = async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request().query('EXEC SP_GET_CargosEmpresa');
        const lista = result.recordset.map(item => item.NombreCargo);
        res.json(lista);
    } catch (err) {
        console.error('Error obteniendo cargos:', err.message);
        res.status(500).send('Error del servidor');
    }
};

// --- NUEVA FUNCI√ìN: ACTUALIZAR PERFIL (EMAIL) ---
const actualizarPerfilEmail = async (req, res) => {
    const { email } = req.body;
    const idUsuario = req.usuario.id; // Del token

    // Validaci√≥n b√°sica de email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        return res.status(400).json({ msg: 'Formato de correo inv√°lido.' });
    }

    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idUsuario', mssql.Int, idUsuario)
            .input('email', mssql.NVarChar, email)
            .query('EXEC SP_UPDATE_EmailUsuario @idUsuario, @email');

        res.json({ msg: 'Correo actualizado exitosamente' });
    } catch (err) {
        console.error(err);
        res.status(500).send('Error al actualizar perfil');
    }
};

const userController = {
    buscarDirectorioExterno, 
    crearColaborador,
    getColaboradores,
    getTodosUsuarios,
    getUsuarioPorCedula,
    getRoles,
    editarColaborador,
    cambiarEstadoColaborador,
    resetPasswordColaborador,
    getCargosEmpresa,
    actualizarPerfilEmail // <--- AGREGAR
};

export default userController;


==================================================================
ARCHIVO: backend\middleware\acpmFileUpload.js
==================================================================
// backend/middleware/acpmFileUpload.js

import multer from 'multer';
import path from 'path';

// 1. D√≥nde y c√≥mo guardar los archivos
const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        cb(null, 'uploads/'); // Usa la misma carpeta 'uploads/'
    },
    filename: (req, file, cb) => {
        // Genera un nombre de archivo √∫nico para ACPM
        // Formato: acpm-IDACPM-timestamp.extension
        const idACPM = req.params.id; // Asume que el ID est√° en la URL
        const timestamp = Date.now();
        const extension = path.extname(file.originalname);
        
        cb(null, `acpm-${idACPM}-${timestamp}${extension}`);
    }
});

// 2. Filtro de archivos (igual al anterior)
const fileFilter = (req, file, cb) => {
    const allowedTypes = /jpeg|jpg|png|pdf/;
    const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
    const mimetype = allowedTypes.test(file.mimetype);

    if (mimetype && extname) {
        cb(null, true);
    } else {
        cb(new Error('Error: Solo se permiten archivos .jpg, .png o .pdf'), false);
    }
};

// 3. Creaci√≥n del middleware de subida
const acpmUpload = multer({
    storage: storage,
    limits: { fileSize: 1024 * 1024 * 10 }, // L√≠mite de 10 MB
    fileFilter: fileFilter
});

// Exportamos como 'default'
export default acpmUpload;


==================================================================
ARCHIVO: backend\middleware\authMiddleware.js
==================================================================
// backend/middleware/authMiddleware.js
import jwt from 'jsonwebtoken';
import 'dotenv/config.js';

/**
 * @middleware protect
 * @desc       Middleware para identificar el token y el usuario.
 */
const protect = (req, res, next) => {
    let token;

    const authHeader = req.headers.authorization;

    if (authHeader && authHeader.startsWith('Bearer')){
        try {
            token = authHeader.split(' ')[1];
            const decoded = jwt.verify(token, process.env.JWT_SECRET);
            req.usuario = decoded.usuario; // { id, nombre, rol }
            next();
        } catch (error) {
            console.error('Error de autenticacion:', error.message);
            res.status(401).json({msg: 'Token no valido, autorizacion denegada'});
        }
    }

    if(!token){
        res.status(401).json({msg: 'No hay token autorizacion denegada'});
    }
};

/**
 * @middleware admin
 * @desc       Middleware para verificar roles administrativos (SST o Super Admin)
 */
const admin = (req, res, next) => {
    // Verifica si existe el usuario y si tiene uno de los roles permitidos
    if (req.usuario && (req.usuario.rol === 'Administrador SST' || req.usuario.rol === 'Super Admin')){
        next();
    } else {
        res.status(403).json({msg:'Acceso denegado. Se requiere rol de administrador'});
    }
};

export { protect, admin };


==================================================================
ARCHIVO: backend\middleware\dmsFileUpload.js
==================================================================
// backend/middleware/dmsFileUpload.js

import multer from 'multer';
import path from 'path';

// --- 1. Definir tipos de archivo permitidos (RNF-017) ---
const allowedMimeTypes = [
    'application/pdf', // .pdf
    'application/msword', // .doc
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // .docx
    'application/vnd.ms-excel', // .xls
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
    'application/xml', // .xml
    'text/xml' // .xml
];

// --- 2. D√≥nde y c√≥mo guardar ---
const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        // Guarda en una subcarpeta 'dms' para no mezclar con evidencias
        cb(null, 'uploads/dms'); 
    },
    filename: (req, file, cb) => {
        // Genera un nombre de archivo √∫nico (timestamp + nombre original)
        const timestamp = Date.now();
        const safeOriginalName = file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_');
        cb(null, `${timestamp}-${safeOriginalName}`);
    }
});

// --- 3. Filtro de archivos ---
const fileFilter = (req, file, cb) => {
    if (allowedMimeTypes.includes(file.mimetype)) {
        cb(null, true); // Archivo permitido
    } else {
        // Archivo rechazado (RNF-017)
        cb(new Error(`Tipo de archivo no permitido: ${file.mimetype}`), false);
    }
};

// --- 4. Creaci√≥n del middleware de subida ---
// Usamos .array('archivos') para permitir subida m√∫ltiple
const dmsUpload = multer({
    storage: storage,
    limits: {
        fileSize: 1024 * 1024 * 25 // L√≠mite de 25 MB (RNF-018)
    },
    fileFilter: fileFilter
});

export default dmsUpload;


==================================================================
ARCHIVO: backend\middleware\fileUpload.js
==================================================================
// backend/middleware/fileUpload.js

import multer from 'multer';
import path from 'path'; // M√≥dulo 'path' de Node.js

/**
 * @middleware  fileUpload
 * @desc        Configuraci√≥n de Multer para la subida de archivos
 */

// 1. D√≥nde y c√≥mo guardar los archivos
const storage = multer.diskStorage({
    // Define la carpeta de destino
    destination: (req, file, cb) => {
        cb(null, 'uploads/'); // Aseg√∫rate de que la carpeta 'uploads/' exista
    },
    // Define el nombre del archivo
    filename: (req, file, cb) => {
        // Genera un nombre de archivo √∫nico para evitar colisiones
        // Formato: actividad-IDActividad-timestamp.extension
        const idActividad = req.params.id; // Asume que el ID est√° en la URL
        const timestamp = Date.now();
        const extension = path.extname(file.originalname); // .jpg, .pdf
        
        cb(null, `actividad-${idActividad}-${timestamp}${extension}`);
    }
});

// 2. Filtro de archivos (basado en tu CU-01 y DB)
const fileFilter = (req, file, cb) => {
    // Define los tipos de archivo permitidos
    const allowedTypes = /jpeg|jpg|png|pdf/;
    
    // Comprueba la extensi√≥n del archivo
    const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
    // Comprueba el 'mimetype'
    const mimetype = allowedTypes.test(file.mimetype);

    if (mimetype && extname) {
        // Archivo permitido
        cb(null, true);
    } else {
        // Archivo rechazado
        cb(new Error('Error: Solo se permiten archivos .jpg, .png o .pdf'), false);
    }
};

// 3. Creaci√≥n del middleware de subida
const upload = multer({
    storage: storage,
    limits: {
        fileSize: 1024 * 1024 * 10 // L√≠mite de 10 MB por archivo
    },
    fileFilter: fileFilter
});

export default upload;


==================================================================
ARCHIVO: backend\package.json
==================================================================
{
  "name": "backend",
  "version": "1.0.0",
  "main": "index.js",
  "type": "module",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "description": "",
  "dependencies": {
    "axios": "^1.13.2",
    "bcrypt": "^6.0.0",
    "bcryptjs": "^3.0.2",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^5.1.0",
    "express-validator": "^7.3.0",
    "jsonwebtoken": "^9.0.2",
    "mssql": "^12.0.0",
    "multer": "^2.0.2",
    "node-cron": "^4.2.1",
    "nodemailer": "^7.0.11",
    "pdf-lib": "^1.17.1",
    "pdfkit": "^0.17.2"
  },
  "devDependencies": {
    "nodemon": "^3.1.10"
  }
}



==================================================================
ARCHIVO: backend\routes\acpmRoutes.js
==================================================================
// backend/routes/acpmRoutes.js

import express from 'express';
import { check } from 'express-validator';
import acpmController from '../controllers/acpmController.js';
import { protect, admin } from '../middleware/authMiddleware.js';
import acpmUpload from '../middleware/acpmFileUpload.js';

const router = express.Router();

// POST /api/acpm (Crear ACPM)
router.post(
    '/',
    [ protect, admin ], 
    [
        check('tipoAccion', 'El tipo de acci√≥n es obligatorio').isIn(['Correctiva', 'Preventiva', 'Mejora']),
        check('origen', 'El origen es obligatorio').not().isEmpty(),
        check('descripcionProblema', 'La descripci√≥n del problema es obligatoria').not().isEmpty(),
        check('planAccion', 'El plan de acci√≥n es obligatorio').not().isEmpty(),
        // --- CAMBIO: Validaci√≥n de ID ---
        check('idUsuarioResponsable', 'El responsable es obligatorio').isInt(),
        check('fechaLimite', 'La fecha l√≠mite es obligatoria').isISO8601()
    ],
    acpmController.crearACPM
);

// GET /api/acpm (Listar ACPM)
router.get(
    '/',
    [ protect, admin ], 
    acpmController.getACPMs
);

// GET /api/acpm/:id (Ver Detalle)
router.get(
    '/:id', 
    [ protect, admin ], 
    acpmController.getACPMDetalle
);

// PATCH /api/acpm/:id (Gestionar/Cerrar)
router.patch(
    '/:id', 
    [ protect, admin ], 
    acpmUpload.single('evidenciaCierre'), 
    [
        check('estadoACPM', 'El estado es obligatorio').isIn(['Abierta', 'En Proceso', 'Cerrada'])
    ],
    acpmController.gestionarACPM
);

// GET /api/acpm/:id/evidencias (Ver Evidencias)
router.get(
    '/:id/evidencias',
    [ protect, admin ],
    acpmController.getEvidenciasACPM
);

export default router;


==================================================================
ARCHIVO: backend\routes\activityRoutes.js
==================================================================
// backend/routes/activityRoutes.js

import express from 'express';
import { check } from 'express-validator';
import activityController from '../controllers/activityController.js';
import { protect, admin } from '../middleware/authMiddleware.js';
import upload from '../middleware/fileUpload.js';

const router = express.Router();

/**
 * @route   PUT /api/actividades/:id
 * @desc    Editar los detalles de una actividad (CU-10)
 */
router.put(
    '/:id', // :id es el ID_Actividad
    [ protect, admin ],
    [
        check('nombreActividad', 'El nombre de la actividad es obligatorio').not().isEmpty(),
        check('fechaLimite', 'La fecha l√≠mite es obligatoria y debe ser una fecha v√°lida').isISO8601(),
        // --- CAMBIO: Validaci√≥n de ID ---
        check('idUsuarioResponsable', 'El responsable es obligatorio').isInt()
    ],
    activityController.editarActividad
);

// DELETE /api/actividades/:id (Eliminar Actividad)
router.delete(
    '/:id', 
    [ protect, admin ], 
    activityController.eliminarActividad
);

// PATCH /api/actividades/:id/estado (Gestionar Estado/Evidencia)
router.patch(
    '/:id/estado',
    [ protect, admin ], 
    upload.single('evidenciaFile'), 
    [
        check('estado', 'El estado es obligatorio').isIn(['Pendiente', 'Realizada', 'Cancelada']),
        check('observaciones').optional().isString()
    ],
    activityController.gestionarActividad
);

// GET /api/actividades/:id/evidencias (Ver Evidencias)
router.get(
    '/:id/evidencias',
    [ protect, admin ],
    activityController.getEvidenciasActividad
);

/**
 * @route   GET /api/actividades/:id
 * @desc    Obtener el detalle completo de una actividad
 * @access  Privado (Admin)
 */
router.get(
    '/:id', 
    [ protect, admin ],
    activityController.getActividadDetalle // <-- NUEVA RUTA
);

export default router;


==================================================================
ARCHIVO: backend\routes\assetRoutes.js
==================================================================
// backend/routes/assetRoutes.js

import express from 'express';
import { check } from 'express-validator';
import assetController from '../controllers/assetController.js';
import { protect, admin } from '../middleware/authMiddleware.js';

const router = express.Router();

/**
 * @route   GET /api/activos/tipos
 * @desc    Obtener lista de tipos de activos
 * @access  Privado (Admin) - Se usa para crear activos
 */
router.get(
    '/tipos',
    [ protect, admin ],
    assetController.getTiposDisponibles
);

/**
 * @route   GET /api/activos/tipo/:tipo
 * @desc    Obtener lista de activos filtrados por tipo
 * @access  Privado (Cualquier rol logueado)
 */
router.get(
    '/tipo/:tipo',
    [ protect ], 
    assetController.getActivosPorTipo
);

/**
 * @route   GET /api/activos
 * @desc    Obtener lista de TODOS los activos
 * @access  Privado (Cualquier rol logueado) <--- CAMBIO IMPORTANTE
 */
router.get(
    '/',
    [ protect ], // <--- Antes ten√≠a [protect, admin]. Ahora cualquiera puede ver la lista para reportar.
    assetController.getActivosTodos
);

/**
 * @route   POST /api/activos
 * @desc    Crear un nuevo activo
 * @access  Privado (Admin)
 */
router.post(
    '/',
    [ protect, admin ],
    [
        check('tipoActivo', 'El tipo de activo es obligatorio').not().isEmpty(),
        check('codigoIdentificador', 'El c√≥digo identificador es obligatorio').not().isEmpty(),
        check('nombreDescriptivo', 'El nombre descriptivo es obligatorio').not().isEmpty()
    ],
    assetController.crearActivo
);

/**
 * @route   PUT /api/activos/:id
 * @desc    Actualizar un activo
 * @access  Privado (Admin)
 */
router.put(
    '/:id',
    [ protect, admin ],
    [
        check('tipoActivo', 'El tipo de activo es obligatorio').not().isEmpty(),
        check('codigoIdentificador', 'El c√≥digo identificador es obligatorio').not().isEmpty(),
        check('nombreDescriptivo', 'El nombre descriptivo es obligatorio').not().isEmpty()
    ],
    assetController.actualizarActivo
);

/**
 * @route   DELETE /api/activos/:id
 * @desc    Eliminar un activo
 * @access  Privado (Admin)
 */
router.delete(
    '/:id',
    [ protect, admin ],
    assetController.eliminarActivo
);

export default router;


==================================================================
ARCHIVO: backend\routes\authRoutes.js
==================================================================
// backend/routes/authRoutes.js

import express from 'express';
import { check } from 'express-validator'; // Para validar los datos de entrada
import authController from '../controllers/authController.js';

const router = express.Router();

/**
 * @route   POST /api/auth/login
 * @desc    Autenticar usuario (Admin o Colaborador) y obtener token
 * @access  Public
 */
router.post(
    '/login',
    [
        // Validaciones: no deben estar vac√≠os
        check('cedula', 'La c√©dula es obligatoria').not().isEmpty(),
        check('password', 'La contrase√±a es obligatoria').not().isEmpty()
    ],
    authController.login // Llama a la funci√≥n 'login' del controlador
);

export default router;


==================================================================
ARCHIVO: backend\routes\budgetRoutes.js
==================================================================
// backend/routes/budgetRoutes.js
import express from 'express';
import budgetController from '../controllers/budgetController.js';
import { protect, admin } from '../middleware/authMiddleware.js';
import upload from '../middleware/fileUpload.js'; // Reusamos tu middleware de subida

const router = express.Router();

// Obtener resumen (Todos los admins pueden ver)
router.get('/', [protect, admin], budgetController.getPresupuestos);

// Obtener detalle de gastos de un presupuesto
router.get('/:id/gastos', [protect, admin], budgetController.getDetalleGastos);

// Crear Presupuesto (Super Admin y Admin SST pueden, pero idealmente Super Admin asigna)
router.post('/asignar', [protect, admin], budgetController.crearPresupuesto);

// Registrar Gasto (Con evidencia)
router.post('/gastar', [protect, admin], upload.single('evidencia'), budgetController.registrarGasto);

router.put('/:id', [protect, admin], budgetController.editarPresupuesto);
router.delete('/:id', [protect, admin], budgetController.eliminarPresupuesto);

export default router;


==================================================================
ARCHIVO: backend\routes\collabDocsRoutes.js
==================================================================
// backend/routes/collabDocsRoutes.js

import express from 'express';
import multer from 'multer';
import path from 'path';
import fs from 'fs';
import collabDocsController from '../controllers/collabDocsController.js';
import { protect, admin } from '../middleware/authMiddleware.js';

const router = express.Router();

// --- CONFIGURACI√ìN DE MULTER (ALMACENAMIENTO) ---
const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        // Carpeta donde se guardar√°n los documentos
        const dir = 'uploads/colaboradores/';
        // Si no existe, la creamos recursivamente
        if (!fs.existsSync(dir)){ 
            fs.mkdirSync(dir, { recursive: true }); 
        }
        cb(null, dir);
    },
    filename: (req, file, cb) => {
        // Generamos un nombre √∫nico: TIMESTAMP-RANDOM-NOMBREORIGINAL
        // Esto evita que se sobrescriban archivos con el mismo nombre
        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
        cb(null, uniqueSuffix + '-' + file.originalname);
    }
});

const upload = multer({ storage: storage });

// --- DEFINICI√ìN DE RUTAS ---

// 1. Obtener lista de documentos de un colaborador (por C√©dula)
router.get('/:cedula', [protect], collabDocsController.getDocumentosPorCedula);

// 2. Descargar un documento (Force Download)
router.get('/download/:id', [protect], collabDocsController.descargarDocumento);

// 3. Visualizar un documento en el navegador (Inline View)
router.get('/view/:id', [protect], collabDocsController.verDocumento);

// 4. Eliminar un documento (Solo Admins)
router.delete('/:id', [protect, admin], collabDocsController.eliminarDocumento);

// 5. Subir un nuevo documento
// 'archivo' es el nombre del campo que debe enviar el Frontend en el FormData
router.post('/', [protect, admin], upload.single('archivo'), collabDocsController.subirDocumento);

export default router;


==================================================================
ARCHIVO: backend\routes\committeeRoutes.js
==================================================================
// backend/routes/committeeRoutes.js
import express from 'express';
import committeeController from '../controllers/committeeController.js';
import { protect, admin } from '../middleware/authMiddleware.js';
import multer from 'multer';
import path from 'path';
import fs from 'fs';

const router = express.Router();

const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        const dir = 'uploads/actas/';
        if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
        cb(null, dir);
    },
    filename: (req, file, cb) => {
        const prefix = file.fieldname === 'archivoFirmas' ? 'Firmas_' : 'Acta_';
        cb(null, `${prefix}${Date.now()}_${path.extname(file.originalname)}`);
    }
});
const upload = multer({ storage: storage });

// Rutas existentes
router.post('/', [protect], upload.single('archivoManual'), committeeController.crearActa);
router.get('/', [protect], committeeController.getActas);
router.put('/:id/archivo', [protect, admin], upload.single('archivo'), committeeController.actualizarArchivoActa);

// --- RUTAS NUEVAS ---
// Subir firmas
router.put('/:id/firmas', [protect, admin], upload.single('archivoFirmas'), committeeController.subirFirmasActa);
// Descargar (Forzar descarga directa)
router.get('/:id/download', [protect], committeeController.descargarActa);

export default router;


==================================================================
ARCHIVO: backend\routes\dashboardRoutes.js
==================================================================
// backend/routes/dashboardRoutes.js

import express from 'express';
import dashboardController from '../controllers/dashboardController.js';
import { protect, admin } from '../middleware/authMiddleware.js';

const router = express.Router();

/**
 * @route   GET /api/dashboard/admin-kpis
 * @desc    Obtener los 4 KPIs (contadores)
 */
router.get(
    '/admin-kpis',
    [ protect, admin ],
    dashboardController.getAdminKPIs
);

/**
 * @route   GET /api/dashboard/admin-actividades
 * @desc    Obtener lista Top 5 de actividades pendientes
 */
router.get(
    '/admin-actividades',
    [ protect, admin ],
    dashboardController.getAdminActividadesPendientes
);

/**
 * @route   GET /api/dashboard/admin-actividades-estado
 * @desc    Obtener datos para gr√°fica de estados de actividades (NUEVO)
 */
router.get(
    '/admin-actividades-estado',
    [ protect, admin ],
    dashboardController.getAdminActividadesEstado
);

/**
 * @route   GET /api/dashboard/admin-reportes
 * @desc    Obtener lista Top 5 de reportes nuevos
 */
router.get(
    '/admin-reportes',
    [ protect, admin ],
    dashboardController.getAdminReportesRecientes
);

/**
 * @route   GET /api/dashboard/super-admin
 * @desc    Data completa para Super Admin
 */
router.get(
    '/super-admin',
    [ protect, admin ], 
    dashboardController.getSuperAdminData
);

export default router;


==================================================================
ARCHIVO: backend\routes\documentRoutes.js
==================================================================
// backend/routes/documentRoutes.js

import express from 'express';
import { check } from 'express-validator';
import documentController from '../controllers/documentController.js';
import { protect, admin } from '../middleware/authMiddleware.js';
import dmsUpload from '../middleware/dmsFileUpload.js'; 

const router = express.Router();

// --- Rutas de Carpetas (CU-25) ---
router.get(
    '/carpeta/:id', 
    [ protect, admin ], 
    documentController.getContenidoCarpeta
);

router.post(
    '/carpeta', 
    [ protect, admin ],
    [
        check('nombreCarpeta', 'El nombre de la carpeta es obligatorio').not().isEmpty(),
        check('idCarpetaPadre', 'El ID de la carpeta padre es obligatorio').isInt()
    ],
    documentController.crearCarpeta
);

router.delete(
    '/carpeta/:id', 
    [ protect, admin ], 
    documentController.eliminarCarpeta
);


// --- Rutas de Archivos (CU-26, 27, 28) ---
router.post(
    '/upload', 
    [ protect, admin ], 
    dmsUpload.array('archivos'), 
    documentController.subirArchivos
);

router.get(
    '/descargar/:id', 
    [ protect, admin ], 
    documentController.descargarDocumento
);

router.delete(
    '/documento/:id',
    [ protect, admin ],
    documentController.eliminarDocumento
);

/**
 * @route   GET /api/documentos/stream/:id
 * @desc    Obtiene un archivo para visualizarlo (inline) (Tanda 3.D)
 * @access  Privado (Admin)
 */
router.get(
    '/stream/:id',
    [ protect, admin ],
    documentController.streamDocumento 
);

export default router;


==================================================================
ARCHIVO: backend\routes\historyRoutes.js
==================================================================
// backend/routes/historyRoutes.js
import express from 'express';
import historyController from '../controllers/historyController.js';
import { protect, admin } from '../middleware/authMiddleware.js';

const router = express.Router();

// CAMBIO: El par√°metro ahora se llama :cedula
router.get('/colaborador/:cedula', [protect, admin], historyController.getHistorialColaborador);
router.get('/activo/:id', [protect, admin], historyController.getHistorialActivo);

export default router;


==================================================================
ARCHIVO: backend\routes\indicatorRoutes.js
==================================================================
// backend/routes/indicatorRoutes.js
import express from 'express';
import indicatorController from '../controllers/indicatorController.js';
import { protect, admin } from '../middleware/authMiddleware.js';

const router = express.Router();

router.post('/', [protect, admin], indicatorController.guardarIndicador);
router.get('/:anio', [protect, admin], indicatorController.getIndicadoresAnuales);
router.delete('/registro/:id', [protect, admin], indicatorController.eliminarRegistro);

// Rutas de Configuraci√≥n
router.get('/config/todos', [protect, admin], indicatorController.getConfiguraciones);
router.post('/config', [protect, admin], indicatorController.crearConfiguracion);
router.put('/config/:id', [protect, admin], indicatorController.editarConfiguracion); // <--- NUEVA RUTA
router.delete('/config/:id', [protect, admin], indicatorController.eliminarConfiguracion);

export default router;


==================================================================
ARCHIVO: backend\routes\inspectionRoutes.js
==================================================================
// backend/routes/inspectionRoutes.js
import express from 'express';
import { check } from 'express-validator';
import inspectionController from '../controllers/inspectionController.js';
import { protect, admin } from '../middleware/authMiddleware.js';

const router = express.Router();

// ============================================================
// 1. RUTAS ESPEC√çFICAS (Deben ir PRIMERO)
// ============================================================

// Obtener tipos de activos √∫nicos (Para el modal de crear)
router.get('/activos/tipos-unicos', [ protect, admin ], inspectionController.getTiposUnicos);

// Obtener lista de formularios (Esta era la que fallaba)
router.get('/formularios', [ protect ], inspectionController.getFormularios);

// Crear nuevo formulario
router.post('/formularios', [ protect, admin ], [], inspectionController.crearNuevoFormulario);

// Obtener preguntas de un formulario espec√≠fico
router.get('/formularios/:idFormulario/preguntas', [ protect ], inspectionController.getPreguntasFormulario);

// Agregar pregunta a un formulario
router.post('/formularios/:id/preguntas', [ protect, admin ], [], inspectionController.agregarPregunta);

// Cambiar visibilidad de un formulario
router.patch('/formularios/:id/visibilidad', [ protect, admin ], inspectionController.toggleVisibilidad);

// Editar formulario (PUT)
router.put('/formularios/:id', 
    [ protect, admin ], 
    [
        check('nombreFormulario', 'Nombre obligatorio').not().isEmpty(),
        check('tipoActivoAsociado', 'Tipo de activo obligatorio').not().isEmpty()
    ],
    inspectionController.editarFormulario
);

// Eliminar formulario (DELETE)
router.delete('/formularios/:id', [ protect, admin ], inspectionController.eliminarFormulario);

// ============================================================
// 2. RUTAS GENERALES DE INSPECCI√ìN
// ============================================================

// Crear una inspecci√≥n (Diligenciar)
router.post('/', [ protect, admin ], [], inspectionController.crearInspeccion);

// Obtener historial de inspecciones
router.get('/', [ protect, admin ], inspectionController.getInspeccionesHistorial);

// Eliminar pregunta (Ruta espec√≠fica de preguntas)
router.delete('/preguntas/:id', [ protect, admin ], inspectionController.eliminarPregunta);


// ============================================================
// 3. RUTAS DIN√ÅMICAS (Deben ir AL FINAL)
// ============================================================

// Obtener detalle de una inspecci√≥n por ID
// ¬°IMPORTANTE! Esta ruta atrapa todo lo que sea /api/inspecciones/ALGO
// Por eso debe ir al final, para no atrapar "formularios" o "activos".
router.get('/:id', [ protect, admin ], inspectionController.getInspeccionDetalle);

export default router;


==================================================================
ARCHIVO: backend\routes\logRoutes.js
==================================================================
// backend/src/routes/logRoutes.js

import express from 'express';
import logController from '../controllers/logController.js';
import { protect, admin } from '../middleware/authMiddleware.js';

const router = express.Router();

/**
 * @route   GET /api/logs/filtros
 * @desc    Obtener las listas para los dropdowns de filtro
 * @access  Privado (Admin)
 */
router.get(
    '/filtros',
    [ protect, admin ],
    logController.getLogFiltros
);

/**
 * @route   POST /api/logs/buscar
 * @desc    Obtener el historial de auditor√≠a (filtrado)
 * @access  Privado (Admin)
 */
router.post(
    '/buscar', // Cambiado de GET / a POST /buscar
    [ protect, admin ],
    logController.getLogs
);

export default router;


==================================================================
ARCHIVO: backend\routes\medicalRoutes.js
==================================================================
// backend/routes/medicalRoutes.js

import express from 'express';
import { check } from 'express-validator';
import medicalController from '../controllers/medicalController.js';
import { protect, admin } from '../middleware/authMiddleware.js';
const router = express.Router();

// GET /api/medicina (Historial)
router.get(
    '/',
    [ protect, admin ],
    medicalController.getHistorialExamenes
);

// POST /api/medicina (Registrar)
router.post(
    '/',
    [ protect, admin ],
    [ 
        check('nombreColaborador', 'El nombre del colaborador es obligatorio').not().isEmpty(),
        check('cedulaColaborador', 'La c√©dula del colaborador es obligatoria').not().isEmpty(),
        check('tipoExamen', 'El tipo de examen es obligatorio').not().isEmpty(),
        check('fechaExamen', 'La fecha de examen es obligatoria').isISO8601(),
        check('conceptoAptitud', 'El concepto de aptitud es obligatorio').not().isEmpty()
    ],
    medicalController.crearExamenMedico
);

// GET /api/medicina/:id (Obtener detalle)
router.get(
    '/:id',
    [ protect, admin ],
    medicalController.getExamenMedicoDetalle 
);

// --- CAMBIO AQU√ç: POST en lugar de GET para recibir datos del encabezado ---
router.post(
    '/:id/pdf',
    [ protect, admin ],
    medicalController.generarPdfRecomendaciones 
);

export default router;


==================================================================
ARCHIVO: backend\routes\notificationRoutes.js
==================================================================
// backend/routes/notificationRoutes.js
import express from 'express';
import notificationController from '../controllers/notificationController.js';
import { protect } from '../middleware/authMiddleware.js';

const router = express.Router();

router.get('/', [protect], notificationController.getMisNotificaciones);
router.patch('/:id/leida', [protect], notificationController.marcarLeida);
router.patch('/:id/ocultar', [protect], notificationController.ocultarNotificacion); // <--- NUEVA RUTA

export default router;


==================================================================
ARCHIVO: backend\routes\pesvRoutes.js
==================================================================
// backend/routes/pesvRoutes.js

import express from 'express';
import pesvController from '../controllers/pesvController.js';
import { protect, admin } from '../middleware/authMiddleware.js';
import upload from '../middleware/fileUpload.js';

const router = express.Router();

// Conductores
router.get('/conductores', [protect, admin], pesvController.getConductoresPESV);
router.post('/conductores', [protect, admin], upload.single('archivoLicencia'), pesvController.guardarInfoConductor);

// Mantenimientos
router.get('/mantenimientos', [protect, admin], pesvController.getMantenimientos);

// --- CAMBIO AQU√ç: Agregamos upload.single('evidencia') ---
router.post('/mantenimientos', 
    [protect, admin], 
    upload.single('evidencia'), // Permite recibir el archivo
    pesvController.crearMantenimiento
);

// Pasos PESV
router.get('/pasos', [protect, admin], pesvController.getPasosPESV);
router.get('/pasos/:id/evidencias', [protect, admin], pesvController.getEvidenciasPorPaso);

// Documentos Internos
router.get('/documentos-internos', [protect], pesvController.getDocumentosGenerados);

// Actualizaciones
router.post('/pasos/actualizar', [protect, admin], upload.single('evidencia'), pesvController.actualizarPasoPESV);
router.put('/evidencias/reemplazar', [protect, admin], upload.single('evidencia'), pesvController.reemplazarEvidencia);

// Plantillas y Generaci√≥n
router.post('/plantilla', [protect, admin], pesvController.guardarConfiguracionPlantilla);
router.get('/plantilla/:id', [protect, admin], pesvController.getPlantillaPaso);
router.post('/pasos/generar', [protect, admin], pesvController.generarDocumentoPaso);

// CRUD Pasos
router.post('/pasos/crear', [protect, admin], pesvController.crearPaso);
router.put('/pasos/editar', [protect, admin], pesvController.editarPasoInfo);
router.delete('/pasos/:id', [protect, admin], pesvController.eliminarPaso);

// Descarga
router.get('/download/:filename', pesvController.descargarArchivo);

export default router;


==================================================================
ARCHIVO: backend\routes\reportRoutes.js
==================================================================
// backend/routes/reportRoutes.js

import express from 'express';
import { check } from 'express-validator';
import reportController from '../controllers/reportController.js';
import { protect, admin } from '../middleware/authMiddleware.js'; 
import upload from '../middleware/fileUpload.js'; 

const router = express.Router();

// --- Rutas Colaborador (Crear Reportes) ---
router.post('/maquina', 
    [ protect ], 
    upload.single('fotoReporte'), 
    [ 
        check('idActivo', 'Debe seleccionar una m√°quina').not().isEmpty().isInt(),
        check('estadoReportado', 'El estado es obligatorio').isIn(['OK', 'Con Problema'])
    ],
    reportController.crearReporteMaquina
);

router.post('/seguridad', 
    [ protect ], 
    upload.single('fotoReporte'), 
    [
        check('tipoReporte', 'Obligatorio').not().isEmpty(),
        check('ubicacionArea', 'Obligatorio').not().isEmpty(),
        check('descripcion', 'Obligatorio').not().isEmpty()
    ],
    reportController.crearReporteSeguridad
);

// --- Rutas Colaborador (Ver Mis Reportes) ---
router.get('/maquina/mis-reportes', [ protect ], reportController.getMisReportesMaquina);
router.get('/seguridad/mis-reportes', [ protect ], reportController.getMisReportesSeguridad);

// --- Rutas Generales (Admin Listas) ---
router.get('/maquina', [ protect, admin ], reportController.getReportesMaquina);
router.get('/seguridad', [ protect, admin ], reportController.getReportesSeguridad);

// --- Rutas Detalle (Acceso mixto: Admin revisa, Colaborador solo lee) ---
// NOTA: Se quit√≥ el middleware 'admin' para permitir acceso al colaborador
router.get('/maquina/:id', [ protect ], reportController.getReporteMaquinaDetalle);
router.get('/seguridad/:id', [ protect ], reportController.getReporteSeguridadDetalle);

export default router;


==================================================================
ARCHIVO: backend\routes\requestRoutes.js
==================================================================
// backend/routes/requestRoutes.js

import express from 'express';
import requestController from '../controllers/requestController.js';
import { protect, admin } from '../middleware/authMiddleware.js';
import upload from '../middleware/fileUpload.js';

const router = express.Router();

// Crear solicitud (SST env√≠a archivo opcional)
router.post('/', 
    [protect], 
    upload.single('archivo'), 
    requestController.crearSolicitud
);

// Leer solicitudes
router.get('/', 
    [protect], 
    requestController.getSolicitudes
);

// Responder y Firmar (Super Admin env√≠a imagen de firma opcional)
router.put('/responder', 
    [protect, admin], 
    upload.single('firma'), 
    requestController.responderSolicitud
);

// Actualizar documento firmado manualmente (Reemplazar archivo)
router.post('/actualizar-doc', 
    [protect, admin], 
    upload.single('archivo'), 
    requestController.actualizarDocumentoFirmado
);

export default router;


==================================================================
ARCHIVO: backend\routes\scheduleRoutes.js
==================================================================
// backend/src/routes/scheduleRoutes.js

import express from 'express';
import { check } from 'express-validator';
import scheduleController from '../controllers/scheduleController.js';
import { protect, admin } from '../middleware/authMiddleware.js';

const router = express.Router();

// POST /api/cronogramas (Crear Cronograma)
router.post(
    '/',
    [ protect, admin ],
    [
        check('nombreCronograma', 'El nombre del cronograma es obligatorio').not().isEmpty()
    ],
    scheduleController.crearCronograma
);

// GET /api/cronogramas (Listar Cronogramas Activos)
router.get(
    '/',
    [ protect, admin ],
    scheduleController.getCronogramas
);

/**
 * @route   DELETE /api/cronogramas/:id
 * @desc    Eliminar (Soft Delete) un cronograma
 * @access  Privado (Admin)
 */
router.delete(
    '/:id',
    [ protect, admin ],
    scheduleController.eliminarCronograma // <--- NUEVA RUTA
);


// --- Rutas de Actividades ---
router.post(
    '/:id/actividades',
    [ protect, admin ],
    [
        check('nombreActividad', 'El nombre de la actividad es obligatorio').not().isEmpty(),
        check('fechaLimite', 'La fecha l√≠mite es obligatoria y debe ser una fecha v√°lida').isISO8601(),
        check('idUsuarioResponsable', 'El responsable es obligatorio').isInt()
    ],
    scheduleController.crearActividad
);

router.get(
    '/:id/actividades',
    [ protect, admin ],
    scheduleController.getActividadesPorCronograma
);

export default router;


==================================================================
ARCHIVO: backend\routes\userRoutes.js
==================================================================
// backend/routes/userRoutes.js

import express from 'express';
import { check } from 'express-validator';
import userController from '../controllers/userController.js';
import { protect, admin } from '../middleware/authMiddleware.js';

const router = express.Router();

// 1. RUTA PARA API EXTERNA (GOSEN)
router.get(
    '/externos/buscar', 
    [ protect, admin ], 
    userController.buscarDirectorioExterno
);

// 2. OBTENER ROLES
router.get(
    '/roles',
    [ protect, admin ],
    userController.getRoles
);

// 3. OBTENER CARGOS (NUEVA RUTA)
// IMPORTANTE: Debe ir antes de las rutas con :id para no confundirse
router.get(
    '/cargos',
    [ protect, admin ],
    userController.getCargosEmpresa
);

// 4. CREAR USUARIO
router.post(
    '/',
    [ protect, admin ],
    [
        check('nombreCompleto', 'El nombre completo es obligatorio').not().isEmpty(),
        check('cedula', 'La c√©dula (usuario) es obligatoria').not().isEmpty(),
        check('password', 'La contrase√±a temporal es obligatoria').not().isEmpty(),
        check('idRol', 'El rol es obligatorio').isInt()
    ],
    userController.crearColaborador
);

// 5. LISTAR USUARIOS (Gesti√≥n)
router.get(
    '/',
    [ protect, admin ],
    userController.getColaboradores
);

// 6. LISTAR TODOS (Selectores)
router.get(
    '/todos',
    [ protect, admin ], 
    userController.getTodosUsuarios
);

// 7. OBTENER POR C√âDULA
router.get(
    '/cedula/:cedula',
    [ protect, admin ],
    userController.getUsuarioPorCedula
);

// 8. EDITAR USUARIO
router.put(
    '/:id', 
    [ protect, admin ],
    [
        check('nombreCompleto', 'El nombre completo es obligatorio').not().isEmpty()
    ],
    userController.editarColaborador
);

// 9. CAMBIAR ESTADO (ACTIVAR/INACTIVAR)
router.patch(
    '/:id/estado',
    [ protect, admin ],
    [
        check('estado', 'El estado es obligatorio').isIn(['Activo', 'Inactivo'])
    ],
    userController.cambiarEstadoColaborador
);

// 10. RESETEAR PASSWORD
router.patch(
    '/:id/reset-password',
    [ protect, admin ],
    [
        check('password', 'La nueva contrase√±a es obligatoria').not().isEmpty()
    ],
    userController.resetPasswordColaborador
);

// 11. ACTUALIZAR EMAIL (PERFIL)
router.patch(
    '/perfil/email',
    [ protect ], // Cualquier usuario logueado puede actualizar su email
    userController.actualizarPerfilEmail
);

export default router;


==================================================================
ARCHIVO: backend\server.js
==================================================================
// backend/server.js

import express from 'express';
import cors from 'cors';
import 'dotenv/config'; 
import path from 'path';
import { fileURLToPath } from 'url';
import { initCronJobs } from './services/cronService.js';
import { verificarConexionCorreo } from './config/mailer.js'; // <--- NUEVO

// --- Importaci√≥n de Rutas (ESM) ---
import authRoutes from './routes/authRoutes.js';
import userRoutes from './routes/userRoutes.js';
import scheduleRoutes from './routes/scheduleRoutes.js';
import activityRoutes from './routes/activityRoutes.js';
import inspectionRoutes from './routes/inspectionRoutes.js';
import reportRoutes from './routes/reportRoutes.js';
import acpmRoutes from './routes/acpmRoutes.js'; 
import assetRoutes from './routes/assetRoutes.js'; 
import dashboardRoutes from './routes/dashboardRoutes.js';
import documentRoutes from './routes/documentRoutes.js';
import medicalRoutes from './routes/medicalRoutes.js';
import logRoutes from './routes/logRoutes.js';
import notificationRoutes from './routes/notificationRoutes.js';
import indicatorRoutes from './routes/indicatorRoutes.js';
import pesvRoutes from './routes/pesvRoutes.js';
import requestRoutes from './routes/requestRoutes.js';
import collabDocsRoutes from './routes/collabDocsRoutes.js';
import committeeRoutes from './routes/committeeRoutes.js'
import budgetRoutes from './routes/budgetRoutes.js';
import historyRoutes from './routes/historyRoutes.js'; 

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const port = process.env.PORT || 5000;

// --- Middlewares ---
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true })); 

// --- Middleware de Archivos Est√°ticos ---
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));

// --- Definici√≥n de Rutas de la API ---
app.use('/api/auth', authRoutes);
app.use('/api/usuarios', userRoutes);
app.use('/api/cronogramas', scheduleRoutes);
app.use('/api/actividades', activityRoutes);
app.use('/api/inspecciones', inspectionRoutes);
app.use('/api/reportes', reportRoutes);
app.use('/api/acpm', acpmRoutes); 
app.use('/api/activos', assetRoutes);
app.use('/api/dashboard', dashboardRoutes);
app.use('/api/documentos', documentRoutes);
app.use('/api/medicina', medicalRoutes);
app.use('/api/logs', logRoutes);
app.use('/api/notificaciones', notificationRoutes);
app.use('/api/indicadores', indicatorRoutes);
app.use('/api/pesv', pesvRoutes);
app.use('/api/solicitudes', requestRoutes);
app.use('/api/colaboradores-docs', collabDocsRoutes);
app.use('/api/actas', committeeRoutes);
app.use('/api/presupuesto', budgetRoutes);
app.use('/api/historial', historyRoutes);

// --- Inicializadores ---
initCronJobs();
verificarConexionCorreo(); // <--- INICIALIZAR CORREO

app.listen(port, () => {
    console.log(`üöÄ Servidor corriendo exitosamente en el puerto ${port}`);
});


==================================================================
ARCHIVO: backend\services\cronService.js
==================================================================
// backend/services/cronService.js

import cron from 'node-cron';
import { poolPromise, mssql } from '../config/dbConfig.js';
import { crearNotificacion } from './notificationService.js';

const ejecutarAlertasAutomaticas = async () => {
    console.log('‚è∞ Ejecutando verificaci√≥n de alertas (Cron Job)...');
    try {
        const pool = await poolPromise;

        // 1. ALERTAS DE ACTIVIDADES (Ya exist√≠a)
        const actResult = await pool.request().query('EXEC SP_CHECK_Alertas_Actividades');
        for (const act of actResult.recordset) {
            await crearNotificacion({
                idUsuarioDestino: act.ID_UsuarioResponsable,
                titulo: '‚ö†Ô∏è Actividad por Vencer',
                mensaje: `La actividad "${act.NombreActividad}" vence pronto.`,
                ruta: '/planificacion'
            });
        }

        // 2. ALERTAS DE ACPM (Ya exist√≠a)
        const acpmResult = await pool.request().query('EXEC SP_CHECK_Alertas_ACPM');
        for (const acpm of acpmResult.recordset) {
            await crearNotificacion({
                idUsuarioDestino: acpm.ID_UsuarioResponsable,
                titulo: 'üìã ACPM Pendiente',
                mensaje: `Acci√≥n "${acpm.Origen}" requiere gesti√≥n.`,
                ruta: '/acpm'
            });
        }

        // 3. NUEVA ALERTA: RECOMENDACIONES M√âDICAS POR VENCER
        // (Usa el SP nuevo que creamos en el script SQL)
        const medResult = await pool.request().query('EXEC SP_CHECK_Alertas_Recomendaciones');
        
        for (const med of medResult.recordset) {
            const dias = med.DiasRestantes;
            let titulo = '';
            let mensaje = '';

            if (dias < 0) {
                titulo = 'üî¥ Recomendaciones Vencidas';
                mensaje = `Las recomendaciones de ${med.NombreColaborador} vencieron hace ${Math.abs(dias)} d√≠as.`;
            } else if (dias === 0) {
                titulo = '‚ö†Ô∏è Recomendaciones Vencen HOY';
                mensaje = `Las recomendaciones de ${med.NombreColaborador} terminan hoy.`;
            } else {
                titulo = '‚è≥ Recomendaciones por Terminar';
                mensaje = `Las recomendaciones de ${med.NombreColaborador} finalizan el ${new Date(med.FechaFinRecomendaciones).toLocaleDateString()}.`;
            }

            // Notifica al Admin SST
            await crearNotificacion({
                rolDestino: 'Administrador SST',
                titulo: titulo,
                mensaje: mensaje,
                ruta: '/medicina'
            });
        }

        console.log('‚úÖ Verificaci√≥n de alertas completada.');

    } catch (error) {
        console.error('‚ùå Error en Cron Job:', error);
    }
};

export const initCronJobs = () => {
    // Ejecutar todos los d√≠as a las 08:00 AM
    cron.schedule('0 8 * * *', () => {
        ejecutarAlertasAutomaticas();
    });
    console.log('üïí Servicio de Cron Jobs iniciado (08:00 AM diario).');
};


==================================================================
ARCHIVO: backend\services\externalApiService.js
==================================================================
// backend/services/externalApiService.js
import axios from 'axios';

// No necesitamos API Key para localhost por ahora
const API_URL = process.env.EXTERNAL_API_URL || 'http://localhost:4000/api/gosen';

export const buscarEnDirectorioExterno = async (termino) => {
    try {
        // Petici√≥n al microservicio: GET http://localhost:4000/api/gosen/empleados?q=...
        const response = await axios.get(`${API_URL}/empleados`, {
            params: { q: termino },
            timeout: 3000 // Si en 3 seg no responde, cancelamos
        });
        return response.data;
    } catch (error) {
        console.error("Error llamando a API Gosen (B√∫squeda):", error.message);
        return []; // Retorna vac√≠o si falla la conexi√≥n
    }
};

// --- NUEVA FUNCI√ìN PARA PESV ---
export const obtenerConductoresGosen = async () => {
    try {
        const response = await axios.get(`${API_URL}/conductores-activos`, {
            timeout: 5000 
        });
        return response.data;
    } catch (error) {
        console.error("Error obteniendo conductores de Gosen:", error.message);
        return []; 
    }
};


==================================================================
ARCHIVO: backend\services\logService.js
==================================================================
// backend/src/services/logService.js
import { poolPromise, mssql } from '../config/dbConfig.js';

/**
 * @service   logAction
 * @desc      Registra una acci√≥n de administrador en la tabla AuditLog.
 * @param {number} idUsuario - El ID del usuario que realiza la acci√≥n (del token).
 * @param {string} nombreUsuario - El nombre del usuario (del token).
 * @param {string} accion - Un c√≥digo de acci√≥n (ej. "CREAR_USUARIO").
 * @param {string} descripcion - Un texto legible (ej. "Cre√≥ al usuario Pepito Perez (ID: 12)").
 */
export const logAction = async (idUsuario, nombreUsuario, accion, descripcion) => {
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idUsuario', mssql.Int, idUsuario)
            .input('nombreUsuario', mssql.NVarChar, nombreUsuario)
            .input('accion', mssql.NVarChar, accion)
            .input('descripcion', mssql.NVarChar, descripcion)
            .query('EXEC SP_CREATE_AuditLog @idUsuario, @nombreUsuario, @accion, @descripcion');
    } catch (err) {
        // Si el log falla, no queremos que la aplicaci√≥n principal se caiga.
        // Solo lo registramos en la consola del servidor.
        console.error('CRITICAL: Falla al escribir en AuditLog.', err.message);
    }
};


==================================================================
ARCHIVO: backend\services\notificationService.js
==================================================================
// backend/services/notificationService.js

import { poolPromise, mssql } from '../config/dbConfig.js';
import { transporter } from '../config/mailer.js';

// --- CONFIGURACI√ìN DEL LOGO ---
// Usamos el enlace directo que acabamos de obtener
const LOGO_URL = "https://i.ibb.co/27GMjSQM/logo.png";

/**
 * @desc Crea una notificaci√≥n en la BD y env√≠a un correo espejo.
 */
export const crearNotificacion = async ({ idUsuarioDestino, rolDestino, titulo, mensaje, ruta }) => {
    try {
        const pool = await poolPromise;

        // 1. Guardar en Base de Datos (Para la campana del header)
        await pool.request()
            .input('idUsuarioDestino', mssql.Int, idUsuarioDestino || null)
            .input('rolDestino', mssql.NVarChar, rolDestino || null)
            .input('titulo', mssql.NVarChar, titulo)
            .input('mensaje', mssql.NVarChar, mensaje)
            .input('rutaAccion', mssql.NVarChar, ruta || null)
            .query('EXEC SP_CREATE_Notificacion @idUsuarioDestino, @rolDestino, @titulo, @mensaje, @rutaAccion');

        // 2. Enviar Correo Electr√≥nico (Proceso en segundo plano)
        enviarCorreoEspejo({ idUsuarioDestino, rolDestino, titulo, mensaje });

    } catch (err) {
        console.error('Error creando notificaci√≥n/correo:', err.message);
    }
};

/**
 * @desc Env√≠a el correo usando la URL del logo en la nube
 */
const enviarCorreoEspejo = async ({ idUsuarioDestino, rolDestino, titulo, mensaje }) => {
    try {
        const pool = await poolPromise;
        let destinatarios = [];

        // A. Obtener emails de la BD
        if (idUsuarioDestino) {
            // Caso: Usuario espec√≠fico
            const res = await pool.request()
                .input('idUsuario', mssql.Int, idUsuarioDestino)
                .query('SELECT Email FROM Usuarios WHERE ID_Usuario = @idUsuario');
            
            if (res.recordset.length > 0 && res.recordset[0].Email) {
                destinatarios.push(res.recordset[0].Email);
            }
        } else if (rolDestino) {
            // Caso: Rol completo (ej. Admin SST)
            const res = await pool.request()
                .input('nombreRol', mssql.NVarChar, rolDestino)
                .query(`
                    SELECT U.Email 
                    FROM Usuarios U
                    JOIN Roles R ON U.ID_Rol = R.ID_Rol
                    WHERE R.NombreRol = @nombreRol 
                      AND U.EstadoCuenta = 'Activo'
                      AND U.Email IS NOT NULL
                `);
            
            destinatarios = res.recordset.map(row => row.Email);
        }

        if (destinatarios.length === 0) return;

        // B. Configurar correo
        const mailOptions = {
            from: `"Sistema SG-SST" <${process.env.MAIL_USER}>`,
            to: destinatarios,
            subject: `üîî Novedad SG-SST: ${titulo}`,
            html: `
                <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 600px; margin: 0 auto; padding: 0; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #ffffff; overflow: hidden;">
                    
                    <div style="background-color: #f8f9fa; padding: 20px; text-align: center; border-bottom: 3px solid #005A5B;">
                        <img src="${LOGO_URL}" alt="Empaquetados El Trece" style="max-width: 150px; height: auto; display: block; margin: 0 auto;">
                    </div>
                    
                    <div style="padding: 30px 20px;">
                        <h2 style="color: #005A5B; margin-top: 0; font-size: 20px;">${titulo}</h2>
                        
                        <div style="background-color: #eef7ff; border-left: 4px solid #007BFF; padding: 15px; margin: 20px 0; border-radius: 4px;">
                            <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0;">
                                ${mensaje}
                            </p>
                        </div>

                        <p style="color: #555; font-size: 14px;">
                            Se ha registrado una novedad en el sistema que requiere tu atenci√≥n.
                        </p>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <a href="http://localhost:5173" style="background-color: #005A5B; color: white; padding: 12px 25px; text-decoration: none; border-radius: 50px; font-weight: bold; font-size: 14px;">Ir a la Plataforma</a>
                        </div>
                    </div>

                    <div style="background-color: #333; color: #aaa; padding: 15px; text-align: center; font-size: 11px;">
                        <p style="margin: 0;">Empaquetados El Trece S.A.S - Sistema de Gesti√≥n SST</p>
                    </div>
                </div>
            `
        };

        await transporter.sendMail(mailOptions);
        console.log(`üìß Correo enviado a: ${destinatarios.length} destinatarios.`);

    } catch (error) {
        console.error("‚ö†Ô∏è Error enviando correo espejo:", error.message);
    }
};


==================================================================
ARCHIVO: backend\utils\committeePdfGenerator.js
==================================================================
// backend/utils/committeePdfGenerator.js

import PDFDocument from 'pdfkit';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

export const generarActaComitePDF = (data, asistentes, compromisos, rutaSalida) => {
    return new Promise((resolve, reject) => {
        try {
            const listaAsistentes = Array.isArray(asistentes) ? asistentes : [];
            const listaCompromisos = Array.isArray(compromisos) ? compromisos : [];

            const directorio = path.dirname(rutaSalida);
            if (!fs.existsSync(directorio)) fs.mkdirSync(directorio, { recursive: true });

            const doc = new PDFDocument({ margin: 40, size: 'LETTER', bufferPages: true });
            const stream = fs.createWriteStream(rutaSalida);
            doc.pipe(stream);

            const fontBold = 'Helvetica-Bold';
            const fontReg = 'Helvetica';
            const black = '#000000';

            // --- 1. ENCABEZADO ---
            const logoPath = path.resolve(__dirname, '..', 'assets', 'logo.png'); 
            const startY = 40; // Posici√≥n vertical donde empieza todo
            const startX = 40;
            const col1W = 100; 
            const col2W = 280; 
            const col3W = 150; 
            const hHeader = 70;

            // Bordes Tabla Encabezado
            doc.rect(startX, startY, col1W + col2W + col3W, hHeader).stroke();
            doc.moveTo(startX + col1W, startY).lineTo(startX + col1W, startY + hHeader).stroke();
            doc.moveTo(startX + col1W + col2W, startY).lineTo(startX + col1W + col2W, startY + hHeader).stroke();
            
            const rowH = hHeader / 4;
            doc.moveTo(startX + col1W + col2W, startY + rowH).lineTo(startX + col1W + col2W + col3W, startY + rowH).stroke();
            doc.moveTo(startX + col1W + col2W, startY + rowH * 2).lineTo(startX + col1W + col2W + col3W, startY + rowH * 2).stroke();
            doc.moveTo(startX + col1W + col2W, startY + rowH * 3).lineTo(startX + col1W + col2W + col3W, startY + rowH * 3).stroke();

            // --- LOGO (Ajustado) ---
            // Si quieres subirlo m√°s, disminuye el valor sumado a startY (ej: startY + 1)
            if (fs.existsSync(logoPath)) {
                try {
                    doc.image(logoPath, startX + 10, startY + 6, { width: 80 }); 
                } catch (imgErr) { console.warn('Error cargando logo:', imgErr); }
            }
            
            // T√≠tulo Central
            doc.font(fontBold).fontSize(12).text('ACTA DE REUNI√ìN DE COMIT√â', startX + col1W, startY + 30, { width: col2W, align: 'center' });

            // Datos Control
            doc.font(fontBold).fontSize(8);
            doc.text(`C√ìDIGO: ${data.codigoDocumento || ''}`, startX + col1W + col2W + 5, startY + 7);
            doc.text(`FECHA EMISI√ìN: ${data.fechaEmision || ''}`, startX + col1W + col2W + 5, startY + rowH + 7);
            doc.text(`FECHA REVISI√ìN: ${data.fechaRevision || ''}`, startX + col1W + col2W + 5, startY + (rowH * 2) + 7);
            doc.text(`VERSI√ìN: ${data.version || ''}`, startX + col1W + col2W + 5, startY + (rowH * 3) + 7);

            doc.moveDown(5);

            // --- 2. DATOS GENERALES ---
            let y = doc.y;
            const labelX = 40;
            const valX = 110;
            
            doc.font(fontBold).fontSize(10).text('LUGAR:', labelX, y);
            doc.font(fontReg).text(data.lugar || '', valX, y);
            
            doc.font(fontBold).text('FECHA:', 280, y);
            doc.font(fontReg).text(data.fechaReunion || '', 330, y);

            doc.font(fontBold).text('N¬∞ ACTA:', 430, y);
            doc.font(fontReg).text(data.numeroActa || '', 480, y);
            
            y += 20;
            doc.font(fontBold).text('HORA INICIO:', labelX, y);
            doc.font(fontReg).text(data.horaInicio || '', valX, y);

            doc.font(fontBold).text('HORA FIN:', 280, y);
            doc.font(fontReg).text(data.horaFin || '', 330, y);

            y += 30;

            // --- 3. VERIFICACI√ìN QUORUM ---
            doc.font(fontBold).fontSize(11).fillColor(black).text('1. VERIFICACI√ìN DE QUORUM', 40, y);
            y += 20;
            doc.font(fontReg).fontSize(10).text('En el momento de dar inicio se deja constancia de los siguientes asistentes:', 40, y);
            y += 20;

            const asisCol1 = 180; 
            const asisCol2 = 150; 
            const rowHeight = 25;

            // Encabezados Tabla
            doc.rect(40, y, 530, 20).fill('#f0f0f0').stroke();
            doc.fillColor(black).font(fontBold).text('NOMBRE', 45, y + 6);
            doc.text('CARGO', 40 + asisCol1 + 5, y + 6);
            doc.text('FIRMA', 40 + asisCol1 + asisCol2 + 5, y + 6);
            y += 20;

            // Filas Asistentes
            doc.font(fontReg);
            listaAsistentes.forEach(asis => {
                // Margen de seguridad aumentado (680) para evitar salto autom√°tico al borde
                if (y + rowHeight > 680) { doc.addPage(); y = 50; }

                doc.rect(40, y, 530, rowHeight).stroke();
                doc.text(asis.Nombre || '', 45, y + 8, { width: asisCol1 - 10 });
                doc.moveTo(40 + asisCol1, y).lineTo(40 + asisCol1, y + rowHeight).stroke();
                doc.text(asis.Cargo || '', 40 + asisCol1 + 5, y + 8, { width: asisCol2 - 10 });
                doc.moveTo(40 + asisCol1 + asisCol2, y).lineTo(40 + asisCol1 + asisCol2, y + rowHeight).stroke();
                y += rowHeight;
            });

            y += 15;
            
            if (y + 20 > 680) { doc.addPage(); y = 50; }
            doc.font(fontReg).text('Por lo anterior se determina que existe el quorum para proceder y dar inicio a la reuni√≥n convocada.', 40, y);
            y += 30;

            // --- 4. OBJETIVO ---
            if (y + 60 > 680) { doc.addPage(); y = 50; }
            doc.font(fontBold).fontSize(11).text('2. OBJETIVO', 40, y);
            y += 15;
            doc.font(fontReg).fontSize(10).text(data.objetivo || 'Sin objetivo registrado.', 40, y, { align: 'justify', width: 510 });
            y = doc.y + 20;

            // --- 5. DESARROLLO ---
            if (y + 60 > 680) { doc.addPage(); y = 50; }
            doc.font(fontBold).fontSize(11).text('3. DESARROLLO DE LA REUNI√ìN', 40, y);
            y += 15;
            doc.font(fontReg).fontSize(10).text(data.desarrollo || 'Sin desarrollo registrado.', 40, y, { align: 'justify', width: 510 });
            y = doc.y + 20;

            // --- 6. COMPROMISOS ---
            if (y + 60 > 680) { doc.addPage(); y = 50; }
            doc.font(fontBold).fontSize(11).text('4. COMPROMISOS Y ACTIVIDADES PENDIENTES', 40, y);
            y += 15;

            const compCol1 = 270; 
            const compCol2 = 150; 
            
            // Encabezado Tabla
            doc.rect(40, y, 530, 20).fill('#f0f0f0').stroke();
            doc.fillColor(black).font(fontBold).text('COMPROMISO', 45, y + 6);
            doc.text('RESPONSABLE', 40 + compCol1 + 5, y + 6);
            doc.text('FECHA', 40 + compCol1 + compCol2 + 5, y + 6);
            y += 20;

            doc.font(fontReg);
            if (listaCompromisos.length === 0) {
                doc.rect(40, y, 530, 25).stroke();
                doc.text('No se establecieron compromisos.', 45, y + 8);
                y += 25;
            } else {
                listaCompromisos.forEach(comp => {
                    const textHeight = doc.heightOfString(comp.Compromiso || '', { width: compCol1 - 10 });
                    const currentRowH = Math.max(25, textHeight + 10);

                    // Verificaci√≥n proactiva de espacio
                    if (y + currentRowH > 680) {
                        doc.addPage(); y = 50;
                        doc.rect(40, y, 530, 20).fill('#f0f0f0').stroke();
                        doc.fillColor(black).font(fontBold).text('COMPROMISO', 45, y + 6);
                        doc.text('RESPONSABLE', 40 + compCol1 + 5, y + 6);
                        doc.text('FECHA', 40 + compCol1 + compCol2 + 5, y + 6);
                        y += 20;
                    }

                    doc.rect(40, y, 530, currentRowH).stroke();
                    doc.text(comp.Compromiso || '', 45, y + 5, { width: compCol1 - 10 });
                    doc.moveTo(40 + compCol1, y).lineTo(40 + compCol1, y + currentRowH).stroke();
                    doc.text(comp.Responsable || '', 40 + compCol1 + 5, y + 8, { width: compCol2 - 10 });
                    doc.moveTo(40 + compCol1 + compCol2, y).lineTo(40 + compCol1 + compCol2, y + currentRowH).stroke();
                    doc.text(comp.FechaEjecucion || '', 40 + compCol1 + compCol2 + 5, y + 8);
                    y += currentRowH;
                });
            }
            y += 30;

            // --- 7. CIERRE Y FIRMAS ---
            // Calculamos si caben las firmas (aprox 150px de altura necesaria)
            if (y + 150 > 680) { 
                doc.addPage(); 
                y = 50; 
            }
            
            doc.font(fontBold).fontSize(11).text('5. CIERRE DE LA REUNI√ìN', 40, y);
            y += 15;
            doc.font(fontReg).fontSize(10).text(`Siendo las ${data.horaFin || '...'} se da por terminada la reuni√≥n.`, 40, y);
            
            y += 80; // Espacio para firmar

            const firmaY = y;
            
            // Firma 1
            doc.text('_______________________________', 40, firmaY);
            doc.font(fontBold).text('PRESIDENTE', 40, firmaY + 10);
            doc.font(fontReg).text(data.nombrePresidente || '', 40, firmaY + 25);

            // Firma 2
            doc.text('_______________________________', 350, firmaY);
            doc.font(fontBold).text('SECRETARIO', 350, firmaY + 10);
            doc.font(fontReg).text(data.nombreSecretario || '', 350, firmaY + 25);

            // --- 8. NUMERACI√ìN DE P√ÅGINAS ---
            const range = doc.bufferedPageRange();
            for (let i = 0; i < range.count; i++) {
                doc.switchToPage(i);
                // Pie de p√°gina
                doc.font(fontReg).fontSize(8).text(
                    `P√°gina ${i + 1} de ${range.count}`, 
                    0, 
                    730, // Sub√≠ un poco el pie de p√°gina para alejarlo del borde
                    { align: 'center', width: 612 }
                );
            }

            doc.end();
            stream.on('finish', () => resolve(rutaSalida));
            stream.on('error', (err) => reject(err));

        } catch (error) {
            reject(error);
        }
    });
};


==================================================================
ARCHIVO: backend\utils\pdfGenerator.js
==================================================================
// backend/utils/pdfGenerator.js

import PDFDocument from 'pdfkit';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

export const generarActaPDF = (configuracion, datosUsuario, rutaSalida) => {
    return new Promise((resolve, reject) => {
        try {
            const directorio = path.dirname(rutaSalida);
            if (!fs.existsSync(directorio)) {
                fs.mkdirSync(directorio, { recursive: true });
            }

            // Margen de 40 puntos
            const doc = new PDFDocument({ margin: 40, size: 'LETTER', bufferPages: true });
            const stream = fs.createWriteStream(rutaSalida);

            doc.pipe(stream);

            const fontBold = 'Helvetica-Bold';
            const fontReg = 'Helvetica';
            const black = '#000000';

            // ==========================================
            // 1. ENCABEZADO ESTRUCTURADO (TABLA)
            // ==========================================
            
            const startY = 40; 
            const startX = 40; // Margen izquierdo
            const col1W = 100; // Ancho Logo
            const col2W = 280; // Ancho T√≠tulo
            const col3W = 150; // Ancho Datos Control
            const hHeader = 70; // Altura Total Header
            
            // Ancho √∫til de la p√°gina para el texto (Ancho total - M√°rgenes)
            // Letter width ~612. Margin 40 left + 40 right = 80. Content Width = 532.
            const contentWidth = 530; 

            // Dibujar L√≠neas de la Tabla del Encabezado
            doc.rect(startX, startY, col1W + col2W + col3W, hHeader).stroke(); // Borde exterior
            doc.moveTo(startX + col1W, startY).lineTo(startX + col1W, startY + hHeader).stroke(); // Divisor Logo-T√≠tulo
            doc.moveTo(startX + col1W + col2W, startY).lineTo(startX + col1W + col2W, startY + hHeader).stroke(); // Divisor T√≠tulo-Datos
            
            // L√≠neas horizontales de la columna de datos
            const rowH = hHeader / 4;
            doc.moveTo(startX + col1W + col2W, startY + rowH).lineTo(startX + col1W + col2W + col3W, startY + rowH).stroke();
            doc.moveTo(startX + col1W + col2W, startY + rowH * 2).lineTo(startX + col1W + col2W + col3W, startY + rowH * 2).stroke();
            doc.moveTo(startX + col1W + col2W, startY + rowH * 3).lineTo(startX + col1W + col2W + col3W, startY + rowH * 3).stroke();

            // --- LOGO ---
            const logoPath = path.resolve(__dirname, '..', 'assets', 'logo.png');
            if (fs.existsSync(logoPath)) {
                try {
                    doc.image(logoPath, startX + 10, startY + 4, { width: 80 }); 
                } catch (imgErr) { console.warn('Error cargando logo:', imgErr); }
            }

            // --- T√çTULO CENTRAL ---
            doc.font(fontBold).fontSize(11).fillColor(black)
               .text('PLAN ESTRAT√âGICO DE SEGURIDAD VIAL (PESV)', startX + col1W, startY + 20, { width: col2W, align: 'center' });
            
            // Subt√≠tulo din√°mico
            doc.fontSize(10).font(fontReg)
               .text(configuracion.titulo.toUpperCase(), startX + col1W, startY + 40, { width: col2W, align: 'center' });

            // --- DATOS DE CONTROL (DERECHA) ---
            doc.font(fontBold).fontSize(8);
            doc.text(`C√ìDIGO: ${configuracion.codigo || 'PESV-FTO-001'}`, startX + col1W + col2W + 5, startY + 7);
            doc.text(`FECHA EMISI√ìN: ${configuracion.fechaEmision || ''}`, startX + col1W + col2W + 5, startY + rowH + 7);
            doc.text(`FECHA REVISI√ìN: ${configuracion.fechaRevision || ''}`, startX + col1W + col2W + 5, startY + (rowH * 2) + 7);
            doc.text(`VERSI√ìN: ${configuracion.version || '1'}`, startX + col1W + col2W + 5, startY + (rowH * 3) + 7);

            // ==========================================
            // 2. CUERPO DEL DOCUMENTO (CORREGIDO)
            // ==========================================

            // --- IMPORTANTE: RESETEAR CURSOR ---
            // Forzamos X al margen izquierdo y Y debajo del header con un espacio
            doc.x = startX;
            doc.y = startY + hHeader + 40; 

            // --- CUERPO FIJO ---
            if (configuracion.cuerpo) {
                doc.font(fontReg).fontSize(11)
                   .text(configuracion.cuerpo, { 
                       align: 'justify', 
                       lineGap: 4,
                       width: contentWidth // Forzamos el ancho para que ocupe toda la p√°gina
                   });
                doc.moveDown(1.5);
            }

            // --- CAMPOS DIN√ÅMICOS ---
            if (configuracion.camposLlenos && configuracion.camposLlenos.length > 0) {
                // T√≠tulo de secci√≥n
                doc.font(fontBold).fontSize(11).text('INFORMACI√ìN ESPEC√çFICA:', { underline: true });
                doc.moveDown(0.5);

                // Lista de campos
                configuracion.camposLlenos.forEach(campo => {
                    // Usamos continued: true para que valor quede al lado de la etiqueta
                    doc.font(fontBold).text(`‚Ä¢ ${campo.label}: `, { continued: true });
                    doc.font(fontReg).text(campo.valor);
                    doc.moveDown(0.3);
                });
                doc.moveDown(2);
            }

            // ==========================================
            // 3. FIRMAS
            // ==========================================
            
            // Verificar espacio disponible para firmas
            if (doc.y > 600) doc.addPage();
            
            const yFirmas = doc.y + 60; // Un poco m√°s de aire antes de las firmas

            // Firma 1 (Izquierda)
            doc.text('_____________________________', startX, yFirmas);
            doc.font(fontBold).text('L√çDER DEL PESV', startX, yFirmas + 15);
            
            // Firma 2 (Derecha - si aplica)
            const campoNombre = configuracion.camposLlenos.find(c => c.label.toLowerCase().includes('nombre') || c.label.toLowerCase().includes('responsable'));
            
            if (campoNombre) {
                const firmaDerechaX = 350;
                doc.text('_____________________________', firmaDerechaX, yFirmas);
                doc.font(fontBold).text(campoNombre.valor.toUpperCase(), firmaDerechaX, yFirmas + 15);
                doc.font(fontReg).text('Firma Responsable', firmaDerechaX, yFirmas + 30);
            }

            // ==========================================
            // 4. NUMERACI√ìN DE P√ÅGINAS (PIE)
            // ==========================================
            const range = doc.bufferedPageRange();
            for (let i = 0; i < range.count; i++) {
                doc.switchToPage(i);
                doc.fontSize(8).fillColor('#6c757d')
                   .text(`P√°gina ${i + 1} de ${range.count}`, 0, 730, { align: 'center', width: 612 }); // Centrado en p√°gina (612pt)
            }

            doc.end();
            stream.on('finish', () => resolve(true));
            stream.on('error', (err) => reject(err));

        } catch (error) { reject(error); }
    });
};


==================================================================
ARCHIVO: backend\utils\seedAdmin.js
==================================================================
// backend/utils/seedAdmin.js

import bcrypt from 'bcryptjs';
import { poolPromise, mssql } from '../config/dbConfig.js';
import 'dotenv/config'; 

const seedAdmin = async () => {
    console.log('Iniciando script para sembrar Admin SST (Modo Seguro)...');

    // 1. Leer credenciales del entorno
    // Usamos los valores del .env, o un fallback seguro vac√≠o para forzar el error si faltan
    const adminData = {
        nombre: "Administrador Principal",
        cedula: process.env.ADMIN_CEDULA,
        passwordPlano: process.env.ADMIN_PASSWORD
    };

    // Validaci√≥n de seguridad
    if (!adminData.cedula || !adminData.passwordPlano) {
        console.error('‚ùå ERROR DE SEGURIDAD: Las variables ADMIN_CEDULA o ADMIN_PASSWORD no est√°n definidas en el archivo .env');
        process.exit(1);
    }

    try {
        const pool = await poolPromise;

        // 2. Verificar si existe
        const checkUser = await pool.request()
            .input('cedula', mssql.NVarChar, adminData.cedula)
            .query('SELECT ID_Usuario FROM Usuarios WHERE CedulaUsuario = @cedula');

        if (checkUser.recordset.length > 0) {
            console.log(`‚ÑπÔ∏è El usuario '${adminData.cedula}' ya existe. No se realizaron cambios.`);
            process.exit(0); 
        }

        // 3. Hashear
        console.log('Hasheando contrase√±a...');
        const salt = await bcrypt.genSalt(10);
        const passwordHash = await bcrypt.hash(adminData.passwordPlano, salt);

        // 4. Insertar (ID_Rol = 1 es Admin SST)
        const insertQuery = `
            INSERT INTO Usuarios (NombreCompleto, CedulaUsuario, PasswordHash, ID_Rol, EstadoCuenta, Cargo)
            VALUES (@nombre, @cedula, @hash, 1, 'Activo', 'Jefe SST')
        `;

        await pool.request()
            .input('nombre', mssql.NVarChar, adminData.nombre)
            .input('cedula', mssql.NVarChar, adminData.cedula)
            .input('hash', mssql.NVarChar, passwordHash)
            .query(insertQuery);

        console.log('-------------------------------------------');
        console.log('‚úÖ ¬°Usuario Administrador SST Creado!');
        console.log(`   Usuario: ${adminData.cedula}`);
        console.log('-------------------------------------------');

        process.exit(0);

    } catch (err) {
        console.error('‚ùå Error durante el sembrado del admin:', err.message);
        process.exit(1);
    }
};

seedAdmin();


==================================================================
ARCHIVO: backend\utils\seedSuperAdmin.js
==================================================================
// backend/utils/seedSuperAdmin.js

import bcrypt from 'bcryptjs';
import { poolPromise, mssql } from '../config/dbConfig.js';
import 'dotenv/config'; // Carga las variables del .env

const seedSuperAdmin = async () => {
    console.log('--- Configurando Super Admin (Modo Seguro) ---');

    // 1. Leer credenciales del entorno
    const usuario = process.env.SUPER_ADMIN_CEDULA;
    const passwordPlano = process.env.SUPER_ADMIN_PASSWORD;

    // Validaci√≥n de seguridad: Si no est√°n en el .env, detenemos el script
    if (!usuario || !passwordPlano) {
        console.error('‚ùå ERROR DE SEGURIDAD: Las variables SUPER_ADMIN_CEDULA o SUPER_ADMIN_PASSWORD no est√°n definidas en el archivo .env');
        process.exit(1);
    }

    try {
        const pool = await poolPromise;

        // 2. Buscar ID del Rol "Super Admin"
        const roleResult = await pool.request()
            .query("SELECT ID_Rol FROM Roles WHERE NombreRol = 'Super Admin'");
        
        if (roleResult.recordset.length === 0) {
            console.error('‚ùå ERROR: No existe el rol "Super Admin" en la BD. Ejecuta primero el script SQL de roles.');
            process.exit(1);
        }
        const idRolSuper = roleResult.recordset[0].ID_Rol;

        // 3. Hashear contrase√±a
        const salt = await bcrypt.genSalt(10);
        const passwordHash = await bcrypt.hash(passwordPlano, salt);

        // 4. Verificar existencia del usuario
        const userCheck = await pool.request()
            .input('cedula', mssql.NVarChar, usuario)
            .query('SELECT ID_Usuario FROM Usuarios WHERE CedulaUsuario = @cedula');

        if (userCheck.recordset.length > 0) {
            console.log('El usuario ya existe. Actualizando credenciales...');
            await pool.request()
                .input('cedula', mssql.NVarChar, usuario)
                .input('pass', mssql.NVarChar, passwordHash)
                .query(`UPDATE Usuarios SET PasswordHash = @pass, EstadoCuenta = 'Activo' WHERE CedulaUsuario = @cedula`);
        } else {
            console.log('Creando nuevo Super Admin...');
            await pool.request()
                .input('cedula', mssql.NVarChar, usuario)
                .input('pass', mssql.NVarChar, passwordHash)
                .input('rol', mssql.Int, idRolSuper)
                .query(`INSERT INTO Usuarios (NombreCompleto, CedulaUsuario, PasswordHash, ID_Rol, Cargo, EstadoCuenta) 
                        VALUES ('Super Administrador', @cedula, @pass, @rol, 'Gerencia TI', 'Activo')`);
        }

        console.log('‚úÖ √âXITO: Super Admin configurado desde variables de entorno.');
        process.exit(0);

    } catch (err) {
        console.error('‚ùå ERROR:', err.message);
        process.exit(1);
    }
};

seedSuperAdmin();


==================================================================
ARCHIVO: backend\utils\signer.js
==================================================================
// backend/utils/signer.js

import { PDFDocument, rgb, StandardFonts } from 'pdf-lib'; // Importamos rgb y fonts
import fs from 'fs';

export const estamparFirmaEnPDF = async (rutaPdfOriginal, rutaImagenFirma, rutaSalida, nombreFirmante, cargoFirmante) => {
    try {
        const pdfBytes = fs.readFileSync(rutaPdfOriginal);
        const pdfDoc = await PDFDocument.load(pdfBytes);
        const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);

        const firmaBytes = fs.readFileSync(rutaImagenFirma);
        let firmaImage;
        
        if (rutaImagenFirma.endsWith('.png')) {
            firmaImage = await pdfDoc.embedPng(firmaBytes);
        } else {
            firmaImage = await pdfDoc.embedJpg(firmaBytes);
        }

        const pages = pdfDoc.getPages();
        const lastPage = pages[pages.length - 1]; // Firmamos en la √∫ltima p√°gina
        const { width, height } = lastPage.getSize();

        // --- CONFIGURACI√ìN DE POSICI√ìN ---
        // Escalar firma (ajusta el 0.4 seg√∫n el tama√±o de tus im√°genes)
        const scale = 0.4; 
        const firmaDims = firmaImage.scale(scale);

        // Coordenadas: Abajo a la derecha
        const margenDerecho = 50;
        const margenInferior = 120; // Subimos un poco para dejar espacio al texto
        
        const xPos = width - firmaDims.width - margenDerecho;
        const yPos = margenInferior;

        // 1. DIBUJAR LA IMAGEN DE LA FIRMA
        lastPage.drawImage(firmaImage, {
            x: xPos,
            y: yPos,
            width: firmaDims.width,
            height: firmaDims.height,
        });
        
        // 2. DIBUJAR EL TEXTO DEBAJO ("FIRMADO POR...")
        const fechaFirma = new Date().toLocaleString('es-CO');
        
        // L√≠nea divisoria
        lastPage.drawLine({
            start: { x: xPos, y: yPos - 5 },
            end: { x: xPos + firmaDims.width, y: yPos - 5 },
            thickness: 1,
            color: rgb(0, 0, 0),
        });

        // Texto
        lastPage.drawText(`FIRMADO POR: ${cargoFirmante.toUpperCase()}`, {
            x: xPos,
            y: yPos - 20,
            size: 8,
            font: helveticaFont,
            color: rgb(0, 0, 0),
        });

        lastPage.drawText(`Nombre: ${nombreFirmante}`, {
            x: xPos,
            y: yPos - 32,
            size: 8,
            font: helveticaFont,
            color: rgb(0.4, 0.4, 0.4),
        });

        lastPage.drawText(`Fecha: ${fechaFirma}`, {
            x: xPos,
            y: yPos - 44,
            size: 7,
            font: helveticaFont,
            color: rgb(0.6, 0.6, 0.6),
        });

        const pdfFirmadoBytes = await pdfDoc.save();
        fs.writeFileSync(rutaSalida, pdfFirmadoBytes);

        return true;

    } catch (error) {
        console.error("Error estampando firma:", error);
        throw new Error("No se pudo estampar la firma en el documento.");
    }
};


==================================================================
ARCHIVO: frontend\eslint.config.js
==================================================================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs['recommended-latest'],
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])



==================================================================
ARCHIVO: frontend\package.json
==================================================================
{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "date-fns": "^4.1.0",
    "jwt-decode": "^4.0.0",
    "react": "^19.1.1",
    "react-big-calendar": "^1.19.4",
    "react-dom": "^19.1.1",
    "react-icons": "^5.5.0",
    "react-router-dom": "^7.9.5",
    "react-signature-canvas": "^1.1.0-alpha.2",
    "recharts": "^3.5.0",
    "sweetalert2": "^11.26.3"
  },
  "devDependencies": {
    "@eslint/js": "^9.36.0",
    "@types/react": "^19.1.16",
    "@types/react-dom": "^19.1.9",
    "@vitejs/plugin-react": "^5.0.4",
    "eslint": "^9.36.0",
    "eslint-plugin-react-hooks": "^5.2.0",
    "eslint-plugin-react-refresh": "^0.4.22",
    "globals": "^16.4.0",
    "vite": "^7.1.7"
  }
}



==================================================================
ARCHIVO: frontend\src\App.css
==================================================================



==================================================================
ARCHIVO: frontend\src\App.jsx
==================================================================
// frontend/src/App.jsx

import React, { useEffect } from 'react';
import { Routes, Route, Navigate, Outlet } from 'react-router-dom';
import { useAuth } from './context/AuthContext';

// P√°ginas
import LoginPage from './pages/LoginPage';
import DashboardPage from './pages/DashboardPage'; 
import UsuariosPage from './pages/UsuariosPage';
import ActivosPage from './pages/ActivosPage.jsx';
import PlanificacionPage from './pages/PlanificacionPage.jsx';
import InspeccionesPage from './pages/InspeccionesPage.jsx';
import ReportesPage from './pages/ReportesPage.jsx'; 
import AcpmPage from './pages/AcpmPage.jsx'; 
import DocumentosPage from './pages/DocumentosPage.jsx';
import MedicinaLaboralPage from './pages/MedicinaLaboralPage.jsx'; 
import LogsPage from './pages/LogsPage.jsx'; 
import IndicadoresPage from './pages/IndicadoresPage.jsx'; 
import PesvPage from './pages/PesvPage.jsx'; 
import SolicitudesPage from './pages/SolicitudesPage.jsx';
import ReportarMaquinaPage from './pages/ReportarMaquinaPage.jsx'; 
import ReportarSeguridadPage from './pages/ReportarSeguridadPage.jsx';
import DashboardSuperAdmin from './pages/DashboardSuperAdmin';
import GestionFormulariosPage from './pages/GestionFormulariosPage'; 
import DirectorioExternoPage from './pages/DirectorioExternoPage';
import ActasPage from './pages/ActasPage.jsx'; 
import PresupuestoPage from './pages/PresupuestoPage.jsx';
import HistorialPage from './pages/HistorialPage.jsx';

// Layouts
import MainLayout from './layout/MainLayout'; 
import ColaboradorLayout from './layout/ColaboradorLayout.jsx'; 
import ProtectedRoutes from './components/ProtectedRoutes';

const AdminRoutes = () => {
    const { usuario } = useAuth();
    // CAMBIO: Se elimin√≥ Gesti√≥n de Calidad
    const tieneAcceso = usuario.rol === 'Super Admin' || usuario.rol === 'Administrador SST';
    return tieneAcceso ? <Outlet /> : <Navigate to="/dashboard" replace />;
};

const SuperAdminRoutes = () => {
    const { usuario } = useAuth();
    return usuario.rol === 'Super Admin' ? <Outlet /> : <Navigate to="/dashboard" replace />;
};

function App() {
    const { isAuthenticated, isLoading, usuario } = useAuth();

    useEffect(() => {
        const root = document.getElementById('root');
        if (isAuthenticated) {
            root.classList.add('layout-activo');
        } else {
            root.classList.remove('layout-activo');
        }
    }, [isAuthenticated]);

    const getDefaultRoute = () => {
        if (!usuario) return "/login";
        if (usuario.rol === 'Super Admin') return "/super-admin/dashboard";
        // CAMBIO: Se elimin√≥ la ruta de Calidad
        if (usuario.rol === 'Administrador SST') return "/dashboard";
        if (usuario.rol === 'Colaborador') return "/dashboard"; 
        return "/login";
    };

    if (isLoading) {
        return <div style={{display: 'flex', height: '100vh', justifyContent: 'center', alignItems: 'center'}}>Cargando Sistema...</div>;
    }

    return (
        <Routes>
            <Route path="/login" element={isAuthenticated ? <Navigate to={getDefaultRoute()} replace /> : <LoginPage />} />
            
            <Route path="/" element={<ProtectedRoutes />}>
                <Route element={usuario?.rol === 'Colaborador' ? <ColaboradorLayout /> : <MainLayout />}>
                    
                    <Route path="dashboard" element={
                        usuario?.rol === 'Super Admin' ? <Navigate to="/super-admin/dashboard" replace /> :
                        // CAMBIO: Se elimin√≥ la redirecci√≥n a Calidad
                        <DashboardPage /> 
                    } />
                    
                    {/* SUPER ADMIN */}
                    <Route path="super-admin" element={<SuperAdminRoutes />}>
                        <Route path="dashboard" element={<DashboardSuperAdmin />} />
                        <Route path="formularios" element={<GestionFormulariosPage />} />
                    </Route>

                    {/* GESTI√ìN Y ADMINISTRACI√ìN (RUTAS COMPARTIDAS SUPER ADMIN Y ADMIN SST) */}
                    <Route element={<AdminRoutes />}>
                        <Route path="usuarios" element={<UsuariosPage />} />
                        <Route path="directorio" element={<DirectorioExternoPage />} />

                        <Route path="activos" element={<ActivosPage />} /> 
                        <Route path="planificacion" element={<PlanificacionPage />} />
                        <Route path="inspecciones" element={<InspeccionesPage />} />
                        <Route path="reportes" element={<ReportesPage />} /> 
                        <Route path="acpm" element={<AcpmPage />} /> 
                        <Route path="documentos" element={<DocumentosPage />} />
                        <Route path="medicina" element={<MedicinaLaboralPage />} /> 
                        <Route path="indicadores" element={<IndicadoresPage />} />
                        <Route path="pesv" element={<PesvPage />} /> 
                        <Route path="solicitudes" element={<SolicitudesPage />} />
                        <Route path="logs" element={<LogsPage />} />
                        <Route path="actas" element={<ActasPage />} />
                        <Route path="presupuesto" element={<PresupuestoPage />} />
                        <Route path="historial" element={<HistorialPage />} />
                    </Route>

                    {/* COLABORADOR */}
                    <Route path="reportar-maquina" element={<ReportarMaquinaPage />} />
                    <Route path="reportar-seguridad" element={<ReportarSeguridadPage />} />

                    <Route index element={<Navigate to={getDefaultRoute()} replace />} />
                </Route>
            </Route>
            
            <Route path="*" element={<Navigate to={getDefaultRoute()} replace />} />
        </Routes>
    );
}

export default App;


==================================================================
ARCHIVO: frontend\src\components\forms\FormularioGenericoRenderer.jsx
==================================================================
/* eslint-disable no-unused-vars */
// frontend/src/components/forms/FormularioGenericoRenderer.jsx

import React, { useState, useEffect } from 'react';
import '../../style/InspeccionesPage.css';
import '../../index.css';

const ChecklistItem = ({ id, label, value, onRespuestaChange, onObservacionChange }) => (
    <div className="checklist-item-wrapper">
        <div className="checklist-item">
            <label className="item-label">{label}</label>
            <div className="checklist-options">
                {/* Opciones Estandarizadas: C (Cumple), NC (No Cumple), NA (No Aplica) */}
                {['C', 'NC', 'NA'].map(val => (
                    <label key={val} className={`radio-label-cn ${val === 'C' ? 'radio-cumple' : val === 'NC' ? 'radio-nocumple' : ''}`}>
                        <input 
                            type="radio" 
                            name={id} 
                            value={val} 
                            checked={value.respuesta === val} 
                            onChange={() => onRespuestaChange(id, val)} 
                        />
                        <span>{val}</span>
                    </label>
                ))}
            </div>
        </div>
        <div className="checklist-item-observacion">
            <label htmlFor={`${id}_obs`}>Obs:</label>
            <input type="text" id={`${id}_obs`} value={value.observacion} onChange={(e) => onObservacionChange(id, e.target.value)} placeholder="Observaci√≥n..." />
        </div>
    </div>
);

const FormularioGenericoRenderer = ({ preguntas, onFormChange, onResultadoChange }) => {
    
    // Inicializamos el estado usando las preguntas que llegan de la BD
    const initialState = preguntas.reduce((acc, p) => {
        acc[p.CodigoPregunta] = { 
            respuesta: '', 
            observacion: '',
            // --- ESTO ES LO NUEVO: Guardamos el texto para persistencia en JSON ---
            textoPregunta: p.TextoPregunta 
        };
        return acc;
    }, {});

    const [respuestas, setRespuestas] = useState(initialState);

    useEffect(() => {
        // L√≥gica autom√°tica de resultado (Si hay un No Cumple, el resultado es Con Hallazgos)
        const tieneHallazgos = Object.values(respuestas).some(v => v.respuesta === 'NC' || v.respuesta === 'M' || v.respuesta === 'R');
        onResultadoChange(tieneHallazgos ? 'Con Hallazgos' : 'OK');
        
        // Enviamos el objeto completo (incluyendo textoPregunta) al padre para guardar en BD
        onFormChange({ checklist: respuestas });
    }, [respuestas, onFormChange, onResultadoChange]);

    const handleRespuestaChange = (key, valor) => {
        setRespuestas(prev => ({ 
            ...prev, 
            [key]: { ...prev[key], respuesta: valor } 
        }));
    };
    
    const handleObservacionChange = (key, valor) => {
        setRespuestas(prev => ({ 
            ...prev, 
            [key]: { ...prev[key], observacion: valor } 
        }));
    };

    if (!preguntas || preguntas.length === 0) return <p>No hay preguntas configuradas.</p>;

    return (
        <div className="form-checklist-container">
            {preguntas.map((p, index) => (
                <ChecklistItem 
                    key={p.ID_Pregunta} 
                    id={p.CodigoPregunta} 
                    // Mostramos "1. Pregunta..."
                    label={`${p.Orden ? p.Orden + '.' : ''} ${p.TextoPregunta}`}
                    // Pasamos el estado actual o un objeto vac√≠o seguro
                    value={respuestas[p.CodigoPregunta] || { respuesta: '', observacion: '' }}
                    onRespuestaChange={handleRespuestaChange}
                    onObservacionChange={handleObservacionChange}
                />
            ))}
        </div>
    );
};

export default FormularioGenericoRenderer;


==================================================================
ARCHIVO: frontend\src\components\Header.jsx
==================================================================
// frontend/src/components/Header.jsx

import React, { useState } from 'react';
import { useAuth } from '../context/AuthContext';
import '../style/Header.css';
import { useNavigate } from 'react-router-dom';
import logo from "../assets/logo-empaquetados.png";
import { BsList, BsExclamationCircleFill } from 'react-icons/bs';

// Importamos el componente de Campana y Modal
import NotificationBell from './NotificationBell'; 
import ModalMiPerfil from './ModalMiPerfil';

const Header = ({ onToggleSidebar }) => { 
    const { usuario, logout } = useAuth();
    const navigate = useNavigate();
    const [modalPerfilOpen, setModalPerfilOpen] = useState(false);

    const handleLogout = () => {
        logout();
        navigate('/login');
    };

    // --- L√ìGICA DE ROLES Y ALERTAS ---
    const esColaborador = usuario?.rol === 'Colaborador';
    
    // Verificamos si falta el correo, PERO solo si NO es colaborador.
    // Si es colaborador, 'mostrarAlerta' siempre ser√° falso.
    const tieneCorreo = usuario?.email && usuario.email !== '';
    const mostrarAlerta = !tieneCorreo && !esColaborador;

    return (
        <>
            <header className="header-container">
                
                {!esColaborador && (
                    <button className="header-toggle-btn" onClick={onToggleSidebar}>
                        <BsList />
                    </button>
                )}

                {esColaborador && (
                    <img 
                        src={logo} 
                        alt="Logo Empaquetados El Trece" 
                        className="sidebar-logo-img3"
                    />
                )}

                <div className="header-title-placeholder"></div>
        
                <div className="header-user-info">
                    
                    {/* Alerta de Texto (Solo visible si falta correo y NO es colaborador) */}
                    {mostrarAlerta && (
                        <div 
                            style={{
                                color:'#dc3545', marginRight:'15px', display:'flex', alignItems:'center', 
                                gap:'5px', fontSize:'0.8rem', cursor:'pointer', fontWeight:'bold',
                                animation: 'pulse 2s infinite'
                            }}
                            onClick={() => setModalPerfilOpen(true)}
                            title="Haz clic para configurar tu correo"
                        >
                            <BsExclamationCircleFill /> Configurar Correo
                        </div>
                    )}

                    <NotificationBell />
                    
                    <div className="header-separator"></div>

                    <div className="user-details">
                        <span className="user-name">
                            {usuario ? usuario.nombre : 'Usuario'}
                        </span>
                        <span className="user-role">
                            {usuario ? usuario.rol : ''}
                        </span>
                    </div>

                    {/* Avatar Clickeable */}
                    <div 
                        className="user-avatar" 
                        onClick={() => setModalPerfilOpen(true)}
                        style={{cursor: 'pointer', position:'relative'}}
                        title="Ver Mi Perfil"
                    >
                        {usuario ? usuario.nombre[0].toUpperCase() : 'U'}
                        
                        {/* Punto Rojo (Solo si corresponde mostrar alerta) */}
                        {mostrarAlerta && (
                            <span style={{
                                position:'absolute', bottom:'-2px', right:'-2px', 
                                width:'12px', height:'12px', backgroundColor:'#dc3545', 
                                borderRadius:'50%', border:'2px solid white'
                            }}></span>
                        )}
                    </div>
                    
                    <button onClick={handleLogout} className="header-logout-button">
                        <span className="logout-text">Cerrar Sesi√≥n</span>
                        <span className="logout-icon">‚èª</span>
                    </button>
                </div>
            </header>

            {/* Modal */}
            {modalPerfilOpen && (
                <ModalMiPerfil alCerrar={() => setModalPerfilOpen(false)} />
            )}
        </>
    );
};

export default Header;


==================================================================
ARCHIVO: frontend\src\components\InspeccionDetalleRenderer.jsx
==================================================================
// frontend/src/componentes/InspeccionDetalleRenderer.jsx

import React from 'react';
import '../style/InspeccionesPage.css'; 
import '../index.css'; 

// DICCIONARIOS LEGADOS (Para compatibilidad hist√≥rica con inspecciones viejas)
// NO BORRAR hasta que se depure la data antigua
const DICTIONARIES = {
    'FTO-SST-02': { doc_soat: 'SOAT Vigente', doc_tecnomecanica: 'Revisi√≥n Tecnomec√°nica Vigente', doc_licencia: 'Licencia de Conducci√≥n Vigente', doc_tarjeta_op: 'Tarjeta de Operaci√≥n', eq_gato: 'Gato con capacidad', eq_cruceta: 'Cruceta', eq_llanta_rep: 'Llanta de Repuesto', eq_herramienta: 'Herramienta B√°sica', eq_botiquin: 'Botiqu√≠n', eq_extintor: 'Extintor', eq_tacos: 'Tacos para bloquear', eq_senales: 'Se√±ales de carretera', rev_luces_altas: 'Luces Altas y Bajas', rev_direccionales: 'Luces Direccionales', rev_stop: 'Luces de Stop', rev_reversa: 'Luces de Reversa', rev_frenos: 'Frenos', rev_llantas_est: 'Estado Llantas', rev_limpiabrisas: 'Limpiaparabrisas', rev_espejos: 'Espejos', rev_pito: 'Pito', epp_guantes: 'Guantes', epp_casco: 'Casco', flu_aceite: 'Nivel Aceite Motor', flu_liq_frenos: 'Nivel L√≠quido de Frenos', flu_agua: 'Nivel Agua/Refrigerante' },
    'FTO-SST-13': { item1_ubicacion: '1. ¬øEst√° en la ubicaci√≥n asignada?', item2_senalizacion: '2. ¬øLa se√±alizaci√≥n es visible y adecuada?', item3_acceso: '3. ¬øEl acceso al extintor est√° libre de obst√°culos?', item4_manometro: '4. ¬øEl man√≥metro indica la presi√≥n adecuada?', item5_seguro: '5. ¬øEl seguro y sello de garant√≠a est√°n intactos?', item6_manguera: '6. ¬øLa manguera y boquilla est√°n en buen estado?', item7_etiqueta_vencimiento: '7. ¬øLa etiqueta de vencimiento est√° vigente?' },
    'FTO-SST-14': { item_gasas: 'Gasas limpias', item_esparadrapo: 'Esparadrapo de tela', item_baja_lenguas: 'Baja lenguas', item_curas: 'Curitas', item_venda_ela_2: 'Venda el√°stica 2x5', item_venda_ela_3: 'Venda el√°stica 3x5', item_venda_alg: 'Venda de algod√≥n 3x5', item_yodopovidona: 'Yodopovidona', item_sol_salina: 'Soluci√≥n salina', item_guantes: 'Guantes de l√°tex', item_tijeras: 'Tijeras', item_termometro: 'Term√≥metro' },
    'FTO-SST-23': { cla_necesarios: 'Se conservan solo elementos necesarios', cla_obsoletos: 'Se retiran elementos obsoletos', ord_lugar: 'Un lugar para cada cosa', ord_identificados: '√Åreas identificadas', ord_pasillos: 'Pasillos despejados', lim_pisos: 'Pisos/paredes limpios', lim_maquinas: 'Maquinaria limpia', lim_puntos: 'Puntos ecol√≥gicos limpios', est_controles: 'Controles visuales', est_rutinas: 'Rutinas de aseo', dis_habito: 'H√°bito de orden', dis_epp: 'Uso de EPP' },
    'FTO-SST-45': { maq_guardas: 'Guardas de seguridad', maq_parada_e: 'Paradas de emergencia', maq_mantenimiento: 'Mantenimiento preventivo', esc_estado: 'Escaleras fijas', esc_manuales: 'Escaleras manuales', esc_andamios: 'Andamios', inst_pisos: 'Pisos', inst_iluminacion: 'Iluminaci√≥n', inst_ventilacion: 'Ventilaci√≥n', alm_estanterias: 'Estanter√≠as', alm_materiales: 'Apilamiento materiales', epp_uso: 'Uso EPP', epp_estado: 'Estado EPP', em_rutas: 'Rutas evacuaci√≥n', em_salidas: 'Salidas emergencia', em_extintores: 'Extintores', em_botiquin: 'Botiqu√≠n' },
    'FTO-SST-95': { alm_area: '√Årea ventilada', alm_compatibilidad: 'Compatibilidad qu√≠mica', alm_envases: 'Envases rotulados', alm_hojas_seg: 'Hojas de seguridad', alm_diques: 'Diques contenci√≥n', man_trasvase: 'Trasvase seguro', man_personal: 'Personal capacitado', epp_guantes: 'Guantes nitrilo', epp_gafas: 'Gafas seguridad', epp_respirador: 'Protecci√≥n respiratoria', em_kit: 'Kit derrames', em_ducha: 'Ducha emergencia' },
    'FTO-SST-96': { tab_senalizados: 'Tableros se√±alizados', tab_libres: 'Acceso libre', tab_tapas: 'Tapas protecci√≥n', tab_polo: 'Polo a tierra', con_estado: 'Cables buen estado', con_canalizacion: 'Canalizados', tom_estado: 'Tomas buen estado', tom_sobrecarga: 'Sin sobrecarga', ext_uso: 'Extensiones temporal', ext_estado: 'Estado extensiones', epp_dielectrico: 'EPP Diel√©ctrico' }
};

const RenderValor = ({ valor }) => {
    let clase = '';
    // Mapeo de valores viejos (B, M, R) a nuevos (C, NC, NA) para color
    if (['B', 'C', 'OK'].includes(valor)) clase = 'status-activo'; 
    else if (['R', 'M', 'NC', 'No Cumple'].includes(valor)) clase = 'status-pendiente'; 
    else if (['NA', 'N/A'].includes(valor)) clase = 'status-inactivo'; 
    else clase = 'status-inactivo'; 

    return <span className={`status-pill ${clase}`} style={{ width: '45px', textAlign: 'center', flexShrink: 0 }}>{valor}</span>;
};

const InspeccionDetalleRenderer = ({ formId, jsonString }) => {
    if (!jsonString) return <p>No hay datos registrados.</p>;

    let data;
    try {
        data = JSON.parse(jsonString);
    // eslint-disable-next-line no-unused-vars
    } catch (e) {
        return <p className="modal-error">Error al leer los datos (JSON inv√°lido).</p>;
    }

    // 1. Intentar obtener diccionario legacy
    const dictionary = DICTIONARIES[formId] || {};
    
    // 2. Normalizar los datos
    let items = [];
    let observacionesGenerales = '';
    let infoAdicional = '';
    let otroActivo = '';

    if (Array.isArray(data)) {
        // Formato SQL (Poco com√∫n ahora)
        items = data;
    } else {
        // Formato Objeto JS (Est√°ndar del proyecto)
        observacionesGenerales = data.observacionesFormulario || '';
        infoAdicional = data.infoAdicionalActivo || '';
        otroActivo = data.otroActivoMencionado || '';
        
        if (data.checklist) {
            items = Object.entries(data.checklist).map(([key, val]) => {
                const respuesta = (typeof val === 'object' && val !== null) ? val.respuesta : val;
                const observacion = (typeof val === 'object' && val !== null) ? val.observacion : '';
                // --- RECUPERAR TEXTO GUARDADO (NUEVO) ---
                const textoPregunta = (typeof val === 'object' && val !== null) ? val.textoPregunta : null;

                return { key, respuesta, observacion, textoPregunta };
            });
        }
    }

    return (
        <div className="form-checklist-container">

            {infoAdicional && (
                <div className="detail-section" style={{ paddingBottom: '1rem', borderBottom: '1px solid #f0f2f5' }}>
                    <strong>Informaci√≥n Adicional del Activo:</strong>
                    <p style={{ margin: 0, fontSize: '0.95rem' }}>{infoAdicional}</p>
                </div>
            )}
            {otroActivo && (
                <div className="detail-section" style={{ paddingBottom: '1rem', borderBottom: '1px solid #f0f2f5' }}>
                    <strong>Activo/√Årea Relacionada:</strong>
                    <p style={{ margin: 0, fontSize: '0.95rem' }}>{otroActivo}</p>
                </div>
            )}
            
            {items.map((item, index) => {
                if (!item.respuesta) return null;
                
                // L√ìGICA DE VISUALIZACI√ìN:
                // 1. Usar texto guardado en JSON (Nuevas inspecciones)
                // 2. Usar diccionario hardcodeado (Inspecciones viejas)
                // 3. Usar el c√≥digo clave (Fallback)
                const label = item.textoPregunta || dictionary[item.key] || item.key;
                
                return (
                    <div key={index} className="checklist-item-wrapper">
                        <div className="checklist-item">
                            <label className="item-label">{label}</label>
                            <RenderValor valor={item.respuesta} />
                        </div>
                        {item.observacion && (
                            <div className="checklist-item-observacion" style={{ paddingLeft: '0.5rem', marginTop: '0.25rem' }}>
                                <em style={{ color: '#6c757d', fontSize: '0.9rem' }}>Obs: {item.observacion}</em>
                            </div>
                        )}
                    </div>
                );
            })}
            
            {observacionesGenerales && (
                <div className="detail-section" style={{marginTop: '1rem', borderTop: '1px solid #f0f2f5', paddingTop: '1rem'}}>
                    <strong>Observaciones Generales del Formulario:</strong>
                    <p className="detail-box">{observacionesGenerales}</p>
                </div>
            )}
        </div>
    );
};

export default InspeccionDetalleRenderer;


==================================================================
ARCHIVO: frontend\src\components\ModalConfigurarIndicadores.jsx
==================================================================
// frontend/src/components/ModalConfigurarIndicadores.jsx

import React, { useState } from 'react';
import { crearConfiguracionIndicador, editarConfiguracionIndicador, eliminarConfiguracionIndicador } from '../services/indicatorService';
import '../style/Modal.css';
import Swal from 'sweetalert2';
import { BsTrash, BsPlusCircle, BsCalculator, BsDashCircle, BsPencil } from 'react-icons/bs';

const ModalConfigurarIndicadores = ({ configs, alCerrar, alActualizar }) => {
    const [view, setView] = useState('LIST'); 
    const [isEditing, setIsEditing] = useState(false);
    const [editingId, setEditingId] = useState(null);
    
    // Estado variables
    const [variablesDinamicas, setVariablesDinamicas] = useState([
        { id: 1, code: 'v1', label: '' },
        { id: 2, code: 'v2', label: '' }
    ]);

    // Estado formulario
    const [form, setForm] = useState({
        nombre: '',
        tipo: 'PERSONALIZADO', 
        formula: '', 
        constante: 100,
        meta: 0,
        operador: '>=',
        frecuencia: 'Mensual',
        grafica: 'Bar'
    });

    const resetForm = () => {
        setForm({
            nombre: '',
            tipo: 'PERSONALIZADO', 
            formula: '', 
            constante: 100,
            meta: 0,
            operador: '>=',
            frecuencia: 'Mensual',
            grafica: 'Bar'
        });
        setVariablesDinamicas([
            { id: 1, code: 'v1', label: '' },
            { id: 2, code: 'v2', label: '' }
        ]);
        setIsEditing(false);
        setEditingId(null);
    };

    const handleNuevaConfig = () => {
        resetForm();
        setView('FORM');
    };

    const handleEditarConfig = (config) => {
        setIsEditing(true);
        setEditingId(config.ID_Config);
        
        let vars = [];
        // Intentamos leer variables desde el objeto (Soporte doble chequeo por si viene del mapeo o crudo)
        if (config.variables && config.variables.length > 0) {
            vars = config.variables.map((v, i) => ({ id: i+1, code: v.code, label: v.label }));
        } else if (config.VariablesJSON) {
             try {
                 const parsed = JSON.parse(config.VariablesJSON);
                 vars = parsed.map((v, i) => ({ id: i+1, code: v.code, label: v.label }));
             // eslint-disable-next-line no-unused-vars
             } catch(e) { vars = [{ id: 1, code: 'v1', label: '' }]; }
        } else {
            vars = [{ id: 1, code: 'v1', label: '' }];
        }

        setVariablesDinamicas(vars);
        
        setForm({
            nombre: config.NombreIndicador,
            tipo: 'PERSONALIZADO',
            // Usamos || '' para evitar undefined
            formula: config.formula || config.FormulaCalculo || '', 
            // Usamos || 100 para evitar nulos en Constante
            constante: (config.constante !== undefined && config.constante !== null) ? config.constante : (config.Constante || 100),
            meta: (config.metaDefault !== undefined && config.metaDefault !== null) ? config.metaDefault : (config.MetaDefault || 0),
            
            operador: config.operadorMeta || config.OperadorMeta || '>=',
            frecuencia: config.frecuencia || config.Frecuencia || 'Mensual',
            grafica: config.tipoGrafica || config.TipoGrafica || 'Bar'
        });
        setView('FORM');
    };

    // --- M√âTODOS PARA VARIABLES DIN√ÅMICAS ---
    const agregarVariable = () => {
        const nuevoId = variablesDinamicas.length + 1;
        const nuevoCodigo = `v${nuevoId}`;
        setVariablesDinamicas([...variablesDinamicas, { id: nuevoId, code: nuevoCodigo, label: '' }]);
    };

    const quitarVariable = (index) => {
        if (variablesDinamicas.length <= 1) return;
        const nuevas = variablesDinamicas.filter((_, i) => i !== index);
        const reordenadas = nuevas.map((v, i) => ({ ...v, code: `v${i + 1}` }));
        setVariablesDinamicas(reordenadas);
    };

    const handleVariableChange = (index, valor) => {
        const nuevas = [...variablesDinamicas];
        nuevas[index].label = valor;
        setVariablesDinamicas(nuevas);
    };
    // ----------------------------------------

    const handleEliminar = async (id, nombre) => {
        const result = await Swal.fire({
            title: '¬øInactivar Indicador?',
            text: `Se ocultar√° la definici√≥n de "${nombre}".`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'S√≠, inactivar'
        });

        if (result.isConfirmed) {
            try {
                await eliminarConfiguracionIndicador(id);
                Swal.fire('Inactivado', 'Indicador eliminado del listado.', 'success');
                alActualizar();
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        }
    };

    const handleGuardar = async (e) => {
        e.preventDefault();
        
        if(variablesDinamicas.some(v => !v.label.trim())){
            Swal.fire('Atenci√≥n', 'Todas las variables deben tener nombre.', 'warning');
            return;
        }

        try {
            const payload = {
                ...form,
                variables: variablesDinamicas 
            };

            if (isEditing) {
                await editarConfiguracionIndicador(editingId, payload);
                Swal.fire('Actualizado', 'Indicador modificado correctamente.', 'success');
            } else {
                await crearConfiguracionIndicador(payload);
                Swal.fire('Creado', 'Nuevo indicador configurado.', 'success');
            }
            
            alActualizar();
            setView('LIST');
            resetForm();
        } catch (error) {
            console.error(error);
            Swal.fire('Error', error.message, 'error');
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>{view === 'LIST' ? 'Gestionar Indicadores' : (isEditing ? 'Editar Indicador' : 'Crear Nuevo Indicador')}</h2>
                    <button className="modal-close-button" onClick={alCerrar}>&times;</button>
                </div>

                <div className="modal-body" style={{maxHeight:'70vh', overflowY:'auto'}}>
                    
                    {view === 'LIST' ? (
                        <>
                            <div style={{marginBottom:'1rem', textAlign:'right'}}>
                                <button className="btn btn-primary" onClick={handleNuevaConfig}>
                                    <BsPlusCircle /> Crear Nuevo
                                </button>
                            </div>
                            <table className="data-table">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>F√≥rmula</th>
                                        <th>Frecuencia</th>
                                        <th style={{textAlign:'center'}}>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {configs.map(c => (
                                        <tr key={c.ID_Config}>
                                            <td>{c.NombreIndicador}</td>
                                            <td style={{fontFamily:'monospace', fontSize:'0.85rem', color:'#555'}}>
                                                {c.formula || c.FormulaCalculo || c.Tipo}
                                            </td>
                                            <td>{c.frecuencia || c.Frecuencia}</td>
                                            <td style={{textAlign:'center', display:'flex', gap:'5px', justifyContent:'center'}}>
                                                <button className="btn btn-sm btn-warning" onClick={() => handleEditarConfig(c)} title="Editar configuraci√≥n">
                                                    <BsPencil />
                                                </button>
                                                <button className="btn btn-sm btn-danger" onClick={() => handleEliminar(c.ID_Config, c.NombreIndicador)} title="Inactivar indicador">
                                                    <BsTrash />
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                    {configs.length === 0 && <tr><td colSpan="4" style={{textAlign:'center'}}>No hay indicadores configurados.</td></tr>}
                                </tbody>
                            </table>
                        </>
                    ) : (
                        <form onSubmit={handleGuardar}>
                            <div className="form-group">
                                <label>Nombre del Indicador *</label>
                                <input className="form-control" required value={form.nombre} onChange={e => setForm({...form, nombre: e.target.value})} placeholder="Ej: Cumplimiento de Capacitaciones"/>
                            </div>

                            <div style={{backgroundColor:'#f8f9fa', padding:'1rem', borderRadius:'8px', marginBottom:'1rem', border:'1px solid #eee'}}>
                                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'10px'}}>
                                    <h4 style={{marginTop:0, margin:0, color:'#005A5B'}}>Definir Variables</h4>
                                    <button type="button" className="btn btn-sm btn-secondary" onClick={agregarVariable}>
                                        <BsPlusCircle /> A√±adir Variable
                                    </button>
                                </div>
                                
                                <div style={{display: 'flex', flexDirection:'column', gap:'10px'}}>
                                    {variablesDinamicas.map((v, index) => (
                                        <div key={index} style={{display:'flex', gap:'10px', alignItems:'center'}}>
                                            <span style={{fontWeight:'bold', color:'#007BFF', width:'30px'}}>{v.code}</span>
                                            <input 
                                                className="form-control" 
                                                placeholder={`Nombre de la variable ${v.code} (Ej: Total Horas)`} 
                                                value={v.label}
                                                onChange={e => handleVariableChange(index, e.target.value)}
                                                required
                                            />
                                            {variablesDinamicas.length > 1 && (
                                                <button type="button" className="btn btn-sm btn-danger" onClick={() => quitarVariable(index)} title="Quitar">
                                                    <BsDashCircle />
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>

                                <div className="form-group" style={{marginTop:'1.5rem'}}>
                                    <label style={{color: '#d63384'}}><BsCalculator/> F√≥rmula Matem√°tica</label>
                                    <input 
                                        className="form-control" 
                                        required 
                                        value={form.formula} 
                                        onChange={e => setForm({...form, formula: e.target.value})} 
                                        placeholder={`Ej: (${variablesDinamicas.map(v => v.code).join(' + ')}) / 100`} 
                                        style={{fontFamily:'monospace', fontWeight:'bold', fontSize:'1.1rem'}}
                                    />
                                    <small style={{color:'#666'}}>
                                        Usa los c√≥digos <b>{variablesDinamicas.map(v => v.code).join(', ')}</b> y operadores (+ - * /).
                                    </small>
                                </div>
                                
                                <div className="form-group" style={{marginTop:'1rem'}}>
                                    <label>Constante (K)</label>
                                    <input type="number" className="form-control" value={form.constante} onChange={e => setForm({...form, constante: e.target.value})} style={{width:'100px'}}/>
                                </div>
                            </div>

                            <div style={{display:'flex', gap:'1rem'}}>
                                <div className="form-group" style={{flex:1}}>
                                    <label>Meta por Defecto</label>
                                    <input type="number" step="0.01" className="form-control" value={form.meta} onChange={e => setForm({...form, meta: e.target.value})}/>
                                </div>
                                <div className="form-group" style={{flex:1}}>
                                    <label>Condici√≥n Meta</label>
                                    <select className="form-control" value={form.operador} onChange={e => setForm({...form, operador: e.target.value})}>
                                        <option value=">=">Mayor o Igual ({'>='})</option>
                                        <option value="<=">Menor o Igual ({'<='})</option>
                                        <option value="==">Igual (==)</option>
                                    </select>
                                </div>
                            </div>

                            <div style={{display:'flex', gap:'1rem'}}>
                                <div className="form-group" style={{flex:1}}>
                                    <label>Frecuencia</label>
                                    <select className="form-control" value={form.frecuencia} onChange={e => setForm({...form, frecuencia: e.target.value})}>
                                        <option>Mensual</option>
                                        <option>Anual</option>
                                        <option>Trimestral</option>
                                    </select>
                                </div>
                                <div className="form-group" style={{flex:1}}>
                                    <label>Tipo Gr√°fica</label>
                                    <select className="form-control" value={form.grafica} onChange={e => setForm({...form, grafica: e.target.value})}>
                                        <option value="Bar">Barras</option>
                                        <option value="Line">L√≠nea</option>
                                    </select>
                                </div>
                            </div>

                            <div className="modal-footer">
                                <button type="button" className="btn btn-secondary" onClick={() => setView('LIST')}>Volver a Lista</button>
                                <button type="submit" className="btn btn-primary">{isEditing ? 'Actualizar' : 'Guardar'}</button>
                            </div>
                        </form>
                    )}
                </div>
                
                {view === 'LIST' && (
                    <div className="modal-footer">
                        <button className="btn btn-secondary" onClick={alCerrar}>Cerrar</button>
                    </div>
                )}
            </div>
        </div>
    );
};

export default ModalConfigurarIndicadores;


==================================================================
ARCHIVO: frontend\src\components\ModalConfigurarPlantilla.jsx
==================================================================
// frontend/src/components/ModalConfigurarPlantilla.jsx

import React, { useState, useEffect } from 'react';
import { apiFetch } from '../services/apiService';
import '../style/Modal.css';
import Swal from 'sweetalert2';
import { BsPlusCircle, BsTrash, BsCardHeading, BsTextParagraph } from 'react-icons/bs';

const ModalConfigurarPlantilla = ({ paso, alCerrar }) => {
    
    const [config, setConfig] = useState({
        // Datos del Encabezado
        codigo: '',
        version: '',
        fechaEmision: '',
        fechaRevision: '',
        
        // Datos del Contenido
        titulo: '',
        cuerpo: '',
        campos: [] 
    });
    const [isLoading, setIsLoading] = useState(false);

    useEffect(() => {
        cargarConfig();
    }, []);

    const cargarConfig = async () => {
        try {
            const data = await apiFetch(`/pesv/plantilla/${paso.ID_Paso}`);
            if (data.existe) {
                // Parseamos fechas para el input date (YYYY-MM-DD)
                const fEmision = data.config.FechaEmision ? data.config.FechaEmision.split('T')[0] : '';
                const fRevision = data.config.FechaRevision ? data.config.FechaRevision.split('T')[0] : '';

                setConfig({
                    titulo: data.config.TituloDocumento,
                    cuerpo: data.config.CuerpoInicial || '',
                    codigo: data.config.CodigoDocumento || '',
                    version: data.config.Version || '',
                    fechaEmision: fEmision,
                    fechaRevision: fRevision,
                    campos: data.campos.map(c => ({ label: c.Etiqueta, tipo: c.TipoInput, orden: c.Orden }))
                });
            } else {
                // Valores por defecto sugeridos
                setConfig(prev => ({
                    ...prev,
                    codigo: `PESV-FTO-${paso.NumeroPaso}`,
                    version: '1',
                    fechaEmision: new Date().toISOString().split('T')[0],
                    fechaRevision: new Date().toISOString().split('T')[0]
                }));
            }
        } catch (error) { console.error(error); }
    };

    const agregarCampo = () => {
        setConfig(prev => ({
            ...prev,
            campos: [...prev.campos, { label: '', tipo: 'texto', orden: prev.campos.length + 1 }]
        }));
    };

    const actualizarCampo = (idx, key, val) => {
        const nuevos = [...config.campos];
        nuevos[idx][key] = val;
        setConfig({ ...config, campos: nuevos });
    };

    const borrarCampo = (idx) => {
        const nuevos = config.campos.filter((_, i) => i !== idx);
        setConfig({ ...config, campos: nuevos });
    };

    const handleGuardar = async (e) => {
        e.preventDefault();
        if (config.campos.length === 0) {
            Swal.fire('Atenci√≥n', 'Debe agregar al menos un campo din√°mico para el formulario.', 'warning');
            return;
        }
        setIsLoading(true);
        try {
            await apiFetch('/pesv/plantilla', {
                method: 'POST',
                body: JSON.stringify({
                    idPaso: paso.ID_Paso,
                    ...config // Enviamos todo: codigo, version, fechas, titulo, cuerpo, campos
                })
            });
            Swal.fire('√âxito', 'Dise√±o guardado correctamente.', 'success');
            alCerrar();
        // eslint-disable-next-line no-unused-vars
        } catch (error) {
            Swal.fire('Error', 'No se pudo guardar la configuraci√≥n', 'error');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                    <h3>Dise√±ar Formulario: Paso {paso.NumeroPaso}</h3>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleGuardar}>
                    <div className="modal-body" style={{maxHeight:'70vh', overflowY:'auto'}}>
                        
                        {/* SECCI√ìN 1: ENCABEZADO DE CONTROL */}
                        <div style={{backgroundColor:'#f0f7ff', padding:'15px', borderRadius:'8px', marginBottom:'1.5rem', border:'1px solid #cce5ff'}}>
                            <h4 style={{marginTop:0, color:'#005A5B', fontSize:'1rem', display:'flex', alignItems:'center', gap:'8px'}}>
                                <BsCardHeading /> Datos del Encabezado (Control Documental)
                            </h4>
                            <div style={{display:'flex', gap:'10px', marginBottom:'10px'}}>
                                <div className="form-group" style={{flex:1, marginBottom:0}}>
                                    <label style={{fontSize:'0.85rem'}}>C√≥digo Doc</label>
                                    <input className="form-control" required value={config.codigo} onChange={e => setConfig({...config, codigo: e.target.value})} placeholder="PESV-FTO-001" />
                                </div>
                                <div className="form-group" style={{flex:1, marginBottom:0}}>
                                    <label style={{fontSize:'0.85rem'}}>Versi√≥n</label>
                                    <input className="form-control" required value={config.version} onChange={e => setConfig({...config, version: e.target.value})} placeholder="1" />
                                </div>
                            </div>
                            <div style={{display:'flex', gap:'10px'}}>
                                <div className="form-group" style={{flex:1, marginBottom:0}}>
                                    <label style={{fontSize:'0.85rem'}}>Fecha Emisi√≥n</label>
                                    <input type="date" className="form-control" required value={config.fechaEmision} onChange={e => setConfig({...config, fechaEmision: e.target.value})} />
                                </div>
                                <div className="form-group" style={{flex:1, marginBottom:0}}>
                                    <label style={{fontSize:'0.85rem'}}>Fecha Revisi√≥n</label>
                                    <input type="date" className="form-control" required value={config.fechaRevision} onChange={e => setConfig({...config, fechaRevision: e.target.value})} />
                                </div>
                            </div>
                        </div>

                        {/* SECCI√ìN 2: CONTENIDO */}
                        <h4 style={{marginTop:0, color:'#005A5B', fontSize:'1rem', display:'flex', alignItems:'center', gap:'8px'}}>
                            <BsTextParagraph /> Contenido del Documento
                        </h4>
                        
                        <div className="form-group">
                            <label>T√≠tulo del Documento (Aparece bajo el nombre del PESV)</label>
                            <input className="form-control" required value={config.titulo} onChange={e => setConfig({...config, titulo: e.target.value})} placeholder="Ej: ACTA DE CAPACITACI√ìN EN SEGURIDAD VIAL" />
                        </div>
                        
                        <div className="form-group">
                            <label>Texto Introductorio (P√°rrafo fijo antes de los campos)</label>
                            <textarea className="form-control" rows="3" value={config.cuerpo} onChange={e => setConfig({...config, cuerpo: e.target.value})} placeholder="Ej: En la ciudad de Medell√≠n, siendo el d√≠a..." />
                        </div>

                        <hr />
                        
                        {/* SECCI√ìN 3: CAMPOS */}
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'10px'}}>
                            <h4 style={{margin:0, color:'#005A5B'}}>Campos Din√°micos (Formulario)</h4>
                            <button type="button" className="btn btn-sm btn-secondary" onClick={agregarCampo}>
                                <BsPlusCircle /> Agregar Campo
                            </button>
                        </div>
                        
                        {config.campos.length === 0 && <p style={{color:'#999', textAlign:'center', fontStyle:'italic'}}>Agrega campos para que el usuario diligencie.</p>}

                        {config.campos.map((campo, idx) => (
                            <div key={idx} style={{display:'flex', gap:'10px', marginBottom:'10px', alignItems:'center', backgroundColor:'#f8f9fa', padding:'10px', borderRadius:'6px', border:'1px solid #eee'}}>
                                <span style={{fontWeight:'bold', color:'#666', width:'20px'}}>{idx + 1}.</span>
                                <input 
                                    className="form-control" 
                                    placeholder="Nombre del Campo (Ej: Nombre Asistente)" 
                                    value={campo.label} 
                                    onChange={e => actualizarCampo(idx, 'label', e.target.value)}
                                    required
                                    style={{flex: 2}}
                                />
                                <select className="form-control" value={campo.tipo} onChange={e => actualizarCampo(idx, 'tipo', e.target.value)} style={{flex: 1}}>
                                    <option value="texto">Texto Corto</option>
                                    <option value="fecha">Fecha</option>
                                    <option value="parrafo">P√°rrafo Largo</option>
                                </select>
                                <button type="button" className="btn btn-sm btn-danger" onClick={() => borrarCampo(idx)}><BsTrash /></button>
                            </div>
                        ))}

                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>
                            {isLoading ? 'Guardando...' : 'Guardar Dise√±o'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalConfigurarPlantilla;


==================================================================
ARCHIVO: frontend\src\components\ModalConfirmarAccion.jsx
==================================================================
// frontend/src/componentes/ModalConfirmarAccion.jsx

import React, { useState } from 'react';
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; // <-- 1. Importar

const ModalConfirmarAccion = ({ 
    titulo, 
    mensaje, 
    enConfirmar, // Esta es la funci√≥n async que llama a la API
    alCerrar, 
    textoBotonConfirmar = "Confirmar", 
    claseBoton = "btn-danger" 
}) => {
    
    const [isLoading, setIsLoading] = useState(false);

    const handleConfirmar = async () => {
        setIsLoading(true);
        try {
            await enConfirmar(); // Llama a la acci√≥n (ej. eliminarActividad)
            
            // --- 2. MOSTRAR √âXITO (SUTIL) ---
            Swal.fire({
                title: '¬°Hecho!',
                text: `La acci√≥n "${textoBotonConfirmar}" se complet√≥ exitosamente.`,
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            
            alCerrar(); // Cierra el modal si tiene √©xito
        } catch (err) {
            // --- 3. MOSTRAR ERROR ---
            Swal.fire({
                title: 'Error',
                text: err.message || 'Ocurri√≥ un error al realizar la acci√≥n',
                icon: 'error'
            });
            setIsLoading(false); // Permite reintentar
        } 
        // No ponemos 'finally' porque solo queremos que se quite el loading en error
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>{titulo}</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <div className="modal-body">
                    <p>{mensaje}</p>
                </div>
                <div className="modal-footer">
                    <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                    <button type="button" className={`btn ${claseBoton}`} onClick={handleConfirmar} disabled={isLoading}>
                        {isLoading ? 'Procesando...' : textoBotonConfirmar}
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalConfirmarAccion;


==================================================================
ARCHIVO: frontend\src\components\ModalCrearACPM.jsx
==================================================================
// frontend/src/componentes/ModalCrearACPM.jsx

import React, { useState, useEffect } from 'react';
import { crearACPM } from '../services/acpmService'; 
import { getTodosUsuarios } from '../services/userService'; 
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; 

/**
 * @component ModalCrearACPM
 * @desc Modal con formulario para crear una nueva ACPM (CU-03)
 * @param {function} alCerrar - Funci√≥n para cerrar el modal
 * @param {function} alExito - Funci√≥n que se llama si se crea exitosamente (devuelve el nuevo ID)
 * @param {object} initialData - (Opcional) Datos para pre-llenar el formulario
 */
const ModalCrearACPM = ({ alCerrar, alExito, initialData = {} }) => {
    
    // --- Estados del Formulario ---
    const [formData, setFormData] = useState({
        tipoAccion: initialData.tipoAccion || 'Correctiva', 
        origen: initialData.origen || '',
        descripcionProblema: initialData.descripcionProblema || '',
        planAccion: '',
        idUsuarioResponsable: '', // (Se carga desde el selector)
        fechaLimite: new Date().toISOString().split('T')[0], 
        analisisCausa: '',
        idInspeccionOrigen: initialData.idInspeccionOrigen || null,
        idReporteMaquinaOrigen: initialData.idReporteMaquinaOrigen || null,
        idReporteSeguridadOrigen: initialData.idReporteSeguridadOrigen || null,
    });
    
    const [listaUsuarios, setListaUsuarios] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    // --- Cargar Usuarios para el Selector ---
    useEffect(() => {
        const cargarUsuarios = async () => {
            try {
                const data = await getTodosUsuarios();
                setListaUsuarios(data);
            } catch (err) {
                console.error("Error cargando usuarios:", err);
                setError("No se pudo cargar la lista de responsables");
            }
        };
        cargarUsuarios();
    }, []); // Se ejecuta solo una vez al montar

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({
            ...prevState,
            [name]: value
        }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        
        // --- Validaci√≥n (Bug de NaN) ---
        const idResponsableNum = parseInt(formData.idUsuarioResponsable);
        if (!idResponsableNum) {
            setError('Debe seleccionar un responsable v√°lido.');
            return;
        }

        setIsLoading(true);

        try {
            const payload = { 
                ...formData, 
                idUsuarioResponsable: idResponsableNum // Env√≠a el n√∫mero
            };
            
            const respuesta = await crearACPM(payload);
            const nuevoIdACPM = respuesta.idACPM; // Obtenemos el ID
            
            Swal.fire({
                title: '¬°√âxito!',
                text: 'Acci√≥n ACPM creada exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            
            alExito(nuevoIdACPM); // Devolvemos el ID al padre
            
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Crear Nueva Acci√≥n (ACPM)</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <form onSubmit={handleSubmit}>
                    <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                        
                        <div className="form-group"><label htmlFor="tipoAccion">Tipo de Acci√≥n *</label><select id="tipoAccion" name="tipoAccion" value={formData.tipoAccion} onChange={handleChange}><option value="Correctiva">Correctiva</option><option value="Preventiva">Preventiva</option><option value="Mejora">Mejora</option></select></div>
                        <div className="form-group"><label htmlFor="origen">Origen del Hallazgo *</label><input type="text" id="origen" name="origen" value={formData.origen} onChange={handleChange} placeholder="Ej: Inspecci√≥n Extintores, Reporte Colaborador..." required /></div>
                        <div className="form-group"><label htmlFor="descripcionProblema">Descripci√≥n del Problema/Hallazgo *</label><textarea id="descripcionProblema" name="descripcionProblema" rows="3" value={formData.descripcionProblema} onChange={handleChange} required /></div>
                        <div className="form-group"><label htmlFor="planAccion">Plan de Acci√≥n *</label><textarea id="planAccion" name="planAccion" rows="3" value={formData.planAccion} onChange={handleChange} required /></div>
                        
                        <div className="form-group">
                            <label htmlFor="idUsuarioResponsable">Responsable de la Ejecuci√≥n *</label>
                            <select id="idUsuarioResponsable" name="idUsuarioResponsable" value={formData.idUsuarioResponsable} onChange={handleChange} required>
                                <option value="">-- Seleccione un responsable --</option>
                                {listaUsuarios.map(user => (
                                    <option key={user.ID_Usuario} value={user.ID_Usuario}>
                                        {user.NombreCompleto}
                                    </option>
                                ))}
                            </select>
                        </div>
                        
                        <div className="form-group"><label htmlFor="fechaLimite">Fecha L√≠mite *</label><input type="date" id="fechaLimite" name="fechaLimite" value={formData.fechaLimite} onChange={handleChange} min={new Date().toISOString().split('T')[0]} required /></div>
                        <div className="form-group"><label htmlFor="analisisCausa">An√°lisis de Causa (Opcional)</label><textarea id="analisisCausa" name="analisisCausa" rows="3" value={formData.analisisCausa} onChange={handleChange} /></div>

                        {error && <p className="modal-error">{error}</p>}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Creando...' : 'Crear Acci√≥n'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalCrearACPM;


==================================================================
ARCHIVO: frontend\src\components\ModalCrearActa.jsx
==================================================================
// frontend/src/components/ModalCrearActa.jsx

import React, { useState } from 'react';
import { crearActa } from '../services/committeeService';
import '../style/Modal.css';
import Swal from 'sweetalert2';
import { BsPlusCircle, BsTrash, BsCloudUpload, BsFileEarmarkText } from 'react-icons/bs';

const ModalCrearActa = ({ alCerrar, alExito }) => {
    const [step, setStep] = useState(1);
    const [isLoading, setIsLoading] = useState(false);
    const [modoSubida, setModoSubida] = useState('GENERAR'); // 'GENERAR' o 'SUBIR'

    // Datos Generales
    const [form, setForm] = useState({
        codigoDocumento: 'FTO-SST-COM-01', 
        fechaEmision: '', 
        fechaRevision: '', 
        version: '1',
        numeroActa: '', 
        lugar: 'Sala de Juntas', 
        fechaReunion: new Date().toISOString().split('T')[0], 
        horaInicio: '', 
        horaFin: '',
        objetivo: '', 
        desarrollo: '', 
        nombrePresidente: '', 
        nombreSecretario: ''
    });

    const [asistentes, setAsistentes] = useState([{ Nombre: '', Cargo: '' }]);
    const [compromisos, setCompromisos] = useState([{ Compromiso: '', Responsable: '', FechaEjecucion: '' }]);
    
    const [archivoManual, setArchivoManual] = useState(null);

    const handleForm = (e) => setForm({ ...form, [e.target.name]: e.target.value });
    
    // --- L√≥gica de Listas (Solo usadas en modo GENERAR) ---
    const updateAsistente = (idx, field, val) => {
        const newAsistentes = [...asistentes];
        newAsistentes[idx][field] = val;
        setAsistentes(newAsistentes);
    };
    const addAsistente = () => setAsistentes([...asistentes, { Nombre: '', Cargo: '' }]);
    const removeAsistente = (idx) => setAsistentes(asistentes.filter((_, i) => i !== idx));

    const updateCompromiso = (idx, field, val) => {
        const newComp = [...compromisos];
        newComp[idx][field] = val;
        setCompromisos(newComp);
    };
    const addCompromiso = () => setCompromisos([...compromisos, { Compromiso: '', Responsable: '', FechaEjecucion: '' }]);
    const removeCompromiso = (idx) => setCompromisos(compromisos.filter((_, i) => i !== idx));

    // --- ENVIAR ---
    const handleSubmit = async () => {
        // VALIDACI√ìN B√ÅSICA (Aplica para ambos modos)
        if (!form.numeroActa || !form.fechaReunion) {
            Swal.fire('Faltan datos', 'El N¬∞ de Acta y la Fecha son obligatorios para el historial.', 'warning');
            return;
        }

        // VALIDACI√ìN ESPEC√çFICA MODO SUBIR
        if (modoSubida === 'SUBIR' && !archivoManual) {
            Swal.fire('Atenci√≥n', 'Debes seleccionar el archivo PDF del acta.', 'warning');
            return;
        }

        setIsLoading(true);
        try {
            const formData = new FormData();
            
            // 1. Datos del Formulario
            Object.keys(form).forEach(key => {
                // Si estamos en modo SUBIR, llenamos los campos de texto obligatorios con un default
                // para que la base de datos (NOT NULL) no falle.
                if (modoSubida === 'SUBIR' && (key === 'objetivo' || key === 'desarrollo')) {
                    formData.append(key, form[key] || 'Contenido en documento adjunto.');
                } else if (modoSubida === 'SUBIR' && (key === 'horaInicio' || key === 'horaFin')) {
                     formData.append(key, form[key] || '00:00');
                } else {
                    formData.append(key, form[key]);
                }
            });
            
            // 2. Listas (En modo SUBIR se env√≠an vac√≠as para no ensuciar la BD)
            if (modoSubida === 'GENERAR') {
                formData.append('asistentes', JSON.stringify(asistentes));
                formData.append('compromisos', JSON.stringify(compromisos));
            } else {
                formData.append('asistentes', '[]');
                formData.append('compromisos', '[]');
            }

            // 3. Archivo
            if (modoSubida === 'SUBIR' && archivoManual) {
                formData.append('archivoManual', archivoManual);
            }

            // Llamada al servicio
            await crearActa(formData);
            
            Swal.fire('√âxito', 'Acta guardada correctamente', 'success');
            alExito();
        } catch (error) {
            console.error(error);
            Swal.fire('Error', error.message || 'Error al guardar', 'error');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content modal-lg" style={{maxWidth: '800px'}}>
                <div className="modal-header">
                    <h2>
                        {modoSubida === 'GENERAR' ? `Crear Acta - Paso ${step}/4` : 'Subir Acta Existente'}
                    </h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body" style={{maxHeight:'65vh', overflowY:'auto'}}>
                    
                    {/* --- SELECTOR DE MODO --- */}
                    <div style={{display:'flex', gap:'10px', marginBottom:'1.5rem', backgroundColor:'#f8f9fa', padding:'10px', borderRadius:'8px', justifyContent:'center'}}>
                        <button 
                            className={`btn ${modoSubida==='GENERAR'?'btn-primary':'btn-secondary'}`} 
                            onClick={()=>{setModoSubida('GENERAR'); setStep(1);}}
                            style={{minWidth:'180px'}}
                        >
                            <BsFileEarmarkText /> Generar PDF (Wizard)
                        </button>
                        <button 
                            className={`btn ${modoSubida==='SUBIR'?'btn-primary':'btn-secondary'}`} 
                            onClick={()=>{setModoSubida('SUBIR'); setStep(1);}}
                            style={{minWidth:'180px'}}
                        >
                            <BsCloudUpload /> Subir PDF Listo
                        </button>
                    </div>

                    {/* =========================================================
                        VISTA PARA SUBIR PDF (FORMULARIO CORTO)
                       ========================================================= */}
                    {modoSubida === 'SUBIR' && (
                        <div className="fade-in">
                            <p style={{color:'#666', marginBottom:'1rem', textAlign:'center'}}>
                                Utiliza esta opci√≥n si ya tienes el acta firmada o escaneada. Solo necesitamos los datos b√°sicos para el √≠ndice.
                            </p>

                            <div className="form-group-row">
                                <div className="form-group">
                                    <label>N¬∞ Acta *</label>
                                    <input name="numeroActa" className="form-control" value={form.numeroActa} onChange={handleForm} placeholder="Ej: 005-2025" required autoFocus/>
                                </div>
                                <div className="form-group">
                                    <label>Fecha Reuni√≥n *</label>
                                    <input type="date" name="fechaReunion" className="form-control" value={form.fechaReunion} onChange={handleForm} required/>
                                </div>
                                <div className="form-group">
                                    <label>Lugar</label>
                                    <input name="lugar" className="form-control" value={form.lugar} onChange={handleForm} />
                                </div>
                            </div>

                            {/* Campos opcionales para mejorar la b√∫squeda futura */}
                            <div className="form-group">
                                <label>Objetivo / Tema Principal (Para b√∫squedas)</label>
                                <input name="objetivo" className="form-control" value={form.objetivo} onChange={handleForm} placeholder="Ej: Revisi√≥n indicadores trimestrales"/>
                            </div>

                            <div className="form-group" style={{marginTop:'20px', border:'2px dashed #007BFF', padding:'30px', textAlign:'center', backgroundColor:'#e7f1ff', borderRadius:'10px'}}>
                                <label style={{display:'block', marginBottom:'10px', fontSize:'1.1rem', color:'#005A5B', fontWeight:'bold'}}>
                                    <BsCloudUpload size={24} style={{verticalAlign:'middle', marginRight:'8px'}}/>
                                    Seleccionar Archivo PDF
                                </label>
                                <input 
                                    type="file" 
                                    className="form-control" 
                                    accept=".pdf" 
                                    onChange={(e) => setArchivoManual(e.target.files[0])} 
                                    style={{maxWidth:'400px', margin:'0 auto'}}
                                />
                                <small style={{display:'block', marginTop:'5px', color:'#666'}}>M√°ximo 10MB</small>
                            </div>
                        </div>
                    )}


                    {/* =========================================================
                        VISTA PARA GENERAR PDF (WIZARD 4 PASOS)
                       ========================================================= */}
                    {modoSubida === 'GENERAR' && (
                        <div className="fade-in">
                            {/* PASO 1: METADATA */}
                            {step === 1 && (
                                <>
                                    <div className="form-group-row">
                                        <div className="form-group"><label>N¬∞ Acta *</label><input name="numeroActa" className="form-control" value={form.numeroActa} onChange={handleForm} required/></div>
                                        <div className="form-group"><label>Lugar</label><input name="lugar" className="form-control" value={form.lugar} onChange={handleForm} /></div>
                                        <div className="form-group"><label>Fecha Reuni√≥n *</label><input type="date" name="fechaReunion" className="form-control" value={form.fechaReunion} onChange={handleForm} required/></div>
                                    </div>
                                    <div className="form-group-row">
                                        <div className="form-group"><label>Hora Inicio</label><input type="time" name="horaInicio" className="form-control" value={form.horaInicio} onChange={handleForm} /></div>
                                        <div className="form-group"><label>Hora Fin</label><input type="time" name="horaFin" className="form-control" value={form.horaFin} onChange={handleForm} /></div>
                                    </div>
                                    
                                    <h4 style={{borderBottom:'1px solid #eee', marginTop:'1rem', color:'#005A5B'}}>Datos de Control (Encabezado PDF)</h4>
                                    <div className="form-group-row">
                                        <div className="form-group"><label>C√≥digo</label><input name="codigoDocumento" className="form-control" value={form.codigoDocumento} onChange={handleForm} /></div>
                                        <div className="form-group"><label>Versi√≥n</label><input name="version" className="form-control" value={form.version} onChange={handleForm} /></div>
                                        <div className="form-group"><label>Fecha Emisi√≥n</label><input type="date" name="fechaEmision" className="form-control" value={form.fechaEmision} onChange={handleForm} /></div>
                                        <div className="form-group"><label>Fecha Revisi√≥n</label><input type="date" name="fechaRevision" className="form-control" value={form.fechaRevision} onChange={handleForm} /></div>
                                    </div>
                                </>
                            )}

                            {/* PASO 2: ASISTENTES */}
                            {step === 2 && (
                                <>
                                    <h4>Verificaci√≥n de Quorum (Asistentes)</h4>
                                    {asistentes.map((asis, idx) => (
                                        <div key={idx} style={{display:'flex', gap:'10px', marginBottom:'10px', alignItems:'center'}}>
                                            <input placeholder="Nombre Completo" className="form-control" value={asis.Nombre} onChange={(e) => updateAsistente(idx, 'Nombre', e.target.value)} />
                                            <input placeholder="Cargo" className="form-control" value={asis.Cargo} onChange={(e) => updateAsistente(idx, 'Cargo', e.target.value)} />
                                            <button className="btn btn-danger btn-sm" onClick={() => removeAsistente(idx)}><BsTrash/></button>
                                        </div>
                                    ))}
                                    <button className="btn btn-secondary btn-sm" onClick={addAsistente}><BsPlusCircle/> Agregar Asistente</button>
                                </>
                            )}

                            {/* PASO 3: CONTENIDO */}
                            {step === 3 && (
                                <>
                                    <div className="form-group">
                                        <label>Objetivo de la Reuni√≥n</label>
                                        <textarea name="objetivo" className="form-control" rows="2" value={form.objetivo} onChange={handleForm}></textarea>
                                    </div>
                                    <div className="form-group">
                                        <label>Desarrollo de la Reuni√≥n</label>
                                        <textarea name="desarrollo" className="form-control" rows="4" value={form.desarrollo} onChange={handleForm}></textarea>
                                    </div>

                                    <h4>Compromisos</h4>
                                    {compromisos.map((comp, idx) => (
                                        <div key={idx} style={{display:'flex', gap:'5px', marginBottom:'10px', alignItems:'center'}}>
                                            <input placeholder="Compromiso" className="form-control" style={{flex:2}} value={comp.Compromiso} onChange={(e) => updateCompromiso(idx, 'Compromiso', e.target.value)} />
                                            <input placeholder="Responsable" className="form-control" style={{flex:1}} value={comp.Responsable} onChange={(e) => updateCompromiso(idx, 'Responsable', e.target.value)} />
                                            <input type="date" className="form-control" style={{width:'130px'}} value={comp.FechaEjecucion} onChange={(e) => updateCompromiso(idx, 'FechaEjecucion', e.target.value)} />
                                            <button className="btn btn-danger btn-sm" onClick={() => removeCompromiso(idx)}><BsTrash/></button>
                                        </div>
                                    ))}
                                    <button className="btn btn-secondary btn-sm" onClick={addCompromiso}><BsPlusCircle/> Agregar Compromiso</button>
                                </>
                            )}

                            {/* PASO 4: FIRMAS */}
                            {step === 4 && (
                                <>
                                    <h4>Firmas (Aparecer√°n en el PDF)</h4>
                                    <div className="form-group-row">
                                        <div className="form-group"><label>Nombre Presidente</label><input name="nombrePresidente" className="form-control" value={form.nombrePresidente} onChange={handleForm} /></div>
                                        <div className="form-group"><label>Nombre Secretario</label><input name="nombreSecretario" className="form-control" value={form.nombreSecretario} onChange={handleForm} /></div>
                                    </div>
                                    
                                    <div style={{marginTop:'2rem', padding:'1rem', backgroundColor:'#e6f7ec', borderRadius:'8px', color:'#0f5132', textAlign:'center'}}>
                                        <BsFileEarmarkText size={20} style={{verticalAlign:'middle', marginRight:'10px'}}/>
                                        Al finalizar, el sistema generar√° autom√°ticamente el PDF con el formato oficial.
                                    </div>
                                </>
                            )}
                        </div>
                    )}
                </div>

                <div className="modal-footer">
                    {/* BOTONES MODO GENERAR (WIZARD) */}
                    {modoSubida === 'GENERAR' && (
                        <>
                            {step > 1 && <button className="btn btn-secondary" onClick={() => setStep(step - 1)}>Atr√°s</button>}
                            {step < 4 && <button className="btn btn-primary" onClick={() => setStep(step + 1)}>Siguiente</button>}
                            {step === 4 && (
                                <button className="btn btn-success" onClick={handleSubmit} disabled={isLoading}>
                                    {isLoading ? 'Generando PDF...' : 'Finalizar y Crear'}
                                </button>
                            )}
                        </>
                    )}

                    {/* BOTONES MODO SUBIR (DIRECTO) */}
                    {modoSubida === 'SUBIR' && (
                        <>
                            <button className="btn btn-secondary" onClick={alCerrar}>Cancelar</button>
                            <button className="btn btn-success" onClick={handleSubmit} disabled={isLoading}>
                                {isLoading ? 'Subiendo...' : 'Guardar y Subir'}
                            </button>
                        </>
                    )}
                </div>
            </div>
        </div>
    );
};

export default ModalCrearActa;


==================================================================
ARCHIVO: frontend\src\components\ModalCrearActividad.jsx
==================================================================
// frontend/src/componentes/ModalCrearActividad.jsx

import React, { useState, useEffect } from 'react';
import { crearActividad } from '../services/scheduleService';
import { getTodosUsuarios } from '../services/userService'; 
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; // <-- 1. Importar

const ModalCrearActividad = ({ idCronograma, alCerrar, alExito }) => {
    const getManana = () => {
        const manana = new Date();
        manana.setDate(manana.getDate() + 1);
        return manana.toISOString().split('T')[0];
    };
    const [formData, setFormData] = useState({
        nombreActividad: '',
        idUsuarioResponsable: '',
        fechaLimite: getManana(),
        descripcion: ''
    });
    const [listaUsuarios, setListaUsuarios] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    useEffect(() => {
        const cargarUsuarios = async () => {
            try {
                const data = await getTodosUsuarios();
                setListaUsuarios(data);
            } catch (err) {
                console.error("Error cargando usuarios:", err);
                setError("No se pudo cargar la lista de responsables");
            }
        };
        cargarUsuarios();
    }, []);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({ ...prevState, [name]: value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setIsLoading(true);
        try {
            const payload = { ...formData, idUsuarioResponsable: parseInt(formData.idUsuarioResponsable) };
            await crearActividad(idCronograma, payload);
            
            // --- 2. REEMPLAZAR 'alert()' ---
            Swal.fire({
                title: '¬°√âxito!',
                text: 'Actividad creada exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            alExito(); 
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>A√±adir Nueva Actividad</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        {/* (Inputs del formulario sin cambios) */}
                        <div className="form-group"><label htmlFor="nombreActividad">Nombre de la Actividad *</label><input type="text" id="nombreActividad" name="nombreActividad" value={formData.nombreActividad} onChange={handleChange} placeholder="Ej: Capacitaci√≥n Uso de EPP" required /></div>
                        <div className="form-group"><label htmlFor="idUsuarioResponsable">Responsable *</label><select id="idUsuarioResponsable" name="idUsuarioResponsable" value={formData.idUsuarioResponsable} onChange={handleChange} required><option value="">-- Seleccione un responsable --</option>{listaUsuarios.map(user => (<option key={user.ID_Usuario} value={user.ID_Usuario}>{user.NombreCompleto}</option>))}</select></div>
                        <div className="form-group"><label htmlFor="fechaLimite">Fecha L√≠mite *</label><input type="date" id="fechaLimite" name="fechaLimite" value={formData.fechaLimite} onChange={handleChange} min={getManana()} required /></div>
                        <div className="form-group"><label htmlFor="descripcion">Descripci√≥n (Opcional)</label><input type="text" id="descripcion" name="descripcion" value={formData.descripcion} onChange={handleChange} /></div>
                        {error && <p className="modal-error">{error}</p>}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Creando...' : 'A√±adir Actividad'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalCrearActividad;


==================================================================
ARCHIVO: frontend\src\components\ModalCrearActivo.jsx
==================================================================
// frontend/src/components/ModalCrearActivo.jsx

import React, { useState, useEffect } from 'react';
import { crearActivo, getTiposActivosDisponibles } from '../services/assetService';
import { getColaboradores } from '../services/userService';
import { useAuth } from '../context/AuthContext';
import '../style/Modal.css';
import '../index.css';
import Swal from 'sweetalert2';

const ModalCrearActivo = ({ alCerrar, alExito }) => {
    // eslint-disable-next-line no-unused-vars
    const { usuario } = useAuth(); 

    const [formData, setFormData] = useState({
        tipoActivo: '',
        codigoIdentificador: '',
        nombreDescriptivo: '',
        ubicacion: '',
        // Campos extra para Veh√≠culos
        marca: '',
        modelo: '',
        soatVencimiento: '',
        tecnoVencimiento: '',
        kilometrajeInicial: 0,
        idConductor: ''
    });

    const [listaTipos, setListaTipos] = useState([]); // Array de objetos { TipoActivoAsociado, Categoria }
    const [listaConductores, setListaConductores] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    useEffect(() => {
        const cargarDatos = async () => {
            try {
                // 1. Cargar Tipos (Ahora trae la categor√≠a)
                const tipos = await getTiposActivosDisponibles();
                setListaTipos(tipos);
                
                // Pre-seleccionar el primer tipo si existe
                if (tipos.length > 0) {
                    setFormData(prev => ({ ...prev, tipoActivo: tipos[0].TipoActivoAsociado }));
                }

                // 2. Cargar Usuarios (Para asignar como conductores)
                const users = await getColaboradores(); 
                setListaConductores(users);

            } catch (err) {
                console.error("Error cargando datos:", err);
                setError('Error cargando las listas de configuraci√≥n.');
            }
        };
        cargarDatos();
    }, []);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({ ...prevState, [name]: value }));
    };

    // --- L√ìGICA INTELIGENTE ---
    // Busca el objeto completo en la lista para ver su categor√≠a
    const esVehiculo = () => {
        const tipoSeleccionado = listaTipos.find(t => t.TipoActivoAsociado === formData.tipoActivo);
        // Si la categor√≠a en BD es 'Vehiculo', mostramos los campos
        return tipoSeleccionado?.Categoria === 'Vehiculo';
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setIsLoading(true);

        try {
            // Preparar payload: Limpiar datos num√©ricos si est√°n vac√≠os
            const payload = {
                ...formData,
                kilometrajeInicial: formData.kilometrajeInicial || 0,
                idConductor: formData.idConductor || null
            };

            await crearActivo(payload);
            
            Swal.fire({
                title: '¬°√âxito!',
                text: 'Activo creado exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            alExito(); 
            
        } catch (err) {
            Swal.fire('Error', err.message, 'error');
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Crear Nuevo Activo</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <form onSubmit={handleSubmit}>
                    <div className="modal-body" style={{maxHeight: '70vh', overflowY: 'auto'}}>
                        
                        <div className="form-group">
                            <label htmlFor="tipoActivo">Tipo de Activo *</label>
                            {listaTipos.length === 0 ? (
                                <p style={{color: 'orange'}}>Cargando tipos...</p>
                            ) : (
                                <select 
                                    id="tipoActivo" 
                                    name="tipoActivo" 
                                    value={formData.tipoActivo} 
                                    onChange={handleChange} 
                                    required
                                >
                                    {listaTipos.map((t, index) => (
                                        <option key={index} value={t.TipoActivoAsociado}>{t.TipoActivoAsociado}</option>
                                    ))}
                                </select>
                            )}
                        </div>

                        {/* CAMPOS COMUNES */}
                        <div className="form-group">
                            <label>{esVehiculo() ? 'Placa del Veh√≠culo *' : 'C√≥digo Identificador *'}</label>
                            <input type="text" name="codigoIdentificador" value={formData.codigoIdentificador} onChange={handleChange} placeholder={esVehiculo() ? "Ej: ABC-123" : "Ej: MAQ-01"} required />
                        </div>
                        <div className="form-group">
                            <label>Nombre Descriptivo *</label>
                            <input type="text" name="nombreDescriptivo" value={formData.nombreDescriptivo} onChange={handleChange} placeholder={esVehiculo() ? "Ej: Camioneta N300 - Repartos" : "Ej: Taladro de Banco"} required />
                        </div>
                        <div className="form-group">
                            <label>Ubicaci√≥n / √Årea</label>
                            <input type="text" name="ubicacion" value={formData.ubicacion} onChange={handleChange} placeholder="Ej: Parqueadero / Bodega" />
                        </div>

                        {/* --- SECCI√ìN DIN√ÅMICA DE VEH√çCULOS --- */}
                        {esVehiculo() && (
                            <div style={{backgroundColor: '#f8f9fa', padding: '1rem', borderRadius: '8px', border: '1px solid #dee2e6', marginTop: '1rem'}}>
                                <h4 style={{marginTop:0, color: 'var(--color-primario)', borderBottom: '1px solid #ddd', paddingBottom: '5px'}}>Datos del Veh√≠culo</h4>
                                
                                <div style={{display: 'flex', gap: '10px'}}>
                                    <div className="form-group" style={{flex: 1}}>
                                        <label>Marca</label>
                                        <input type="text" name="marca" value={formData.marca} onChange={handleChange} placeholder="Ej: Chevrolet" />
                                    </div>
                                    <div className="form-group" style={{flex: 1}}>
                                        <label>Modelo</label>
                                        <input type="text" name="modelo" value={formData.modelo} onChange={handleChange} placeholder="Ej: 2024" />
                                    </div>
                                </div>

                                <div className="form-group">
                                    <label>Conductor Asignado</label>
                                    <select name="idConductor" value={formData.idConductor} onChange={handleChange}>
                                        <option value="">-- Sin asignar --</option>
                                        {listaConductores.map(u => (
                                            <option key={u.ID_Usuario} value={u.ID_Usuario}>{u.NombreCompleto} ({u.CedulaUsuario})</option>
                                        ))}
                                    </select>
                                </div>

                                <div className="form-group">
                                    <label>Kilometraje Inicial</label>
                                    <input type="number" name="kilometrajeInicial" value={formData.kilometrajeInicial} onChange={handleChange} placeholder="0" />
                                </div>

                                <div style={{display: 'flex', gap: '10px'}}>
                                    <div className="form-group" style={{flex: 1}}>
                                        <label>Vencimiento SOAT</label>
                                        <input type="date" name="soatVencimiento" value={formData.soatVencimiento} onChange={handleChange} />
                                    </div>
                                    <div className="form-group" style={{flex: 1}}>
                                        <label>Venc. Tecnomec√°nica</label>
                                        <input type="date" name="tecnoVencimiento" value={formData.tecnoVencimiento} onChange={handleChange} />
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* --- FIN SECCI√ìN VEH√çCULOS --- */}

                        {error && <p className="modal-error">{error}</p>}
                    </div>

                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>
                            {isLoading ? 'Creando...' : 'Crear Activo'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalCrearActivo;


==================================================================
ARCHIVO: frontend\src\components\ModalCrearCarpeta.jsx
==================================================================
// frontend/src/componentes/ModalCrearCarpeta.jsx
import React, { useState } from 'react';
import { crearCarpeta } from '../services/documentService';
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; // <-- Importar

const ModalCrearCarpeta = ({ idCarpetaPadre, alCerrar, alExito }) => {
    const [nombreCarpeta, setNombreCarpeta] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleSubmit = async (e) => {
        e.preventDefault(); setError(''); setIsLoading(true);
        try {
            await crearCarpeta(nombreCarpeta, idCarpetaPadre);
            Swal.fire({ title: '¬°√âxito!', text: 'Carpeta creada exitosamente.', icon: 'success', timer: 2000, showConfirmButton: false });
            alExito(); 
        } catch (err) { setError(err.message); } finally { setIsLoading(false); }
    };
    return (
        <div className="modal-overlay" onClick={alCerrar}><div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header"><h2>Crear Nueva Carpeta</h2><button onClick={alCerrar} className="modal-close-button">&times;</button></div>
            <form onSubmit={handleSubmit}>
                <div className="modal-body">
                    <div className="form-group"><label htmlFor="nombreCarpeta">Nombre de la Carpeta *</label><input type="text" id="nombreCarpeta" name="nombreCarpeta" value={nombreCarpeta} onChange={(e) => setNombreCarpeta(e.target.value)} autoFocus required /></div>
                    {error && <p className="modal-error">{error}</p>}
                </div>
                <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button><button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Creando...' : 'Crear Carpeta'}</button></div>
            </form>
        </div></div>
    );
};
export default ModalCrearCarpeta;


==================================================================
ARCHIVO: frontend\src\components\ModalCrearCronograma.jsx
==================================================================
// frontend/src/componentes/ModalCrearCronograma.jsx

import React, { useState } from 'react';
import { crearCronograma } from '../services/scheduleService';
import '../style/Modal.css';
import '../index.css';
import Swal from 'sweetalert2'; // <-- 1. Importar

const ModalCrearCronograma = ({ alCerrar, alExito }) => {
    const [formData, setFormData] = useState({
        nombreCronograma: '',
        anioAplicacion: new Date().getFullYear(),
        descripcion: ''
    });
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(''); // (Lo mantenemos para errores en l√≠nea)

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({ ...prevState, [name]: value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setIsLoading(true);
        try {
            await crearCronograma(formData);
            
            // --- 2. REEMPLAZAR 'alert()' ---
            Swal.fire({
                title: '¬°√âxito!',
                text: 'Cronograma creado exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            alExito(); 
        } catch (err) {
            setError(err.message); // Muestra el error en el modal
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Crear Nuevo Cronograma</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        {/* (Inputs del formulario sin cambios) */}
                        <div className="form-group"><label htmlFor="nombreCronograma">Nombre del Cronograma *</label><input type="text" id="nombreCronograma" name="nombreCronograma" value={formData.nombreCronograma} onChange={handleChange} placeholder="Ej: Plan Anual SST 2025" required /></div>
                        <div className="form-group"><label htmlFor="anioAplicacion">A√±o de Aplicaci√≥n (Opcional)</label><input type="number" id="anioAplicacion" name="anioAplicacion" value={formData.anioAplicacion} onChange={handleChange} placeholder="Ej: 2025" /></div>
                        <div className="form-group"><label htmlFor="descripcion">Descripci√≥n (Opcional)</label><input type="text" id="descripcion" name="descripcion" value={formData.descripcion} onChange={handleChange} /></div>
                        {error && <p className="modal-error">{error}</p>}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Creando...' : 'Crear Cronograma'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalCrearCronograma;


==================================================================
ARCHIVO: frontend\src\components\ModalCrearFormulario.jsx
==================================================================
// frontend/src/components/ModalCrearFormulario.jsx

import React, { useState, useEffect } from 'react';
import { crearNuevoFormulario, editarFormulario, getTiposActivosUnicos } from '../services/inspectionService';
import '../style/Modal.css';
import '../index.css';
import Swal from 'sweetalert2';
import { BsPlusLg, BsTrash } from 'react-icons/bs';

const ModalCrearFormulario = ({ formularioEditar, alCerrar, alExito }) => {
    
    const isEditMode = !!formularioEditar; // Detecta si estamos editando

    const [formData, setFormData] = useState({
        idFormulario: '',
        nombreFormulario: '',
        descripcion: '',
        tipoActivoAsociado: '',
        categoria: 'General',
        visibleColaborador: false
    });

    // Preguntas (Solo para creaci√≥n)
    const [preguntas, setPreguntas] = useState([{ id: 1, texto: '' }]);
    
    // Estados para el selector inteligente
    const [listaTiposExistentes, setListaTiposExistentes] = useState([]);
    const [tipoInputMode, setTipoInputMode] = useState('select'); // 'select' o 'text'
    
    const [isLoading, setIsLoading] = useState(false);

    useEffect(() => {
        // 1. Cargar lista de tipos de activos existentes
        const cargarTipos = async () => {
            try {
                const tipos = await getTiposActivosUnicos();
                setListaTiposExistentes(tipos);
            } catch (e) { console.error(e); }
        };
        cargarTipos();

        // 2. Si es edici√≥n, llenar los campos
        if (isEditMode) {
            setFormData({
                idFormulario: formularioEditar.ID_Formulario,
                nombreFormulario: formularioEditar.NombreFormulario,
                descripcion: formularioEditar.Descripcion || '',
                tipoActivoAsociado: formularioEditar.TipoActivoAsociado,
                categoria: formularioEditar.Categoria,
                visibleColaborador: formularioEditar.VisibleColaborador
            });
            // En modo edici√≥n, verificamos si el tipo actual est√° en la lista
            // Si no est√°, cambiamos a modo texto para que se vea
            setTipoInputMode('text'); 
        }
    }, [isEditMode, formularioEditar]);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData({ ...formData, [name]: value });
    };

    // Manejo de Preguntas (Solo Creaci√≥n)
    const handlePreguntaChange = (id, texto) => {
        setPreguntas(preguntas.map(p => p.id === id ? { ...p, texto } : p));
    };
    const agregarPregunta = () => {
        const nuevoId = preguntas.length > 0 ? Math.max(...preguntas.map(p => p.id)) + 1 : 1;
        setPreguntas([...preguntas, { id: nuevoId, texto: '' }]);
    };
    const eliminarPregunta = (id) => {
        if (preguntas.length > 1) setPreguntas(preguntas.filter(p => p.id !== id));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        
        if (!isEditMode && preguntas.some(p => !p.texto.trim())) {
            Swal.fire('Error', 'Todas las preguntas deben tener texto.', 'warning');
            return;
        }

        setIsLoading(true);
        try {
            if (isEditMode) {
                // L√≥gica Edici√≥n
                await editarFormulario(formData.idFormulario, formData);
                Swal.fire('¬°Actualizado!', 'El formulario ha sido actualizado.', 'success');
            } else {
                // L√≥gica Creaci√≥n
                const payload = {
                    ...formData,
                    preguntas: preguntas.map((p, index) => ({ texto: p.texto, orden: index + 1 }))
                };
                await crearNuevoFormulario(payload);
                Swal.fire({ icon: 'success', title: '¬°Formulario Creado!', text: 'Ahora puedes asociar activos a este formulario.' });
            }
            alExito();
        } catch (err) {
            Swal.fire('Error', err.message, 'error');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>{isEditMode ? 'Editar Formulario' : 'Crear Nuevo Formulario'}</h2>
                    <button className="modal-close-button" onClick={alCerrar}>&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body" style={{maxHeight: '70vh', overflowY: 'auto'}}>
                        
                        <div className="form-group">
                            <label>C√≥digo Identificador *</label>
                            <input 
                                name="idFormulario" 
                                value={formData.idFormulario} 
                                onChange={handleChange} 
                                required 
                                placeholder="Ej: FTO-SST-TRACTO" 
                                disabled={isEditMode} // No editable en modo edici√≥n
                                style={isEditMode ? {backgroundColor: '#e9ecef', cursor:'not-allowed'} : {}}
                            />
                            <small style={{color:'#666'}}>Este c√≥digo es √∫nico y no se puede cambiar despu√©s.</small>
                        </div>

                        <div className="form-group">
                            <label>Nombre del Formulario *</label>
                            <input name="nombreFormulario" value={formData.nombreFormulario} onChange={handleChange} required />
                        </div>

                        <div className="form-group">
                            <label>Descripci√≥n</label>
                            <input name="descripcion" value={formData.descripcion} onChange={handleChange} />
                        </div>
                        
                        <div style={{display:'flex', gap:'1rem', flexWrap: 'wrap'}}>
                            
                            {/* --- SELECTOR DE TIPO DE ACTIVO MEJORADO --- */}
                            <div className="form-group" style={{flex:1, minWidth: '250px'}}>
                                <label>Tipo de Activo Asociado *</label>
                                
                                <div style={{display:'flex', gap:'5px'}}>
                                    {tipoInputMode === 'select' ? (
                                        <select 
                                            className="form-control"
                                            name="tipoActivoAsociado" 
                                            value={formData.tipoActivoAsociado} 
                                            onChange={handleChange}
                                            required
                                        >
                                            <option value="">-- Seleccione uno existente --</option>
                                            {listaTiposExistentes.map((tipo, i) => (
                                                <option key={i} value={tipo}>{tipo}</option>
                                            ))}
                                        </select>
                                    ) : (
                                        <input 
                                            className="form-control"
                                            name="tipoActivoAsociado"
                                            value={formData.tipoActivoAsociado}
                                            onChange={handleChange}
                                            placeholder="Escriba el nuevo tipo..."
                                            required
                                        />
                                    )}
                                    
                                    <button 
                                        type="button" 
                                        className="btn btn-secondary" 
                                        style={{padding: '0 10px'}}
                                        onClick={() => {
                                            setTipoInputMode(prev => prev === 'select' ? 'text' : 'select');
                                            if (tipoInputMode === 'select') setFormData(prev => ({...prev, tipoActivoAsociado: ''}));
                                        }}
                                        title={tipoInputMode === 'select' ? "Crear nuevo tipo" : "Seleccionar existente"}
                                    >
                                        {tipoInputMode === 'select' ? <BsPlusLg /> : 'Lista'}
                                    </button>
                                </div>
                                <small style={{color:'#666'}}>
                                    {tipoInputMode === 'select' ? 'Selecciona un tipo existente de tus activos.' : 'Define un nuevo tipo de activo para el sistema.'}
                                </small>
                            </div>

                            {/* --- CATEGOR√çAS AJUSTADAS SEG√öN TU SOLICITUD --- */}
                            <div className="form-group" style={{flex:1, minWidth: '250px'}}>
                                <label>Categor√≠a del Comportamiento *</label>
                                <select name="categoria" value={formData.categoria} onChange={handleChange} required>
                                    <option value="General">General Inspecciones (Extintores, Orden y Aseo...)</option>
                                    <option value="Vehiculo">Veh√≠culo (Pide Placa, SOAT, KM)</option>
                                </select>
                            </div>
                        </div>

                        {/* SECCI√ìN DE PREGUNTAS (SOLO EN CREACI√ìN) */}
                        {!isEditMode && (
                            <>
                                <hr />
                                <h3>Preguntas Iniciales del Checklist</h3>
                                <p style={{fontSize:'0.9rem', color:'#666'}}>Podr√°s agregar o quitar m√°s preguntas despu√©s en el gestor.</p>
                                {preguntas.map((p, index) => (
                                    <div key={p.id} style={{ display: 'flex', gap: '10px', marginBottom: '10px' }}>
                                        <span style={{fontWeight: 'bold', marginTop: '10px'}}>{index + 1}.</span>
                                        <input type="text" value={p.texto} onChange={(e) => handlePreguntaChange(p.id, e.target.value)} placeholder="Escribe la pregunta..." style={{flex: 1}} required />
                                        <button type="button" className="btn btn-danger" onClick={() => eliminarPregunta(p.id)}><BsTrash /></button>
                                    </div>
                                ))}
                                <button type="button" className="btn btn-secondary" onClick={agregarPregunta}><BsPlusLg /> Agregar Pregunta</button>
                            </>
                        )}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Guardando...' : (isEditMode ? 'Actualizar' : 'Guardar')}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalCrearFormulario;


==================================================================
ARCHIVO: frontend\src\components\ModalCrearMantenimiento.jsx
==================================================================
// frontend/src/components/ModalCrearMantenimiento.jsx

import React, { useState } from 'react';
// eslint-disable-next-line no-unused-vars
import { crearMantenimiento } from '../services/pesvService'; // Aseg√∫rate que esta funci√≥n acepte FormData o modif√≠cala si es necesario
import '../style/Modal.css';
import Swal from 'sweetalert2';

const ModalCrearMantenimiento = ({ vehiculos, alCerrar, alExito }) => {
    const [form, setForm] = useState({
        idActivo: '',
        tipo: 'Preventivo',
        fecha: new Date().toISOString().split('T')[0],
        kilometraje: '',
        descripcion: '',
        taller: '',
        costo: 0
    });
    
    // Estado para el archivo
    const [archivo, setArchivo] = useState(null);
    const [isSaving, setIsSaving] = useState(false);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setIsSaving(true);

        // Usamos FormData para enviar archivo + datos
        const formData = new FormData();
        formData.append('idActivo', form.idActivo);
        formData.append('tipo', form.tipo);
        formData.append('fecha', form.fecha);
        formData.append('kilometraje', form.kilometraje);
        formData.append('descripcion', form.descripcion);
        formData.append('taller', form.taller);
        formData.append('costo', form.costo);
        
        if (archivo) {
            formData.append('evidencia', archivo);
        }

        try {
            // NOTA: crearMantenimiento en pesvService debe cambiarse ligeramente 
            // para aceptar el segundo argumento o manejar que le pasamos formData directo.
            // Para asegurar, llamamos a la API directamente aqu√≠ o ajustamos el servicio.
            // Opci√≥n Mejor: Ajustar el servicio abajo. Aqu√≠ asumimos que el servicio ya lo soporta.
            
            // Si tu servicio 'crearMantenimiento' usa apiFetch con JSON, fallar√° con FormData.
            // Haremos el fetch aqu√≠ directo para garantizar compatibilidad r√°pida.
            const token = localStorage.getItem('token');
            const response = await fetch('http://localhost:5000/api/pesv/mantenimientos', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }, // NO poner Content-Type
                body: formData
            });

            if(response.ok) {
                Swal.fire('Registrado', 'Mantenimiento guardado exitosamente.', 'success');
                alExito();
            } else {
                throw new Error('Error al guardar');
            }

        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        } finally {
            setIsSaving(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                    <h3>Registrar Mantenimiento</h3>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body" style={{maxHeight:'70vh', overflowY:'auto'}}>
                        <div className="form-group">
                            <label>Veh√≠culo *</label>
                            <select className="form-control" required value={form.idActivo} onChange={e => setForm({...form, idActivo: e.target.value})}>
                                <option value="">-- Seleccione --</option>
                                {vehiculos.map(v => <option key={v.ID_Activo} value={v.ID_Activo}>{v.NombreDescriptivo} ({v.CodigoIdentificador})</option>)}
                            </select>
                        </div>
                        <div style={{display:'flex', gap:'1rem'}}>
                            <div className="form-group" style={{flex:1}}>
                                <label>Tipo</label>
                                <select className="form-control" value={form.tipo} onChange={e => setForm({...form, tipo: e.target.value})}>
                                    <option>Preventivo</option>
                                    <option>Correctivo</option>
                                </select>
                            </div>
                            <div className="form-group" style={{flex:1}}>
                                <label>Fecha *</label>
                                <input type="date" className="form-control" required value={form.fecha} onChange={e => setForm({...form, fecha: e.target.value})} />
                            </div>
                        </div>
                        <div className="form-group">
                            <label>Kilometraje al momento *</label>
                            <input type="number" className="form-control" required value={form.kilometraje} onChange={e => setForm({...form, kilometraje: e.target.value})} />
                        </div>
                        <div className="form-group">
                            <label>Descripci√≥n del trabajo *</label>
                            <textarea className="form-control" rows="3" required value={form.descripcion} onChange={e => setForm({...form, descripcion: e.target.value})} />
                        </div>
                        <div style={{display:'flex', gap:'1rem'}}>
                            <div className="form-group" style={{flex:1}}>
                                <label>Taller / Proveedor</label>
                                <input type="text" className="form-control" value={form.taller} onChange={e => setForm({...form, taller: e.target.value})} />
                            </div>
                            <div className="form-group" style={{flex:1}}>
                                <label>Costo Total ($)</label>
                                <input type="number" className="form-control" value={form.costo} onChange={e => setForm({...form, costo: e.target.value})} />
                            </div>
                        </div>

                        {/* --- CAMPO PARA SUBIR EVIDENCIA --- */}
                        <div className="form-group" style={{marginTop:'1rem', background:'#f8f9fa', padding:'10px', borderRadius:'8px'}}>
                            <label>Adjuntar Factura / Reporte (Opcional)</label>
                            <input 
                                type="file" 
                                className="form-control" 
                                accept=".pdf,.jpg,.jpeg,.png"
                                onChange={(e) => setArchivo(e.target.files[0])}
                            />
                        </div>

                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isSaving}>
                            {isSaving ? 'Guardando...' : 'Registrar'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalCrearMantenimiento;


==================================================================
ARCHIVO: frontend\src\components\ModalCrearUsuario.jsx
==================================================================
// frontend/src/components/ModalCrearUsuario.jsx

import React, { useState, useEffect, useRef } from 'react';
import { crearColaborador, getRoles, buscarUsuarioExterno, getCargosEmpresa } from '../services/userService'; 
import { useAuth } from '../context/AuthContext'; 
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; 
import { BsCloudDownload, BsSearch, BsPersonPlusFill, BsPersonBadge, BsBuilding, BsBriefcase, BsCheck2 } from 'react-icons/bs';

const ModalCrearUsuario = ({ alCerrar, alExito, initialData = null }) => {
    const { usuario } = useAuth();

    const [formData, setFormData] = useState({
        nombreCompleto: '', cedula: '', password: '',
        idRol: '', area: '', cargo: ''
    });
    
    // --- ESTADOS PARA EL BUSCADOR DE CARGOS ---
    const [listaCargos, setListaCargos] = useState([]); // La lista completa de la BD
    const [cargosFiltrados, setCargosFiltrados] = useState([]); // La lista filtrada al escribir
    const [mostrarSugerencias, setMostrarSugerencias] = useState(false);
    const wrapperRef = useRef(null); // Para detectar clics fuera del buscador

    const [modo, setModo] = useState(initialData ? 'MANUAL' : 'IMPORTAR');
    const [busquedaExterna, setBusquedaExterna] = useState('');
    const [resultadosExternos, setResultadosExternos] = useState([]);
    const [buscando, setBuscando] = useState(false);
    const [rolesDisponibles, setRolesDisponibles] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    // 1. Cargar Datos Maestros
    useEffect(() => {
        const cargarDatosMaestros = async () => {
            try {
                // Cargar roles y cargos en paralelo
                const [rolesData, cargosData] = await Promise.all([
                    getRoles(),
                    getCargosEmpresa()
                ]);
                
                setListaCargos(cargosData);
                setCargosFiltrados(cargosData); // Inicialmente muestra todos

                // Roles
                if (usuario.rol === 'Super Admin') {
                    setRolesDisponibles(rolesData);
                } else {
                    const rolColaborador = rolesData.filter(r => r.NombreRol === 'Colaborador');
                    setRolesDisponibles(rolColaborador);
                    if (rolColaborador.length > 0) {
                        setFormData(prev => ({ ...prev, idRol: rolColaborador[0].ID_Rol }));
                    }
                }

                // Pre-llenado
                if (initialData) {
                    setFormData(prev => ({
                        ...prev,
                        nombreCompleto: initialData.NombreCompleto || '',
                        cedula: initialData.CedulaUsuario || '',
                        password: initialData.CedulaUsuario,
                        cargo: initialData.Cargo || '' // Seteamos el cargo inicial
                    }));
                }

            } catch (err) { 
                console.error(err);
                setError("No se pudieron cargar los datos de configuraci√≥n."); 
            }
        };
        cargarDatosMaestros();
    }, [usuario, initialData]);

    // 2. Manejador de clics fuera del buscador (para cerrar la lista)
    useEffect(() => {
        function handleClickOutside(event) {
            if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                setMostrarSugerencias(false);
            }
        }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, [wrapperRef]);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({ ...prevState, [name]: value }));
    };

    // --- L√ìGICA DEL BUSCADOR DE CARGOS ---
    const handleCargoChange = (e) => {
        const texto = e.target.value;
        setFormData(prev => ({ ...prev, cargo: texto }));
        
        // Filtrar la lista
        const filtrados = listaCargos.filter(c => 
            c.toLowerCase().includes(texto.toLowerCase())
        );
        setCargosFiltrados(filtrados);
        setMostrarSugerencias(true);
    };

    const seleccionarCargo = (cargo) => {
        setFormData(prev => ({ ...prev, cargo: cargo }));
        setMostrarSugerencias(false);
    };
    // ---------------------------------------

    const handleBuscarExterno = async (e) => {
        e.preventDefault();
        if (!busquedaExterna.trim()) return;
        setBuscando(true);
        setResultadosExternos([]); 
        try {
            const data = await buscarUsuarioExterno(busquedaExterna);
            setResultadosExternos(data);
            if (data.length === 0) setError('No se encontraron coincidencias en la base de datos de Gesti√≥n Humana.');
            else setError('');
        } catch (error) {
            console.error(error);
            setError('Error de conexi√≥n con la base de datos externa.');
        } finally { setBuscando(false); }
    };

    const seleccionarImportado = (usuarioExterno) => {
        setFormData(prev => ({
            ...prev,
            nombreCompleto: usuarioExterno.Nombre,
            cedula: usuarioExterno.Cedula,
            area: usuarioExterno.Area || '',
            password: usuarioExterno.Cedula,
            cargo: usuarioExterno.Cargo || '' // Importamos el cargo directamente al input
        }));
        
        setModo('MANUAL'); 
        Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Datos importados', showConfirmButton: false, timer: 1500 });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        if (!formData.idRol) { setError('El rol es obligatorio.'); return; }
        if (!formData.cargo) { setError('El cargo es obligatorio.'); return; }

        setIsLoading(true);
        try {
            const payload = { ...formData, idRol: parseInt(formData.idRol) };
            await crearColaborador(payload);
            alExito(formData.cedula); 
        } catch (err) { setError(err.message); } finally { setIsLoading(false); }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '600px'}}>
                
                <div className="modal-header">
                    <h2>{initialData ? 'Activar Usuario (Desde PESV)' : (modo === 'IMPORTAR' ? 'Importar Colaborador' : 'Crear Nuevo Usuario')}</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                {!initialData && (
                    <div style={{display:'flex', marginBottom:'1.5rem', borderBottom:'1px solid #eee'}}>
                        <button type="button" onClick={() => setModo('IMPORTAR')} style={{flex:1, padding:'10px', background:'none', border:'none', borderBottom: modo === 'IMPORTAR' ? '3px solid #007BFF' : '3px solid transparent', color: modo === 'IMPORTAR' ? '#007BFF' : '#666', fontWeight:'bold', cursor:'pointer'}}>
                            <BsCloudDownload /> Importar Colaborador
                        </button>
                        <button type="button" onClick={() => setModo('MANUAL')} style={{flex:1, padding:'10px', background:'none', border:'none', borderBottom: modo === 'MANUAL' ? '3px solid #007BFF' : '3px solid transparent', color: modo === 'MANUAL' ? '#007BFF' : '#666', fontWeight:'bold', cursor:'pointer'}}>
                            <BsPersonPlusFill /> Crear Manualmente
                        </button>
                    </div>
                )}

                {modo === 'IMPORTAR' && !initialData ? (
                    <div className="modal-body">
                        <p style={{fontSize:'0.9rem', color:'#666', marginBottom:'1rem'}}>Busque el colaborador en la base de datos externa.</p>
                        <form onSubmit={handleBuscarExterno} style={{display:'flex', gap:'10px', marginBottom:'1rem'}}>
                            <input className="form-control" placeholder="Ej: 1036... o Pepito P√©rez" value={busquedaExterna} onChange={e => setBusquedaExterna(e.target.value)} autoFocus />
                            <button className="btn btn-primary" type="submit" disabled={buscando}>{buscando ? '...' : <BsSearch />}</button>
                        </form>
                        
                        <div style={{maxHeight:'300px', overflowY:'auto', border:'1px solid #eee', borderRadius:'8px', backgroundColor:'#f9f9f9'}}>
                            {!buscando && resultadosExternos.length === 0 && !error && (
                                <div style={{padding:'2rem', textAlign:'center', color:'#ccc'}}><BsSearch style={{fontSize:'2rem', marginBottom:'10px'}}/><br/>Resultados aqu√≠.</div>
                            )}
                            {resultadosExternos.map((u, idx) => (
                                <div key={idx} onClick={() => seleccionarImportado(u)} style={{padding:'12px', borderBottom:'1px solid #eee', cursor:'pointer', backgroundColor:'white', display:'flex', alignItems:'center', gap:'1rem'}} onMouseEnter={e => e.currentTarget.style.backgroundColor = '#f0f7ff'} onMouseLeave={e => e.currentTarget.style.backgroundColor = 'white'}>
                                    <div style={{width:'40px', height:'40px', borderRadius:'50%', backgroundColor:'#e9ecef', color:'#005A5B', display:'flex', alignItems:'center', justifyContent:'center', fontWeight:'bold'}}>{u.Nombre.charAt(0)}</div>
                                    <div><div style={{fontWeight:'bold', color:'#333'}}>{u.Nombre}</div><div style={{fontSize:'0.8rem', color:'#666', display:'flex', gap:'10px'}}><span title="C√©dula"><BsPersonBadge/> {u.Cedula}</span><span title="Cargo"><BsBriefcase/> {u.Cargo}</span></div></div>
                                    <div style={{marginLeft:'auto'}}><span className="btn btn-sm btn-secondary" style={{fontSize:'0.7rem'}}>Seleccionar</span></div>
                                </div>
                            ))}
                        </div>
                        {error && <p className="modal-error" style={{marginTop:'1rem'}}>{error}</p>}
                    </div>
                ) : (
                    <form onSubmit={handleSubmit}>
                        <div className="modal-body" style={{maxHeight:'60vh', overflowY:'auto', overflowX:'visible'}}> {/* overflowX visible para el dropdown */}
                            
                            {initialData && (
                                <div style={{backgroundColor:'#e6f7ec', color:'#0d5e32', padding:'10px', borderRadius:'6px', marginBottom:'1rem', fontSize:'0.9rem'}}>
                                    <strong>¬°Listo!</strong> Datos cargados. Confirma el cargo y crea el usuario.
                                </div>
                            )}

                            <div className="form-group">
                                <label>Nombre Completo *</label>
                                <input type="text" name="nombreCompleto" className="form-control" value={formData.nombreCompleto} onChange={handleChange} required />
                            </div>
                            <div className="form-group">
                                <label>C√©dula (Usuario) *</label>
                                <input 
                                    type="text" name="cedula" className="form-control" 
                                    value={formData.cedula} onChange={handleChange} required 
                                    disabled={!!initialData} 
                                    style={initialData ? {backgroundColor: '#e9ecef'} : {}}
                                />
                            </div>
                            
                            <div style={{display:'flex', gap:'1rem', flexWrap:'wrap'}}>
                                <div className="form-group" style={{flex:1, minWidth: '200px'}}>
                                    <label>√Årea / Dpto</label>
                                    <div style={{position:'relative'}}>
                                        <BsBuilding style={{position:'absolute', top:'12px', left:'10px', color:'#999'}}/>
                                        <input type="text" name="area" className="form-control" style={{paddingLeft:'30px'}} value={formData.area} onChange={handleChange} />
                                    </div>
                                </div>
                                
                                {/* --- BUSCADOR DE CARGO INTELIGENTE --- */}
                                <div className="form-group" style={{flex:1, minWidth: '200px'}} ref={wrapperRef}>
                                    <label>Cargo *</label>
                                    <div style={{position:'relative'}}>
                                        <BsBriefcase style={{position:'absolute', top:'12px', left:'10px', color:'#999', zIndex: 1}}/>
                                        <input 
                                            type="text" 
                                            className="form-control" 
                                            style={{paddingLeft:'30px'}} 
                                            value={formData.cargo} 
                                            onChange={handleCargoChange}
                                            onFocus={() => setMostrarSugerencias(true)}
                                            placeholder="Buscar o escribir cargo..."
                                            required
                                            autoComplete="off"
                                        />
                                        
                                        {/* LISTA FLOTANTE DE SUGERENCIAS */}
                                        {mostrarSugerencias && (
                                            <div style={{
                                                position: 'absolute', top: '100%', left: 0, right: 0,
                                                backgroundColor: 'white', border: '1px solid #dee2e6',
                                                borderRadius: '0 0 8px 8px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                                maxHeight: '200px', overflowY: 'auto', zIndex: 1000
                                            }}>
                                                {cargosFiltrados.length > 0 ? (
                                                    cargosFiltrados.map((c, i) => (
                                                        <div 
                                                            key={i} 
                                                            onClick={() => seleccionarCargo(c)}
                                                            style={{
                                                                padding: '10px 15px', cursor: 'pointer', borderBottom: '1px solid #f0f0f0',
                                                                fontSize: '0.9rem', color: '#333'
                                                            }}
                                                            onMouseEnter={e => e.currentTarget.style.backgroundColor = '#f8f9fa'}
                                                            onMouseLeave={e => e.currentTarget.style.backgroundColor = 'white'}
                                                        >
                                                            {c}
                                                        </div>
                                                    ))
                                                ) : (
                                                    <div style={{padding: '10px', fontSize: '0.85rem', color: '#007BFF', fontStyle:'italic'}}>
                                                        <BsCheck2 /> Se crear√° como cargo nuevo
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <div className="form-group" style={{backgroundColor:'#fff3cd', padding:'10px', borderRadius:'6px', border:'1px solid #ffeeba'}}>
                                <label style={{color:'#856404'}}>Asignar Rol en SST *</label>
                                <select name="idRol" className="form-control" value={formData.idRol} onChange={handleChange} required>
                                    <option value="">-- Seleccione un Rol --</option>
                                    {rolesDisponibles.map(rol => (
                                        <option key={rol.ID_Rol} value={rol.ID_Rol}>{rol.NombreRol}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="form-group">
                                <label>Contrase√±a *</label>
                                <input type="password" name="password" className="form-control" value={formData.password} onChange={handleChange} required placeholder="M√≠nimo 6 caracteres" />
                            </div>
                            
                            {error && <p className="modal-error">{error}</p>}
                        </div>
                        <div className="modal-footer">
                            <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                            <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Creando...' : 'Crear y Continuar'}</button>
                        </div>
                    </form>
                )}
            </div>
        </div>
    );
};
export default ModalCrearUsuario;


==================================================================
ARCHIVO: frontend\src\components\ModalDetalleActividad.jsx
==================================================================
// frontend/src/components/ModalDetalleActividad.jsx

import React from 'react';
import '../style/Modal.css'; //
import '../index.css';

const ModalDetalleActividad = ({ actividad, alCerrar }) => {
    if (!actividad) return null;

    // Helper para fechas
    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        // Ajuste simple para zona horaria local
        const fecha = new Date(fechaISO.split('T')[0] + 'T00:00:00');
        return fecha.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    };

    const getEstadoClass = (estado) => {
        if (estado === 'Realizada') return 'status-activo';
        if (estado === 'Pendiente') return 'status-pendiente';
        return 'status-inactivo';
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={e => e.stopPropagation()}>
                
                {/* --- Encabezado --- */}
                <div className="modal-header">
                    <h2>Detalle de Actividad</h2>
                    <button className="modal-close-button" onClick={alCerrar}>&times;</button>
                </div>
                
                {/* --- Cuerpo (Usando estructura similar a form-group para consistencia) --- */}
                <div className="modal-body">
                    
                    {/* Nombre */}
                    <div className="form-group">
                        <label>Nombre de la Actividad:</label>
                        <p style={{ fontSize: '1.1rem', margin: '0.2rem 0', color: '#212529' }}>
                            {actividad.NombreActividad}
                        </p>
                    </div>

                    {/* Estado y Responsable (En fila) */}
                    <div style={{ display: 'flex', gap: '1.5rem', marginBottom: '1rem' }}>
                        <div style={{ flex: 1 }}>
                            <label style={{ display: 'block', fontSize: '0.9rem', fontWeight: '600', color: '#6c757d', marginBottom: '0.5rem' }}>
                                Estado:
                            </label>
                            <span className={`status-pill ${getEstadoClass(actividad.EstadoActividad)}`}>
                                {actividad.EstadoActividad}
                            </span>
                        </div>
                        <div style={{ flex: 1 }}>
                            <label style={{ display: 'block', fontSize: '0.9rem', fontWeight: '600', color: '#6c757d', marginBottom: '0.5rem' }}>
                                Responsable:
                            </label>
                            <span style={{ fontSize: '1rem' }}>{actividad.Responsable || 'Sin asignar'}</span>
                        </div>
                    </div>

                    {/* Fechas (En fila) */}
                    <div style={{ display: 'flex', gap: '1.5rem', marginBottom: '1rem' }}>
                        <div style={{ flex: 1 }}>
                            <label style={{ display: 'block', fontSize: '0.9rem', fontWeight: '600', color: '#6c757d', marginBottom: '0.5rem' }}>
                                Fecha L√≠mite:
                            </label>
                            <span>{formatearFecha(actividad.FechaLimite)}</span>
                        </div>
                        {actividad.FechaRealizacion && (
                            <div style={{ flex: 1 }}>
                                <label style={{ display: 'block', fontSize: '0.9rem', fontWeight: '600', color: '#6c757d', marginBottom: '0.5rem' }}>
                                    Fecha Realizaci√≥n:
                                </label>
                                <span>{formatearFecha(actividad.FechaRealizacion)}</span>
                            </div>
                        )}
                    </div>

                    {/* Descripci√≥n */}
                    <div className="form-group">
                        <label>Descripci√≥n:</label>
                        <div style={{ 
                            background: '#f8f9fa', 
                            padding: '0.8rem', 
                            borderRadius: '8px', 
                            border: '1px solid #dee2e6', 
                            fontSize: '0.95rem',
                            maxHeight: '120px', 
                            overflowY: 'auto' 
                        }}>
                            {actividad.DescripcionActividad || 'Sin descripci√≥n.'}
                        </div>
                    </div>

                    {/* Observaciones */}
                    <div className="form-group">
                        <label>Observaciones:</label>
                        <div style={{ 
                            background: '#f8f9fa', 
                            padding: '0.8rem', 
                            borderRadius: '8px', 
                            border: '1px solid #dee2e6',
                            fontSize: '0.95rem',
                            minHeight: '40px' 
                        }}>
                            {actividad.Observaciones || 'Ninguna observaci√≥n registrada.'}
                        </div>
                    </div>
                </div>

                {/* --- Pie (Botones) --- */}
                <div className="modal-footer">
                    <button type="button" className="btn btn-primary" onClick={alCerrar}>
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalDetalleActividad;


==================================================================
ARCHIVO: frontend\src\components\ModalDiligenciarInspeccion.jsx
==================================================================
// frontend/src/components/ModalDiligenciarInspeccion.jsx

import React, { useState, useEffect } from 'react';
// Importamos el servicio para traer las preguntas de la BD
import { crearInspeccion, getPreguntasFormulario } from '../services/inspectionService'; 
import { getActivosPorTipo } from '../services/assetService'; 
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; 

// √öNICO RENDERIZADOR NECESARIO AHORA
import FormularioGenericoRenderer from './forms/FormularioGenericoRenderer';

const ModalDiligenciarInspeccion = ({ 
    idFormulario, 
    nombreFormulario, 
    tipoActivo, 
    datosFormulario, // Puede venir con preguntas si es desde el gestor, o vac√≠o si es desde biblioteca
    alCerrar, 
    alExito 
}) => {

    const [listaActivos, setListaActivos] = useState([]);
    const [isLoadingActivos, setIsLoadingActivos] = useState(false);
    const [idActivoSeleccionado, setIdActivoSeleccionado] = useState(null); 
    
    const [observacionesGenerales, setObservacionesGenerales] = useState('');
    const [datosDiligenciados, setDatosDiligenciados] = useState({}); 
    const [resultadoGeneral, setResultadoGeneral] = useState('OK');
    const [infoAdicionalActivo, setInfoAdicionalActivo] = useState('');
    const [otroActivoMencionado, setOtroActivoMencionado] = useState('');
    
    // Estado local para almacenar las preguntas que vienen de la BD
    const [preguntasLocales, setPreguntasLocales] = useState([]);
    const [isLoadingPreguntas, setIsLoadingPreguntas] = useState(false);

    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    // --- 1. CARGAR ACTIVOS ---
    useEffect(() => {
        if (tipoActivo) {
            const cargarActivos = async () => {
                setIsLoadingActivos(true);
                try {
                    const data = await getActivosPorTipo(tipoActivo);
                    setListaActivos(data);
                } catch (err) { 
                    console.error("Error cargando activos:", err); 
                } finally { 
                    setIsLoadingActivos(false); 
                }
            };
            cargarActivos();
        }
    }, [tipoActivo]);

    // --- 2. CARGAR PREGUNTAS DEL FORMULARIO (L√ìGICA UNIFICADA) ---
    useEffect(() => {
        // Opci√≥n A: Si ya nos pasaron las preguntas por props (ej: vista previa del gestor)
        if (datosFormulario && datosFormulario.preguntas && datosFormulario.preguntas.length > 0) {
            setPreguntasLocales(datosFormulario.preguntas);
            return;
        }

        // Opci√≥n B: Si no, vamos a la BD a buscarlas por el ID del formulario
        const cargarPreguntasBD = async () => {
            setIsLoadingPreguntas(true);
            try {
                // Esto traer√° las preguntas que ya migraste a la tabla PreguntasInspeccion
                const data = await getPreguntasFormulario(idFormulario);
                setPreguntasLocales(data);
            } catch (err) {
                console.error("Error cargando preguntas:", err);
                setError("No se pudo cargar el checklist del formulario.");
            } finally {
                setIsLoadingPreguntas(false);
            }
        };
        
        if (idFormulario) {
            cargarPreguntasBD();
        }

    }, [idFormulario, datosFormulario]);


    // --- 3. RENDERIZADO DEL CONTENIDO ---
    const renderContent = () => {
        if (isLoadingPreguntas) return <p style={{textAlign:'center', padding:'2rem'}}>Cargando preguntas del formulario...</p>;
        
        if (!preguntasLocales || preguntasLocales.length === 0) {
            return (
                <div style={{padding: '2rem', textAlign: 'center', color: '#666', border: '1px dashed #ccc', borderRadius: '8px'}}>
                    <p><strong>Formulario vac√≠o.</strong></p>
                    <p>No se encontraron preguntas configuradas para este formulario en la base de datos.</p>
                </div>
            );
        }

        // Usamos siempre el gen√©rico, que ahora es capaz de renderizar cualquier lista de preguntas
        return (
            <FormularioGenericoRenderer 
                preguntas={preguntasLocales} 
                onFormChange={setDatosDiligenciados}
                onResultadoChange={setResultadoGeneral}
            />
        );
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        
        // Validaci√≥n b√°sica
        if (!datosDiligenciados.checklist || Object.keys(datosDiligenciados.checklist).length === 0) {
            setError('Por favor, diligencie el checklist (marque opciones).');
            return;
        }

        setIsLoading(true);
        try {
            // Estructura JSON final ("Tabla sobre Tabla")
            const datosJSONCompletos = {
                ...datosDiligenciados, // Aqu√≠ va el 'checklist' con respuestas y textos
                infoAdicionalActivo: infoAdicionalActivo,
                otroActivoMencionado: otroActivoMencionado
            };
            
            const payload = {
                idFormulario,
                idActivoInspeccionado: idActivoSeleccionado ? Number(idActivoSeleccionado) : null,
                datosDiligenciados: datosJSONCompletos, 
                observacionesGenerales,
                resultadoGeneral
            };
            
            await crearInspeccion(payload); 
            
            Swal.fire({ title: '¬°√âxito!', text: 'Inspecci√≥n guardada correctamente.', icon: 'success', timer: 2000, showConfirmButton: false });
            alExito(); 
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Diligenciar: {nombreFormulario}</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                        
                        {/* SELECTOR DE ACTIVO */}
                        <div className="form-group">
                            <label htmlFor="activo-select">
                                Seleccione el Activo / √Årea ({tipoActivo || 'General'})
                            </label>
                            
                            {isLoadingActivos ? (
                                <p>Cargando activos...</p>
                            ) : (
                                <select 
                                    id="activo-select" 
                                    className="form-control"
                                    value={idActivoSeleccionado || ''} 
                                    onChange={(e) => setIdActivoSeleccionado(e.target.value || null)}
                                >
                                    <option value="">-- Selecci√≥n Opcional (Inspecci√≥n General) --</option>
                                    
                                    {listaActivos.length > 0 ? (
                                        listaActivos.map(activo => (
                                            <option key={activo.ID_Activo} value={activo.ID_Activo}>
                                                {activo.NombreDescriptivo} ({activo.CodigoIdentificador})
                                            </option>
                                        ))
                                    ) : (
                                        <option disabled>No hay activos registrados tipo "{tipoActivo}"</option>
                                    )}
                                </select>
                            )}
                        </div>

                        <div className="form-group" style={{display: 'flex', gap: '1rem'}}>
                            <div style={{flex: 1}}>
                                <label>Info Adicional (Serial/Placa/Detalle)</label>
                                <input type="text" className="form-control" value={infoAdicionalActivo} onChange={(e) => setInfoAdicionalActivo(e.target.value)} placeholder="Ej: Serial XT-123..." />
                            </div>
                            <div style={{flex: 1}}>
                                <label>Otra √Årea/Activo (Si no est√° en lista)</label>
                                <input type="text" className="form-control" value={otroActivoMencionado} onChange={(e) => setOtroActivoMencionado(e.target.value)} placeholder="Ej: Pasillo Principal..." />
                            </div>
                        </div>
                        
                        <hr />
                        
                        {/* Aqu√≠ se inyecta el formulario din√°mico */}
                        {renderContent()}

                        <hr style={{ margin: '1.5rem 0' }} />
                        <div className="form-group">
                            <label>Observaciones Generales de la Inspecci√≥n</label>
                            <textarea className="form-control" rows="2" value={observacionesGenerales} onChange={(e) => setObservacionesGenerales(e.target.value)} placeholder="Comentarios generales sobre la inspecci√≥n..." />
                        </div>
                        
                        {error && <p className="modal-error">{error}</p>}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Guardando...' : 'Finalizar y Guardar'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalDiligenciarInspeccion;


==================================================================
ARCHIVO: frontend\src\components\ModalEditarActividad.jsx
==================================================================
// frontend/src/componentes/ModalEditarActividad.jsx

import React, { useState, useEffect } from 'react';
import { editarActividad } from '../services/scheduleService';
import { getTodosUsuarios } from '../services/userService'; 
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; // <-- 1. Importar

const ModalEditarActividad = ({ actividad, alCerrar, alExito }) => {
    const formatInputDate = (fechaISO) => {
        if (!fechaISO) return '';
        return new Date(fechaISO).toISOString().split('T')[0];
    };
    const [formData, setFormData] = useState({
        nombreActividad: '',
        idUsuarioResponsable: '',
        fechaLimite: '',
        descripcionActividad: '' 
    });
    const [listaUsuarios, setListaUsuarios] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    useEffect(() => {
        const cargarUsuarios = async () => {
            try {
                const data = await getTodosUsuarios();
                setListaUsuarios(data);
            } catch (err) {
                console.error("Error cargando usuarios:", err);
                setError("No se pudo cargar la lista de responsables");
            }
        };
        if (actividad) {
            setFormData({
                nombreActividad: actividad.NombreActividad || '',
                idUsuarioResponsable: actividad.ID_UsuarioResponsable || '',
                fechaLimite: formatInputDate(actividad.FechaLimite),
                descripcionActividad: actividad.DescripcionActividad || ''
            });
        }
        cargarUsuarios();
    }, [actividad]); 

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({ ...prevState, [name]: value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setIsLoading(true);
        try {
            const payload = { ...formData, idUsuarioResponsable: parseInt(formData.idUsuarioResponsable) };
            await editarActividad(actividad.ID_Actividad, payload);
            
            // --- 2. REEMPLAZAR 'alert()' ---
            Swal.fire({
                title: '¬°√âxito!',
                text: 'Actividad actualizada exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            alExito(); 
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Editar Actividad</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        {/* (Inputs del formulario sin cambios) */}
                        <div className="form-group"><label htmlFor="nombreActividad">Nombre de la Actividad *</label><input type="text" id="nombreActividad" name="nombreActividad" value={formData.nombreActividad} onChange={handleChange} required /></div>
                        <div className="form-group"><label htmlFor="idUsuarioResponsable">Responsable *</label><select id="idUsuarioResponsable" name="idUsuarioResponsable" value={formData.idUsuarioResponsable} onChange={handleChange} required><option value="">-- Seleccione un responsable --</option>{listaUsuarios.map(user => (<option key={user.ID_Usuario} value={user.ID_Usuario}>{user.NombreCompleto}</option>))}</select></div>
                        <div className="form-group"><label htmlFor="fechaLimite">Fecha L√≠mite *</label><input type="date" id="fechaLimite" name="fechaLimite" value={formData.fechaLimite} onChange={handleChange} min={new Date().toISOString().split('T')[0]} required /></div>
                        <div className="form-group"><label htmlFor="descripcionActividad">Descripci√≥n (Opcional)</label><input type="text" id="descripcionActividad" name="descripcionActividad" value={formData.descripcionActividad} onChange={handleChange} /></div>
                        {error && <p className="modal-error">{error}</p>}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Guardando...' : 'Guardar Cambios'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalEditarActividad;


==================================================================
ARCHIVO: frontend\src\components\ModalEditarActivo.jsx
==================================================================
// frontend/src/components/ModalEditarActivo.jsx

import React, { useState, useEffect } from 'react';
import { actualizarActivo, getTiposActivosDisponibles } from '../services/assetService';
import { getColaboradores } from '../services/userService';
import '../style/Modal.css';
import '../index.css';
import Swal from 'sweetalert2';

const ModalEditarActivo = ({ activo, alCerrar, alExito }) => {
    
    const formatInputDate = (isoString) => {
        if (!isoString) return '';
        return isoString.split('T')[0];
    };

    const [formData, setFormData] = useState({
        tipoActivo: '',
        codigoIdentificador: '',
        nombreDescriptivo: '',
        ubicacion: '',
        marca: '',
        modelo: '',
        idConductor: '',
        soatVencimiento: '',
        tecnoVencimiento: ''
    });

    const [listaTipos, setListaTipos] = useState([]);
    const [listaConductores, setListaConductores] = useState([]);
    const [isLoading, setIsLoading] = useState(false);

    const TIPOS_VEHICULO = ['Vehiculo', 'Moto', 'Montacarga'];

    useEffect(() => {
        const cargarDatos = async () => {
            try {
                const [tipos, users] = await Promise.all([
                    getTiposActivosDisponibles(),
                    getColaboradores()
                ]);
                setListaTipos(tipos);
                setListaConductores(users);

                if (activo) {
                    setFormData({
                        tipoActivo: activo.TipoActivo,
                        codigoIdentificador: activo.CodigoIdentificador,
                        nombreDescriptivo: activo.NombreDescriptivo,
                        ubicacion: activo.Ubicacion || '',
                        marca: activo.Marca || '',
                        modelo: activo.Modelo || '',
                        idConductor: buscarIdConductor(users, activo.NombreConductor),
                        soatVencimiento: formatInputDate(activo.SOAT_Vencimiento),
                        tecnoVencimiento: formatInputDate(activo.Tecno_Vencimiento)
                    });
                }
            } catch (err) {
                console.error(err);
            }
        };
        cargarDatos();
    }, [activo]);

    const buscarIdConductor = (users, nombre) => {
        if (!nombre) return '';
        const user = users.find(u => u.NombreCompleto === nombre);
        return user ? user.ID_Usuario : '';
    };

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({ ...prevState, [name]: value }));
    };

    const esVehiculo = () => TIPOS_VEHICULO.includes(formData.tipoActivo);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        try {
            await actualizarActivo(activo.ID_Activo, formData);
            Swal.fire('Actualizado', 'Activo actualizado correctamente.', 'success');
            alExito(); 
        } catch (err) {
            Swal.fire('Error', err.message, 'error');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Editar Activo</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <form onSubmit={handleSubmit}>
                    <div className="modal-body" style={{maxHeight:'70vh', overflowY:'auto'}}>
                        
                        <div className="form-group">
                            <label>Tipo de Activo</label>
                            <select name="tipoActivo" value={formData.tipoActivo} onChange={handleChange} required>
                                {listaTipos.map((t, i) => (
                                    // Manejo para si viene como objeto o string
                                    <option key={i} value={t.TipoActivoAsociado || t}>{t.TipoActivoAsociado || t}</option>
                                ))}
                            </select>
                        </div>

                        <div className="form-group">
                            <label>{esVehiculo() ? 'Placa *' : 'C√≥digo *'}</label>
                            <input type="text" name="codigoIdentificador" value={formData.codigoIdentificador} onChange={handleChange} required />
                        </div>

                        <div className="form-group">
                            <label>Nombre Descriptivo *</label>
                            <input type="text" name="nombreDescriptivo" value={formData.nombreDescriptivo} onChange={handleChange} required />
                        </div>

                        <div className="form-group">
                            <label>Ubicaci√≥n</label>
                            <input type="text" name="ubicacion" value={formData.ubicacion} onChange={handleChange} />
                        </div>

                        {esVehiculo() && (
                            <div style={{backgroundColor: '#f8f9fa', padding: '1rem', borderRadius: '8px', border: '1px solid #dee2e6', marginTop: '1rem'}}>
                                <h4 style={{marginTop:0, color: 'var(--color-primario)', borderBottom: '1px solid #ddd'}}>Datos del Veh√≠culo</h4>
                                
                                <div style={{display:'flex', gap:'10px'}}>
                                    <div className="form-group" style={{flex:1}}>
                                        <label>Marca</label>
                                        <input type="text" name="marca" value={formData.marca} onChange={handleChange} />
                                    </div>
                                    <div className="form-group" style={{flex:1}}>
                                        <label>Modelo</label>
                                        <input type="text" name="modelo" value={formData.modelo} onChange={handleChange} />
                                    </div>
                                </div>

                                <div className="form-group">
                                    <label>Conductor Asignado</label>
                                    <select name="idConductor" value={formData.idConductor} onChange={handleChange}>
                                        <option value="">-- Sin Asignar --</option>
                                        {listaConductores.map(u => (
                                            <option key={u.ID_Usuario} value={u.ID_Usuario}>{u.NombreCompleto}</option>
                                        ))}
                                    </select>
                                </div>

                                <div style={{display: 'flex', gap: '10px'}}>
                                    <div className="form-group" style={{flex: 1}}>
                                        <label>Vencimiento SOAT</label>
                                        <input type="date" name="soatVencimiento" value={formData.soatVencimiento} onChange={handleChange} />
                                    </div>
                                    <div className="form-group" style={{flex: 1}}>
                                        <label>Venc. Tecnomec√°nica</label>
                                        <input type="date" name="tecnoVencimiento" value={formData.tecnoVencimiento} onChange={handleChange} />
                                    </div>
                                </div>
                            </div>
                        )}

                    </div>

                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Guardando...' : 'Guardar Cambios'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalEditarActivo;


==================================================================
ARCHIVO: frontend\src\components\ModalEditarUsuario.jsx
==================================================================
// frontend/src/componentes/ModalEditarUsuario.jsx

import React, { useState, useEffect } from 'react';
import { editarColaborador } from '../services/userService';
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; // <-- 1. Importar

const ModalEditarUsuario = ({ usuario, alCerrar, alExito }) => {
    
    const [formData, setFormData] = useState({
        nombreCompleto: '',
        area: '',
        cargo: ''
    });
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    useEffect(() => {
        if (usuario) {
            setFormData({
                nombreCompleto: usuario.NombreCompleto || '',
                area: usuario.AreaDepartamento || '',
                cargo: usuario.Cargo || ''
            });
        }
    }, [usuario]);

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({
            ...prevState,
            [name]: value
        }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setIsLoading(true);

        try {
            await editarColaborador(usuario.ID_Usuario, formData);
            
            // --- 2. REEMPLAZAR 'alert()' ---
            Swal.fire({
                title: '¬°√âxito!',
                text: 'Usuario actualizado exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            alExito(); 
            
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Editar Usuario</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        <div className="form-group">
                            <label>C√©dula (Usuario)</label>
                            <input type="text" value={usuario?.CedulaUsuario || ''} disabled />
                        </div>
                        <div className="form-group">
                            <label htmlFor="nombreCompleto">Nombre Completo *</label>
                            <input type="text" id="nombreCompleto" name="nombreCompleto" value={formData.nombreCompleto} onChange={handleChange} required />
                        </div>
                        <div className="form-group">
                            <label htmlFor="area">√Årea / Departamento (Opcional)</label>
                            <input type="text" id="area" name="area" value={formData.area} onChange={handleChange} />
                        </div>
                        <div className="form-group">
                            <label htmlFor="cargo">Cargo (Opcional)</label>
                            <input type="text" id="cargo" name="cargo" value={formData.cargo} onChange={handleChange} />
                        </div>
                        {error && <p className="modal-error">{error}</p>}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Guardando...' : 'Guardar Cambios'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalEditarUsuario;


==================================================================
ARCHIVO: frontend\src\components\ModalFirmarSolicitud.jsx
==================================================================
// frontend/src/components/ModalFirmarSolicitud.jsx

import React, { useState, useRef } from 'react';
import SignatureCanvas from 'react-signature-canvas';
import '../style/Modal.css';
import Swal from 'sweetalert2';

const ModalFirmarSolicitud = ({ solicitud, alCerrar, alExito }) => {
    const [comentario, setComentario] = useState('Aprobado y firmado.');
    const [modoFirma, setModoFirma] = useState('dibujar'); // 'dibujar' o 'subir'
    const [imagenSubida, setImagenSubida] = useState(null);
    const [isProcessing, setIsProcessing] = useState(false);
    
    const sigCanvas = useRef({});

    const limpiarFirma = () => sigCanvas.current.clear();

    const handleFileChange = (e) => {
        if (e.target.files[0]) {
            setImagenSubida(e.target.files[0]);
        }
    };

    const handleAprobar = async () => {
        setIsProcessing(true);
        
        // 1. Preparar la imagen de la firma
        let firmaBlob = null;

        try {
            if (modoFirma === 'dibujar') {
                if (sigCanvas.current.isEmpty()) {
                    Swal.fire('Error', 'Por favor dibuje su firma.', 'warning');
                    setIsProcessing(false);
                    return;
                }
                
                // --- CORRECCI√ìN AQU√ç ---
                // Eliminamos .getTrimmedCanvas() porque causa conflicto con Vite/Webpack
                // Usamos .toDataURL() directo que funciona perfecto.
                const dataURL = sigCanvas.current.toDataURL('image/png');
                
                const res = await fetch(dataURL);
                firmaBlob = await res.blob();

            } else {
                if (!imagenSubida) {
                    Swal.fire('Error', 'Por favor suba una imagen de su firma.', 'warning');
                    setIsProcessing(false);
                    return;
                }
                firmaBlob = imagenSubida;
            }

            // 2. Enviar al Backend
            const formData = new FormData();
            formData.append('idSolicitud', solicitud.ID_Solicitud);
            formData.append('estado', 'Aprobado');
            formData.append('comentario', comentario);
            formData.append('rutaDocumentoOriginal', solicitud.RutaDocumento); 
            formData.append('firma', firmaBlob, 'firma_admin.png'); 

            const token = localStorage.getItem('token');
            const response = await fetch('http://localhost:5000/api/solicitudes/responder', {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            if (response.ok) {
                Swal.fire('¬°√âxito!', 'Documento firmado y solicitud aprobada.', 'success');
                alExito(); 
            } else {
                throw new Error('Error en el servidor al firmar');
            }
        } catch (error) {
            console.error(error);
            Swal.fire('Error', error.message || 'No se pudo procesar la firma', 'error');
        } finally {
            setIsProcessing(false);
        }
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '500px'}}>
                <div className="modal-header">
                    <h3>Firmar Documento</h3>
                    <button className="modal-close-button" onClick={alCerrar}>&times;</button>
                </div>
                <div className="modal-body">
                    <p style={{color:'#666'}}>Est√°s aprobando la solicitud de: <strong>{solicitud.Solicitante}</strong></p>
                    
                    <div className="form-group">
                        <label>Comentario de Aprobaci√≥n</label>
                        <input className="form-control" value={comentario} onChange={e => setComentario(e.target.value)} />
                    </div>

                    <div style={{marginBottom:'10px', display:'flex', gap:'10px'}}>
                        <button className={`btn btn-sm ${modoFirma==='dibujar'?'btn-primary':'btn-secondary'}`} onClick={() => setModoFirma('dibujar')}>Dibujar</button>
                        <button className={`btn btn-sm ${modoFirma==='subir'?'btn-primary':'btn-secondary'}`} onClick={() => setModoFirma('subir')}>Subir Imagen</button>
                    </div>

                    {modoFirma === 'dibujar' ? (
                        <div style={{border: '2px dashed #ccc', borderRadius:'8px', backgroundColor:'#fff'}}>
                            <SignatureCanvas 
                                penColor="black"
                                canvasProps={{width: 460, height: 200, className: 'sigCanvas'}}
                                ref={sigCanvas}
                            />
                            <button onClick={limpiarFirma} style={{fontSize:'0.8rem', margin:'5px', color:'red', background:'none', border:'none', cursor:'pointer'}}>Borrar firma</button>
                        </div>
                    ) : (
                        <div className="form-group">
                            <label>Subir imagen de firma (PNG/JPG)</label>
                            <input type="file" className="form-control" onChange={handleFileChange} accept="image/*" />
                        </div>
                    )}
                </div>
                <div className="modal-footer">
                    <button className="btn btn-secondary" onClick={alCerrar} disabled={isProcessing}>Cancelar</button>
                    <button className="btn btn-primary" onClick={handleAprobar} disabled={isProcessing}>
                        {isProcessing ? 'Firmando...' : 'Estampar Firma y Aprobar'}
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalFirmarSolicitud;


==================================================================
ARCHIVO: frontend\src\components\ModalGenerarDocumento.jsx
==================================================================
// frontend/src/components/ModalGenerarDocumento.jsx

import React, { useState, useEffect } from 'react';
import { apiFetch } from '../services/apiService';
import '../style/Modal.css';
import Swal from 'sweetalert2';
import { BsCheckCircle, BsDownload, BsEye, BsFileText, BsCardHeading } from 'react-icons/bs';

const ModalGenerarDocumento = ({ paso, alCerrar, alExito }) => {
    const [plantilla, setPlantilla] = useState(null); 
    const [respuestas, setRespuestas] = useState({}); 
    
    // --- NUEVO: Estado para datos del encabezado ---
    const [headerData, setHeaderData] = useState({
        codigo: '',
        version: '',
        fechaEmision: '',
        fechaRevision: ''
    });

    const [isLoading, setIsLoading] = useState(true);
    const [isGenerating, setIsGenerating] = useState(false);
    const [pdfGenerado, setPdfGenerado] = useState(null); 

    const API_URL = 'http://localhost:5000'; 

    useEffect(() => {
        const cargarPlantilla = async () => {
            try {
                const data = await apiFetch(`/pesv/plantilla/${paso.ID_Paso}`);
                if (data.existe) {
                    setPlantilla(data);
                    
                    // Pre-llenar con lo que est√° configurado en BD
                    setHeaderData({
                        codigo: data.config.CodigoDocumento || `PESV-FTO-${paso.NumeroPaso}`,
                        version: data.config.Version || '1',
                        fechaEmision: data.config.FechaEmision ? data.config.FechaEmision.split('T')[0] : new Date().toISOString().split('T')[0],
                        fechaRevision: data.config.FechaRevision ? data.config.FechaRevision.split('T')[0] : new Date().toISOString().split('T')[0]
                    });

                } else {
                    setPlantilla(null); 
                }
            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'No se pudo cargar la plantilla', 'error');
            } finally {
                setIsLoading(false);
            }
        };
        cargarPlantilla();
    }, [paso]);

    const handleChange = (label, valor) => {
        setRespuestas({ ...respuestas, [label]: valor });
    };

    // Manejador para los campos del encabezado
    const handleHeaderChange = (e) => {
        setHeaderData({ ...headerData, [e.target.name]: e.target.value });
    };

    const handleGenerar = async (e) => {
        e.preventDefault();
        setIsGenerating(true);
        try {
            const response = await apiFetch('/pesv/pasos/generar', {
                method: 'POST',
                body: JSON.stringify({
                    idPaso: paso.ID_Paso,
                    datosFormulario: respuestas,
                    headerData: headerData // Enviamos los datos editados del encabezado
                })
            });
            
            setPdfGenerado(`${API_URL}/${response.ruta}`);
            
            Swal.fire({
                icon: 'success',
                title: '¬°Generado!',
                text: 'Documento creado y firmado digitalmente.',
                timer: 1500,
                showConfirmButton: false
            });
            
            if (alExito) alExito();
        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        } finally {
            setIsGenerating(false);
        }
    };

    const renderFormulario = () => {
        if (isLoading) return <p>Cargando estructura...</p>;
        
        if (!plantilla) {
            return (
                <div style={{textAlign:'center', padding:'2rem', color:'#666', backgroundColor:'#f8f9fa', borderRadius:'8px'}}>
                    <BsFileText style={{fontSize:'2rem', marginBottom:'10px', opacity:0.5}}/>
                    <p>Este paso a√∫n no tiene una plantilla autom√°tica configurada.</p>
                    <p style={{fontSize:'0.85rem'}}>Por favor, contacte al Administrador para configurar el formato.</p>
                </div>
            );
        }

        return (
            <form onSubmit={handleGenerar}>
                
                {/* --- SECCI√ìN DE ENCABEZADO EDITABLE --- */}
                <div style={{backgroundColor: '#f0f7ff', padding: '15px', borderRadius: '8px', marginBottom: '1.5rem', border: '1px solid #cce5ff'}}>
                    <h4 style={{marginTop: 0, fontSize: '0.9rem', color: '#005A5B', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <BsCardHeading /> Informaci√≥n del Documento
                    </h4>
                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px'}}>
                        <div className="form-group" style={{marginBottom: 0}}>
                            <label style={{fontSize: '0.8rem'}}>C√≥digo:</label>
                            <input className="form-control" name="codigo" value={headerData.codigo} onChange={handleHeaderChange} required />
                        </div>
                        <div className="form-group" style={{marginBottom: 0}}>
                            <label style={{fontSize: '0.8rem'}}>Versi√≥n:</label>
                            <input className="form-control" name="version" value={headerData.version} onChange={handleHeaderChange} required />
                        </div>
                        <div className="form-group" style={{marginBottom: 0}}>
                            <label style={{fontSize: '0.8rem'}}>Fecha Emisi√≥n:</label>
                            <input type="date" className="form-control" name="fechaEmision" value={headerData.fechaEmision} onChange={handleHeaderChange} required />
                        </div>
                        <div className="form-group" style={{marginBottom: 0}}>
                            <label style={{fontSize: '0.8rem'}}>Fecha Revisi√≥n:</label>
                            <input type="date" className="form-control" name="fechaRevision" value={headerData.fechaRevision} onChange={handleHeaderChange} required />
                        </div>
                    </div>
                </div>
                
                {/* --- HEADER VISUAL --- */}
                <div className="form-header-box">
                    <BsFileText />
                    <div>
                        <strong>{plantilla.config.TituloDocumento}</strong>
                        <p style={{margin:0, fontSize:'0.8rem'}}>{plantilla.config.CuerpoInicial.substring(0, 60)}...</p>
                    </div>
                </div>

                {/* --- CAMPOS DIN√ÅMICOS --- */}
                {plantilla.campos.map((campo) => (
                    <div key={campo.ID_Campo} className="form-group">
                        <label>{campo.Etiqueta}</label>
                        {campo.TipoInput === 'parrafo' ? (
                            <textarea 
                                className="form-control" 
                                rows="3" 
                                required 
                                onChange={(e) => handleChange(campo.Etiqueta, e.target.value)}
                            />
                        ) : (
                            <input 
                                type={campo.TipoInput === 'fecha' ? 'date' : 'text'} 
                                className="form-control" 
                                required 
                                onChange={(e) => handleChange(campo.Etiqueta, e.target.value)}
                            />
                        )}
                    </div>
                ))}

                <div className="modal-footer">
                    <button type="button" className="btn btn-secondary" onClick={alCerrar}>Cancelar</button>
                    <button type="submit" className="btn btn-magic" disabled={isGenerating}>
                        {isGenerating ? 'Generando...' : 'Crear Documento'}
                    </button>
                </div>
            </form>
        );
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" style={{maxWidth: '650px'}} onClick={e => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h3>{pdfGenerado ? 'Documento Listo' : `Generar: Paso ${paso.NumeroPaso}`}</h3>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                
                {!pdfGenerado ? (
                    <div className="modal-body" style={{ maxHeight: '75vh', overflowY: 'auto' }}>
                        {renderFormulario()}
                    </div>
                ) : (
                    // VISTA DE √âXITO
                    <div className="modal-body" style={{textAlign:'center', padding:'2rem'}}>
                        <BsCheckCircle style={{fontSize:'4rem', color:'#28a745', marginBottom:'1rem'}} />
                        <h3 style={{color:'#005A5B'}}>¬°Documento Generado!</h3>
                        <p style={{color:'#666', marginBottom:'2rem'}}>Se ha guardado en el historial del paso.</p>
                        
                        <div style={{display:'flex', gap:'15px', justifyContent:'center'}}>
                            <a href={pdfGenerado} target="_blank" rel="noopener noreferrer" className="btn btn-view" style={{textDecoration:'none'}}>
                                <BsEye /> Ver Online
                            </a>
                            <a href={`${API_URL}/api/pesv/download/${pdfGenerado.split('/').pop()}`} className="btn btn-download" style={{textDecoration:'none'}}>
                                <BsDownload /> Descargar
                            </a>
                        </div>
                        
                        <button className="btn btn-link" onClick={alCerrar} style={{marginTop:'2rem'}}>Cerrar</button>
                    </div>
                )}
            </div>
        </div>
    );
};

export default ModalGenerarDocumento;


==================================================================
ARCHIVO: frontend\src\components\ModalGenerarPdfMedico.jsx
==================================================================
// frontend/src/components/ModalGenerarPdfMedico.jsx

import React, { useState } from 'react';
import { generarPdfExamen } from '../services/medicalService';
import '../style/Modal.css';
import { BsFileEarmarkPdfFill, BsCardHeading, BsCalendarEvent, BsHash } from 'react-icons/bs';
import Swal from 'sweetalert2';

const ModalGenerarPdfMedico = ({ examen, alCerrar }) => {
    
    // --- CORRECCI√ìN DE SEGURIDAD ---
    // Si por alguna raz√≥n 'examen' llega vac√≠o, no renderizamos nada para evitar el error.
    if (!examen) return null;

    // Valores por defecto del encabezado
    // eslint-disable-next-line react-hooks/rules-of-hooks
    const [headerData, setHeaderData] = useState({
        codigo: 'SST-FTO-001',
        version: '1',
        fechaEmision: new Date().toISOString().split('T')[0],
        fechaRevision: new Date().toISOString().split('T')[0]
    });

    // eslint-disable-next-line react-hooks/rules-of-hooks
    const [isGenerating, setIsGenerating] = useState(false);

    const handleChange = (e) => {
        setHeaderData({ ...headerData, [e.target.name]: e.target.value });
    };

    const handleGenerar = async (e) => {
        e.preventDefault();
        setIsGenerating(true);
        try {
            await generarPdfExamen(examen.ID_ExamenMedico, examen.CedulaColaborador, headerData);
            
            Swal.fire({
                icon: 'success',
                title: 'PDF Descargado',
                text: 'El documento se ha generado correctamente.',
                timer: 2000,
                showConfirmButton: false
            });
            alCerrar();
        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        } finally {
            setIsGenerating(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" style={{maxWidth:'500px'}} onClick={e => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h3>Generar PDF de Recomendaciones</h3>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <form onSubmit={handleGenerar}>
                    <div className="modal-body">
                        
                        <p style={{fontSize:'0.9rem', color:'#666', marginBottom: '1rem'}}>
                            Vas a generar el documento para: <strong style={{color:'#005A5B'}}>{examen.NombreColaborador}</strong>
                        </p>

                        {/* --- SECCI√ìN DE ENCABEZADO --- */}
                        <div style={{backgroundColor: '#f0f7ff', padding: '15px', borderRadius: '8px', marginBottom: '1.5rem', border: '1px solid #cce5ff'}}>
                            <div style={{fontSize:'0.9rem', marginBottom:'15px', color:'#005A5B', display:'flex', alignItems:'center', gap:'8px', borderBottom:'1px solid #cce5ff', paddingBottom:'5px'}}>
                                <BsCardHeading size={18} />
                                <strong>Configuraci√≥n del Encabezado</strong>
                            </div>
                            
                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px'}}>
                                {/* C√≥digo */}
                                <div className="form-group" style={{marginBottom:0}}>
                                    <label style={{fontSize:'0.8rem', display:'flex', gap:'5px', alignItems:'center'}}><BsHash/> C√≥digo Doc</label>
                                    <input className="form-control" name="codigo" value={headerData.codigo} onChange={handleChange} required />
                                </div>
                                {/* Versi√≥n */}
                                <div className="form-group" style={{marginBottom:0}}>
                                    <label style={{fontSize:'0.8rem', display:'flex', gap:'5px', alignItems:'center'}}><BsHash/> Versi√≥n</label>
                                    <input className="form-control" name="version" value={headerData.version} onChange={handleChange} required />
                                </div>
                                {/* Fecha Emisi√≥n */}
                                <div className="form-group" style={{marginBottom:0}}>
                                    <label style={{fontSize:'0.8rem', display:'flex', gap:'5px', alignItems:'center'}}><BsCalendarEvent/> F. Emisi√≥n</label>
                                    <input type="date" className="form-control" name="fechaEmision" value={headerData.fechaEmision} onChange={handleChange} required />
                                </div>
                                {/* Fecha Revisi√≥n */}
                                <div className="form-group" style={{marginBottom:0}}>
                                    <label style={{fontSize:'0.8rem', display:'flex', gap:'5px', alignItems:'center'}}><BsCalendarEvent/> F. Revisi√≥n</label>
                                    <input type="date" className="form-control" name="fechaRevision" value={headerData.fechaRevision} onChange={handleChange} required />
                                </div>
                            </div>
                        </div>

                    </div>

                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isGenerating}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isGenerating}>
                            <BsFileEarmarkPdfFill /> {isGenerating ? 'Generando...' : 'Descargar PDF'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalGenerarPdfMedico;


==================================================================
ARCHIVO: frontend\src\components\ModalGestionarACPM.jsx
==================================================================
// frontend/src/componentes/ModalGestionarACPM.jsx
import React, { useState } from 'react';
import { gestionarACPM } from '../services/acpmService';
import '../style/Modal.css';
import '../index.css';
import '../style/InspeccionesPage.css'; 
import Swal from 'sweetalert2'; // <-- Importar

const ModalGestionarACPM = ({ acpm, alCerrar, alExito }) => {
    const [estadoACPM, setEstadoACPM] = useState(acpm.EstadoACPM);
    const [comentariosSeguimiento, setComentariosSeguimiento] = useState(''); 
    const [evidenciaCierre, setEvidenciaCierre] = useState(null); 
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');
    const handleFileChange = (e) => { setEvidenciaCierre(e.target.files[0]); };
    const handleSubmit = async (e) => {
        e.preventDefault(); setError('');
        if (estadoACPM === 'Cerrada' && !evidenciaCierre) {
            setError('Se requiere un archivo de evidencia para cerrar la acci√≥n.');
            return;
        }
        setIsLoading(true);
        const formData = new FormData();
        formData.append('estadoACPM', estadoACPM);
        formData.append('comentariosSeguimiento', comentariosSeguimiento);
        if (evidenciaCierre) { formData.append('evidenciaCierre', evidenciaCierre); }
        try {
            await gestionarACPM(acpm.ID_ACPM, formData);
            Swal.fire({ title: '¬°√âxito!', text: 'Acci√≥n ACPM gestionada exitosamente.', icon: 'success', timer: 2000, showConfirmButton: false });
            alExito(); 
        } catch (err) { setError(err.message); } finally { setIsLoading(false); }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}><div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header"><h2>Gestionar Acci√≥n ACPM (ID: {acpm.ID_ACPM})</h2><button onClick={alCerrar} className="modal-close-button">&times;</button></div>
            <form onSubmit={handleSubmit}>
                <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                    <div className="detail-section"><strong>Descripci√≥n del Problema:</strong><p className="detail-box">{acpm.DescripcionProblema}</p></div>
                    {acpm.ComentariosSeguimiento && ( <div className="detail-section"><strong>Historial de Seguimiento:</strong><pre className="detail-box" style={{ fontFamily: 'inherit', fontSize: '0.9rem' }}>{acpm.ComentariosSeguimiento}</pre></div> )}
                    <div className="form-group"><label htmlFor="estadoACPM">Cambiar Estado *</label><select id="estadoACPM" name="estadoACPM" value={estadoACPM} onChange={(e) => setEstadoACPM(e.target.value)} required><option value="Abierta">Abierta</option><option value="En Proceso">En Proceso</option><option value="Cerrada">Cerrada</option></select></div>
                    <div className="form-group"><label htmlFor="comentariosSeguimiento">A√±adir Nuevo Comentario de Seguimiento</label><textarea id="comentariosSeguimiento" name="comentariosSeguimiento" value={comentariosSeguimiento} onChange={(e) => setComentariosSeguimiento(e.target.value)} rows="3" placeholder="A√±ada aqu√≠ el nuevo seguimiento..." /></div>
                    <div className="form-group"><label htmlFor="evidenciaCierre">Adjuntar Evidencia (Cierre o Seguimiento)</label><input type="file" id="evidenciaCierre" name="evidenciaCierre" onChange={handleFileChange} accept=".jpg,.jpeg,.png,.pdf" />{estadoACPM === 'Cerrada' && !evidenciaCierre && (<small style={{ color: '#D32F2F', fontWeight: 'bold' }}>¬°Obligatorio para cerrar!</small>)}</div>
                    {error && <p className="modal-error">{error}</p>}
                </div>
                <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button><button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Guardando...' : 'Guardar Gesti√≥n'}</button></div>
            </form>
        </div></div>
    );
};
export default ModalGestionarACPM;


==================================================================
ARCHIVO: frontend\src\components\ModalGestionarActividad.jsx
==================================================================
// frontend/src/componentes/ModalGestionarActividad.jsx

import React, { useState } from 'react';
import { gestionarActividad } from '../services/scheduleService';
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; // <-- 1. Importar

const ModalGestionarActividad = ({ actividad, alCerrar, alExito }) => {
    const [estado, setEstado] = useState(actividad.EstadoActividad);
    const [observaciones, setObservaciones] = useState(actividad.Observaciones || '');
    const [evidenciaFile, setEvidenciaFile] = useState(null);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleFileChange = (e) => {
        setEvidenciaFile(e.target.files[0]);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');

        if (estado === 'Realizada' && !evidenciaFile) {
            setError('Para marcar como "Realizada", debe adjuntar un nuevo archivo de evidencia.');
            return;
        }

        setIsLoading(true);
        const formData = new FormData();
        formData.append('estado', estado);
        formData.append('observaciones', observaciones);
        if (evidenciaFile) {
            formData.append('evidenciaFile', evidenciaFile); 
        }

        try {
            await gestionarActividad(actividad.ID_Actividad, formData);
            
            // --- 2. REEMPLAZAR 'alert()' ---
            Swal.fire({
                title: '¬°√âxito!',
                text: 'Actividad gestionada exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            alExito(); 
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Gestionar Actividad</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        <h4>{actividad.NombreActividad}</h4>
                        {/* (Inputs del formulario sin cambios) */}
                        <div className="form-group"><label htmlFor="estado">Cambiar Estado *</label><select id="estado" name="estado" value={estado} onChange={(e) => setEstado(e.target.value)} required><option value="Pendiente">Pendiente</option><option value="Realizada">Realizada</option><option value="Cancelada">Cancelada</option></select></div>
                        <div className="form-group"><label htmlFor="observaciones">Observaciones / Motivo</label><textarea id="observaciones" name="observaciones" value={observaciones} onChange={(e) => setObservaciones(e.target.value)} rows="3" placeholder={estado === 'Cancelada' ? 'Especifique el motivo de la cancelaci√≥n' : 'A√±ada observaciones...'} /></div>
                        <div className="form-group"><label htmlFor="evidenciaFile">Adjuntar Evidencia (.jpg, .png, .pdf)</label><input type="file" id="evidenciaFile" name="evidenciaFile" onChange={handleFileChange} accept=".jpg,.jpeg,.png,.pdf" />{estado === 'Realizada' && !evidenciaFile && (<small style={{ color: '#f57f17' }}>Se requiere evidencia para marcar como "Realizada".</small>)}</div>
                        {error && <p className="modal-error">{error}</p>}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Guardando...' : 'Guardar Gesti√≥n'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalGestionarActividad;


==================================================================
ARCHIVO: frontend\src\components\ModalGestionarDocs.jsx
==================================================================
// frontend/src/components/ModalGestionarDocs.jsx

import React, { useState, useEffect } from 'react';
import { apiFetch, apiFetchBlob } from '../services/apiService';
import '../style/Modal.css';
import Swal from 'sweetalert2';
// Iconos
import { BsCloudUpload, BsFileEarmarkPdf, BsTrash, BsDownload, BsEyeFill } from 'react-icons/bs';

const ModalGestionarDocs = ({ colaborador, alCerrar }) => {
    const [docs, setDocs] = useState([]);
    const [tipoDoc, setTipoDoc] = useState('');
    const [archivo, setArchivo] = useState(null);
    const [uploading, setUploading] = useState(false);

    // Estado para saber cu√°l se est√° abriendo (loading visual)
    const [openingId, setOpeningId] = useState(null);

    useEffect(() => {
        cargarDocs();
    }, []);

    const cargarDocs = async () => {
        try {
            const data = await apiFetch(`/colaboradores-docs/${colaborador.Cedula}`);
            setDocs(data);
        } catch (error) { console.error(error); }
    };

    const handleSubir = async (e) => {
        e.preventDefault();
        if (!archivo || !tipoDoc) return Swal.fire('Error', 'Seleccione archivo y tipo', 'warning');

        setUploading(true);
        const formData = new FormData();
        formData.append('cedula', colaborador.Cedula);
        formData.append('nombreColaborador', colaborador.Nombre);
        formData.append('tipoDocumento', tipoDoc);
        formData.append('archivo', archivo);

        try {
            const token = localStorage.getItem('token');
            const res = await fetch('http://localhost:5000/api/colaboradores-docs', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });
            
            if (res.ok) {
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Documento adjuntado', showConfirmButton: false, timer: 1500 });
                setArchivo(null);
                setTipoDoc('');
                document.getElementById('fileInputDocs').value = ""; 
                cargarDocs(); 
            } else { throw new Error('Error subiendo'); }
        // eslint-disable-next-line no-unused-vars
        } catch (err) { Swal.fire('Error', 'No se pudo subir', 'error'); } finally { setUploading(false); }
    };

    // --- VER EN PESTA√ëA NUEVA ---
    const handleVer = async (doc) => {
        setOpeningId(doc.ID_Documento);
        try {
            const blob = await apiFetchBlob(`/colaboradores-docs/view/${doc.ID_Documento}`);
            const fileURL = window.URL.createObjectURL(blob);
            window.open(fileURL, '_blank');
        } catch (e) {
            console.error(e);
            Swal.fire('Error', 'No se puede visualizar este archivo.', 'error');
        } finally {
            setOpeningId(null);
        }
    };

    const handleDescargar = async (doc) => {
        try {
            const blob = await apiFetchBlob(`/colaboradores-docs/download/${doc.ID_Documento}`);
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = doc.NombreArchivo;
            a.click();
        // eslint-disable-next-line no-unused-vars
        } catch (e) { Swal.fire('Error', 'No se pudo descargar', 'error'); }
    };

    const handleEliminar = async (id) => {
        const result = await Swal.fire({ title: '¬øEliminar?', text: 'Se borrar√° permanentemente', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' });
        if (result.isConfirmed) {
            await apiFetch(`/colaboradores-docs/${id}`, { method: 'DELETE' });
            cargarDocs();
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={e => e.stopPropagation()}>
                
                <div className="modal-header">
                    <div>
                        <h2 style={{fontSize:'1.2rem'}}>Documentos del Colaborador</h2>
                        <div style={{color:'#666', fontSize:'0.9rem', marginTop:'5px'}}>
                            <strong>{colaborador.Nombre}</strong> | C.C. {colaborador.Cedula}
                        </div>
                    </div>
                    <button className="modal-close-button" onClick={alCerrar}>&times;</button>
                </div>

                <div className="modal-body">
                    
                    {/* FORMULARIO SUBIDA */}
                    <div style={{backgroundColor:'#f8f9fa', padding:'15px', borderRadius:'8px', marginBottom:'1.5rem', border:'1px solid #eee'}}>
                        <h4 style={{marginTop:0, color:'#005A5B', fontSize:'1rem'}}>Adjuntar Nuevo Documento</h4>
                        <form onSubmit={handleSubir} style={{display:'flex', gap:'10px', alignItems:'flex-end', flexWrap:'wrap'}}>
                            <div style={{flex:1, minWidth:'200px'}}>
                                <label style={{fontSize:'0.85rem'}}>Tipo de Documento</label>
                                <select className="form-control" value={tipoDoc} onChange={e => setTipoDoc(e.target.value)} required>
                                    <option value="">-- Seleccione --</option>
                                    <option>Examen M√©dico</option>
                                    <option>Certificado Laboral</option>
                                    <option>Contrato</option>
                                    <option>Capacitaci√≥n / Diploma</option>
                                    <option>Incapacidad</option>
                                    <option>Otro</option>
                                </select>
                            </div>
                            <div style={{flex:2, minWidth:'250px'}}>
                                <label style={{fontSize:'0.85rem'}}>Archivo</label>
                                <input id="fileInputDocs" type="file" className="form-control" onChange={e => setArchivo(e.target.files[0])} required />
                            </div>
                            <button className="btn btn-primary" disabled={uploading}>
                                <BsCloudUpload /> {uploading ? 'Subiendo...' : 'Adjuntar'}
                            </button>
                        </form>
                    </div>

                    {/* LISTA */}
                    <div style={{maxHeight:'300px', overflowY:'auto'}}>
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Nombre Archivo</th>
                                    <th>Fecha</th>
                                    <th style={{textAlign: 'center'}}>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {docs.length === 0 ? (
                                    <tr><td colSpan="4" style={{textAlign:'center', color:'#999', padding:'2rem'}}>No hay documentos adjuntos.</td></tr>
                                ) : (
                                    docs.map(d => (
                                        <tr key={d.ID_Documento}>
                                            <td><span className="status-pill status-activo" style={{fontSize:'0.75rem'}}>{d.TipoDocumento}</span></td>
                                            <td style={{maxWidth:'200px', overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}} title={d.NombreArchivo}>
                                                <BsFileEarmarkPdf style={{color:'#dc3545', marginRight:'5px'}}/>
                                                {d.NombreArchivo}
                                            </td>
                                            <td>{new Date(d.FechaSubida).toLocaleDateString()}</td>
                                            
                                            <td style={{display:'flex', gap:'5px', justifyContent: 'center'}}>
                                                
                                                {/* BOT√ìN VER (AZUL S√ìLIDO) */}
                                                <button 
                                                    className="btn btn-sm" 
                                                    onClick={() => handleVer(d)} 
                                                    title="Ver documento"
                                                    disabled={openingId === d.ID_Documento}
                                                    style={{
                                                        backgroundColor: '#007BFF', // Azul fuerte
                                                        color: 'white',
                                                        border: 'none',
                                                        display: 'flex', alignItems: 'center', justifyContent: 'center'
                                                    }}
                                                >
                                                    {openingId === d.ID_Documento ? '...' : <BsEyeFill />}
                                                </button>

                                                {/* BOT√ìN DESCARGAR (GRIS) */}
                                                <button 
                                                    className="btn btn-sm btn-secondary" 
                                                    onClick={() => handleDescargar(d)} 
                                                    title="Descargar"
                                                    style={{display: 'flex', alignItems: 'center', justifyContent: 'center'}}
                                                >
                                                    <BsDownload />
                                                </button>

                                                {/* BOT√ìN ELIMINAR (ROJO) */}
                                                <button 
                                                    className="btn btn-sm btn-danger" 
                                                    onClick={() => handleEliminar(d.ID_Documento)} 
                                                    title="Eliminar"
                                                    style={{display: 'flex', alignItems: 'center', justifyContent: 'center'}}
                                                >
                                                    <BsTrash />
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div className="modal-footer">
                    <button type="button" className="btn btn-secondary" onClick={alCerrar}>Cerrar</button>
                </div>
            </div>
        </div>
    );
};

export default ModalGestionarDocs;


==================================================================
ARCHIVO: frontend\src\components\ModalGestionConductor.jsx
==================================================================
// frontend/src/components/ModalGestionConductor.jsx

import React, { useState, useEffect } from 'react';
import '../style/Modal.css';
import Swal from 'sweetalert2';
// Importamos iconos para la interfaz visual
import { BsUpload, BsEyeFill, BsFileEarmarkCheckFill, BsCloudArrowUpFill } from 'react-icons/bs';

const ModalGestionConductor = ({ conductor, alCerrar, alExito }) => {
    
    // URL base de tu backend para construir el link del archivo (Aseg√∫rate que coincida con tu puerto)
    const API_BASE_URL = 'http://localhost:5000';

    const [form, setForm] = useState({
        numeroLicencia: '',
        categoria: '',
        vencimiento: ''
    });
    
    const [archivo, setArchivo] = useState(null);
    const [isLoading, setIsLoading] = useState(false);

    // Cargar datos existentes al abrir el modal
    useEffect(() => {
        if (conductor) {
            setForm({
                numeroLicencia: conductor.NumeroLicencia || '',
                categoria: conductor.Categoria || '',
                // Formato YYYY-MM-DD para que el input type="date" lo lea bien
                vencimiento: conductor.VencimientoLicencia ? conductor.VencimientoLicencia.split('T')[0] : ''
            });
        }
    }, [conductor]);

    const handleFileChange = (e) => {
        setArchivo(e.target.files[0]);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);

        const formData = new FormData();
        formData.append('idUsuario', conductor.ID_Usuario);
        formData.append('numeroLicencia', form.numeroLicencia);
        formData.append('categoria', form.categoria);
        formData.append('vencimiento', form.vencimiento);
        
        // Solo agregamos el archivo si el usuario seleccion√≥ uno nuevo (Renovaci√≥n)
        if (archivo) {
            formData.append('archivoLicencia', archivo);
        }

        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE_URL}/api/pesv/conductores`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            const data = await response.json();

            if (!response.ok) throw new Error(data.msg || 'Error al guardar');

            Swal.fire({
                title: '¬°Actualizado!',
                text: 'La informaci√≥n y la licencia se han guardado correctamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            alExito(); 
        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        } finally {
            setIsLoading(false);
        }
    };

    // Helper para limpiar la ruta del archivo (quitando backslashes de Windows si existen)
    const getUrlArchivo = (ruta) => {
        if (!ruta) return '#';
        // Reemplaza barras invertidas por normales para que la URL sea v√°lida
        const rutaLimpia = ruta.replace(/\\/g, '/'); 
        return `${API_BASE_URL}/${rutaLimpia}`;
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={e => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h3>Gestionar Conductor</h3>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        
                        {/* TARJETA DE RESUMEN DEL USUARIO */}
                        <div style={{marginBottom:'1.5rem', padding:'10px', backgroundColor:'#f0f7ff', borderRadius:'8px', display:'flex', alignItems:'center', gap:'10px', border: '1px solid #cce5ff'}}>
                            <div className="user-avatar" style={{width:'40px', height:'40px', fontSize:'1.2rem', backgroundColor: '#007BFF', color: 'white'}}>
                                {conductor.NombreCompleto.charAt(0)}
                            </div>
                            <div>
                                <div style={{fontWeight: 'bold', color: '#005A5B'}}>{conductor.NombreCompleto}</div>
                                <div style={{fontSize:'0.85rem', color:'#666'}}>C.C. {conductor.CedulaUsuario}</div>
                            </div>
                        </div>

                        {/* CAMPOS DE TEXTO */}
                        <div className="form-group">
                            <label>N¬∞ Licencia de Conducci√≥n *</label>
                            <input type="text" className="form-control" required 
                                value={form.numeroLicencia} onChange={e => setForm({...form, numeroLicencia: e.target.value})} 
                                placeholder="Ej: 1234567890"
                            />
                        </div>
                        
                        <div style={{display: 'flex', gap: '1rem'}}>
                            <div className="form-group" style={{flex: 1}}>
                                <label>Categor√≠a *</label>
                                <input type="text" className="form-control" required 
                                    value={form.categoria} onChange={e => setForm({...form, categoria: e.target.value})} 
                                    placeholder="Ej: C2"
                                />
                            </div>
                            
                            <div className="form-group" style={{flex: 1}}>
                                <label>Vencimiento *</label>
                                <input type="date" className="form-control" required 
                                    value={form.vencimiento} onChange={e => setForm({...form, vencimiento: e.target.value})} 
                                />
                            </div>
                        </div>
                        
                        <hr style={{margin: '1.5rem 0', border: '0', borderTop: '1px solid #eee'}}/>

                        {/* --- SECCI√ìN DE ARCHIVO (VISUALIZACI√ìN Y CARGA) --- */}
                        <div className="form-group">
                            <label style={{fontWeight: 'bold', marginBottom: '10px', display: 'block'}}>Soporte Digital (Licencia)</label>
                            
                            {/* 1. SI YA TIENE LICENCIA CARGADA: MOSTRAR BOT√ìN DE VER */}
                            {conductor.RutaLicencia && (
                                <div style={{
                                    display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                                    backgroundColor: '#d4edda', border: '1px solid #c3e6cb', 
                                    padding: '10px 15px', borderRadius: '8px', marginBottom: '15px'
                                }}>
                                    <div style={{display: 'flex', alignItems: 'center', gap: '8px', color: '#155724'}}>
                                        <BsFileEarmarkCheckFill size={20} />
                                        <span style={{fontSize: '0.9rem', fontWeight: '500'}}>Archivo actual cargado</span>
                                    </div>
                                    
                                    {/* BOT√ìN PARA VER EL DOCUMENTO */}
                                    <a 
                                        href={getUrlArchivo(conductor.RutaLicencia)} 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className="btn btn-sm btn-success"
                                        style={{
                                            backgroundColor: '#155724', color: 'white', textDecoration: 'none', 
                                            display: 'flex', alignItems: 'center', gap: '5px', padding: '5px 10px', borderRadius: '4px'
                                        }}
                                    >
                                        <BsEyeFill /> Ver Licencia
                                    </a>
                                </div>
                            )}

                            {/* 2. INPUT PARA SUBIR O REEMPLAZAR */}
                            <div style={{
                                display:'flex', gap:'10px', alignItems:'center', 
                                border:'2px dashed #007BFF', padding:'1.5rem', borderRadius:'8px', 
                                backgroundColor:'#f8f9fa', flexDirection: 'column', textAlign: 'center'
                            }}>
                                <BsCloudArrowUpFill style={{color:'#007BFF', fontSize:'2rem'}}/>
                                <div style={{width: '100%'}}>
                                    <label htmlFor="file-upload" style={{cursor: 'pointer', color: '#007BFF', fontWeight: 'bold', textDecoration: 'underline'}}>
                                        {conductor.RutaLicencia ? 'Clic aqu√≠ para actualizar archivo' : 'Clic aqu√≠ para subir licencia'}
                                    </label>
                                    <input 
                                        id="file-upload"
                                        type="file" 
                                        onChange={handleFileChange} 
                                        accept=".pdf,.jpg,.jpeg,.png" 
                                        style={{display: 'none'}} 
                                    />
                                    <div style={{fontSize: '0.85rem', color: '#666', marginTop: '5px'}}>
                                        {archivo ? `Seleccionado: ${archivo.name}` : (conductor.RutaLicencia ? 'Opcional: Solo si desea reemplazar el actual' : 'Requerido: PDF o Imagen')}
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>
                            {isLoading ? 'Guardando...' : 'Guardar Informaci√≥n'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalGestionConductor;


==================================================================
ARCHIVO: frontend\src\components\ModalGuardarPaso.jsx
==================================================================
// frontend/src/components/ModalGuardarPaso.jsx

import React, { useState, useEffect } from 'react';
import { apiFetch } from '../services/apiService';
import '../style/Modal.css';
import Swal from 'sweetalert2';

const ModalGuardarPaso = ({ paso, alCerrar, alExito }) => {
    const [form, setForm] = useState({
        numeroPaso: '',
        nombrePaso: '',
        descripcionNorma: ''
    });
    const [isLoading, setIsLoading] = useState(false);

    useEffect(() => {
        if (paso) {
            setForm({
                numeroPaso: paso.NumeroPaso,
                nombrePaso: paso.NombrePaso,
                descripcionNorma: paso.DescripcionNorma
            });
        }
    }, [paso]);

    const handleChange = (e) => setForm({ ...form, [e.target.name]: e.target.value });

    const handleSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        try {
            const url = paso ? '/pesv/pasos/editar' : '/pesv/pasos/crear';
            const method = paso ? 'PUT' : 'POST';
            // Si es edici√≥n enviamos el ID, si es nuevo no
            const body = paso ? { idPaso: paso.ID_Paso, ...form } : form;

            await apiFetch(url, { method, body: JSON.stringify(body) });
            
            Swal.fire('√âxito', `Paso ${paso ? 'actualizado' : 'creado'} correctamente`, 'success');
            alExito();
        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                    <h3>{paso ? 'Editar Paso' : 'Crear Nuevo Paso'}</h3>
                    <button className="modal-close-button" onClick={alCerrar}>&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        <div className="form-group">
                            <label>N√∫mero de Paso (Orden) *</label>
                            <input type="number" name="numeroPaso" className="form-control" required 
                                value={form.numeroPaso} onChange={handleChange} placeholder="Ej: 25" />
                        </div>
                        <div className="form-group">
                            <label>Nombre del Paso / Requisito *</label>
                            <textarea name="nombrePaso" className="form-control" required rows="2" 
                                value={form.nombrePaso} onChange={handleChange} placeholder="Ej: Plan de fatiga" />
                        </div>
                        <div className="form-group">
                            <label>Normativa / Descripci√≥n Legal</label>
                            <input type="text" name="descripcionNorma" className="form-control" 
                                value={form.descripcionNorma} onChange={handleChange} placeholder="Ej: Art 2.2.4.6.X" />
                        </div>
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>
                            {isLoading ? 'Guardando...' : 'Guardar'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalGuardarPaso;


==================================================================
ARCHIVO: frontend\src\components\ModalMiPerfil.jsx
==================================================================
// frontend/src/components/ModalMiPerfil.jsx

import React, { useState, useEffect } from 'react';
import { apiFetch } from '../services/apiService';
import { useAuth } from '../context/AuthContext';
import '../style/Modal.css';
import Swal from 'sweetalert2';
import { BsEnvelopeAt, BsInfoCircle } from 'react-icons/bs';

const ModalMiPerfil = ({ alCerrar }) => {
    const { usuario, logout } = useAuth();
    
    // Estado inicial del correo
    const [email, setEmail] = useState(usuario.email || '');
    const [isLoading, setIsLoading] = useState(false);

    // Verificar Rol
    const esColaborador = usuario?.rol === 'Colaborador';

    useEffect(() => {
        if (usuario && usuario.email) {
            setEmail(usuario.email);
        }
    }, [usuario]);

    const handleGuardar = async (e) => {
        e.preventDefault();
        
        // Doble seguridad: Si es colaborador, no hace nada
        if (esColaborador) return;

        if (!email.includes('@') || !email.includes('.')) {
            Swal.fire('Error', 'Ingrese un correo v√°lido', 'error');
            return;
        }

        setIsLoading(true);
        try {
            await apiFetch('/usuarios/perfil/email', {
                method: 'PATCH',
                body: JSON.stringify({ email })
            });

            Swal.fire({
                title: '¬°Correo Guardado!',
                text: 'Para aplicar los cambios, reinicia tu sesi√≥n.',
                icon: 'success',
                confirmButtonText: 'Cerrar Sesi√≥n Ahora',
                confirmButtonColor: '#005A5B',
                showCancelButton: true,
                cancelButtonText: 'Hacerlo luego'
            }).then((result) => {
                if (result.isConfirmed) {
                    logout(); 
                } else {
                    alCerrar(); 
                }
            });

        } catch (error) {
            console.error(error);
            Swal.fire('Error', error.message || 'No se pudo guardar', 'error');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={e => e.stopPropagation()} style={{maxWidth:'450px'}}>
                <div className="modal-header">
                    <h2>Mi Perfil</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <form onSubmit={handleGuardar}>
                    <div className="modal-body">
                        
                        {/* Tarjeta de Usuario Visual */}
                        <div style={{
                            textAlign:'center', marginBottom:'1.5rem', padding:'1rem', 
                            backgroundColor:'#f8f9fa', borderRadius:'8px', border:'1px solid #eee'
                        }}>
                            <div style={{
                                width:'70px', height:'70px', backgroundColor:'#005A5B', 
                                borderRadius:'50%', margin:'0 auto 10px auto', display:'flex', 
                                alignItems:'center', justifyContent:'center', fontSize:'2rem', color:'white', fontWeight:'bold'
                            }}>
                                {usuario.nombre ? usuario.nombre.charAt(0).toUpperCase() : 'U'}
                            </div>
                            <h3 style={{margin:0, color:'#333', fontSize:'1.1rem'}}>{usuario.nombre}</h3>
                            <div style={{color:'#666', fontSize:'0.9rem'}}>{usuario.rol}</div>
                            <div style={{color:'#888', fontSize:'0.8rem'}}>C.C. {usuario.cedula}</div>
                        </div>

                        {/* Campo Email */}
                        <div className="form-group">
                            <label htmlFor="email" style={{display:'flex', alignItems:'center', gap:'8px', color:'#005A5B'}}>
                                <BsEnvelopeAt /> Correo Electr√≥nico
                            </label>
                            
                            <input 
                                type="email" 
                                id="email" 
                                className="form-control"
                                value={email} 
                                onChange={e => setEmail(e.target.value)} 
                                placeholder={esColaborador ? "No habilitado" : "ejemplo@empresa.com.co"}
                                required={!esColaborador}
                                disabled={esColaborador} // <--- BLOQUEADO PARA COLABORADORES
                                style={{
                                    fontSize:'1rem', 
                                    padding:'10px',
                                    backgroundColor: esColaborador ? '#e9ecef' : 'white',
                                    cursor: esColaborador ? 'not-allowed' : 'text'
                                }}
                            />
                            
                            {/* Mensaje Informativo seg√∫n el rol */}
                            {!esColaborador ? (
                                <small style={{display:'block', marginTop:'8px', color:'#666', fontSize:'0.85rem'}}>
                                    Recibir√°s notificaciones de seguridad a este correo.
                                </small>
                            ) : (
                                <div style={{marginTop:'10px', color:'#856404', backgroundColor:'#fff3cd', padding:'8px', borderRadius:'4px', fontSize:'0.85rem', display:'flex', gap:'5px'}}>
                                    <BsInfoCircle style={{marginTop:'2px'}}/> 
                                    <span>Tu rol no requiere configuraci√≥n de correo electr√≥nico.</span>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar}>
                            {esColaborador ? 'Cerrar' : 'Cancelar'}
                        </button>
                        
                        {/* Bot√≥n Guardar SOLO si NO es colaborador */}
                        {!esColaborador && (
                            <button type="submit" className="btn btn-primary" disabled={isLoading}>
                                {isLoading ? 'Guardando...' : 'Guardar y Actualizar'}
                            </button>
                        )}
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalMiPerfil;


==================================================================
ARCHIVO: frontend\src\components\ModalRegistrarExamen.jsx
==================================================================
// frontend/src/components/ModalRegistrarExamen.jsx

import React, { useState } from 'react';
import { registrarExamen } from '../services/medicalService';
import { getUsuarioByCedula, buscarUsuarioExterno } from '../services/userService'; 
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; 
import { BsSearch, BsCloudDownload, BsCalendarCheck } from 'react-icons/bs';

const LISTA_ENTIDADES = ['Sura', 'Nueva EPS', 'Sanitas', 'Salud Total', 'Coomeva', 'Sura ARL', 'Bol√≠var', 'Positiva', 'Axa Colpatria', 'Otra'];
const LISTA_ESPECIALISTAS = ['M√©dico General', 'M√©dico Laboral', 'Ortopedista', 'Opt√≥metra', 'Psic√≥logo', 'Fisioterapeuta', 'Otro'];

const ModalRegistrarExamen = ({ alCerrar, alExito }) => {
    
    const [formData, setFormData] = useState({
        idUsuarioColaborador: '', 
        nombreColaborador: '',    
        cedulaColaborador: '',    
        tipoExamen: 'Ingreso',
        fechaExamen: new Date().toISOString().split('T')[0],
        conceptoAptitud: 'Apto',
        medicoEspecialista: '',
        entidadEmite: '',
        
        fechaFinRecomendaciones: '', // REEMPLAZA A duracionRecomendaciones
        
        resumenCaso: '',
        recomendacionesGenerales: '', 
        recomendacionesOcupacionales: '',
        compromisos: '',
        observaciones: '' 
    });
    
    // UI
    const [modoBusqueda, setModoBusqueda] = useState('LOCAL'); 
    const [busquedaGosen, setBusquedaGosen] = useState('');
    const [resultadosGosen, setResultadosGosen] = useState([]);
    const [isSearching, setIsSearching] = useState(false);
    const [isLoading, setIsLoading] = useState(false);
    const [esIndefinida, setEsIndefinida] = useState(false); // Checkbox indefinida

    // Selects "Otra"
    const [entidadSelect, setEntidadSelect] = useState('');
    const [medicoSelect, setMedicoSelect] = useState('');

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prevState => ({ ...prevState, [name]: value }));
    };

    const handleSelectChange = (e, campo, setEstadoLocal) => {
        const valor = e.target.value;
        setEstadoLocal(valor);
        if (valor !== 'Otra' && valor !== 'Otro') {
            setFormData(prev => ({ ...prev, [campo]: valor }));
        } else {
            setFormData(prev => ({ ...prev, [campo]: '' }));
        }
    };

    const handleIndefinidaChange = (e) => {
        const checked = e.target.checked;
        setEsIndefinida(checked);
        if (checked) {
            setFormData(prev => ({ ...prev, fechaFinRecomendaciones: '' }));
        }
    };

    // --- B√öSQUEDA LOCAL ---
    const handleBuscarCedulaLocal = async () => {
        if (!formData.cedulaColaborador) return Swal.fire('Atenci√≥n', 'Ingrese c√©dula.', 'warning');
        setIsSearching(true);
        try {
            const usuario = await getUsuarioByCedula(formData.cedulaColaborador);
            setFormData(prev => ({
                ...prev,
                idUsuarioColaborador: usuario.ID_Usuario,
                nombreColaborador: usuario.NombreCompleto
            }));
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Usuario Local Encontrado', timer: 1500, showConfirmButton: false });
        // eslint-disable-next-line no-unused-vars
        } catch (error) {
            setFormData(prev => ({ ...prev, idUsuarioColaborador: '', nombreColaborador: '' }));
            Swal.fire('No encontrado', 'No existe en usuarios locales.', 'error');
        } finally { setIsSearching(false); }
    };

    // --- B√öSQUEDA GOSEN ---
    const handleBuscarGosen = async (e) => {
        e.preventDefault();
        if (!busquedaGosen) return;
        setIsSearching(true);
        setResultadosGosen([]);
        try {
            const data = await buscarUsuarioExterno(busquedaGosen);
            setResultadosGosen(data);
            if(data.length === 0) Swal.fire('Info', 'No encontrado en Base de datos de Gosen', 'info');
        // eslint-disable-next-line no-unused-vars
        } catch (error) {
            Swal.fire('Error', 'Fallo conexi√≥n Gosem', 'error');
        } finally { setIsSearching(false); }
    };

    const seleccionarDeGosen = async (emp) => {
        let idLocal = '';
        try {
            const usuarioLocal = await getUsuarioByCedula(emp.Cedula);
            idLocal = usuarioLocal.ID_Usuario;
        // eslint-disable-next-line no-unused-vars, no-empty
        } catch (e) {}

        setFormData(prev => ({
            ...prev,
            idUsuarioColaborador: idLocal || null,
            nombreColaborador: emp.Nombre,
            cedulaColaborador: emp.Cedula
        }));
        setModoBusqueda('LOCAL');
        setResultadosGosen([]);
        Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Colaborador cargado de Gosen', timer: 1500, showConfirmButton: false });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.nombreColaborador || !formData.cedulaColaborador) {
            Swal.fire('Error', 'Debe identificar al colaborador.', 'error');
            return;
        }
        
        // Validaci√≥n de fecha de fin
        if (!esIndefinida && !formData.fechaFinRecomendaciones) {
             if(formData.recomendacionesGenerales || formData.recomendacionesOcupacionales){
                 Swal.fire('Atenci√≥n', 'Si hay recomendaciones, indique fecha de terminaci√≥n o marque "Indefinidas".', 'warning');
                 return;
             }
        }

        setIsLoading(true);
        try {
            await registrarExamen(formData); 
            Swal.fire({ title: '¬°√âxito!', text: 'Registrado correctamente.', icon: 'success', timer: 2000, showConfirmButton: false });
            alExito(); 
        } catch (err) {
            Swal.fire('Error', err.message, 'error');
        } finally { setIsLoading(false); }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Registrar Examen M√©dico</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                {/* TABS */}
                <div style={{display:'flex', borderBottom:'1px solid #eee', marginBottom:'1rem'}}>
                    <button type="button" onClick={() => setModoBusqueda('LOCAL')} style={{flex:1, padding:'10px', background:'none', borderBottom: modoBusqueda==='LOCAL'?'3px solid #005A5B':'none', fontWeight:'bold', color:modoBusqueda==='LOCAL'?'#005A5B':'#999', cursor:'pointer'}}><BsSearch/> Buscar Local</button>
                    <button type="button" onClick={() => setModoBusqueda('GOSEN')} style={{flex:1, padding:'10px', background:'none', borderBottom: modoBusqueda==='GOSEN'?'3px solid #005A5B':'none', fontWeight:'bold', color:modoBusqueda==='GOSEN'?'#005A5B':'#999', cursor:'pointer'}}><BsCloudDownload/> Buscar en Gosem</button>
                </div>

                {modoBusqueda === 'GOSEN' ? (
                    <div className="modal-body" style={{minHeight:'300px'}}>
                        <form onSubmit={handleBuscarGosen} style={{display:'flex', gap:'10px', marginBottom:'1rem'}}>
                            <input className="form-control" placeholder="Nombre o C√©dula..." value={busquedaGosen} onChange={e=>setBusquedaGosen(e.target.value)} autoFocus/>
                            <button className="btn btn-primary" type="submit" disabled={isSearching}>Buscar</button>
                        </form>
                        <div style={{maxHeight:'250px', overflowY:'auto'}}>
                            {resultadosGosen.map((emp, idx) => (
                                <div key={idx} onClick={() => seleccionarDeGosen(emp)} style={{padding:'10px', borderBottom:'1px solid #eee', cursor:'pointer', display:'flex', justifyContent:'space-between', alignItems:'center'}} onMouseEnter={e=>e.currentTarget.style.backgroundColor='#f9f9f9'} onMouseLeave={e=>e.currentTarget.style.backgroundColor='white'}>
                                    <div><strong>{emp.Nombre}</strong><br/><small>{emp.Cedula} - {emp.Cargo}</small></div>
                                    <span className="btn btn-sm btn-secondary">Seleccionar</span>
                                </div>
                            ))}
                        </div>
                        <div style={{textAlign:'right', marginTop:'1rem'}}><button className="btn btn-link" onClick={() => setModoBusqueda('LOCAL')}>Cancelar</button></div>
                    </div>
                ) : (
                    <form onSubmit={handleSubmit}>
                        <div className="modal-body" style={{ maxHeight: '65vh', overflowY: 'auto' }}>
                            <div className="form-group">
                                <label>C√©dula Colaborador *</label>
                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <input name="cedulaColaborador" value={formData.cedulaColaborador} onChange={handleChange} placeholder="C√©dula..." required style={{ flex: 1 }} />
                                    <button type="button" className="btn btn-secondary" onClick={handleBuscarCedulaLocal} disabled={isSearching}><BsSearch /></button>
                                </div>
                            </div>
                            <div className="form-group"><label>Nombre</label><input value={formData.nombreColaborador} readOnly disabled style={{ backgroundColor: '#f0f0f0' }} /></div>
                            
                            <div style={{ display: 'flex', gap: '1rem' }}>
                                <div className="form-group" style={{ flex: 1 }}>
                                    <label>Tipo Examen *</label>
                                    <select name="tipoExamen" value={formData.tipoExamen} onChange={handleChange}>
                                        <option>Ingreso</option><option>Peri√≥dico</option><option>Egreso</option><option>Post-incapacidad</option><option>Otro</option>
                                    </select>
                                </div>
                                <div className="form-group" style={{ flex: 1 }}>
                                    <label>Fecha *</label>
                                    <input type="date" name="fechaExamen" value={formData.fechaExamen} onChange={handleChange} required />
                                </div>
                            </div>
                            
                            <div className="form-group"><label>Concepto Aptitud *</label>
                                <select name="conceptoAptitud" value={formData.conceptoAptitud} onChange={handleChange}>
                                    <option>Apto</option><option>Apto con restricciones</option><option>No Apto</option>
                                </select>
                            </div>

                            <hr />
                            
                            <div className="form-group">
                                <label>Entidad que emite (ARL/EPS)</label>
                                <select value={entidadSelect} onChange={(e) => handleSelectChange(e, 'entidadEmite', setEntidadSelect)}>
                                    <option value="">-- Seleccione --</option>
                                    {LISTA_ENTIDADES.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                </select>
                                {(entidadSelect === 'Otra') && <input type="text" name="entidadEmite" placeholder="Escriba nombre..." value={formData.entidadEmite} onChange={handleChange} style={{marginTop:'0.5rem'}} />}
                            </div>

                            <div className="form-group">
                                <label>Profesional (M√©dico)</label>
                                <select value={medicoSelect} onChange={(e) => handleSelectChange(e, 'medicoEspecialista', setMedicoSelect)}>
                                    <option value="">-- Seleccione --</option>
                                    {LISTA_ESPECIALISTAS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                </select>
                                {(medicoSelect === 'Otro') && <input type="text" name="medicoEspecialista" placeholder="Escriba tipo..." value={formData.medicoEspecialista} onChange={handleChange} style={{marginTop:'0.5rem'}} />}
                            </div>

                            {/* --- CAMPO VIGENCIA RECOMENDACIONES --- */}
                            <div className="form-group" style={{backgroundColor: '#f8f9fa', padding: '10px', borderRadius: '8px', border: '1px solid #eee'}}>
                                <label style={{fontWeight: 'bold', color: '#005A5B', display:'flex', alignItems:'center', gap:'8px'}}>
                                    <BsCalendarCheck /> Fecha de terminaci√≥n de recomendaciones
                                </label>
                                <div style={{display: 'flex', alignItems: 'center', gap: '15px', marginTop: '10px'}}>
                                    <input 
                                        type="date" 
                                        name="fechaFinRecomendaciones" 
                                        value={formData.fechaFinRecomendaciones} 
                                        onChange={handleChange} 
                                        className="form-control"
                                        style={{flex: 1, opacity: esIndefinida ? 0.5 : 1}}
                                        disabled={esIndefinida}
                                    />
                                    <label style={{display: 'flex', alignItems: 'center', cursor: 'pointer', fontSize: '0.9rem', color: '#555', whiteSpace:'nowrap'}}>
                                        <input 
                                            type="checkbox" 
                                            checked={esIndefinida} 
                                            onChange={handleIndefinidaChange}
                                            style={{marginRight: '8px', width: '16px', height: '16px'}}
                                        />
                                        Indefinidas / No aplica
                                    </label>
                                </div>
                            </div>
                            {/* ------------------------------------------- */}

                            <div className="form-group"><label>Resumen del caso</label><textarea name="resumenCaso" rows="2" value={formData.resumenCaso} onChange={handleChange} /></div>
                            <div className="form-group"><label>Recomendaciones M√©dicas</label><textarea name="recomendacionesGenerales" rows="2" value={formData.recomendacionesGenerales} onChange={handleChange} /></div>
                            <div className="form-group"><label>Restricciones Ocupacionales</label><textarea name="recomendacionesOcupacionales" rows="2" value={formData.recomendacionesOcupacionales} onChange={handleChange} /></div>
                            <div className="form-group"><label>Compromisos</label><textarea name="compromisos" rows="2" value={formData.compromisos} onChange={handleChange} /></div>
                            <div className="form-group"><label>Observaciones Internas</label><textarea name="observaciones" rows="2" value={formData.observaciones} onChange={handleChange} /></div>
                        </div>

                        <div className="modal-footer">
                            <button type="button" className="btn btn-secondary" onClick={alCerrar}>Cancelar</button>
                            <button type="submit" className="btn btn-primary" disabled={isLoading}>Guardar</button>
                        </div>
                    </form>
                )}
            </div>
        </div>
    );
};

export default ModalRegistrarExamen;


==================================================================
ARCHIVO: frontend\src\components\ModalResetPassword.jsx
==================================================================
// frontend/src/componentes/ModalResetPassword.jsx

import React, { useState } from 'react';
import { resetPasswordColaborador } from '../services/userService';
import '../style/Modal.css';
import '../index.css'; 
import Swal from 'sweetalert2'; // <-- Importar

const ModalResetPassword = ({ usuario, alCerrar, alExito }) => {
    const [password, setPassword] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        if (password.length < 6) { 
            setError('La contrase√±a debe tener al menos 6 caracteres');
            return;
        }
        setIsLoading(true);
        try {
            await resetPasswordColaborador(usuario.ID_Usuario, password);
            
            // --- REEMPLAZAR 'alert()' ---
            Swal.fire({
                title: '¬°Contrase√±a Actualizada!',
                text: `Por favor, informa al colaborador su nueva contrase√±a: ${password}`,
                icon: 'success',
                confirmButtonText: 'Entendido'
            });
            alExito(); 
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Resetear Contrase√±a</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        <p>Est√°s asignando una nueva contrase√±a para <strong>{usuario.NombreCompleto}</strong>.</p>
                        <div className="form-group">
                            <label htmlFor="password">Nueva Contrase√±a *</label>
                            <input type="password" id="password" name="password" value={password} onChange={(e) => setPassword(e.target.value)} required />
                        </div>
                        {error && <p className="modal-error">{error}</p>}
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isLoading}>{isLoading ? 'Guardando...' : 'Asignar Contrase√±a'}</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalResetPassword;


==================================================================
ARCHIVO: frontend\src\components\ModalSubirArchivo.jsx
==================================================================
// frontend/src/componentes/ModalSubirArchivo.jsx
import React, { useState } from 'react';
import { subirArchivos } from '../services/documentService';
import '../style/Modal.css';
import '../index.css';
import { BsFileEarmarkArrowUpFill } from 'react-icons/bs';
import Swal from 'sweetalert2'; // <-- Importar

const ModalSubirArchivo = ({ idCarpetaDestino, alCerrar, alExito }) => {
    const [archivos, setArchivos] = useState(null); 
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');
    const handleFileChange = (e) => { setArchivos(e.target.files); };
    const handleSubmit = async (e) => {
        e.preventDefault(); setError('');
        if (!archivos || archivos.length === 0) { setError('Por favor, seleccione al menos un archivo.'); return; }
        setIsLoading(true);
        try {
            const formData = new FormData();
            formData.append('idCarpeta', idCarpetaDestino);
            for (let i = 0; i < archivos.length; i++) { formData.append('archivos', archivos[i]); }
            
            const resultado = await subirArchivos(formData); // Captura el mensaje de √©xito
            
            Swal.fire({ title: '¬°√âxito!', text: resultado.msg || 'Archivos subidos exitosamente.', icon: 'success', timer: 2000, showConfirmButton: false });
            alExito(); 
        } catch (err) { setError(err.message); } finally { setIsLoading(false); }
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}><div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header"><h2>Subir Documentos</h2><button onClick={alCerrar} className="modal-close-button">&times;</button></div>
            <form onSubmit={handleSubmit}>
                <div className="modal-body">
                    <div className="form-group"><label htmlFor="archivos">Seleccione archivos (PDF, Word, Excel, XML)</label><input type="file" id="archivos" name="archivos" onChange={handleFileChange} multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.xml,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/xml,text/xml" /></div>
                    {archivos && archivos.length > 0 && (<div style={{fontSize: '0.9rem'}}><strong>Archivos seleccionados:</strong><ul>{Array.from(archivos).map(file => (<li key={file.name}>{file.name} ({(file.size / 1024).toFixed(1)} KB)</li>))}</ul></div>)}
                    {error && <p className="modal-error">{error}</p>}
                </div>
                <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={alCerrar} disabled={isLoading}>Cancelar</button><button type="submit" className="btn btn-primary" disabled={isLoading}><BsFileEarmarkArrowUpFill /> {isLoading ? 'Subiendo...' : 'Subir Archivos'}</button></div>
            </form>
        </div></div>
    );
};
export default ModalSubirArchivo;


==================================================================
ARCHIVO: frontend\src\components\ModalVerACPM.jsx
==================================================================
// frontend/src/componentes/ModalVerACPM.jsx

import React, { useState, useEffect } from 'react';
// Importamos ambos servicios
import { getACPMDetalle, getEvidenciasPorACPM } from '../services/acpmService';
import '../style/Modal.css';
import '../style/UsuariosPage.css';
import '../style/InspeccionesPage.css'; // Reutiliza estilos de detalle

/**
 * @component ModalVerACPM
 * @desc Modal de "Solo Lectura" para ver el detalle de una ACPM
 */
const ModalVerACPM = ({ acpmId, alCerrar }) => {
    
    // Estados para los datos
    const [acpm, setAcpm] = useState(null);
    const [evidencias, setEvidencias] = useState([]);
    
    // Estados de carga separados
    const [isLoading, setIsLoading] = useState(true);
    const [isLoadingEvidencias, setIsLoadingEvidencias] = useState(true);
    const [error, setError] = useState('');

    // URL base del backend para construir los enlaces
    const API_BASE_URL = 'http://localhost:5000';

    // Carga los detalles y las evidencias al mismo tiempo
    useEffect(() => {
        if (!acpmId) return;

        const cargarDatos = async () => {
            try {
                // Inicia ambas peticiones
                const detallePromise = getACPMDetalle(acpmId);
                const evidenciasPromise = getEvidenciasPorACPM(acpmId);
                
                // Espera a que la de detalle termine
                const dataDetalle = await detallePromise;
                setAcpm(dataDetalle);
                setIsLoading(false); // Detalle cargado

                // Espera a que la de evidencias termine
                const dataEvidencias = await evidenciasPromise;
                setEvidencias(dataEvidencias);
                setIsLoadingEvidencias(false); // Evidencias cargadas

            } catch (err) {
                setError(err.message);
                setIsLoading(false);
                setIsLoadingEvidencias(false);
            }
        };
        cargarDatos();
    }, [acpmId]);

    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        return new Date(fechaISO.split('T')[0] + 'T00:00:00').toLocaleDateString('es-CO');
    };

    // Funci√≥n para √≠conos (reutilizada de ModalVerEvidencias)
    const getIconoTipo = (tipo) => {
        if (tipo.includes('pdf')) return 'üìÑ';
        if (tipo.includes('png') || tipo.includes('jpg') || tipo.includes('jpeg')) return 'üñºÔ∏è';
        return 'üìé';
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Detalle de Acci√≥n ACPM (ID: {acpmId})</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                    {isLoading && <p>Cargando detalle...</p>}
                    {error && <p className="modal-error">{error}</p>}
                    
                    {!isLoading && acpm && (
                        <div className="inspection-details">
                            {/* ... (Toda la secci√≥n de detalles de la ACPM, sin cambios) ... */}
                            <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
                                <div className="detail-section" style={{ flex: 1, minWidth: '200px' }}>
                                    <strong>Tipo de Acci√≥n:</strong> {acpm.TipoAccion}
                                </div>
                                <div className="detail-section" style={{ flex: 1, minWidth: '200px' }}>
                                    <strong>Origen:</strong> {acpm.Origen}
                                </div>
                                <div className="detail-section" style={{ flex: 1, minWidth: '200px' }}>
                                    <strong>Estado:</strong>
                                    <span className={`status-pill ${
                                        acpm.EstadoACPM === 'Abierta' ? 'status-pendiente' :
                                        acpm.EstadoACPM === 'En Proceso' ? 'status-proceso' : 'status-activo'
                                    }`}>
                                        {acpm.EstadoACPM}
                                    </span>
                                </div>
                            </div>
                            <div className="detail-section"><strong>Descripci√≥n del Problema:</strong><p className="detail-box">{acpm.DescripcionProblema}</p></div>
                            <div className="detail-section"><strong>An√°lisis de Causa:</strong><p className="detail-box">{acpm.AnalisisCausa || 'No registrado'}</p></div>
                            <div className="detail-section"><strong>Plan de Acci√≥n:</strong><p className="detail-box">{acpm.PlanAccion}</p></div>
                            <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
                                <div className="detail-section" style={{ flex: 1 }}><strong>Responsable:</strong> {acpm.NombreResponsable || 'No asignado'}</div>
                                <div className="detail-section" style={{ flex: 1 }}><strong>Fecha L√≠mite:</strong> {formatearFecha(acpm.FechaLimite)}</div>
                                <div className="detail-section" style={{ flex: 1 }}><strong>Fecha Cierre:</strong> {formatearFecha(acpm.FechaCierre)}</div>
                            </div>
                            <div className="detail-section">
                                <strong>Historial de Seguimiento:</strong>
                                <pre className="detail-box" style={{ fontFamily: 'inherit', fontSize: '0.9rem' }}>
                                    {acpm.ComentariosSeguimiento || 'Sin comentarios de seguimiento.'}
                                </pre>
                            </div>
                            
                            {/* --- SECCI√ìN DE EVIDENCIAS (NUEVO) --- */}
                            <div className="detail-section">
                                <strong>Archivos de Evidencia:</strong>
                                {isLoadingEvidencias && <p>Cargando evidencias...</p>}
                                {!isLoadingEvidencias && evidencias.length === 0 && (
                                    <p className="detail-box" style={{fontStyle: 'italic'}}>No se han adjuntado evidencias.</p>
                                )}
                                {!isLoadingEvidencias && evidencias.length > 0 && (
                                    <ul className="evidence-list" style={{marginTop: '0.5rem'}}>
                                        {evidencias.map(ev => (
                                            <li key={ev.ID_EvidenciaACPM} className="evidence-item">
                                                <span>{getIconoTipo(ev.TipoArchivo)}</span>
                                                <div className="evidence-info">
                                                    <a href={`${API_BASE_URL}/${ev.RutaArchivo.replace(/\\/g, '/')}`} target="_blank" rel="noopener noreferrer">
                                                        {ev.NombreArchivo}
                                                    </a>
                                                    <small>
                                                        Subido por: {ev.NombreUsuarioSubio} el {new Date(ev.FechaSubida).toLocaleDateString()}
                                                        {ev.EsEvidenciaDeCierre && <strong style={{color: '#005A5B'}}> (Evidencia de Cierre)</strong>}
                                                    </small>
                                                </div>
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                        </div>
                    )}
                </div>

                <div className="modal-footer">
                    <button 
                        type="button" 
                        className="btn btn-secondary" 
                        onClick={alCerrar}
                    >
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerACPM;


==================================================================
ARCHIVO: frontend\src\components\ModalVerDetalleActividad.jsx
==================================================================
// frontend/src/componentes/ModalVerDetalleActividad.jsx

import React, { useState, useEffect } from 'react';
import { getActividadDetalle } from '../services/scheduleService';
import '../style/Modal.css';
import '../style/index.css'; 

const ModalVerDetalleActividad = ({ idActividad, alCerrar }) => {
    
    const [detalle, setDetalle] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');

    useEffect(() => {
        if (!idActividad) return;

        const cargarDetalle = async () => {
            try {
                setIsLoading(true);
                const data = await getActividadDetalle(idActividad);
                setDetalle(data);
            } catch (err) {
                setError(err.message);
            } finally {
                setIsLoading(false);
            }
        };
        cargarDetalle();
    }, [idActividad]);

    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        // Ajustamos la fecha para que no se desplace el d√≠a
        return new Date(fechaISO.split('T')[0] + 'T00:00:00').toLocaleDateString('es-CO');
    };
    
    const getEstadoClass = (estado) => {
        if (estado === 'Realizada') return 'status-activo';
        if (estado === 'Pendiente') return 'status-pendiente';
        return 'status-inactivo';
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Detalle de Actividad #{idActividad}</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                    {isLoading && <p>Cargando detalle...</p>}
                    {error && <p className="modal-error">{error}</p>}
                    
                    {!isLoading && detalle && (
                        <div className="detail-container">
                            <h3 style={{ borderBottom: '1px solid #eee', paddingBottom: '10px' }}>
                                {detalle.NombreActividad}
                            </h3>

                            {/* --- Grid de Informaci√≥n B√°sica --- */}
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '1.5rem', marginBottom: '1.5rem' }}>
                                
                                <div style={{ flex: 1, minWidth: '45%' }}>
                                    <strong>Estado:</strong>
                                    <span className={`status-pill ${getEstadoClass(detalle.EstadoActividad)}`} style={{ marginLeft: '10px' }}>
                                        {detalle.EstadoActividad}
                                    </span>
                                </div>
                                <div style={{ flex: 1, minWidth: '45%' }}>
                                    <strong>Responsable:</strong> {detalle.Responsable} ({detalle.CedulaResponsable})
                                </div>
                                <div style={{ flex: 1, minWidth: '45%' }}>
                                    <strong>Fecha L√≠mite:</strong> {formatearFecha(detalle.FechaLimite)}
                                </div>
                                <div style={{ flex: 1, minWidth: '45%' }}>
                                    <strong>Fecha Realizaci√≥n:</strong> {detalle.FechaRealizacion ? formatearFecha(detalle.FechaRealizacion) : 'Pendiente'}
                                </div>
                            </div>
                            
                            <hr />

                            {/* --- Descripci√≥n --- */}
                            <div style={{ marginTop: '1.5rem' }}>
                                <strong>Descripci√≥n Detallada:</strong>
                                <p className="detail-box">{detalle.DescripcionActividad || 'No aplica'}</p>
                            </div>

                            {/* --- Observaciones --- */}
                            <div style={{ marginTop: '1.5rem' }}>
                                <strong>Observaciones Finales:</strong>
                                <p className="detail-box">{detalle.Observaciones || 'Sin observaciones registradas'}</p>
                            </div>

                        </div>
                    )}
                </div>

                <div className="modal-footer">
                    <button type="button" className="btn btn-secondary" onClick={alCerrar}>Cerrar</button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerDetalleActividad;


==================================================================
ARCHIVO: frontend\src\components\ModalVerDetalleActivo.jsx
==================================================================
// frontend/src/components/ModalVerDetalleActivo.jsx

import React from 'react';
import '../style/Modal.css';
import '../style/InspeccionesPage.css';
import { BsSpeedometer2, BsCalendarEvent, BsPersonBadge, BsGeoAlt } from 'react-icons/bs';

const ModalVerDetalleActivo = ({ activo, alCerrar }) => {
    if (!activo) return null;

    const esVehiculo = ['Vehiculo', 'Moto', 'Montacarga'].includes(activo.TipoActivo);

    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return <span style={{color: '#999'}}>No registrada</span>;
        return new Date(fechaISO.split('T')[0] + 'T00:00:00').toLocaleDateString('es-CO');
    };

    const getEstadoDocumento = (fechaISO) => {
        if (!fechaISO) return null;
        const fechaDoc = new Date(fechaISO);
        const hoy = new Date();
        const esVencido = fechaDoc < hoy;
        return (
            <span className={`status-pill ${esVencido ? 'status-inactivo' : 'status-activo'}`} style={{fontSize: '0.75rem', marginLeft: '5px'}}>
                {esVencido ? 'Vencido' : 'Vigente'}
            </span>
        );
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Ficha T√©cnica del Activo</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                    
                    <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', borderBottom: '1px solid #eee', paddingBottom: '1rem', marginBottom: '1rem' }}>
                        <div style={{ flex: 1 }}>
                            <small style={{color: '#666', textTransform: 'uppercase'}}>{activo.TipoActivo}</small>
                            <h3 style={{ margin: 0, color: '#005A5B' }}>{activo.NombreDescriptivo}</h3>
                        </div>
                        <div style={{ textAlign: 'right' }}>
                            <span className="status-pill status-activo" style={{fontSize: '1rem'}}>
                                {activo.CodigoIdentificador}
                            </span>
                        </div>
                    </div>

                    <div className="inspection-details">
                        <div className="detail-section">
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem'}}>
                                <div>
                                    <strong>Ubicaci√≥n:</strong>
                                    <p className="detail-box"><BsGeoAlt /> {activo.Ubicacion || 'No definida'}</p>
                                </div>
                                <div>
                                    <strong>Marca / Modelo:</strong>
                                    <p className="detail-box">{activo.Marca || '---'} {activo.Modelo || ''}</p>
                                </div>
                            </div>
                        </div>

                        {esVehiculo && (
                            <>
                                <h4 style={{borderBottom: '2px solid #f0f2f5', paddingBottom: '5px', marginTop: '1.5rem', color: '#6c757d'}}>
                                    Informaci√≥n del Veh√≠culo
                                </h4>
                                
                                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem', marginTop: '1rem'}}>
                                    <div>
                                        <strong><BsPersonBadge /> Conductor Asignado:</strong>
                                        <div className="detail-box">
                                            {activo.NombreConductor ? (
                                                <>
                                                    <div style={{fontWeight: 'bold'}}>{activo.NombreConductor}</div>
                                                    <small style={{color: '#666'}}>C.C. {activo.CedulaConductor}</small>
                                                </>
                                            ) : (
                                                <span style={{color: '#999', fontStyle: 'italic'}}>Sin conductor asignado</span>
                                            )}
                                        </div>
                                    </div>

                                    <div>
                                        <strong><BsSpeedometer2 /> Kilometraje Actual:</strong>
                                        <div className="detail-box" style={{fontSize: '1.2rem', fontWeight: 'bold', color: '#007BFF'}}>
                                            {activo.KilometrajeActual ? `${activo.KilometrajeActual.toLocaleString()} km` : '0 km'}
                                        </div>
                                    </div>
                                </div>

                                <div style={{marginTop: '1rem'}}>
                                    <strong>Documentaci√≥n Legal:</strong>
                                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginTop: '0.5rem'}}>
                                        <div style={{background: '#f8f9fa', padding: '0.8rem', borderRadius: '8px', border: '1px solid #e9ecef'}}>
                                            <div style={{fontWeight: '600', color: '#555'}}><BsCalendarEvent /> Vencimiento SOAT</div>
                                            <div style={{marginTop: '5px'}}>
                                                {formatearFecha(activo.SOAT_Vencimiento)}
                                                {getEstadoDocumento(activo.SOAT_Vencimiento)}
                                            </div>
                                        </div>
                                        <div style={{background: '#f8f9fa', padding: '0.8rem', borderRadius: '8px', border: '1px solid #e9ecef'}}>
                                            <div style={{fontWeight: '600', color: '#555'}}><BsCalendarEvent /> Vencimiento Tecnomec√°nica</div>
                                            <div style={{marginTop: '5px'}}>
                                                {formatearFecha(activo.Tecno_Vencimiento)}
                                                {getEstadoDocumento(activo.Tecno_Vencimiento)}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}

                    </div>
                </div>

                <div className="modal-footer">
                    <button type="button" className="btn btn-secondary" onClick={alCerrar}>Cerrar</button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerDetalleActivo;


==================================================================
ARCHIVO: frontend\src\components\ModalVerDocumento.jsx
==================================================================
// frontend/src/components/ModalVerDocumento.jsx

import React, { useState, useEffect } from 'react';
import { getDocumentoBlob } from '../services/documentService';
import '../style/Modal.css';
import '../index.css';
import { BsFileEarmarkWordFill, BsFileEarmarkExcelFill, BsDownload, BsEyeSlash } from 'react-icons/bs';

/**
 * @component ModalVerDocumento
 * @desc Modal inteligente que visualiza PDFs/Im√°genes o muestra opci√≥n de descarga para Office.
 */
const ModalVerDocumento = ({ archivo, alCerrar }) => {
    
    const [documentUrl, setDocumentUrl] = useState(null);
    const [fileType, setFileType] = useState(null); // Para saber qu√© renderizar
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');

    useEffect(() => {
        const cargarDocumento = async () => {
            if (!archivo) return;
            try {
                const blob = await getDocumentoBlob(archivo.ID);
                const url = URL.createObjectURL(blob);
                
                setDocumentUrl(url);
                setFileType(blob.type);

            } catch (err) {
                setError(err.message);
            } finally {
                setIsLoading(false);
            }
        };

        cargarDocumento();

        return () => {
            if (documentUrl) {
                URL.revokeObjectURL(documentUrl);
            }
        };
    }, [archivo]);

    // Funci√≥n para forzar la descarga desde el modal
    const handleDescargaManual = () => {
        const a = document.createElement('a');
        a.href = documentUrl;
        a.download = archivo.Nombre;
        a.click();
    };

    // Helper para saber si se puede mostrar en iframe (PDF, Im√°genes, Texto plano)
    const esVisualizable = (type) => {
        if (!type) return false;
        return type.includes('pdf') || type.includes('image') || type.includes('text/plain');
    };

    // Renderizado condicional del contenido
    const renderContenido = () => {
        if (isLoading) return <div style={{padding: '3rem', textAlign: 'center'}}>Cargando documento...</div>;
        if (error) return <div className="modal-error" style={{padding: '3rem'}}>{error}</div>;

        // CASO 1: Archivo Visualizable (PDF, Imagen)
        if (esVisualizable(fileType)) {
            return (
                <iframe
                    src={documentUrl}
                    title={archivo.Nombre}
                    style={{ width: '100%', height: '100%', border: 'none', backgroundColor: '#f4f4f4' }}
                />
            );
        }

        // CASO 2: Archivo NO Visualizable (Word, Excel, Zip, etc.)
        return (
            <div style={{
                display: 'flex', 
                flexDirection: 'column', 
                alignItems: 'center', 
                justifyContent: 'center', 
                height: '100%', 
                textAlign: 'center',
                padding: '2rem',
                backgroundColor: '#f8f9fa'
            }}>
                {/* Icono Grande seg√∫n tipo */}
                <div style={{fontSize: '5rem', marginBottom: '1rem', opacity: 0.8}}>
                    {fileType.includes('word') || fileType.includes('officedocument.word') ? <BsFileEarmarkWordFill color="#2B579A" /> :
                     fileType.includes('excel') || fileType.includes('spreadsheet') ? <BsFileEarmarkExcelFill color="#1D6F42" /> :
                     <BsEyeSlash color="#6c757d" />}
                </div>

                <h3 style={{color: '#333', marginBottom: '0.5rem'}}>Vista previa no disponible</h3>
                <p style={{color: '#666', maxWidth: '400px', marginBottom: '2rem'}}>
                    El navegador no puede mostrar archivos de tipo <strong>{archivo.TipoArchivo}</strong> directamente.
                    <br/>Por favor, desc√°rgalo para verlo en tu equipo.
                </p>

                <button className="btn btn-primary" onClick={handleDescargaManual} style={{padding: '0.8rem 2rem', fontSize: '1.1rem'}}>
                    <BsDownload /> Descargar Archivo
                </button>
            </div>
        );
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content" 
                 style={{ maxWidth: '90vw', width: '1000px', height: '85vh', display: 'flex', flexDirection: 'column', padding: 0, overflow: 'hidden' }} 
                 onClick={(e) => e.stopPropagation()}
            >
                
                <div className="modal-header" style={{margin: 0, padding: '1rem 1.5rem', backgroundColor: '#fff'}}>
                    <h2 style={{fontSize: '1.2rem', margin: 0}}>Visor: {archivo?.Nombre}</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body" style={{ flex: 1, padding: 0, overflow: 'hidden', display: 'flex', flexDirection: 'column' }}>
                    {renderContenido()}
                </div>

                <div className="modal-footer" style={{margin: 0, padding: '1rem', backgroundColor: '#fff'}}>
                    <button 
                        type="button" 
                        className="btn btn-secondary" 
                        onClick={alCerrar}
                    >
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerDocumento;


==================================================================
ARCHIVO: frontend\src\components\ModalVerEvidencia.jsx
==================================================================
// frontend/src/components/ModalVerEvidencia.jsx

import React, { useState, useRef, useEffect } from 'react';
import '../style/Modal.css';
import Swal from 'sweetalert2';
import { BsDownload, BsFileEarmarkPdf, BsImage, BsEye, BsXCircle, BsArrowRepeat } from 'react-icons/bs';

const ModalVerEvidencia = ({ archivos, pasoNombre, alCerrar }) => {
    
    const API_URL = 'http://localhost:5000'; 
    
    // Estado local
    const [listaArchivos, setListaArchivos] = useState([]);
    // Referencia para el input file
    const fileInputRef = useRef(null);
    const [evidenciaAActualizar, setEvidenciaAActualizar] = useState(null);

    useEffect(() => {
        if (archivos) {
            setListaArchivos(archivos);
        }
    }, [archivos]);

    const esImagen = (ruta) => ruta && ruta.match(/\.(jpeg|jpg|gif|png)$/) != null;

    // --- 1. BOT√ìN ACTUALIZAR ---
    const handleClicActualizar = (e, evidencia) => {
        e.preventDefault(); // Prevenir comportamientos por defecto
        e.stopPropagation(); // EVITAR QUE SE CIERRE EL MODAL
        
        setEvidenciaAActualizar(evidencia);
        
        // Disparar el selector de archivos
        if (fileInputRef.current) {
            fileInputRef.current.click();
        }
    };

    // --- 2. AL SELECCIONAR ARCHIVO ---
    const handleArchivoSeleccionado = async (e) => {
        // Evitar propagaci√≥n aqu√≠ tambi√©n por seguridad
        e.stopPropagation();
        
        const file = e.target.files[0];
        if (!file || !evidenciaAActualizar) return;

        const result = await Swal.fire({
            title: '¬øReemplazar documento?',
            text: `Vas a cambiar "${evidenciaAActualizar.NombreArchivo}" por "${file.name}".`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'S√≠, reemplazar'
        });

        if (result.isConfirmed) {
            const formData = new FormData();
            formData.append('idEvidencia', evidenciaAActualizar.ID_Evidencia);
            formData.append('evidencia', file);

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:5000/api/pesv/evidencias/reemplazar', {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (response.ok) {
                    Swal.fire('¬°√âxito!', 'Documento actualizado.', 'success');
                    
                    // Actualizar la lista visualmente al instante
                    const nuevaLista = listaArchivos.map(item => {
                        if (item.ID_Evidencia === evidenciaAActualizar.ID_Evidencia) {
                            return {
                                ...item,
                                NombreArchivo: file.name,
                                // Ruta visual temporal (el backend ya la guard√≥ bien)
                                RutaArchivo: 'uploads/' + file.name, 
                                FechaSubida: new Date().toISOString()
                            };
                        }
                        return item;
                    });
                    setListaArchivos(nuevaLista);

                } else {
                    throw new Error('Error al actualizar');
                }
            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'No se pudo actualizar el archivo.', 'error');
            }
        }

        // Limpiar input para permitir subir el mismo archivo si se necesita
        e.target.value = null;
        setEvidenciaAActualizar(null);
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            
            {/* CONTENIDO DEL MODAL */}
            <div className="modal-content modal-lg" style={{maxWidth: '900px', maxHeight: '85vh', display: 'flex', flexDirection: 'column'}} onClick={e => e.stopPropagation()}>
                
                {/* --- IMPORTANTE: EL INPUT DEBE ESTAR AQU√ç DENTRO (NO AFUERA) --- */}
                <input 
                    type="file" 
                    ref={fileInputRef} 
                    style={{display:'none'}} 
                    accept=".pdf,.jpg,.jpeg,.png" 
                    onChange={handleArchivoSeleccionado}
                    onClick={(e) => e.stopPropagation()} // Doble seguridad
                />
                {/* ------------------------------------------------------------- */}

                <div className="modal-header">
                    <h3 style={{margin:0, fontSize:'1.2rem'}}>Evidencias: {pasoNombre}</h3>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body" style={{flex: 1, overflowY: 'auto', padding: '1.5rem'}}>
                    
                    {listaArchivos.length === 0 ? (
                        <div style={{textAlign:'center', padding:'2rem', color:'#999', border:'2px dashed #eee', borderRadius:'8px'}}>
                            <BsFileEarmarkPdf style={{fontSize:'3rem', marginBottom:'10px', opacity:0.3}}/>
                            <p>No hay archivos adjuntos en este paso.</p>
                        </div>
                    ) : (
                        <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                            {listaArchivos.map((archivo) => {
                                const rutaLimpia = archivo.RutaArchivo ? archivo.RutaArchivo.replace(/\\/g, '/') : '';
                                const urlVer = `${API_URL}/${rutaLimpia}`;
                                const urlDescarga = `${API_URL}/api/pesv/download/${archivo.NombreArchivo}`;
                                
                                return (
                                    <div key={archivo.ID_Evidencia} style={{
                                        border: '1px solid #e0e0e0', 
                                        borderRadius: '8px', 
                                        padding: '15px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'space-between',
                                        backgroundColor: '#fff',
                                        boxShadow: '0 2px 5px rgba(0,0,0,0.02)'
                                    }}>
                                        <div style={{display:'flex', alignItems:'center', gap:'15px', flex: 1, minWidth: 0}}>
                                            <div style={{
                                                width:'45px', height:'45px', borderRadius:'8px', 
                                                backgroundColor: esImagen(rutaLimpia) ? '#fff8e1' : '#e7f1ff',
                                                color: esImagen(rutaLimpia) ? '#ffc107' : '#007BFF',
                                                display:'flex', alignItems:'center', justifyContent:'center', fontSize:'1.5rem',
                                                flexShrink: 0
                                            }}>
                                                {esImagen(rutaLimpia) ? <BsImage /> : <BsFileEarmarkPdf />}
                                            </div>
                                            <div style={{overflow: 'hidden'}}>
                                                <div style={{fontWeight:'600', color:'#333', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis'}} title={archivo.NombreArchivo}>
                                                    {archivo.NombreArchivo}
                                                </div>
                                                <div style={{fontSize:'0.75rem', color:'#888'}}>
                                                    Fecha: {new Date(archivo.FechaSubida).toLocaleString()}
                                                </div>
                                            </div>
                                        </div>

                                        <div style={{display:'flex', gap:'8px', marginLeft:'15px'}}>
                                            <a href={urlVer} target="_blank" rel="noopener noreferrer" className="btn btn-sm" style={{backgroundColor: '#17a2b8', color: 'white'}}>
                                                <BsEye /> Ver
                                            </a>
                                            <a href={urlDescarga} className="btn btn-sm" style={{backgroundColor: '#6c757d', color: 'white'}}>
                                                <BsDownload /> Bajar
                                            </a>
                                            
                                            {/* BOT√ìN ACTUALIZAR CORREGIDO */}
                                            <button 
                                                onClick={(e) => handleClicActualizar(e, archivo)} // Pasamos el evento 'e'
                                                className="btn btn-sm"
                                                type="button"
                                                style={{backgroundColor: '#fff', color: '#28a745', border: '1px solid #28a745', fontWeight: 'bold'}}
                                            >
                                                <BsArrowRepeat /> Actualizar
                                            </button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
                <div className="modal-footer">
                    <button className="btn btn-secondary" onClick={alCerrar}>
                        <BsXCircle style={{marginRight:'5px'}}/> Cerrar Ventana
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerEvidencia;


==================================================================
ARCHIVO: frontend\src\components\ModalVerEvidencias.jsx
==================================================================
// frontend/src/componentes/ModalVerEvidencias.jsx

import React, { useState, useEffect } from 'react';
// --- CORRECCI√ìN: El nombre correcto es getEvidenciasActividad ---
import { getEvidenciasActividad } from '../services/scheduleService'; 
import '../style/Modal.css';
import '../index.css'; 
import '../style/InspeccionesPage.css'; // Reutiliza estilos de detalle

const ModalVerEvidencias = ({ actividad, alCerrar }) => {
    
    const [evidencias, setEvidencias] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');
    
    // URL base del backend para los enlaces
    const API_BASE_URL = 'http://localhost:5000';

    useEffect(() => {
        if (!actividad) return;

        const cargarEvidencias = async () => {
            try {
                setIsLoading(true);
                // --- Llamada a la funci√≥n con el nombre correcto ---
                const data = await getEvidenciasActividad(actividad.ID_Actividad);
                setEvidencias(data);
            } catch (err) {
                setError(err.message);
            } finally {
                setIsLoading(false);
            }
        };
        
        cargarEvidencias();
    }, [actividad]);

    // Helper para icono seg√∫n tipo
    const getIconoTipo = (tipo) => {
        if (!tipo) return 'üìé';
        if (tipo.includes('pdf')) return 'üìÑ';
        if (tipo.includes('image')) return 'üñºÔ∏è';
        return 'üìé';
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Evidencias de la Actividad</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body">
                    <div className="detail-section">
                        <strong>Actividad:</strong> {actividad?.NombreActividad}
                    </div>

                    {isLoading && <p>Cargando evidencias...</p>}
                    {error && <p className="modal-error">{error}</p>}
                    
                    {!isLoading && !error && evidencias.length === 0 && (
                        <p style={{ fontStyle: 'italic', color: '#666', textAlign: 'center', marginTop: '2rem' }}>
                            No hay evidencias adjuntas para esta actividad.
                        </p>
                    )}

                    {!isLoading && evidencias.length > 0 && (
                        <ul className="evidence-list" style={{ marginTop: '1rem' }}>
                            {evidencias.map((ev) => (
                                <li key={ev.ID_EvidenciaAct} className="evidence-item" style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    padding: '1rem',
                                    borderBottom: '1px solid #eee',
                                    gap: '1rem'
                                }}>
                                    <span style={{ fontSize: '1.5rem' }}>{getIconoTipo(ev.TipoArchivo)}</span>
                                    <div style={{ flex: 1 }}>
                                        <a 
                                            href={`${API_BASE_URL}/${ev.RutaArchivo.replace(/\\/g, '/')}`} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            style={{ fontWeight: '600', color: 'var(--color-acento)', textDecoration: 'none' }}
                                        >
                                            {ev.NombreArchivo}
                                        </a>
                                        <div style={{ fontSize: '0.85rem', color: '#888' }}>
                                            Subido por: {ev.NombreUsuarioSubio} ‚Ä¢ {new Date(ev.FechaSubida).toLocaleDateString()}
                                        </div>
                                    </div>
                                </li>
                            ))}
                        </ul>
                    )}
                </div>

                <div className="modal-footer">
                    <button className="btn btn-secondary" onClick={alCerrar}>Cerrar</button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerEvidencias;


==================================================================
ARCHIVO: frontend\src\components\ModalVerExamen.jsx
==================================================================
// frontend/src/componentes/ModalVerExamen.jsx

import React, { useState, useEffect } from 'react';
// Importamos el servicio para obtener el detalle
import { getExamenMedicoDetalle } from '../services/medicalService'; 
import '../style/Modal.css';
import '../index.css'; 
import '../style/InspeccionesPage.css'; // Reutiliza estilos de detalle

/**
 * @component ModalVerExamen
 * @desc Modal de "Solo Lectura" para ver el detalle de un Examen M√©dico
 * @param {number} examenId - El ID del examen a cargar
 * @param {function} alCerrar - Funci√≥n para cerrar el modal
 */
const ModalVerExamen = ({ examenId, alCerrar }) => {
    
    const [examen, setExamen] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');

    useEffect(() => {
        if (!examenId) return;
        const cargarDetalle = async () => {
            try {
                setIsLoading(true);
                // Llama al servicio para obtener los datos
                const data = await getExamenMedicoDetalle(examenId);
                setExamen(data);
            } catch (err) {
                setError(err.message);
            } finally {
                setIsLoading(false);
            }
        };
        cargarDetalle();
    }, [examenId]); // Se ejecuta cuando el modal se abre

    // Formatear la fecha (corrigiendo zona horaria)
    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        const fecha = new Date(fechaISO.split('T')[0] + 'T00:00:00');
        return fecha.toLocaleDateString('es-CO');
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Detalle de Examen M√©dico</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                    {isLoading && <p>Cargando detalle...</p>}
                    {error && <p className="modal-error">{error}</p>}
                    
                    {!isLoading && examen && (
                        <div className="inspection-details">
                            {/* --- Datos B√°sicos --- */}
                            <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap', borderBottom: '1px solid #eee', paddingBottom: '1rem' }}>
                                <div className="detail-section" style={{ flex: 1, minWidth: '200px' }}>
                                    <strong>Colaborador:</strong> {examen.NombreColaborador}
                                </div>
                                <div className="detail-section" style={{ flex: 1, minWidth: '200px' }}>
                                    <strong>C√©dula:</strong> {examen.CedulaColaborador}
                                </div>
                                <div className="detail-section" style={{ flex: 1, minWidth: '200px' }}>
                                    <strong>Tipo Examen:</strong> {examen.TipoExamen}
                                </div>
                                <div className="detail-section" style={{ flex: 1, minWidth: '200px' }}>
                                    <strong>Fecha Examen:</strong> {formatearFecha(examen.FechaExamen)}
                                </div>
                            </div>

                            {/* --- Concepto --- */}
                            <div className="detail-section" style={{marginTop: '1rem'}}>
                                <strong>Concepto de Aptitud:</strong> 
                                <p style={{margin: 0}}><strong>{examen.ConceptoAptitud}</strong></p>
                            </div>
                            
                            {/* --- Datos del PDF --- */}
                            <div className="detail-section">
                                <strong>M√©dico:</strong> {examen.MedicoEspecialista || 'N/A'}
                            </div>
                            <div className="detail-section">
                                <strong>Entidad:</strong> {examen.EntidadEmite || 'N/A'}
                            </div>
                            <div className="detail-section">
                                <strong>Duraci√≥n:</strong> {examen.DuracionRecomendaciones || 'N/A'}
                            </div>
                            
                            <div className="detail-section">
                                <strong>Resumen del Caso:</strong>
                                <p className="detail-box">{examen.ResumenCaso || 'N/A'}</p>
                            </div>
                            <div className="detail-section">
                                <strong>Recomendaciones M√©dicas:</strong>
                                <p className="detail-box">{examen.RecomendacionesGenerales || 'N/A'}</p>
                            </div>
                            <div className="detail-section">
                                <strong>Recomendaciones Ocupacionales:</strong>
                                <p className="detail-box">{examen.RecomendacionesOcupacionales || 'N/A'}</p>
                            </div>
                            <div className="detail-section">
                                <strong>Compromisos:</strong>
                                <p className="detail-box">{examen.Compromisos || 'N/A'}</p>
                            </div>
                            <div className="detail-section">
                                <strong>Observaciones (Uso Interno):</strong>
                                <p className="detail-box">{examen.Observaciones || 'N/A'}</p>
                            </div>
                        </div>
                    )}
                </div>

                <div className="modal-footer">
                    <button 
                        type="button" 
                        className="btn btn-secondary" 
                        onClick={alCerrar}
                    >
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerExamen;


==================================================================
ARCHIVO: frontend\src\components\ModalVerIndicador.jsx
==================================================================
// frontend/src/components/ModalVerIndicador.jsx

import React from 'react';
import '../style/Modal.css';
import '../index.css'; 
import '../style/InspeccionesPage.css';
import { BsCalendarEvent, BsGraphUp, BsChatLeftText, BsCalculator, BsBraces, BsX, BsCheck2Circle, BsXCircle } from 'react-icons/bs';

const ModalVerIndicador = ({ indicador, alCerrar }) => {
    if (!indicador) return null;

    const meses = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
    
    // --- PARSER INTELIGENTE ---
    // Convierte el string t√©cnico "[F√≥rmula: ... | K: ...] Valores: ..." en objetos usables
    const parsearDatosTecnicos = (textoAnalisis) => {
        const resultado = {
            formula: 'Est√°ndar',
            constante: 100,
            variables: [],
            comentario: ''
        };

        if (!textoAnalisis) return resultado;

        // 1. Separar parte t√©cnica del comentario
        let parteTecnica = "";
        let parteComentario = textoAnalisis;

        if (textoAnalisis.includes('///')) {
            const parts = textoAnalisis.split('///');
            parteTecnica = parts[0];
            parteComentario = parts[1];
        } else if (textoAnalisis.includes(']')) {
            const splitIndex = textoAnalisis.lastIndexOf('}');
            if (splitIndex !== -1) {
                parteTecnica = textoAnalisis.substring(0, splitIndex + 1);
                parteComentario = textoAnalisis.substring(splitIndex + 1);
            }
        }

        // Limpieza del comentario
        if(parteComentario) {
            parteComentario = parteComentario.replace(/^->/, '').trim();
            resultado.comentario = parteComentario;
        }

        // 2. Extraer datos con Regex
        try {
            const matchFormula = parteTecnica.match(/F√≥rmula: (.*?) \|/);
            if (matchFormula) resultado.formula = matchFormula[1];

            const matchK = parteTecnica.match(/K: (\d+)/);
            if (matchK) resultado.constante = matchK[1];

            const matchVars = parteTecnica.match(/Valores: \{(.*?)\}/);
            if (matchVars) {
                const varsString = matchVars[1]; 
                // Separar por comas pero cuidando par√©ntesis
                const varsArray = varsString.split(',');
                
                resultado.variables = varsArray.map(v => {
                    // v viene como: "v1(Total Horas): 150"
                    const parts = v.trim().split(':');
                    if (parts.length === 2) {
                        const izquierda = parts[0].trim(); // "v1(Total Horas)"
                        const valor = parts[1].trim();     // "150"
                        
                        // Separar c√≥digo y etiqueta
                        const matchLabel = izquierda.match(/(v\d+)\((.*?)\)/);
                        if (matchLabel) {
                            return { code: matchLabel[1], label: matchLabel[2], val: valor };
                        }
                        return { code: izquierda, label: izquierda, val: valor };
                    }
                    return null;
                }).filter(Boolean);
            }
        } catch (e) { console.error("Error parseando detalle", e); }

        return resultado;
    };

    const info = parsearDatosTecnicos(indicador.Analisis);

    // Embellecer la f√≥rmula matem√°tica (reemplazar s√≠mbolos de prog por s√≠mbolos mate)
    const formulaBonita = info.formula
        .replace(/\*/g, ' √ó ')
        .replace(/\//g, ' √∑ ')
        .replace(/\+/g, ' + ')
        // eslint-disable-next-line no-useless-escape
        .replace(/\-/g, ' - ');

    // eslint-disable-next-line no-unused-vars
    const cumple = indicador.Resultado >= indicador.Meta; // L√≥gica simple visual (ajustar si usas operador)

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" style={{maxWidth: '850px'}} onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Ficha T√©cnica del Indicador</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body" style={{ maxHeight: '75vh', overflowY: 'auto', padding: '0 1rem' }}>
                    
                    {/* CABECERA: T√çTULO Y FECHA */}
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', borderBottom: '2px solid #f0f0f0', paddingBottom:'1rem' }}>
                        <div>
                            <small style={{color: '#999', textTransform: 'uppercase', letterSpacing: '1px', fontWeight: 'bold'}}>KPI / Indicador</small>
                            <h3 style={{ margin: '5px 0 0 0', color: '#005A5B', fontSize: '1.6rem' }}>{indicador.NombreIndicador}</h3>
                        </div>
                        <div className="status-pill status-proceso" style={{fontSize: '1.1rem', padding: '8px 15px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <BsCalendarEvent /> {meses[indicador.Mes - 1]} {indicador.Anio}
                        </div>
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))', gap: '2rem' }}>
                        
                        {/* COLUMNA IZQUIERDA: MATEM√ÅTICA */}
                        <div>
                            <h4 style={{marginTop:0, color:'#555', display:'flex', alignItems:'center', gap:'8px'}}>
                                <BsCalculator /> Estructura Matem√°tica
                            </h4>
                            
                            {/* CAJA DE F√ìRMULA */}
                            <div style={{backgroundColor:'#f8f9fa', border:'1px solid #e9ecef', borderRadius:'10px', padding:'1.5rem', textAlign:'center', marginBottom:'1.5rem'}}>
                                <div style={{fontFamily:'monospace', fontSize:'1.3rem', color:'#333', marginBottom:'0.5rem'}}>
                                    {formulaBonita} 
                                    {parseInt(info.constante) !== 1 && <span style={{color:'#d63384'}}> √ó {parseInt(info.constante).toLocaleString()}</span>}
                                </div>
                                <small style={{color:'#999'}}>F√≥rmula Base aplicada al c√°lculo</small>
                            </div>

                            {/* LISTA DE VARIABLES */}
                            <h5 style={{marginTop:0, color:'#666', display:'flex', alignItems:'center', gap:'8px', fontSize:'0.95rem'}}>
                                <BsBraces /> Variables Registradas
                            </h5>
                            <ul style={{listStyle:'none', padding:0, margin:0}}>
                                {info.variables.length > 0 ? (
                                    info.variables.map((v, idx) => (
                                        <li key={idx} style={{display:'flex', justifyContent:'space-between', padding:'10px', borderBottom:'1px solid #f0f0f0', alignItems:'center'}}>
                                            <div>
                                                <span style={{fontWeight:'bold', color:'#007BFF', marginRight:'8px'}}>{v.code}</span>
                                                <span style={{color:'#555'}}>{v.label}</span>
                                            </div>
                                            <span style={{fontWeight:'bold', fontSize:'1.1rem', color:'#333'}}>{v.val}</span>
                                        </li>
                                    ))
                                ) : (
                                    // Fallback para datos viejos
                                    <>
                                        <li style={{display:'flex', justifyContent:'space-between', padding:'10px', borderBottom:'1px solid #f0f0f0'}}>
                                            <span>Numerador (Legacy)</span>
                                            <strong>{indicador.Numerador}</strong>
                                        </li>
                                        <li style={{display:'flex', justifyContent:'space-between', padding:'10px', borderBottom:'1px solid #f0f0f0'}}>
                                            <span>Denominador (Legacy)</span>
                                            <strong>{indicador.Denominador}</strong>
                                        </li>
                                    </>
                                )}
                            </ul>
                        </div>

                        {/* COLUMNA DERECHA: RESULTADOS Y AN√ÅLISIS */}
                        <div>
                            <h4 style={{marginTop:0, color:'#555', display:'flex', alignItems:'center', gap:'8px'}}>
                                <BsGraphUp /> Desempe√±o
                            </h4>

                            <div style={{display:'flex', gap:'1rem', marginBottom:'1.5rem'}}>
                                {/* TARJETA RESULTADO */}
                                <div style={{flex:1, backgroundColor:'#e6f7ec', border:'1px solid #c3e6cb', borderRadius:'10px', padding:'1rem', textAlign:'center'}}>
                                    <div style={{color:'#155724', fontSize:'0.85rem', fontWeight:'bold', textTransform:'uppercase'}}>Resultado</div>
                                    <div style={{fontSize:'2.5rem', fontWeight:'800', color:'#155724', lineHeight:'1.2'}}>
                                        {indicador.Resultado?.toFixed(2)}
                                    </div>
                                </div>
                                {/* TARJETA META */}
                                <div style={{flex:1, backgroundColor:'#fff', border:'1px solid #dee2e6', borderRadius:'10px', padding:'1rem', textAlign:'center'}}>
                                    <div style={{color:'#666', fontSize:'0.85rem', fontWeight:'bold', textTransform:'uppercase'}}>Meta</div>
                                    <div style={{fontSize:'2.5rem', fontWeight:'800', color:'#666', lineHeight:'1.2'}}>
                                        {indicador.Meta}
                                    </div>
                                </div>
                            </div>

                            {/* AN√ÅLISIS CUALITATIVO */}
                            <div className="detail-section">
                                <h5 style={{marginTop:0, color:'#666', display:'flex', alignItems:'center', gap:'8px', fontSize:'0.95rem'}}>
                                    <BsChatLeftText /> An√°lisis Cualitativo
                                </h5>
                                <div className="detail-box" style={{backgroundColor:'#fff', border:'1px solid #eee', minHeight:'120px', fontSize:'0.95rem', lineHeight:'1.6', color:'#444'}}>
                                    {info.comentario || <span style={{fontStyle:'italic', color:'#ccc'}}>No se registr√≥ an√°lisis cualitativo para este periodo.</span>}
                                </div>
                            </div>

                        </div>
                    </div>

                </div>

                <div className="modal-footer">
                    <button type="button" className="btn btn-secondary" onClick={alCerrar}>Cerrar</button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerIndicador;


==================================================================
ARCHIVO: frontend\src\components\ModalVerInspeccion.jsx
==================================================================
// frontend/src/componentes/ModalVerInspeccion.jsx

import React, { useState, useEffect } from 'react';
import { getInspeccionDetalle } from '../services/inspectionService';
import InspeccionDetalleRenderer from './InspeccionDetalleRenderer'; 
import '../style/Modal.css';
import '../index.css';
import '../style/InspeccionesPage.css'; 

const ModalVerInspeccion = ({ inspeccionId, alCerrar }) => {
    
    const [inspeccion, setInspeccion] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');

    useEffect(() => {
        // --- VALIDACI√ìN: No hacer nada si no hay ID ---
        if (!inspeccionId) {
            return; 
        }
        // ---------------------------------------------

        const cargarDetalle = async () => {
            try {
                setIsLoading(true);
                const data = await getInspeccionDetalle(inspeccionId);
                setInspeccion(data);
            } catch (err) {
                setError(err.message);
            } finally {
                setIsLoading(false);
            }
        };
        cargarDetalle();
    }, [inspeccionId]);

    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        return new Date(fechaISO.split('T')[0] + 'T00:00:00').toLocaleDateString('es-CO');
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Detalle de Inspecci√≥n #{inspeccionId}</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                    {isLoading && <p>Cargando detalle...</p>}
                    {error && <p className="error-message">{error}</p>}
                    
                    {!isLoading && inspeccion && (
                        <div className="inspection-details">
                            <div className="detail-header-grid" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>
                                <div className="detail-section"><strong>Formulario:</strong> {inspeccion.NombreFormulario}</div>
                                <div className="detail-section"><strong>Fecha:</strong> {formatearFecha(inspeccion.FechaInspeccion)}</div>
                                <div className="detail-section"><strong>Realizado por:</strong> {inspeccion.NombreUsuarioRealizo}</div>
                                <div className="detail-section"><strong>Activo/√Årea:</strong> {inspeccion.NombreActivo || 'N/A'}</div>
                                <div className="detail-section"><strong>Resultado:</strong> <span className={`status-pill ${inspeccion.ResultadoGeneral === 'OK' ? 'status-activo' : 'status-pendiente'}`} style={{marginLeft: '0.5rem'}}>{inspeccion.ResultadoGeneral}</span></div>
                            </div>
                            <hr style={{margin: '1rem 0'}}/>
                            <InspeccionDetalleRenderer formId={inspeccion.ID_Formulario} jsonString={inspeccion.DatosDiligenciados} />
                            {inspeccion.ObservacionesGenerales && (<div className="detail-section" style={{ marginTop: '2rem' }}><strong>Observaciones Generales:</strong><p className="detail-box">{inspeccion.ObservacionesGenerales}</p></div>)}
                        </div>
                    )}
                </div>
                <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={alCerrar}>Cerrar</button></div>
            </div>
        </div>
    );
};

export default ModalVerInspeccion;


==================================================================
ARCHIVO: frontend\src\components\ModalVerMantenimiento.jsx
==================================================================
// frontend/src/components/ModalVerMantenimiento.jsx

import React from 'react';
import '../style/Modal.css';
import '../style/InspeccionesPage.css'; // Reutilizamos estilos
import { BsTools, BsCalendarEvent, BsFileEarmarkPdf, BsCurrencyDollar } from 'react-icons/bs';

const ModalVerMantenimiento = ({ mantenimiento, alCerrar }) => {
    if (!mantenimiento) return null;

    const API_URL = 'http://localhost:5000'; // Ajusta si cambia tu puerto

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={e => e.stopPropagation()}>
                
                <div className="modal-header">
                    <h2>Detalle de Mantenimiento</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>

                <div className="modal-body">
                    
                    <div style={{display:'flex', alignItems:'center', gap:'10px', marginBottom:'1rem', borderBottom:'1px solid #eee', paddingBottom:'1rem'}}>
                        <div style={{fontSize:'2rem', color:'#005A5B'}}>
                            <BsTools />
                        </div>
                        <div>
                            <h3 style={{margin:0}}>{mantenimiento.Vehiculo}</h3>
                            <span className="status-pill status-activo">{mantenimiento.Placa}</span>
                        </div>
                    </div>

                    <div className="inspection-details">
                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'1rem'}}>
                            <div className="detail-section">
                                <strong>Tipo:</strong> {mantenimiento.TipoMantenimiento}
                            </div>
                            <div className="detail-section">
                                <strong>Fecha:</strong> {new Date(mantenimiento.Fecha).toLocaleDateString()}
                            </div>
                            <div className="detail-section">
                                <strong>Kilometraje:</strong> {mantenimiento.Kilometraje} km
                            </div>
                            <div className="detail-section">
                                <strong>Taller:</strong> {mantenimiento.Taller_Realizo}
                            </div>
                        </div>

                        <div className="detail-section" style={{marginTop:'1rem'}}>
                            <strong>Descripci√≥n del Trabajo:</strong>
                            <p className="detail-box">{mantenimiento.Descripcion}</p>
                        </div>

                        <div className="detail-section" style={{display:'flex', justifyContent:'space-between', alignItems:'center', background:'#f8f9fa', padding:'10px', borderRadius:'8px'}}>
                            <div>
                                <strong>Costo Total:</strong>
                            </div>
                            <div style={{fontSize:'1.2rem', color:'#28a745', fontWeight:'bold'}}>
                                <BsCurrencyDollar/> {mantenimiento.Costo.toLocaleString()}
                            </div>
                        </div>

                        {/* --- SECCI√ìN DE EVIDENCIA --- */}
                        <div className="detail-section" style={{marginTop:'1.5rem', borderTop:'1px solid #eee', paddingTop:'1rem'}}>
                            <strong>Evidencia / Soporte Adjunto:</strong>
                            
                            {mantenimiento.RutaEvidencia ? (
                                <div style={{marginTop:'10px'}}>
                                    <a 
                                        href={`${API_URL}/${mantenimiento.RutaEvidencia}`} 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className="btn btn-secondary"
                                        style={{textDecoration:'none', display:'inline-flex', alignItems:'center', gap:'8px'}}
                                    >
                                        <BsFileEarmarkPdf /> Ver Documento Soporte
                                    </a>
                                    <p style={{fontSize:'0.8rem', color:'#666', marginTop:'5px'}}>Se abrir√° en una nueva pesta√±a.</p>
                                </div>
                            ) : (
                                <p style={{color:'#999', fontStyle:'italic'}}>No se adjunt√≥ evidencia para este mantenimiento.</p>
                            )}
                        </div>
                    </div>

                </div>

                <div className="modal-footer">
                    <button className="btn btn-primary" onClick={alCerrar}>Cerrar</button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerMantenimiento;


==================================================================
ARCHIVO: frontend\src\components\ModalVerReporte.jsx
==================================================================
// frontend/src/components/ModalVerReporte.jsx

import React, { useState, useEffect } from 'react';
import { getReporteMaquinaDetalle, getReporteSeguridadDetalle } from '../services/reportService';
import '../style/Modal.css';
import '../index.css'; 
import '../style/InspeccionesPage.css';
import { BsSpeedometer2, BsGeoAlt, BsPersonBadge, BsCalendarCheck } from 'react-icons/bs';

const ModalVerReporte = ({ reporte, tipo, alCerrar }) => {
    const [detalle, setDetalle] = useState(reporte);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');
    const API_BASE_URL = 'http://localhost:5000';

    useEffect(() => {
        const cargarDetalle = async () => {
            try {
                setIsLoading(true);
                
                let data;
                // Soporte para ambos nombres de tipo que llegan del dashboard o tabla
                if (tipo === 'maquina' || tipo === 'M√°quina (Pre-uso)') { 
                    data = await getReporteMaquinaDetalle(reporte.ID_ReporteMaquina || reporte.id?.split('-')[1]);
                } else {
                    data = await getReporteSeguridadDetalle(reporte.ID_ReporteSeguridad || reporte.id?.split('-')[1]);
                }
            
                setDetalle(data); 
                
                // --- CORRECCI√ìN: ELIMINADA LA LLAMADA A alExito() AQU√ç ---
                // Esto evita que la tabla padre se recargue mientras el modal est√° abierto,
                // rompiendo el bucle infinito.

            } catch (err) { 
                setError(err.message); 
            } finally { 
                setIsLoading(false); 
            }
        };
        cargarDetalle();
    }, [reporte, tipo]); // Dependencias limpias

    // Formatear fecha
    const formatearFecha = (fecha) => {
        if (!fecha) return 'N/A';
        return new Date(fecha).toLocaleString('es-CO');
    };

    return (
        <div className="modal-overlay" onClick={alCerrar}>
            <div className="modal-content modal-lg" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                    <h2>Detalle de Reporte</h2>
                    <button onClick={alCerrar} className="modal-close-button">&times;</button>
                </div>
                <div className="modal-body" style={{ maxHeight: '70vh', overflowY: 'auto' }}>
                    {isLoading && <p>Cargando...</p>}
                    {error && <p className="modal-error">{error}</p>}
            
                    {!isLoading && detalle && (
                        <div className="inspection-details">
                            
                            {/* === REPORTE DE M√ÅQUINA === */}
                            {(tipo === 'maquina' || tipo === 'M√°quina (Pre-uso)') ? (
                                <>
                                    <div style={{display:'flex', gap:'1rem', marginBottom:'1rem', backgroundColor:'#f8f9fa', padding:'1rem', borderRadius:'8px', alignItems:'center'}}>
                                        <div style={{flex:1}}>
                                            <strong>Activo:</strong> {detalle.NombreActivo}
                                            <div style={{fontSize:'0.9rem', color:'#666'}}>{detalle.CodigoActivo} {detalle.Marca ? `- ${detalle.Marca}` : ''}</div>
                                        </div>
                                        <div style={{flex:1}}>
                                            <strong>Reportado por:</strong> {detalle.NombreUsuarioReporta}
                                            <div style={{fontSize:'0.9rem', color:'#666'}}>C.C. {detalle.CedulaUsuarioReporta}</div>
                                        </div>
                                        <div style={{textAlign:'right'}}>
                                            <span className={`status-pill ${detalle.EstadoReportado === 'OK' ? 'status-activo' : 'status-pendiente'}`}>
                                                {detalle.EstadoReportado}
                                            </span>
                                        </div>
                                    </div>

                                    {detalle.Kilometraje && (
                                        <div className="detail-section" style={{color: '#007BFF', fontWeight:'bold', display:'flex', alignItems:'center', gap:'5px'}}>
                                            <BsSpeedometer2 /> Kilometraje: {detalle.Kilometraje.toLocaleString()} km
                                        </div>
                                    )}

                                    <div className="detail-section">
                                        <span style={{display:'flex', alignItems:'center', gap:'5px', color:'#666'}}>
                                            <BsCalendarCheck/> {formatearFecha(detalle.FechaHoraReporte)}
                                        </span>
                                    </div>

                                    {/* CHECKLIST */}
                                    {detalle.DatosReporte && (
                                        <div className="detail-section" style={{marginTop: '1rem'}}>
                                            <strong>Checklist de Verificaci√≥n:</strong>
                                            <div style={{ background: '#fff', padding: '0.5rem', border: '1px solid #eee', maxHeight: '250px', overflowY: 'auto', borderRadius:'8px' }}>
                                                <ul style={{ listStyle: 'none', padding: 0, margin: 0 }}>
                                                    {JSON.parse(detalle.DatosReporte).map((item, idx) => (
                                                        <li key={idx} style={{ display: 'flex', justifyContent: 'space-between', padding: '0.5rem', borderBottom: '1px solid #f0f0f0', fontSize: '0.9rem' }}>
                                                            <span>{item.pregunta}</span>
                                                            <span style={{ fontWeight: 'bold', color: item.respuesta === 'No Cumple' ? '#dc3545' : '#28a745' }}>
                                                                {item.respuesta}
                                                            </span>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        </div>
                                    )}

                                    {/* OBSERVACIONES */}
                                    <div className="detail-section" style={{marginTop:'1rem'}}>
                                        <strong>Observaciones / Detalles:</strong>
                                        <p className="detail-box" style={{
                                            color: detalle.EstadoReportado === 'Con Problema' ? '#dc3545' : '#333',
                                            borderColor: detalle.EstadoReportado === 'Con Problema' ? '#dc3545' : '#dee2e6'
                                        }}>
                                            {detalle.DescripcionProblema || 'Sin observaciones registradas.'}
                                        </p>
                                    </div>

                                    {detalle.RutaFotoAdjunta && (
                                        <div className="detail-section">
                                            <strong>Evidencia Fotogr√°fica:</strong><br/>
                                            <img src={`${API_BASE_URL}/${detalle.RutaFotoAdjunta.replace(/\\/g, '/')}`} alt="Evidencia" style={{ maxWidth: '100%', marginTop:'0.5rem', borderRadius:'8px', border:'1px solid #ddd' }} />
                                        </div>
                                    )}
                                </>
                            ) : (
                                /* === REPORTE DE SEGURIDAD === */
                                <>
                                    <div style={{display:'flex', gap:'1rem', marginBottom:'1rem', backgroundColor:'#f8f9fa', padding:'1rem', borderRadius:'8px'}}>
                                        <div style={{flex:1}}>
                                            <strong>Tipo:</strong> <span style={{color:'#005A5B', fontWeight:'bold'}}>{detalle.TipoReporte}</span>
                                        </div>
                                        <div style={{flex:1}}>
                                            <strong>Ubicaci√≥n:</strong> <BsGeoAlt/> {detalle.UbicacionArea}
                                        </div>
                                    </div>
                                    
                                    <div className="detail-section">
                                        <strong>Reportado por:</strong> {detalle.NombreUsuarioReporta}
                                    </div>
                                    <div className="detail-section">
                                        <strong>Fecha:</strong> {formatearFecha(detalle.FechaHoraReporte)}
                                    </div>

                                    <div className="detail-section"><strong>Descripci√≥n:</strong><p className="detail-box">{detalle.Descripcion}</p></div>
                                    
                                    {detalle.RutaFotoAdjunta && (
                                        <div className="detail-section">
                                            <strong>Evidencia:</strong><br/>
                                            <img src={`${API_BASE_URL}/${detalle.RutaFotoAdjunta.replace(/\\/g, '/')}`} alt="Evidencia" style={{ maxWidth: '100%', borderRadius:'8px' }} />
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    )}
                </div>
                <div className="modal-footer">
                    <button type="button" className="btn btn-secondary" onClick={alCerrar}>Cerrar</button>
                </div>
            </div>
        </div>
    );
};
export default ModalVerReporte;


==================================================================
ARCHIVO: frontend\src\components\NotificationBell.jsx
==================================================================
// frontend/src/components/NotificationBell.jsx

import React, { useState, useEffect, useRef } from 'react';
import { BsBellFill, BsTrash, BsXLg } from 'react-icons/bs'; // Importamos BsXLg para la X
import { useNavigate } from 'react-router-dom';
import { apiFetch } from '../services/apiService';
import '../style/Header.css';

const NotificationBell = () => {
    const [notificaciones, setNotificaciones] = useState([]);
    const [showDropdown, setShowDropdown] = useState(false);
    const navigate = useNavigate();
    
    // Referencia para detectar clics fuera del componente
    const dropdownRef = useRef(null);

    const cargarNotificaciones = async () => {
        try {
            const data = await apiFetch('/notificaciones');
            setNotificaciones(data);
        } catch (err) {
            console.error("Error notificaciones:", err);
        }
    };

    // Polling: Busca notificaciones cada 30 segundos
    useEffect(() => {
        cargarNotificaciones();
        const interval = setInterval(cargarNotificaciones, 30000);
        return () => clearInterval(interval);
    }, []);

    // Efecto para cerrar el dropdown si se hace clic fuera de √©l
    useEffect(() => {
        function handleClickOutside(event) {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                setShowDropdown(false);
            }
        }
        // Agregar el listener
        document.addEventListener("mousedown", handleClickOutside);
        // Limpiar el listener
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, [dropdownRef]);

    // Al hacer clic en una notificaci√≥n: marca le√≠da y navega
    const handleClicNotificacion = async (n) => {
        if (!n.Leida) {
            try {
                await apiFetch(`/notificaciones/${n.ID_Notificacion}/leida`, { method: 'PATCH' });
                setNotificaciones(prev => prev.map(item => 
                    item.ID_Notificacion === n.ID_Notificacion ? { ...item, Leida: true } : item
                ));
            } catch (err) { console.error(err); }
        }
        setShowDropdown(false);
        if (n.RutaAccion) navigate(n.RutaAccion);
    };

    // Borrar notificaci√≥n (Ocultar)
    const handleEliminar = async (e, id) => {
        e.stopPropagation(); 
        try {
            await apiFetch(`/notificaciones/${id}/ocultar`, { method: 'PATCH' });
            setNotificaciones(prev => prev.filter(n => n.ID_Notificacion !== id));
        } catch (err) { console.error(err); }
    };

    const conteoNoLeidas = notificaciones.filter(n => !n.Leida).length;

    return (
        <div className="notification-container" style={{position: 'relative', marginRight: '1.5rem'}} ref={dropdownRef}>
            
            {/* --- ICONO DE CAMPANA --- */}
            <div 
                className="bell-icon" 
                onClick={() => setShowDropdown(!showDropdown)}
                style={{cursor: 'pointer', position: 'relative', fontSize: '1.2rem', color: '#6c757d'}}
                title="Notificaciones"
            >
                <BsBellFill />
                {conteoNoLeidas > 0 && (
                    <span className="notification-badge" style={{
                        position: 'absolute', top: '-8px', right: '-8px',
                        backgroundColor: '#dc3545', color: 'white', borderRadius: '50%',
                        padding: '2px 6px', fontSize: '0.7rem', fontWeight: 'bold'
                    }}>
                        {conteoNoLeidas}
                    </span>
                )}
            </div>

            {/* --- VENTANA DESPLEGABLE --- */}
            {showDropdown && (
                <div className="notification-dropdown" style={{
                    position: 'absolute', top: '150%', right: '-10px', width: '350px',
                    backgroundColor: 'white', boxShadow: '0 4px 20px rgba(0,0,0,0.15)',
                    borderRadius: '12px', zIndex: 2000, border: '1px solid #dee2e6',
                    maxHeight: '400px', display: 'flex', flexDirection: 'column'
                }}>
                    {/* HEADER DE LA VENTANA */}
                    <div style={{
                        padding: '12px 15px', borderBottom: '1px solid #eee', 
                        fontWeight: 'bold', fontSize: '1rem', color: '#333',
                        display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                        backgroundColor: '#f8f9fa', borderRadius: '12px 12px 0 0'
                    }}>
                        <span>Notificaciones</span>
                        
                        {/* --- BOT√ìN "X" PARA CERRAR --- */}
                        <button 
                            onClick={() => setShowDropdown(false)}
                            style={{
                                background:'none', border:'none', cursor:'pointer', 
                                color:'#6c757d', display:'flex', alignItems:'center', padding: '4px'
                            }}
                            title="Cerrar ventana"
                        >
                            <BsXLg size={16} />
                        </button>
                    </div>

                    {/* LISTA DE NOTIFICACIONES */}
                    <div style={{overflowY: 'auto', flex: 1}}>
                        {notificaciones.length === 0 ? (
                            <div style={{padding: '2rem', textAlign: 'center', color: '#999', fontSize: '0.9rem'}}>
                                No tienes notificaciones pendientes.
                            </div>
                        ) : (
                            notificaciones.map(n => (
                                <div 
                                    key={n.ID_Notificacion} 
                                    onClick={() => handleClicNotificacion(n)}
                                    style={{
                                        padding: '12px 15px', borderBottom: '1px solid #f0f0f0', 
                                        cursor: 'pointer', transition: 'background 0.2s',
                                        backgroundColor: n.Leida ? '#ffffff' : '#eef7ff', 
                                        display: 'flex', gap: '10px', alignItems: 'flex-start', position: 'relative'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#f1f3f5'}
                                    onMouseLeave={(e) => e.currentTarget.style.backgroundColor = n.Leida ? '#ffffff' : '#eef7ff'}
                                >
                                    {/* Punto azul si no est√° le√≠da */}
                                    {!n.Leida && (
                                        <div style={{
                                            width: '8px', height: '8px', borderRadius: '50%', 
                                            backgroundColor: '#007BFF', marginTop: '6px', flexShrink: 0
                                        }}></div>
                                    )}

                                    <div style={{flex: 1, opacity: n.Leida ? 0.7 : 1}}>
                                        <div style={{fontWeight: n.Leida ? '500' : '700', fontSize: '0.9rem', color: n.Leida ? '#555' : '#005A5B', marginBottom: '2px'}}>
                                            {n.Titulo}
                                        </div>
                                        <div style={{fontSize: '0.85rem', color: '#666', lineHeight: '1.4'}}>
                                            {n.Mensaje}
                                        </div>
                                        <div style={{fontSize: '0.75rem', color: '#aaa', marginTop: '5px'}}>
                                            {new Date(n.FechaCreacion).toLocaleString()}
                                        </div>
                                    </div>

                                    {/* Bot√≥n Papelera para ocultar notificaci√≥n individual */}
                                    <button 
                                        onClick={(e) => handleEliminar(e, n.ID_Notificacion)}
                                        title="Eliminar de la lista"
                                        style={{
                                            background: 'none', border: 'none', color: '#dc3545', cursor: 'pointer', 
                                            padding: '2px', opacity: 0.6, marginTop: '2px'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.opacity = 1}
                                        onMouseLeave={(e) => e.currentTarget.style.opacity = 0.6}
                                    >
                                        <BsTrash size={16} />
                                    </button>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            )}
        </div>
    );
};

export default NotificationBell;


==================================================================
ARCHIVO: frontend\src\components\ProtectedRoutes.jsx
==================================================================
// frontend/src/components/ProtectedRoutes.jsx

import React from 'react';
import { useAuth } from '../context/AuthContext';
import { Navigate, Outlet } from 'react-router-dom';

/**
 * @component ProtectedRoutes
 * @desc Componente para proteger rutas.
 * Si el usuario est√° autenticado, muestra las rutas hijas (Outlet).
 * Si no, lo redirige a la p√°gina de login.
 */
const ProtectedRoutes = () => {
    const { isAuthenticated, isLoading } = useAuth();

    // 1. Mostrar "Cargando..." mientras el AuthContext verifica el token
    if (isLoading) {
        return <div>Cargando sesi√≥n...</div>;
    }

    // 2. Si no est√° autenticado, redirigir a /login
    if (!isAuthenticated) {
        return <Navigate to="/login" replace />;
    }

    // 3. Si est√° autenticado, mostrar el contenido de la ruta (ej. el Dashboard)
    // 'Outlet' es el marcador de posici√≥n de react-router-dom para las rutas anidadas
    return <Outlet />;
};

export default ProtectedRoutes;


==================================================================
ARCHIVO: frontend\src\components\Sidebar.jsx
==================================================================
// frontend/src/components/Sidebar.jsx

import React from 'react';
import { NavLink } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import '../style/Sidebar.css'; 
import logo from "../assets/logo-empaquetados.png";

// Importamos iconos
import { 
    BsGrid1X2Fill, BsPeopleFill, BsCalendarWeek, BsClipboard2CheckFill, 
    BsExclamationTriangleFill, BsGraphUpArrow, BsHouseFill, BsCpuFill, 
    BsShieldFillExclamation, BsFillFolderFill, BsHeartPulseFill, BsArchiveFill, 
    BsFileEarmarkTextFill, BsShieldLockFill, BsListCheck, 
    BsBarChartFill, BsConeStriped, BsEnvelopeExclamation, BsJournalRichtext,
    BsFileText, BsCurrencyDollar, BsClockHistory 
} from 'react-icons/bs';

const Sidebar = ({ isOpen, onClose }) => {
    const { usuario } = useAuth(); 
    const containerClass = `sidebar-container ${isOpen ? 'open' : ''}`;

    // Roles
    const isSuperAdmin = usuario?.rol === 'Super Admin';
    const isAdminSST = usuario?.rol === 'Administrador SST';
    const isColaborador = usuario?.rol === 'Colaborador';

    return (
        <aside className={containerClass}>
            <div className="sidebar-logo">
                <img src={logo} alt="Logo" className="sidebar-logo-img"/>
                <h3>SG-SST</h3>
                <button className="sidebar-close-btn" onClick={onClose}>&times;</button>
            </div>

            <nav className="sidebar-nav">
                
                {/* =================================================
                   MEN√ö EXCLUSIVO SUPER ADMIN
                   ================================================= */}
                {isSuperAdmin && (
                    <>
                        <div className="sidebar-section-label">CENTRO DE COMANDO</div>
                        
                        <NavLink to="/super-admin/dashboard" className="sidebar-link" onClick={onClose}>
                            <BsShieldLockFill /> Dashboard Global
                        </NavLink>

                        <div className="sidebar-section-label">ADMINISTRACI√ìN</div>

                        <NavLink to="/usuarios" className="sidebar-link" onClick={onClose}>
                            <BsPeopleFill /> Gesti√≥n de Usuarios
                        </NavLink>

                        <NavLink to="/pesv" className="sidebar-link" onClick={onClose}>
                            <BsConeStriped /> Gesti√≥n PESV (Estrat√©gico)
                        </NavLink>

                        <NavLink to="/super-admin/formularios" className="sidebar-link" onClick={onClose}>
                            <BsListCheck /> Gestor de Formularios
                        </NavLink>
                        
                        <NavLink to="/presupuesto" className="sidebar-link" onClick={onClose}>
                            <BsCurrencyDollar /> Gesti√≥n Presupuesto
                        </NavLink>

                        <NavLink to="/historial" className="sidebar-link" onClick={onClose}>
                            <BsClockHistory /> Historial y Trazabilidad
                        </NavLink>

                        {/* --- NUEVA SECCI√ìN PARA SUPER ADMIN --- */}
                        <div className="sidebar-section-label">OPERACI√ìN SST</div>

                        <NavLink to="/planificacion" className="sidebar-link" onClick={onClose}>
                            <BsCalendarWeek /> Planificaci√≥n
                        </NavLink>

                        <NavLink to="/reportes" className="sidebar-link" onClick={onClose}>
                            <BsExclamationTriangleFill /> Reportes Colaboradores
                        </NavLink>

                        <NavLink to="/acpm" className="sidebar-link" onClick={onClose}>
                            <BsGraphUpArrow /> Acciones (ACPM)
                        </NavLink>
                        {/* -------------------------------------- */}

                        <div className="sidebar-section-label">APROBACIONES</div>

                        <NavLink to="/solicitudes" className="sidebar-link" onClick={onClose}>
                            <BsEnvelopeExclamation /> Solicitudes y Firmas
                        </NavLink>

                        <div className="sidebar-section-label">SEGURIDAD</div>

                        <NavLink to="/logs" className="sidebar-link" onClick={onClose}>
                            <BsFileEarmarkTextFill /> Auditor√≠a (Logs)
                        </NavLink>
                    </>
                )}

                {/* =================================================
                   MEN√ö OPERATIVO SST (Solo para Admin SST)
                   ================================================= */}
                {isAdminSST && (
                    <>
                        <div className="sidebar-section-label">GESTI√ìN OPERATIVA</div>
                        
                        <NavLink to="/dashboard" className="sidebar-link" onClick={onClose}>
                            <BsGrid1X2Fill /> Dashboard SST
                        </NavLink>

                        <NavLink to="/historial" className="sidebar-link" onClick={onClose}>
                            <BsClockHistory /> Historial y Trazabilidad
                        </NavLink>

                        <NavLink to="/presupuesto" className="sidebar-link" onClick={onClose}>
                            <BsCurrencyDollar /> Presupuesto SST
                        </NavLink>

                        <NavLink to="/usuarios" className="sidebar-link" onClick={onClose}>
                            <BsPeopleFill /> Usuarios Locales
                        </NavLink>

                        <NavLink to="/directorio" className="sidebar-link" onClick={onClose}>
                            <BsJournalRichtext /> Directorio Colaboradores
                        </NavLink>

                        <div className="sidebar-section-label">PROCESOS</div>

                        <NavLink to="/planificacion" className="sidebar-link" onClick={onClose}>
                            <BsCalendarWeek /> Planificaci√≥n
                        </NavLink>

                        <NavLink to="/inspecciones" className="sidebar-link" onClick={onClose}>
                            <BsClipboard2CheckFill /> Inspecciones
                        </NavLink>

                        <NavLink to="/pesv" className="sidebar-link" onClick={onClose}>
                            <BsConeStriped /> Gesti√≥n PESV
                        </NavLink>

                        <NavLink to="/activos" className="sidebar-link" onClick={onClose}>
                            <BsArchiveFill /> Activos y Equipos
                        </NavLink>

                        <NavLink to="/reportes" className="sidebar-link" onClick={onClose}>
                            <BsExclamationTriangleFill /> Reportes Colaboradores
                        </NavLink>

                        <div className="sidebar-section-label">AN√ÅLISIS Y CIERRE</div>

                        <NavLink to="/indicadores" className="sidebar-link" onClick={onClose}>
                            <BsBarChartFill /> Indicadores
                        </NavLink>

                        <NavLink to="/acpm" className="sidebar-link" onClick={onClose}>
                            <BsGraphUpArrow /> Acciones (ACPM)
                        </NavLink>
                        
                        <NavLink to="/actas" className="sidebar-link" onClick={onClose}>
                            <BsFileText /> Actas de Comit√©
                        </NavLink>

                        <NavLink to="/solicitudes" className="sidebar-link" onClick={onClose}>
                            <BsEnvelopeExclamation /> Solicitudes a Gerencia
                        </NavLink>

                        <NavLink to="/documentos" className="sidebar-link" onClick={onClose}>
                            <BsFillFolderFill /> Documentaci√≥n
                        </NavLink>

                        <NavLink to="/medicina" className="sidebar-link" onClick={onClose}>
                            <BsHeartPulseFill /> Medicina Laboral
                        </NavLink>
                    </>
                )}

                {/* =================================================
                   MEN√ö COLABORADOR
                   ================================================= */}
                {isColaborador && (
                    <>
                        <div className="sidebar-section-label">MI GESTI√ìN</div>
                        <NavLink to="/dashboard" className="sidebar-link" onClick={onClose}>
                            <BsHouseFill /> Inicio
                        </NavLink>
                        <NavLink to="/reportar-maquina" className="sidebar-link" onClick={onClose}>
                            <BsCpuFill /> Reportar M√°quina
                        </NavLink>
                        <NavLink to="/reportar-seguridad" className="sidebar-link" onClick={onClose}>
                            <BsShieldFillExclamation /> Reportar Seguridad
                        </NavLink>
                    </>
                )}
            </nav>

            <div className="sidebar-footer">
                <span style={{padding: '1rem', fontSize: '0.75rem', color: '#ffffff80', display: 'block', textAlign: 'center'}}>
                    {usuario?.nombre}<br/>
                    <strong style={{ color: 'white', textTransform: 'uppercase' }}>{usuario?.rol}</strong>
                </span>
            </div>
        </aside>
    );
};

export default Sidebar; 


==================================================================
ARCHIVO: frontend\src\components\TabPasosPESV.jsx
==================================================================
// frontend/src/components/TabPasosPESV.jsx

import React, { useState, useEffect } from 'react';
import { apiFetch } from '../services/apiService'; 
import { useAuth } from '../context/AuthContext'; 
import '../index.css';
import Swal from 'sweetalert2';
import { BsFileEarmarkPdf, BsMagic, BsUpload, BsEye, BsPencil, BsTrash, BsPlusLg, BsInputCursorText } from 'react-icons/bs';

import ModalGenerarDocumento from './ModalGenerarDocumento';
import ModalVerEvidencia from './ModalVerEvidencia';
import ModalGuardarPaso from './ModalGuardarPaso';         
import ModalConfigurarPlantilla from './ModalConfigurarPlantilla'; 

const TabPasosPESV = () => {
    const { usuario } = useAuth();
    const [pasos, setPasos] = useState([]);
    // eslint-disable-next-line no-unused-vars
    const [isLoading, setIsLoading] = useState(true);
    
    // Estados Modales
    const [pasoSeleccionado, setPasoSeleccionado] = useState(null);
    const [modalGenerarOpen, setModalGenerarOpen] = useState(false);
    const [modalGestionarOpen, setModalGestionarOpen] = useState(false);
    const [modalVerEvidenciaOpen, setModalVerEvidenciaOpen] = useState(false);
    const [modalCRUDOpen, setModalCRUDOpen] = useState(false); 
    const [modalConfigOpen, setModalConfigOpen] = useState(false); 

    // Estados Gesti√≥n Manual
    const [file, setFile] = useState(null);
    const [nuevoEstado, setNuevoEstado] = useState('');
    
    // Estados Visualizar
    const [evidenciasVisualizar, setEvidenciasVisualizar] = useState([]);
    const [nombrePasoVisualizar, setNombrePasoVisualizar] = useState('');

    const esSuperAdmin = usuario.rol === 'Super Admin';

    useEffect(() => { cargarPasos(); }, []);

    const cargarPasos = async () => {
        try {
            const data = await apiFetch('/pesv/pasos');
            setPasos(data);
        } catch (error) { console.error(error); } finally { setIsLoading(false); }
    };

    // --- CRUD PASOS ---
    const handleNuevoPaso = () => { setPasoSeleccionado(null); setModalCRUDOpen(true); };
    const handleEditarPaso = (paso) => { setPasoSeleccionado(paso); setModalCRUDOpen(true); };
    const handleDise√±arFormulario = (paso) => { setPasoSeleccionado(paso); setModalConfigOpen(true); };

    const handleEliminarPaso = async (paso) => {
        const result = await Swal.fire({
            title: '¬øEliminar paso?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'S√≠, eliminar'
        });
        if (result.isConfirmed) {
            try {
                await apiFetch(`/pesv/pasos/${paso.ID_Paso}`, { method: 'DELETE' });
                Swal.fire('Eliminado', 'Paso eliminado.', 'success');
                cargarPasos();
            } catch (error) { Swal.fire('Error', error.message, 'error'); }
        }
    };

    // --- VER EVIDENCIAS ---
    const handleVerEvidencias = async (paso) => {
        if (paso.CantidadEvidencias === 0) return;
        try {
            const archivos = await apiFetch(`/pesv/pasos/${paso.ID_Paso}/evidencias`);
            setEvidenciasVisualizar(archivos);
            setNombrePasoVisualizar(paso.NombrePaso);
            setModalVerEvidenciaOpen(true);
        // eslint-disable-next-line no-unused-vars
        } catch (error) { Swal.fire('Error', 'No se cargaron archivos', 'error'); }
    };

    // --- GESTI√ìN MANUAL ---
    const abrirGestionar = (paso) => {
        setPasoSeleccionado(paso);
        setNuevoEstado(paso.Estado);
        setFile(null);
        setModalGestionarOpen(true);
    };

    const handleGuardarManual = async () => {
        if (!pasoSeleccionado) return;
        const formData = new FormData();
        formData.append('idPaso', pasoSeleccionado.ID_Paso);
        formData.append('estado', nuevoEstado);
        if (file) formData.append('evidencia', file);

        try {
            const token = localStorage.getItem('token');
            const response = await fetch('http://localhost:5000/api/pesv/pasos/actualizar', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });
            if (response.ok) {
                Swal.fire('Actualizado', 'Paso actualizado.', 'success');
                setModalGestionarOpen(false);
                cargarPasos();
            } else throw new Error('Error');
        } catch (error) { Swal.fire('Error', error.message, 'error'); }
    };

    const getEstadoColor = (estado) => {
        if (estado === 'Realizada' || estado === 'Realizado') return 'status-activo';
        if (estado === 'En Proceso') return 'status-proceso';
        return 'status-pendiente';
    };

    const avance = pasos.length > 0 ? Math.round((pasos.filter(p => p.Estado === 'Realizado').length / pasos.length) * 100) : 0;

    return (
        <div className="table-wrapper">
            <div style={{marginBottom: '1.5rem', padding: '1rem', backgroundColor: '#eef2f7', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'space-between'}}>
                <div>
                    <h3 style={{margin:0, color: '#005A5B'}}>Avance PESV</h3>
                    <p style={{margin:0, color:'#666'}}>Ciclo PHVA</p>
                </div>
                <div style={{display:'flex', alignItems:'center', gap:'20px'}}>
                    {esSuperAdmin && (
                        <button className="btn btn-primary" onClick={handleNuevoPaso}>
                            <BsPlusLg /> Nuevo Paso
                        </button>
                    )}
                    <div style={{textAlign:'right'}}>
                        <div style={{fontSize: '2rem', fontWeight: 'bold', color: avance === 100 ? '#28a745' : '#005A5B'}}>{avance}%</div>
                        <small>Cumplimiento</small>
                    </div>
                </div>
            </div>

            <table className="data-table">
                <thead>
                    <tr>
                        <th style={{width:'50px'}}>#</th>
                        <th>Requisito</th>
                        <th>Normativa</th>
                        <th>Evidencias</th>
                        <th>Estado</th>
                        <th style={{width:'200px'}}>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    {pasos.map(p => (
                        <tr key={p.ID_Paso}>
                            <td><strong>{p.NumeroPaso}</strong></td>
                            <td><strong>{p.NombrePaso}</strong></td>
                            <td style={{fontSize:'0.85rem', color:'#666'}}>{p.DescripcionNorma}</td>
                            
                            {/* COLUMNA EVIDENCIAS (CLICKEABLE) */}
                            <td style={{cursor: p.CantidadEvidencias > 0 ? 'pointer' : 'default'}} onClick={() => handleVerEvidencias(p)}>
                                {p.CantidadEvidencias > 0 ? (
                                    <div className="status-pill" style={{backgroundColor:'#e7f1ff', color:'#007BFF', display:'inline-flex', alignItems:'center', gap:'5px', border:'1px solid #007BFF'}}>
                                        <BsEye /> {p.CantidadEvidencias}
                                    </div>
                                ) : <span style={{color:'#999', fontSize:'0.8rem'}}>--</span>}
                            </td>

                            <td><span className={`status-pill ${getEstadoColor(p.Estado)}`}>{p.Estado}</span></td>
                            
                            <td>
                                <div style={{display: 'flex', gap: '5px', flexWrap: 'wrap'}}>
                                    <button className="btn btn-sm btn-magic" title="Generar" onClick={() => { setPasoSeleccionado(p); setModalGenerarOpen(true); }}><BsMagic /></button>
                                    <button className="btn btn-sm btn-action" title="Gestionar" onClick={() => abrirGestionar(p)}><BsUpload /></button>
                                    
                                    {esSuperAdmin && (
                                        <>
                                            <button className="btn btn-sm" style={{backgroundColor:'#fd7e14', color:'white'}} title="Dise√±ar" onClick={() => handleDise√±arFormulario(p)}><BsInputCursorText /></button>
                                            <button className="btn btn-sm btn-warning" title="Editar" onClick={() => handleEditarPaso(p)}><BsPencil /></button>
                                            <button className="btn btn-sm btn-danger" title="Eliminar" onClick={() => handleEliminarPaso(p)}><BsTrash /></button>
                                        </>
                                    )}
                                </div>
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>

            {/* MODALES */}
            {modalGestionarOpen && (
                <div className="modal-overlay" onClick={() => setModalGestionarOpen(false)}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header"><h3>Gesti√≥n Manual</h3><button className="modal-close-button" onClick={() => setModalGestionarOpen(false)}>&times;</button></div>
                        <div className="modal-body">
                            <div className="form-group"><label>Estado</label><select className="form-control" value={nuevoEstado} onChange={e => setNuevoEstado(e.target.value)}><option>Pendiente</option><option>En Proceso</option><option>Realizado</option></select></div>
                            <div className="form-group"><label>Evidencia</label><input type="file" className="form-control" onChange={e => setFile(e.target.files[0])} /></div>
                        </div>
                        <div className="modal-footer"><button className="btn btn-secondary" onClick={() => setModalGestionarOpen(false)}>Cancelar</button><button className="btn btn-primary" onClick={handleGuardarManual}>Guardar</button></div>
                    </div>
                </div>
            )}

            {modalGenerarOpen && <ModalGenerarDocumento paso={pasoSeleccionado} alCerrar={() => setModalGenerarOpen(false)} alExito={() => { setModalGenerarOpen(false); cargarPasos(); }} />}
            {modalVerEvidenciaOpen && <ModalVerEvidencia archivos={evidenciasVisualizar} pasoNombre={nombrePasoVisualizar} alCerrar={() => setModalVerEvidenciaOpen(false)} />}
            
            {modalCRUDOpen && <ModalGuardarPaso paso={pasoSeleccionado} alCerrar={() => setModalCRUDOpen(false)} alExito={() => { setModalCRUDOpen(false); cargarPasos(); }} />}
            {modalConfigOpen && <ModalConfigurarPlantilla paso={pasoSeleccionado} alCerrar={() => setModalConfigOpen(false)} />}
        </div>
    );
};

export default TabPasosPESV;


==================================================================
ARCHIVO: frontend\src\context\AuthContext.jsx
==================================================================
// frontend/src/context/AuthContext.jsx

import { createContext, useContext, useState, useEffect } from 'react';
import { jwtDecode } from 'jwt-decode'; // Importamos el decodificador
import * as authService from '../services/authService';

// 1. Crear el Contexto
const AuthContext = createContext();

// 2. Crear el Proveedor (Provider)
export const AuthProvider = ({ children }) => {
    const [token, setToken] = useState(null);
    const [usuario, setUsuario] = useState(null); // { id, nombre, rol }
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [isLoading, setIsLoading] = useState(true); // Para la carga inicial

    useEffect(() => {
        // Comprobar si ya existe un token en localStorage al cargar la app
        setIsLoading(true);
        const storedToken = authService.getCurrentToken();
        
        if (storedToken) {
            try {
                // Decodificamos el token para obtener la info del usuario
                const decoded = jwtDecode(storedToken); 
                
                // Comprobamos si el token ha expirado
                if (decoded.exp * 1000 < Date.now()) {
                    authService.logout(); // Token expirado, lo borramos
                } else {
                    // Token v√°lido
                    setToken(storedToken);
                    setUsuario(decoded.usuario); // { id, nombre, rol }
                    setIsAuthenticated(true);
                }
            } catch (error) {
                console.error("Error decodificando el token:", error);
                authService.logout(); // Token corrupto, lo borramos
            }
        }
        setIsLoading(false);
    }, []);

    // Funci√≥n de Login que se llamar√° desde la p√°gina de Login
    const login = async (cedula, password) => {
        // Llama al servicio de API
        const data = await authService.login(cedula, password);

        // Si tuvo √©xito, el servicio ya guard√≥ el token en localStorage
        const decoded = jwtDecode(data.token);
        
        // Actualizamos el estado global
        setToken(data.token);
        setUsuario(decoded.usuario);
        setIsAuthenticated(true);
    };

    // Funci√≥n de Logout
    const logout = () => {
        authService.logout(); // Borra de localStorage
        // Resetea el estado global
        setToken(null);
        setUsuario(null);
        setIsAuthenticated(false);
    };

    // El valor que compartiremos a toda la app
    const value = {
        token,
        usuario, // El objeto { id, nombre, rol }
        isAuthenticated,
        isLoading,
        login, // La funci√≥n de login
        logout, // La funci√≥n de logout
    };

    return (
        <AuthContext.Provider value={value}>
            {children}
        </AuthContext.Provider>
    );
};

// 3. Crear un Hook personalizado para usar el contexto f√°cilmente
// eslint-disable-next-line react-refresh/only-export-components
export const useAuth = () => {
    const context = useContext(AuthContext);
    if (!context) {
        throw new Error('useAuth debe ser usado dentro de un AuthProvider');
    }
    return context;
};


==================================================================
ARCHIVO: frontend\src\index.css
==================================================================
/* frontend/src/index.css (Global y Responsive) */
@import 'sweetalert2/dist/sweetalert2.min.css';

/* --- 1. VARIABLES DE DISE√ëO (TEMA PROFESIONAL) --- */
:root {
    /* Paleta de Colores */
    --color-primario: #005A5B; /* Verde Oscuro (Teal) */
    --color-primario-hover: #004B4C;
    --color-acento: #007BFF; /* Azul Acento */
    --color-acento-hover: #0056b3;
    --color-danger: #f37683; /* Rojo */
    --color-danger-hover: #c82333;
    --color-warning: #f1ce63; /* Amarillo */
    --color-warning-hover: #e0a800;
    --color-secondary: #6c757d; /* Gris */
    --color-secondary-hover: #5a6268;
    --color-success: #28a745; /* Verde 'OK' */
    --color-success-hover: #218838;
    

    /* Paleta de UI */
    --color-bg: #f4f7f6; /* Fondo de p√°gina */
    --color-card: #ffffff;
    --color-text: #212529;
    --color-text-secondary: #6c757d;
    --color-border: #dee2e6;

    /* Sombras y Bordes */
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.05);
    --border-radius: 8px;
}

/* --- 2. RESET Y ESTILOS BASE (PARA CENTRAR EL LOGIN) --- */
body, html {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--color-bg); 
    color: var(--color-text);
}
body, #root {
    width: 100%;
    min-height: 100vh;
    display: flex;
    justify-content: center; /* Centra horizontalmente */
    align-items: center;    /* Centra verticalmente */
    box-sizing: border-box;
}
#root.layout-activo {
    display: block; /* Desactiva el centrado cuando est√°s logueado */
    min-height: 100vh;
}

/* --- 3. ESTILOS DE LAYOUT DE P√ÅGINA REUTILIZABLES --- */
.page-container {
    width: 100%;
}
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap; 
    gap: 1rem; 
}
.page-header h1 {
    font-size: 2rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0;
}
.page-content-card {
    background-color: var(--color-card);
    border-radius: var(--border-radius);
    padding: 2rem;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--color-border);
    /* Agregado sutil para evitar desbordes, pero sin cambiar tu dise√±o */
    overflow: hidden; 
    max-width: 100%;
}

/* --- 4. CLASES DE BOTONES GLOBALES --- */
.btn {
    padding: 0.75rem 1.25rem;
    border: none;
    border-radius: var(--border-radius);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-flex; 
    align-items: center;
    justify-content: center;
    gap: 0.5rem; 
    white-space: nowrap;
}
.btn:disabled {
    background-color: #aaa;
    color: #eee;
    box-shadow: none;
    cursor: not-allowed;
}
.btn-primary { background-color: var(--color-acento); color: white; }
.btn-primary:hover:not(:disabled) { background-color: var(--color-acento-hover); }
.btn-secondary { background-color: var(--color-secondary); color: white; }
.btn-secondary:hover:not(:disabled) { background-color: var(--color-secondary-hover); }
.btn-danger { background-color: var(--color-danger); color: white; }
.btn-danger:hover:not(:disabled) { background-color: var(--color-danger-hover); }
.btn-warning { background-color: var(--color-warning); color: var(--color-text); }
.btn-warning:hover:not(:disabled) { background-color: var(--color-warning-hover); }
.btn-success { background-color: var(--color-success); color: white; }
.btn-success:hover:not(:disabled) { background-color: var(--color-success-hover); }
.btn-icon {
    background-color: transparent;
    border: 1px solid var(--color-border);
    color: var(--color-secondary);
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
}
.btn-icon:hover { background-color: #f8f9fa; }
.btn-icon svg {
    width: 14px;
    height: 14px;
}

/* --- 5. ESTILOS DE FORMULARIO GLOBALES --- */
.form-group { margin-bottom: 1.5rem; }
.form-group label { display: block; font-size: 0.9rem; font-weight: 600; color: var(--color-text-secondary); margin-bottom: 0.5rem; }
.form-group input[type="text"],
.form-group input[type="password"],
.form-group input[type="number"],
.form-group input[type="date"],
.form-group input[type="file"],
.form-group select,
.form-group textarea {
    width: 100%; padding: 0.8rem; font-size: 1rem; border: 1px solid var(--color-border);
    border-radius: var(--border-radius); box-sizing: border-box; font-family: inherit; background-color: #fff;
}
.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none; border-color: var(--color-acento); box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}
.form-group textarea { resize: vertical; min-height: 80px; }

/* --- 6. ESTILOS DE TABLA GLOBALES Y RESPONSIVE --- */
.table-wrapper {
    width: 100%;
    overflow-x: auto; /* Permite scroll horizontal */
}
.data-table {
    width: 100%;
    border-collapse: collapse; 
    min-width: 900px; /* Ancho m√≠nimo para forzar el scroll */
}
.data-table th, .data-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
}
.data-table th {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    background-color: #f8f9fa;
}
.data-table td {
    font-size: 0.95rem;
    color: var(--color-text);
}
.data-table tr:hover {
    background-color: #f8f9fa;
}
.action-buttons {
    white-space: nowrap;
    display: flex;
    gap: 0.5rem;
}

/* --- 7. P√çLDORAS DE ESTADO GLOBALES --- */
.status-pill { padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; white-space: nowrap; }
.status-activo { background-color: #e6f7ec; color: #005A5B; }
.status-pendiente { background-color: #fff8e1; color: #f57f17; }
.status-inactivo { background-color: #fbebee; color: #dc3545; }
.status-proceso { background-color: #e7f3ff; color: #007BFF; }

/* --- 8. MENSAJES GLOBALES --- */
.error-message { color: var(--color-danger); font-weight: 500; text-align: center; }
.success-message { color: var(--color-success); font-weight: 600; text-align: center; background-color: #e6f7ec; padding: 1rem; border-radius: var(--border-radius); }

/* --- 9. RESPONSIVIDAD GLOBAL --- */
@media (max-width: 768px) {
    body, #root {
        align-items: flex-start; 
    }
    .page-header { flex-direction: column; align-items: flex-start; }
    .page-content-card { padding: 1rem; }
    .action-buttons { flex-direction: column; width: 120px; }
}

/* ==========================================================================
   10. NUEVOS ESTILOS PARA FILTROS (Dise√±o limpio y corregido)
   ========================================================================== */

/* Contenedor de la barra de filtros */
.filters-bar {
    background-color: #ffffff;
    padding: 1rem; /* Padding original c√≥modo */
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.06);
    border: 1px solid #eff2f5;
    
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    
    /* ESTA es la clave para que no se monten: permitir salto de l√≠nea */
    flex-wrap: wrap; 
}

/* Contenedor del Input de B√∫squeda */
.search-input-container {
    position: relative;
    /* Flex grow + Flex basis para que ocupe espacio pero tenga un m√≠nimo sano */
    flex: 2 1 300px; 
    min-width: 250px; /* Evita que se aplaste demasiado */
}

/* Icono de Lupa */
.search-input-container svg {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: #98a2b3;
    font-size: 1rem;
    pointer-events: none;
    z-index: 2;
}

/* Input de Texto (Estilo P√≠ldora) */
.search-input-container input.form-control {
    width: 100%;
    height: 46px; /* Altura fija para alinear */
    padding-left: 42px !important; /* Espacio para la lupa */
    border-radius: 50px; /* Redondeado completo */
    border: 1px solid #e0e0e0;
    background-color: #f8f9fa;
    font-size: 0.95rem;
    box-shadow: none;
    transition: all 0.2s ease;
    box-sizing: border-box; /* Asegura que no se desborde */
}

/* Efecto Focus */
.search-input-container input.form-control:focus {
    background-color: #ffffff;
    border-color: var(--color-acento);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
}

/* Contenedor del Selector */
.filter-select-container {
    /* Ocupa menos espacio que el buscador, pero tiene un ancho base */
    flex: 1 1 200px; 
    min-width: 200px;
}

/* Selector (Dropdown) */
.filter-select-container select.form-control {
    width: 100%;
    height: 46px; /* Misma altura que el buscador */
    border-radius: 10px; /* Bordes un poco menos redondos */
    border: 1px solid #e0e0e0;
    background-color: #ffffff;
    padding-left: 1rem;
    cursor: pointer;
    color: var(--color-text);
    font-weight: 500;
    box-sizing: border-box;
}

.filter-select-container select.form-control:focus {
    border-color: var(--color-acento);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
    outline: none;
}



/* Ajuste Responsive (Celulares) */
@media (max-width: 768px) {
    .filters-bar {
        flex-direction: column;
        align-items: stretch; /* Estira al ancho completo */
        gap: 1rem;
    }
    
    .search-input-container, 
    .filter-select-container {
        flex: 1 1 100%;
        width: 100%;
        min-width: 100%;
    }
}
/* --- ESTILOS DEL GESTOR DE FORMULARIOS (PANEL DIVIDIDO) --- */

/* Contenedor Principal del Panel */
.split-layout-container {
    display: flex;
    gap: 1.5rem;
    height: calc(100vh - 140px); /* Resta el header principal */
    overflow: hidden; /* Evita scroll en la p√°gina entera */
}

/* --- PANEL IZQUIERDO (LISTA) --- */
.split-sidebar {
    width: 320px;
    min-width: 300px;
    background-color: #fff;
    border-radius: 12px;
    border: 1px solid #e0e0e0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    display: flex;
    flex-direction: column;
}

.sidebar-search-box {
    padding: 1rem;
    border-bottom: 1px solid #f0f0f0;
}

.sidebar-list {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem;
}

.form-item {
    padding: 1rem;
    margin-bottom: 4px;
    border-radius: 8px;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
}

.form-item:hover {
    background-color: #f8f9fa;
    border-color: #eee;
}

.form-item.active {
    background-color: #f0f7ff; /* Azul muy claro */
    border-color: #cce5ff;
    position: relative;
}
.form-item.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 10%;
    height: 80%;
    width: 4px;
    background-color: var(--color-acento); /* Azul */
    border-radius: 0 4px 4px 0;
}

.form-item-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
    font-size: 0.95rem;
}
.form-item-subtitle {
    font-size: 0.8rem;
    color: #888;
    display: flex;
    justify-content: space-between;
}

/* --- PANEL DERECHO (EDITOR) --- */
.split-content {
    flex: 1;
    background-color: #fff;
    border-radius: 12px;
    border: 1px solid #e0e0e0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Importante para scrolls internos */
}

/* Cabecera del Formulario */
.editor-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e0e0e0;
    background-color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

/* Cuerpo con Preguntas */
.editor-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    background-color: #fcfcfc;
}

/* Tarjeta de Pregunta */
.question-block {
    background-color: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.02);
    transition: transform 0.2s;
}
.question-block:hover {
    border-color: #b0c4de;
    transform: translateX(2px);
}

.q-number {
    background-color: #e9ecef;
    color: #495057;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.85rem;
    margin-right: 1rem;
    flex-shrink: 0;
}

.q-text {
    flex: 1;
    font-size: 1rem;
    color: #333;
}

/* Footer para agregar */
.editor-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #e0e0e0;
    background-color: #fff;
}

/* Estado Vac√≠o */
.empty-placeholder {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #adb5bd;
    text-align: center;
}
.empty-placeholder svg {
    font-size: 4rem;
    margin-bottom: 1rem;
    color: #dee2e6;
}



/* ... (Todo el c√≥digo anterior) ... */

/* ==========================================================================
   11. MEJORAS RESPONSIVE PARA CONTENIDO INTERNO
   ========================================================================== */

@media (max-width: 768px) {
    /* 1. Ajustar fuentes generales */
    html {
        font-size: 14px; /* Reduce ligeramente el tama√±o base */
    }

    .page-header h1 {
        font-size: 1.5rem; /* T√≠tulos m√°s peque√±os */
    }

    /* 2. Tablas: Ajustes para scroll y legibilidad */
    .data-table th, .data-table td {
        padding: 0.75rem 0.5rem; /* Menos relleno en celdas */
        font-size: 0.85rem;
    }
    
    /* Forzar scroll suave en tablas */
    .table-wrapper {
        -webkit-overflow-scrolling: touch;
        margin-bottom: 1rem;
    }

    /* 3. Botones de acci√≥n en tablas */
    .action-buttons {
        flex-direction: row; /* Mantener en fila si caben */
        flex-wrap: wrap; /* Permitir bajar si no caben */
        gap: 5px;
    }
    .action-buttons .btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
    }

    /* 4. Ajustes para tarjetas de Dashboard */
    .dashboard-lists-grid {
        grid-template-columns: 1fr !important; /* Forzar una sola columna */
    }
    
    .kpi-grid {
        grid-template-columns: 1fr 1fr; /* 2 columnas en tablets/m√≥viles grandes */
        gap: 1rem;
    }
}

@media (max-width: 480px) {
    /* En celulares muy peque√±os, KPIs en una sola columna */
    .kpi-grid {
        grid-template-columns: 1fr;
    }
    
    /* Ocultar columnas menos importantes en tablas si fuera necesario, 
       o confiar en el scroll horizontal (que ya tienes configurado). */
}


==================================================================
ARCHIVO: frontend\src\layout\ColaboradorLayout.jsx
==================================================================
// frontend/src/layout/ColaboradorLayout.jsx

import React from 'react';
import { Outlet } from 'react-router-dom';
import Header from '../components/Header'; // Importamos el Header (que ya tiene logout)
import '../style/ColaboradorLayout.css'; // CSS nuevo

const ColaboradorLayout = () => {
    return (
        <div className="colaborador-layout">
            {/* 1. Header en la parte superior */}
            <Header />

            {/* 2. Contenido de la p√°gina (se renderiza aqu√≠) */}
            <main className="colaborador-page-content">
                <Outlet />
            </main>
        </div>
    );
};

export default ColaboradorLayout;


==================================================================
ARCHIVO: frontend\src\layout\MainLayout.jsx
==================================================================
// frontend/src/layout/MainLayout.jsx

import React, { useState } from 'react';
import { Outlet } from 'react-router-dom';
import Sidebar from '../components/Sidebar'; 
import Header from '../components/Header';   
import '../style/MainLayout.css'; 

/**
 * @component MainLayout
 * @desc El layout principal que gestiona la apertura del men√∫ en m√≥vil.
 */
const MainLayout = () => {
    // Estado para controlar si el sidebar est√° abierto en m√≥vil
    const [isSidebarOpen, setIsSidebarOpen] = useState(false);

    const toggleSidebar = () => {
        setIsSidebarOpen(!isSidebarOpen);
    };

    const closeSidebar = () => {
        setIsSidebarOpen(false);
    };

    return (
        <div className="app-layout">
            
            {/* --- 1. Barra Lateral (Recibe estado y funci√≥n de cerrar) --- */}
            <Sidebar isOpen={isSidebarOpen} onClose={closeSidebar} />

            {/* --- Overlay Oscuro (Solo visible en m√≥vil cuando el men√∫ est√° abierto) --- */}
            {isSidebarOpen && (
                <div className="sidebar-overlay" onClick={closeSidebar}></div>
            )}

            {/* --- 2. Contenedor Principal (derecha) --- */}
            <div className="main-content-wrapper">
                
                {/* --- Barra Superior (Recibe la funci√≥n para ABRIR el men√∫) --- */}
                <Header onToggleSidebar={toggleSidebar} />
                
                {/* 'Outlet' renderizar√° la p√°gina actual */}
                <main className="page-content">
                    <Outlet />
                </main>
            </div>
        </div>
    );
};

export default MainLayout;


==================================================================
ARCHIVO: frontend\src\main.jsx
==================================================================
// frontend/src/main.jsx

import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App.jsx';
import { BrowserRouter } from 'react-router-dom';
import { AuthProvider } from './context/AuthContext'; // <--- Importa tu AuthProvider
// Asumo que tienes un index.css global
import './index.css'; 

ReactDOM.createRoot(document.getElementById('root')).render(
    <React.StrictMode>
        {/* 1. Envuelve todo con el AuthProvider */}
        <AuthProvider>
            {/* 2. Envuelve todo con el BrowserRouter */}
            <BrowserRouter>
                <App />
            </BrowserRouter>
        </AuthProvider>
    </React.StrictMode>,
);


==================================================================
ARCHIVO: frontend\src\pages\AcpmPage.jsx
==================================================================
// frontend/src/pages/AcpmPage.jsx

import React, { useState, useEffect, useMemo } from 'react';
import { getACPMs } from '../services/acpmService';
import '../index.css'; 
import { BsPlusLg, BsSearch } from 'react-icons/bs';

import ModalCrearACPM from '../components/ModalCrearACPM.jsx'; 
import ModalGestionarACPM from '../components/ModalGestionarACPM.jsx';
import ModalVerACPM from '../components/ModalVerACPM.jsx'; 

const AcpmPage = () => {
    // --- Estados ---
    const [acpmLista, setAcpmLista] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);

    // --- Estados de Filtros (NUEVOS) ---
    const [busqueda, setBusqueda] = useState('');
    const [filtroEstado, setFiltroEstado] = useState('');

    // --- Estados de Modales ---
    const [modalCrearAbierto, setModalCrearAbierto] = useState(false);
    const [modalGestionarAbierto, setModalGestionarAbierto] = useState(false);
    const [modalVerAbierto, setModalVerAbierto] = useState(false); 
    const [acpmSeleccionada, setAcpmSeleccionada] = useState(null); 

    // --- Carga Inicial ---
    const cargarACPMs = async () => {
        try {
            setIsLoading(true);
            const data = await getACPMs();
            setAcpmLista(data);
            setError(null);
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    useEffect(() => {
        cargarACPMs();
    }, []);

    // --- L√ìGICA DE FILTRADO (NUEVA) ---
    const acpmFiltradas = useMemo(() => {
        return acpmLista.filter((acpm) => {
            const texto = busqueda.toLowerCase();
            
            // 1. B√∫squeda por Descripci√≥n, Origen o ID
            const matchTexto = 
                acpm.DescripcionProblema.toLowerCase().includes(texto) ||
                acpm.Origen.toLowerCase().includes(texto) ||
                acpm.ID_ACPM.toString().includes(texto);

            // 2. Filtro por Estado
            const matchEstado = filtroEstado ? acpm.EstadoACPM === filtroEstado : true;

            return matchTexto && matchEstado;
        });
    }, [acpmLista, busqueda, filtroEstado]);

    // --- Manejadores de Modal (Sin cambios) ---
    const handleAcpmCreada = () => { setModalCrearAbierto(false); cargarACPMs(); };
    
    const abrirModalGestionar = (acpm) => { setAcpmSeleccionada(acpm); setModalGestionarAbierto(true); };
    const cerrarModalGestionar = () => { setModalGestionarAbierto(false); setAcpmSeleccionada(null); };
    const handleAcpmGestionada = () => { cerrarModalGestionar(); cargarACPMs(); };

    const abrirModalVer = (acpm) => { setAcpmSeleccionada(acpm); setModalVerAbierto(true); };
    const cerrarModalVer = () => { setModalVerAbierto(false); setAcpmSeleccionada(null); };

    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        const fecha = new Date(fechaISO.split('T')[0] + 'T00:00:00');
        return fecha.toLocaleDateString('es-CO');
    };

    const getEstadoClass = (estado) => {
        if (estado === 'Abierta') return 'status-pendiente'; 
        if (estado === 'En Proceso') return 'status-proceso'; 
        if (estado === 'Cerrada') return 'status-activo'; 
        return 'status-inactivo'; 
    };

    return (
        <div className="page-container">
            {/* --- Encabezado --- */}
            <div className="page-header">
                <h1>Gesti√≥n de Acciones (ACPM)</h1>
                <button className="btn btn-primary" onClick={() => setModalCrearAbierto(true)}>
                    <BsPlusLg /> Crear Nueva ACPM
                </button>
            </div>

            {/* --- BARRA DE FILTROS (NUEVA) --- */}
            <div className="filters-bar" style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                {/* Input B√∫squeda */}
                <div className="search-input-container" style={{ flex: 1, minWidth: '250px', position: 'relative' }}>
                    <BsSearch style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#aaa' }} />
                    <input 
                        type="text" 
                        className="form-control" 
                        placeholder="Buscar por descripci√≥n, origen o ID..." 
                        style={{ paddingLeft: '35px', height: '40px' }}
                        value={busqueda}
                        onChange={(e) => setBusqueda(e.target.value)}
                    />
                </div>

                {/* Select Estado */}
                <div className="filter-select-container" style={{ minWidth: '200px' }}>
                    <select 
                        className="form-control"
                        style={{ height: '40px' }}
                        value={filtroEstado}
                        onChange={(e) => setFiltroEstado(e.target.value)}
                    >
                        <option value="">Todos los Estados</option>
                        <option value="Abierta">Abierta</option>
                        <option value="En Proceso">En Proceso</option>
                        <option value="Cerrada">Cerrada</option>
                    </select>
                </div>
            </div>

            {/* --- Tabla --- */}
            <div className="page-content-card">
                <div className="table-wrapper">
                    {isLoading && <p>Cargando acciones ACPM...</p>}
                    {error && <p className="error-message">Error: {error}</p>}
                    
                    {!isLoading && !error && (
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Tipo</th>
                                    <th>Origen</th>
                                    <th>Descripci√≥n</th>
                                    <th>Responsable</th>
                                    <th>Fecha L√≠mite</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {acpmFiltradas.length === 0 ? (
                                    <tr><td colSpan="8" style={{ textAlign: 'center' }}>No se encontraron acciones.</td></tr>
                                ) : (
                                    acpmFiltradas.map((acpm) => (
                                        <tr key={acpm.ID_ACPM}>
                                            <td>{acpm.ID_ACPM}</td>
                                            <td>{acpm.TipoAccion}</td>
                                            <td>{acpm.Origen}</td>
                                            <td title={acpm.DescripcionProblema}>{acpm.DescripcionProblema.substring(0, 30)}...</td>
                                            <td>{acpm.NombreResponsable}</td>
                                            <td>{formatearFecha(acpm.FechaLimite)}</td>
                                            <td>
                                                <span className={`status-pill ${getEstadoClass(acpm.EstadoACPM)}`}>
                                                    {acpm.EstadoACPM}
                                                </span>
                                            </td>
                                            <td className="action-buttons">
                                                <button 
                                                    className="btn btn-secondary"
                                                    onClick={() => abrirModalVer(acpm)} 
                                                >
                                                    Ver
                                                </button>
                                                {acpm.EstadoACPM !== 'Cerrada' && (
                                                    <button 
                                                        className="btn btn-warning"
                                                        onClick={() => abrirModalGestionar(acpm)} 
                                                    >
                                                        Gestionar
                                                    </button>
                                                )}
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>
            
            {/* --- Modales --- */}
            {modalCrearAbierto && <ModalCrearACPM alCerrar={() => setModalCrearAbierto(false)} alExito={handleAcpmCreada} />}
            {modalGestionarAbierto && <ModalGestionarACPM acpm={acpmSeleccionada} alCerrar={cerrarModalGestionar} alExito={handleAcpmGestionada} />}
            {modalVerAbierto && <ModalVerACPM acpmId={acpmSeleccionada.ID_ACPM} alCerrar={cerrarModalVer} />}
        </div>
    );
};

export default AcpmPage;


==================================================================
ARCHIVO: frontend\src\pages\ActasPage.jsx
==================================================================
// frontend/src/pages/ActasPage.jsx

import React, { useState, useEffect, useRef, useMemo } from 'react';
import { getActas, actualizarArchivoActa, subirFirmasActa, descargarActa } from '../services/committeeService';
import ModalCrearActa from '../components/ModalCrearActa';
import '../index.css';
import Swal from 'sweetalert2';
import { BsPlusLg, BsSearch, BsCloudUpload, BsDownload, BsEye, BsPen } from 'react-icons/bs';

const ActasPage = () => {
    const [actas, setActas] = useState([]);
    const [modalOpen, setModalOpen] = useState(false);
    const [isLoading, setIsLoading] = useState(false);
    const [busqueda, setBusqueda] = useState('');

    // Estados para subida de archivos
    const fileInputRef = useRef(null);
    const [actaSeleccionada, setActaSeleccionada] = useState(null);
    const [tipoCarga, setTipoCarga] = useState(''); // 'ORIGINAL' o 'FIRMAS'

    const API_URL = 'http://localhost:5000';

    const cargarActas = async () => {
        setIsLoading(true);
        try {
            const data = await getActas();
            setActas(data);
        } catch (error) {
            console.error(error);
        } finally {
            setIsLoading(false);
        }
    };

    useEffect(() => { cargarActas(); }, []);

    const actasFiltradas = useMemo(() => {
        return actas.filter(acta => {
            const texto = busqueda.toLowerCase();
            return (
                acta.NumeroActa.toLowerCase().includes(texto) ||
                acta.Lugar.toLowerCase().includes(texto) ||
                acta.Objetivo.toLowerCase().includes(texto)
            );
        });
    }, [actas, busqueda]);

    // --- DESCARGA DIRECTA (SIN PESTA√ëA) ---
    const handleDescargar = async (idActa, tipo, nombreArchivo) => {
        try {
            const blob = await descargarActa(idActa, tipo);
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nombreArchivo;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        // eslint-disable-next-line no-unused-vars
        } catch (error) {
            Swal.fire('Error', 'No se pudo descargar el archivo.', 'error');
        }
    };

    // --- VER EN NAVEGADOR ---
    const handleVer = (ruta) => {
        if (!ruta) return;
        window.open(`${API_URL}/${ruta.replace(/\\/g, '/')}`, '_blank');
    };

    // --- SUBIR ARCHIVO ---
    const iniciarCarga = (acta, tipo) => {
        setActaSeleccionada(acta);
        setTipoCarga(tipo); 
        if (fileInputRef.current) {
            fileInputRef.current.value = "";
            fileInputRef.current.click(); 
        }
    };

    const handleArchivoSeleccionado = async (e) => {
        const file = e.target.files[0];
        if (!file || !actaSeleccionada) return;

        const esFirmas = tipoCarga === 'FIRMAS';
        const titulo = esFirmas ? 'Subir Acta Firmada' : 'Reemplazar Original';
        const texto = esFirmas 
            ? `Se agregar√° el documento de firmas para el Acta ${actaSeleccionada.NumeroActa}.`
            : `Se sobrescribir√° el archivo original del Acta ${actaSeleccionada.NumeroActa}.`;

        const result = await Swal.fire({
            title: titulo,
            text: texto,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#007BFF',
            confirmButtonText: 'S√≠, subir',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            try {
                const formData = new FormData();
                if (esFirmas) {
                    formData.append('archivoFirmas', file);
                    await subirFirmasActa(actaSeleccionada.ID_Acta, formData);
                } else {
                    formData.append('archivo', file);
                    await actualizarArchivoActa(actaSeleccionada.ID_Acta, formData);
                }
                
                Swal.fire('√âxito', 'Archivo subido correctamente.', 'success');
                cargarActas();
            } catch (error) {
                console.error(error);
                Swal.fire('Error', error.message, 'error');
            }
        }
        setActaSeleccionada(null);
        setTipoCarga('');
    };

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>Actas de Comit√©</h1>
                <button className="btn btn-primary" onClick={() => setModalOpen(true)}>
                    <BsPlusLg /> Crear Acta
                </button>
            </div>

            <input type="file" ref={fileInputRef} style={{display:'none'}} accept=".pdf" onChange={handleArchivoSeleccionado} />

            <div className="filters-bar" style={{marginBottom: '1.5rem'}}>
                <div className="search-input-container" style={{maxWidth: '400px', position: 'relative'}}>
                    <BsSearch style={{ position: 'absolute', left: '15px', top: '50%', transform: 'translateY(-50%)', color: '#aaa' }} />
                    <input 
                        type="text" className="form-control" 
                        placeholder="Buscar por N¬∞ Acta..." 
                        style={{ paddingLeft: '40px', height: '45px', borderRadius: '50px' }}
                        value={busqueda} onChange={(e) => setBusqueda(e.target.value)}
                    />
                </div>
            </div>

            <div className="page-content-card">
                <div className="table-wrapper">
                    {isLoading ? <p>Cargando actas...</p> : (
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>N¬∞ Acta</th>
                                    <th>Fecha</th>
                                    <th>Objetivo</th>
                                    <th style={{textAlign: 'center', width: '180px'}}>Acta Original</th>
                                    <th style={{textAlign: 'center', width: '180px'}}>Acta Firmada</th>
                                </tr>
                            </thead>
                            <tbody>
                                {actasFiltradas.length === 0 ? (
                                    <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem', color:'#999'}}>No se encontraron actas.</td></tr>
                                ) : (
                                    actasFiltradas.map(acta => (
                                        <tr key={acta.ID_Acta}>
                                            <td><strong>{acta.NumeroActa}</strong></td>
                                            <td>{new Date(acta.FechaReunion).toLocaleDateString()}</td>
                                            <td title={acta.Objetivo}>{acta.Objetivo.substring(0, 40)}...</td>
                                            
                                            {/* COLUMNA 1: ORIGINAL */}
                                            <td style={{textAlign: 'center'}}>
                                                {acta.RutaArchivo ? (
                                                    <div style={{display:'flex', gap:'5px', justifyContent:'center'}}>
                                                        <button className="btn btn-sm btn-secondary" onClick={() => handleVer(acta.RutaArchivo)} title="Ver">
                                                            <BsEye />
                                                        </button>
                                                        <button 
                                                            className="btn btn-sm btn-secondary" 
                                                            onClick={() => handleDescargar(acta.ID_Acta, 'original', `Acta_${acta.NumeroActa}.pdf`)} 
                                                            title="Descargar"
                                                        >
                                                            <BsDownload />
                                                        </button>
                                                        <button className="btn btn-sm btn-warning" onClick={() => iniciarCarga(acta, 'ORIGINAL')} title="Reemplazar">
                                                            <BsPen />
                                                        </button>
                                                    </div>
                                                ) : <span style={{color:'#999', fontSize:'0.8rem'}}>--</span>}
                                            </td>

                                            {/* COLUMNA 2: FIRMADA */}
                                            <td style={{textAlign: 'center'}}>
                                                {acta.RutaArchivoFirmas ? (
                                                    <div style={{display:'flex', gap:'5px', justifyContent:'center'}}>
                                                        <button className="btn btn-sm btn-success" onClick={() => handleVer(acta.RutaArchivoFirmas)} title="Ver Firmado">
                                                            <BsEye />
                                                        </button>
                                                        <button 
                                                            className="btn btn-sm btn-success" 
                                                            onClick={() => handleDescargar(acta.ID_Acta, 'firmas', `Acta_Firmada_${acta.NumeroActa}.pdf`)} 
                                                            title="Descargar Firmado"
                                                        >
                                                            <BsDownload />
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <button 
                                                        className="btn btn-sm"
                                                        style={{border:'1px dashed #007BFF', color:'#007BFF', background:'white'}}
                                                        onClick={() => iniciarCarga(acta, 'FIRMAS')}
                                                        title="Subir Firmas"
                                                    >
                                                        <BsCloudUpload /> Subir
                                                    </button>
                                                )}
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>

            {modalOpen && <ModalCrearActa alCerrar={() => setModalOpen(false)} alExito={() => { setModalOpen(false); cargarActas(); }} />}
        </div>
    );
};

export default ActasPage;


==================================================================
ARCHIVO: frontend\src\pages\ActivosPage.jsx
==================================================================
// frontend/src/pages/ActivosPage.jsx

import React, { useState, useEffect, useMemo } from 'react';
import { getActivosTodos, eliminarActivo, getTiposActivosDisponibles } from '../services/assetService';
import '../index.css';
import { BsPlusLg, BsSearch, BsPencilSquare, BsTrash, BsEyeFill } from 'react-icons/bs';

import ModalCrearActivo from '../components/ModalCrearActivo';
import ModalEditarActivo from '../components/ModalEditarActivo';
import ModalConfirmarAccion from '../components/ModalConfirmarAccion';
import ModalVerDetalleActivo from '../components/ModalVerDetalleActivo';
import Swal from 'sweetalert2';

const ActivosPage = () => {
    const [activos, setActivos] = useState([]);
    const [tiposDisponibles, setTiposDisponibles] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);

    // Filtros
    const [busqueda, setBusqueda] = useState('');
    const [filtroTipo, setFiltroTipo] = useState('');

    // Modales
    const [modalCrearAbierto, setModalCrearAbierto] = useState(false);
    const [modalEditarAbierto, setModalEditarAbierto] = useState(false);
    const [modalConfirmarAbierto, setModalConfirmarAbierto] = useState(false);
    const [modalVerDetalleAbierto, setModalVerDetalleAbierto] = useState(false);
    
    const [activoSeleccionado, setActivoSeleccionado] = useState(null);

    const cargarActivos = async () => {
        try {
            setIsLoading(true);
            const [dataActivos, dataTipos] = await Promise.all([
                getActivosTodos(),
                getTiposActivosDisponibles()
            ]);
            setActivos(dataActivos);
            setTiposDisponibles(dataTipos);
            setError(null);
        } catch (err) {
            console.error("Error:", err.message);
            setError("No se pudieron cargar los activos.");
        } finally {
            setIsLoading(false);
        }
    };

    useEffect(() => {
        cargarActivos();
    }, []);

    const activosFiltrados = useMemo(() => {
        return activos.filter((activo) => {
            const texto = busqueda.toLowerCase();
            const matchTexto = 
                activo.NombreDescriptivo.toLowerCase().includes(texto) ||
                activo.CodigoIdentificador.toLowerCase().includes(texto) ||
                (activo.Ubicacion && activo.Ubicacion.toLowerCase().includes(texto));

            const matchTipo = filtroTipo ? activo.TipoActivo === filtroTipo : true;
            return matchTexto && matchTipo;
        });
    }, [activos, busqueda, filtroTipo]);

    // Manejadores
    const handleActivoCreado = () => { setModalCrearAbierto(false); cargarActivos(); };
    
    const abrirModalEditar = (activo) => { setActivoSeleccionado(activo); setModalEditarAbierto(true); };
    const cerrarModalEditar = () => { setModalEditarAbierto(false); setActivoSeleccionado(null); };
    const handleActivoEditado = () => { cerrarModalEditar(); cargarActivos(); };

    const abrirModalEliminar = (activo) => { setActivoSeleccionado(activo); setModalConfirmarAbierto(true); };
    const cerrarModalEliminar = () => { setModalConfirmarAbierto(false); setActivoSeleccionado(null); };
    
    const abrirModalVer = (activo) => { setActivoSeleccionado(activo); setModalVerDetalleAbierto(true); };
    const cerrarModalVer = () => { setModalVerDetalleAbierto(false); setActivoSeleccionado(null); };

    const handleConfirmarEliminar = async () => {
        if (!activoSeleccionado) return;
        try {
            await eliminarActivo(activoSeleccionado.ID_Activo);
            cerrarModalEliminar();
            Swal.fire({ title: 'Eliminado', text: 'Activo eliminado.', icon: 'success', timer: 1500, showConfirmButton: false });
            cargarActivos(); 
        } catch (err) {
            cerrarModalEliminar();
            Swal.fire('Error', err.message, 'error');
        }
    };

    // Helper visual para la p√≠ldora de estado
    const getTipoClass = (tipo) => {
        if (!tipo) return 'status-pendiente';
        const t = tipo.toLowerCase();
        if (t.includes('vehiculo') || t.includes('moto') || t.includes('montacarga')) return 'status-proceso';
        if (t.includes('extintor') || t.includes('botiquin')) return 'status-activo';
        return 'status-pendiente';
    };

    const esVehiculo = (tipo) => {
        if (!tipo) return false;
        const t = tipo.toLowerCase().trim();
        return ['vehiculo', 'moto', 'montacarga', 'carro', 'camion', 'tractomula', 'furgon'].some(clave => t.includes(clave));
    };

    // Estilo base para botones de la tabla
    const btnBaseStyle = {
        padding: '0.35rem 0.75rem',
        fontSize: '0.85rem',
        display: 'inline-flex',
        alignItems: 'center',
        gap: '6px',
        border: 'none',
        borderRadius: '6px',
        color: 'white',
        fontWeight: '500',
        cursor: 'pointer',
        transition: 'background-color 0.2s ease',
        boxShadow: '0 2px 4px rgba(0,0,0,0.1)' 
    };

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>Gesti√≥n de Activos</h1>
                <button className="btn btn-primary" onClick={() => setModalCrearAbierto(true)}>
                    <BsPlusLg /> Crear Nuevo Activo
                </button>
            </div>

            <div className="filters-bar" style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                <div className="search-input-container" style={{ flex: 1, minWidth: '250px', position: 'relative' }}>
                    <BsSearch style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#aaa' }} />
                    <input 
                        type="text" className="form-control" 
                        placeholder="Buscar por nombre, c√≥digo o ubicaci√≥n..." 
                        style={{ paddingLeft: '35px', height: '40px' }}
                        value={busqueda} onChange={(e) => setBusqueda(e.target.value)}
                    />
                </div>
                <div className="filter-select-container" style={{ minWidth: '200px' }}>
                    <select className="form-control" style={{ height: '40px' }} value={filtroTipo} onChange={(e) => setFiltroTipo(e.target.value)}>
                        <option value="">Todos los Tipos</option>
                        {tiposDisponibles.map((tipoObj, idx) => {
                            const valor = typeof tipoObj === 'object' ? tipoObj.TipoActivoAsociado : tipoObj;
                            return <option key={idx} value={valor}>{valor}</option>;
                        })}
                    </select>
                </div>
            </div>

            <div className="page-content-card">
                <div className="table-wrapper">
                    {isLoading && <p>Cargando activos...</p>}
                    {!isLoading && !error && (
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>C√≥digo / Placa</th>
                                    <th>Nombre Descriptivo</th>
                                    <th>Ubicaci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {activosFiltrados.length === 0 ? (
                                    <tr><td colSpan="5" style={{ textAlign: 'center' }}>No se encontraron activos.</td></tr>
                                ) : (
                                    activosFiltrados.map((activo) => (
                                        <tr key={activo.ID_Activo}>
                                            <td>
                                                <span className={`status-pill ${getTipoClass(activo.TipoActivo)}`}>
                                                    {activo.TipoActivo}
                                                </span>
                                            </td>
                                            <td><strong>{activo.CodigoIdentificador}</strong></td>
                                            <td>{activo.NombreDescriptivo}</td>
                                            <td>{activo.Ubicacion || 'N/A'}</td>
                                            <td className="action-buttons" style={{display: 'flex', gap: '8px'}}>
                                                
                                                {/* 1. VER (Gris Acero - S√≥lido) */}
                                                {esVehiculo(activo.TipoActivo) && (
                                                    <button 
                                                        title="Ver Ficha T√©cnica" 
                                                        onClick={() => abrirModalVer(activo)}
                                                        style={{ 
                                                            ...btnBaseStyle,
                                                            backgroundColor: '#546e7a' // Gris Azulado Oscuro
                                                        }}
                                                        onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#455a64'}
                                                        onMouseOut={(e) => e.currentTarget.style.backgroundColor = '#546e7a'}
                                                    >
                                                        <BsEyeFill /> Ver
                                                    </button>
                                                )}

                                                {/* 2. EDITAR (Amarillo Ocre - S√≥lido y legible) */}
                                                <button 
                                                    title="Editar" 
                                                    onClick={() => abrirModalEditar(activo)}
                                                    style={{
                                                        ...btnBaseStyle,
                                                        backgroundColor: '#f0ad4e' // Amarillo Ocre (Bootstrap Warning)
                                                    }}
                                                    onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#ec971f'}
                                                    onMouseOut={(e) => e.currentTarget.style.backgroundColor = '#f0ad4e'}
                                                >
                                                    <BsPencilSquare /> Editar
                                                </button>
                                                
                                                {/* 3. ELIMINAR (Rojo Ladrillo - S√≥lido) */}
                                                <button 
                                                    title="Eliminar" 
                                                    onClick={() => abrirModalEliminar(activo)}
                                                    style={{
                                                        ...btnBaseStyle,
                                                        backgroundColor: '#d9534f' // Rojo Ladrillo Suave
                                                    }}
                                                    onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#c9302c'}
                                                    onMouseOut={(e) => e.currentTarget.style.backgroundColor = '#d9534f'}
                                                >
                                                    <BsTrash /> Eliminar
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>
            
            {/* Modales */}
            {modalCrearAbierto && <ModalCrearActivo alCerrar={() => setModalCrearAbierto(false)} alExito={handleActivoCreado} />}
            
            {modalEditarAbierto && <ModalEditarActivo activo={activoSeleccionado} alCerrar={cerrarModalEditar} alExito={handleActivoEditado} />}
            
            {modalVerDetalleAbierto && (
                <ModalVerDetalleActivo 
                    activo={activoSeleccionado} 
                    alCerrar={cerrarModalVer} 
                />
            )}

            {modalConfirmarAbierto && (
                <ModalConfirmarAccion
                    titulo="Eliminar Activo"
                    mensaje={`¬øEst√°s seguro de que deseas eliminar "${activoSeleccionado?.NombreDescriptivo}"?`}
                    enConfirmar={handleConfirmarEliminar}
                    alCerrar={cerrarModalEliminar}
                    textoBotonConfirmar="Eliminar"
                    claseBoton="btn-danger"
                />
            )}
        </div>
    );
};

export default ActivosPage;


==================================================================
ARCHIVO: frontend\src\pages\DashboardPage.jsx
==================================================================
// frontend/src/pages/DashboardPage.jsx

import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import { Link } from 'react-router-dom';
import { getMisReportesMaquina, getMisReportesSeguridad } from '../services/reportService';
import { 
    getAdminKPIs, 
    getAdminActividadesPendientes, 
    getAdminReportesRecientes,
    getAdminActividadesEstado // <--- Importado
} from '../services/dashboardService';
import ModalVerReporte from '../components/ModalVerReporte';

// Importaciones para Gr√°ficas
import { PieChart, Pie, Cell, Tooltip, Legend, ResponsiveContainer } from 'recharts';

import '../style/UsuariosPage.css';
import '../style/DashboardColaborador.css'; 
import '../style/DashboardAdmin.css';

// --- VISTA DEL COLABORADOR ---
const DashboardColaborador = ({ usuario }) => {
    const [misReportes, setMisReportes] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');
    
    // Estados para el modal de detalle
    const [modalVerAbierto, setModalVerAbierto] = useState(false);
    const [reporteSeleccionado, setReporteSeleccionado] = useState(null);

    useEffect(() => {
        const cargarMisReportes = async () => {
            try {
                const [maquina, seguridad] = await Promise.all([
                    getMisReportesMaquina(),
                    getMisReportesSeguridad()
                ]);
                // Unificar formatos para la tabla
                const maqFormateados = maquina.map(r => ({ 
                    id: `maq-${r.ID_ReporteMaquina}`,
                    ID_ReporteMaquina: r.ID_ReporteMaquina, // ID Real para el modal
                    fecha: r.FechaHoraReporte,
                    tipo: 'M√°quina (Pre-uso)',
                    rawTipo: 'maquina', // Para saber qu√© endpoint llamar
                    ref: r.NombreActivo, 
                    estado: r.EstadoRevision
                }));
                const segFormateados = seguridad.map(r => ({ 
                    id: `seg-${r.ID_ReporteSeguridad}`,
                    ID_ReporteSeguridad: r.ID_ReporteSeguridad, // ID Real para el modal
                    fecha: r.FechaHoraReporte,
                    tipo: r.TipoReporte, 
                    rawTipo: 'seguridad', // Para saber qu√© endpoint llamar
                    ref: r.UbicacionArea, 
                    estado: r.EstadoRevision
                }));
                
                const todos = [...maqFormateados, ...segFormateados];
                todos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                setMisReportes(todos);
            } catch (err) {
                console.error(err);
                setError('No se pudo cargar el historial de reportes.');
            } finally {
                setIsLoading(false);
            }
        };
        cargarMisReportes();
    }, []);

    const formatearFecha = (fechaISO) => new Date(fechaISO).toLocaleString('es-CO');

    // Funci√≥n para abrir el modal
    const abrirDetalle = (rep) => {
        setReporteSeleccionado(rep);
        setModalVerAbierto(true);
    };

    return (
        <div className="dashboard-colaborador">
            <div className="dashboard-colaborador-header">
                <h1>Hola, {usuario.nombre}</h1>
            </div>
            <div className="report-cards-container">
                <Link to="/reportar-maquina" className="report-card">
                    <h2>Reportar Estado de M√°quina y vehiculos</h2>
                    <p>Diligenciar el reporte pre-uso de su equipo.</p>
                </Link>
                <Link to="/reportar-seguridad" className="report-card">
                    <h2>Reportar Incidente / Condici√≥n</h2>
                    <p>Reportar actos, condiciones, incidentes o accidentes.</p>
                </Link>
            </div>
            
            <div className="historial-section">
                <h2>Historial de mis reportes enviados</h2>
                <div className="page-content-card">
                    {isLoading && <p>Cargando historial...</p>}
                    {error && <p className="error-message">{error}</p>}
                    {!isLoading && !error && (
                        <div className="table-wrapper">
                            <table className="data-table">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Tipo de Reporte</th>
                                        <th>Equipo / √Årea</th>
                                        <th>Estado (Revisi√≥n)</th>
                                        <th>Acci√≥n</th> {/* Columna Nueva */}
                                    </tr>
                                </thead>
                                <tbody>
                                    {misReportes.length === 0 ? (
                                        <tr><td colSpan="5" style={{textAlign: 'center'}}>No has enviado reportes.</td></tr>
                                    ) : (
                                        misReportes.slice(0, 10).map((rep) => (
                                            <tr key={rep.id}>
                                                <td>{formatearFecha(rep.fecha)}</td>
                                                <td>{rep.tipo}</td>
                                                <td>{rep.ref}</td>
                                                <td>
                                                    <span className={`status-pill ${rep.estado === 'Nuevo' ? 'status-pendiente' : 'status-inactivo'}`}>
                                                        {rep.estado}
                                                    </span>
                                                </td>
                                                <td>
                                                    <button 
                                                        className="btn btn-sm btn-secondary" 
                                                        onClick={() => abrirDetalle(rep)}
                                                    >
                                                        Ver Detalle
                                                    </button>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            </div>

            {/* Modal de Ver Reporte (Reutilizado) */}
            {modalVerAbierto && reporteSeleccionado && (
                <ModalVerReporte 
                    reporte={reporteSeleccionado} 
                    tipo={reporteSeleccionado.rawTipo} 
                    alCerrar={() => setModalVerAbierto(false)}
                    // No pasamos alExito porque el colaborador no cambia el estado
                />
            )}
        </div>
    );
};

// --- VISTA DEL ADMINISTRADOR (ACTUALIZADA CON GR√ÅFICA) ---
const DashboardAdmin = ({ usuario }) => {
    const [kpis, setKpis] = useState(null);
    const [actividades, setActividades] = useState([]);
    const [actividadesGrafica, setActividadesGrafica] = useState([]); // Nuevo Estado
    const [reportes, setReportes] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');

    const formatearFechaCorta = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        const fecha = new Date(fechaISO.split('T')[0] + 'T00:00:00');
        return fecha.toLocaleDateString('es-CO');
    };

    // Colores para la gr√°fica
    const COLORES_GRAFICA = {
        'Realizada': '#28a745',  // Verde
        'Pendiente': '#f0ad4e',  // Naranja
        'Cancelada': '#dc3545'   // Rojo
    };

    useEffect(() => {
        const cargarDashboard = async () => {
            try {
                setIsLoading(true);
                const [dataKPIs, dataActividades, dataActividadesEstado, dataReportes] = await Promise.all([
                    getAdminKPIs(),
                    getAdminActividadesPendientes(),
                    getAdminActividadesEstado(), // Cargar datos de la gr√°fica
                    getAdminReportesRecientes()
                ]);
                setKpis(dataKPIs);
                setActividades(dataActividades);
                setActividadesGrafica(dataActividadesEstado);
                setReportes(dataReportes);
            } catch (err) {
                console.error(err);
                setError('No se pudo cargar el dashboard.');
            } finally {
                setIsLoading(false);
            }
        };
        cargarDashboard();
    }, []);

    if (isLoading) return <div className="page-container"><p>Cargando dashboard...</p></div>;
    if (error) return <div className="page-container"><p className="error-message">{error}</p></div>;

    return (
        <div className="page-container">
            <div className="dashboard-admin-header">
                <h1>Bienvenido, {usuario.nombre}</h1>
            </div>

            {/* SECCI√ìN 1: KPIs */}
            {kpis && (
                <div className="kpi-grid">
                    <Link to="/inspecciones" className="kpi-card-link">
                        <div className="kpi-card kpi-inspecciones">
                            <h3>Inspecciones Realizadas</h3>
                            <div className="kpi-value">{kpis.InspeccionesRealizadas}</div>
                        </div>
                    </Link>
                    <Link to="/reportes" className="kpi-card-link">
                        <div className="kpi-card kpi-reportes-maq">
                            <h3>Reportes de Maquinaria</h3>
                            <div className="kpi-value">{kpis.ReportesMaquinaria}</div>
                        </div>
                    </Link>
                    <Link to="/reportes" className="kpi-card-link">
                        <div className="kpi-card kpi-reportes-seg">
                            <h3>Reportes de Seguridad</h3>
                            <div className="kpi-value">{kpis.ReportesSeguridad}</div>
                        </div>
                    </Link>
                    <Link to="/acpm" className="kpi-card-link">
                        <div className="kpi-card kpi-acpm">
                            <h3>Acciones Creadas (ACPM)</h3>
                            <div className="kpi-value">{kpis.AccionesCreadas}</div>
                        </div>
                    </Link>
                </div>
            )}

            {/* SECCI√ìN 2: GR√ÅFICA Y LISTAS */}
            <div className="dashboard-lists-grid" style={{ gridTemplateColumns: '1fr 1fr 1fr', gap: '1.5rem' }}>
                
                {/* 1. Gr√°fica de Estado de Actividades */}
                <div className="dashboard-list-card" style={{minHeight: '350px'}}>
                    <h2><Link to="/planificacion">Estado de Actividades</Link></h2>
                    <div style={{ width: '100%', height: 250 }}>
                        {actividadesGrafica.length === 0 ? (
                            <p style={{textAlign:'center', marginTop:'30%'}}>No hay datos de actividades.</p>
                        ) : (
                            <ResponsiveContainer>
                                <PieChart>
                                    <Pie
                                        data={actividadesGrafica}
                                        cx="50%"
                                        cy="50%"
                                        innerRadius={60}
                                        outerRadius={80}
                                        paddingAngle={5}
                                        dataKey="value"
                                    >
                                        {actividadesGrafica.map((entry, index) => (
                                            <Cell key={`cell-${index}`} fill={COLORES_GRAFICA[entry.name] || '#8884d8'} />
                                        ))}
                                    </Pie>
                                    <Tooltip />
                                    <Legend verticalAlign="bottom" height={36}/>
                                </PieChart>
                            </ResponsiveContainer>
                        )}
                    </div>
                </div>

                {/* 2. Lista de Actividades Pendientes */}
                <div className="dashboard-list-card">
                    <h2><Link to="/planificacion">Actividades Pendientes</Link></h2>
                    {actividades.length === 0 ? (
                        <p>¬°No hay actividades pendientes!</p>
                    ) : (
                        <ul style={{listStyle: 'none', padding: 0, margin: 0}}>
                            {actividades.map(act => (
                                <li key={act.ID_Actividad} className="dashboard-list-item">
                                    <span className="item-info">{act.NombreActividad}</span>
                                    <span className="item-date">{formatearFechaCorta(act.FechaLimite)}</span>
                                </li>
                            ))}
                        </ul>
                    )}
                </div>

                {/* 3. Lista de Reportes Recientes */}
                <div className="dashboard-list-card">
                    <h2><Link to="/reportes">Reportes Recientes</Link></h2>
                    {reportes.length === 0 ? (
                        <p>No hay reportes nuevos pendientes.</p>
                    ) : (
                        <ul style={{listStyle: 'none', padding: 0, margin: 0}}>
                            {reportes.map(rep => (
                                <li key={rep.ID} className="dashboard-list-item">
                                    <div>
                                        <span className="item-info">{rep.TipoReporte}</span>
                                        <small className="item-type" style={{display: 'block'}}>Ref: {rep.Referencia}</small>
                                    </div>
                                    <span className="item-date" style={{color: '#6c757d', fontWeight: 'normal'}}>
                                        {new Date(rep.FechaHoraReporte).toLocaleDateString()}
                                    </span>
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            </div>
        </div>
    );
};

const DashboardPage = () => {
    const { usuario } = useAuth();
    if (!usuario) return <div>Cargando...</div>; 
    
    return usuario.rol === 'Administrador SST' 
        ? <DashboardAdmin usuario={usuario} /> 
        : <DashboardColaborador usuario={usuario} />;
};

export default DashboardPage;


==================================================================
ARCHIVO: frontend\src\pages\DashboardSuperAdmin.jsx
==================================================================
// frontend/src/pages/DashboardSuperAdmin.jsx

import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import { apiFetch } from '../services/apiService'; 
// Importamos el servicio de la gr√°fica que creamos previamente
import { getAdminActividadesEstado } from '../services/dashboardService'; 
import { Link } from 'react-router-dom';
import '../style/DashboardAdmin.css'; 

// Iconos
import { 
    BsShieldLockFill, BsActivity, BsPeopleFill, 
    BsCheckCircleFill, BsExclamationOctagonFill, BsGraphUp, BsBellFill, BsPieChartFill
} from 'react-icons/bs';

// Gr√°ficas (A√±adimos PieChart y componentes necesarios)
import { 
    BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, 
    PieChart, Pie, Cell, Legend 
} from 'recharts';

const DashboardSuperAdmin = () => {
    const { usuario } = useAuth();
    
    // Estados
    const [data, setData] = useState(null); // Data general (KPIs, Barras, Logs)
    const [actividadesGrafica, setActividadesGrafica] = useState([]); // Data para la gr√°fica de pastel
    const [loading, setLoading] = useState(true);

    // Colores para la gr√°fica de pastel
    const COLORES_GRAFICA = {
        'Realizada': '#28a745',  // Verde
        'Pendiente': '#ffc107',  // Amarillo
        'Cancelada': '#dc3545'   // Rojo
    };

    // Cargar Datos
    useEffect(() => {
        const cargarDatos = async () => {
            try {
                // Hacemos las dos peticiones en paralelo
                const [respuestaGeneral, respuestaActividades] = await Promise.all([
                    apiFetch('/dashboard/super-admin'),
                    getAdminActividadesEstado()
                ]);

                setData(respuestaGeneral);
                setActividadesGrafica(respuestaActividades);

            } catch (error) {
                console.error(error);
            } finally {
                setLoading(false);
            }
        };
        cargarDatos();
    }, []);

    if (loading) return <div className="page-container"><p style={{padding:'2rem', textAlign:'center'}}>Cargando Centro de Comando...</p></div>;
    
    const { kpis, grafica, logs } = data;

    return (
        <div className="page-container">
            {/* --- HEADER --- */}
            <div className="dashboard-admin-header" style={{ borderBottom: '4px solid #f1c40f', paddingBottom: '1rem' }}>
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                    <div>
                        <h1 style={{display:'flex', alignItems:'center', gap:'10px'}}>
                            <BsShieldLockFill style={{color: '#f1c40f'}}/> Centro de Comando
                        </h1>
                        <p>Super Usuario: <strong>{usuario.nombre}</strong></p>
                    </div>
                    <div style={{textAlign:'right'}}>
                        <span className="status-pill status-activo">Sistema Operativo</span>
                    </div>
                </div>
            </div>

            {/* --- SECCI√ìN 1: KPIs GLOBALES --- */}
            <div className="kpi-grid">
                <div className="kpi-card">
                    <h3><BsPeopleFill style={{color:'#007BFF'}}/> Usuarios Totales</h3>
                    <div className="kpi-value">{kpis?.TotalUsuarios || 0}</div>
                </div>
                <div className="kpi-card">
                    <h3><BsCheckCircleFill style={{color:'#28a745'}}/> Inspecciones</h3>
                    <div className="kpi-value">{kpis?.TotalInspecciones || 0}</div>
                </div>
                <div className="kpi-card">
                    <h3><BsExclamationOctagonFill style={{color:'#dc3545'}}/> Reportes</h3>
                    <div className="kpi-value">{kpis?.TotalReportes || 0}</div>
                </div>
                <div className="kpi-card">
                    <h3><BsGraphUp style={{color:'#005A5B'}}/> ACPM Globales</h3>
                    <div className="kpi-value">{kpis?.TotalACPM || 0}</div>
                </div>
            </div>

            {/* --- SECCI√ìN 2: GR√ÅFICAS (GRID DE 2 COLUMNAS) --- */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(450px, 1fr))', gap: '1.5rem', marginBottom: '1.5rem' }}>
                
                {/* 1. GR√ÅFICA DE RENDIMIENTO (BARRAS) */}
                <div className="page-content-card">
                    <h2 style={{marginBottom: '1.5rem', display:'flex', alignItems:'center', gap:'10px', fontSize:'1.1rem'}}>
                        <BsActivity /> Rendimiento (√öltimos 7 d√≠as)
                    </h2>
                    <div style={{ width: '100%', height: 300 }}>
                        <ResponsiveContainer>
                            <BarChart data={grafica}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#eee" />
                                <XAxis dataKey="Dia" />
                                <YAxis />
                                <Tooltip 
                                    contentStyle={{borderRadius:'8px', border:'none', boxShadow:'0 2px 10px rgba(0,0,0,0.1)'}}
                                />
                                <Bar dataKey="CantidadAcciones" name="Eventos" fill="#005A5B" radius={[4, 4, 0, 0]} />
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                </div>

                {/* 2. GR√ÅFICA DE ACTIVIDADES (PASTEL) - NUEVA PARA SUPER ADMIN */}
                <div className="page-content-card">
                    <h2 style={{marginBottom: '1.5rem', display:'flex', alignItems:'center', gap:'10px', fontSize:'1.1rem'}}>
                        <BsPieChartFill /> Estado Global de Actividades
                    </h2>
                    <div style={{ width: '100%', height: 300, display:'flex', justifyContent:'center', alignItems:'center' }}>
                        {actividadesGrafica.length === 0 ? (
                            <p style={{color:'#999'}}>No hay actividades registradas.</p>
                        ) : (
                            <ResponsiveContainer width="100%" height="100%">
                                <PieChart>
                                    <Pie
                                        data={actividadesGrafica}
                                        cx="50%"
                                        cy="50%"
                                        innerRadius={70}
                                        outerRadius={100}
                                        paddingAngle={5}
                                        dataKey="value"
                                        label={({percent}) => `${(percent * 100).toFixed(0)}%`}
                                    >
                                        {actividadesGrafica.map((entry, index) => (
                                            <Cell key={`cell-${index}`} fill={COLORES_GRAFICA[entry.name] || '#8884d8'} />
                                        ))}
                                    </Pie>
                                    <Tooltip contentStyle={{borderRadius:'8px'}} />
                                    <Legend verticalAlign="bottom" height={36} iconType="circle"/>
                                </PieChart>
                            </ResponsiveContainer>
                        )}
                    </div>
                </div>

            </div>

            {/* --- SECCI√ìN 3: LOGS EN VIVO (Ancho Completo) --- */}
            <div className="page-content-card" style={{ marginBottom: '2rem' }}>
                <h2 style={{marginBottom: '1rem', display:'flex', alignItems:'center', gap:'10px', fontSize:'1.2rem'}}>
                    <BsBellFill style={{color:'#f1c40f'}} /> Auditor√≠a Reciente
                </h2>
                <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                    {logs.length === 0 ? (
                        <p style={{color:'#999', padding:'1rem'}}>No hay actividad reciente.</p>
                    ) : (
                        <table className="data-table" style={{fontSize:'0.9rem'}}>
                            <thead>
                                <tr>
                                    <th>Hora</th>
                                    <th>Usuario</th>
                                    <th>Acci√≥n</th>
                                    <th>Descripci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {logs.map(log => (
                                    <tr key={log.ID_Log}>
                                        <td style={{whiteSpace:'nowrap', color:'#666'}}>
                                            {new Date(log.FechaHora).toLocaleDateString()} {new Date(log.FechaHora).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                        </td>
                                        <td><strong>{log.NombreUsuario}</strong></td>
                                        <td><span className="status-pill status-proceso" style={{fontSize:'0.75rem'}}>{log.Accion}</span></td>
                                        <td>{log.Descripcion}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div>
                <div style={{textAlign:'center', marginTop:'1rem'}}>
                    <Link to="/logs" className="btn btn-secondary btn-sm">Ver Historial Completo</Link>
                </div>
            </div>

            {/* --- ACCESOS R√ÅPIDOS --- */}
            <h2 style={{fontSize: '1.2rem', marginBottom: '1rem', color: '#666'}}>Panel de Control</h2>
            <div className="kpi-grid" style={{ gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))' }}>
                <Link to="/usuarios" className="kpi-card-link">
                    <div className="kpi-card" style={{ borderLeft: '4px solid #007BFF', padding:'1rem' }}>
                        <h4 style={{margin:0, color:'#007BFF'}}>Gesti√≥n de Usuarios</h4>
                        <small style={{color:'#666'}}>Permisos y Roles</small>
                    </div>
                </Link>
                <Link to="/logs" className="kpi-card-link">
                    <div className="kpi-card" style={{ borderLeft: '4px solid #f1c40f', padding:'1rem' }}>
                        <h4 style={{margin:0, color:'#f1c40f'}}>Auditor√≠a Total</h4>
                        <small style={{color:'#666'}}>Traza de seguridad</small>
                    </div>
                </Link>
                <Link to="/super-admin/formularios" className="kpi-card-link">
                    <div className="kpi-card" style={{ borderLeft: '4px solid #28a745', padding:'1rem' }}>
                        <h4 style={{margin:0, color:'#28a745'}}>Formularios</h4>
                        <small style={{color:'#666'}}>Dise√±ador de Inspecciones</small>
                    </div>
                </Link>
            </div>
        </div>
    );
};

export default DashboardSuperAdmin;


==================================================================
ARCHIVO: frontend\src\pages\DirectorioExternoPage.jsx
==================================================================
// frontend/src/pages/DirectorioExternoPage.jsx

import React, { useState, useEffect } from 'react';
import { buscarUsuarioExterno } from '../services/userService';
import '../index.css';
// Importamos iconos
import { 
    BsSearch, BsBuilding, BsPersonBadge, BsEnvelope, 
    BsBriefcaseFill, BsFolderPlus, BsCalendarEvent, BsDot 
} from 'react-icons/bs';
// IMPORTAMOS EL MODAL DE DOCUMENTOS
import ModalGestionarDocs from '../components/ModalGestionarDocs';

const DirectorioExternoPage = () => {
    const [empleados, setEmpleados] = useState([]);
    const [busqueda, setBusqueda] = useState('');
    const [isLoading, setIsLoading] = useState(true);
    
    // Estado para controlar qu√© colaborador se est√° gestionando
    const [colaboradorDocs, setColaboradorDocs] = useState(null);

    useEffect(() => {
        const cargarDatos = async () => {
            setIsLoading(true);
            try {
                const data = await buscarUsuarioExterno(busqueda);
                setEmpleados(data);
            } catch (error) {
                console.error("Error cargando directorio:", error);
            } finally {
                setIsLoading(false);
            }
        };

        const delayDebounce = setTimeout(() => {
            cargarDatos();
        }, 500);

        return () => clearTimeout(delayDebounce);
    }, [busqueda]);

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>Directorio de Colaboradores</h1>
            </div>

            {/* BARRA DE B√öSQUEDA */}
            <div className="filters-bar" style={{marginBottom: '1.5rem'}}>
                <div className="search-input-container" style={{maxWidth: '400px', position: 'relative'}}>
                    <BsSearch style={{ position: 'absolute', left: '15px', top: '50%', transform: 'translateY(-50%)', color: '#aaa' }} />
                    <input 
                        type="text" 
                        className="form-control" 
                        placeholder="Buscar por nombre o c√©dula..." 
                        style={{ paddingLeft: '40px', height: '45px', borderRadius: '50px' }}
                        value={busqueda}
                        onChange={(e) => setBusqueda(e.target.value)}
                        autoFocus
                    />
                </div>
            </div>

            {/* CONTENIDO PRINCIPAL */}
            <div className="page-content-card">
                <div className="table-wrapper">
                    {isLoading ? (
                        <p style={{padding:'3rem', textAlign:'center', color:'#666'}}>Cargando directorio de Gosen...</p>
                    ) : (
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Colaborador</th>
                                    <th>Identificaci√≥n</th>
                                    <th>Cargo (Oficio)</th>
                                    <th>Centro de Costos</th>
                                    <th>Estado / Fecha</th> 
                                    <th>Gesti√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {empleados.length === 0 ? (
                                    <tr><td colSpan="6" style={{textAlign:'center', padding:'2rem', color:'#999'}}>No se encontraron colaboradores.</td></tr>
                                ) : (
                                    empleados.map((emp, idx) => (
                                        <tr key={idx} style={{opacity: emp.Estado === 'Inactivo' ? 0.7 : 1}}>
                                            {/* 1. NOMBRE */}
                                            <td>
                                                <div style={{fontWeight:'bold', color:'#005A5B', fontSize:'0.95rem'}}>
                                                    {emp.Nombre}
                                                </div>
                                                {emp.Email && emp.Email !== 'No registrado' && (
                                                    <div style={{fontSize:'0.75rem', color:'#666', display:'flex', alignItems:'center'}}>
                                                        <BsEnvelope style={{marginRight:'4px'}}/> {emp.Email}
                                                    </div>
                                                )}
                                            </td>

                                            {/* 2. C√âDULA */}
                                            <td>
                                                <div style={{display:'flex', alignItems:'center', gap:'6px', color:'#333'}}>
                                                    <BsPersonBadge style={{color:'#6c757d'}}/> 
                                                    {emp.Cedula}
                                                </div>
                                            </td>
                                            
                                            {/* 3. CARGO */}
                                            <td>
                                                <div style={{
                                                    display:'flex', alignItems:'center', gap:'6px', 
                                                    fontWeight:'600', color:'#495057', backgroundColor:'#f1f3f5', 
                                                    padding:'5px 10px', borderRadius:'6px', width:'fit-content', fontSize:'0.85rem'
                                                }}>
                                                    <BsBriefcaseFill style={{color:'#007BFF'}}/> 
                                                    {emp.Cargo}
                                                </div>
                                            </td>

                                            {/* 4. CENTRO DE COSTOS */}
                                            <td>
                                                <div style={{display:'flex', alignItems:'center', gap:'6px', color:'#666', fontSize:'0.9rem'}}>
                                                    <BsBuilding /> {emp.Area}
                                                </div>
                                            </td>

                                            {/* 5. ESTADO Y FECHA */}
                                            <td>
                                                <div style={{display:'flex', flexDirection:'column', gap:'4px'}}>
                                                    <span 
                                                        className={`status-pill ${emp.Estado === 'Activo' ? 'status-activo' : 'status-inactivo'}`}
                                                        style={{width: 'fit-content', fontSize:'0.75rem'}}
                                                    >
                                                        <BsDot style={{fontSize:'1.2rem', marginLeft:'-5px'}}/>
                                                        {emp.Estado}
                                                    </span>
                                                    
                                                    <div style={{fontSize:'0.8rem', color:'#555', display:'flex', alignItems:'center', gap:'5px'}}>
                                                        <BsCalendarEvent style={{color:'#6c757d'}}/> 
                                                        {emp.FechaRelevante}
                                                    </div>
                                                </div>
                                            </td>

                                            {/* 6. BOT√ìN DE DOCUMENTOS */}
                                            <td>
                                                <button 
                                                    className="btn btn-sm btn-secondary" 
                                                    onClick={() => setColaboradorDocs(emp)} 
                                                    title="Gestionar Documentos Adjuntos"
                                                    style={{display:'flex', alignItems:'center', gap:'5px'}}
                                                >
                                                    <BsFolderPlus /> Docs
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    )}
                </div>
                
                <div style={{marginTop:'1.5rem', fontSize:'0.75rem', color:'#888', textAlign:'center', borderTop:'1px solid #eee', paddingTop:'10px'}}>
                    Informaci√≥n sincronizada en tiempo real con la Base de Datos de N√≥mina.
                </div>
            </div>

            {/* RENDERIZADO DEL MODAL */}
            {colaboradorDocs && (
                <ModalGestionarDocs 
                    colaborador={colaboradorDocs} 
                    alCerrar={() => setColaboradorDocs(null)} 
                />
            )}
        </div>
    );
};

export default DirectorioExternoPage;


==================================================================
ARCHIVO: frontend\src\pages\DocumentosPage.jsx
==================================================================
// frontend/src/pages/DocumentosPage.jsx

import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { 
    getContenidoCarpeta, 
    descargarDocumento, 
    eliminarDocumento, 
    eliminarCarpeta 
} from '../services/documentService';
import { 
    BsFolderFill, BsFileEarmarkTextFill, BsFileEarmarkPdfFill, 
    BsFileEarmarkWordFill, BsFileEarmarkExcelFill, BsFileEarmarkZipFill, 
    BsPlusLg, BsUpload, BsDownload, BsTrash, BsSearch, BsChevronRight, BsCloudUpload, BsGrid
} from 'react-icons/bs';
import '../index.css'; 
import '../style/DocumentosPage.css'; 
import Swal from 'sweetalert2';

import ModalCrearCarpeta from '../components/ModalCrearCarpeta';
import ModalSubirArchivo from '../components/ModalSubirArchivo';
import ModalConfirmarAccion from '../components/ModalConfirmarAccion';
import ModalVerDocumento from '../components/ModalVerDocumento';

// Helper para obtener el icono de archivo con colores
const getIconoArchivo = (tipo) => {
    // Normalizamos para evitar errores si tipo es null
    const t = (tipo || '').toLowerCase();
    if (t.includes('pdf')) return <BsFileEarmarkPdfFill style={{ color: '#E53E3E' }} />;
    if (t.includes('word') || t.includes('officedocument.word')) return <BsFileEarmarkWordFill style={{ color: '#2B579A' }} />;
    if (t.includes('excel') || t.includes('spreadsheet')) return <BsFileEarmarkExcelFill style={{ color: '#1D6F42' }} />;
    if (t.includes('xml') || t.includes('text')) return <BsFileEarmarkTextFill style={{ color: '#6c757d' }} />;
    if (t.includes('zip') || t.includes('rar')) return <BsFileEarmarkZipFill style={{ color: '#F9A825' }} />;
    return <BsFileEarmarkTextFill className="icon-file" style={{ color: '#adb5bd' }} />;
};

const DocumentosPage = () => {
    // --- Estados ---
    const [carpetas, setCarpetas] = useState([]);
    const [archivos, setArchivos] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);
    const [ruta, setRuta] = useState([{ id: 1, nombre: 'Documentos Ra√≠z' }]);
    const carpetaActualId = ruta[ruta.length - 1].id;
    
    // Estado para b√∫squeda local
    const [busquedaLocal, setBusquedaLocal] = useState('');

    // --- Estados de Modales ---
    const [modalCarpetaAbierto, setModalCarpetaAbierto] = useState(false);
    const [modalSubirAbierto, setModalSubirAbierto] = useState(false);
    const [modalConfirmarAbierto, setModalConfirmarAbierto] = useState(false);
    const [modalVerAbierto, setModalVerAbierto] = useState(false);
    
    // --- Estados de Contexto ---
    const [isDownloading, setIsDownloading] = useState(null);
    const [itemParaEliminar, setItemParaEliminar] = useState(null); 
    const [archivoParaVer, setArchivoParaVer] = useState(null);

    // --- Funci√≥n de Carga de Contenido ---
    const cargarContenido = useCallback(async (id) => {
        try {
            setIsLoading(true);
            const data = await getContenidoCarpeta(id);
            setCarpetas(data.carpetas);
            setArchivos(data.archivos);
            setError(null);
        } catch (err) { 
            setError(err.message); 
        } finally { 
            setIsLoading(false); 
        }
    }, []); 

    useEffect(() => {
        cargarContenido(carpetaActualId);
        setBusquedaLocal(''); // Limpiar b√∫squeda al cambiar de carpeta
    }, [carpetaActualId, cargarContenido]);

    // --- Filtrado Local ---
    const contenidoFiltrado = useMemo(() => {
        const texto = busquedaLocal.toLowerCase();
        const folders = carpetas.filter(c => c.Nombre.toLowerCase().includes(texto));
        const files = archivos.filter(f => f.Nombre.toLowerCase().includes(texto));
        return { folders, files };
    }, [carpetas, archivos, busquedaLocal]);

    // --- Manejadores de Navegaci√≥n ---
    const navegarA = (carpeta) => setRuta([...ruta, carpeta]);
    const navegarAIndex = (index) => setRuta(ruta.slice(0, index + 1));

    // --- Manejadores de Modales ---
    const handleRecargar = () => {
        setModalCarpetaAbierto(false);
        setModalSubirAbierto(false);
        setModalConfirmarAbierto(false);
        setItemParaEliminar(null);
        cargarContenido(carpetaActualId); 
    };
    
    const handleDescargar = async (id, nombreOriginal) => {
        setIsDownloading(id); 
        try { 
            await descargarDocumento(id, nombreOriginal); 
        } catch (err) { 
            console.error(err);
            Swal.fire('Error', err.message, 'error');
        } 
        finally { setIsDownloading(null); }
    };

    const abrirModalEliminar = (item, tipo) => { setItemParaEliminar({ ...item, tipo }); setModalConfirmarAbierto(true); };
    
    const handleConfirmarEliminar = async () => {
        if (!itemParaEliminar) return;
        // eslint-disable-next-line no-useless-catch
        try {
            if (itemParaEliminar.tipo === 'Carpeta') { await eliminarCarpeta(itemParaEliminar.ID); } 
            else if (itemParaEliminar.tipo === 'Documento') { await eliminarDocumento(itemParaEliminar.ID); }
            handleRecargar(); 
        } catch (err) { throw err; }
    };
    
    const abrirModalVer = (archivo) => {
        setArchivoParaVer(archivo);
        setModalVerAbierto(true);
    };
    const cerrarModalVer = () => {
        setModalVerAbierto(false);
        setArchivoParaVer(null);
    };

    const formatBytes = (bytes) => {
        if (!bytes || bytes === 0) return '0 KB';
        if (bytes > 1024) return `${(bytes / 1024).toFixed(2)} MB`;
        return `${Math.round(bytes)} KB`;
    };

    const formatearFecha = (fecha) => {
        if (!fecha) return '--';
        return new Date(fecha).toLocaleDateString('es-CO');
    };

    return (
        <div className="page-container">
            {/* --- Encabezado --- */}
            <div className="page-header">
                <h1>Gesti√≥n Documental</h1>
                <div className="header-actions">
                    <button className="btn btn-secondary" onClick={() => setModalCarpetaAbierto(true)}>
                        <BsPlusLg /> Nueva Carpeta
                    </button>
                    <button className="btn btn-primary" onClick={() => setModalSubirAbierto(true)}>
                        <BsUpload /> Subir Archivos
                    </button>
                </div>
            </div>

            {/* --- Barra de Herramientas (NUEVA) --- */}
            <div className="docs-toolbar">
                
                {/* Breadcrumbs Estilo C√°psula */}
                <div className="document-breadcrumb">
                    {ruta.map((p, index) => (
                        <React.Fragment key={p.id}>
                            <div 
                                className={`breadcrumb-item ${index === ruta.length - 1 ? 'active' : ''}`}
                                onClick={() => index < ruta.length - 1 && navegarAIndex(index)}
                            >
                                {index === 0 ? <BsGrid /> : <BsFolderFill />} 
                                {p.nombre}
                            </div>
                            {index < ruta.length - 1 && <BsChevronRight className="breadcrumb-separator"/>}
                        </React.Fragment>
                    ))}
                </div>

                {/* Buscador Local */}
                <div className="docs-search">
                    <BsSearch />
                    <input 
                        type="text" 
                        placeholder="Filtrar en esta carpeta..." 
                        value={busquedaLocal}
                        onChange={(e) => setBusquedaLocal(e.target.value)}
                    />
                </div>
            </div>

            {/* --- Listado de Contenido --- */}
            <div className="page-content-card" style={{padding: '1.5rem'}}>
                {isLoading && <p>Cargando contenido...</p>}
                {error && <p className="error-message">Error: {error}</p>}
                
                {!isLoading && !error && (
                    <>
                        {/* Encabezados de Columna (Desktop) */}
                        {(contenidoFiltrado.folders.length > 0 || contenidoFiltrado.files.length > 0) && (
                            <div className="document-list-header">
                                <span>Tipo</span>
                                <span>Nombre</span>
                                <span>Fecha</span>
                                <span>Tama√±o</span>
                                <span style={{textAlign: 'right'}}>Acciones</span>
                            </div>
                        )}

                        <div className="document-list-container">
                            
                            {/* Carpetas */}
                            {contenidoFiltrado.folders.map(carpeta => (
                                <div key={`c-${carpeta.ID}`} className="document-row">
                                    <div className="doc-icon-wrapper">
                                        <BsFolderFill style={{ color: '#FFC107' }} />
                                    </div>
                                    <div className="doc-info-main">
                                        <span className="doc-name" onClick={() => navegarA({ id: carpeta.ID, nombre: carpeta.Nombre })}>
                                            {carpeta.Nombre}
                                        </span>
                                        <span className="doc-meta-mobile">{formatearFecha(carpeta.FechaCreacion)}</span>
                                    </div>
                                    <div className="doc-date">{formatearFecha(carpeta.FechaCreacion)}</div>
                                    <div className="doc-size">--</div>
                                    <div className="doc-actions">
                                        <button className="btn btn-icon btn-danger" onClick={() => abrirModalEliminar(carpeta, 'Carpeta')} title="Eliminar Carpeta">
                                            <BsTrash />
                                        </button>
                                    </div>
                                </div>
                            ))}

                            {/* Archivos */}
                            {contenidoFiltrado.files.map(archivo => (
                                <div key={`f-${archivo.ID}`} className="document-row">
                                    <div className="doc-icon-wrapper">
                                        {getIconoArchivo(archivo.TipoArchivo)}
                                    </div>
                                    <div className="doc-info-main">
                                        <span className="doc-name" onClick={() => abrirModalVer(archivo)}>
                                            {archivo.Nombre}
                                        </span>
                                        <span className="doc-meta-mobile">
                                            {formatBytes(archivo.TamanoArchivoKB)} ‚Ä¢ {formatearFecha(archivo.FechaCreacion)}
                                        </span>
                                    </div>
                                    <div className="doc-date">{formatearFecha(archivo.FechaCreacion)}</div>
                                    <div className="doc-size">{formatBytes(archivo.TamanoArchivoKB)}</div>
                                    <div className="doc-actions">
                                        <button 
                                            className="btn btn-icon btn-secondary" 
                                            onClick={() => handleDescargar(archivo.ID, archivo.Nombre)} 
                                            disabled={isDownloading === archivo.ID}
                                            title="Descargar"
                                        >
                                            <BsDownload />
                                        </button>
                                        <button 
                                            className="btn btn-icon btn-danger" 
                                            onClick={() => abrirModalEliminar(archivo, 'Documento')}
                                            title="Eliminar Archivo"
                                        >
                                            <BsTrash />
                                        </button>
                                    </div>
                                </div>
                            ))}

                            {/* Estado Vac√≠o */}
                            {contenidoFiltrado.folders.length === 0 && contenidoFiltrado.files.length === 0 && (
                                <div className="empty-state-docs">
                                    <BsCloudUpload className="empty-icon" />
                                    <h3>Carpeta Vac√≠a</h3>
                                    <p>Usa los botones superiores para crear carpetas o subir archivos.</p>
                                </div>
                            )}
                        </div>
                    </>
                )}
            </div>
            
            {/* --- Renderizado de Modales --- */}
            {modalCarpetaAbierto && ( <ModalCrearCarpeta idCarpetaPadre={carpetaActualId} alCerrar={() => setModalCarpetaAbierto(false)} alExito={handleRecargar} /> )}
            {modalSubirAbierto && ( <ModalSubirArchivo idCarpetaDestino={carpetaActualId} alCerrar={() => setModalSubirAbierto(false)} alExito={handleRecargar} /> )}
            {modalConfirmarAbierto && ( 
                <ModalConfirmarAccion 
                    titulo={`Eliminar ${itemParaEliminar?.tipo}`} 
                    mensaje={`¬øEst√°s seguro de que deseas eliminar "${itemParaEliminar?.Nombre}"?`} 
                    enConfirmar={handleConfirmarEliminar} 
                    alCerrar={() => { setModalConfirmarAbierto(false); setItemParaEliminar(null); }} 
                    textoBotonConfirmar="Eliminar" 
                    claseBoton="btn-danger" 
                /> 
            )}
            
            {modalVerAbierto && (
                <ModalVerDocumento
                    archivo={archivoParaVer}
                    alCerrar={cerrarModalVer}
                />
            )}
        </div>
    );
};

export default DocumentosPage;


==================================================================
ARCHIVO: frontend\src\pages\GestionFormulariosPage.jsx
==================================================================
// frontend/src/pages/GestionFormulariosPage.jsx

import React, { useState, useEffect, useMemo } from 'react';
import { 
    getFormularios, 
    getPreguntasFormulario, 
    agregarPregunta, 
    eliminarPregunta, 
    toggleVisibilidadFormulario,
    eliminarFormulario 
} from '../services/inspectionService';
import '../index.css'; // Aseg√∫rate de que los estilos nuevos est√°n aqu√≠
import Swal from 'sweetalert2';
import { 
    BsPencilSquare, BsPlusCircleFill, BsTrashFill, BsListCheck, 
    BsArrowLeft, BsFileEarmarkPlus, BsToggleOn, BsToggleOff, 
    BsTrash, BsPencil, BsSearch, BsUiChecksGrid, BsFolder2Open 
} from 'react-icons/bs';
import { Link } from 'react-router-dom';
import ModalCrearFormulario from '../components/ModalCrearFormulario';

const GestionFormulariosPage = () => {
    // --- Estados ---
    const [formularios, setFormularios] = useState([]);
    const [busquedaForm, setBusquedaForm] = useState('');
    const [formularioSeleccionado, setFormularioSeleccionado] = useState(null);
    const [preguntas, setPreguntas] = useState([]);
    const [nuevaPregunta, setNuevaPregunta] = useState('');
    const [isLoading, setIsLoading] = useState(true);
    const [isLoadingPreguntas, setIsLoadingPreguntas] = useState(false);
    
    // --- Modales ---
    const [modalCrearAbierto, setModalCrearAbierto] = useState(false);
    const [formularioParaEditar, setFormularioParaEditar] = useState(null);

    // --- Carga Inicial ---
    useEffect(() => {
        cargarFormularios();
    }, []);

    const cargarFormularios = async () => {
        setIsLoading(true);
        try {
            const data = await getFormularios();
            setFormularios(data);
            
            // Mantener selecci√≥n si refrescamos
            if (formularioSeleccionado) {
                const aunExiste = data.find(f => f.ID_Formulario === formularioSeleccionado.ID_Formulario);
                if (!aunExiste) {
                    setFormularioSeleccionado(null);
                    setPreguntas([]);
                } else {
                    setFormularioSeleccionado(aunExiste);
                }
            }
        } catch (error) {
            console.error(error);
        } finally {
            setIsLoading(false);
        }
    };

    // --- Filtro de B√∫squeda ---
    const formulariosFiltrados = useMemo(() => {
        return formularios.filter(f => 
            f.NombreFormulario.toLowerCase().includes(busquedaForm.toLowerCase()) ||
            f.TipoActivoAsociado.toLowerCase().includes(busquedaForm.toLowerCase())
        );
    }, [formularios, busquedaForm]);

    // --- Selecci√≥n de Formulario ---
    const handleSeleccionar = async (form) => {
        setFormularioSeleccionado(form);
        setNuevaPregunta('');
        setIsLoadingPreguntas(true);
        try {
            const data = await getPreguntasFormulario(form.ID_Formulario);
            setPreguntas(data || []); 
        } catch (error) {
            console.error(error);
        } finally {
            setIsLoadingPreguntas(false);
        }
    };

    // --- Acciones del Formulario ---
    const abrirModalCrear = () => {
        setFormularioParaEditar(null);
        setModalCrearAbierto(true);
    };

    const abrirModalEditar = (e) => {
        if (e) e.stopPropagation(); // Evitar clicks fantasma
        setFormularioParaEditar(formularioSeleccionado);
        setModalCrearAbierto(true);
    };

    const handleFormularioGuardado = () => {
        setModalCrearAbierto(false);
        cargarFormularios();
    };

    const handleToggleVisibilidad = async () => {
        if (!formularioSeleccionado) return;
        const nuevoEstado = !formularioSeleccionado.VisibleColaborador;
        try {
            await toggleVisibilidadFormulario(formularioSeleccionado.ID_Formulario, nuevoEstado);
            // Actualizar localmente
            const formActualizado = { ...formularioSeleccionado, VisibleColaborador: nuevoEstado };
            setFormularioSeleccionado(formActualizado);
            setFormularios(prev => prev.map(f => f.ID_Formulario === formActualizado.ID_Formulario ? formActualizado : f));
            
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
            Toast.fire({ 
                icon: nuevoEstado ? 'success' : 'info', 
                title: nuevoEstado ? 'Visible para Colaborador' : 'Oculto para Colaborador' 
            });
        // eslint-disable-next-line no-unused-vars
        } catch (error) { 
            Swal.fire('Error', 'No se pudo cambiar la visibilidad', 'error'); 
        }
    };

    const handleEliminarFormularioActual = async () => {
        if (!formularioSeleccionado) return;
        const result = await Swal.fire({
            title: '¬øEliminar Formulario?',
            text: `Se eliminar√° "${formularioSeleccionado.NombreFormulario}".`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d9534f',
            confirmButtonText: 'S√≠, eliminar'
        });

        if (result.isConfirmed) {
            try {
                await eliminarFormulario(formularioSeleccionado.ID_Formulario);
                Swal.fire('Eliminado', 'Formulario inactivado.', 'success');
                setFormularioSeleccionado(null);
                cargarFormularios();
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        }
    };

    // --- Acciones de Preguntas ---
    const handleAgregarPregunta = async (e) => {
        e.preventDefault();
        if (!nuevaPregunta.trim()) return;
        try {
            await agregarPregunta(formularioSeleccionado.ID_Formulario, nuevaPregunta);
            const data = await getPreguntasFormulario(formularioSeleccionado.ID_Formulario);
            setPreguntas(data);
            setNuevaPregunta('');
        } catch (error) { Swal.fire('Error', error.message, 'error'); }
    };

    const handleEliminarPregunta = async (id) => {
        try {
            await eliminarPregunta(id);
            const data = await getPreguntasFormulario(formularioSeleccionado.ID_Formulario);
            setPreguntas(data);
        } catch (error) { Swal.fire('Error', error.message, 'error'); }
    };

    // --- RENDERIZADO ---
    return (
        <div className="page-container" style={{height: '100vh', display:'flex', flexDirection:'column', overflow:'hidden'}}>
            
            {/* HEADER DE LA P√ÅGINA */}
            <div className="page-header" style={{ paddingBottom: '1rem', flexShrink: 0 }}>
                <h1>Gestor de Formularios</h1>
                <div style={{ display: 'flex', gap: '10px' }}>
                    <Link to="/super-admin/dashboard" className="btn btn-secondary"><BsArrowLeft /> Volver</Link>
                    <button className="btn btn-primary" onClick={abrirModalCrear}><BsFileEarmarkPlus /> Crear Nuevo</button>
                </div>
            </div>

            {/* CONTENEDOR DIVIDIDO (SPLIT VIEW) */}
            <div className="split-layout-container">
                
                {/* === PANEL IZQUIERDO: LISTA === */}
                <div className="split-sidebar">
                    {/* Buscador */}
                    <div className="sidebar-search-box">
                        <div className="search-input-container" style={{width:'100%'}}>
                            <BsSearch style={{position:'absolute', left:'15px', top:'50%', transform:'translateY(-50%)', color:'#999'}}/>
                            <input 
                                type="text" 
                                className="form-control" 
                                placeholder="Buscar formulario..." 
                                style={{paddingLeft:'35px', borderRadius:'20px'}}
                                value={busquedaForm}
                                onChange={e => setBusquedaForm(e.target.value)}
                            />
                        </div>
                    </div>

                    {/* Lista de Items */}
                    <div className="sidebar-list">
                        {isLoading ? <p style={{padding:'1rem', textAlign:'center'}}>Cargando...</p> : (
                            <>
                                {formulariosFiltrados.map(form => (
                                    <div 
                                        key={form.ID_Formulario}
                                        onClick={() => handleSeleccionar(form)}
                                        className={`form-item ${formularioSeleccionado?.ID_Formulario === form.ID_Formulario ? 'active' : ''}`}
                                    >
                                        <div className="form-item-title">{form.NombreFormulario}</div>
                                        <div className="form-item-subtitle">
                                            <span>{form.TipoActivoAsociado}</span>
                                            {form.VisibleColaborador ? 
                                                <span style={{color:'#28a745', fontSize:'0.7rem'}}>Visible</span> : 
                                                <span style={{color:'#ccc', fontSize:'0.7rem'}}>Oculto</span>
                                            }
                                        </div>
                                    </div>
                                ))}
                                {formulariosFiltrados.length === 0 && <div style={{padding:'1rem', textAlign:'center', color:'#999'}}>No se encontraron formularios.</div>}
                            </>
                        )}
                    </div>
                </div>

                {/* === PANEL DERECHO: EDITOR === */}
                <div className="split-content">
                    {!formularioSeleccionado ? (
                        <div className="empty-placeholder">
                            <BsUiChecksGrid />
                            <h3>Selecciona un Formulario</h3>
                            <p>Elige un formulario de la lista izquierda para ver sus preguntas.</p>
                        </div>
                    ) : (
                        <>
                            {/* 1. Cabecera del Formulario */}
                            <div className="editor-header">
                                <div>
                                    <h2 style={{margin:'0 0 5px 0', color:'var(--color-primario)'}}>{formularioSeleccionado.NombreFormulario}</h2>
                                    <div style={{display:'flex', gap:'15px', fontSize:'0.9rem', color:'#666'}}>
                                        <span>ID: <strong>{formularioSeleccionado.ID_Formulario}</strong></span>
                                        <span>Categor√≠a: <strong>{formularioSeleccionado.Categoria}</strong></span>
                                    </div>
                                    <p style={{margin:'5px 0 0 0', fontSize:'0.9rem', fontStyle:'italic', color:'#888'}}>
                                        {formularioSeleccionado.Descripcion || 'Sin descripci√≥n'}
                                    </p>
                                </div>

                                {/* Barra de Herramientas */}
                                <div style={{display:'flex', gap:'10px'}}>
                                    <button 
                                        className="btn" 
                                        onClick={handleToggleVisibilidad}
                                        title={formularioSeleccionado.VisibleColaborador ? "Ocultar" : "Hacer Visible"}
                                        style={{backgroundColor:'#fff', border:'1px solid #dee2e6', color: formularioSeleccionado.VisibleColaborador ? '#28a745' : '#999'}}
                                    >
                                        {formularioSeleccionado.VisibleColaborador ? <BsToggleOn size={22}/> : <BsToggleOff size={22}/>}
                                    </button>
                                    <button className="btn" onClick={abrirModalEditar} style={{backgroundColor:'#fff', border:'1px solid #dee2e6', color:'#f0ad4e'}} title="Editar Datos">
                                        <BsPencil size={18}/>
                                    </button>
                                    <button className="btn" onClick={handleEliminarFormularioActual} style={{backgroundColor:'#fff', border:'1px solid #dee2e6', color:'#d9534f'}} title="Eliminar Formulario">
                                        <BsTrash size={18}/>
                                    </button>
                                </div>
                            </div>

                            {/* 2. Cuerpo (Lista de Preguntas) */}
                            <div className="editor-body">
                                <h4 style={{marginTop:0, marginBottom:'1rem', color:'#666', borderBottom:'1px solid #eee', paddingBottom:'5px'}}>
                                    Preguntas del Checklist ({preguntas.length})
                                </h4>

                                {isLoadingPreguntas ? <p>Cargando preguntas...</p> : (
                                    <>
                                        {preguntas.length === 0 ? (
                                            <div style={{textAlign:'center', padding:'2rem', color:'#999', border:'2px dashed #e0e0e0', borderRadius:'8px'}}>
                                                <BsFolder2Open style={{fontSize:'2rem', marginBottom:'10px'}} />
                                                <p>Este formulario no tiene preguntas. Agrega la primera abajo.</p>
                                            </div>
                                        ) : (
                                            <div style={{display:'flex', flexDirection:'column'}}>
                                                {preguntas.map((p, index) => (
                                                    <div key={p.ID_Pregunta} className="question-block">
                                                        <div className="q-number">{index + 1}</div>
                                                        <div className="q-text">{p.TextoPregunta}</div>
                                                        <button 
                                                            onClick={() => handleEliminarPregunta(p.ID_Pregunta)}
                                                            style={{background:'none', border:'none', color:'#d9534f', cursor:'pointer', padding:'5px'}}
                                                            title="Eliminar pregunta"
                                                        >
                                                            <BsTrashFill size={16}/>
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>

                            {/* 3. Footer (Agregar Pregunta) */}
                            <div className="editor-footer">
                                <form onSubmit={handleAgregarPregunta} style={{ display: 'flex', gap: '10px' }}>
                                    <input 
                                        type="text" 
                                        className="form-control" 
                                        placeholder="Escribe una nueva pregunta aqu√≠..." 
                                        value={nuevaPregunta} 
                                        onChange={(e) => setNuevaPregunta(e.target.value)} 
                                        style={{ flex: 1 }} 
                                        autoFocus
                                    />
                                    <button type="submit" className="btn btn-primary" disabled={!nuevaPregunta.trim()}>
                                        <BsPlusCircleFill /> Agregar
                                    </button>
                                </form>
                            </div>
                        </>
                    )}
                </div>
            </div>

            {modalCrearAbierto && (
                <ModalCrearFormulario 
                    formularioEditar={formularioParaEditar} 
                    alCerrar={() => setModalCrearAbierto(false)}
                    alExito={handleFormularioGuardado}
                />
            )}
        </div>
    );
};

export default GestionFormulariosPage;


==================================================================
ARCHIVO: frontend\src\pages\HistorialPage.jsx
==================================================================
// frontend/src/pages/HistorialPage.jsx

import React, { useState, useEffect, useMemo } from 'react';
import { getColaboradores, buscarUsuarioExterno } from '../services/userService'; 
import { getActivosTodos } from '../services/assetService';
import { getHistorialColaborador, getHistorialActivo } from '../services/historyService';
import '../index.css';
import { 
    BsPersonBadge, BsTruck, BsSearch, BsClockHistory, 
    BsFileEarmarkMedical, BsFileText, BsConeStriped, BsTools, BsClipboardCheck, 
    BsPersonVcard, BsLaptop
} from 'react-icons/bs';

const HistorialPage = () => {
    const [activeTab, setActiveTab] = useState('colaboradores'); // 'colaboradores' | 'activos'
    const [lista, setLista] = useState([]);
    const [busqueda, setBusqueda] = useState('');
    const [seleccionado, setSeleccionado] = useState(null);
    const [historial, setHistorial] = useState([]);
    
    // Estados de carga
    const [isLoadingList, setIsLoadingList] = useState(false);
    const [isLoadingHistory, setIsLoadingHistory] = useState(false);

    // Cargar listas iniciales al cambiar de pesta√±a
    useEffect(() => {
        setLista([]);
        setSeleccionado(null);
        setHistorial([]);
        setBusqueda('');
        
        if (activeTab === 'activos') {
            cargarActivos();
        } else {
            // Cargar colaboradores locales al inicio
            cargarColaboradoresLocales();
        }
    }, [activeTab]);

    // --- CARGA DE COLABORADORES (H√çBRIDA: LOCAL + EXTERNA) ---
    const cargarColaboradoresLocales = async () => {
        setIsLoadingList(true);
        try {
            const dataLocales = await getColaboradores();
            // Formateamos para unificar estructura
            const localesFormateados = dataLocales.map(u => ({
                Nombre: u.NombreCompleto,
                Cedula: u.CedulaUsuario,
                Cargo: u.Cargo || 'Sin cargo',
                Tipo: 'Local',
                // Guardamos ID local por si se necesita, aunque usaremos c√©dula
                ID_Usuario: u.ID_Usuario 
            }));
            setLista(localesFormateados);
        } catch (error) { console.error(error); } 
        finally { setIsLoadingList(false); }
    };

    const buscarColaboradoresGlobal = async (texto) => {
        if (!texto.trim()) {
            cargarColaboradoresLocales();
            return;
        }

        setIsLoadingList(true);
        try {
            // 1. Buscar Externos (API Gosen)
            const externos = await buscarUsuarioExterno(texto);
            
            // 2. Traer locales actuales (o filtrar si ya est√°n cargados)
            const dataLocales = await getColaboradores();
            const localesFiltrados = dataLocales.filter(u => 
                (u.NombreCompleto || '').toLowerCase().includes(texto.toLowerCase()) || 
                (u.CedulaUsuario || '').includes(texto)
            ).map(u => ({
                Nombre: u.NombreCompleto,
                Cedula: u.CedulaUsuario,
                Cargo: u.Cargo || 'Usuario del Sistema',
                Tipo: 'Local',
                ID_Usuario: u.ID_Usuario
            }));

            // 3. Unificar Listas (Prioridad: Local sobre Externo si la c√©dula se repite)
            const mapaUnificado = new Map();

            // Primero agregamos externos
            externos.forEach(ext => {
                mapaUnificado.set(ext.Cedula, { ...ext, Tipo: 'Externo' });
            });

            // Luego sobreescribimos con locales (si existen, tienen prioridad)
            localesFiltrados.forEach(loc => {
                mapaUnificado.set(loc.Cedula, loc);
            });

            setLista(Array.from(mapaUnificado.values()));

        } catch (error) { 
            console.error(error); 
        } finally { 
            setIsLoadingList(false); 
        }
    };

    // --- CARGA DE ACTIVOS (M√ÅQUINAS Y VEH√çCULOS) ---
    const cargarActivos = async () => {
        setIsLoadingList(true);
        try {
            const data = await getActivosTodos();
            setLista(data);
        } catch (error) { console.error(error); } 
        finally { setIsLoadingList(false); }
    };

    // --- MANEJO DE B√öSQUEDA ---
    const handleBusquedaChange = (e) => {
        setBusqueda(e.target.value);
    };

    const handleBusquedaKeyDown = (e) => {
        if (e.key === 'Enter' && activeTab === 'colaboradores') {
            buscarColaboradoresGlobal(busqueda);
        }
    };

    // --- SELECCI√ìN Y CARGA DE HISTORIAL ---
    const handleSeleccionar = async (item) => {
        setSeleccionado(item);
        setHistorial([]); 
        setIsLoadingHistory(true);
        try {
            if (activeTab === 'colaboradores') {
                // USAMOS LA C√âDULA para traer historial (Local o Externo)
                const data = await getHistorialColaborador(item.Cedula);
                setHistorial(data);
            } else {
                // USAMOS EL ID DEL ACTIVO
                const data = await getHistorialActivo(item.ID_Activo);
                setHistorial(data);
            }
        } catch (error) { 
            console.error(error); 
        } finally { 
            setIsLoadingHistory(false); 
        }
    };

    // --- FILTRADO VISUAL (CORREGIDO EL ERROR AQU√ç) ---
    const listaVisual = useMemo(() => {
        // Si estamos en colaboradores, la lista ya viene filtrada por la b√∫squeda API (si se us√≥ enter)
        // o muestra los locales. Hacemos un filtrado ligero por si acaso.
        const texto = busqueda.toLowerCase();

        return lista.filter(item => {
            if (activeTab === 'colaboradores') {
                // Validaci√≥n de nulos con ( || '')
                const nombre = item.Nombre || '';
                const cedula = item.Cedula || '';
                return nombre.toLowerCase().includes(texto) || cedula.includes(texto);
            } else {
                // CORRECCI√ìN DEL ERROR: Validaci√≥n de nulos para Activos
                const nombre = item.NombreDescriptivo || '';
                const codigo = item.CodigoIdentificador || '';
                const tipo = item.TipoActivo || '';
                
                return nombre.toLowerCase().includes(texto) || 
                       codigo.toLowerCase().includes(texto) ||
                       tipo.toLowerCase().includes(texto);
            }
        });
    }, [lista, busqueda, activeTab]);

    // Icono seg√∫n tipo de evento
    const getIconoEvento = (tipo) => {
        const t = (tipo || '').toLowerCase(); // Validaci√≥n de null
        if (t.includes('examen')) return <BsFileEarmarkMedical style={{color:'#e91e63'}}/>;
        if (t.includes('documento')) return <BsFileText style={{color:'#007BFF'}}/>;
        if (t.includes('inspecci√≥n') || t.includes('inspeccion')) return <BsClipboardCheck style={{color:'#28a745'}}/>;
        if (t.includes('mantenimiento')) return <BsTools style={{color:'#fd7e14'}}/>;
        if (t.includes('reporte')) return <BsConeStriped style={{color:'#dc3545'}}/>;
        if (t.includes('licencia')) return <BsPersonVcard style={{color:'#6f42c1'}}/>;
        if (t.includes('registro')) return <BsClockHistory style={{color:'#6c757d'}}/>;
        return <BsClockHistory style={{color:'#6c757d'}}/>;
    };

    return (
        <div className="page-container" style={{height:'90vh', display:'flex', flexDirection:'column', overflow:'hidden'}}>
            
            <div className="page-header" style={{flexShrink:0, marginBottom:'1rem'}}>
                <h1>Historial y Trazabilidad</h1>
            </div>

            {/* TABS SUPERIORES */}
            <div style={{display:'flex', gap:'10px', marginBottom:'1rem'}}>
                <button className={`btn ${activeTab==='colaboradores'?'btn-primary':'btn-secondary'}`} onClick={()=>setActiveTab('colaboradores')}>
                    <BsPersonBadge /> Colaboradores
                </button>
                <button className={`btn ${activeTab==='activos'?'btn-primary':'btn-secondary'}`} onClick={()=>setActiveTab('activos')}>
                    <BsTruck /> M√°quinas y Veh√≠culos
                </button>
            </div>

            {/* CONTENEDOR DIVIDIDO */}
            <div style={{display:'flex', gap:'1.5rem', flex:1, overflow:'hidden'}}>
                
                {/* --- PANEL IZQUIERDO: LISTA --- */}
                <div style={{width:'350px', display:'flex', flexDirection:'column', backgroundColor:'white', borderRadius:'10px', border:'1px solid #dee2e6', boxShadow:'0 2px 5px rgba(0,0,0,0.05)'}}>
                    
                    {/* Buscador */}
                    <div style={{padding:'1rem', borderBottom:'1px solid #eee'}}>
                        <div className="search-input-container" style={{width:'100%'}}>
                            <BsSearch style={{position:'absolute', left:'15px', top:'50%', transform:'translateY(-50%)', color:'#999'}}/>
                            <input 
                                className="form-control" 
                                placeholder={activeTab==='colaboradores' ? "Nombre/C√©dula + Enter (Externos)" : "Buscar activo..."} 
                                style={{paddingLeft:'35px', borderRadius:'20px'}}
                                value={busqueda}
                                onChange={handleBusquedaChange}
                                onKeyDown={handleBusquedaKeyDown} 
                            />
                        </div>
                        {activeTab === 'colaboradores' && <small style={{color:'#999', fontSize:'0.75rem', marginLeft:'10px'}}>Presiona Enter para buscar en base externa</small>}
                    </div>

                    {/* Lista Scrolleable */}
                    <div style={{flex:1, overflowY:'auto', padding:'0.5rem'}}>
                        {isLoadingList ? <p style={{textAlign:'center', padding:'1rem'}}>Cargando...</p> : (
                            listaVisual.map((item, idx) => (
                                <div 
                                    key={idx} 
                                    onClick={() => handleSeleccionar(item)}
                                    style={{
                                        padding:'1rem', marginBottom:'5px', borderRadius:'8px', cursor:'pointer', border:'1px solid transparent',
                                        backgroundColor: (seleccionado && (
                                            (activeTab === 'colaboradores' && seleccionado.Cedula === item.Cedula) || 
                                            (activeTab === 'activos' && seleccionado.ID_Activo === item.ID_Activo)
                                        )) ? '#e7f1ff' : 'white',
                                        borderColor: (seleccionado && (
                                            (activeTab === 'colaboradores' && seleccionado.Cedula === item.Cedula) || 
                                            (activeTab === 'activos' && seleccionado.ID_Activo === item.ID_Activo)
                                        )) ? '#007BFF' : 'transparent'
                                    }}
                                    className="hover-bg-light"
                                >
                                    {activeTab === 'colaboradores' ? (
                                        <>
                                            <div style={{display:'flex', justifyContent:'space-between'}}>
                                                <div style={{fontWeight:'bold', color:'#333'}}>{item.Nombre}</div>
                                                {item.Tipo === 'Externo' && <span className="status-pill status-pendiente" style={{fontSize:'0.6rem', padding:'2px 5px'}}>Ext</span>}
                                            </div>
                                            <small style={{color:'#666'}}>CC: {item.Cedula} <br/> {item.Cargo}</small>
                                        </>
                                    ) : (
                                        <>
                                            <div style={{fontWeight:'bold', color:'#333'}}>{item.NombreDescriptivo}</div>
                                            <small style={{color:'#666'}}>ID: {item.CodigoIdentificador} | {item.TipoActivo}</small>
                                        </>
                                    )}
                                </div>
                            ))
                        )}
                        {listaVisual.length === 0 && !isLoadingList && <p style={{textAlign:'center', color:'#999', padding:'1rem'}}>No hay resultados.</p>}
                    </div>
                </div>

                {/* --- PANEL DERECHO: TIMELINE --- */}
                <div style={{flex:1, backgroundColor:'white', borderRadius:'10px', border:'1px solid #dee2e6', padding:'2rem', overflowY:'auto', boxShadow:'0 2px 5px rgba(0,0,0,0.05)'}}>
                    
                    {!seleccionado ? (
                        <div style={{height:'100%', display:'flex', alignItems:'center', justifyContent:'center', color:'#999', flexDirection:'column'}}>
                            <BsClockHistory style={{fontSize:'3rem', marginBottom:'1rem', opacity:0.3}}/>
                            <h3>Selecciona un elemento</h3>
                            <p>Haz clic en la lista izquierda para ver su hoja de vida.</p>
                        </div>
                    ) : (
                        <>
                            <div style={{borderBottom:'2px solid #f0f0f0', paddingBottom:'1rem', marginBottom:'2rem', display:'flex', alignItems:'center', gap:'15px'}}>
                                <div style={{width:'60px', height:'60px', backgroundColor:'#e9ecef', borderRadius:'50%', display:'flex', alignItems:'center', justifyContent:'center', fontSize:'1.8rem', color:'#005A5B'}}>
                                    {activeTab === 'colaboradores' ? <BsPersonBadge/> : <BsLaptop/>}
                                </div>
                                <div>
                                    <h2 style={{margin:0, color:'#005A5B'}}>
                                        {activeTab === 'colaboradores' ? seleccionado.Nombre : seleccionado.NombreDescriptivo}
                                    </h2>
                                    <p style={{margin:0, color:'#666'}}>
                                        {activeTab === 'colaboradores' 
                                            ? `Historial Laboral - C√©dula: ${seleccionado.Cedula}` 
                                            : `Historial del Equipo - C√≥digo: ${seleccionado.CodigoIdentificador}`}
                                    </p>
                                    {activeTab === 'colaboradores' && (
                                        <small style={{color:'#007BFF'}}>{seleccionado.Cargo}</small>
                                    )}
                                </div>
                            </div>

                            {isLoadingHistory ? <p style={{textAlign:'center'}}>Cargando historial...</p> : (
                                <div className="timeline-container">
                                    {historial.length === 0 ? (
                                        <div style={{textAlign:'center', padding:'2rem', color:'#666', border:'2px dashed #eee', borderRadius:'10px'}}>
                                            <p>No hay eventos registrados en el historial de este √≠tem.</p>
                                            <small>Aqu√≠ aparecer√°n ex√°menes, documentos, reportes y mantenimientos.</small>
                                        </div>
                                    ) : (
                                        historial.map((evento, idx) => (
                                            <div key={idx} style={{display:'flex', marginBottom:'1.5rem', position:'relative'}}>
                                                {/* L√≠nea vertical (truco visual) */}
                                                {idx !== historial.length - 1 && (
                                                    <div style={{position:'absolute', left:'24px', top:'40px', bottom:'-30px', width:'2px', backgroundColor:'#e9ecef'}}></div>
                                                )}
                                                
                                                {/* Icono */}
                                                <div style={{
                                                    width:'50px', height:'50px', borderRadius:'50%', backgroundColor:'#f8f9fa', 
                                                    display:'flex', alignItems:'center', justifyContent:'center', fontSize:'1.5rem',
                                                    border:'2px solid #e9ecef', zIndex:2, marginRight:'1.5rem', flexShrink:0
                                                }}>
                                                    {getIconoEvento(evento.TipoEvento)}
                                                </div>

                                                {/* Contenido */}
                                                <div style={{flex:1, backgroundColor:'#fff', border:'1px solid #f0f0f0', borderRadius:'8px', padding:'1rem', boxShadow:'0 2px 4px rgba(0,0,0,0.02)', transition:'transform 0.2s'}}>
                                                    <div style={{display:'flex', justifyContent:'space-between', marginBottom:'5px'}}>
                                                        <strong style={{color:'#005A5B', fontSize:'1rem'}}>{evento.TipoEvento}</strong>
                                                        <span style={{fontSize:'0.85rem', color:'#999', fontWeight:'600'}}>
                                                            {new Date(evento.Fecha).toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' })}
                                                        </span>
                                                    </div>
                                                    <p style={{margin:0, color:'#555', fontSize:'0.95rem'}}>{evento.Descripcion}</p>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            )}
                        </>
                    )}
                </div>

            </div>
        </div>
    );
};

export default HistorialPage;


==================================================================
ARCHIVO: frontend\src\pages\IndicadoresPage.jsx
==================================================================
/* eslint-disable no-unused-vars */
// frontend/src/pages/IndicadoresPage.jsx

import React, { useState, useEffect } from 'react';
import { guardarIndicador, getIndicadoresAnuales, getConfiguracionesIndicadores, eliminarRegistroIndicador } from '../services/indicatorService';
import '../index.css';
import Swal from 'sweetalert2';
import { 
    BsGraphUp, BsSave, BsCalendarCheck, BsTable, BsSearch, 
    BsCalculator, BsChatQuote, BsCheck2Circle, BsXCircle, BsGearFill, BsTrash
} from 'react-icons/bs';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line } from 'recharts';

import ModalVerIndicador from '../components/ModalVerIndicador';
import ModalConfigurarIndicadores from '../components/ModalConfigurarIndicadores';

const IndicadoresPage = () => {
    const currentYear = new Date().getFullYear();
    const [anio, setAnio] = useState(currentYear);
    const [dataRaw, setDataRaw] = useState([]);
    const [dataGraficas, setDataGraficas] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [filtroTabla, setFiltroTabla] = useState('');

    // Estado para la configuraci√≥n din√°mica
    const [configIndicadores, setConfigIndicadores] = useState({});
    const [listaNombresIndicadores, setListaNombresIndicadores] = useState([]);

    // Estados Modales
    const [modalDetalleAbierto, setModalDetalleAbierto] = useState(false);
    const [modalConfigAbierto, setModalConfigAbierto] = useState(false);
    
    const [indicadorSeleccionado, setIndicadorSeleccionado] = useState(null);

    // Formulario (Estado din√°mico de valores)
    const [form, setForm] = useState({
        nombreIndicador: '',
        mes: new Date().getMonth() + 1,
        meta: 0,
        analisis: ''
    });

    // Variables din√°micas para el c√°lculo
    const [valoresVariables, setValoresVariables] = useState({}); // { v1: 10, v2: 20... }
    const [resultadoPreliminar, setResultadoPreliminar] = useState(0);

    const meses = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];

    // 1. CARGA INICIAL DE CONFIGURACIONES
    useEffect(() => {
        cargarConfiguraciones();
    }, []);

    const cargarConfiguraciones = async () => {
        try {
            const data = await getConfiguracionesIndicadores();
            
            const configMap = {};
            const nombres = [];
            
            data.forEach(c => {
                // Parseamos el JSON de variables
                let vars = [];
                try {
                    if (c.VariablesJSON) vars = JSON.parse(c.VariablesJSON);
                    else {
                        // BACKWARD COMPATIBILITY: Si es un indicador viejo sin JSON, lo simulamos
                        if(c.LabelNumerador) vars.push({ code: 'v1', label: c.LabelNumerador });
                        if(c.LabelDenominador) vars.push({ code: 'v2', label: c.LabelDenominador });
                        if(c.LabelAdicional) vars.push({ code: 'v3', label: c.LabelAdicional });
                    }
                } catch (e) { console.error("Error parseando JSON vars", e); }

                configMap[c.NombreIndicador] = {
                    ...c,
                    variables: vars,
                    metaDefault: c.MetaDefault,
                    // Aseguramos lectura correcta de propiedades (Case Insensitive)
                    Frecuencia: c.Frecuencia || c.frecuencia || 'Mensual',
                    TipoGrafica: c.TipoGrafica || c.tipoGrafica || 'Bar',
                    OperadorMeta: c.OperadorMeta || c.operadorMeta || '>=',
                    FormulaCalculo: c.FormulaCalculo || c.formula || c.Tipo,
                    Constante: (c.Constante !== undefined && c.Constante !== null) ? c.Constante : 100,
                    ID_Config: c.ID_Config
                };
                nombres.push(c.NombreIndicador);
            });

            setConfigIndicadores(configMap);
            setListaNombresIndicadores(nombres);

            // Seleccionar el primero por defecto
            if (nombres.length > 0 && !form.nombreIndicador) {
                handleIndicadorChange(nombres[0], configMap);
            }

        } catch (error) {
            console.error("Error cargando configuraciones:", error);
        }
    };

    // 2. CARGAR DATOS HIST√ìRICOS DEL A√ëO
    useEffect(() => {
        if (Object.keys(configIndicadores).length > 0) {
            cargarDatos();
        }
    }, [anio, configIndicadores]);

    // 3. C√ÅLCULO AUTOM√ÅTICO EN TIEMPO REAL
    useEffect(() => {
        if (form.nombreIndicador && configIndicadores[form.nombreIndicador]) {
            setResultadoPreliminar(calcularResultado());
        }
    }, [valoresVariables, form.nombreIndicador]);

    const cargarDatos = async () => {
        try {
            const datosRaw = await getIndicadoresAnuales(anio);
            const datosOrdenados = [...datosRaw].sort((a, b) => b.Mes - a.Mes);
            setDataRaw(datosOrdenados);
            procesarDatosParaGrafica(datosRaw);
        } catch (error) { console.error(error); }
    };

    const procesarDatosParaGrafica = (datos) => {
        const chartData = meses.map((mesNombre) => ({
            name: mesNombre,
            ...Object.keys(configIndicadores).reduce((acc, key) => ({ ...acc, [key]: 0, [`Meta_${key}`]: 0 }), {})
        }));

        datos.forEach(d => {
            const mesIndex = d.Mes - 1;
            if (chartData[mesIndex]) {
                chartData[mesIndex][d.NombreIndicador] = d.Resultado || 0;
                chartData[mesIndex][`Meta_${d.NombreIndicador}`] = d.Meta || 0;
            }
        });
        setDataGraficas(chartData);
    };

    const handleIndicadorChange = (nuevoNombre, mapaConfig = configIndicadores) => {
        const config = mapaConfig[nuevoNombre];
        if (config) {
            setForm(prev => ({
                ...prev,
                nombreIndicador: nuevoNombre,
                meta: config.metaDefault,
                analisis: ''
            }));
            // Inicializar variables en vac√≠o/cero
            const initVars = {};
            config.variables.forEach(v => initVars[v.code] = '');
            setValoresVariables(initVars);
        }
    };

    const handleVariableValueChange = (code, val) => {
        setValoresVariables(prev => ({ ...prev, [code]: val }));
    };

    // --- L√ìGICA MATEM√ÅTICA ---
    const calcularResultado = () => {
        const config = configIndicadores[form.nombreIndicador];
        if (!config) return 0;

        try {
            let expresion = config.FormulaCalculo ? config.FormulaCalculo.toLowerCase() : '';
            
            // Si no hay f√≥rmula expl√≠cita (legacy), asumimos v1 / v2
            if(!expresion && config.variables.length >= 2) {
                expresion = "(v1 / v2)";
            } 
            // Si es legacy compuesto (3 vars)
            else if (!expresion && config.Tipo === 'COMPUESTO') {
                expresion = "((v1 + v2) / v3)";
            }

            // Ordenamos variables por longitud (v10 antes que v1) para evitar reemplazos parciales
            const variablesOrdenadas = [...config.variables].sort((a, b) => b.code.length - a.code.length);

            variablesOrdenadas.forEach(v => {
                const valor = valoresVariables[v.code] === '' ? 0 : parseFloat(valoresVariables[v.code]);
                // Reemplazo global seguro
                const regex = new RegExp(v.code, 'gi'); 
                expresion = expresion.replace(regex, `(${valor})`); 
            });

            // Evaluar
            // eslint-disable-next-line no-new-func
            let resultado = new Function('return ' + expresion)();
            
            // Multiplicar por constante si aplica
            if (config.Constante) resultado = resultado * config.Constante;

            return isNaN(resultado) || !isFinite(resultado) ? 0 : resultado;
        } catch (e) {
            return 0;
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        try {
            const config = configIndicadores[form.nombreIndicador];
            const resultadoFinal = calcularResultado();
            
            // Construir el desglose t√©cnico para guardar en la BD
            let desglose = `[F√≥rmula: ${config.FormulaCalculo || config.Tipo} | K: ${config.Constante}] `;
            desglose += `Valores: { ` + config.variables.map(v => `${v.code}(${v.label}): ${valoresVariables[v.code] || 0}`).join(', ') + ` }`;
            
            // Separador especial '///' para diferenciar datos t√©cnicos de comentarios humanos
            const analisisFinal = form.analisis ? `${desglose} /// ${form.analisis}` : desglose;

            const payload = {
                nombreIndicador: form.nombreIndicador,
                mes: form.mes,
                anio: anio,
                constante: config.Constante,
                meta: parseFloat(form.meta || 0),
                analisis: analisisFinal,
                resultadoCalculado: resultadoFinal, 
                // Valores dummy para compatibilidad
                numerador: 0, 
                denominador: 1
            };
            
            await guardarIndicador(payload);
            
            Swal.fire({ icon: 'success', title: 'Guardado', timer: 1500, showConfirmButton: false });
            cargarDatos();
            
            // Limpiar solo campos de valor, mantener indicador seleccionado
            setForm(prev => ({...prev, analisis: ''}));
            const initVars = {};
            config.variables.forEach(v => initVars[v.code] = '');
            setValoresVariables(initVars);

        } catch (error) {
            // AQU√ç ATRAPAMOS EL ERROR DE DUPLICADOS (400 Bad Request)
            Swal.fire('Atenci√≥n', error.message, 'warning');
        } finally {
            setIsLoading(false);
        }
    };

    const handleEliminarRegistro = async (id) => {
        const result = await Swal.fire({
            title: '¬øInactivar registro?',
            text: "El registro desaparecer√° de la vista actual.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'S√≠, inactivar'
        });

        if (result.isConfirmed) {
            try {
                await eliminarRegistroIndicador(id);
                Swal.fire('Inactivado', 'Registro eliminado de la vista.', 'success');
                cargarDatos();
            } catch (error) {
                Swal.fire('Error', 'No se pudo inactivar.', 'error');
            }
        }
    };

    const configActual = configIndicadores[form.nombreIndicador] || { variables: [] };

    const cumpleMeta = (valor, meta, indicadorNombre) => {
        const valSeguro = valor || 0;
        const metaSegura = meta || 0;
        const config = configIndicadores[indicadorNombre];
        if (!config) return true;
        
        const op = config.OperadorMeta || '>=';
        
        if (op === '<=') return valSeguro <= metaSegura;
        if (op === '>=') return valSeguro >= metaSegura;
        return valSeguro === metaSegura;
    };

    // --- COMPONENTE VISUAL PARA AN√ÅLISIS ---
    const RenderAnalisisCell = ({ textoAnalisis }) => {
        if (!textoAnalisis) return <span style={{fontStyle:'italic', color:'#ccc'}}>Sin an√°lisis.</span>;

        let parteComentario = textoAnalisis;
        // Extraer solo el comentario del usuario para la tabla
        if (textoAnalisis.includes('///')) {
            parteComentario = textoAnalisis.split('///')[1]?.trim() || "Ver detalles...";
        } else if (textoAnalisis.includes(']')) {
            const splitIndex = textoAnalisis.lastIndexOf('}');
            if (splitIndex !== -1) parteComentario = textoAnalisis.substring(splitIndex + 1).replace(/^->/, '').trim();
        }
        
        return <div style={{fontSize:'0.85rem', color:'#555'}}>{parteComentario}</div>;
    };

    // --- COMPONENTE VISUAL PARA F√ìRMULA ---
    const RenderFormulaCell = ({ nombreIndicador }) => {
        const conf = configIndicadores[nombreIndicador];
        if(!conf) return <span>--</span>;

        let formulaBonita = conf.FormulaCalculo || conf.Tipo || 'Est√°ndar';
        // Reemplazo visual
        formulaBonita = formulaBonita
            .replace(/\*/g, ' √ó ')
            .replace(/\//g, ' √∑ ')
            .replace(/\+/g, ' + ')
            // eslint-disable-next-line no-useless-escape
            .replace(/\-/g, ' - ');

        return (
            <div style={{fontFamily:'monospace', fontSize:'0.8rem', color:'#005A5B'}}>
                {formulaBonita}
                {conf.Constante && parseInt(conf.Constante) !== 1 && (
                    <span style={{color:'#d63384', fontWeight:'bold'}}> √ó {parseInt(conf.Constante).toLocaleString()}</span>
                )}
            </div>
        );
    };

    const RenderGrafica = ({ titulo, dataKey, tipo }) => (
        <div className="page-content-card" style={{marginBottom:'1rem', minWidth: '0'}}>
            <h4 style={{fontSize:'0.9rem', color:'#666', textTransform:'uppercase', borderBottom:'1px solid #eee', paddingBottom:'5px'}}>{titulo}</h4>
            <div style={{ width: '100%', height: 300 }}>
                <ResponsiveContainer width="100%" height="100%">
                    {tipo === 'Line' ? (
                        <LineChart data={dataGraficas} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                            <CartesianGrid strokeDasharray="3 3" />
                            <XAxis dataKey="name" />
                            <YAxis />
                            <Tooltip contentStyle={{borderRadius:'8px'}} />
                            <Legend />
                            <Line type="monotone" dataKey={dataKey} stroke="#005A5B" strokeWidth={3} activeDot={{ r: 6 }} name="Resultado" />
                            <Line type="monotone" dataKey={`Meta_${dataKey}`} stroke="#dc3545" strokeDasharray="5 5" name="Meta" />
                        </LineChart>
                    ) : (
                        <BarChart data={dataGraficas} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                            <CartesianGrid strokeDasharray="3 3" />
                            <XAxis dataKey="name" />
                            <YAxis />
                            <Tooltip contentStyle={{borderRadius:'8px'}} />
                            <Legend />
                            <Bar dataKey={dataKey} fill="#005A5B" name="Resultado" radius={[4, 4, 0, 0]} />
                            <Bar dataKey={`Meta_${dataKey}`} fill="#b3b3b3" name="Meta" radius={[4, 4, 0, 0]} />
                        </BarChart>
                    )}
                </ResponsiveContainer>
            </div>
        </div>
    );

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>Indicadores de Gesti√≥n SST ({anio})</h1>
                <div style={{display:'flex', gap:'10px'}}>
                    <button className="btn btn-secondary" onClick={() => setModalConfigAbierto(true)}>
                        <BsGearFill /> Gestionar Indicadores
                    </button>
                    <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                        <span style={{fontWeight:'bold'}}>A√±o:</span>
                        <input type="number" className="form-control" value={anio} onChange={(e) => setAnio(e.target.value)} style={{width:'80px', padding:'5px'}} />
                    </div>
                </div>
            </div>

            {/* FORMULARIO DE REGISTRO DIN√ÅMICO */}
            <div className="page-content-card" style={{borderTop: '5px solid var(--color-acento)', marginBottom: '2rem'}}>
                <h3 style={{marginTop:0, display:'flex', alignItems:'center', gap:'10px'}}>
                    <BsCalendarCheck /> Registrar Medici√≥n Mensual
                </h3>
                
                {listaNombresIndicadores.length === 0 ? (
                    <p style={{color:'#666'}}>No hay indicadores configurados.</p>
                ) : (
                    <form onSubmit={handleSubmit}>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1.5rem'}}>
                            <div className="form-group">
                                <label>Seleccione Indicador</label>
                                <select className="form-control" value={form.nombreIndicador} onChange={(e) => handleIndicadorChange(e.target.value)}>
                                    {listaNombresIndicadores.map(k => <option key={k} value={k}>{k}</option>)}
                                </select>
                                <div style={{marginTop:'5px', fontSize:'0.8rem', color:'#666', display:'flex', gap:'10px'}}>
                                    <span>Frecuencia: <strong>{configActual.Frecuencia}</strong></span>
                                    {configActual.Constante !== 1 && <span>K: <strong>{configActual.Constante?.toLocaleString()}</strong></span>}
                                    <span>F√≥rmula: <code style={{color:'#d63384'}}>{configActual.FormulaCalculo || configActual.Tipo}</code></span>
                                </div>
                            </div>
                            <div className="form-group">
                                <label>Mes de Reporte</label>
                                <select className="form-control" value={form.mes} onChange={(e) => setForm({...form, mes: parseInt(e.target.value)})}>
                                    {meses.map((m, i) => <option key={i} value={i+1}>{m}</option>)}
                                </select>
                            </div>
                        </div>

                        {/* INPUTS DIN√ÅMICOS PARA LAS VARIABLES */}
                        <div style={{marginTop:'1rem', backgroundColor:'#f8f9fa', padding:'1.5rem', borderRadius:'8px', border:'1px solid #dee2e6'}}>
                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem'}}>
                                {configActual.variables && configActual.variables.map(v => (
                                    <div key={v.code} className="form-group" style={{marginBottom:0}}>
                                        <label>{v.label} <span style={{color:'#007BFF', fontSize:'0.8rem'}}>({v.code})</span></label>
                                        <input 
                                            type="number" 
                                            step="0.01" 
                                            className="form-control" 
                                            required 
                                            value={valoresVariables[v.code] || ''} 
                                            onChange={(e) => handleVariableValueChange(v.code, e.target.value)} 
                                            placeholder="0" 
                                        />
                                    </div>
                                ))}
                            </div>
                            
                            <div style={{display: 'flex', gap:'2rem', marginTop: '1.5rem', borderTop:'1px solid #ddd', paddingTop:'1rem', alignItems:'center'}}>
                                <div className="form-group" style={{marginBottom:0}}>
                                    <label>Meta Establecida</label>
                                    <input type="number" step="0.01" className="form-control" required value={form.meta} onChange={(e) => setForm({...form, meta: e.target.value})} style={{width:'150px'}} />
                                </div>
                                <div style={{flex:1, textAlign:'right'}}>
                                    <label style={{display:'block', marginBottom:'5px', color:'#005A5B', fontSize:'0.9rem'}}>Resultado Calculado {configActual.Constante !== 1 && `(x ${configActual.Constante})`}</label>
                                    <span style={{fontSize:'2.5rem', fontWeight:'bold', color:'#005A5B'}}>
                                        {resultadoPreliminar.toFixed(2)}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div className="form-group" style={{marginTop: '1rem'}}>
                            <label>An√°lisis Cualitativo / Comentarios (Opcional)</label>
                            <textarea className="form-control" rows="2" value={form.analisis} onChange={(e) => setForm({...form, analisis: e.target.value})} placeholder="Comentarios sobre el resultado..." />
                        </div>

                        <div style={{textAlign:'right', marginTop:'1rem'}}>
                            <button type="submit" className="btn btn-primary" disabled={isLoading}>
                                <BsSave /> {isLoading ? 'Guardando...' : 'Guardar Registro'}
                            </button>
                        </div>
                    </form>
                )}
            </div>

            {/* GR√ÅFICAS */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '2rem', marginBottom: '3rem' }}>
                {listaNombresIndicadores.map(key => {
                    const tieneDatos = dataRaw.some(d => d.NombreIndicador === key);
                    if (!tieneDatos) return null;
                    return (
                        <RenderGrafica 
                            key={key} 
                            titulo={key} 
                            dataKey={key} 
                            tipo={configIndicadores[key]?.TipoGrafica || 'Bar'} 
                        />
                    );
                })}
            </div>

            {/* TABLA HIST√ìRICA */}
            <div className="page-content-card">
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem'}}>
                    <h3 style={{marginTop:0, display:'flex', alignItems:'center', gap:'10px'}}><BsTable /> Detalle de Registros {anio}</h3>
                    <div className="search-input-container" style={{maxWidth:'300px'}}>
                        <BsSearch style={{ position: 'absolute', left: '10px', top: '50%', transform: 'translateY(-50%)', color: '#aaa' }} />
                        <input type="text" className="form-control" placeholder="Filtrar..." style={{ paddingLeft: '30px', height: '35px' }} value={filtroTabla} onChange={(e) => setFiltroTabla(e.target.value)} />
                    </div>
                </div>

                <div className="table-wrapper">
                    <table className="data-table">
                        <thead>
                            <tr>
                                <th style={{width: '80px'}}>Mes</th>
                                <th style={{width: '200px'}}>Indicador</th>
                                <th style={{width: '180px'}}>F√≥rmula</th>
                                <th style={{width: '100px'}}>Resultado</th>
                                <th style={{width: '80px'}}>Meta</th>
                                <th style={{width: '100px'}}>Estado</th>
                                <th>Comentarios</th>
                                <th style={{width: '120px', textAlign:'center'}}>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            {dataRaw.filter(r => r.NombreIndicador.toLowerCase().includes(filtroTabla.toLowerCase())).length === 0 ? (
                                <tr><td colSpan="8" style={{textAlign:'center'}}>No hay registros.</td></tr>
                            ) : (
                                dataRaw.filter(r => r.NombreIndicador.toLowerCase().includes(filtroTabla.toLowerCase())).map((row) => (
                                    <tr key={row.ID_Indicador}>
                                        <td>{meses[row.Mes - 1]}</td>
                                        <td><strong style={{fontSize:'0.9rem'}}>{row.NombreIndicador}</strong></td>
                                        
                                        <td style={{verticalAlign:'middle'}}>
                                            <RenderFormulaCell nombreIndicador={row.NombreIndicador} />
                                        </td>

                                        <td style={{fontWeight:'bold', color: '#005A5B', fontSize:'1rem'}}>{(row.Resultado || 0).toFixed(2)}</td>
                                        <td>{row.Meta}</td>
                                        <td>
                                            {cumpleMeta(row.Resultado, row.Meta, row.NombreIndicador) ? (
                                                <span className="status-pill status-activo"><BsCheck2Circle/> Cumple</span>
                                            ) : (
                                                <span className="status-pill status-inactivo"><BsXCircle/> No Cumple</span>
                                            )}
                                        </td>
                                        <td style={{verticalAlign: 'top'}}><RenderAnalisisCell textoAnalisis={row.Analisis} /></td>
                                        <td style={{textAlign:'center', display:'flex', gap:'5px', justifyContent:'center'}}>
                                            <button className="btn btn-sm btn-secondary" onClick={() => {setIndicadorSeleccionado({...row, Anio: anio}); setModalDetalleAbierto(true);}} title="Ver Detalle">Ver</button>
                                            <button className="btn btn-sm btn-danger" onClick={() => handleEliminarRegistro(row.ID_Indicador)} title="Inactivar Registro"><BsTrash /></button>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>

            {modalConfigAbierto && (
                <ModalConfigurarIndicadores 
                    configs={Object.values(configIndicadores)} 
                    alCerrar={() => setModalConfigAbierto(false)} 
                    alActualizar={() => { setModalConfigAbierto(false); cargarConfiguraciones(); }}
                />
            )}

            {modalDetalleAbierto && (
                <ModalVerIndicador indicador={indicadorSeleccionado} alCerrar={() => setModalDetalleAbierto(false)} />
            )}
        </div>
    );
};

export default IndicadoresPage;


==================================================================
ARCHIVO: frontend\src\pages\InspeccionesPage.jsx
==================================================================
// frontend/src/pages/InspeccionesPage.jsx

import React, { useState, useEffect, useMemo } from 'react';

// Servicios
import { 
    getInspeccionesHistorial, 
    getFormularios, 
    getPreguntasFormulario 
} from '../services/inspectionService';

import '../index.css';
import '../style/InspeccionesPage.css';

// Iconos (Quitamos BsFileEarmarkPlus que ya no se usa)
import { BsPlusLg, BsEyeFill, BsSearch } from 'react-icons/bs';
import Swal from 'sweetalert2'; 

// Modales
import ModalVerInspeccion from '../components/ModalVerInspeccion.jsx';
import ModalDiligenciarInspeccion from '../components/ModalDiligenciarInspeccion.jsx';
import ModalCrearACPM from '../components/ModalCrearACPM.jsx'; 
import ModalVerACPM from '../components/ModalVerACPM.jsx'; 

const InspeccionesPage = () => {

    // DATOS
    const [historial, setHistorial] = useState([]);
    const [listaFormularios, setListaFormularios] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);

    // --- FILTROS ---
    const [busqueda, setBusqueda] = useState('');
    const [filtroResultado, setFiltroResultado] = useState(''); // 'OK', 'Con Hallazgos'

    // MODALES
    const [modalDetalleAbierto, setModalDetalleAbierto] = useState(false);
    const [inspeccionSeleccionadaId, setInspeccionSeleccionadaId] = useState(null);

    const [modalDiligenciarAbierto, setModalDiligenciarAbierto] = useState(false);
    const [formularioSeleccionado, setFormularioSeleccionado] = useState(null);

    // *** ESTADO PARA PREGUNTAS DIN√ÅMICAS ***
    const [preguntasFormulario, setPreguntasFormulario] = useState([]);

    // ACPM
    const [modalCrearAcpmAbierto, setModalCrearAcpmAbierto] = useState(false);
    const [modalVerAcpmId, setModalVerAcpmId] = useState(null);
    const [acpmInitialData, setAcpmInitialData] = useState({});

    // CARGA INICIAL
    const cargarDatos = async () => {
        try {
            setIsLoading(true);
            const [dataHistorial, dataFormularios] = await Promise.all([
                getInspeccionesHistorial(),
                getFormularios()
            ]);
            setHistorial(dataHistorial);
            setListaFormularios(dataFormularios);
            setError(null);
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    useEffect(() => { cargarDatos(); }, []);

    // --- L√ìGICA DE FILTRADO ---
    const historialFiltrado = useMemo(() => {
        return historial.filter(ins => {
            const texto = busqueda.toLowerCase();
            
            // 1. B√∫squeda por: Formulario, Usuario, Activo o ID
            const matchTexto = 
                ins.NombreFormulario.toLowerCase().includes(texto) ||
                ins.NombreUsuarioRealizo.toLowerCase().includes(texto) ||
                (ins.NombreActivo && ins.NombreActivo.toLowerCase().includes(texto)) ||
                ins.ID_InspeccionRealizada.toString().includes(texto);

            // 2. Filtro por Resultado
            const matchResultado = filtroResultado ? ins.ResultadoGeneral === filtroResultado : true;

            return matchTexto && matchResultado;
        });
    }, [historial, busqueda, filtroResultado]);

    // MODAL DETALLE
    const abrirModalDetalle = (id) => {
        setInspeccionSeleccionadaId(id);
        setModalDetalleAbierto(true);
    };
    const cerrarModalDetalle = () => {
        setModalDetalleAbierto(false);
        setInspeccionSeleccionadaId(null);
    };

    // ABRIR MODAL DILIGENCIAR
    const abrirModalDiligenciar = async (form) => {
        setFormularioSeleccionado(form);
        setPreguntasFormulario([]);

        // Formularios hardcoded que NO usan BD (Legacy)
        const formulariosHardcoded = [
            'FTO-SST-02', 'FTO-SST-13', 'FTO-SST-14',
            'FTO-SST-23', 'FTO-SST-45', 'FTO-SST-95', 'FTO-SST-96'
        ];

        // Si NO es hardcoded -> cargar preguntas desde BD
        if (!formulariosHardcoded.includes(form.ID_Formulario)) {
            try {
                const preguntas = await getPreguntasFormulario(form.ID_Formulario);
                setPreguntasFormulario(preguntas);
            // eslint-disable-next-line no-unused-vars
            } catch (err) {
                // eslint-disable-next-line no-unused-vars
                Swal.fire('Error', 'No se pudieron cargar las preguntas del formulario din√°mico.', 'error');
                return;
            }
        }

        setModalDiligenciarAbierto(true);
    };

    const cerrarModalDiligenciar = () => {
        setModalDiligenciarAbierto(false);
        setFormularioSeleccionado(null);
        setPreguntasFormulario([]);
    };

    const handleInspeccionGuardada = () => {
        cerrarModalDiligenciar();
        cargarDatos();
    };

    // ACPM
    const abrirModalCrearACPM = (inspeccion) => {
        setAcpmInitialData({
            origen: `Inspecci√≥n: ${inspeccion.NombreFormulario} (ID: ${inspeccion.ID_InspeccionRealizada})`,
            descripcionProblema: `Hallazgos encontrados en inspecci√≥n de ${inspeccion.NombreFormulario} (Activo: ${inspeccion.NombreActivo || 'N/A'}).`,
            idInspeccionOrigen: inspeccion.ID_InspeccionRealizada
        });
        setModalCrearAcpmAbierto(true);
    };

    const cerrarModalCrearACPM = () => {
        setModalCrearAcpmAbierto(false);
        setAcpmInitialData({});
    };

    const handleAcpmCreada = (nuevoIdACPM) => {
        cerrarModalCrearACPM();
        cargarDatos();
        Swal.fire({
            title: '¬°ACPM Creada!',
            text: `La Acci√≥n ACPM (ID: ${nuevoIdACPM}) ha sido creada.`,
            icon: 'success',
            showCancelButton: true,
            confirmButtonText: 'Ver ACPM',
            cancelButtonText: 'Cerrar'
        }).then(result => {
            if (result.isConfirmed) setModalVerAcpmId(nuevoIdACPM);
        });
    };

    const abrirModalVerACPM = (id) => setModalVerAcpmId(id);
    const cerrarModalVerACPM = () => setModalVerAcpmId(null);

    // UTIL FECHA
    const formatearFechaHora = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        return new Date(fechaISO).toLocaleString('es-CO');
    };

    return (
        <div className="page-container">
            
            {/* HEADER */}
            <div className="page-header">
                <h1>Inspecciones de Seguridad</h1>
                {/* BOT√ìN ELIMINADO AQU√ç */}
            </div>

            {/* BIBLIOTECA */}
            <div className="page-content-card inspection-library">
                <h2>Biblioteca de Formularios</h2>
                <p>Seleccione un formulario para diligenciar una nueva inspecci√≥n.</p>

                <div className="form-buttons-container">
                    {listaFormularios.length === 0 ? (
                        <p>Cargando formularios...</p>
                    ) : (
                        listaFormularios.map(form => (
                            <button 
                                key={form.ID_Formulario}
                                className="btn btn-primary"
                                onClick={() => abrirModalDiligenciar(form)}
                                title={form.Descripcion}
                            >
                                <BsPlusLg /> {form.NombreFormulario}
                            </button>
                        ))
                    )}
                </div>
            </div>

            {/* HISTORIAL */}
            <div className="page-content-card" style={{ marginTop: '2rem' }}>
                <h2>Historial de Inspecciones Realizadas</h2>

                {/* --- BARRA DE FILTROS --- */}
                <div className="filters-bar" style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                    {/* Input B√∫squeda */}
                    <div className="search-input-container" style={{ flex: 1, minWidth: '250px', position: 'relative' }}>
                        <BsSearch style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#aaa' }} />
                        <input 
                            type="text" 
                            className="form-control" 
                            placeholder="Buscar por formulario, usuario, activo..." 
                            style={{ paddingLeft: '35px', height: '40px' }}
                            value={busqueda}
                            onChange={(e) => setBusqueda(e.target.value)}
                        />
                    </div>

                    {/* Select Resultado */}
                    <div className="filter-select-container" style={{ minWidth: '200px' }}>
                        <select 
                            className="form-control"
                            style={{ height: '40px' }}
                            value={filtroResultado}
                            onChange={(e) => setFiltroResultado(e.target.value)}
                        >
                            <option value="">Todos los Resultados</option>
                            <option value="OK">OK (Sin Hallazgos)</option>
                            <option value="Con Hallazgos">Con Hallazgos</option>
                        </select>
                    </div>
                </div>

                <div className="table-wrapper">
                    {isLoading && <p>Cargando historial...</p>}
                    {error && <p className="error-message">Error: {error}</p>}

                    {!isLoading && !error && (
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Formulario</th>
                                    <th>Fecha Realizada</th>
                                    <th>Realizada por</th>
                                    <th>Resultado</th>
                                    <th>Activo/√Årea</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {historialFiltrado.length === 0 ? (
                                    <tr><td colSpan="6" style={{ textAlign: 'center' }}>No se encontraron inspecciones.</td></tr>
                                ) : (
                                    historialFiltrado.map(ins => (
                                        <tr key={ins.ID_InspeccionRealizada}>
                                            <td>{ins.NombreFormulario} ({ins.ID_Formulario})</td>
                                            <td>{formatearFechaHora(ins.FechaInspeccion)}</td>
                                            <td>{ins.NombreUsuarioRealizo}</td>
                                            <td>
                                                <span className={`status-pill ${
                                                    ins.ResultadoGeneral === 'OK' ? 'status-activo' : 'status-pendiente'
                                                }`}>
                                                    {ins.ResultadoGeneral}
                                                </span>
                                            </td>
                                            <td>{ins.NombreActivo || 'N/A'}</td>
                                            <td className="action-buttons">
                                                <button 
                                                    className="btn btn-secondary"
                                                    onClick={() => abrirModalDetalle(ins.ID_InspeccionRealizada)}
                                                >
                                                    Ver Detalle
                                                </button>

                                                {ins.ResultadoGeneral === 'Con Hallazgos' && (
                                                    ins.ID_ACPM_Vinculada ? (
                                                        <button 
                                                            className="btn btn-success"
                                                            onClick={() => abrirModalVerACPM(ins.ID_ACPM_Vinculada)}
                                                        >
                                                            <BsEyeFill /> Ver ACPM
                                                        </button>
                                                    ) : (
                                                        <button 
                                                            className="btn btn-warning"
                                                            onClick={() => abrirModalCrearACPM(ins)}
                                                        >
                                                            Crear ACPM
                                                        </button>
                                                    )
                                                )}
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>

            {/* MODALES */}

            {modalDetalleAbierto && (
                <ModalVerInspeccion 
                    inspeccionId={inspeccionSeleccionadaId}
                    alCerrar={cerrarModalDetalle}
                />
            )}

            {/* Modal DILIGENCIAR con preguntas din√°micas */}
            {modalDiligenciarAbierto && formularioSeleccionado && (
                <ModalDiligenciarInspeccion 
                    idFormulario={formularioSeleccionado.ID_Formulario}
                    nombreFormulario={formularioSeleccionado.NombreFormulario}
                    tipoActivo={formularioSeleccionado.TipoActivoAsociado}
                    datosFormulario={{ preguntas: preguntasFormulario }}
                    alCerrar={cerrarModalDiligenciar}
                    alExito={handleInspeccionGuardada}
                />
            )}

            {modalCrearAcpmAbierto && (
                <ModalCrearACPM 
                    alCerrar={cerrarModalCrearACPM}
                    alExito={handleAcpmCreada}
                    initialData={acpmInitialData}
                />
            )}

            {modalVerAcpmId && (
                <ModalVerACPM 
                    acpmId={modalVerAcpmId}
                    alCerrar={cerrarModalVerACPM}
                />
            )}

        </div>
    );
};

export default InspeccionesPage;


==================================================================
ARCHIVO: frontend\src\pages\LoginPage.jsx
==================================================================
// frontend/src/pages/LoginPage.jsx

import React, { useState } from 'react';
// eslint-disable-next-line no-unused-vars
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import '../style/LoginPage.css';
import logo from "../assets/logo-empaquetados.png";
// Iconos
import { BsShieldCheck, BsPeople, BsArrowLeft, BsPersonFill, BsLockFill } from 'react-icons/bs';

const LoginPage = () => {
    const [view, setView] = useState('SELECCION');
    const [selectedRoleTitle, setSelectedRoleTitle] = useState('');
    const [cedula, setCedula] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [isLoadingLogin, setIsLoadingLogin] = useState(false);
    const { login } = useAuth();

    // --- 1. SELECCI√ìN DE PERFIL ---
    const handleSelectRole = (roleName) => {
        setSelectedRoleTitle(roleName);
        setView('FORMULARIO');
        setError('');
        setCedula('');
        setPassword('');
    };

    // --- 2. VOLVER ---
    const handleBack = () => {
        setView('SELECCION');
        setSelectedRoleTitle('');
        setError('');
    };

    // --- 3. LOGIN ---
    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');

        if (!cedula || !password) {
            setError('Por favor, complete todos los campos.');
            return;
        }

        setIsLoadingLogin(true);
        try {
            await login(cedula, password);
        } catch (err) {
            setError(err.message || 'Credenciales incorrectas.');
            setIsLoadingLogin(false);
        }
    };

    // --- VISTA 1: SELECCI√ìN DE ROL ---
    if (view === 'SELECCION') {
        return (
            <div className="login-container-selection">
                <div className="login-header-center">
                    <img src={logo} alt="Logo Empaquetados El Trece" className="login-logo-selection" />
                    <h1>Bienvenido al Sistema</h1>
                    <p>Empaquetados El Trece S.A.S</p>
                    <h3>Seleccione su perfil para ingresar:</h3>
                </div>

                <div className="role-cards-container">
                   
                    {/* TARJETA 1: SG-SST */}
                    <div className="role-card" onClick={() => handleSelectRole('Seguridad y Salud en el Trabajo')}>
                        <div className="role-icon sst-color"><BsShieldCheck /></div>
                        <h3>Gesti√≥n SG-SST</h3>
                        <p>Administradores y L√≠deres SST</p>
                    </div>

                    {/* TARJETA 2: COLABORADOR */}
                    <div className="role-card" onClick={() => handleSelectRole('Colaborador')}>
                        <div className="role-icon collab-color"><BsPeople /></div>
                        <h3>Colaborador</h3>
                        <p>Reportes y Consultas Operativas</p>
                    </div>
                </div>
                
                <div style={{marginTop: '2rem', fontSize: '0.8rem', color: '#aaa'}}>
                    v2.0 - Sistema Integrado de Gesti√≥n
                </div>
            </div>
        );
    }

    // --- VISTA 2: FORMULARIO ---
    return (
        <div className="login-container">
            {/* Columna Izquierda Visual */}
            <div className="login-visual-column">
                <div className="visual-content">
                    <h1>{selectedRoleTitle}</h1>
                    <p>Ingrese sus credenciales para acceder al m√≥dulo seleccionado.</p>
                </div>
            </div>

            {/* Columna Derecha Formulario */}
            <div className="login-form-column">
                <button className="btn-back" onClick={handleBack}>
                    <BsArrowLeft /> Volver
                </button>

                <div className="login-form-wrapper">
                    <div style={{ textAlign: 'center', marginBottom: '1rem' }}>
                        <img src={logo} alt="Logo" className="login-form-logo" />
                    </div>
                    <div className="login-logo-placeholder">Empaquetados El Trece</div>
                    <h2>Iniciar Sesi√≥n</h2>

                    <form onSubmit={handleSubmit}>
                        <div className="input-group">
                            <label htmlFor="cedula">Usuario / C√©dula</label>
                            <div className="input-with-icon">
                                <BsPersonFill className="input-icon" />
                                <input
                                    type="text"
                                    id="cedula"
                                    value={cedula}
                                    onChange={(e) => setCedula(e.target.value)}
                                    placeholder="Ingrese su usuario"
                                    autoFocus
                                />
                            </div>
                        </div>

                        <div className="input-group">
                            <label htmlFor="password">Contrase√±a</label>
                            <div className="input-with-icon">
                                <BsLockFill className="input-icon" />
                                <input
                                    type="password"
                                    id="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="Ingrese su contrase√±a"
                                />
                            </div>
                        </div>

                        {error && <p className="login-error-message">{error}</p>}

                        <button type="submit" className="btn btn-primary login-button" disabled={isLoadingLogin}>
                            {isLoadingLogin ? 'Validando...' : 'Ingresar'}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    );
};

export default LoginPage;


==================================================================
ARCHIVO: frontend\src\pages\LogsPage.jsx
==================================================================
// frontend/src/pages/LogsPage.jsx

import React, { useState, useEffect, useCallback } from 'react';
import { buscarLogs, getLogFiltros } from '../services/logService';
import '../index.css'; // Estilos globales
import '../style/LogsPage.css'; // <-- 1. Importar el nuevo CSS
import { BsSearch, BsArrowCounterclockwise } from 'react-icons/bs';

// Estado inicial vac√≠o para los filtros
const filtrosVacios = {
    idUsuario: '',
    accion: '',
    fechaInicio: '',
    fechaFin: ''
};

const LogsPage = () => {
    // --- Estados ---
    const [logs, setLogs] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);

    // --- Estados de Filtros ---
    const [filtros, setFiltros] = useState(filtrosVacios);
    const [listasFiltros, setListasFiltros] = useState({ usuarios: [], acciones: [] });

    // --- Carga Inicial de Datos (Logs y Filtros) ---
    
    // 1. Carga los dropdowns de filtros (solo una vez)
    useEffect(() => {
        const cargarListas = async () => {
            try {
                const data = await getLogFiltros();
                setListasFiltros(data);
            } catch (err) {
                console.error("Error cargando filtros:", err);
            }
        };
        cargarListas();
    }, []);

    // 2. Carga los logs (depende de 'filtros')
    const cargarLogs = useCallback(async (filtrosActuales) => {
        try {
            setIsLoading(true);
            const data = await buscarLogs(filtrosActuales);
            setLogs(data);
            setError(null);
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    }, []); // Ya no depende de 'filtros'

    // 3. Carga inicial de logs (con filtros vac√≠os)
    useEffect(() => {
        cargarLogs(filtros);
    }, [filtros, cargarLogs]);

    // --- Manejadores de Filtros ---
    const handleChange = (e) => {
        const { name, value } = e.target;
        setFiltros(prev => ({ ...prev, [name]: value }));
    };

    const handleBuscar = (e) => {
        e.preventDefault(); // Previene que el form recargue la p√°g
        cargarLogs(filtros); 
    };

    const handleLimpiar = () => {
        setFiltros(filtrosVacios);
        // La recarga se disparar√° autom√°ticamente por el useEffect [filtros]
    };

    // Formatear la fecha para la tabla
    const formatearFechaHora = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        return new Date(fechaISO).toLocaleString('es-CO', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
    };

    return (
        <div className="page-container">
            {/* --- Encabezado --- */}
            <div className="page-header">
                <h1>Registro de Auditor√≠a (Logs)</h1>
            </div>

            {/* --- 2. TARJETA DE FILTROS (Actualizada con CSS) --- */}
            <div className="page-content-card logs-filter-card">
                {/* Usamos <form> para que 'Enter' funcione en la b√∫squeda */}
                <form className="logs-filter-bar" onSubmit={handleBuscar}>
                    
                    <div className="filter-item">
                        <label htmlFor="idUsuario">Filtrar por Usuario:</label>
                        <select name="idUsuario" value={filtros.idUsuario} onChange={handleChange}>
                            <option value="">-- Todos los Usuarios --</option>
                            {listasFiltros.usuarios.map(u => (
                                <option key={u.ID_Usuario} value={u.ID_Usuario}>{u.NombreUsuario}</option>
                            ))}
                        </select>
                    </div>

                    <div className="filter-item">
                        <label htmlFor="accion">Filtrar por Acci√≥n:</label>
                        <select name="accion" value={filtros.accion} onChange={handleChange}>
                            <option value="">-- Todas las Acciones --</option>
                            {listasFiltros.acciones.map(a => (
                                <option key={a.Accion} value={a.Accion}>{a.Accion}</option>
                            ))}
                        </select>
                    </div>
                    
                    <div className="filter-item">
                        <label htmlFor="fechaInicio">Fecha Desde:</label>
                        <input type="date" name="fechaInicio" value={filtros.fechaInicio} onChange={handleChange} />
                    </div>

                    <div className="filter-item">
                        <label htmlFor="fechaFin">Fecha Hasta:</label>
                        <input type="date" name="fechaFin" value={filtros.fechaFin} onChange={handleChange} />
                    </div>

                    <div className="filter-buttons">
                        <button type="submit" className="btn btn-primary">
                            <BsSearch /> Buscar
                        </button>
                        <button type="button" className="btn btn-secondary" onClick={handleLimpiar}>
                            <BsArrowCounterclockwise /> Limpiar
                        </button>
                    </div>
                </form>
            </div>
            {/* --- FIN DE LA TARJETA DE FILTROS --- */}


            {/* --- Tarjeta de Contenido (Tabla) --- */}
            <div className="page-content-card">
                <div className="table-wrapper">
                    {isLoading && <p>Cargando registros...</p>}
                    {error && <p className="error-message">Error: {error}</p>}
                    
                    {!isLoading && !error && (
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha y Hora</th>
                                    <th>Usuario Admin</th>
                                    <th>Acci√≥n</th>
                                    <th>Descripci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {logs.length === 0 ? (
                                    <tr><td colSpan="4" style={{ textAlign: 'center' }}>No se encontraron registros con esos filtros.</td></tr>
                                ) : (
                                    logs.slice(0, 100).map((log) => ( // Limita a 100
                                        <tr key={log.ID_Log}>
                                            <td>{formatearFechaHora(log.FechaHora)}</td>
                                            <td>{log.NombreUsuario}</td>
                                            <td>
                                                <span className="status-pill status-proceso">
                                                    {log.Accion}
                                                </span>
                                            </td>
                                            <td>{log.Descripcion}</td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>
        </div>
    );
};

export default LogsPage;


==================================================================
ARCHIVO: frontend\src\pages\MedicinaLaboralPage.jsx
==================================================================
// frontend/src/pages/MedicinaLaboralPage.jsx

import React, { useState, useEffect, useMemo } from 'react';
import { getHistorialExamenes } from '../services/medicalService';
import '../index.css';
import { BsPlusLg, BsSearch, BsFileEarmarkPdf, BsEyeFill, BsHeartPulseFill } from 'react-icons/bs';

// Importamos los modales
import ModalRegistrarExamen from '../components/ModalRegistrarExamen';
import ModalVerExamen from '../components/ModalVerExamen';
import ModalGenerarPdfMedico from '../components/ModalGenerarPdfMedico';

const MedicinaLaboralPage = () => {
    // --- ESTADOS ---
    const [examenes, setExamenes] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    // eslint-disable-next-line no-unused-vars
    const [error, setError] = useState('');
    const [busqueda, setBusqueda] = useState('');

    // Estados de Modales
    const [modalRegistrarOpen, setModalRegistrarOpen] = useState(false);
    const [modalVerOpen, setModalVerOpen] = useState(false);
    const [modalPdfOpen, setModalPdfOpen] = useState(false);
    
    // Examen seleccionado para Ver o Generar PDF
    const [examenSeleccionado, setExamenSeleccionado] = useState(null);

    // --- CARGA DE DATOS ---
    const cargarExamenes = async () => {
        setIsLoading(true);
        try {
            const data = await getHistorialExamenes();
            setExamenes(data);
            setError('');
        } catch (err) {
            console.error(err);
            setError('No se pudo cargar el historial m√©dico.');
        } finally {
            setIsLoading(false);
        }
    };

    useEffect(() => {
        cargarExamenes();
    }, []);

    // --- FILTRADO ---
    const examenesFiltrados = useMemo(() => {
        const texto = busqueda.toLowerCase();
        return examenes.filter(ex => 
            ex.NombreColaborador.toLowerCase().includes(texto) ||
            ex.CedulaColaborador.includes(texto) ||
            ex.TipoExamen.toLowerCase().includes(texto)
        );
    }, [examenes, busqueda]);

    // --- MANEJADORES ---
    const handleExamenRegistrado = () => {
        setModalRegistrarOpen(false);
        cargarExamenes();
    };

    const abrirModalVer = (examen) => {
        setExamenSeleccionado(examen);
        setModalVerOpen(true);
    };

    const abrirModalPdf = (examen) => {
        setExamenSeleccionado(examen);
        setModalPdfOpen(true);
    };

    // Formatear fecha para visualizaci√≥n
    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return '--';
        return new Date(fechaISO).toLocaleDateString('es-CO');
    };

    // Color seg√∫n concepto
    const getConceptoClass = (concepto) => {
        if (concepto === 'Apto') return 'status-activo';
        if (concepto === 'Apto con restricciones') return 'status-proceso'; // Azul o Amarillo
        return 'status-inactivo'; // Rojo (No Apto)
    };

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>Medicina Laboral</h1>
                <button className="btn btn-primary" onClick={() => setModalRegistrarOpen(true)}>
                    <BsPlusLg /> Registrar Examen
                </button>
            </div>

            {/* BARRA DE B√öSQUEDA */}
            <div className="filters-bar" style={{marginBottom:'1.5rem'}}>
                <div className="search-input-container" style={{maxWidth:'400px', position:'relative'}}>
                    <BsSearch style={{position:'absolute', left:'15px', top:'50%', transform:'translateY(-50%)', color:'#999'}}/>
                    <input 
                        type="text" 
                        className="form-control" 
                        placeholder="Buscar por nombre, c√©dula o tipo..." 
                        style={{paddingLeft:'40px', borderRadius:'20px'}}
                        value={busqueda}
                        onChange={(e) => setBusqueda(e.target.value)}
                    />
                </div>
            </div>

            <div className="page-content-card">
                <div className="table-wrapper">
                    {isLoading ? <p>Cargando ex√°menes...</p> : (
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Colaborador</th>
                                    <th>C√©dula</th>
                                    <th>Tipo Examen</th>
                                    <th>Concepto</th>
                                    <th style={{textAlign:'center'}}>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {examenesFiltrados.length === 0 ? (
                                    <tr><td colSpan="6" style={{textAlign:'center', padding:'2rem', color:'#999'}}>No se encontraron registros.</td></tr>
                                ) : (
                                    examenesFiltrados.map((ex) => (
                                        <tr key={ex.ID_ExamenMedico}>
                                            <td>{formatearFecha(ex.FechaExamen)}</td>
                                            <td><strong>{ex.NombreColaborador}</strong></td>
                                            <td>{ex.CedulaColaborador}</td>
                                            <td><span style={{display:'flex', alignItems:'center', gap:'5px'}}><BsHeartPulseFill style={{color:'#e91e63'}}/> {ex.TipoExamen}</span></td>
                                            <td>
                                                <span className={`status-pill ${getConceptoClass(ex.ConceptoAptitud)}`}>
                                                    {ex.ConceptoAptitud}
                                                </span>
                                            </td>
                                            <td style={{textAlign:'center'}}>
                                                <div style={{display:'flex', gap:'5px', justifyContent:'center'}}>
                                                    {/* Bot√≥n VER DETALLE */}
                                                    <button 
                                                        className="btn btn-sm btn-secondary" 
                                                        onClick={() => abrirModalVer(ex)}
                                                        title="Ver Detalle Completo"
                                                    >
                                                        <BsEyeFill />
                                                    </button>

                                                    {/* Bot√≥n GENERAR PDF */}
                                                    <button 
                                                        className="btn btn-sm btn-warning" 
                                                        onClick={() => abrirModalPdf(ex)}
                                                        title="Generar Acta/PDF"
                                                        style={{color:'#333'}}
                                                    >
                                                        <BsFileEarmarkPdf />
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>

            {/* --- MODALES --- */}
            
            {modalRegistrarOpen && (
                <ModalRegistrarExamen 
                    alCerrar={() => setModalRegistrarOpen(false)} 
                    alExito={handleExamenRegistrado} 
                />
            )}

            {modalVerOpen && examenSeleccionado && (
                <ModalVerExamen 
                    examenId={examenSeleccionado.ID_ExamenMedico} 
                    alCerrar={() => setModalVerOpen(false)} 
                />
            )}

            {/* CORRECCI√ìN: Renderizado Condicional Seguro */}
            {modalPdfOpen && examenSeleccionado && (
                <ModalGenerarPdfMedico 
                    examen={examenSeleccionado} 
                    alCerrar={() => setModalPdfOpen(false)} 
                />
            )}

        </div>
    );
};

export default MedicinaLaboralPage;


==================================================================
ARCHIVO: frontend\src\pages\PesvPage.jsx
==================================================================
// frontend/src/pages/PesvPage.jsx

import React, { useState, useEffect } from 'react';
import { getConductoresPESV, getMantenimientos } from '../services/pesvService';
import { getActivosTodos } from '../services/assetService';
import '../index.css';
import { 
    BsConeStriped, BsPersonBadge, BsTools, BsTruck, 
    BsCheckCircle, BsPencilSquare, BsPersonPlusFill, BsEyeFill, BsPlusLg, BsInfoCircle 
} from 'react-icons/bs';
import Swal from 'sweetalert2';

// Importamos los componentes hijos
import ModalGestionConductor from '../components/ModalGestionConductor';
import ModalCrearMantenimiento from '../components/ModalCrearMantenimiento';
import TabPasosPESV from '../components/TabPasosPESV'; 
import ModalCrearUsuario from '../components/ModalCrearUsuario'; 
import ModalVerMantenimiento from '../components/ModalVerMantenimiento'; // <--- IMPORTANTE

const PesvPage = () => {
    // URL Base para abrir los documentos adjuntos
    const API_BASE_URL = 'http://localhost:5000';

    // Estado de Pesta√±as
    const [activeTab, setActiveTab] = useState('implementacion'); 
    
    // Estados de Datos
    const [conductores, setConductores] = useState([]);
    const [mantenimientos, setMantenimientos] = useState([]);
    const [vehiculos, setVehiculos] = useState([]);
    const [isLoading, setIsLoading] = useState(false);

    // Estados de Modales
    const [modalConductorOpen, setModalConductorOpen] = useState(false);
    const [conductorSelected, setConductorSelected] = useState(null);
    
    // Modales de Mantenimiento
    const [modalMtoOpen, setModalMtoOpen] = useState(false);
    const [modalVerMtoOpen, setModalVerMtoOpen] = useState(false); // Estado para ver detalle
    const [mtoSeleccionado, setMtoSeleccionado] = useState(null); // Mto seleccionado para ver

    // Estados para crear usuario (Flujo continuo)
    const [modalCrearUsuarioOpen, setModalCrearUsuarioOpen] = useState(false);
    const [usuarioPrellenado, setUsuarioPrellenado] = useState(null);

    // Cargar datos al cambiar de pesta√±a
    useEffect(() => {
        cargarDatos();
    }, [activeTab]);

    const cargarDatos = async () => {
        if (activeTab === 'implementacion') return;

        setIsLoading(true);
        try {
            if (activeTab === 'conductores') {
                const data = await getConductoresPESV();
                setConductores(data);
                setIsLoading(false); 
                return data; 
            } 
            else if (activeTab === 'vehiculos') {
                const allActivos = await getActivosTodos();
                // Filtramos solo lo que rueda
                const vehs = allActivos.filter(v => ['Vehiculo', 'Moto', 'Montacarga'].includes(v.TipoActivo));
                setVehiculos(vehs);
            }
            else if (activeTab === 'mantenimientos') {
                const mtos = await getMantenimientos();
                const allActivos = await getActivosTodos();
                setMantenimientos(mtos);
                setVehiculos(allActivos.filter(v => ['Vehiculo', 'Moto', 'Montacarga'].includes(v.TipoActivo)));
            }
        } catch (error) {
            console.error(error);
        } finally {
            setIsLoading(false);
        }
    };

    // --- MANEJADORES DE CONDUCTORES ---

    const abrirEditarConductor = (c) => {
        setConductorSelected(c);
        setModalConductorOpen(true);
    };

    const handleConductorGuardado = () => {
        setModalConductorOpen(false);
        setConductorSelected(null);
        cargarDatos(); 
    };
    
    const abrirCrearUsuario = (c) => {
        setUsuarioPrellenado({
            NombreCompleto: c.NombreCompleto,
            CedulaUsuario: c.CedulaUsuario,
            Cargo: c.Cargo
        });
        setModalCrearUsuarioOpen(true);
    };

    const handleUsuarioCreado = async (cedulaCreada) => {
        setModalCrearUsuarioOpen(false);
        setUsuarioPrellenado(null);

        Swal.fire({
            title: '¬°Usuario Activado!',
            text: 'Preparando formulario de licencia...',
            icon: 'success',
            timer: 1000,
            showConfirmButton: false
        });

        const listaActualizada = await cargarDatos();

        if (listaActualizada && cedulaCreada) {
            const nuevoConductor = listaActualizada.find(c => c.CedulaUsuario === cedulaCreada);
            if (nuevoConductor && nuevoConductor.ID_Usuario) {
                setTimeout(() => {
                    abrirEditarConductor(nuevoConductor);
                }, 800);
            }
        }
    };

    // --- MANEJADORES DE MANTENIMIENTOS ---

    const handleMtoCreado = () => {
        setModalMtoOpen(false);
        cargarDatos(); 
    };

    const abrirVerMto = (m) => {
        setMtoSeleccionado(m);
        setModalVerMtoOpen(true);
    };

    // --- HELPERS ---

    const isVencido = (fechaISO) => {
        if (!fechaISO) return false;
        const fecha = new Date(fechaISO).setHours(0,0,0,0);
        const hoy = new Date().setHours(0,0,0,0);
        return fecha < hoy;
    };

    const abrirDocumento = (ruta) => {
        if (!ruta) return;
        const rutaLimpia = ruta.replace(/\\/g, '/'); 
        const urlCompleta = `${API_BASE_URL}/${rutaLimpia}`;
        window.open(urlCompleta, '_blank');
    };

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>
                    <BsConeStriped style={{color:'#fd7e14', marginRight:'10px'}} /> 
                    Plan Estrat√©gico de Seguridad Vial (PESV)
                </h1>
            </div>

            {/* --- NAVEGACI√ìN (TABS) --- */}
            <div style={{display:'flex', gap:'0.5rem', marginBottom:'2rem', borderBottom:'2px solid #dee2e6', flexWrap: 'wrap'}}>
                <button 
                    className={`btn ${activeTab === 'implementacion' ? 'btn-primary' : 'btn-secondary'}`} 
                    onClick={() => setActiveTab('implementacion')}
                    style={{borderRadius:'8px 8px 0 0', borderBottom: 'none'}}
                >
                    <BsCheckCircle /> Implementaci√≥n
                </button>
                <button 
                    className={`btn ${activeTab === 'conductores' ? 'btn-primary' : 'btn-secondary'}`} 
                    onClick={() => setActiveTab('conductores')}
                    style={{borderRadius:'8px 8px 0 0', borderBottom: 'none'}}
                >
                    <BsPersonBadge /> Conductores
                </button>
                <button 
                    className={`btn ${activeTab === 'vehiculos' ? 'btn-primary' : 'btn-secondary'}`} 
                    onClick={() => setActiveTab('vehiculos')}
                    style={{borderRadius:'8px 8px 0 0', borderBottom: 'none'}}
                >
                    <BsTruck /> Veh√≠culos
                </button>
                <button 
                    className={`btn ${activeTab === 'mantenimientos' ? 'btn-primary' : 'btn-secondary'}`} 
                    onClick={() => setActiveTab('mantenimientos')}
                    style={{borderRadius:'8px 8px 0 0', borderBottom: 'none'}}
                >
                    <BsTools /> Mantenimientos
                </button>
            </div>

            {/* --- CONTENIDO --- */}
            <div className="page-content-card">
                
                {/* TAB 1: IMPLEMENTACI√ìN */}
                {activeTab === 'implementacion' && <TabPasosPESV />}

                {/* TAB 2: CONDUCTORES */}
                {activeTab === 'conductores' && (
                    <>
                        {isLoading ? <p>Sincronizando con N√≥mina (Gosen)...</p> : (
                            <div className="table-wrapper">
                                <div style={{marginBottom:'10px', fontSize:'0.85rem', color:'#666', backgroundColor:'#e7f3ff', padding:'10px', borderRadius:'6px', border:'1px solid #b6d4fe'}}>
                                    <strong>‚ÑπÔ∏è Sincronizaci√≥n:</strong> Se visualizan colaboradores con cargos de <strong>Conductor, Chofer, Transportador y Maquinaria</strong>.
                                </div>
                                <table className="data-table">
                                    <thead>
                                        <tr>
                                            <th>Estado</th>
                                            <th>Nombre</th>
                                            <th>C√©dula</th>
                                            <th>Cargo (N√≥mina)</th>
                                            <th>Licencia</th>
                                            <th>Categor√≠a</th>
                                            <th>Vencimiento</th>
                                            <th>Acci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {conductores.map((c, idx) => (
                                            <tr key={idx}>
                                                <td>
                                                    {c.EstadoRegistro === 'Registrado' ? (
                                                        <span className="status-pill status-activo">En Sistema</span>
                                                    ) : (
                                                        <span className="status-pill status-pendiente">Pendiente</span>
                                                    )}
                                                </td>
                                                <td><strong>{c.NombreCompleto}</strong></td>
                                                <td>{c.CedulaUsuario}</td>
                                                <td>{c.Cargo}</td>
                                                <td>{c.NumeroLicencia || '--'}</td>
                                                <td>{c.Categoria || '--'}</td>
                                                <td>
                                                    {c.VencimientoLicencia ? (
                                                        <span className={`status-pill ${isVencido(c.VencimientoLicencia) ? 'status-inactivo' : 'status-activo'}`}>
                                                            {new Date(c.VencimientoLicencia).toLocaleDateString()}
                                                        </span>
                                                    ) : <span style={{color:'#999'}}>--</span>}
                                                </td>
                                                <td style={{display: 'flex', gap: '5px'}}>
                                                    {c.ID_Usuario ? (
                                                        <>
                                                            <button 
                                                                className="btn btn-sm btn-secondary" 
                                                                onClick={() => abrirEditarConductor(c)}
                                                                title="Editar datos de licencia"
                                                            >
                                                                <BsPencilSquare /> Gestionar
                                                            </button>

                                                            {c.RutaLicencia && (
                                                                <button 
                                                                    className="btn btn-sm"
                                                                    onClick={() => abrirDocumento(c.RutaLicencia)}
                                                                    title="Ver Licencia Adjunta"
                                                                    style={{backgroundColor: '#17a2b8', color: 'white', border: 'none', display: 'flex', alignItems: 'center', justifyContent: 'center'}}
                                                                >
                                                                    <BsEyeFill />
                                                                </button>
                                                            )}
                                                        </>
                                                    ) : (
                                                        <button 
                                                            className="btn btn-sm btn-primary" 
                                                            onClick={() => abrirCrearUsuario(c)}
                                                            title="Habilitar usuario en el sistema"
                                                        >
                                                            <BsPersonPlusFill /> Crear Usuario
                                                        </button>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </>
                )}

                {/* TAB 3: VEH√çCULOS */}
                {activeTab === 'vehiculos' && (
                    <>
                        {isLoading ? <p>Cargando flota...</p> : (
                            <div className="table-wrapper">
                                <table className="data-table">
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>Placa / ID</th>
                                            <th>Descripci√≥n</th>
                                            <th>Kilometraje</th>
                                            <th>Venc. SOAT</th>
                                            <th>Venc. Tecno</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {vehiculos.map(v => (
                                            <tr key={v.ID_Activo}>
                                                <td>{v.TipoActivo}</td>
                                                <td><strong>{v.CodigoIdentificador}</strong></td>
                                                <td>{v.NombreDescriptivo}</td>
                                                <td style={{color:'#007BFF', fontWeight:'bold'}}>
                                                    {v.KilometrajeActual ? v.KilometrajeActual.toLocaleString() : 0} km
                                                </td>
                                                <td>
                                                    {v.SOAT_Vencimiento ? (
                                                        <span className={`status-pill ${isVencido(v.SOAT_Vencimiento) ? 'status-inactivo' : 'status-activo'}`}>
                                                            {new Date(v.SOAT_Vencimiento).toLocaleDateString()}
                                                        </span>
                                                    ) : '--'}
                                                </td>
                                                <td>
                                                    {v.Tecno_Vencimiento ? (
                                                        <span className={`status-pill ${isVencido(v.Tecno_Vencimiento) ? 'status-inactivo' : 'status-activo'}`}>
                                                            {new Date(v.Tecno_Vencimiento).toLocaleDateString()}
                                                        </span>
                                                    ) : '--'}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </>
                )}

                {/* TAB 4: MANTENIMIENTOS */}
                {activeTab === 'mantenimientos' && (
                    <>
                        <div style={{marginBottom:'1rem'}}>
                            <button className="btn btn-primary" onClick={() => setModalMtoOpen(true)}>
                                <BsPlusLg /> Registrar Mantenimiento
                            </button>
                        </div>
                        
                        {isLoading ? <p>Cargando historial...</p> : (
                            <div className="table-wrapper">
                                <table className="data-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Veh√≠culo</th>
                                            <th>Tipo</th>
                                            <th>Descripci√≥n</th>
                                            <th>Taller</th>
                                            <th>Costo</th>
                                            <th style={{textAlign: 'center'}}>Ver</th> {/* COLUMNA NUEVA */}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {mantenimientos.length === 0 ? (
                                            <tr><td colSpan="7" style={{textAlign:'center'}}>No hay mantenimientos registrados.</td></tr>
                                        ) : (
                                            mantenimientos.map(m => (
                                                <tr key={m.ID_Mantenimiento}>
                                                    <td>{new Date(m.Fecha).toLocaleDateString()}</td>
                                                    <td>{m.Vehiculo} ({m.Placa})</td>
                                                    <td>
                                                        <span className={`status-pill ${m.TipoMantenimiento === 'Preventivo' ? 'status-activo' : 'status-inactivo'}`}>
                                                            {m.TipoMantenimiento}
                                                        </span>
                                                    </td>
                                                    <td>{m.Descripcion.substring(0, 30)}...</td>
                                                    <td>{m.Taller_Realizo || 'Interno'}</td>
                                                    <td>${(m.Costo || 0).toLocaleString()}</td>
                                                    <td style={{textAlign: 'center'}}>
                                                        <button 
                                                            className="btn btn-sm btn-secondary"
                                                            onClick={() => abrirVerMto(m)}
                                                            title="Ver Detalle y Evidencia"
                                                            style={{
                                                                display: 'inline-flex',
                                                                alignItems: 'center',
                                                                gap: '5px'
                                                            }}
                                                        >
                                                            <BsInfoCircle /> Detalle
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </>
                )}
            </div>

            {/* --- MODALES --- */}
            {modalConductorOpen && (
                <ModalGestionConductor 
                    conductor={conductorSelected} 
                    alCerrar={() => setModalConductorOpen(false)} 
                    alExito={handleConductorGuardado} 
                />
            )}
            
            {modalMtoOpen && (
                <ModalCrearMantenimiento 
                    vehiculos={vehiculos} 
                    alCerrar={() => setModalMtoOpen(false)} 
                    alExito={handleMtoCreado} 
                />
            )}

            {modalCrearUsuarioOpen && (
                <ModalCrearUsuario 
                    alCerrar={() => setModalCrearUsuarioOpen(false)} 
                    alExito={handleUsuarioCreado} 
                    initialData={usuarioPrellenado} 
                />
            )}

            {/* MODAL DE VER DETALLE (NUEVO) */}
            {modalVerMtoOpen && (
                <ModalVerMantenimiento 
                    mantenimiento={mtoSeleccionado} 
                    alCerrar={() => setModalVerMtoOpen(false)} 
                />
            )}
        </div>
    );
};

export default PesvPage;


==================================================================
ARCHIVO: frontend\src\pages\PlanificacionPage.jsx
==================================================================
// frontend/src/pages/PlanificacionPage.jsx

import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { 
    getCronogramas, 
    getActividadesPorCronograma, 
    // eslint-disable-next-line no-unused-vars
    eliminarActividad,
    eliminarCronograma 
} from '../services/scheduleService';
import { getACPMs } from '../services/acpmService'; 
import { Calendar, dateFnsLocalizer, Views } from 'react-big-calendar';
import format from 'date-fns/format';
import parse from 'date-fns/parse';
import startOfWeek from 'date-fns/startOfWeek';
import getDay from 'date-fns/getDay';
import es from 'date-fns/locale/es'; 
import 'react-big-calendar/lib/css/react-big-calendar.css'; 

import '../index.css'; 
import '../style/PlanificacionPage.css'; 
import { BsEyeFill, BsPlusLg, BsTrash, BsSearch, BsInfoCircle } from 'react-icons/bs'; 
import Swal from 'sweetalert2'; 

// Modales
import ModalCrearCronograma from '../components/ModalCrearCronograma.jsx';
import ModalCrearActividad from '../components/ModalCrearActividad.jsx';
import ModalEditarActividad from '../components/ModalEditarActividad.jsx';
import ModalConfirmarAccion from '../components/ModalConfirmarAccion.jsx'; 
import ModalGestionarActividad from '../components/ModalGestionarActividad.jsx';
import ModalVerEvidencias from '../components/ModalVerEvidencias.jsx';
import ModalDetalleActividad from '../components/ModalDetalleActividad.jsx';
import ModalVerACPM from '../components/ModalVerACPM.jsx'; 

const locales = { 'es': es };
const localizer = dateFnsLocalizer({ format, parse, startOfWeek: () => startOfWeek(new Date(), { weekStartsOn: 1 }), getDay, locales });
const messages = { allDay: 'Todo el d√≠a', previous: 'Anterior', next: 'Siguiente', today: 'Hoy', month: 'Mes', week: 'Semana', day: 'D√≠a', agenda: 'Agenda', date: 'Fecha', time: 'Hora', event: 'Evento', noEventsInRange: 'No hay eventos en este rango.'};

const parseDateAsLocal = (dateString) => {
    if (!dateString) return null;
    try { 
        const datePart = dateString.split('T')[0]; 
        const [year, month, day] = datePart.split('-'); 
        return new Date(year, month - 1, day); 
    // eslint-disable-next-line no-unused-vars
    } catch (e) { return new Date(dateString); }
};

const PlanificacionPage = () => {
    const [cronogramas, setCronogramas] = useState([]);
    const [cronogramaSeleccionado, setCronogramaSeleccionado] = useState(null);
    const [cronogramaDescripcion, setCronogramaDescripcion] = useState(''); 
    
    const [actividades, setActividades] = useState([]);
    const [acpms, setAcpms] = useState([]); 

    const [isLoadingCronogramas, setIsLoadingCronogramas] = useState(true);
    const [isLoadingActividades, setIsLoadingActividades] = useState(false);
    const [error, setError] = useState(null);

    const [busqueda, setBusqueda] = useState('');
    const [filtroEstado, setFiltroEstado] = useState(''); 
    
    const [modalCronogramaAbierto, setModalCronogramaAbierto] = useState(false);
    const [modalActividadAbierto, setModalActividadAbierto] = useState(false);
    const [modalEditarAbierto, setModalEditarAbierto] = useState(false);
    const [modalConfirmarAbierto, setModalConfirmarAbierto] = useState(false);
    const [modalGestionarAbierto, setModalGestionarAbierto] = useState(false);
    const [modalEvidenciaAbierto, setModalEvidenciaAbierto] = useState(false);
    const [modalDetalleAbierto, setModalDetalleAbierto] = useState(false);
    const [modalVerACPMAbierto, setModalVerACPMAbierto] = useState(false); 
    const [acpmSeleccionadaId, setAcpmSeleccionadaId] = useState(null);

    const [itemAEliminar, setItemAEliminar] = useState(null); 
    const [actividadSeleccionada, setActividadSeleccionada] = useState(null); 
    
    const [calendarDate, setCalendarDate] = useState(new Date());
    const [calendarView, setCalendarView] = useState(Views.MONTH);
    
    // --- Carga Inicial ---
    const cargarDatosIniciales = useCallback(async () => {
        try {
            setIsLoadingCronogramas(true);
            const dataCronos = await getCronogramas();
            setCronogramas(dataCronos);
            const dataAcpms = await getACPMs();
            setAcpms(dataAcpms);

            if (dataCronos.length > 0 && !cronogramaSeleccionado) {
                const primerId = dataCronos[0].ID_Cronograma;
                handleSeleccionarCronograma(primerId, dataCronos); 
            }
        } catch (err) { setError(err.message); } finally { setIsLoadingCronogramas(false); }
    }, [cronogramaSeleccionado]); 
    
    useEffect(() => { cargarDatosIniciales(); }, []); 
    
    const handleSeleccionarCronograma = useCallback(async (idCronograma, cronogramasData = cronogramas) => {
        if (!idCronograma) return;
        setCronogramaSeleccionado(idCronograma); 
        const crono = cronogramasData.find(c => c.ID_Cronograma == idCronograma);
        setCronogramaDescripcion(crono?.Descripcion || 'Este cronograma no tiene descripci√≥n.');
        setIsLoadingActividades(true);
        setError(null);
        setActividades([]); 
        try {
            const data = await getActividadesPorCronograma(idCronograma);
            setActividades(data);
        } catch (err) { setError(err.message); } finally { setIsLoadingActividades(false); }
    }, [cronogramas]); 

    // --- Filtros ---
    const actividadesFiltradas = useMemo(() => {
        return actividades.filter(act => {
            const texto = busqueda.toLowerCase();
            const matchTexto = 
                act.NombreActividad.toLowerCase().includes(texto) ||
                (act.DescripcionActividad && act.DescripcionActividad.toLowerCase().includes(texto)) ||
                (act.Responsable && act.Responsable.toLowerCase().includes(texto));
            const matchEstado = filtroEstado ? act.EstadoActividad === filtroEstado : true;
            return matchTexto && matchEstado;
        });
    }, [actividades, busqueda, filtroEstado]);

    // --- C√°lculo de Totales para la Leyenda ---
    const totales = useMemo(() => {
        return {
            pendientes: actividades.filter(a => a.EstadoActividad === 'Pendiente').length,
            realizadas: actividades.filter(a => a.EstadoActividad === 'Realizada').length,
            canceladas: actividades.filter(a => a.EstadoActividad === 'Cancelada').length,
            acpmAbiertas: acpms.filter(a => a.EstadoACPM !== 'Cerrada').length,
            acpmCerradas: acpms.filter(a => a.EstadoACPM === 'Cerrada').length
        };
    }, [actividades, acpms]);

    // --- Calendario ---
    const calendarEvents = useMemo(() => {
        // 1. Actividades
        const eventosActividades = actividadesFiltradas.map(act => ({
            title: act.NombreActividad, 
            start: parseDateAsLocal(act.FechaLimite), 
            end: parseDateAsLocal(act.FechaLimite), 
            allDay: true, 
            tipo: 'ACTIVIDAD', 
            resource: act 
        }));

        // 2. ACPMs
        const eventosACPM = acpms.map(acpm => {
            const isCerrada = acpm.EstadoACPM === 'Cerrada';
            const fechaEvento = isCerrada && acpm.FechaCierre ? acpm.FechaCierre : acpm.FechaLimite;
            
            return {
                title: `ACPM: ${acpm.Origen} (${acpm.EstadoACPM})`, 
                start: parseDateAsLocal(fechaEvento),
                end: parseDateAsLocal(fechaEvento),
                allDay: true,
                tipo: 'ACPM', 
                resource: acpm
            };
        });

        return [...eventosActividades, ...eventosACPM];
    }, [actividadesFiltradas, acpms]); 

    const onCalendarNavigate = useCallback((newDate) => setCalendarDate(newDate), [setCalendarDate]);
    const onCalendarView = useCallback((newView) => setCalendarView(newView), [setCalendarView]);
    
    const handleSelectEvent = (event) => {
        if (event.tipo === 'ACPM') {
            setAcpmSeleccionadaId(event.resource.ID_ACPM);
            setModalVerACPMAbierto(true);
        } else {
            const actividad = event.resource;
            if (actividad.EstadoActividad === 'Realizada' || actividad.EstadoActividad === 'Cancelada') {
                abrirModalDetalle(actividad);
            } else {
                abrirModalGestionar(actividad);
            }
        }
    };

    const eventStyleGetter = (event) => {
        let backgroundColor = '#3174ad'; 
        
        if (event.tipo === 'ACPM') {
            backgroundColor = event.resource.EstadoACPM === 'Cerrada' ? '#6c757d' : '#fd7e14';
        } else {
            if (event.resource.EstadoActividad === 'Realizada') backgroundColor = '#28a745'; 
            else if (event.resource.EstadoActividad === 'Cancelada') backgroundColor = '#dc3545'; 
        }

        return { style: { backgroundColor, borderRadius: '5px', opacity: 0.9, color: 'white', border: '0px', display: 'block', fontSize: '0.85rem' } };
    };

    const refrescarActividades = () => { if (cronogramaSeleccionado) { handleSeleccionarCronograma(cronogramaSeleccionado); } };
    const handleCronogramaCreado = () => { setModalCronogramaAbierto(false); cargarDatosIniciales(); };
    const handleActividadCreada = () => { setModalActividadAbierto(false); refrescarActividades(); };
    const abrirModalEditar = (actividad) => { setActividadSeleccionada(actividad); setModalEditarAbierto(true); };
    const cerrarModalEditar = () => { setModalEditarAbierto(false); setActividadSeleccionada(null); };
    const handleActividadEditada = () => { cerrarModalEditar(); refrescarActividades(); };
    const abrirModalGestionar = (actividad) => { setActividadSeleccionada(actividad); setModalGestionarAbierto(true); };
    const cerrarModalGestionar = () => { setModalGestionarAbierto(false); setActividadSeleccionada(null); };
    const handleActividadGestionada = () => { cerrarModalGestionar(); refrescarActividades(); };
    const abrirModalEvidencia = (actividad) => { setActividadSeleccionada(actividad); setModalEvidenciaAbierto(true); };
    const cerrarModalEvidencia = () => { setModalEvidenciaAbierto(false); setActividadSeleccionada(null); };
    const abrirModalDetalle = (actividad) => { setActividadSeleccionada(actividad); setModalDetalleAbierto(true); };
    const cerrarModalDetalle = () => { setModalDetalleAbierto(false); setActividadSeleccionada(null); };
    
    // Solo dejamos la eliminaci√≥n de cronogramas
    const abrirModalEliminarCronograma = () => {
        if (!cronogramaSeleccionado) return;
        const crono = cronogramas.find(c => c.ID_Cronograma == cronogramaSeleccionado);
        if (crono) { setItemAEliminar({ tipo: 'cronograma', data: crono }); setModalConfirmarAbierto(true); }
    };
    const cerrarModalEliminar = () => { setModalConfirmarAbierto(false); setItemAEliminar(null); };

    const handleConfirmarEliminacion = async () => {
        if (!itemAEliminar) return;
        // eslint-disable-next-line no-useless-catch
        try {
            if (itemAEliminar.tipo === 'cronograma') {
                await eliminarCronograma(itemAEliminar.data.ID_Cronograma);
                setCronogramaSeleccionado(null); cargarDatosIniciales(); 
            }
        } catch (err) { throw err; }
    };

    const formatearFecha = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        const fecha = parseDateAsLocal(fechaISO);
        return fecha.toLocaleDateString('es-CO');
    };

    return (
        <div className="page-container">
            {/* --- Encabezado --- */}
            <div className="page-header">
                <h1>Planificaci√≥n (Cronogramas y Actividades)</h1>
                <div className="header-actions">
                    <button className="btn btn-secondary" onClick={() => setModalCronogramaAbierto(true)}>
                        <BsPlusLg /> Crear Cronograma
                    </button>
                    <button className="btn btn-primary" disabled={!cronogramaSeleccionado} onClick={() => setModalActividadAbierto(true)}>
                        <BsPlusLg /> A√±adir Actividad
                    </button>
                    {cronogramaSeleccionado && (
                        <button className="btn btn-danger" onClick={abrirModalEliminarCronograma} title="Eliminar el cronograma actual">
                            <BsTrash /> Eliminar Cronograma
                        </button>
                    )}
                </div>
            </div>

            {/* --- Selector de Cronograma --- */}
            <div className="cronograma-selector-container" style={{ marginBottom: '1.5rem', background: 'white', padding: '1rem', borderRadius: '8px', border: '1px solid #eee' }}>
                <div className="form-group" style={{ marginBottom: 0 }}>
                    <label htmlFor="cronograma" style={{ marginBottom: '0.5rem' }}>Seleccione un Cronograma:</label>
                    <select 
                        id="cronograma"
                        className="form-control"
                        value={cronogramaSeleccionado || ''}
                        onChange={(e) => handleSeleccionarCronograma(e.target.value)}
                        disabled={isLoadingCronogramas}
                    >
                        <option value="" disabled>-- Seleccione --</option>
                        {cronogramas.map(c => (
                            <option key={c.ID_Cronograma} value={c.ID_Cronograma}>
                                {c.NombreCronograma} ({c.AnioAplicacion || 'N/A'})
                            </option>
                        ))}
                    </select>
                </div>
                {cronogramaDescripcion && (
                    <p className="cronograma-descripcion" style={{ marginTop: '0.5rem', color: '#666', fontStyle: 'italic' }}>
                        {cronogramaDescripcion}
                    </p>
                )}
            </div>

            {/* --- CALENDARIO INTEGRADO (PRIMERO) --- */}
            <div className="page-content-card calendar-card" style={{marginBottom: '2rem'}}>
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem', flexWrap:'wrap', gap:'10px'}}>
                    <h2 style={{margin:0}}>Calendario General</h2>
                    
                    {/* --- LEYENDA CON CONTADORES --- */}
                    <div style={{display: 'flex', gap: '1rem', fontSize: '0.9rem', flexWrap:'wrap'}}>
                        <span title="Actividades Pendientes" style={{display: 'flex', alignItems: 'center', gap: '5px'}}>
                            <span style={{width: 10, height: 10, background: '#3174ad', borderRadius: '50%'}}></span> 
                            Pendientes <strong>({totales.pendientes})</strong>
                        </span>
                        <span title="Actividades Realizadas" style={{display: 'flex', alignItems: 'center', gap: '5px'}}>
                            <span style={{width: 10, height: 10, background: '#28a745', borderRadius: '50%'}}></span> 
                            Realizadas <strong>({totales.realizadas})</strong>
                        </span>
                        <span title="Actividades Canceladas" style={{display: 'flex', alignItems: 'center', gap: '5px'}}>
                            <span style={{width: 10, height: 10, background: '#dc3545', borderRadius: '50%'}}></span> 
                            Canceladas <strong>({totales.canceladas})</strong>
                        </span>
                        <span title="ACPM en curso" style={{display: 'flex', alignItems: 'center', gap: '5px'}}>
                            <span style={{width: 10, height: 10, background: '#fd7e14', borderRadius: '50%'}}></span> 
                            ACPM (Abierta) <strong>({totales.acpmAbiertas})</strong>
                        </span>
                        <span title="ACPM Cerradas" style={{display: 'flex', alignItems: 'center', gap: '5px'}}>
                            <span style={{width: 10, height: 10, background: '#6c757d', borderRadius: '50%'}}></span> 
                            ACPM (Cerrada) <strong>({totales.acpmCerradas})</strong>
                        </span>
                    </div>
                </div>
                
                {isLoadingActividades ? (
                    <p>Cargando calendario...</p>
                ) : (
                    <Calendar
                        localizer={localizer}
                        events={calendarEvents}
                        startAccessor="start"
                        endAccessor="end"
                        style={{ height: 600 }}
                        culture="es" 
                        messages={messages}
                        onSelectEvent={handleSelectEvent}
                        eventPropGetter={eventStyleGetter}
                        date={calendarDate}
                        view={calendarView} 
                        onNavigate={onCalendarNavigate}
                        onView={onCalendarView}
                    />
                )}
            </div>

            {/* --- BARRA DE FILTROS --- */}
            <div className="filters-bar" style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                <div className="search-input-container" style={{ flex: 1, minWidth: '250px', position: 'relative' }}>
                    <BsSearch style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#aaa' }} />
                    <input type="text" className="form-control" placeholder="Buscar actividad, descripci√≥n o responsable..." style={{ paddingLeft: '35px', height: '40px' }} value={busqueda} onChange={(e) => setBusqueda(e.target.value)} />
                </div>
                <div className="filter-select-container" style={{ minWidth: '200px' }}>
                    <select className="form-control" style={{ height: '40px' }} value={filtroEstado} onChange={(e) => setFiltroEstado(e.target.value)}>
                        <option value="">Todos los Estados</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Realizada">Realizada</option>
                        <option value="Cancelada">Cancelada</option>
                    </select>
                </div>
            </div>

            {/* --- TABLA DE ACTIVIDADES --- */}
            <div className="page-content-card">
                <h2>Listado de Actividades</h2>
                <div className="table-wrapper">
                    {!isLoadingActividades && !error && (
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Actividad</th>
                                    <th>Descripci√≥n</th> 
                                    <th>Responsable</th>
                                    <th>Fecha L√≠mite</th>
                                    <th>Estado</th>
                                    <th>Evidencia</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {actividades.length === 0 && (
                                    <tr><td colSpan="8" style={{ textAlign: 'center' }}>{cronogramaSeleccionado ? 'Este cronograma a√∫n no tiene actividades.' : 'Por favor, seleccione un cronograma.'}</td></tr>
                                )}
                                {actividadesFiltradas.map((act) => (
                                    <tr key={act.ID_Actividad}>
                                        <td title={act.NombreActividad}>{act.NombreActividad.substring(0, 30)}{act.NombreActividad.length > 30 ? '...' : ''}</td>
                                        <td title={act.DescripcionActividad}>{act.DescripcionActividad?.substring(0, 20) || 'N/A'}{act.DescripcionActividad?.length > 20 ? '...' : ''}</td>
                                        <td>{act.Responsable}</td>
                                        <td>{formatearFecha(act.FechaLimite)}</td>
                                        <td><span className={`status-pill ${
                                            act.EstadoActividad === 'Realizada' ? 'status-activo' :
                                            act.EstadoActividad === 'Pendiente' ? 'status-pendiente' : 'status-inactivo'
                                        }`}>{act.EstadoActividad}</span></td>
                                        
                                        <td>
                                            {act.EstadoActividad === 'Realizada' ? (
                                                <button 
                                                    className="btn btn-icon" 
                                                    onClick={() => abrirModalEvidencia(act)} 
                                                    title="Ver Evidencias"
                                                    style={{ color: '#6c757d', border: '1px solid #6c757d' }}
                                                >
                                                    <BsEyeFill /> Ver
                                                </button>
                                            ) : <span style={{ color: '#999', fontSize: '0.8rem' }}>-</span>}
                                        </td>

                                        <td className="action-buttons">
                                            <button 
                                                className="btn btn-secondary" 
                                                onClick={() => abrirModalDetalle(act)} 
                                                title="Ver Detalle Completo"
                                            >
                                                <BsInfoCircle /> Ver Detalle
                                            </button>

                                            {act.EstadoActividad !== 'Realizada' && act.EstadoActividad !== 'Cancelada' && (
                                                <>
                                                    <button className="btn btn-secondary" onClick={() => abrirModalGestionar(act)} title="Cambiar Estado">Gestionar</button>
                                                    <button className="btn btn-warning" onClick={() => abrirModalEditar(act)} title="Editar Datos">Editar</button>
                                                    {/* El bot√≥n de eliminar actividad se ha retirado */}
                                                </>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div> 
            </div>
            
            {/* Modales */}
            {modalCronogramaAbierto && <ModalCrearCronograma alCerrar={() => setModalCronogramaAbierto(false)} alExito={handleCronogramaCreado} />}
            {modalActividadAbierto && <ModalCrearActividad idCronograma={cronogramaSeleccionado} alCerrar={() => setModalActividadAbierto(false)} alExito={handleActividadCreada} />}
            {modalEditarAbierto && <ModalEditarActividad actividad={actividadSeleccionada} alCerrar={cerrarModalEditar} alExito={handleActividadEditada} />}
            {modalConfirmarAbierto && <ModalConfirmarAccion titulo={itemAEliminar?.tipo === 'cronograma' ? 'Eliminar Cronograma' : 'Eliminar Actividad'} mensaje={itemAEliminar?.tipo === 'cronograma' ? `¬øEliminar cronograma?` : `¬øEliminar actividad?`} enConfirmar={handleConfirmarEliminacion} alCerrar={cerrarModalEliminar} textoBotonConfirmar="Eliminar" claseBoton="btn-danger" />}
            {modalGestionarAbierto && <ModalGestionarActividad actividad={actividadSeleccionada} alCerrar={cerrarModalGestionar} alExito={handleActividadGestionada} />}
            {modalEvidenciaAbierto && <ModalVerEvidencias actividad={actividadSeleccionada} alCerrar={cerrarModalEvidencia} />}
            {modalDetalleAbierto && <ModalDetalleActividad actividad={actividadSeleccionada} alCerrar={cerrarModalDetalle} />}
            {modalVerACPMAbierto && <ModalVerACPM acpmId={acpmSeleccionadaId} alCerrar={() => setModalVerACPMAbierto(false)} />}
        </div>
    );
};

export default PlanificacionPage;


==================================================================
ARCHIVO: frontend\src\pages\PresupuestoPage.jsx
==================================================================
// frontend/src/pages/PresupuestoPage.jsx

import React, { useState, useEffect } from 'react';
import { 
    getPresupuestos, 
    crearPresupuesto, 
    registrarGasto, 
    getDetalleGastos,
    editarPresupuesto,
    eliminarPresupuesto 
} from '../services/budgetService';
import { useAuth } from '../context/AuthContext';
import '../index.css';
import Swal from 'sweetalert2';
import { 
    BsCashCoin, BsPlusLg, BsFileEarmarkArrowUp, BsEye, 
    BsCurrencyDollar, BsPencilSquare, BsTrash, BsArchiveFill // <--- Agregu√© icono de archivo
} from 'react-icons/bs';

const API_URL = 'http://localhost:5000';

const PresupuestoPage = () => {
    const { usuario } = useAuth();
    const [presupuestos, setPresupuestos] = useState([]);
    const [anio, setAnio] = useState(new Date().getFullYear());
    
    // Modales
    const [modalAsignarOpen, setModalAsignarOpen] = useState(false);
    const [modalGastoOpen, setModalGastoOpen] = useState(false);
    const [modalDetalleOpen, setModalDetalleOpen] = useState(false);
    
    // Estados auxiliares
    const [selectedPresupuesto, setSelectedPresupuesto] = useState(null);
    const [listaGastos, setListaGastos] = useState([]);
    const [isEditing, setIsEditing] = useState(false);

    // Forms
    const [formAsignar, setFormAsignar] = useState({ 
        idPresupuesto: null,
        nombreRubro: '', 
        descripcion: '', 
        montoAsignado: '', 
        anio: new Date().getFullYear(),
        estado: 'Activo'
    });
    
    const [formGasto, setFormGasto] = useState({ 
        descripcionGasto: '', 
        montoGastado: '', 
        fechaGasto: new Date().toISOString().split('T')[0] 
    });
    const [archivoGasto, setArchivoGasto] = useState(null);

    const esSuperAdmin = usuario.rol === 'Super Admin';

    useEffect(() => {
        cargarDatos();
    }, [anio]);

    const cargarDatos = async () => {
        try {
            const data = await getPresupuestos(anio);
            setPresupuestos(data);
        } catch (error) { console.error(error); }
    };

    // --- LOGICA MODAL ASIGNAR/EDITAR ---
    const abrirModalCrear = () => {
        setIsEditing(false);
        setFormAsignar({ 
            idPresupuesto: null,
            nombreRubro: '', descripcion: '', montoAsignado: '', 
            anio: anio, estado: 'Activo' 
        });
        setModalAsignarOpen(true);
    };

    const abrirModalEditar = (p) => {
        setIsEditing(true);
        setFormAsignar({
            idPresupuesto: p.ID_Presupuesto,
            nombreRubro: p.NombreRubro,
            descripcion: p.Descripcion || '',
            montoAsignado: p.MontoAsignado,
            anio: p.Anio,
            estado: p.Estado
        });
        setModalAsignarOpen(true);
    };

    const handleGuardarPresupuesto = async (e) => {
        e.preventDefault();
        try {
            if (isEditing) {
                await editarPresupuesto(formAsignar.idPresupuesto, formAsignar);
                Swal.fire('Actualizado', 'Rubro actualizado correctamente.', 'success');
            } else {
                await crearPresupuesto(formAsignar);
                Swal.fire('Creado', 'Presupuesto asignado.', 'success');
            }
            setModalAsignarOpen(false);
            cargarDatos();
        } catch (error) { 
            Swal.fire('Error', error.message, 'error'); 
        }
    };

    // --- LOGICA INACTIVAR (Antes Eliminar) ---
    const handleEliminar = async (id, nombre) => {
        const result = await Swal.fire({
            title: '¬øInactivar Rubro?',
            text: `Se ocultar√° el rubro "${nombre}" de la lista principal.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'S√≠, inactivar',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            try {
                await eliminarPresupuesto(id); // Llama al backend que ahora hace UPDATE
                Swal.fire('Inactivado', 'El rubro ha sido archivado.', 'success');
                cargarDatos();
            } catch (error) {
                // Mensaje si tiene gastos (viene del SP)
                Swal.fire('No se puede inactivar', error.message, 'error');
            }
        }
    };

    // --- LOGICA GASTAR (Admin SST) ---
    const abrirModalGasto = (p) => {
        setSelectedPresupuesto(p);
        setModalGastoOpen(true);
    };

    const handleGasto = async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('idPresupuesto', selectedPresupuesto.ID_Presupuesto);
        formData.append('descripcionGasto', formGasto.descripcionGasto);
        formData.append('montoGastado', formGasto.montoGastado);
        formData.append('fechaGasto', formGasto.fechaGasto);
        if (archivoGasto) formData.append('evidencia', archivoGasto);

        try {
            await registrarGasto(formData);
            Swal.fire('Registrado', 'Gasto guardado correctamente.', 'success');
            setModalGastoOpen(false);
            setFormGasto({ descripcionGasto: '', montoGastado: '', fechaGasto: new Date().toISOString().split('T')[0] });
            setArchivoGasto(null);
            cargarDatos();
        } catch (error) { Swal.fire('Error', error.message, 'error'); }
    };

    // --- LOGICA VER DETALLE ---
    const abrirModalDetalle = async (p) => {
        setSelectedPresupuesto(p);
        const gastos = await getDetalleGastos(p.ID_Presupuesto);
        setListaGastos(gastos);
        setModalDetalleOpen(true);
    };

    // --- UTILS ---
    const formatMoney = (amount) => {
        return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(amount);
    };

    const getProgressColor = (porcentaje) => {
        if (porcentaje > 90) return '#dc3545'; // Rojo
        if (porcentaje > 70) return '#ffc107'; // Amarillo
        return '#28a745'; // Verde
    };

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>Gesti√≥n de Presupuesto {anio}</h1>
                <div style={{display:'flex', gap:'10px'}}>
                    <input type="number" className="form-control" style={{width:'80px'}} value={anio} onChange={e => setAnio(e.target.value)} />
                    {esSuperAdmin && (
                        <button className="btn btn-primary" onClick={abrirModalCrear}>
                            <BsPlusLg /> Asignar Nuevo Rubro
                        </button>
                    )}
                </div>
            </div>

            <div className="page-content-card">
                <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fill, minmax(350px, 1fr))', gap:'1.5rem'}}>
                    {presupuestos.map(p => {
                        const porcentaje = (p.TotalGastado / p.MontoAsignado) * 100;
                        const colorBarra = getProgressColor(porcentaje);

                        return (
                            <div key={p.ID_Presupuesto} style={{border:'1px solid #eee', borderRadius:'10px', padding:'1.5rem', boxShadow:'0 2px 5px rgba(0,0,0,0.05)', position:'relative', backgroundColor: '#fff'}}>
                                
                                <div style={{display:'flex', justifyContent:'space-between', alignItems:'flex-start'}}>
                                    <h3 style={{margin:'0 0 5px 0', color:'#005A5B', maxWidth: '70%'}}>{p.NombreRubro}</h3>
                                    
                                    {/* BOTONES DE EDICI√ìN (SOLO SUPER ADMIN) */}
                                    {esSuperAdmin && (
                                        <div style={{display:'flex', gap:'5px'}}>
                                            <button className="btn btn-sm btn-icon" onClick={() => abrirModalEditar(p)} title="Editar Rubro">
                                                <BsPencilSquare style={{color:'#f0ad4e'}}/>
                                            </button>
                                            <button className="btn btn-sm btn-icon" onClick={() => handleEliminar(p.ID_Presupuesto, p.NombreRubro)} title="Inactivar (Solo si sin gastos)">
                                                <BsArchiveFill style={{color:'#dc3545'}}/> {/* Icono cambiado a Archive */}
                                            </button>
                                        </div>
                                    )}
                                </div>
                                
                                <p style={{color:'#666', fontSize:'0.9rem', minHeight:'40px'}}>{p.Descripcion}</p>
                                
                                <div style={{marginBottom:'1rem'}}>
                                    <div style={{display:'flex', justifyContent:'space-between', fontSize:'0.85rem', marginBottom:'5px'}}>
                                        <span>Gastado: <strong>{formatMoney(p.TotalGastado)}</strong></span>
                                        <span>Total: <strong>{formatMoney(p.MontoAsignado)}</strong></span>
                                    </div>
                                    <div style={{width:'100%', height:'10px', backgroundColor:'#e9ecef', borderRadius:'5px', overflow:'hidden'}}>
                                        <div style={{width:`${Math.min(porcentaje, 100)}%`, height:'100%', backgroundColor: colorBarra, transition:'width 0.5s'}}></div>
                                    </div>
                                    <div style={{textAlign:'right', marginTop:'5px', fontWeight:'bold', color: p.SaldoDisponible < 0 ? 'red' : '#28a745'}}>
                                        Disponible: {formatMoney(p.SaldoDisponible)}
                                    </div>
                                </div>

                                <div style={{display:'flex', gap:'10px', marginTop:'1rem'}}>
                                    <button className="btn btn-secondary btn-sm" style={{flex:1}} onClick={() => abrirModalDetalle(p)}>
                                        <BsEye /> Ver Gastos
                                    </button>
                                    <button className="btn btn-warning btn-sm" style={{flex:1}} onClick={() => abrirModalGasto(p)}>
                                        <BsCashCoin /> Registrar Gasto
                                    </button>
                                </div>
                            </div>
                        );
                    })}
                    {presupuestos.length === 0 && <p style={{color:'#666'}}>No hay rubros activos asignados para este a√±o.</p>}
                </div>
            </div>

            {/* MODAL ASIGNAR / EDITAR (SUPER ADMIN) */}
            {modalAsignarOpen && (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <div className="modal-header">
                            <h3>{isEditing ? 'Editar Presupuesto' : 'Asignar Presupuesto'}</h3>
                            <button className="modal-close-button" onClick={()=>setModalAsignarOpen(false)}>&times;</button>
                        </div>
                        <form onSubmit={handleGuardarPresupuesto}>
                            <div className="modal-body">
                                <div className="form-group"><label>Nombre Actividad/Rubro</label><input required className="form-control" value={formAsignar.nombreRubro} onChange={e=>setFormAsignar({...formAsignar, nombreRubro:e.target.value})} placeholder="Ej: Compra EPP"/></div>
                                <div className="form-group"><label>Descripci√≥n</label><input className="form-control" value={formAsignar.descripcion} onChange={e=>setFormAsignar({...formAsignar, descripcion:e.target.value})}/></div>
                                <div className="form-group"><label>Monto a Asignar ($)</label><input type="number" required className="form-control" value={formAsignar.montoAsignado} onChange={e=>setFormAsignar({...formAsignar, montoAsignado:e.target.value})}/></div>
                                
                                {isEditing && (
                                    <div className="form-group">
                                        <label>Estado</label>
                                        <select className="form-control" value={formAsignar.estado} onChange={e=>setFormAsignar({...formAsignar, estado:e.target.value})}>
                                            <option value="Activo">Activo</option>
                                            <option value="Inactivo">Inactivo (Ocultar)</option>
                                        </select>
                                    </div>
                                )}
                            </div>
                            <div className="modal-footer"><button className="btn btn-primary">{isEditing ? 'Actualizar' : 'Guardar'}</button></div>
                        </form>
                    </div>
                </div>
            )}

            {/* MODAL REGISTRAR GASTO */}
            {modalGastoOpen && (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <div className="modal-header"><h3>Registrar Gasto: {selectedPresupuesto?.NombreRubro}</h3><button className="modal-close-button" onClick={()=>setModalGastoOpen(false)}>&times;</button></div>
                        <form onSubmit={handleGasto}>
                            <div className="modal-body">
                                <div className="form-group"><label>Descripci√≥n del Gasto</label><input required className="form-control" value={formGasto.descripcionGasto} onChange={e=>setFormGasto({...formGasto, descripcionGasto:e.target.value})} placeholder="Ej: Factura #123 Panamericana"/></div>
                                <div className="form-group"><label>Monto ($)</label><input type="number" required className="form-control" value={formGasto.montoGastado} onChange={e=>setFormGasto({...formGasto, montoGastado:e.target.value})}/></div>
                                <div className="form-group"><label>Fecha</label><input type="date" required className="form-control" value={formGasto.fechaGasto} onChange={e=>setFormGasto({...formGasto, fechaGasto:e.target.value})}/></div>
                                <div className="form-group"><label>Evidencia (Factura/Foto)</label><input type="file" className="form-control" onChange={e=>setArchivoGasto(e.target.files[0])}/></div>
                            </div>
                            <div className="modal-footer"><button className="btn btn-primary">Registrar</button></div>
                        </form>
                    </div>
                </div>
            )}

            {/* MODAL VER DETALLE */}
            {modalDetalleOpen && (
                <div className="modal-overlay">
                    <div className="modal-content modal-lg">
                        <div className="modal-header"><h3>Detalle de Gastos: {selectedPresupuesto?.NombreRubro}</h3><button className="modal-close-button" onClick={()=>setModalDetalleOpen(false)}>&times;</button></div>
                        <div className="modal-body" style={{maxHeight:'60vh', overflowY:'auto'}}>
                            <table className="data-table">
                                <thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Monto</th><th>Evidencia</th></tr></thead>
                                <tbody>
                                    {listaGastos.map(g => (
                                        <tr key={g.ID_Gasto}>
                                            <td>{new Date(g.FechaGasto).toLocaleDateString()}</td>
                                            <td>{g.DescripcionGasto}<br/><small style={{color:'#999'}}>Reg: {g.UsuarioRegistra}</small></td>
                                            <td style={{fontWeight:'bold'}}>{formatMoney(g.MontoGastado)}</td>
                                            <td>
                                                {g.RutaEvidencia ? (
                                                    <a href={`${API_URL}/${g.RutaEvidencia}`} target="_blank" rel="noopener noreferrer" className="btn btn-sm btn-secondary"><BsFileEarmarkArrowUp/> Ver</a>
                                                ) : 'No adjunto'}
                                            </td>
                                        </tr>
                                    ))}
                                    {listaGastos.length === 0 && <tr><td colSpan="4">No hay gastos registrados.</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

export default PresupuestoPage;


==================================================================
ARCHIVO: frontend\src\pages\ReportarMaquinaPage.jsx
==================================================================
// frontend/src/pages/ReportarMaquinaPage.jsx

import React, { useState, useEffect, useRef } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { getActivosTodos } from '../services/assetService'; 
import { crearReporteMaquina } from '../services/reportService';
import { getFormularios, getPreguntasFormulario } from '../services/inspectionService';
import { useAuth } from '../context/AuthContext'; 
import '../index.css'; 
import '../style/ReportarPage.css'; 
import Swal from 'sweetalert2'; 
import { BsArrowLeftCircle, BsSpeedometer2, BsSearch, BsChevronDown, BsPersonBadge } from 'react-icons/bs';

const ReportarMaquinaPage = () => {
    const { usuario } = useAuth(); // Aqu√≠ obtenemos los datos del logueado
    
    // Estados del Reporte
    const [idActivo, setIdActivo] = useState('');
    const [kilometraje, setKilometraje] = useState('');
    const [estadoReportado, setEstadoReportado] = useState('OK');
    const [descripcionProblema, setDescripcionProblema] = useState('');
    const [fotoReporte, setFotoReporte] = useState(null); 
    
    // Estados de Datos Maestros
    const [listaActivos, setListaActivos] = useState([]);
    const [listaFormularios, setListaFormularios] = useState([]);
    
    // Estados para el Buscador Inteligente
    const [busquedaActivo, setBusquedaActivo] = useState('');
    const [activosFiltrados, setActivosFiltrados] = useState([]);
    const [mostrarSugerencias, setMostrarSugerencias] = useState(false);
    const wrapperRef = useRef(null); 

    // Estados de L√≥gica Interna
    const [activoInfo, setActivoInfo] = useState(null);
    const [preguntasActivas, setPreguntasActivas] = useState([]);
    const [respuestasChecklist, setRespuestasChecklist] = useState({});
    
    // Estados de UI
    const [isLoadingData, setIsLoadingData] = useState(true);
    const [isLoadingPreguntas, setIsLoadingPreguntas] = useState(false);
    const [isLoadingSubmit, setIsLoadingSubmit] = useState(false);
    const [error, setError] = useState('');
    const [debugInfo, setDebugInfo] = useState(null);

    // eslint-disable-next-line no-unused-vars
    const navigate = useNavigate();

    // 1. Carga Inicial
    useEffect(() => {
        const cargarDatosMaestros = async () => {
            try {
                const [activos, formularios] = await Promise.all([
                    getActivosTodos(),
                    getFormularios()
                ]);
                
                const formulariosVisibles = formularios.filter(f => f.VisibleColaborador === true);
                setListaFormularios(formulariosVisibles);

                const tiposPermitidos = formulariosVisibles.map(f => f.TipoActivoAsociado.toLowerCase().trim());

                const activosFiltradosBD = activos.filter(a => 
                    a.TipoActivo && tiposPermitidos.includes(a.TipoActivo.toLowerCase().trim())
                );

                setListaActivos(activosFiltradosBD);
                setActivosFiltrados(activosFiltradosBD);

            } catch (err) {
                console.error(err);
                setError("Error conectando con el servidor.");
            } finally {
                setIsLoadingData(false);
            }
        };
        cargarDatosMaestros();
    }, []);

    // 2. Manejador de clics fuera del buscador
    useEffect(() => {
        function handleClickOutside(event) {
            if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                setMostrarSugerencias(false);
            }
        }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, [wrapperRef]);

    // 3. L√≥gica del Buscador
    const handleSearchChange = (e) => {
        const texto = e.target.value;
        setBusquedaActivo(texto);
        
        if (texto === '') {
            setIdActivo('');
            setActivoInfo(null);
            setPreguntasActivas([]);
        }

        const filtrados = listaActivos.filter(a => 
            a.NombreDescriptivo.toLowerCase().includes(texto.toLowerCase()) ||
            a.CodigoIdentificador.toLowerCase().includes(texto.toLowerCase())
        );
        setActivosFiltrados(filtrados);
        setMostrarSugerencias(true);
    };

    const seleccionarActivo = (activo) => {
        setBusquedaActivo(`${activo.NombreDescriptivo} (${activo.CodigoIdentificador})`);
        setIdActivo(activo.ID_Activo);
        setMostrarSugerencias(false);
    };

    // 4. Buscar Formulario y Preguntas
    useEffect(() => {
        if (!idActivo) {
            setPreguntasActivas([]);
            setDebugInfo(null);
            setEstadoReportado('OK');
            setActivoInfo(null);
            return;
        }

        const buscarPreguntas = async () => {
            setIsLoadingPreguntas(true);
            setRespuestasChecklist({});
            setEstadoReportado('OK');
            
            const activoSelect = listaActivos.find(a => a.ID_Activo == idActivo);
            if (!activoSelect) return;

            setActivoInfo(activoSelect);

            const tipoActivoReal = activoSelect.TipoActivo.trim();

            const formularioAsociado = listaFormularios.find(f => 
                f.TipoActivoAsociado && 
                f.TipoActivoAsociado.trim().toLowerCase() === tipoActivoReal.toLowerCase()
            );

            setDebugInfo({
                tipoDetectado: tipoActivoReal,
                formularioEncontrado: formularioAsociado ? formularioAsociado.NombreFormulario : "NINGUNO"
            });

            if (formularioAsociado) {
                try {
                    const preguntas = await getPreguntasFormulario(formularioAsociado.ID_Formulario);
                    setPreguntasActivas(preguntas);
                    
                    const inicial = {};
                    preguntas.forEach(p => { inicial[p.ID_Pregunta] = 'Cumple'; });
                    setRespuestasChecklist(inicial);
                } catch (err) {
                    console.error("Error preguntas:", err);
                }
            } else {
                setPreguntasActivas([]);
            }
            setIsLoadingPreguntas(false);
        };

        buscarPreguntas();
    }, [idActivo, listaActivos, listaFormularios]);

    const handleChecklistChange = (id, val) => {
        setRespuestasChecklist(prev => {
            const nuevasRespuestas = { ...prev, [id]: val };
            const hayFalla = Object.values(nuevasRespuestas).some(v => v === 'No Cumple');
            setEstadoReportado(hayFalla ? 'Con Problema' : 'OK');
            return nuevasRespuestas;
        });
    };

    const handleFileChange = (e) => setFotoReporte(e.target.files[0]);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');

        const esTipoVehiculo = ['vehiculo', 'moto', 'montacarga', 'carro', 'camion', 'tractomula', 'furgon'].some(t => 
            activoInfo?.TipoActivo.toLowerCase().includes(t)
        );

        if (activoInfo && esTipoVehiculo && !kilometraje) {
            setError('El kilometraje es obligatorio para este equipo.');
            return;
        }

        if (estadoReportado === 'Con Problema' && !descripcionProblema.trim()) {
            setError('Por favor describa el problema detectado en las observaciones.');
            return;
        }

        setIsLoadingSubmit(true);
        const formData = new FormData();
        formData.append('idActivo', idActivo);
        formData.append('estadoReportado', estadoReportado);
        if (kilometraje) formData.append('kilometraje', kilometraje);
        
        if (preguntasActivas.length > 0) {
            const reporteDetallado = preguntasActivas.map(p => ({
                pregunta: p.TextoPregunta,
                respuesta: respuestasChecklist[p.ID_Pregunta] || 'N/A'
            }));
            formData.append('datosReporte', JSON.stringify(reporteDetallado));
        }

        if (descripcionProblema.trim()) {
            formData.append('descripcionProblema', descripcionProblema);
        }
        
        if (fotoReporte) formData.append('fotoReporte', fotoReporte);

        try {
            await crearReporteMaquina(formData);
            Swal.fire('Enviado', 'Reporte registrado exitosamente.', 'success');
            
            // Resetear
            setIdActivo('');
            setBusquedaActivo('');
            setActivosFiltrados(listaActivos);
            setEstadoReportado('OK');
            setDescripcionProblema('');
            setKilometraje('');
            setFotoReporte(null);
            setPreguntasActivas([]);
            setDebugInfo(null);
            setActivoInfo(null);
            e.target.reset();
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoadingSubmit(false);
        }
    };

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>Reporte Pre-Uso</h1>
                <Link to="/dashboard" className="btn btn-secondary"><BsArrowLeftCircle /> Volver</Link>
            </div>

            <div className="page-content-card" style={{ maxWidth: '800px', margin: '0 auto' }}>
                <form onSubmit={handleSubmit}>
                    
                    {/* --- BUSCADOR INTELIGENTE --- */}
                    <div className="form-group" ref={wrapperRef}>
                        <label>Seleccione el Equipo:</label>
                        {isLoadingData ? (
                            <p>Cargando activos...</p>
                        ) : (
                            <div style={{position: 'relative'}}>
                                <BsSearch style={{position: 'absolute', top: '12px', left: '12px', color: '#999', zIndex: 1}}/>
                                <input 
                                    type="text" 
                                    className="form-control" 
                                    style={{paddingLeft: '35px', paddingRight: '30px'}} 
                                    placeholder="Buscar por nombre, placa o c√≥digo..." 
                                    value={busquedaActivo}
                                    onChange={handleSearchChange}
                                    onFocus={() => setMostrarSugerencias(true)}
                                    required
                                    autoComplete="off"
                                />
                                <BsChevronDown style={{position: 'absolute', top: '12px', right: '12px', color: '#999', cursor:'pointer'}} onClick={() => setMostrarSugerencias(!mostrarSugerencias)}/>

                                {mostrarSugerencias && (
                                    <div style={{
                                        position: 'absolute', top: '100%', left: 0, right: 0,
                                        backgroundColor: 'white', border: '1px solid #dee2e6',
                                        borderRadius: '0 0 8px 8px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                        maxHeight: '250px', overflowY: 'auto', zIndex: 1000
                                    }}>
                                        {activosFiltrados.length > 0 ? (
                                            activosFiltrados.map((a) => (
                                                <div 
                                                    key={a.ID_Activo} 
                                                    onClick={() => seleccionarActivo(a)}
                                                    style={{
                                                        padding: '10px 15px', cursor: 'pointer', borderBottom: '1px solid #f0f0f0',
                                                        display: 'flex', flexDirection: 'column'
                                                    }}
                                                    onMouseEnter={e => e.currentTarget.style.backgroundColor = '#f8f9fa'}
                                                    onMouseLeave={e => e.currentTarget.style.backgroundColor = 'white'}
                                                >
                                                    <span style={{fontWeight: '600', color: '#333'}}>{a.NombreDescriptivo}</span>
                                                    <div style={{fontSize: '0.8rem', color: '#666', display:'flex', justifyContent:'space-between'}}>
                                                        <span>C√≥digo: {a.CodigoIdentificador}</span>
                                                        <span style={{textTransform:'uppercase', fontSize:'0.7rem', backgroundColor:'#e9ecef', padding:'2px 6px', borderRadius:'4px'}}>{a.TipoActivo}</span>
                                                    </div>
                                                </div>
                                            ))
                                        ) : (
                                            <div style={{padding: '15px', textAlign: 'center', color: '#999'}}>
                                                No se encontraron equipos.
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* --- INFO DEL ACTIVO + USUARIO LOGUEADO --- */}
                    {activoInfo && (
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem', backgroundColor: '#eef2f7', padding: '1rem', borderRadius: '8px' }}>
                            <div className="form-group" style={{marginBottom:0}}>
                                <label style={{fontSize:'0.8rem', fontWeight:'bold', color:'#666'}}>C√≥digo:</label>
                                <div style={{fontSize:'1rem', fontWeight:'500'}}>{activoInfo.CodigoIdentificador}</div>
                            </div>
                            <div className="form-group" style={{marginBottom:0}}>
                                <label style={{fontSize:'0.8rem', fontWeight:'bold', color:'#666'}}>Marca/Modelo:</label>
                                <div style={{fontSize:'1rem'}}>{activoInfo.Marca || ''} {activoInfo.Modelo || ''}</div>
                            </div>
                            
                            {/* --- CORRECCI√ìN FINAL (Multiopci√≥n) --- */}
                            <div className="form-group" style={{marginBottom:0, gridColumn:'span 2', borderTop:'1px solid #ddd', paddingTop:'10px', marginTop:'5px'}}>
                                <label style={{fontSize:'0.8rem', fontWeight:'bold', color:'#666', display:'flex', alignItems:'center', gap:'5px'}}>
                                    <BsPersonBadge /> Reportado por:
                                </label>
                                <div style={{fontSize:'1rem', color: '#005A5B', fontWeight:'bold'}}>
                                    {usuario?.NombreCompleto || usuario?.nombre || usuario?.Nombre}
                                </div>
                               
                            </div>
                            {/* --------------------------------------------------- */}
                        </div>
                    )}

                    {/* CAMPO KILOMETRAJE */}
                    {activoInfo && ['vehiculo', 'moto', 'montacarga', 'carro', 'camion', 'tractomula', 'furgon'].some(t => activoInfo.TipoActivo.toLowerCase().includes(t)) && (
                        <div className="form-group">
                            <label style={{color: 'var(--color-acento)', fontWeight:'bold', display:'flex', alignItems:'center', gap:'5px'}}>
                                <BsSpeedometer2 /> Kilometraje Actual *
                            </label>
                            <input 
                                type="number" 
                                className="form-control" 
                                placeholder={`Anterior: ${activoInfo.KilometrajeActual || 0} km`} 
                                value={kilometraje} 
                                onChange={(e) => setKilometraje(e.target.value)} 
                                required
                                style={{borderColor: '#007BFF', backgroundColor: '#f0f8ff'}}
                            />
                        </div>
                    )}

                    {/* CHECKLIST */}
                    {!isLoadingPreguntas && preguntasActivas.length > 0 && (
                        <div style={{backgroundColor:'#f8f9fa', padding:'1rem', borderRadius:'8px', border:'1px solid #dee2e6', marginBottom:'1.5rem'}}>
                            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem', borderBottom:'1px solid #ddd', paddingBottom:'0.5rem'}}>
                                <h3 style={{margin:0, color:'var(--color-primario)'}}>Checklist</h3>
                                <span className={`status-pill ${estadoReportado === 'OK' ? 'status-activo' : 'status-inactivo'}`}>
                                    Estado: {estadoReportado}
                                </span>
                            </div>
                            
                            {preguntasActivas.map((p, idx) => (
                                <div key={p.ID_Pregunta} style={{display:'flex', justifyContent:'space-between', alignItems:'center', padding:'0.8rem 0', borderBottom:'1px solid #e0e0e0'}}>
                                    <span style={{flex:1, paddingRight:'10px', fontWeight:'500'}}>{idx + 1}. {p.TextoPregunta}</span>
                                    <div style={{display:'flex', gap:'15px'}}>
                                        <label style={{color:'#28a745', fontWeight:'600', cursor:'pointer', display:'flex', alignItems:'center', gap:'5px'}}>
                                            <input type="radio" name={`p_${p.ID_Pregunta}`} checked={respuestasChecklist[p.ID_Pregunta] === 'Cumple'} onChange={() => handleChecklistChange(p.ID_Pregunta, 'Cumple')} /> 
                                            Cumple
                                        </label>
                                        <label style={{color:'#dc3545', fontWeight:'600', cursor:'pointer', display:'flex', alignItems:'center', gap:'5px'}}>
                                            <input type="radio" name={`p_${p.ID_Pregunta}`} checked={respuestasChecklist[p.ID_Pregunta] === 'No Cumple'} onChange={() => handleChecklistChange(p.ID_Pregunta, 'No Cumple')} /> 
                                            No Cumple
                                        </label>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* AVISO SI NO HAY CHECKLIST */}
                    {!isLoadingPreguntas && idActivo && preguntasActivas.length === 0 && (
                        <div style={{padding:'1rem', backgroundColor:'#fff3cd', color:'#856404', borderRadius:'8px', marginBottom:'1.5rem', border:'1px solid #ffeeba'}}>
                            <strong>‚ö†Ô∏è Aviso:</strong> No hay checklist para el tipo <strong>"{debugInfo?.tipoDetectado}"</strong>.<br/>
                            (El Super Admin debe crear o activar un formulario para este tipo de activo).
                        </div>
                    )}

                    <div className="form-group">
                        <label>Observaciones / Detalles {estadoReportado === 'Con Problema' && <span style={{color:'red'}}>* (Obligatorio)</span>}</label>
                        <textarea 
                            className="form-control" 
                            rows="3" 
                            value={descripcionProblema} 
                            onChange={(e) => setDescripcionProblema(e.target.value)} 
                            placeholder={estadoReportado === 'Con Problema' ? "Describa qu√© fall√≥..." : "Comentarios adicionales..."}
                            required={estadoReportado === 'Con Problema'}
                            style={{borderColor: estadoReportado === 'Con Problema' ? '#dc3545' : '#dee2e6'}}
                        />
                    </div>

                    <div className="form-group">
                        <label>Foto (Opcional)</label>
                        <input type="file" className="form-control" onChange={handleFileChange} accept="image/*" />
                    </div>

                    <button type="submit" className="btn btn-primary" style={{width:'100%'}} disabled={isLoadingSubmit}>
                        {isLoadingSubmit ? 'Enviando...' : 'Enviar Reporte'}
                    </button>
                    
                    {error && <p className="error-message" style={{marginTop:'1rem'}}>{error}</p>}
                </form>
            </div>
        </div>
    );
};

export default ReportarMaquinaPage;


==================================================================
ARCHIVO: frontend\src\pages\ReportarSeguridadPage.jsx
==================================================================
// frontend/src/pages/ReportarSeguridadPage.jsx

import React, { useState } from 'react';
import { useNavigate, Link } from 'react-router-dom'; // <-- 1. Importar Link
import { crearReporteSeguridad } from '../services/reportService'; 
import '../index.css'; 
import '../style/ReportarPage.css'; 
import Swal from 'sweetalert2'; // <-- Importar Swal
import { BsArrowLeftCircle } from 'react-icons/bs'; // <-- 2. Importar icono

const ReportarSeguridadPage = () => {
    // (Estados sin cambios)
    const [tipoReporte, setTipoReporte] = useState('Condicion'); 
    const [ubicacionArea, setUbicacionArea] = useState('');
    const [descripcion, setDescripcion] = useState('');
    const [fotoReporte, setFotoReporte] = useState(null); 
    const [isLoadingSubmit, setIsLoadingSubmit] = useState(false);
    const [error, setError] = useState('');

    // eslint-disable-next-line no-unused-vars
    const navigate = useNavigate();

    const handleFileChange = (e) => {
        setFotoReporte(e.target.files[0]);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setIsLoadingSubmit(true);

        const formData = new FormData();
        formData.append('tipoReporte', tipoReporte);
        formData.append('ubicacionArea', ubicacionArea);
        formData.append('descripcion', descripcion);
        if (fotoReporte) {
            formData.append('fotoReporte', fotoReporte);
        }

        try {
            await crearReporteSeguridad(formData);
            
            // --- 3. REEMPLAZAR 'alert()' ---
            Swal.fire({
                title: '¬°√âxito!',
                text: 'Reporte de seguridad enviado exitosamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            
            setTipoReporte('Condicion');
            setUbicacionArea('');
            setDescripcion('');
            setFotoReporte(null);
            e.target.reset(); 
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoadingSubmit(false);
        }
    };

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>Reportar Incidente / Condici√≥n Insegura</h1>
                {/* --- 4. A√ëADIR BOT√ìN DE VOLVER --- */}
                <Link to="/dashboard" className="btn btn-secondary">
                    <BsArrowLeftCircle /> Volver al Inicio
                </Link>
            </div>

            <div className="page-content-card" style={{ maxWidth: '700px', margin: '0 auto' }}>
                <form onSubmit={handleSubmit}>
                    <p>Utilice este formulario para reportar cualquier acto, condici√≥n insegura, incidente o accidente.</p>
                    
                    {/* (Resto del formulario sin cambios) */}
                    <div className="form-group"><label htmlFor="tipoReporte">Tipo de Reporte *</label><select id="tipoReporte" name="tipoReporte" value={tipoReporte} onChange={(e) => setTipoReporte(e.target.value)} required><option value="Condicion">Condici√≥n Insegura (Ej: piso mojado, cable expuesto)</option><option value="Acto">Acto Inseguro (Ej: no usar EPP)</option><option value="Incidente">Incidente (Casi accidente)</option><option value="Accidente">Accidente</option><option value="Sugerencia">Sugerencia de Mejora</option></select></div>
                    <div className="form-group"><label htmlFor="ubicacionArea">Ubicaci√≥n / √Årea donde ocurri√≥ *</label><input type="text" id="ubicacionArea" name="ubicacionArea" value={ubicacionArea} onChange={(e) => setUbicacionArea(e.target.value)} placeholder="Ej: Pasillo Bodega MP, M√°quina Troqueladora" required /></div>
                    <div className="form-group"><label htmlFor="descripcion">Descripci√≥n detallada de lo ocurrido *</label><textarea id="descripcion" name="descripcion" rows="5" value={descripcion} onChange={(e) => setDescripcion(e.target.value)} placeholder="Sea lo m√°s espec√≠fico posible..." required /></div>
                    <div className="form-group"><label htmlFor="fotoReporte">Adjuntar Foto (Opcional)</label><input type="file" id="fotoReporte" name="fotoReporte" onChange={handleFileChange} accept=".jpg,.jpeg,.png" /></div>

                    <div className="form-footer">
                        <button type="submit" className="btn btn-primary" disabled={isLoadingSubmit}>
                            {isLoadingSubmit ? 'Enviando...' : 'Enviar Reporte de Seguridad'}
                        </button>
                    </div>
                    {error && <p className="modal-error" style={{marginTop: '1rem'}}>{error}</p>}
                </form>
            </div>
        </div>
    );
};

export default ReportarSeguridadPage;


==================================================================
ARCHIVO: frontend\src\pages\ReportesPage.jsx
==================================================================
// frontend/src/pages/ReportesPage.jsx

import React, { useState, useEffect, useMemo } from 'react';
import { getReportesMaquina, getReportesSeguridad } from '../services/reportService';
import '../index.css'; 
import '../style/PlanificacionPage.css'; 

// --- Importamos los modales ---
import ModalVerReporte from '../components/ModalVerReporte.jsx';
import ModalCrearACPM from '../components/ModalCrearACPM.jsx';
import ModalVerACPM from '../components/ModalVerACPM.jsx'; 
import { BsPlusLg, BsEyeFill } from 'react-icons/bs';

const ReportesPage = () => {
    // --- Estados ---
    const [reportesMaquina, setReportesMaquina] = useState([]);
    const [reportesSeguridad, setReportesSeguridad] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);
    const [filtroEstado, setFiltroEstado] = useState('Todos'); 
    
    // --- Estados de Modales ---
    const [modalVerAbierto, setModalVerAbierto] = useState(false);
    const [modalCrearAcpmAbierto, setModalCrearAcpmAbierto] = useState(false);
    const [modalVerAcpmId, setModalVerAcpmId] = useState(null); 
    const [reporteSeleccionado, setReporteSeleccionado] = useState(null); 
    const [acpmInitialData, setAcpmInitialData] = useState({});

    // --- Carga Inicial ---
    const cargarReportes = async (isRefreshing = false) => {
        try {
            if (!isRefreshing) setIsLoading(true);
            const [dataMaquina, dataSeguridad] = await Promise.all([
                getReportesMaquina(),
                getReportesSeguridad()
            ]);
            setReportesMaquina(dataMaquina);
            setReportesSeguridad(dataSeguridad);
            setError(null);
        } catch (err) {
            setError(err.message);
        } finally {
            if (!isRefreshing) setIsLoading(false);
        }
    };

    useEffect(() => {
        cargarReportes(false); 
    }, []); 

    // --- L√≥gica de Filtrado ---
    const reportesMaquinaFiltrados = useMemo(() => {
        if (filtroEstado === 'Todos') return reportesMaquina;
        return reportesMaquina.filter(rep => rep.EstadoRevision === filtroEstado);
    }, [reportesMaquina, filtroEstado]);

    const reportesSeguridadFiltrados = useMemo(() => {
        if (filtroEstado === 'Todos') return reportesSeguridad;
        return reportesSeguridad.filter(rep => rep.EstadoRevision === filtroEstado);
    }, [reportesSeguridad, filtroEstado]);


    // --- Manejadores de Modales ---
    
    const abrirModalVer = (reporte, tipo) => {
        setReporteSeleccionado({ reporte, tipo });
        setModalVerAbierto(true);
    };

    // --- CORRECCI√ìN: Recargar tabla AL CERRAR el modal ---
    const cerrarModalVer = () => {
        setModalVerAbierto(false);
        setReporteSeleccionado(null);
        // Recargamos aqu√≠ para que el estado "Nuevo" cambie a "Revisado" visualmente
        cargarReportes(true); 
    };

    const abrirModalCrearACPM = (reporte, tipo) => {
        if (tipo === 'maquina') {
            setAcpmInitialData({
                origen: `Reporte M√°quina ID: ${reporte.ID_ReporteMaquina}`,
                descripcionProblema: `(Activo: ${reporte.NombreActivo}) ${reporte.DescripcionProblema}`,
                idReporteMaquinaOrigen: reporte.ID_ReporteMaquina
            });
        } else { 
            setAcpmInitialData({
                origen: `Reporte Seguridad ID: ${reporte.ID_ReporteSeguridad}`,
                descripcionProblema: `(√Årea: ${reporte.UbicacionArea}) ${reporte.Descripcion}`,
                idReporteSeguridadOrigen: reporte.ID_ReporteSeguridad
            });
        }
        setModalCrearAcpmAbierto(true);
    };
    
    const cerrarModalCrearACPM = () => {
        setModalCrearAcpmAbierto(false);
        setAcpmInitialData({});
    };
    
    const handleAcpmCreada = (nuevoIdACPM) => {
        cerrarModalCrearACPM();
        cargarReportes(true); 
        setModalVerAcpmId(nuevoIdACPM); 
    };
    
    const abrirModalVerACPM = (idACPM) => {
        setModalVerAcpmId(idACPM);
    };
    const cerrarModalVerACPM = () => {
        setModalVerAcpmId(null);
    };

    const formatearFechaHora = (fechaISO) => {
        if (!fechaISO) return 'N/A';
        return new Date(fechaISO).toLocaleString('es-CO');
    };

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>Gesti√≥n de Reportes de Colaboradores</h1>
            </div>

            <div className="cronograma-selector" style={{ marginBottom: '2rem' }}>
                <label htmlFor="filtro-estado">Filtrar por Estado:</label>
                <select id="filtro-estado" value={filtroEstado} onChange={(e) => setFiltroEstado(e.target.value)}>
                    <option value="Todos">Todos</option>
                    <option value="Nuevo">Nuevos</option>
                    <option value="Revisado">Revisados</option>
                </select>
            </div>

            {isLoading && <p>Cargando reportes...</p>}
            {error && <p className="error-message">Error: {error}</p>}

            {/* --- Tarjeta "Reportes de M√°quina" --- */}
            {!isLoading && !error && (
                <div className="page-content-card" style={{ marginBottom: '2rem' }}>
                    <h2>Reportes de Estado de M√°quina (Pre-uso)</h2>
                    <div className="table-wrapper">
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>M√°quina/Activo</th>
                                    <th>Reportado por</th>
                                    <th>Estado Reportado</th>
                                    <th>Descripci√≥n</th>
                                    <th>Estado Revisi√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {reportesMaquinaFiltrados.length === 0 ? (
                                    <tr><td colSpan="7" style={{ textAlign: 'center' }}>No hay reportes de m√°quina {filtroEstado !== 'Todos' ? `con estado "${filtroEstado}"` : ''}.</td></tr>
                                ) : (
                                    reportesMaquinaFiltrados.map((rep) => (
                                        <tr key={rep.ID_ReporteMaquina}>
                                            <td>{formatearFechaHora(rep.FechaHoraReporte)}</td>
                                            <td>{rep.NombreActivo} ({rep.CodigoActivo})</td>
                                            <td>{rep.NombreUsuarioReporta}</td>
                                            <td><span className={`status-pill ${rep.EstadoReportado === 'OK' ? 'status-activo' : 'status-pendiente'}`}>{rep.EstadoReportado}</span></td>
                                            <td title={rep.DescripcionProblema}>{rep.DescripcionProblema?.substring(0, 30) || 'N/A'}{rep.DescripcionProblema?.length > 30 ? '...' : ''}</td>
                                            <td><span className={`status-pill ${rep.EstadoRevision === 'Nuevo' ? 'status-pendiente' : 'status-inactivo'}`}>{rep.EstadoRevision}</span></td>
                                            <td className="action-buttons">
                                                <button className="btn btn-secondary" onClick={() => abrirModalVer(rep, 'maquina')}>Ver Detalle</button>
                                                {rep.EstadoReportado === 'Con Problema' && (
                                                    rep.ID_ACPM_Vinculada ? (
                                                        <button className="btn btn-success" onClick={() => abrirModalVerACPM(rep.ID_ACPM_Vinculada)}>
                                                            <BsEyeFill /> Ver ACPM
                                                        </button>
                                                    ) : (
                                                        <button className="btn btn-warning" onClick={() =>abrirModalCrearACPM(rep, 'maquina')}>Crear ACPM</button>
                                                    )
                                                )}
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div> 
                </div>
            )}

            {/* --- Tarjeta "Reportes de Seguridad" --- */}
            {!isLoading && !error && (
                <div className="page-content-card">
                    <h2>Reportes de Seguridad (Actos/Condiciones)</h2>
                    <div className="table-wrapper">
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Reportado por</th>
                                    <th>Ubicaci√≥n</th>
                                    <th>Descripci√≥n</th>
                                    <th>Estado Revisi√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {reportesSeguridadFiltrados.length === 0 ? (
                                    <tr><td colSpan="7" style={{ textAlign: 'center' }}>No hay reportes de seguridad {filtroEstado !== 'Todos' ? `con estado "${filtroEstado}"` : ''}.</td></tr>
                                ) : (
                                    reportesSeguridadFiltrados.map((rep) => (
                                        <tr key={rep.ID_ReporteSeguridad}>
                                            <td>{formatearFechaHora(rep.FechaHoraReporte)}</td>
                                            <td>{rep.TipoReporte}</td>
                                            <td>{rep.NombreUsuarioReporta}</td>
                                            <td>{rep.UbicacionArea}</td>
                                            <td title={rep.Descripcion}>{rep.Descripcion.substring(0, 30)}...</td>
                                            <td><span className={`status-pill ${rep.EstadoRevision === 'Nuevo' ? 'status-pendiente' : 'status-inactivo'}`}>{rep.EstadoRevision}</span></td>
                                            <td className="action-buttons">
                                                <button className="btn btn-secondary" onClick={() => abrirModalVer(rep, 'seguridad')}>Ver Detalle</button>
                                                {rep.ID_ACPM_Vinculada ? (
                                                    <button className="btn btn-success" onClick={() => abrirModalVerACPM(rep.ID_ACPM_Vinculada)}>
                                                        <BsEyeFill /> Ver ACPM
                                                    </button>
                                                ) : (
                                                    <button className="btn btn-warning" onClick={() =>abrirModalCrearACPM(rep, 'seguridad')}>Crear ACPM</button>
                                                )}
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}
            
            {/* --- Renderizado de Modales --- */}
            {modalVerAbierto && ( 
                <ModalVerReporte 
                    reporte={reporteSeleccionado.reporte} 
                    tipo={reporteSeleccionado.tipo} 
                    alCerrar={cerrarModalVer} 
                /> 
            )}
            
            {modalCrearAcpmAbierto && ( 
                <ModalCrearACPM 
                    alCerrar={cerrarModalCrearACPM} 
                    alExito={handleAcpmCreada} 
                    initialData={acpmInitialData} 
                /> 
            )}

            {modalVerAcpmId && ( <ModalVerACPM acpmId={modalVerAcpmId} alCerrar={cerrarModalVerACPM} /> )}
        </div>
    );
};

export default ReportesPage;


==================================================================
ARCHIVO: frontend\src\pages\SolicitudesPage.jsx
==================================================================
// frontend/src/pages/SolicitudesPage.jsx

import React, { useState, useEffect, useRef } from 'react';
import { apiFetch } from '../services/apiService';
import { useAuth } from '../context/AuthContext';
import '../style/Solicitudes.css';
import Swal from 'sweetalert2';
// Iconos
import { 
    BsSend, BsFileEarmarkPdf, BsCheckCircle, BsXCircle, BsInbox, 
    BsDownload, BsCloudCheck, BsPencilSquare, BsArrowRepeat 
} from 'react-icons/bs';
import ModalFirmarSolicitud from '../components/ModalFirmarSolicitud';

const SolicitudesPage = () => {
    const { usuario } = useAuth();
    const [solicitudes, setSolicitudes] = useState([]);
    // eslint-disable-next-line no-unused-vars
    const [isLoading, setIsLoading] = useState(true);
    
    // Estados Formulario
    const [tipo, setTipo] = useState('Firma Documento');
    const [mensaje, setMensaje] = useState('');
    const [modoAdjunto, setModoAdjunto] = useState('interno'); 
    const [archivoSubido, setArchivoSubido] = useState(null);
    const [docInternoSeleccionado, setDocInternoSeleccionado] = useState('');
    const [listaDocsInternos, setListaDocsInternos] = useState([]);
    const [isSending, setIsSending] = useState(false);

    // Estados Modal Firma
    const [modalFirmaOpen, setModalFirmaOpen] = useState(false);
    const [solicitudAFirmar, setSolicitudAFirmar] = useState(null);

    // L√≥gica de Actualizaci√≥n Manual (Input oculto)
    const fileInputRef = useRef(null);
    const [solicitudParaActualizar, setSolicitudParaActualizar] = useState(null);

    const esSuperAdmin = usuario.rol === 'Super Admin';
    const API_URL = 'http://localhost:5000'; 

    useEffect(() => {
        cargarSolicitudes();
        if (!esSuperAdmin) cargarDocsInternos();
    }, []);

    const cargarSolicitudes = async () => {
        try {
            const data = await apiFetch('/solicitudes');
            setSolicitudes(data);
        } catch (error) { console.error(error); } finally { setIsLoading(false); }
    };

    const cargarDocsInternos = async () => {
        try {
            const docs = await apiFetch('/pesv/documentos-internos');
            setListaDocsInternos(docs);
        } catch (error) { console.error(error); }
    };

    // --- ENVIAR SOLICITUD ---
    const handleEnviar = async (e) => {
        e.preventDefault();
        setIsSending(true);

        const formData = new FormData();
        formData.append('tipo', tipo);
        formData.append('mensaje', mensaje);

        if (modoAdjunto === 'archivo' && archivoSubido) {
            formData.append('archivo', archivoSubido);
        } else if (modoAdjunto === 'interno' && docInternoSeleccionado) {
            formData.append('rutaDocumentoInterno', docInternoSeleccionado);
        }

        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_URL}/api/solicitudes`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            if (response.ok) {
                Swal.fire('Enviado', 'Solicitud creada exitosamente.', 'success');
                setMensaje('');
                setArchivoSubido(null);
                setDocInternoSeleccionado('');
                cargarSolicitudes();
            } else throw new Error('Error al enviar');
        // eslint-disable-next-line no-unused-vars
        } catch (error) {
            Swal.fire('Error', 'No se pudo enviar la solicitud.', 'error');
        } finally {
            setIsSending(false);
        }
    };

    // --- L√ìGICA DE APROBACI√ìN ---
    const handleAprobarClic = (solicitud) => {
        if (solicitud.RutaDocumento) {
            setSolicitudAFirmar(solicitud);
            setModalFirmaOpen(true);
        } else {
            // Aprobaci√≥n simple
            apiFetch('/solicitudes/responder', {
                method: 'PUT',
                body: JSON.stringify({ idSolicitud: solicitud.ID_Solicitud, estado: 'Aprobado', comentario: 'Aprobado manual.' })
            }).then(() => {
                Swal.fire('Listo', 'Solicitud aprobada', 'success');
                cargarSolicitudes();
            });
        }
    };

    const handleRechazarClic = async (solicitud) => {
        const { value: text } = await Swal.fire({
            title: 'Rechazar Solicitud',
            input: 'textarea',
            inputPlaceholder: 'Motivo del rechazo...',
            showCancelButton: true,
            confirmButtonColor: '#d33'
        });
        if (text) {
            await apiFetch('/solicitudes/responder', {
                method: 'PUT',
                body: JSON.stringify({ idSolicitud: solicitud.ID_Solicitud, estado: 'Rechazado', comentario: text })
            });
            Swal.fire('Rechazado', 'Solicitud rechazada.', 'info');
            cargarSolicitudes();
        }
    };

    // --- L√ìGICA DE ACTUALIZACI√ìN MANUAL (BOT√ìN RECICLAJE) ---
    const handleClicActualizar = (solicitud) => {
        setSolicitudParaActualizar(solicitud);
        fileInputRef.current.click(); 
    };

    const handleArchivoSeleccionado = async (e) => {
        const file = e.target.files[0];
        if (!file || !solicitudParaActualizar) return;

        const result = await Swal.fire({
            title: '¬øReemplazar documento firmado?',
            text: `Se subir√° "${file.name}" como la versi√≥n final firmada.`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'S√≠, subir'
        });

        if (result.isConfirmed) {
            const formData = new FormData();
            formData.append('idSolicitud', solicitudParaActualizar.ID_Solicitud);
            formData.append('archivo', file);

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/solicitudes/actualizar-doc`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                if (response.ok) {
                    Swal.fire('¬°Listo!', 'Documento actualizado.', 'success');
                    cargarSolicitudes();
                } else throw new Error('Error');
            // eslint-disable-next-line no-unused-vars
            } catch (error) {
                Swal.fire('Error', 'No se pudo actualizar.', 'error');
            }
        }
        e.target.value = null;
        setSolicitudParaActualizar(null);
    };

    const getEstadoBadge = (estado) => {
        switch(estado) {
            case 'Pendiente': return <span className="status-pill status-pendiente">Pendiente</span>;
            case 'Aprobado': return <span className="status-pill status-activo">Aprobado</span>;
            case 'Rechazado': return <span className="status-pill status-inactivo">Rechazado</span>;
            default: return <span>{estado}</span>;
        }
    };

    return (
        <div className="solicitudes-container">
            <div className="page-header">
                <h1>{esSuperAdmin ? <><BsInbox /> Bandeja de Entrada</> : <><BsSend /> Centro de Solicitudes</>}</h1>
            </div>

            {/* INPUT OCULTO PARA ACTUALIZACI√ìN */}
            <input 
                type="file" 
                ref={fileInputRef} 
                style={{display:'none'}} 
                accept=".pdf,.jpg,.png" 
                onChange={handleArchivoSeleccionado} 
            />

            {/* --- FORMULARIO SST --- */}
            {!esSuperAdmin && (
                <div className="solicitud-form-card">
                    <h3 style={{marginTop:0, borderBottom:'1px solid #eee', paddingBottom:'10px'}}>Nueva Solicitud</h3>
                    <form onSubmit={handleEnviar}>
                        <div className="form-grid">
                            <div className="form-group">
                                <label>Tipo de Solicitud</label>
                                <select className="form-control" value={tipo} onChange={e => setTipo(e.target.value)}>
                                    <option>Firma Documento</option>
                                    <option>Aprobaci√≥n</option>
                                    <option>Otro</option>
                                </select>
                            </div>
                            <div className="form-group">
                                <label>Mensaje</label>
                                <input className="form-control" required value={mensaje} onChange={e => setMensaje(e.target.value)} placeholder="Describa su solicitud..." />
                            </div>
                        </div>

                        <div style={{backgroundColor:'#f8f9fa', padding:'1rem', borderRadius:'8px', border:'1px solid #dee2e6', marginBottom:'1rem'}}>
                            <label style={{fontWeight:'bold', marginBottom:'10px', display:'block'}}>Documento a Adjuntar:</label>
                            <div style={{display:'flex', gap:'20px', marginBottom:'15px'}}>
                                <label style={{cursor:'pointer'}}><input type="radio" checked={modoAdjunto === 'interno'} onChange={() => setModoAdjunto('interno')} /> <BsCloudCheck /> Del Software</label>
                                <label style={{cursor:'pointer'}}><input type="radio" checked={modoAdjunto === 'archivo'} onChange={() => setModoAdjunto('archivo')} /> <BsFileEarmarkPdf /> Subir PC</label>
                            </div>
                            
                            {modoAdjunto === 'interno' ? (
                                <select className="form-control" value={docInternoSeleccionado} onChange={e => setDocInternoSeleccionado(e.target.value)}>
                                    <option value="">-- Seleccione --</option>
                                    {listaDocsInternos.map(d => (
                                        <option key={d.ID_Evidencia} value={d.RutaArchivo}>{d.NombreArchivo}</option>
                                    ))}
                                </select>
                            ) : (
                                <input type="file" className="form-control" accept=".pdf,.jpg,.png" onChange={e => setArchivoSubido(e.target.files[0])} />
                            )}
                        </div>

                        <div style={{textAlign:'right'}}>
                            <button className="btn btn-primary" disabled={isSending}>{isSending ? 'Enviando...' : 'Enviar'}</button>
                        </div>
                    </form>
                </div>
            )}

            {/* --- TABLA --- */}
            <div className="solicitudes-list-card">
                <h3 style={{marginTop:0}}>Historial</h3>
                <div className="table-wrapper">
                    <table className="solicitud-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Solicitante</th>
                                <th>Mensaje</th>
                                <th>Documentos</th>
                                <th>Estado</th>
                                <th>Respuesta</th>
                                {esSuperAdmin && <th>Acciones</th>}
                            </tr>
                        </thead>
                        <tbody>
                            {solicitudes.map(s => (
                                <tr key={s.ID_Solicitud}>
                                    <td>{new Date(s.FechaSolicitud).toLocaleDateString()}</td>
                                    <td><strong>{s.Solicitante}</strong><br/><small>{s.Cargo}</small></td>
                                    <td style={{maxWidth:'250px'}}>{s.Mensaje}</td>
                                    
                                    {/* COLUMNA DOCUMENTOS */}
                                    <td>
                                        <div className="btn-doc-group">
                                            {s.RutaDocumento && (
                                                <a href={`${API_URL}/api/pesv/download/${s.RutaDocumento.split('/').pop()}`} className="btn-doc btn-doc-original">
                                                    <BsFileEarmarkPdf /> Original
                                                </a>
                                            )}

                                            {s.RutaDocumentoFirmado && (
                                                <a href={`${API_URL}/api/pesv/download/${s.RutaDocumentoFirmado.split('/').pop()}`} className="btn-doc btn-doc-firmado">
                                                    <BsCheckCircle /> Firmado
                                                </a>
                                            )}

                                            {/* Bot√≥n Actualizar (Solo Admin) */}
                                            {esSuperAdmin && (
                                                <button 
                                                    className="btn btn-sm" 
                                                    style={{marginTop:'5px', backgroundColor:'#fff', border:'1px dashed #007BFF', color:'#007BFF', width:'100%', fontSize:'0.75rem'}}
                                                    onClick={() => handleClicActualizar(s)}
                                                    title="Reemplazar firmado manualmente"
                                                >
                                                    <BsArrowRepeat /> {s.RutaDocumentoFirmado ? 'Cambiar' : 'Subir'}
                                                </button>
                                            )}

                                            {!s.RutaDocumento && !s.RutaDocumentoFirmado && '--'}
                                        </div>
                                    </td>

                                    <td>{getEstadoBadge(s.Estado)}</td>
                                    <td>{s.ComentarioAdmin || '--'}</td>
                                    
                                    {esSuperAdmin && s.Estado === 'Pendiente' && (
                                        <td className="actions-cell">
                                            <button className="btn btn-sm btn-primary" title="Firmar" onClick={() => handleAprobarClic(s)}><BsPencilSquare /></button>
                                            <button className="btn btn-sm btn-danger" title="Rechazar" onClick={() => handleRechazarClic(s)}><BsXCircle /></button>
                                        </td>
                                    )}
                                    {esSuperAdmin && s.Estado !== 'Pendiente' && <td>--</td>}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>

            {modalFirmaOpen && solicitudAFirmar && (
                <ModalFirmarSolicitud 
                    solicitud={solicitudAFirmar} 
                    alCerrar={() => setModalFirmaOpen(false)} 
                    alExito={() => { setModalFirmaOpen(false); cargarSolicitudes(); }} 
                />
            )}
        </div>
    );
};

export default SolicitudesPage;


==================================================================
ARCHIVO: frontend\src\pages\UsuariosPage.jsx
==================================================================
// frontend/src/pages/UsuariosPage.jsx

import React, { useState, useEffect, useMemo } from 'react';
import { getColaboradores, cambiarEstadoColaborador } from '../services/userService.js'; 
import '../index.css'; 
import { BsPlusLg, BsSearch } from 'react-icons/bs'; 

import ModalCrearUsuario from '../components/ModalCrearUsuario.jsx'; 
import ModalEditarUsuario from '../components/ModalEditarUsuario.jsx';
import ModalConfirmarAccion from '../components/ModalConfirmarAccion.jsx';
import ModalResetPassword from '../components/ModalResetPassword.jsx'; 

const UsuariosPage = () => {
    const [usuarios, setUsuarios] = useState([]); 
    const [isLoading, setIsLoading] = useState(true); 
    const [error, setError] = useState(null); 
    
    // --- Filtros (NUEVOS) ---
    const [busqueda, setBusqueda] = useState('');
    const [filtroEstado, setFiltroEstado] = useState('');

    // --- Modales ---
    const [modalCrearAbierto, setModalCrearAbierto] = useState(false);
    const [modalEditarAbierto, setModalEditarAbierto] = useState(false);
    const [modalConfirmarAbierto, setModalConfirmarAbierto] = useState(false);
    const [modalResetAbierto, setModalResetAbierto] = useState(false); 
    const [usuarioSeleccionado, setUsuarioSeleccionado] = useState(null);
    const [accionConfirmar, setAccionConfirmar] = useState(null); 

    const cargarUsuarios = async () => {
        try {
            setIsLoading(true);
            const data = await getColaboradores();
            setUsuarios(data);
            setError(null);
        } catch (err) { setError(err.message); } finally { setIsLoading(false); }
    };
    useEffect(() => { cargarUsuarios(); }, []); 

    // --- L√ìGICA DE FILTRADO ---
    const usuariosFiltrados = useMemo(() => {
        return usuarios.filter(u => {
            const texto = busqueda.toLowerCase();
            
            // 1. B√∫squeda por Texto
            const matchTexto = 
                u.NombreCompleto.toLowerCase().includes(texto) || 
                u.CedulaUsuario.includes(texto) ||
                (u.Cargo && u.Cargo.toLowerCase().includes(texto));
            
            // 2. Filtro por Estado
            const matchEstado = filtroEstado ? u.EstadoCuenta === filtroEstado : true;

            return matchTexto && matchEstado;
        });
    }, [usuarios, busqueda, filtroEstado]);

    // --- Manejadores ---
    const handleUsuarioCreado = () => { setModalCrearAbierto(false); cargarUsuarios(); };
    const abrirModalEditar = (usuario) => { setUsuarioSeleccionado(usuario); setModalEditarAbierto(true); };
    const cerrarModalEditar = () => { setModalEditarAbierto(false); setUsuarioSeleccionado(null); };
    const handleUsuarioEditado = () => { cerrarModalEditar(); cargarUsuarios(); };
    
    const abrirModalConfirmar = (usuario) => {
        setUsuarioSeleccionado(usuario);
        const proximaAccion = usuario.EstadoCuenta === 'Activo' ? 'Inactivar' : 'Activar';
        setAccionConfirmar(proximaAccion);
        setModalConfirmarAbierto(true);
    };
    const cerrarModalConfirmar = () => { setModalConfirmarAbierto(false); setUsuarioSeleccionado(null); setAccionConfirmar(null); };
    
    const handleConfirmarCambioEstado = async () => {
        if (!usuarioSeleccionado || !accionConfirmar) return;
        const nuevoEstado = (accionConfirmar === 'Inactivar') ? 'Inactivo' : 'Activo';
        // eslint-disable-next-line no-useless-catch
        try {
            await cambiarEstadoColaborador(usuarioSeleccionado.ID_Usuario, nuevoEstado);
            cargarUsuarios();
        } catch (err) { throw err; }
    };
    
    const abrirModalReset = (usuario) => { setUsuarioSeleccionado(usuario); setModalResetAbierto(true); };
    const cerrarModalReset = () => { setModalResetAbierto(false); setUsuarioSeleccionado(null); };
    const handlePasswordReseteado = () => { cerrarModalReset(); };
    
    const getRolClass = (rol) => {
        if (rol === 'Administrador SST') return 'status-proceso'; 
        if (rol === 'Colaborador') return 'status-inactivo'; 
        return 'status-inactivo';
    };

    return (
        <div className="page-container">
            <div className="page-header">
                <h1>Gesti√≥n de Usuarios</h1>
                <button className="btn btn-primary" onClick={() => setModalCrearAbierto(true)}>
                    <BsPlusLg /> Crear Nuevo Usuario
                </button>
            </div>

            {/* --- BARRA DE FILTROS (NUEVA) --- */}
            <div className="filters-bar" style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                <div className="search-input-container" style={{ flex: 1, minWidth: '250px', position: 'relative' }}>
                    <BsSearch style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#aaa' }} />
                    <input 
                        type="text" 
                        className="form-control" 
                        placeholder="Buscar por nombre, c√©dula o cargo..." 
                        style={{ paddingLeft: '35px', height: '40px' }}
                        value={busqueda}
                        onChange={(e) => setBusqueda(e.target.value)}
                    />
                </div>
                <div className="filter-select-container" style={{ minWidth: '200px' }}>
                    <select 
                        className="form-control" 
                        style={{ height: '40px' }}
                        value={filtroEstado}
                        onChange={(e) => setFiltroEstado(e.target.value)}
                    >
                        <option value="">Todos los Estados</option>
                        <option value="Activo">Activos</option>
                        <option value="Inactivo">Inactivos</option>
                    </select>
                </div>
            </div>

            <div className="page-content-card">
                <div className="table-wrapper">
                    {isLoading && <p>Cargando usuarios...</p>}
                    {error && <p className="error-message">Error al cargar usuarios: {error}</p>}
                    
                    {!isLoading && !error && (
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre Completo</th>
                                    <th>C√©dula (Usuario)</th>
                                    <th>Rol</th>
                                    <th>√Årea/Dpto.</th>
                                    <th>Cargo</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {usuariosFiltrados.length === 0 ? (
                                    <tr><td colSpan="7" style={{ textAlign: 'center' }}>No se encontraron usuarios.</td></tr>
                                ) : (
                                    usuariosFiltrados.map((user) => (
                                        <tr key={user.ID_Usuario}>
                                            <td>{user.NombreCompleto}</td>
                                            <td>{user.CedulaUsuario}</td>
                                            <td>
                                                <span className={`status-pill ${getRolClass(user.NombreRol)}`}>
                                                    {user.NombreRol}
                                                </span>
                                            </td>
                                            <td>{user.AreaDepartamento || 'N/A'}</td>
                                            <td>{user.Cargo || 'N/A'}</td>
                                            <td>
                                                <span className={`status-pill ${user.EstadoCuenta === 'Activo' ? 'status-activo' : 'status-inactivo'}`}>
                                                    {user.EstadoCuenta}
                                                </span>
                                            </td>
                                            <td className="action-buttons">
                                                <button className="btn btn-secondary" onClick={() => abrirModalEditar(user)}>Editar</button>
                                                <button 
                                                    className={`btn ${user.EstadoCuenta === 'Activo' ? 'btn-danger' : 'btn-success'}`}
                                                    onClick={() => abrirModalConfirmar(user)}
                                                >
                                                    {user.EstadoCuenta === 'Activo' ? 'Inactivar' : 'Activar'}
                                                </button>
                                                <button className="btn btn-warning" onClick={() => abrirModalReset(user)}>Reset Pass</button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>
            
            {modalCrearAbierto && ( <ModalCrearUsuario alCerrar={() => setModalCrearAbierto(false)} alExito={handleUsuarioCreado} /> )}
            {modalEditarAbierto && ( <ModalEditarUsuario usuario={usuarioSeleccionado} alCerrar={cerrarModalEditar} alExito={handleUsuarioEditado} /> )}
            {modalConfirmarAbierto && ( <ModalConfirmarAccion titulo={`${accionConfirmar} Usuario`} mensaje={`¬øEst√°s seguro de que deseas ${accionConfirmar.toLowerCase()} a ${usuarioSeleccionado?.NombreCompleto}?`} enConfirmar={handleConfirmarCambioEstado} alCerrar={cerrarModalConfirmar} textoBotonConfirmar={accionConfirmar} claseBoton={accionConfirmar === 'Inactivar' ? 'btn-danger' : 'btn-success'} /> )}
            {modalResetAbierto && ( <ModalResetPassword usuario={usuarioSeleccionado} alCerrar={cerrarModalReset} alExito={handlePasswordReseteado} /> )}
        </div>
    );
};
export default UsuariosPage;


==================================================================
ARCHIVO: frontend\src\services\acpmService.js
==================================================================
// frontend/src/services/acpmService.js

import { apiFetch } from './apiService.js';

/**
 * @service getACPMs
 * @desc Obtiene la lista de todas las acciones ACPM (Admin)
 */
export const getACPMs = async () => {
    return apiFetch('/acpm'); // GET /api/acpm
};

/**
 * @service getACPMDetalle
 * @desc Obtiene el detalle de una ACPM espec√≠fica (Admin)
 * @param {number} idACPM
 */
export const getACPMDetalle = async (idACPM) => {
    return apiFetch(`/acpm/${idACPM}`); // GET /api/acpm/:id
};

/**
 * @service crearACPM
 * @desc Crea una nueva acci√≥n ACPM (CU-03)
 * @param {object} datosACPM
 */
export const crearACPM = async (datosACPM) => {
    return apiFetch('/acpm', {
        method: 'POST',
        body: JSON.stringify(datosACPM),
    }); // POST /api/acpm
};

/**
 * @service gestionarACPM
 * @desc Actualiza estado, comentarios y sube evidencia de cierre (CU-04)
 * @param {number} idACPM
 * @param {FormData} formData - FormData con estado, comentarios y archivo
 */
export const gestionarACPM = async (idACPM, formData) => {
    const token = localStorage.getItem('token');
    
    const response = await fetch(`http://localhost:5000/api/acpm/${idACPM}`, {
        method: 'PATCH',
        headers: {
            'Authorization': `Bearer ${token}`,
        },
        body: formData,
    });

    const data = await response.json();
    if (!response.ok) {
        throw new Error(data.msg || 'Error al gestionar la ACPM');
    }
    return data;
};

/**
 * @service getEvidenciasPorACPM
 * @desc Obtiene la lista de archivos de evidencia de una ACPM
 * @param {number} idACPM
 */
export const getEvidenciasPorACPM = async (idACPM) => {
    return apiFetch(`/acpm/${idACPM}/evidencias`); // <--- NUEVA FUNCI√ìN
};


==================================================================
ARCHIVO: frontend\src\services\apiService.js
==================================================================
// frontend/src/services/apiService.js

// Ajusta la ruta seg√∫n donde tengas tu authService
import { getCurrentToken } from './authService';

const BASE_URL = 'http://localhost:5000/api';

/**
 * Funci√≥n 1: Para peticiones de datos (JSON)
 * Usada en: Login, Listados, Crear usuarios, etc.
 */
export const apiFetch = async (endpoint, options = {}) => {
    const token = getCurrentToken(); 

    const config = {
        ...options, 
        headers: {
            'Content-Type': 'application/json',
            ...options.headers, 
        },
    };

    if (token) {
        config.headers['Authorization'] = `Bearer ${token}`;
    }

    try {
        const response = await fetch(`${BASE_URL}${endpoint}`, config);
        
        // Intentamos leer la respuesta como JSON
        let data;
        // Si la respuesta no tiene contenido (204), no intentamos parsear
        if (response.status !== 204) {
            try {
                data = await response.json();
            // eslint-disable-next-line no-unused-vars
            } catch (jsonError) {
                // Si falla el parseo (ej. error 500 html), capturamos el texto
                data = { msg: `Error inesperado: ${response.statusText}` };
            }
        }

        if (!response.ok) {
            throw new Error(data?.msg || data?.errors?.[0]?.msg || 'Error en la petici√≥n a la API');
        }

        return data;

    } catch (error) {
        console.error(`Error en apiFetch (${endpoint}):`, error);
        throw error; 
    }
};

/**
 * Funci√≥n 2: Para DESCARGAR archivos (Blob/Binarios)
 * Usada en: Descargar PDF de ex√°menes, Descargar documentos adjuntos.
 * IMPORTANTE: No espera JSON, espera un "Blob" (archivo crudo).
 */
export const apiFetchBlob = async (endpoint, options = {}) => {
    const token = getCurrentToken(); 

    const config = {
        ...options,
        headers: {
            // Nota: AQU√ç NO PONEMOS 'Content-Type': 'application/json'
            ...options.headers,
        },
    };

    if (token) {
        config.headers['Authorization'] = `Bearer ${token}`;
    }

    try {
        const response = await fetch(`${BASE_URL}${endpoint}`, config);

        if (!response.ok) {
            throw new Error(`Error al descargar el archivo: ${response.status} ${response.statusText}`);
        }

        // Retornamos el archivo crudo (Blob)
        return await response.blob();

    } catch (error) {
        console.error(`Error en apiFetchBlob (${endpoint}):`, error);
        throw error;
    }
};


==================================================================
ARCHIVO: frontend\src\services\assetService.js
==================================================================
// frontend/src/services/assetService.js

import { apiFetch } from './apiService.js';

export const getActivosTodos = async () => {
    return apiFetch('/activos');
};

export const getActivosPorTipo = async (tipoActivo) => {
    return apiFetch(`/activos/tipo/${tipoActivo}`);
};

/**
 * @service getTiposActivosDisponibles
 * @desc Obtiene la lista de tipos de activos (din√°mica desde la BD)
 */
export const getTiposActivosDisponibles = async () => {
    return apiFetch('/activos/tipos'); // GET /api/activos/tipos
};

export const crearActivo = async (datosActivo) => {
    return apiFetch('/activos', { method: 'POST', body: JSON.stringify(datosActivo) });
};

export const actualizarActivo = async (idActivo, datosActivo) => {
    return apiFetch(`/activos/${idActivo}`, { method: 'PUT', body: JSON.stringify(datosActivo) });
};

export const eliminarActivo = async (idActivo) => {
    return apiFetch(`/activos/${idActivo}`, { method: 'DELETE' });
};


==================================================================
ARCHIVO: frontend\src\services\authService.js
==================================================================
// frontend/src/services/authService.js

// La URL base de tu API de backend
const API_URL = 'http://localhost:5000/api/auth';

/**
 * @service login
 * @desc Llama al endpoint /api/auth/login
 * @param {string} cedula
 * @param {string} password
 * @returns {object} { token }
 */
export const login = async (cedula, password) => {
    try {
        const response = await fetch(`${API_URL}/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ cedula, password }),
        });

        const data = await response.json();

        if (!response.ok) {
            // Si la respuesta no es 2xx, lanza un error (ej. "Credenciales inv√°lidas")
            throw new Error(data.msg || 'Error al iniciar sesi√≥n');
        }

        // Si el login es exitoso (respuesta 200 OK)
        if (data.token) {
            // Guarda el token en el localStorage para persistir la sesi√≥n
            localStorage.setItem('token', data.token);
        }
        
        return data; // Devuelve { token }

    } catch (error) {
        console.error('Error en authService.login:', error);
        // Lanza el error para que el componente de la UI lo atrape
        throw error;
    }
};

/**
 * @service logout
 * @desc Cierra la sesi√≥n del usuario
 */
export const logout = () => {
    // Simplemente remueve el token del almacenamiento
    localStorage.removeItem('token');
};

/**
 * @service getCurrentToken
 * @desc Obtiene el token actual del localStorage
 */
export const getCurrentToken = () => {
    return localStorage.getItem('token');
};


==================================================================
ARCHIVO: frontend\src\services\budgetService.js
==================================================================
import { apiFetch } from './apiService';

export const getPresupuestos = async (anio) => {
    return apiFetch(`/presupuesto?anio=${anio}`);
};

export const getDetalleGastos = async (idPresupuesto) => {
    return apiFetch(`/presupuesto/${idPresupuesto}/gastos`);
};

export const crearPresupuesto = async (datos) => {
    return apiFetch('/presupuesto/asignar', {
        method: 'POST',
        body: JSON.stringify(datos)
    });
};

export const registrarGasto = async (formData) => {
    const token = localStorage.getItem('token');
    const response = await fetch('http://localhost:5000/api/presupuesto/gastar', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }, // Sin Content-Type por ser FormData
        body: formData
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.msg || 'Error registrando gasto');
    return data;
};

export const editarPresupuesto = async (id, datos) => {
    return apiFetch(`/presupuesto/${id}`, {
        method: 'PUT',
        body: JSON.stringify(datos)
    });
};

export const eliminarPresupuesto = async (id) => {
    return apiFetch(`/presupuesto/${id}`, {
        method: 'DELETE'
    });
};


==================================================================
ARCHIVO: frontend\src\services\committeeService.js
==================================================================
// frontend/src/services/committeeService.js
import { apiFetch, apiFetchBlob } from './apiService';

export const crearActa = async (formData) => {
    const token = localStorage.getItem('token');
    const response = await fetch('http://localhost:5000/api/actas', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData 
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.msg || 'Error al guardar');
    return data;
};

export const getActas = async () => {
    return apiFetch('/actas');
};

export const actualizarArchivoActa = async (idActa, formData) => {
    const token = localStorage.getItem('token');
    const response = await fetch(`http://localhost:5000/api/actas/${idActa}/archivo`, {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData 
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.msg || 'Error al actualizar archivo');
    return data;
};

// --- NUEVAS FUNCIONES ---

export const subirFirmasActa = async (idActa, formData) => {
    const token = localStorage.getItem('token');
    const response = await fetch(`http://localhost:5000/api/actas/${idActa}/firmas`, {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData 
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.msg || 'Error al subir firmas');
    return data;
};

export const descargarActa = async (idActa, tipo) => {
    // Tipo puede ser 'original' o 'firmas'
    return apiFetchBlob(`/actas/${idActa}/download?tipo=${tipo}`);
};


==================================================================
ARCHIVO: frontend\src\services\dashboardService.js
==================================================================
// frontend/src/services/dashboardService.js

import { apiFetch } from './apiService.js';

/**
 * @service getAdminKPIs
 * @desc Obtiene los 4 KPIs (contadores) para el dashboard del Admin
 */
export const getAdminKPIs = async () => {
    return apiFetch('/dashboard/admin-kpis');
};

/**
 * @service getAdminActividadesPendientes
 * @desc Obtiene la lista Top 5 de actividades pendientes
 */
export const getAdminActividadesPendientes = async () => {
    return apiFetch('/dashboard/admin-actividades');
};

/**
 * @service getAdminActividadesEstado
 * @desc Obtiene los datos para la gr√°fica de pastel de actividades (NUEVO)
 */
export const getAdminActividadesEstado = async () => {
    return apiFetch('/dashboard/admin-actividades-estado');
};

/**
 * @service getAdminReportesRecientes
 * @desc Obtiene la lista Top 5 de reportes nuevos
 */
export const getAdminReportesRecientes = async () => {
    return apiFetch('/dashboard/admin-reportes');
};


==================================================================
ARCHIVO: frontend\src\services\documentService.js
==================================================================
// frontend/src/services/documentService.js

import { apiFetch } from './apiService.js';
import Swal from 'sweetalert2';

/**
 * @service getContenidoCarpeta
 * @desc Obtiene las carpetas y archivos de un ID de carpeta
 */
export const getContenidoCarpeta = async (idCarpeta) => {
    return apiFetch(`/documentos/carpeta/${idCarpeta}`); 
};

/**
 * @service crearCarpeta
 * @desc Crea una nueva carpeta (CU-25)
 */
export const crearCarpeta = async (nombreCarpeta, idCarpetaPadre) => {
    return apiFetch('/documentos/carpeta', {
        method: 'POST',
        body: JSON.stringify({ nombreCarpeta, idCarpetaPadre }),
    }); 
};

/**
 * @service subirArchivos
 * @desc Sube uno o m√°s archivos (CU-26)
 */
export const subirArchivos = async (formData) => {
    const token = localStorage.getItem('token');
    
    const response = await fetch('http://localhost:5000/api/documentos/upload', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData,
    });

    const data = await response.json();
    if (!response.ok) {
        throw new Error(data.msg || 'Error al subir los archivos');
    }
    return data;
};

/**
 * @service descargarDocumento
 * @desc Descarga un archivo de forma segura usando token (CU-27)
 */
export const descargarDocumento = async (idDocumento, nombreOriginal) => {
    const token = localStorage.getItem('token');
    const response = await fetch(`http://localhost:5000/api/documentos/descargar/${idDocumento}`, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!response.ok) {
        try { const errData = await response.json(); throw new Error(errData.msg || 'No se pudo descargar');} 
        // eslint-disable-next-line no-unused-vars
        catch (e) { throw new Error(`Error ${response.status}: No se pudo descargar el archivo.`); }
    }
    
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = nombreOriginal; 
    document.body.appendChild(a); 
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
};

/**
 * @service getDocumentoBlob
 * @desc Obtiene un archivo como un Blob para visualizaci√≥n (Tanda 3.D)
 * @param {number} idDocumento
 */
export const getDocumentoBlob = async (idDocumento) => {
    const token = localStorage.getItem('token');
    const response = await fetch(`http://localhost:5000/api/documentos/stream/${idDocumento}`, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!response.ok) {
        throw new Error('No se pudo cargar el documento para visualizaci√≥n.');
    }
    return await response.blob();
};


/**
 * @service eliminarDocumento
 * @desc Elimina un documento (CU-28)
 */
export const eliminarDocumento = async (idDocumento) => {
    return apiFetch(`/documentos/documento/${idDocumento}`, {
        method: 'DELETE',
    }); 
};

/**
 * @service eliminarCarpeta
 * @desc Elimina una carpeta (CU-25)
 */
export const eliminarCarpeta = async (idCarpeta) => {
    return apiFetch(`/documentos/carpeta/${idCarpeta}`, {
        method: 'DELETE',
    }); 
};


==================================================================
ARCHIVO: frontend\src\services\historyService.js
==================================================================
// frontend/src/services/historyService.js
import { apiFetch } from './apiService';

// CAMBIO: Recibe cedula
export const getHistorialColaborador = async (cedula) => {
    return apiFetch(`/historial/colaborador/${cedula}`);
};

export const getHistorialActivo = async (idActivo) => {
    return apiFetch(`/historial/activo/${idActivo}`);
};


==================================================================
ARCHIVO: frontend\src\services\indicatorService.js
==================================================================
// frontend/src/services/indicatorService.js
import { apiFetch } from './apiService.js';

export const guardarIndicador = async (datos) => {
    return apiFetch('/indicadores', {
        method: 'POST',
        body: JSON.stringify(datos)
    });
};

export const getIndicadoresAnuales = async (anio) => {
    return apiFetch(`/indicadores/${anio}`);
};

export const eliminarRegistroIndicador = async (idRegistro) => {
    return apiFetch(`/indicadores/registro/${idRegistro}`, {
        method: 'DELETE'
    });
};

// --- Configuraciones ---
export const getConfiguracionesIndicadores = async () => {
    return apiFetch('/indicadores/config/todos');
};

export const crearConfiguracionIndicador = async (datos) => {
    return apiFetch('/indicadores/config', {
        method: 'POST',
        body: JSON.stringify(datos)
    });
};

export const editarConfiguracionIndicador = async (idConfig, datos) => {
    return apiFetch(`/indicadores/config/${idConfig}`, { // <--- NUEVA
        method: 'PUT',
        body: JSON.stringify(datos)
    });
};

export const eliminarConfiguracionIndicador = async (idConfig) => {
    return apiFetch(`/indicadores/config/${idConfig}`, {
        method: 'DELETE'
    });
};


==================================================================
ARCHIVO: frontend\src\services\inspectionService.js
==================================================================
// frontend/src/services/inspectionService.js

import { apiFetch } from './apiService.js';

export const getInspeccionesHistorial = async () => {
    return apiFetch('/inspecciones');
};

export const crearInspeccion = async (payload) => {
    return apiFetch('/inspecciones', {
        method: 'POST',
        body: JSON.stringify(payload),
    });
};

export const getInspeccionDetalle = async (id) => {
    return apiFetch(`/inspecciones/${id}`);
};

export const crearNuevoFormulario = async (datos) => {
    return apiFetch('/inspecciones/formularios', {
        method: 'POST',
        body: JSON.stringify(datos),
    });
};

export const getFormularios = async () => {
    return apiFetch('/inspecciones/formularios');
};

export const getPreguntasFormulario = async (idFormulario) => {
    return apiFetch(`/inspecciones/formularios/${idFormulario}/preguntas`);
};

export const agregarPregunta = async (idFormulario, textoPregunta) => {
    return apiFetch(`/inspecciones/formularios/${idFormulario}/preguntas`, {
        method: 'POST',
        body: JSON.stringify({ textoPregunta })
    });
};

export const eliminarPregunta = async (idPregunta) => {
    return apiFetch(`/inspecciones/preguntas/${idPregunta}`, {
        method: 'DELETE'
    });
};

export const toggleVisibilidadFormulario = async (idFormulario, visible) => {
    return apiFetch(`/inspecciones/formularios/${idFormulario}/visibilidad`, {
        method: 'PATCH',
        body: JSON.stringify({ visible })
    });
};

// --- NUEVAS FUNCIONES ---

export const getTiposActivosUnicos = async () => {
    return apiFetch('/inspecciones/activos/tipos-unicos');
};

export const editarFormulario = async (idFormulario, datos) => {
    return apiFetch(`/inspecciones/formularios/${idFormulario}`, {
        method: 'PUT',
        body: JSON.stringify(datos)
    });
};

export const eliminarFormulario = async (idFormulario) => {
    return apiFetch(`/inspecciones/formularios/${idFormulario}`, {
        method: 'DELETE'
    });
};


==================================================================
ARCHIVO: frontend\src\services\logService.js
==================================================================
// frontend/src/services/logService.js
import { apiFetch } from './apiService.js';

/**
 * @service buscarLogs
 * @desc (Admin) Obtiene la lista de registros de auditor√≠a filtrados
 * @param {object} filtros - { idUsuario, accion, fechaInicio, fechaFin }
 */
export const buscarLogs = async (filtros) => {
    return apiFetch('/logs/buscar', {
        method: 'POST',
        body: JSON.stringify(filtros || {}),
    }); // POST /api/logs/buscar
};

/**
 * @service getLogFiltros
 * @desc (Admin) Obtiene las listas de usuarios y acciones para los filtros
 */
export const getLogFiltros = async () => {
    return apiFetch('/logs/filtros'); // GET /api/logs/filtros
};


==================================================================
ARCHIVO: frontend\src\services\medicalService.js
==================================================================
// frontend/src/services/medicalService.js

import { apiFetch } from './apiService.js';

export const getHistorialExamenes = async () => {
    return apiFetch('/medicina'); 
};

export const registrarExamen = async (datosExamen) => {
    return apiFetch('/medicina', {
        method: 'POST',
        body: JSON.stringify(datosExamen),
    }); 
};

export const getExamenMedicoDetalle = async (idExamenMedico) => {
    return apiFetch(`/medicina/${idExamenMedico}`); 
};

/**
 * @service generarPdfExamen
 * @desc Genera y descarga el PDF enviando los datos del encabezado
 */
export const generarPdfExamen = async (idExamenMedico, cedulaColaborador, headerData) => {
    const token = localStorage.getItem('token');
    
    // Usamos POST para enviar el JSON con los datos del encabezado
    const response = await fetch(`http://localhost:5000/api/medicina/${idExamenMedico}/pdf`, {
        method: 'POST',
        headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json' 
        },
        body: JSON.stringify(headerData)
    });

    if (!response.ok) {
        throw new Error(`Error ${response.status}: No se pudo generar el PDF.`);
    }
    
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Recomendaciones-${cedulaColaborador}.pdf`; 
    document.body.appendChild(a); 
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
};


==================================================================
ARCHIVO: frontend\src\services\notificationService.js
==================================================================
// backend/services/notificationService.js
import { poolPromise, mssql } from '../config/dbConfig.js';

/**
 * @desc Crea una notificaci√≥n en la BD
 * @param {Object} data - { idUsuarioDestino, rolDestino, titulo, mensaje, ruta }
 */
export const crearNotificacion = async ({ idUsuarioDestino, rolDestino, titulo, mensaje, ruta }) => {
    try {
        const pool = await poolPromise;
        await pool.request()
            .input('idUsuarioDestino', mssql.Int, idUsuarioDestino || null)
            .input('rolDestino', mssql.NVarChar, rolDestino || null)
            .input('titulo', mssql.NVarChar, titulo)
            .input('mensaje', mssql.NVarChar, mensaje)
            .input('rutaAccion', mssql.NVarChar, ruta || null)
            .query('EXEC SP_CREATE_Notificacion @idUsuarioDestino, @rolDestino, @titulo, @mensaje, @rutaAccion');
    } catch (err) {
        console.error('Error creando notificaci√≥n interna:', err.message);
        // No lanzamos error para no interrumpir el flujo principal
    }
};


==================================================================
ARCHIVO: frontend\src\services\pesvService.js
==================================================================
// frontend/src/services/pesvService.js
import { apiFetch } from './apiService.js';

// --- CONDUCTORES ---
export const getConductoresPESV = async () => {
    return apiFetch('/pesv/conductores');
};

export const guardarInfoConductor = async (datos) => {
    return apiFetch('/pesv/conductores', {
        method: 'POST',
        body: JSON.stringify(datos)
    });
};

// --- MANTENIMIENTOS ---
export const getMantenimientos = async (idActivo = null) => {
    const query = idActivo ? `?idActivo=${idActivo}` : '';
    return apiFetch(`/pesv/mantenimientos${query}`);
};

export const crearMantenimiento = async (datos) => {
    return apiFetch('/pesv/mantenimientos', {
        method: 'POST',
        body: JSON.stringify(datos)
    });
};


==================================================================
ARCHIVO: frontend\src\services\reportService.js
==================================================================
// frontend/src/services/reportService.js

import { apiFetch } from './apiService.js';

// --- Para el Administrador ---

export const getReportesMaquina = async () => {
    return apiFetch('/reportes/maquina'); 
};
export const getReportesSeguridad = async () => {
    return apiFetch('/reportes/seguridad'); 
};
export const getReporteMaquinaDetalle = async (idReporte) => {
    return apiFetch(`/reportes/maquina/${idReporte}`);
};
export const getReporteSeguridadDetalle = async (idReporte) => {
    return apiFetch(`/reportes/seguridad/${idReporte}`); 
};

// --- Para el Colaborador ---

/**
 * @service crearReporteMaquina
 * @desc Env√≠a un nuevo reporte de estado de m√°quina (CU-07)
 * @param {FormData} formData - FormData con los datos y el archivo
 */
export const crearReporteMaquina = async (formData) => {
    // Usa fetch directo para FormData
    const token = localStorage.getItem('token');
    
    const response = await fetch('http://localhost:5000/api/reportes/maquina', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
        },
        body: formData,
    });

    const data = await response.json();
    if (!response.ok) {
        throw new Error(data.msg || 'Error al enviar el reporte');
    }
    return data;
};

/**
 * @service crearReporteSeguridad
 * @desc Env√≠a un nuevo reporte de seguridad con foto opcional (CU-08)
 */
export const crearReporteSeguridad = async (formData) => {
    const token = localStorage.getItem('token');
    const response = await fetch('http://localhost:5000/api/reportes/seguridad', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData,
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.msg || 'Error al enviar el reporte');
    return data;
};

export const getMisReportesMaquina = async () => {
    return apiFetch('/reportes/maquina/mis-reportes');
};
export const getMisReportesSeguridad = async () => {
    return apiFetch('/reportes/seguridad/mis-reportes');
};


==================================================================
ARCHIVO: frontend\src\services\requestService.js
==================================================================
// frontend/src/services/requestService.js

import { apiFetch } from './apiService';

// URL Base (Ajusta si tu puerto cambia)
const API_URL = 'http://localhost:5000/api';

// Obtener lista de solicitudes (SST ve las suyas, Admin ve todas)
export const getSolicitudes = async () => {
    return apiFetch('/solicitudes');
};

// Responder una solicitud (Solo Admin)
export const responderSolicitud = async (idSolicitud, estado, comentario) => {
    return apiFetch('/solicitudes/responder', {
        method: 'PUT',
        body: JSON.stringify({ idSolicitud, estado, comentario })
    });
};

// Enviar nueva solicitud con archivo adjunto (SST)
export const crearSolicitud = async (formData) => {
    const token = localStorage.getItem('token');
    
    // Usamos fetch directo aqu√≠ porque FormData requiere headers especiales
    // que apiFetch podr√≠a sobreescribir con 'application/json'
    const response = await fetch(`${API_URL}/solicitudes`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`
            // NO agregamos 'Content-Type' para que el navegador ponga el 'multipart/form-data' con el boundary correcto
        },
        body: formData
    });

    const data = await response.json();

    if (!response.ok) {
        throw new Error(data.msg || 'Error al enviar la solicitud');
    }

    return data;
};


==================================================================
ARCHIVO: frontend\src\services\scheduleService.js
==================================================================
// frontend/src/services/scheduleService.js

import { apiFetch } from './apiService.js';

export const crearCronograma = async (datos) => {
    return apiFetch('/cronogramas', {
        method: 'POST',
        body: JSON.stringify(datos),
    });
};

export const getCronogramas = async () => {
    return apiFetch('/cronogramas');
};

export const eliminarCronograma = async (idCronograma) => {
    return apiFetch(`/cronogramas/${idCronograma}`, {
        method: 'DELETE'
    });
};

export const crearActividad = async (idCronograma, datos) => {
    return apiFetch(`/cronogramas/${idCronograma}/actividades`, {
        method: 'POST',
        body: JSON.stringify(datos),
    });
};

export const getActividadesPorCronograma = async (idCronograma) => {
    return apiFetch(`/cronogramas/${idCronograma}/actividades`);
};

export const editarActividad = async (idActividad, datos) => {
    return apiFetch(`/actividades/${idActividad}`, {
        method: 'PUT',
        body: JSON.stringify(datos),
    });
};

export const eliminarActividad = async (idActividad) => {
    return apiFetch(`/actividades/${idActividad}`, {
        method: 'DELETE',
    });
};

export const gestionarActividad = async (idActividad, formData) => {
    const token = localStorage.getItem('token');
    const response = await fetch(`http://localhost:5000/api/actividades/${idActividad}/estado`, {
        method: 'PATCH',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData,
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.msg || 'Error al gestionar actividad');
    return data;
};

/**
 * @service getActividadDetalle
 * @desc Obtiene el detalle de una sola actividad
 */
export const getActividadDetalle = async (idActividad) => {
    return apiFetch(`/actividades/${idActividad}`);
};

// --- AQU√ç EST√Å LA FUNCI√ìN EXPORTADA ---
export const getEvidenciasActividad = async (idActividad) => {
    return apiFetch(`/actividades/${idActividad}/evidencias`);
};


==================================================================
ARCHIVO: frontend\src\services\userService.js
==================================================================
// frontend/src/services/userService.js

import { apiFetch } from './apiService.js';

// --- CRUD DE USUARIOS LOCALES ---

export const getColaboradores = async () => {
    return apiFetch('/usuarios');
};

export const getTodosUsuarios = async () => {
    return apiFetch('/usuarios/todos');
};

export const getUsuarioByCedula = async (cedula) => {
    return apiFetch(`/usuarios/cedula/${cedula}`);
};

export const getRoles = async () => {
    return apiFetch('/usuarios/roles');
};

// --- NUEVA FUNCI√ìN: TRAER CARGOS DE BD ---
export const getCargosEmpresa = async () => {
    return apiFetch('/usuarios/cargos');
};

export const crearColaborador = async (datosUsuario) => {
    return apiFetch('/usuarios', {
        method: 'POST',
        body: JSON.stringify(datosUsuario),
    });
};

export const editarColaborador = async (id, datosUsuario) => {
    const { nombreCompleto, area, cargo } = datosUsuario;
    return apiFetch(`/usuarios/${id}`, {
        method: 'PUT',
        body: JSON.stringify({ nombreCompleto, area, cargo }),
    });
};

export const cambiarEstadoColaborador = async (id, estado) => {
    return apiFetch(`/usuarios/${id}/estado`, {
        method: 'PATCH',
        body: JSON.stringify({ estado }),
    });
};

export const resetPasswordColaborador = async (id, password) => {
    return apiFetch(`/usuarios/${id}/reset-password`, {
        method: 'PATCH',
        body: JSON.stringify({ password }),
    });
};

// --- B√öSQUEDA EN DIRECTORIO EXTERNO (GOSEN) ---
export const buscarUsuarioExterno = async (query) => {
    // Llama a tu backend, el cual llama al microservicio
    const safeQuery = query || '';
    return apiFetch(`/usuarios/externos/buscar?query=${safeQuery}`);
};


==================================================================
ARCHIVO: frontend\src\style\ColaboradorLayout.css
==================================================================
/* frontend/src/style/ColaboradorLayout.css */

.colaborador-layout {
    display: flex;
    flex-direction: column;
    width: 100%;
    min-height: 100vh;
    background-color: #f4f7f6; /* Fondo gris claro */
}

/* El contenido de la p√°gina del colaborador (centrado y con ancho m√°x) */
.colaborador-page-content {
    width: 100%;
    max-width: 1200px; /* Ancho m√°ximo del contenido */
    margin: 0 auto; /* Centrado */
    padding: 2rem;
    flex: 1;
}


==================================================================
ARCHIVO: frontend\src\style\DashboardAdmin.css
==================================================================
/* frontend/src/style/DashboardAdmin.css */

.dashboard-admin-header {
    margin-bottom: 2rem;
}
.dashboard-admin-header h1 {
    font-size: 2rem;
    font-weight: 600;
    color: #212529;
    margin: 0;
}
.dashboard-admin-header p {
    font-size: 1.1rem;
    color: #6c757d;
    margin: 0.25rem 0 0 0;
}

/* --- Contenedor de Widgets KPIs --- */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); 
    gap: 1.5rem;
    margin-bottom: 2.5rem;
}

/* --- TARJETA KPI (AHORA ES UN ENLACE) --- */
.kpi-card-link {
    text-decoration: none; /* Quita el subrayado del enlace */
}

.kpi-card {
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    padding: 1.5rem;
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
}
/* Efecto hover en la tarjeta */
.kpi-card-link:hover .kpi-card {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    border-color: #007BFF; /* Azul acento */
}

.kpi-card h3 {
    font-size: 1rem;
    font-weight: 600;
    color: #6c757d; 
    text-transform: uppercase;
    margin: 0 0 0.5rem 0;
}

.kpi-card .kpi-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #005A5B; 
}
/* Colores espec√≠ficos para valores */
.kpi-card.kpi-inspecciones .kpi-value { color: #007BFF; }
.kpi-card.kpi-reportes-maq .kpi-value { color: #f57f17; }
.kpi-card.kpi-reportes-seg .kpi-value { color: #dc3545; }
.kpi-card.kpi-acpm .kpi-value { color: #005A5B; }


/* --- Cuadr√≠cula de Listas (2 columnas) --- */
.dashboard-lists-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* 2 columnas */
    gap: 2rem;
}

.dashboard-list-card {
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid #dee2e6;
    padding: 1.5rem;
}

/* --- T√çTULO DE LA LISTA (AHORA ES UN ENLACE) --- */
.dashboard-list-card h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 0 1rem 0;
    border-bottom: 2px solid #f4f7f6;
    padding-bottom: 0.75rem;
}
.dashboard-list-card h2 a {
    text-decoration: none;
    color: #212529; /* Color de texto normal */
    transition: color 0.2s ease;
}
.dashboard-list-card h2 a:hover {
    color: #007BFF; /* Se pone azul al pasar el mouse */
}
/* --- FIN DEL CAMBIO DE ENLACE --- */


.dashboard-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0.25rem;
    border-bottom: 1px solid #f0f2f5;
    font-size: 0.95rem;
}
.dashboard-list-item:last-child {
    border-bottom: none;
}

.dashboard-list-item .item-info {
    font-weight: 500;
    color: #333;
}
.dashboard-list-item .item-date {
    font-weight: 600;
    color: #dc3545; /* Rojo para fechas l√≠mite */
    flex-shrink: 0;
    margin-left: 1rem;
}
.dashboard-list-item .item-type {
    font-size: 0.85rem;
    color: #6c757d;
}

/* Responsividad */
@media (max-width: 992px) {
    .kpi-grid {
        grid-template-columns: 1fr 1fr;
    }
    .dashboard-lists-grid {
        grid-template-columns: 1fr; 
    }
}
@media (max-width: 576px) {
    .kpi-grid {
        grid-template-columns: 1fr;
    }
}


==================================================================
ARCHIVO: frontend\src\style\DashboardColaborador.css
==================================================================
/* frontend/src/style/DashboardColaborador.css */

.dashboard-colaborador-header {
    margin-bottom: 2rem;
}
.dashboard-colaborador-header h1 {
    font-size: 2rem;
    font-weight: 600;
    color: #212529;
    margin: 0;
}

.report-cards-container {
    display: grid;
    /* Dos columnas de igual tama√±o */
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 3rem;
}

.report-card {
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    padding: 2rem;
    text-decoration: none;
    color: #212529;
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}
.report-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    border-color: #005A5B; /* Verde corporativo */
}

.report-card h2 {
    font-size: 1.5rem;
    color: #005A5B; /* Verde corporativo */
    margin: 0 0 0.5rem 0;
}
.report-card p {
    font-size: 0.95rem;
    color: #6c757d;
    margin: 0;
}

/* Estilos para la tabla de historial */
.historial-section h2 {
    font-size: 1.5rem;
    font-weight: 600;
    color: #212529;
    margin-bottom: 1.5rem;
}


==================================================================
ARCHIVO: frontend\src\style\DocumentosPage.css
==================================================================
/* frontend/src/style/DocumentosPage.css */

/* --- Barra de Herramientas (CORREGIDA) --- */
.docs-toolbar {
    display: flex;
    justify-content: space-between; /* Separa extremos */
    align-items: center; /* Centra verticalmente */
    margin-bottom: 1.5rem;
    background-color: #fff;
    padding: 0.8rem 1.2rem; /* Padding ajustado */
    border-radius: 12px;
    border: 1px solid var(--color-border);
    box-shadow: var(--shadow-sm);
    gap: 1rem;
}

/* --- Breadcrumbs Estilo C√°psula --- */
.document-breadcrumb {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
    color: var(--color-text-secondary);
    flex-wrap: wrap; /* Permite bajar si hay muchas carpetas */
    flex: 1; /* Ocupa el espacio disponible a la izquierda */
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 20px;
    transition: background 0.2s, color 0.2s;
    background-color: transparent;
}

.breadcrumb-item:hover {
    background-color: #f1f3f5;
    color: var(--color-acento);
}

.breadcrumb-item.active {
    background-color: #e7f1ff;
    color: var(--color-acento);
    font-weight: 600;
    cursor: default;
}

.breadcrumb-separator {
    color: #adb5bd;
    font-size: 0.7rem;
}

/* --- Buscador Local (CORREGIDO) --- */
.docs-search {
    position: relative;
    width: 300px; /* Ancho fijo para que no se encoja */
    flex-shrink: 0; /* Evita que se aplaste */
}

.docs-search input {
    width: 100%;
    padding: 10px 15px 10px 40px; /* Espacio para el icono */
    border-radius: 50px;
    border: 1px solid #dee2e6;
    font-size: 0.9rem;
    background-color: #f8f9fa;
    transition: all 0.2s;
    box-sizing: border-box; /* Importante para el padding */
}

.docs-search input:focus {
    background-color: #fff;
    border-color: var(--color-acento);
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    outline: none;
}

.docs-search svg {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #999;
    font-size: 1rem;
}

/* --- Lista de Documentos --- */
.document-list-container {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.document-list-header {
    display: grid;
    grid-template-columns: 50px 3fr 1fr 1fr 100px;
    padding: 0 1.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.75rem;
    font-weight: 700;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.document-row {
    display: grid;
    grid-template-columns: 50px 3fr 1fr 1fr 100px;
    align-items: center;
    background-color: #ffffff;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 0.8rem 1.5rem;
    transition: all 0.2s ease;
}

.document-row:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    border-color: var(--color-acento);
    z-index: 2;
}

.doc-icon-wrapper {
    font-size: 1.5rem;
    display: flex;
    align-items: center;
}

.doc-info-main {
    display: flex;
    flex-direction: column;
    justify-content: center;
    overflow: hidden;
}

.doc-name {
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--color-text);
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.doc-name:hover {
    color: var(--color-acento);
    text-decoration: underline;
}

.doc-meta-mobile { display: none; }

.doc-date, .doc-size {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
}

.doc-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
}

/* --- Estado Vac√≠o --- */
.empty-state-docs {
    text-align: center;
    padding: 3rem;
    color: #adb5bd;
    background: #fff;
    border-radius: 12px;
    border: 2px dashed #dee2e6;
}
.empty-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }

/* --- Responsive --- */
@media (max-width: 768px) {
    .docs-toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    .docs-search { width: 100%; }
    
    .document-list-header { display: none; }
    
    .document-row {
        grid-template-columns: 40px 1fr 50px; /* Icono | Info | Actions */
        padding: 1rem;
    }
    
    .doc-date, .doc-size { display: none; }
    .doc-meta-mobile { 
        display: block; 
        font-size: 0.75rem; 
        color: #888; 
        margin-top: 2px; 
    }
}


==================================================================
ARCHIVO: frontend\src\style\Header.css
==================================================================
/* frontend/src/style/Header.css */

.header-container {
    display: flex;
    justify-content: flex-end; /* Alinea todo a la derecha por defecto */
    align-items: center;
    padding: 1rem 2rem;
    height: 70px;
    background-color: #FFFFFF;
    border-bottom: 1px solid #dee2e6;
    position: relative; /* Necesario para elementos absolutos hijos */
    gap: 1rem; /* Espacio entre el bot√≥n men√∫ y el resto */
}

/* --- BOT√ìN DE MEN√ö (HAMBURGUESA) --- */
.header-toggle-btn {
    display: none; /* Oculto por defecto en Desktop */
    background: transparent;
    border: none;
    font-size: 1.8rem;
    color: var(--color-primario); /* Verde corporativo */
    cursor: pointer;
    padding: 5px;
    margin-right: auto; /* Empuja el resto a la derecha en flexbox */
}

/* Placeholder para empujar contenido */
.header-title-placeholder {
    flex-grow: 1;
}

/* --- LOGO --- */
.sidebar-logo-img3 {
    width: 160px;
    height: auto; 
    position: absolute;
    left: 2rem;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
}

/* --- SECCI√ìN DERECHA --- */
.header-user-info {
    display: flex;
    align-items: center;
    color: #6c757d;
}

/* Separador Vertical */
.header-separator {
    width: 1px;
    height: 25px;
    background: #dee2e6;
    margin: 0 1rem;
}

/* Detalles de Texto (Nombre y Rol) */
.user-details {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    margin-right: 0.8rem;
    text-align: right;
}

.user-name {
    font-size: 0.9rem;
    font-weight: 600;
    color: #333;
}

.user-role {
    font-size: 0.75rem;
    color: #6c757d;
}

/* Avatar Circular */
.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #007BFF;
    color: #FFFFFF;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    flex-shrink: 0; /* No encoger */
}

/* Bot√≥n Logout */
.header-logout-button {
    background: transparent;
    border: 1px solid #dc3545;
    color: #dc3545;
    padding: 0.4rem 0.8rem;
    margin-left: 1.5rem;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.header-logout-button:hover {
    background-color: #dc3545;
    color: white;
}

.logout-icon {
    display: none; /* Oculto en desktop */
    font-size: 1.2rem;
    line-height: 1;
}

/* =========================================
   RESPONSIVE DESIGN (M√≥viles y Tablets)
   ========================================= */
@media (max-width: 992px) { /* Coincide con el breakpoint del Sidebar */
    .header-container {
        padding: 0.5rem 1rem;
        height: 60px;
        justify-content: space-between; 
    }

    /* Mostrar el bot√≥n de hamburguesa en Tablet/M√≥vil */
    .header-toggle-btn {
        display: block; 
    }

    /* 1. Logo en M√≥vil: M√°s peque√±o y est√°tico */
    .sidebar-logo-img3 {
        position: static; 
        transform: none;
        width: 100px;
        margin: 0;
        display: block;
    }

    /* Ocultar placeholder */
    .header-title-placeholder {
        display: none;
    }

    /* 2. Ajustar espacio de elementos derechos */
    .header-user-info {
        gap: 0.5rem;
    }

    /* 3. Ocultar Separador y Texto de Nombre en pantallas muy chicas */
    .header-separator,
    .user-details {
        display: none; 
    }

    /* 4. Ajustar Bot√≥n de Logout */
    .header-logout-button {
        margin-left: 0.5rem;
        padding: 0.3rem 0.6rem;
        border: none; 
    }
    
    .header-logout-button .logout-text {
        display: none; 
    }
    .logout-icon {
        display: block; 
    }
    
    /* 5. Avatar un poco m√°s peque√±o */
    .user-avatar {
        width: 35px;
        height: 35px;
        font-size: 1rem;
    }
}


==================================================================
ARCHIVO: frontend\src\style\InspeccionesPage.css
==================================================================
/* frontend/src/style/InspeccionesPage.css (Completo) */

.inspection-library {
    margin-bottom: 2rem;
}

.inspection-library h2 {
    margin-top: 0;
}

.form-buttons-container {
    display: flex;
    flex-wrap: wrap; 
    gap: 1rem; 
}

/* --- Estilos para Modal Ver Detalle --- */
.modal-lg {
    max-width: 800px; 
}

.inspection-details .detail-section {
    margin-bottom: 1rem;
    font-size: 1rem;
    color: #333;
}
.inspection-details .detail-section strong {
    color: var(--color-primario); 
    display: block;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
    text-decoration: none; /* Quita subrayado */
}

.detail-box {
    background-color: #f8f9fa;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    padding: 0.75rem;
    font-size: 0.95rem;
    margin-top: 0.25rem;
    white-space: pre-wrap;
}

/* ... (json-viewer styles sin cambios) ... */

/* --- Estilos para Secciones de Checklist --- */
.form-section-header {
    background-color: #f4f7f6;
    padding: 0.75rem 1rem;
    margin: 1.5rem 0 0.5rem 0;
    border-radius: 6px;
    border: 1px solid var(--color-border);
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--color-primario);
}

/* --- Estilos de Checklist (NUEVA ESTRUCTURA) --- */
.form-checklist-container {
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    padding: 1rem;
}

.checklist-item-wrapper {
    padding: 1rem 0.5rem;
    border-bottom: 1px solid #f0f2f5;
}
.checklist-item-wrapper:last-of-type {
    border-bottom: none;
}

.checklist-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.checklist-item .item-label {
    font-size: 0.95rem;
    color: var(--color-text);
    margin-right: 1rem;
    flex: 1; 
}

.checklist-options {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

/* (Estilos de botones de radio B/R/M/C/NC - sin cambios) */
.radio-label input[type="radio"],
.radio-label-cn input[type="radio"] {
    display: none; 
}
.radio-label span, 
.radio-label-cn span {
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.9rem;
    width: 40px;
    height: 30px;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    background-color: #fff;
    color: var(--color-text);
}
.radio-label-cn span { width: 45px; }

/* (Colores de selecci√≥n - sin cambios) */
.radio-label input[value="B"]:checked + span,
.radio-label-cn input[value="C"]:checked + span {
    background-color: var(--color-success); color: white; border-color: var(--color-success);
}
.radio-label input[value="R"]:checked + span { 
    background-color: var(--color-warning); color: var(--color-text); border-color: var(--color-warning); 
}
.radio-label input[value="M"]:checked + span,
.radio-label-cn input[value="NC"]:checked + span { 
    background-color: var(--color-danger); color: white; border-color: var(--color-danger); 
}
.radio-label input[value="NA"]:checked + span { 
    background-color: var(--color-secondary); color: white; border-color: var(--color-secondary); 
}

/* --- NUEVO: Estilo para la observaci√≥n por √≠tem --- */
.checklist-item-observacion {
    margin-top: 0.75rem;
    display: flex;
    gap: 0.5rem;
    align-items: center;
}
.checklist-item-observacion label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    flex-shrink: 0;
}
.checklist-item-observacion input {
    flex: 1;
    width: 100%;
    padding: 0.5rem; /* M√°s peque√±o */
    font-size: 0.9rem;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    box-sizing: border-box;
}


==================================================================
ARCHIVO: frontend\src\style\LoginPage.css
==================================================================
/* frontend/src/style/LoginPage.css */

:root {
    /* Colores originales de tu dise√±o */
    --color-primario: #005A5B; 
    --color-acento: #007BFF;
    --color-acento-hover: #0056b3;
    --color-texto-claro: #FFFFFF;
    --color-fondo-tarjeta: #FFFFFF;
    --color-texto-oscuro: #212529; 
    --color-texto-secundario: #6c757d; 
    --color-borde: #dee2e6;
    --color-error: #D32F2F;

    /* Colores solo para los iconos de selecci√≥n */
    --icon-sst: #005A5B; 
    --icon-collab: #007BFF;
    /* ELIMINADO: --icon-calidad */
}

/* =========================================
   VISTA DE SELECCI√ìN DE ROL (NUEVA)
   ========================================= */
.login-container-selection {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    width: 100%;
    background-color: #f4f7f6;
    padding: 2rem;
}

.login-header-center {
    text-align: center;
    margin-bottom: 3rem;
}

.login-logo-selection {
    width: 280px;
    height: auto;
    margin-bottom: 0rem;
    margin-top: -5rem;
}
.login-header-center h1 { font-size: 2.5rem; color: var(--color-primario); margin: 0; }
.login-header-center p { font-size: 1.2rem; color: #666; margin: 0.5rem 0 2rem 0; }
.login-header-center h3 { font-weight: 400; color: #444; }

.role-cards-container {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 800px; /* Ajustado para 2 tarjetas */
}

.role-card {
    background: white;
    width: 240px;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid transparent;
}

.role-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.1);
    border-color: #ddd;
}

.role-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}
.sst-color { color: var(--icon-sst); }
.collab-color { color: var(--icon-collab); }
/* ELIMINADO: .calidad-color */

.role-card h3 { margin: 0 0 0.5rem 0; color: #333; }
.role-card p { margin: 0; color: #777; font-size: 0.9rem; }

/* =========================================
   VISTA DE FORMULARIO (LOGIN ORIGINAL RESTAURADO)
   ========================================= */
.login-container {
    display: flex;
    width: 900px;
    min-height: 550px;
    background-color: var(--color-fondo-tarjeta);
    box-shadow: var(--shadow-md);
    border-radius: 10px;
    overflow: hidden;
    position: relative;
}

.btn-back {
    position: absolute;
    top: 20px;
    left: 20px;
    background: transparent;
    border: none;
    color: #666;
    font-size: 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    transition: color 0.2s;
    z-index: 10;
}
.btn-back:hover { color: #000; }

.login-visual-column {
    flex: 1;
    background-color: var(--color-primario);
    color: var(--color-texto-claro);
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: left;
    padding: 3rem;
}

.visual-content { max-width: 300px; }
.visual-content h1 {
    font-size: 2.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
    border-bottom: 3px solid var(--color-acento);
    padding-bottom: 0.5rem;
    display: inline-block;
}
.visual-content p {
    font-size: 1.1rem;
    opacity: 0.9;
    line-height: 1.6;
}

.login-form-column {
    flex: 1;
    background-color: var(--color-fondo-tarjeta);
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 3rem;
}

.login-form-wrapper {
    width: 100%;
    max-width: 350px;
}

.login-form-logo {
    width: 150px;
    height: auto;
    display: block;
    margin: 0 auto; 
    margin-top: -3rem;
    margin-bottom: 0rem;
}

.login-logo-placeholder {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-primario);
    text-align: center;
    margin-bottom: 1rem;
}

.login-form-wrapper h2 {
    font-size: 1.8rem;
    font-weight: 600;
    color: var(--color-texto-oscuro);
    margin-bottom: 2rem;
    text-align: center;
}

.input-group {
    margin-bottom: 1.5rem;
}
.input-group label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--color-texto-secundario);
    margin-bottom: 0.5rem;
}

.input-with-icon {
    display: flex;
    align-items: center;
    border: 1px solid var(--color-borde);
    border-radius: var(--border-radius);
    padding: 0 0.75rem;
    transition: border-color 0.3s ease;
}
.input-with-icon:focus-within {
    border-color: var(--color-acento);
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.input-icon {
    margin-right: 0.75rem;
    color: var(--color-texto-secundario);
    font-size: 1rem;
    flex-shrink: 0;
}

.input-with-icon input {
    width: 100%;
    border: none;
    outline: none;
    padding: 0.9rem 0;
    font-size: 1rem;
    background-color: transparent;
    color: var(--color-texto-oscuro);
}

.login-error-message {
    color: var(--color-error);
    font-size: 0.9rem;
    text-align: center;
    margin-bottom: 1rem;
}

.login-button {
    width: 100%;
}

@media (max-width: 900px) {
    .login-container {
        flex-direction: column;
        width: 100vw;
        min-height: 100vh;
        height: auto;
        border-radius: 0;
        box-shadow: none;
    }
    .login-visual-column {
        min-height: 250px;
        flex-basis: 250px; 
    }
    .login-form-column {
        flex: 1;
        padding: 2rem;
        align-items: flex-start;
    }
}


==================================================================
ARCHIVO: frontend\src\style\LogsPage.css
==================================================================
/* frontend/src/style/LogsPage.css */

/* Tarjeta contenedora de los filtros */
.logs-filter-card {
    margin-bottom: 2rem;
    padding: 1.5rem 2rem;
}

/* La barra de filtros (usa flexbox para responsiveness) */
.logs-filter-bar {
    display: flex;
    flex-wrap: wrap; /* Permite que los filtros se apilen en m√≥vil */
    gap: 1.5rem; /* Espacio entre los filtros */
    align-items: flex-start; /* Alinea los items al inicio */
}

/* Cada item del filtro (cada <select> o <input>) */
.filter-item {
    flex: 1; /* Ocupa el espacio disponible */
    min-width: 180px; /* Ancho m√≠nimo antes de apilarse */
    display: flex;
    flex-direction: column;
}

/* Hereda el estilo global de .form-group label */
.filter-item label {
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-text-secondary);
}

/* Hereda el estilo global de inputs/selects */
.filter-item select,
.filter-item input[type="date"] {
    width: 100%;
}

/* Contenedor de botones */
.filter-buttons {
    display: flex;
    gap: 0.5rem;
    align-self: flex-end; /* Alinea los botones abajo (al final de la label) */
    flex-shrink: 0; /* Evita que los botones se encojan */
}

/* En pantallas m√°s peque√±as, los botones ocupan todo el ancho */
@media (max-width: 768px) {
    .filter-buttons {
        width: 100%;
        /* Opcional: estira los botones */
        display: grid;
        grid-template-columns: 1fr 1fr;
    }
    
    .filter-item {
        min-width: 100%; /* Ocupa todo el ancho en m√≥vil */
    }
}


==================================================================
ARCHIVO: frontend\src\style\MainLayout.css
==================================================================
/* frontend/src/style/MainLayout.css */

.app-layout {
    display: flex;
    background-color: var(--color-bg); 
}

/* --- Wrapper para el contenido (Header + P√°gina) --- */
.main-content-wrapper {
    flex: 1; 
    margin-left: 260px; 
    display: flex;
    flex-direction: column;
    height: 100vh;
    transition: margin-left 0.3s ease; 
    
    /* --- CORRECCI√ìN CLAVE 1 --- */
    /* Evita que este contenedor se estire si el contenido es muy ancho */
    overflow-x: hidden; 
    width: 100%; /* Asegura que no intente ser m√°s grande que su padre */
}

/* --- Contenido de la P√°gina --- */
.page-content {
    flex: 1; 
    padding: 2rem;
    overflow-y: auto; /* Scroll vertical */
    
    /* --- CORRECCI√ìN CLAVE 2 --- */
    /* Doble seguridad: el √°rea de contenido tampoco puede desbordarse */
    overflow-x: hidden; 
}

/* --- Overlay para m√≥vil --- */
.sidebar-overlay {
    display: none; /* Oculto en desktop */
}


/* --- RESPONSIVIDAD (Tablet y M√≥vil) --- */
@media (max-width: 992px) {
    .main-content-wrapper {
        margin-left: 0; /* El contenido ocupa el 100% */
        width: 100vw; /* Ocupa toda la pantalla */
    }

    /* El overlay se activa en m√≥vil cuando el sidebar est√° abierto */
    .sidebar-overlay {
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1999; /* Detr√°s del sidebar, delante del contenido */
    }
}

@media (max-width: 768px) {
    .page-content {
        padding: 1rem; /* Menos padding en m√≥vil */
    }
}


==================================================================
ARCHIVO: frontend\src\style\Modal.css
==================================================================
/* frontend/src/style/Modal.css */

/* --- El fondo oscuro (Overlay) --- */
.modal-overlay {
    position: fixed; /* Cubre toda la pantalla */
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.6); /* Negro semitransparente */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000; /* Asegura que est√© por encima de todo */
}

/* --- La caja blanca (Modal) --- */
.modal-content {
    background-color: white;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    width: 100%;
    max-width: 500px; /* Ancho est√°ndar para un formulario */
    z-index: 1001;
    
    /* Animaci√≥n de entrada */
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* --- Encabezado del Modal --- */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 1rem;
    margin-bottom: 1.5rem;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    color: #212529;
}

.modal-close-button {
    background: transparent;
    border: none;
    font-size: 1.5rem;
    font-weight: bold;
    color: #888;
    cursor: pointer;
    padding: 0.5rem;
}
.modal-close-button:hover {
    color: #000;
}

/* --- Cuerpo y Formulario del Modal --- */
.modal-body {
    /* (Estilos de formulario) */
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    font-size: 0.9rem;
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 0.5rem;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 0.8rem;
    font-size: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    box-sizing: border-box; 
    font-family: inherit;
}

.form-group textarea {
    resize: vertical;
}

.modal-error {
    color: #D32F2F;
    font-size: 0.9rem;
    margin-top: 1rem;
    text-align: center;
}

/* --- Pie del Modal (Botones) --- */
.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem; /* Espacio entre botones */
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #dee2e6;
}

/* --- Estilos para Lista de Evidencias (NUEVO) --- */
.evidence-list {
    list-style: none;
    padding-left: 0;
    margin-top: 1rem;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
}

.evidence-item {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #dee2e6;
}
.evidence-item:last-child {
    border-bottom: none;
}

.evidence-item span {
    margin-right: 0.5rem;
    font-size: 1.5rem;
}

.evidence-info {
    font-size: 0.9rem;
}

.evidence-info a {
    font-weight: 600;
    color: #007BFF;
    text-decoration: none;
}
.evidence-info a:hover {
    text-decoration: underline;
}

.evidence-info small {
    display: block;
    color: #6c757d;
}

/* ... (Mant√©n todo el c√≥digo anterior hasta .modal-footer) ... */

/* AGREGAR AL FINAL DEL ARCHIVO: */

/* =========================================
   RESPONSIVE MODALES
   ========================================= */

@media (max-width: 768px) {
    /* 1. Caja del Modal: M√°s ancha y alta en m√≥vil */
    .modal-content, 
    .modal-content.modal-lg {
        width: 95% !important;
        max-width: 95% !important;
        max-height: 90vh !important; /* Evitar que se salga de la pantalla */
        padding: 1.2rem !important; /* Menos relleno interno */
        margin: 0 auto;
    }

    /* 2. Encabezado */
    .modal-header h2, 
    .modal-header h3 {
        font-size: 1.2rem; /* T√≠tulo m√°s peque√±o */
    }

    /* 3. Formularios: FORZAR COLUMNA √öNICA */
    /* Este truco hace que los divs con display: flex dentro del modal se vuelvan columna */
    .modal-body div[style*="display: flex"], 
    .modal-body div[style*="display:flex"] {
        flex-direction: column !important;
        gap: 1rem !important;
    }
    
    /* Excepci√≥n: Los radio buttons o checkboxes peque√±os no deben apilarse */
    .modal-body div[style*="display: flex"] label,
    .modal-body div[style*="display:flex"] label {
        margin-bottom: 0;
    }
    
    /* Excepci√≥n: Las listas de evidencias o filas peque√±as */
    .evidence-item {
        flex-direction: row !important; /* Mantener icono y texto lado a lado */
    }

    /* 4. Inputs y Selects */
    .form-group input,
    .form-group select,
    .form-group textarea {
        font-size: 16px; /* Evita zoom autom√°tico en iPhone al escribir */
        padding: 0.7rem;
    }

    /* 5. Footer (Botones) */
    .modal-footer {
        flex-direction: column-reverse; /* Bot√≥n principal arriba, cancelar abajo */
        gap: 0.8rem;
    }
    .modal-footer button {
        width: 100%; /* Botones ancho completo */
        padding: 0.9rem;
    }
}


==================================================================
ARCHIVO: frontend\src\style\PlanificacionPage.css
==================================================================
/* frontend/src/style/PlanificacionPage.css */

.header-actions {
    display: flex;
    gap: 1rem;
}

/* Estilo para el filtro (selector de cronograma) */
.cronograma-selector {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    background-color: var(--color-card); /* Usa variable global */
    padding: 1rem;
    border-radius: var(--border-radius); /* Usa variable global */
    box-shadow: var(--shadow-sm); /* Usa variable global */
}

.cronograma-selector label {
    font-weight: 600;
    color: var(--color-text); /* Usa variable global */
}

.cronograma-selector select {
    font-size: 1rem;
    padding: 0.5rem 0.8rem;
    border-radius: var(--border-radius); /* Usa variable global */
    border: 1px solid var(--color-border); /* Usa variable global */
    min-width: 300px;
}

.cronograma-descripcion {
    font-size: 0.95rem;
    color: var(--color-text-secondary); /* Usa variable global */
    margin: -1rem 0 1.5rem 0.5rem;
    padding: 0.5rem 1rem;
    background-color: #f8f9fa; /* Gris muy claro */
    border-radius: var(--border-radius); /* Usa variable global */
    border: 1px solid var(--color-border); /* Usa variable global */
}

/* --- Tarjeta del Calendario --- */
.calendar-card {
    margin-top: 2rem;
    padding: 1.5rem;
}

/* --- Estilos para React Big Calendar --- */
.rbc-calendar {
    height: 600px !important;
}
.rbc-event {
    background-color: var(--color-primario); /* Usa variable global */
    border: 1px solid var(--color-primario-hover); /* Usa variable global */
}
.rbc-event:focus, .rbc-event.rbc-selected {
    background-color: var(--color-acento); /* Usa variable global */
}
.rbc-header {
    background-color: #f8f9fa;
    color: var(--color-text-secondary); /* Usa variable global */
    font-weight: 600;
    border-bottom: 2px solid var(--color-border); /* Usa variable global */
    padding: 0.75rem 0;
}
.rbc-today {
    background-color: #e6f7ec; /* Verde claro (global) */
}


==================================================================
ARCHIVO: frontend\src\style\ReportarPage.css
==================================================================
/* frontend/src/style/ReportarPage.css */

/* Estilos para los botones de radio grandes (OK / Problema) */
.report-radio-group {
    display: flex;
    gap: 1rem;
}

.report-radio-group .radio-label-report {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.report-radio-group .radio-label-report span {
    font-size: 1.1rem;
    font-weight: 600;
}

.report-radio-group .radio-label-report input[type="radio"] {
    display: none; /* Oculta el radio button */
}

/* Color para OK */
.report-radio-group .status-ok:hover {
    background-color: #e6f7ec;
}
.report-radio-group input[value="OK"]:checked + span {
    color: #005A5B;
}
.report-radio-group input[value="OK"]:checked + label {
    border-color: #005A5B;
    background-color: #e6f7ec;
    box-shadow: 0 0 0 3px rgba(0, 90, 91, 0.1);
}

/* Color para Problema */
.report-radio-group .status-problema:hover {
    background-color: #fbebee;
}
.report-radio-group input[value="Con Problema"]:checked + span {
    color: #dc3545;
}
.report-radio-group input[value="Con Problema"]:checked + label {
    border-color: #dc3545;
    background-color: #fbebee;
    box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
}

/* Pie del formulario */
.form-footer {
    display: flex;
    justify-content: flex-end;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #dee2e6;
}

/* Mensaje de √©xito */
.success-message {
    color: #005A5B;
    font-weight: 600;
    text-align: center;
    background-color: #e6f7ec;
    padding: 1rem;
    border-radius: 8px;
}


/* ... (C√≥digo anterior) ... */

/* AGREGAR AL FINAL: */

@media (max-width: 768px) {
    /* Contenedor del calendario */
    .calendar-card {
        padding: 0.5rem; /* Menos padding */
    }

    /* Altura del calendario */
    .rbc-calendar {
        height: 500px !important; /* Un poco menos alto */
        font-size: 0.75rem !important; /* Letra m√°s peque√±a */
    }

    /* Cabecera del calendario (D√≠as) */
    .rbc-header {
        padding: 2px 0 !important;
        font-size: 0.7rem;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Botones de la barra de herramientas del calendario */
    .rbc-toolbar button {
        padding: 0.3rem 0.5rem;
        font-size: 0.8rem;
    }
    
    /* T√≠tulo del calendario (Mes/A√±o) */
    .rbc-toolbar-label {
        font-size: 1rem;
        font-weight: bold;
    }
    
    /* Selector de Cronograma */
    .cronograma-selector select {
        width: 100%;
        min-width: 0; /* Permitir que encoja */
    }
}


==================================================================
ARCHIVO: frontend\src\style\Sidebar.css
==================================================================
/* frontend/src/style/Sidebar.css (Responsive y con Logo) */

:root {
    --sidebar-width: 260px;
}

.sidebar-container {
    display: flex;
    flex-direction: column;
    width: var(--sidebar-width);
    height: 100vh;
    background-color: var(--color-primario);
    color: var(--color-texto-claro);
    position: fixed; 
    left: 0;
    top: 0;
    z-index: 1000;
    box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    transition: left 0.3s ease; 
}

/* --- 1. SECCI√ìN DEL LOGO (INTACTA) --- */
.sidebar-logo {
    display: flex;
    flex-direction: column; 
    align-items: center;  
    justify-content: center; /* Centra el contenido */ 
    border-bottom: 1px solid var(--color-primario-hover);
    position: relative; 
}

/* CORRECCI√ìN: Clase para la imagen (Mantenemos tus ajustes exactos) */
.sidebar-logo-img {
    width: 150px; /* Ancho que especificaste */
    height: auto; 
    margin-top: -2rem;
    /* CORRECCI√ìN: Espacio m√≠nimo entre logo y texto */
    margin-bottom: -2.5rem; /* Pega el texto al logo */
}

.sidebar-logo h3 {
    margin: 0; /* Sin margen */
    font-size: 1.25rem; 
    font-weight: 600;
    text-align: center;
}

/* Bot√≥n de cerrar (solo para m√≥vil) */
.sidebar-close-btn {
    display: none; 
    background: transparent;
    border: none;
    color: white;
    font-size: 2rem;
    cursor: pointer;
    position: absolute;
    top: 10px;
    right: 15px;
}
/* --- FIN DE LA CORRECCI√ìN --- */


/* --- Navegaci√≥n --- */
.sidebar-nav {
    flex-grow: 1;
    overflow-y: auto;
    padding-top: 1rem;
}

/* --- NUEVO: Estilo para los t√≠tulos de secci√≥n (Super Admin / Calidad) --- */
.sidebar-section-label {
    padding: 1.5rem 1.5rem 0.5rem 1.5rem;
    font-size: 0.7rem;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.4); /* Blanco semitransparente */
    text-transform: uppercase;
    letter-spacing: 1px;
}

.sidebar-link {
    display: flex;
    align-items: center;
    gap: 0.75rem; 
    padding: 1rem 1.5rem;
    color: var(--color-texto-claro);
    text-decoration: none;
    font-size: 1rem;
    font-weight: 500;
    transition: background-color 0.2s ease;
    border-left: 4px solid transparent; 
}

.sidebar-link svg {
    font-size: 1.1rem;
    flex-shrink: 0;
    opacity: 0.8;
}

.sidebar-link:hover {
    background-color: var(--color-primario-hover);
}

.sidebar-link.active {
    background-color: var(--color-fondo-oscuro, #003838);
    border-left-color: var(--color-acento); 
    font-weight: 600;
}
.sidebar-link.active svg {
    opacity: 1;
}

/* --- Footer --- */
.sidebar-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--color-primario-hover);
}

/* frontend/src/style/Sidebar.css */


.sidebar-nav {
    flex: 1;
    overflow-y: auto; /* Permite hacer scroll si no cabe */
    padding: 1rem 0;
    
    /* --- ESTO OCULTA LA BARRA VISUALMENTE --- */
    
    /* Para Firefox */
    scrollbar-width: none; 
    
    /* Para Internet Explorer y Edge antiguo */
    -ms-overflow-style: none;  
}

/* Para Chrome, Safari y Edge moderno */
.sidebar-nav::-webkit-scrollbar {
    display: none;
}


/* --- RESPONSIVIDAD (Tablet y M√≥vil) --- */
@media (max-width: 992px) {
    .sidebar-container {
        left: calc(var(--sidebar-width) * -1); 
        z-index: 2000; 
    }
    
    .sidebar-container.open {
        left: 0; 
    }

    .sidebar-close-btn {
        display: block; 
    }
}


==================================================================
ARCHIVO: frontend\src\style\Solicitudes.css
==================================================================
/* frontend/src/style/Solicitudes.css */

.solicitudes-container {
    padding: 1rem;
    background-color: #f4f6f9;
    min-height: 100vh;
}

/* --- FORMULARIO DE CREACI√ìN --- */
.solicitud-form-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    padding: 2rem;
    margin-bottom: 2rem;
    border-left: 6px solid #005A5B; /* Acento corporativo */
}

.solicitud-header-title {
    color: #005A5B;
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

/* --- TABLA DE SOLICITUDES --- */
.solicitudes-list-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    padding: 1.5rem;
    overflow: hidden;
}

.solicitud-table {
    width: 100%;
    border-collapse: collapse;
}

.solicitud-table thead th {
    background-color: #f8f9fa;
    color: #495057;
    font-weight: 700;
    padding: 1rem;
    text-align: left;
    border-bottom: 2px solid #dee2e6;
}

.solicitud-table tbody tr {
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
}

.solicitud-table tbody tr:hover {
    background-color: #f1fcfc;
}

.solicitud-table td {
    padding: 1rem;
    vertical-align: middle;
}

/* --- ESTILOS DE ESTADO (BADGES) --- */
.badge-estado {
    padding: 0.35em 0.65em;
    border-radius: 50rem;
    font-size: 0.85em;
    font-weight: 700;
    text-transform: uppercase;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.badge-pendiente {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
}

.badge-aprobado {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.badge-rechazado {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

/* --- BOTONES DE DOCUMENTOS --- */
.btn-doc-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.btn-doc {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.2s;
}

.btn-doc-original {
    background-color: #e2e6ea;
    color: #343a40;
    border: 1px solid #d6d8db;
}

.btn-doc-original:hover {
    background-color: #dbe0e5;
    color: #000;
}

.btn-doc-firmado {
    background-color: #28a745;
    color: white;
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

.btn-doc-firmado:hover {
    background-color: #218838;
    transform: translateY(-1px);
}

/* --- ACCIONES --- */
.actions-cell {
    display: flex;
    gap: 8px;
}


==================================================================
ARCHIVO: frontend\src\style\UsuariosPage.css
==================================================================
/* frontend/src/style/UsuariosPage.css */

/* --- Estilos Generales de P√°gina (reutilizables) --- */   
.page-container {
    width: 100%;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.page-header h1 {
    font-size: 2rem;
    font-weight: 600;
    color: #212529;
    margin: 0;
}

.page-content-card {
    background-color: #FFFFFF;
    border-radius: 10px;
    padding: 2rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.error-message {
    color: #D32F2F;
}

/* --- Botones --- */
.btn {
    padding: 0.75rem 1.25rem;
    border: none;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-primary {
    background-color: #007BFF; /* Azul Acento */
    color: white;
}
.btn-primary:hover {
    background-color: #0056b3;
}

.btn-secondary {
    background-color: #6c757d; /* Gris */
    color: white;
    margin-right: 0.5rem;
}
.btn-secondary:hover {
    background-color: #5a6268;
}

.btn-danger {
    background-color: #dc3545; /* Rojo */
    color: white;
}
.btn-danger:hover {
    background-color: #c82333;
}

/* --- Estilos de la Tabla --- */
.data-table {
    width: 100%;
    border-collapse: collapse; /* Bordes limpios */
}

.data-table th, .data-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.data-table th {
    font-size: 0.85rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    background-color: #f8f9fa;
}

.data-table td {
    font-size: 0.95rem;
    color: #212529;
}

/* P√≠ldora de Estado */
.status-pill {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

.status-activo {
    background-color: #e6f7ec; /* Verde claro */
    color: #005A5B; /* Verde oscuro */
}

.status-inactivo {
    background-color: #fbebee; /* Rojo claro */
    color: #dc3545; /* Rojo */
}

.action-buttons {
    white-space: nowrap; /* Evita que los botones se partan */
}


/* Nuevo estado para 'En Proceso' (Azul) */
.status-proceso {
    background-color: #e7f3ff; /* Azul claro */
    color: #007BFF; /* Azul */
}


==================================================================
ARCHIVO: frontend\vite.config.js
==================================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})


